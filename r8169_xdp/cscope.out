cscope 15 $HOME/r8169_xdp -q 0000002585 0000560567
	@8139cp.c

49 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

51 
	#DRV_NAME
 "8139ı"

	)

52 
	#DRV_VERSION
 "1.3"

	)

53 
	#DRV_RELDATE
 "M¬ 22, 2004"

	)

56 
	~<lšux/moduË.h
>

57 
	~<lšux/moduË·¿m.h
>

58 
	~<lšux/k”Ãl.h
>

59 
	~<lšux/comp”.h
>

60 
	~<lšux/Ãtdeviû.h
>

61 
	~<lšux/‘h”deviû.h
>

62 
	~<lšux/š™.h
>

63 
	~<lšux/š‹¼u±.h
>

64 
	~<lšux/pci.h
>

65 
	~<lšux/dma-m­pšg.h
>

66 
	~<lšux/d–ay.h
>

67 
	~<lšux/‘htoŞ.h
>

68 
	~<lšux/gå.h
>

69 
	~<lšux/mii.h
>

70 
	~<lšux/if_vÏn.h
>

71 
	~<lšux/üc32.h
>

72 
	~<lšux/š.h
>

73 
	~<lšux/.h
>

74 
	~<lšux/tı.h
>

75 
	~<lšux/udp.h
>

76 
	~<lšux/ÿche.h
>

77 
	~<asm/io.h
>

78 
	~<asm/œq.h
>

79 
	~<asm/uacûss.h
>

82 
	gv”siÚ
[] =

83 
DRV_NAME
 ": 10/100 PCI Eth”Ãˆdriv” v" 
DRV_VERSION
 " (" 
DRV_RELDATE
 ")\n";

85 
MODULE_AUTHOR
("Jeff Garzik <jgarzik@pobox.com>");

86 
MODULE_DESCRIPTION
("RealTek RTL-8139C+ series 10/100 PCI Ethernet driver");

87 
MODULE_VERSION
(
DRV_VERSION
);

88 
MODULE_LICENSE
("GPL");

90 
	gdebug
 = -1;

91 
moduË_·¿m
(
debug
, , 0);

92 
MODULE_PARM_DESC
 (
debug
, "8139cp: bitmapped messageƒnable‚umber");

96 
	gmuÉiÿ¡_f‹r_lim™
 = 32;

97 
moduË_·¿m
(
muÉiÿ¡_f‹r_lim™
, , 0);

98 
MODULE_PARM_DESC
 (
muÉiÿ¡_f‹r_lim™
, "8139cp: maximum‚umber of filtered multicast‡ddresses");

100 
	#CP_DEF_MSG_ENABLE
 (
NETIF_MSG_DRV
 | \

101 
NETIF_MSG_PROBE
 | \

102 
NETIF_MSG_LINK
)

	)

103 
	#CP_NUM_STATS
 14

	)

104 
	#CP_STATS_SIZE
 64

	)

105 
	#CP_REGS_SIZE
 (0xfà+ 1)

	)

106 
	#CP_REGS_VER
 1

	)

107 
	#CP_RX_RING_SIZE
 64

	)

108 
	#CP_TX_RING_SIZE
 64

	)

109 
	#CP_RING_BYTES
 \

110 (((
ı_desc
è* 
CP_RX_RING_SIZE
) + \

111 ((
ı_desc
è* 
CP_TX_RING_SIZE
) + \

112 
CP_STATS_SIZE
)

	)

113 
	#NEXT_TX
(
N
è(((Nè+ 1è& (
CP_TX_RING_SIZE
 - 1))

	)

114 
	#NEXT_RX
(
N
è(((Nè+ 1è& (
CP_RX_RING_SIZE
 - 1))

	)

115 
	#TX_BUFFS_AVAIL
(
CP
) \

116 (((
CP
)->
tx_
 <ğ(CP)->
tx_h—d
) ? \

117 (
CP
)->
tx_
 + (
CP_TX_RING_SIZE
 - 1è- (CP)->
tx_h—d
 : \

118 (
CP
)->
tx_
 - (CP)->
tx_h—d
 - 1)

	)

120 
	#PKT_BUF_SZ
 1536

	)

121 
	#CP_INTERNAL_PHY
 32

	)

124 
	#RX_FIFO_THRESH
 5

	)

125 
	#RX_DMA_BURST
 4

	)

126 
	#TX_DMA_BURST
 6

	)

127 
	#TX_EARLY_THRESH
 256

	)

130 
	#TX_TIMEOUT
 (6*
HZ
)

	)

133 
	#CP_MIN_MTU
 60

	)

134 
	#CP_MAX_MTU
 4096

	)

138 
	mMAC0
 = 0x00,

139 
	mMAR0
 = 0x08,

140 
	mStsAddr
 = 0x10,

141 
	mTxRšgAddr
 = 0x20,

142 
	mHiTxRšgAddr
 = 0x28,

143 
	mCmd
 = 0x37,

144 
	mIÁrMask
 = 0x3C,

145 
	mIÁrStus
 = 0x3E,

146 
	mTxCÚfig
 = 0x40,

147 
	mChV”siÚ
 = 0x43,

148 
	mRxCÚfig
 = 0x44,

149 
	mRxMis£d
 = 0x4C,

150 
	mCfg9346
 = 0x50,

151 
	mCÚfig1
 = 0x52,

152 
	mCÚfig3
 = 0x59,

153 
	mCÚfig4
 = 0x5A,

154 
	mMuÉiIÁr
 = 0x5C,

155 
	mBasicModeCŒl
 = 0x62,

156 
	mBasicModeStus
 = 0x64,

157 
	mNWayAdv”t
 = 0x66,

158 
	mNWayLPAR
 = 0x68,

159 
	mNWayEx·nsiÚ
 = 0x6A,

160 
	mTxDmaOkLowDesc
 = 0x82,

161 
	mCÚfig5
 = 0xD8,

162 
	mTxPŞl
 = 0xD9,

163 
	mRxMaxSize
 = 0xDA,

164 
	mCpCmd
 = 0xE0,

165 
	mIÁrM™ig©e
 = 0xE2,

166 
	mRxRšgAddr
 = 0xE4,

167 
	mTxTh»sh
 = 0xEC,

168 
	mOldRxBufAddr
 = 0x30,

169 
	mOldTSD0
 = 0x10,

172 
	mDescOwn
 = (1 << 31),

173 
	mRšgEnd
 = (1 << 30),

174 
	mFœ¡F¿g
 = (1 << 29),

175 
	mLa¡F¿g
 = (1 << 28),

176 
	mL¬geS’d
 = (1 << 27),

177 
	mMSSShiá
 = 16,

178 
	mMSSMask
 = 0x7ff,

179 
	mTxE¼Ü
 = (1 << 23),

180 
	mRxE¼Ü
 = (1 << 20),

181 
	mIPCS
 = (1 << 18),

182 
	mUDPCS
 = (1 << 17),

183 
	mTCPCS
 = (1 << 16),

184 
	mTxVÏnTag
 = (1 << 17),

185 
	mRxVÏnTagged
 = (1 << 16),

186 
	mIPFa
 = (1 << 15),

187 
	mUDPFa
 = (1 << 14),

188 
	mTCPFa
 = (1 << 13),

189 
	mNÜm®TxPŞl
 = (1 << 6),

190 
	mPID1
 = (1 << 17),

191 
	mPID0
 = (1 << 16),

192 
	mRxPrÙoTCP
 = 1,

193 
	mRxPrÙoUDP
 = 2,

194 
	mRxPrÙoIP
 = 3,

195 
	mTxFIFOUnd”
 = (1 << 25),

196 
	mTxOWC
 = (1 << 22),

197 
	mTxLškFa
 = (1 << 21),

198 
	mTxMaxCŞ
 = (1 << 20),

199 
	mTxCŞCÁShiá
 = 16,

200 
	mTxCŞCÁMask
 = 0x01 | 0x02 | 0x04 | 0x08,

201 
	mRxE¼F¿me
 = (1 << 27),

202 
	mRxMÿ¡
 = (1 << 26),

203 
	mRxE¼CRC
 = (1 << 18),

204 
	mRxE¼RuÁ
 = (1 << 19),

205 
	mRxE¼LÚg
 = (1 << 21),

206 
	mRxE¼FIFO
 = (1 << 22),

209 
	mDumpSts
 = (1 << 3),

212 
	mRxCfgFIFOShiá
 = 13,

213 
	mRxCfgDMAShiá
 = 8,

214 
	mAcû±E¼
 = 0x20,

215 
	mAcû±RuÁ
 = 0x10,

216 
	mAcû±Brßdÿ¡
 = 0x08,

217 
	mAcû±MuÉiÿ¡
 = 0x04,

218 
	mAcû±MyPhys
 = 0x02,

219 
	mAcû±AÎPhys
 = 0x01,

222 
	mPciE¼
 = (1 << 15),

223 
	mTim”IÁr
 = (1 << 14),

224 
	mL’Chg
 = (1 << 13),

225 
	mSWIÁ
 = (1 << 8),

226 
	mTxEm±y
 = (1 << 7),

227 
	mRxFIFOOvr
 = (1 << 6),

228 
	mLškChg
 = (1 << 5),

229 
	mRxEm±y
 = (1 << 4),

230 
	mTxE¼
 = (1 << 3),

231 
	mTxOK
 = (1 << 2),

232 
	mRxE¼
 = (1 << 1),

233 
	mRxOK
 = (1 << 0),

234 
	mIÁrResvd
 = (1 << 10),

237 
	mIÁrAÎ
 = 
PciE¼
 | 
Tim”IÁr
 | 
L’Chg
 | 
SWIÁ
 | 
TxEm±y
 |

238 
RxFIFOOvr
 | 
LškChg
 | 
RxEm±y
 | 
TxE¼
 | 
TxOK
 |

239 
RxE¼
 | 
RxOK
 | 
IÁrResvd
,

242 
	mCmdRe£t
 = (1 << 4),

243 
	mRxOn
 = (1 << 3),

244 
	mTxOn
 = (1 << 2),

247 
	mRxVÏnOn
 = (1 << 6),

248 
	mRxChkSum
 = (1 << 5),

249 
	mPCIDAC
 = (1 << 4),

250 
	mPCIMulRW
 = (1 << 3),

251 
	mCpRxOn
 = (1 << 1),

252 
	mCpTxOn
 = (1 << 0),

255 
	mCfg9346_Lock
 = 0x00,

256 
	mCfg9346_UÆock
 = 0xC0,

259 
	mIFG
 = (1 << 25) | (1 << 24),

260 
	mTxDMAShiá
 = 8,

263 
	mTxTh»shMask
 = 0x3f,

264 
	mTxTh»shMax
 = 2048,

267 
	mDriv”Lßded
 = (1 << 5),

268 
	mLWACT
 = (1 << 4),

269 
	mPMEÇbË
 = (1 << 0),

272 
	mPARMEÇbË
 = (1 << 6),

273 
	mMagicPack‘
 = (1 << 5),

274 
	mLškUp
 = (1 << 4),

277 
	mLWPTN
 = (1 << 1),

278 
	mLWPME
 = (1 << 4),

281 
	mBWF
 = (1 << 6),

282 
	mMWF
 = (1 << 5),

283 
	mUWF
 = (1 << 4),

284 
	mLANWake
 = (1 << 1),

285 
	mPMEStus
 = (1 << 0),

287 
	mı_nÜx_šŒ_mask
 = 
PciE¼
 | 
LškChg
 | 
TxOK
 | 
TxE¼
 | 
TxEm±y
,

288 
	mı_rx_šŒ_mask
 = 
RxOK
 | 
RxE¼
 | 
RxEm±y
 | 
RxFIFOOvr
,

289 
	mı_šŒ_mask
 = 
ı_rx_šŒ_mask
 | 
ı_nÜx_šŒ_mask
,

292 cÚ¡ 
	gı_rx_cÚfig
 =

293 (
RX_FIFO_THRESH
 << 
RxCfgFIFOShiá
) |

294 (
RX_DMA_BURST
 << 
RxCfgDMAShiá
);

296 
	sı_desc
 {

297 
__Ë32
 
	mİts1
;

298 
__Ë32
 
	mİts2
;

299 
__Ë64
 
	maddr
;

302 
	sı_dma_¡©s
 {

303 
__Ë64
 
	mtx_ok
;

304 
__Ë64
 
	mrx_ok
;

305 
__Ë64
 
	mtx_”r
;

306 
__Ë32
 
	mrx_”r
;

307 
__Ë16
 
	mrx_fifo
;

308 
__Ë16
 
	mäame_®ign
;

309 
__Ë32
 
	mtx_ok_1cŞ
;

310 
__Ë32
 
	mtx_ok_mcŞ
;

311 
__Ë64
 
	mrx_ok_phys
;

312 
__Ë64
 
	mrx_ok_bÿ¡
;

313 
__Ë32
 
	mrx_ok_mÿ¡
;

314 
__Ë16
 
	mtx_abÜt
;

315 
__Ë16
 
	mtx_und”run
;

316 } 
	g__·cked
;

318 
	sı_exŒa_¡©s
 {

319 
	mrx_äags
;

322 
	sı_´iv©e
 {

323 
__iomem
 *
	m»gs
;

324 
Ãt_deviû
 *
	mdev
;

325 
¥šlock_t
 
	mlock
;

326 
u32
 
	mmsg_’abË
;

328 
Çpi_¡ruù
 
	mÇpi
;

330 
pci_dev
 *
	mpdev
;

331 
u32
 
	mrx_cÚfig
;

332 
u16
 
	mıcmd
;

334 
ı_exŒa_¡©s
 
	mı_¡©s
;

336 
rx_h—d
 
	m____ÿch–še_®igÃd
;

337 
	mrx_
;

338 
ı_desc
 *
	mrx_ršg
;

339 
sk_buff
 *
	mrx_skb
[
CP_RX_RING_SIZE
];

341 
tx_h—d
 
	m____ÿch–še_®igÃd
;

342 
	mtx_
;

343 
ı_desc
 *
	mtx_ršg
;

344 
sk_buff
 *
	mtx_skb
[
CP_TX_RING_SIZE
];

345 
u32
 
	mtx_İts
[
CP_TX_RING_SIZE
];

347 
	mrx_buf_sz
;

348 
	mwŞ_’abËd
 : 1;

350 
dma_addr_t
 
	mršg_dma
;

352 
mii_if_šfo
 
	mmii_if
;

355 
	#ır8
(
»g
è
	`»adb
(
ı
->
»gs
 + (»g))

	)

356 
	#ır16
(
»g
è
	`»adw
(
ı
->
»gs
 + (»g))

	)

357 
	#ır32
(
»g
è
	`»adl
(
ı
->
»gs
 + (»g))

	)

358 
	#ıw8
(
»g
,
v®
è
	`wr™eb
((v®), 
ı
->
»gs
 + (»g))

	)

359 
	#ıw16
(
»g
,
v®
è
	`wr™ew
((v®), 
ı
->
»gs
 + (»g))

	)

360 
	#ıw32
(
»g
,
v®
è
	`wr™–
((v®), 
ı
->
»gs
 + (»g))

	)

361 
	#ıw8_f
(
»g
,
v®
) do { \

362 
	`wr™eb
((
v®
), 
ı
->
»gs
 + (
»g
)); \

363 
	`»adb
(
ı
->
»gs
 + (
»g
)); \

364 } 0)

	)

365 
	#ıw16_f
(
»g
,
v®
) do { \

366 
	`wr™ew
((
v®
), 
ı
->
»gs
 + (
»g
)); \

367 
	`»adw
(
ı
->
»gs
 + (
»g
)); \

368 } 0)

	)

369 
	#ıw32_f
(
»g
,
v®
) do { \

370 
	`wr™–
((
v®
), 
ı
->
»gs
 + (
»g
)); \

371 
	`»adl
(
ı
->
»gs
 + (
»g
)); \

372 } 0)

	)

375 
__ı_£t_rx_mode
 (
Ãt_deviû
 *
dev
);

376 
ı_tx
 (
ı_´iv©e
 *
ı
);

377 
ı_ş—n_ršgs
 (
ı_´iv©e
 *
ı
);

378 #ifdeà
CONFIG_NET_POLL_CONTROLLER


379 
ı_pŞl_cÚŒŞËr
(
Ãt_deviû
 *
dev
);

381 
ı_g‘_“´om_Ën
(
Ãt_deviû
 *
dev
);

382 
ı_g‘_“´om
(
Ãt_deviû
 *
dev
,

383 
‘htoŞ_“´om
 *
“´om
, 
u8
 *
d©a
);

384 
ı_£t_“´om
(
Ãt_deviû
 *
dev
,

385 
‘htoŞ_“´om
 *
“´om
, 
u8
 *
d©a
);

388 cÚ¡ 
	m¡r
[
ETH_GSTRING_LEN
];

389 } 
	g‘htoŞ_¡©s_keys
[] = {

407 
šlše
 
	$ı_£t_rxbufsize
 (
ı_´iv©e
 *
ı
)

409 
mtu
 = 
ı
->
dev
->mtu;

411 ià(
mtu
 > 
ETH_DATA_LEN
)

413 
ı
->
rx_buf_sz
 = 
mtu
 + 
ETH_HLEN
 + 8;

415 
ı
->
rx_buf_sz
 = 
PKT_BUF_SZ
;

416 
	}
}

418 
šlše
 
	$ı_rx_skb
 (
ı_´iv©e
 *
ı
, 
sk_buff
 *
skb
,

419 
ı_desc
 *
desc
)

421 
u32
 
İts2
 = 
	`Ë32_to_ıu
(
desc
->opts2);

423 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
 (skb, 
ı
->
dev
);

425 
ı
->
dev
->
¡©s
.
rx_·ck‘s
++;

426 
ı
->
dev
->
¡©s
.
rx_by‹s
 +ğ
skb
->
Ën
;

428 ià(
İts2
 & 
RxVÏnTagged
)

429 
	`__vÏn_hwacûl_put_g
(
skb
, 
	`htÚs
(
ETH_P_8021Q
), 
	`swab16
(
İts2
 & 0xffff));

431 
	`Çpi_gro_»ûive
(&
ı
->
Çpi
, 
skb
);

432 
	}
}

434 
	$ı_rx_”r_acù
 (
ı_´iv©e
 *
ı
, 
rx_
,

435 
u32
 
¡©us
, u32 
Ën
)

437 
	`Ãtif_dbg
(
ı
, 
rx_”r
, cp->
dev
, "rxƒrr, slot %d status 0x%x†en %d\n",

438 
rx_
, 
¡©us
, 
Ën
);

439 
ı
->
dev
->
¡©s
.
rx_”rÜs
++;

440 ià(
¡©us
 & 
RxE¼F¿me
)

441 
ı
->
dev
->
¡©s
.
rx_äame_”rÜs
++;

442 ià(
¡©us
 & 
RxE¼CRC
)

443 
ı
->
dev
->
¡©s
.
rx_üc_”rÜs
++;

444 ià((
¡©us
 & 
RxE¼RuÁ
è|| (¡©u & 
RxE¼LÚg
))

445 
ı
->
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

446 ià((
¡©us
 & (
Fœ¡F¿g
 | 
La¡F¿g
)) != (FirstFrag | LastFrag))

447 
ı
->
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

448 ià(
¡©us
 & 
RxE¼FIFO
)

449 
ı
->
dev
->
¡©s
.
rx_fifo_”rÜs
++;

450 
	}
}

452 
šlše
 
	$ı_rx_csum_ok
 (
u32
 
¡©us
)

454 
´ÙocŞ
 = (
¡©us
 >> 16) & 0x3;

456 ià(((
´ÙocŞ
 =ğ
RxPrÙoTCP
è&& !(
¡©us
 & 
TCPFa
)) ||

457 ((
´ÙocŞ
 =ğ
RxPrÙoUDP
è&& !(
¡©us
 & 
UDPFa
)))

461 
	}
}

463 
	$ı_rx_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

465 
ı_´iv©e
 *
ı
 = 
	`cÚš”_of
(
Çpi
, cp_private,‚api);

466 
Ãt_deviû
 *
dev
 = 
ı
->dev;

467 
rx_
 = 
ı
->rx_tail;

468 
rx
;

470 
rx
 = 0;

471 
rx_¡©us_loİ
:

472 
	`ıw16
(
IÁrStus
, 
ı_rx_šŒ_mask
);

474 
rx
 < 
budg‘
) {

475 
u32
 
¡©us
, 
Ën
;

476 
dma_addr_t
 
m­pšg
, 
Ãw_m­pšg
;

477 
sk_buff
 *
skb
, *
Ãw_skb
;

478 
ı_desc
 *
desc
;

479 cÚ¡ 
buæ’
 = 
ı
->
rx_buf_sz
;

481 
skb
 = 
ı
->
rx_skb
[
rx_
];

482 
	`BUG_ON
(!
skb
);

484 
desc
 = &
ı
->
rx_ršg
[
rx_
];

485 
¡©us
 = 
	`Ë32_to_ıu
(
desc
->
İts1
);

486 ià(
¡©us
 & 
DescOwn
)

489 
Ën
 = (
¡©us
 & 0x1fff) - 4;

490 
m­pšg
 = 
	`Ë64_to_ıu
(
desc
->
addr
);

492 ià((
¡©us
 & (
Fœ¡F¿g
 | 
La¡F¿g
)) != (FirstFrag | LastFrag)) {

498 
	`ı_rx_”r_acù
(
ı
, 
rx_
, 
¡©us
, 
Ën
);

499 
dev
->
¡©s
.
rx_drİ³d
++;

500 
ı
->
ı_¡©s
.
rx_äags
++;

501 
rx_Ãxt
;

504 ià(
¡©us
 & (
RxE¼Ü
 | 
RxE¼FIFO
)) {

505 
	`ı_rx_”r_acù
(
ı
, 
rx_
, 
¡©us
, 
Ën
);

506 
rx_Ãxt
;

509 
	`Ãtif_dbg
(
ı
, 
rx_¡©us
, 
dev
, "rx slot %d status 0x%x†en %d\n",

510 
rx_
, 
¡©us
, 
Ën
);

512 
Ãw_skb
 = 
	`Çpi_®loc_skb
(
Çpi
, 
buæ’
);

513 ià(!
Ãw_skb
) {

514 
dev
->
¡©s
.
rx_drİ³d
++;

515 
rx_Ãxt
;

518 
Ãw_m­pšg
 = 
	`dma_m­_sšgË
(&
ı
->
pdev
->
dev
, 
Ãw_skb
->
d©a
, 
buæ’
,

519 
PCI_DMA_FROMDEVICE
);

520 ià(
	`dma_m­pšg_”rÜ
(&
ı
->
pdev
->
dev
, 
Ãw_m­pšg
)) {

521 
dev
->
¡©s
.
rx_drİ³d
++;

522 
	`kä“_skb
(
Ãw_skb
);

523 
rx_Ãxt
;

526 
	`dma_unm­_sšgË
(&
ı
->
pdev
->
dev
, 
m­pšg
,

527 
buæ’
, 
PCI_DMA_FROMDEVICE
);

530 ià(
	`ı_rx_csum_ok
(
¡©us
))

531 
skb
->
_summed
 = 
CHECKSUM_UNNECESSARY
;

533 
	`skb_checksum_nÚe_as£¹
(
skb
);

535 
	`skb_put
(
skb
, 
Ën
);

537 
ı
->
rx_skb
[
rx_
] = 
Ãw_skb
;

539 
	`ı_rx_skb
(
ı
, 
skb
, 
desc
);

540 
rx
++;

541 
m­pšg
 = 
Ãw_m­pšg
;

543 
rx_Ãxt
:

544 
ı
->
rx_ršg
[
rx_
].
İts2
 = 0;

545 
ı
->
rx_ršg
[
rx_
].
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

546 ià(
rx_
 =ğ(
CP_RX_RING_SIZE
 - 1))

547 
desc
->
İts1
 = 
	`ıu_to_Ë32
(
DescOwn
 | 
RšgEnd
 |

548 
ı
->
rx_buf_sz
);

550 
desc
->
İts1
 = 
	`ıu_to_Ë32
(
DescOwn
 | 
ı
->
rx_buf_sz
);

551 
rx_
 = 
	`NEXT_RX
(rx_tail);

554 
ı
->
rx_
 =„x_tail;

559 ià(
rx
 < 
budg‘
) {

560 
æags
;

562 ià(
	`ır16
(
IÁrStus
è& 
ı_rx_šŒ_mask
)

563 
rx_¡©us_loİ
;

565 
	`Çpi_gro_æush
(
Çpi
, 
çl£
);

566 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

567 
	`__Çpi_com¶‘e
(
Çpi
);

568 
	`ıw16_f
(
IÁrMask
, 
ı_šŒ_mask
);

569 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

572  
rx
;

573 
	}
}

575 
œq»tuº_t
 
	$ı_š‹¼u±
 (
œq
, *
dev_š¡ªû
)

577 
Ãt_deviû
 *
dev
 = 
dev_š¡ªû
;

578 
ı_´iv©e
 *
ı
;

579 
hªdËd
 = 0;

580 
u16
 
¡©us
;

582 ià(
	`uÆik–y
(
dev
 =ğ
NULL
))

583  
IRQ_NONE
;

584 
ı
 = 
	`Ãtdev_´iv
(
dev
);

586 
	`¥š_lock
(&
ı
->
lock
);

588 
¡©us
 = 
	`ır16
(
IÁrStus
);

589 ià(!
¡©us
 || (status == 0xFFFF))

590 
out_uÆock
;

592 
hªdËd
 = 1;

594 
	`Ãtif_dbg
(
ı
, 
šŒ
, 
dev
, "intr, status %04x cmd %02x cpcmd %04x\n",

595 
¡©us
, 
	`ır8
(
Cmd
), 
	`ır16
(
CpCmd
));

597 
	`ıw16
(
IÁrStus
, 
¡©us
 & ~
ı_rx_šŒ_mask
);

600 ià(
	`uÆik–y
(!
	`Ãtif_ruÂšg
(
dev
))) {

601 
	`ıw16
(
IÁrMask
, 0);

602 
out_uÆock
;

605 ià(
¡©us
 & (
RxOK
 | 
RxE¼
 | 
RxEm±y
 | 
RxFIFOOvr
))

606 ià(
	`Çpi_scheduË_´•
(&
ı
->
Çpi
)) {

607 
	`ıw16_f
(
IÁrMask
, 
ı_nÜx_šŒ_mask
);

608 
	`__Çpi_scheduË
(&
ı
->
Çpi
);

611 ià(
¡©us
 & (
TxOK
 | 
TxE¼
 | 
TxEm±y
 | 
SWIÁ
))

612 
	`ı_tx
(
ı
);

613 ià(
¡©us
 & 
LškChg
)

614 
	`mii_check_medŸ
(&
ı
->
mii_if
, 
	`Ãtif_msg_lšk
(ı), 
çl£
);

617 ià(
¡©us
 & 
PciE¼
) {

618 
u16
 
pci_¡©us
;

620 
	`pci_»ad_cÚfig_wÜd
(
ı
->
pdev
, 
PCI_STATUS
, &
pci_¡©us
);

621 
	`pci_wr™e_cÚfig_wÜd
(
ı
->
pdev
, 
PCI_STATUS
, 
pci_¡©us
);

622 
	`Ãtdev_”r
(
dev
, "PCI busƒrror, status=%04x, PCI status=%04x\n",

623 
¡©us
, 
pci_¡©us
);

628 
out_uÆock
:

629 
	`¥š_uÆock
(&
ı
->
lock
);

631  
	`IRQ_RETVAL
(
hªdËd
);

632 
	}
}

634 #ifdeà
CONFIG_NET_POLL_CONTROLLER


639 
	$ı_pŞl_cÚŒŞËr
(
Ãt_deviû
 *
dev
)

641 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

642 cÚ¡ 
œq
 = 
ı
->
pdev
->irq;

644 
	`di§bË_œq
(
œq
);

645 
	`ı_š‹¼u±
(
œq
, 
dev
);

646 
	`’abË_œq
(
œq
);

647 
	}
}

650 
	$ı_tx
 (
ı_´iv©e
 *
ı
)

652 
tx_h—d
 = 
ı
->tx_head;

653 
tx_
 = 
ı
->tx_tail;

654 
by‹s_com¶
 = 0, 
pkts_com¶
 = 0;

656 
tx_
 !ğ
tx_h—d
) {

657 
ı_desc
 *
txd
 = 
ı
->
tx_ršg
 + 
tx_
;

658 
sk_buff
 *
skb
;

659 
u32
 
¡©us
;

661 
	`rmb
();

662 
¡©us
 = 
	`Ë32_to_ıu
(
txd
->
İts1
);

663 ià(
¡©us
 & 
DescOwn
)

666 
skb
 = 
ı
->
tx_skb
[
tx_
];

667 
	`BUG_ON
(!
skb
);

669 
	`dma_unm­_sšgË
(&
ı
->
pdev
->
dev
, 
	`Ë64_to_ıu
(
txd
->
addr
),

670 
ı
->
tx_İts
[
tx_
] & 0xffff,

671 
PCI_DMA_TODEVICE
);

673 ià(
¡©us
 & 
La¡F¿g
) {

674 ià(
¡©us
 & (
TxE¼Ü
 | 
TxFIFOUnd”
)) {

675 
	`Ãtif_dbg
(
ı
, 
tx_”r
, cp->
dev
,

676 "txƒ¼, stu 0x%x\n", 
¡©us
);

677 
ı
->
dev
->
¡©s
.
tx_”rÜs
++;

678 ià(
¡©us
 & 
TxOWC
)

679 
ı
->
dev
->
¡©s
.
tx_wšdow_”rÜs
++;

680 ià(
¡©us
 & 
TxMaxCŞ
)

681 
ı
->
dev
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

682 ià(
¡©us
 & 
TxLškFa
)

683 
ı
->
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

684 ià(
¡©us
 & 
TxFIFOUnd”
)

685 
ı
->
dev
->
¡©s
.
tx_fifo_”rÜs
++;

687 
ı
->
dev
->
¡©s
.
cŞlisiÚs
 +=

688 ((
¡©us
 >> 
TxCŞCÁShiá
è& 
TxCŞCÁMask
);

689 
ı
->
dev
->
¡©s
.
tx_·ck‘s
++;

690 
ı
->
dev
->
¡©s
.
tx_by‹s
 +ğ
skb
->
Ën
;

691 
	`Ãtif_dbg
(
ı
, 
tx_dÚe
, cp->
dev
,

692 "tx dÚe, slÙ %d\n", 
tx_
);

694 
by‹s_com¶
 +ğ
skb
->
Ën
;

695 
pkts_com¶
++;

696 
	`dev_kä“_skb_œq
(
skb
);

699 
ı
->
tx_skb
[
tx_
] = 
NULL
;

701 
tx_
 = 
	`NEXT_TX
(tx_tail);

704 
ı
->
tx_
 =x_tail;

706 
	`Ãtdev_com¶‘ed_queue
(
ı
->
dev
, 
pkts_com¶
, 
by‹s_com¶
);

707 ià(
	`TX_BUFFS_AVAIL
(
ı
è> (
MAX_SKB_FRAGS
 + 1))

708 
	`Ãtif_wake_queue
(
ı
->
dev
);

709 
	}
}

711 
šlše
 
u32
 
	$ı_tx_vÏn_g
(
sk_buff
 *
skb
)

713  
	`skb_vÏn_g_´e£Á
(
skb
) ?

714 
TxVÏnTag
 | 
	`swab16
(
	`skb_vÏn_g_g‘
(
skb
)) : 0x00;

715 
	}
}

717 
	$unwšd_tx_äag_m­pšg
(
ı_´iv©e
 *
ı
, 
sk_buff
 *
skb
,

718 
fœ¡
, 
’Œy_Ï¡
)

720 
äag
, 
šdex
;

721 
ı_desc
 *
txd
;

722 
skb_äag_t
 *
this_äag
;

723 
äag
 = 0; f¿g+
fœ¡
 < 
’Œy_Ï¡
; frag++) {

724 
šdex
 = 
fœ¡
+
äag
;

725 
ı
->
tx_skb
[
šdex
] = 
NULL
;

726 
txd
 = &
ı
->
tx_ršg
[
šdex
];

727 
this_äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
äag
];

728 
	`dma_unm­_sšgË
(&
ı
->
pdev
->
dev
, 
	`Ë64_to_ıu
(
txd
->
addr
),

729 
	`skb_äag_size
(
this_äag
), 
PCI_DMA_TODEVICE
);

731 
	}
}

733 
Ãtdev_tx_t
 
	$ı_¡¬t_xm™
 (
sk_buff
 *
skb
,

734 
Ãt_deviû
 *
dev
)

736 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

737 
’Œy
;

738 
u32
 
eÜ
, 
İts1
;

739 
šŒ_æags
;

740 
__Ë32
 
İts2
;

741 
mss
 = 0;

743 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
šŒ_æags
);

746 ià(
	`TX_BUFFS_AVAIL
(
ı
è<ğ(
	`skb_shšfo
(
skb
)->
Ä_äags
 + 1)) {

747 
	`Ãtif_¡İ_queue
(
dev
);

748 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
šŒ_æags
);

749 
	`Ãtdev_”r
(
dev
, "BUG! Tx Ring full when queue‡wake!\n");

750  
NETDEV_TX_BUSY
;

753 
’Œy
 = 
ı
->
tx_h—d
;

754 
eÜ
 = (
’Œy
 =ğ(
CP_TX_RING_SIZE
 - 1)è? 
RšgEnd
 : 0;

755 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
;

757 ià(
mss
 > 
MSSMask
) {

758 
	`WARN_ONCE
(1, "Net bug: GSO size %doo†arge for 8139CP\n",

759 
mss
);

760 
out_dma_”rÜ
;

763 
İts2
 = 
	`ıu_to_Ë32
(
	`ı_tx_vÏn_g
(
skb
));

764 
İts1
 = 
DescOwn
;

765 ià(
mss
)

766 
İts1
 |ğ
L¬geS’d
 | (
mss
 << 
MSSShiá
);

767 ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

768 cÚ¡ 
hdr
 *

 = 
	`_hdr
(
skb
);

769 ià(

->
´ÙocŞ
 =ğ
IPPROTO_TCP
)

770 
İts1
 |ğ
IPCS
 | 
TCPCS
;

771 ià(

->
´ÙocŞ
 =ğ
IPPROTO_UDP
)

772 
İts1
 |ğ
IPCS
 | 
UDPCS
;

774 
	`WARN_ONCE
(1,

776 
out_dma_”rÜ
;

780 ià(
	`skb_shšfo
(
skb
)->
Ä_äags
 == 0) {

781 
ı_desc
 *
txd
 = &
ı
->
tx_ršg
[
’Œy
];

782 
u32
 
Ën
;

783 
dma_addr_t
 
m­pšg
;

785 
Ën
 = 
skb
->len;

786 
m­pšg
 = 
	`dma_m­_sšgË
(&
ı
->
pdev
->
dev
, 
skb
->
d©a
, 
Ën
, 
PCI_DMA_TODEVICE
);

787 ià(
	`dma_m­pšg_”rÜ
(&
ı
->
pdev
->
dev
, 
m­pšg
))

788 
out_dma_”rÜ
;

790 
txd
->
İts2
 = opts2;

791 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

792 
	`wmb
();

794 
İts1
 |ğ
eÜ
 | 
Ën
 | 
Fœ¡F¿g
 | 
La¡F¿g
;

796 
txd
->
İts1
 = 
	`ıu_to_Ë32
(opts1);

797 
	`wmb
();

799 
ı
->
tx_skb
[
’Œy
] = 
skb
;

800 
ı
->
tx_İts
[
’Œy
] = 
İts1
;

801 
	`Ãtif_dbg
(
ı
, 
tx_queued
, cp->
dev
, "tx queued, slot %d, skblen %d\n",

802 
’Œy
, 
skb
->
Ën
);

804 
ı_desc
 *
txd
;

805 
u32
 
fœ¡_Ën
, 
fœ¡_eÜ
, 
ù¾
;

806 
dma_addr_t
 
fœ¡_m­pšg
;

807 
äag
, 
fœ¡_’Œy
 = 
’Œy
;

812 
fœ¡_eÜ
 = 
eÜ
;

813 
fœ¡_Ën
 = 
	`skb_h—dËn
(
skb
);

814 
fœ¡_m­pšg
 = 
	`dma_m­_sšgË
(&
ı
->
pdev
->
dev
, 
skb
->
d©a
,

815 
fœ¡_Ën
, 
PCI_DMA_TODEVICE
);

816 ià(
	`dma_m­pšg_”rÜ
(&
ı
->
pdev
->
dev
, 
fœ¡_m­pšg
))

817 
out_dma_”rÜ
;

819 
ı
->
tx_skb
[
’Œy
] = 
skb
;

821 
äag
 = 0; f¿g < 
	`skb_shšfo
(
skb
)->
Ä_äags
; frag++) {

822 cÚ¡ 
skb_äag_t
 *
this_äag
 = &
	`skb_shšfo
(
skb
)->
äags
[
äag
];

823 
u32
 
Ën
;

824 
dma_addr_t
 
m­pšg
;

826 
’Œy
 = 
	`NEXT_TX
(entry);

828 
Ën
 = 
	`skb_äag_size
(
this_äag
);

829 
m­pšg
 = 
	`dma_m­_sšgË
(&
ı
->
pdev
->
dev
,

830 
	`skb_äag_add»ss
(
this_äag
),

831 
Ën
, 
PCI_DMA_TODEVICE
);

832 ià(
	`dma_m­pšg_”rÜ
(&
ı
->
pdev
->
dev
, 
m­pšg
)) {

833 
	`unwšd_tx_äag_m­pšg
(
ı
, 
skb
, 
fœ¡_’Œy
, 
’Œy
);

834 
out_dma_”rÜ
;

837 
eÜ
 = (
’Œy
 =ğ(
CP_TX_RING_SIZE
 - 1)è? 
RšgEnd
 : 0;

839 
ù¾
 = 
İts1
 | 
eÜ
 | 
Ën
;

841 ià(
äag
 =ğ
	`skb_shšfo
(
skb
)->
Ä_äags
 - 1)

842 
ù¾
 |ğ
La¡F¿g
;

844 
txd
 = &
ı
->
tx_ršg
[
’Œy
];

845 
txd
->
İts2
 = opts2;

846 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

847 
	`wmb
();

849 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
ù¾
);

850 
	`wmb
();

852 
ı
->
tx_İts
[
’Œy
] = 
ù¾
;

853 
ı
->
tx_skb
[
’Œy
] = 
skb
;

856 
txd
 = &
ı
->
tx_ršg
[
fœ¡_’Œy
];

857 
txd
->
İts2
 = opts2;

858 
txd
->
addr
 = 
	`ıu_to_Ë64
(
fœ¡_m­pšg
);

859 
	`wmb
();

861 
ù¾
 = 
İts1
 | 
fœ¡_eÜ
 | 
fœ¡_Ën
 | 
Fœ¡F¿g
;

862 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
ù¾
);

863 
	`wmb
();

865 
ı
->
tx_İts
[
fœ¡_’Œy
] = 
ù¾
;

866 
	`Ãtif_dbg
(
ı
, 
tx_queued
, cp->
dev
, "tx queued, slots %d-%d, skblen %d\n",

867 
fœ¡_’Œy
, 
’Œy
, 
skb
->
Ën
);

869 
ı
->
tx_h—d
 = 
	`NEXT_TX
(
’Œy
);

871 
	`Ãtdev_£Á_queue
(
dev
, 
skb
->
Ën
);

872 ià(
	`TX_BUFFS_AVAIL
(
ı
è<ğ(
MAX_SKB_FRAGS
 + 1))

873 
	`Ãtif_¡İ_queue
(
dev
);

875 
out_uÆock
:

876 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
šŒ_æags
);

878 
	`ıw8
(
TxPŞl
, 
NÜm®TxPŞl
);

880  
NETDEV_TX_OK
;

881 
out_dma_”rÜ
:

882 
	`dev_kä“_skb_ªy
(
skb
);

883 
ı
->
dev
->
¡©s
.
tx_drİ³d
++;

884 
out_uÆock
;

885 
	}
}

890 
	$__ı_£t_rx_mode
 (
Ãt_deviû
 *
dev
)

892 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

893 
u32
 
mc_f‹r
[2];

894 
rx_mode
;

897 ià(
dev
->
æags
 & 
IFF_PROMISC
) {

899 
rx_mode
 =

900 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
 |

901 
Acû±AÎPhys
;

902 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

903 } ià((
	`Ãtdev_mc_couÁ
(
dev
è> 
muÉiÿ¡_f‹r_lim™
) ||

904 (
dev
->
æags
 & 
IFF_ALLMULTI
)) {

906 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
;

907 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

909 
Ãtdev_hw_addr
 *
ha
;

910 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

911 
mc_f‹r
[1] = mc_filter[0] = 0;

912 
	`Ãtdev_fÜ_—ch_mc_addr
(
ha
, 
dev
) {

913 
b™_Ä
 = 
	`‘h”_üc
(
ETH_ALEN
, 
ha
->
addr
) >> 26;

915 
mc_f‹r
[
b™_Ä
 >> 5] |= 1 << (bit_nr & 31);

916 
rx_mode
 |ğ
Acû±MuÉiÿ¡
;

921 
ı
->
rx_cÚfig
 = 
ı_rx_cÚfig
 | 
rx_mode
;

922 
	`ıw32_f
(
RxCÚfig
, 
ı
->
rx_cÚfig
);

924 
	`ıw32_f
 (
MAR0
 + 0, 
mc_f‹r
[0]);

925 
	`ıw32_f
 (
MAR0
 + 4, 
mc_f‹r
[1]);

926 
	}
}

928 
	$ı_£t_rx_mode
 (
Ãt_deviû
 *
dev
)

930 
æags
;

931 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

933 
	`¥š_lock_œq§ve
 (&
ı
->
lock
, 
æags
);

934 
	`__ı_£t_rx_mode
(
dev
);

935 
	`¥š_uÆock_œq»¡Üe
 (&
ı
->
lock
, 
æags
);

936 
	}
}

938 
	$__ı_g‘_¡©s
(
ı_´iv©e
 *
ı
)

941 
ı
->
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ(
	`ır32
 (
RxMis£d
) & 0xffffff);

942 
	`ıw32
 (
RxMis£d
, 0);

943 
	}
}

945 
Ãt_deviû_¡©s
 *
	$ı_g‘_¡©s
(
Ãt_deviû
 *
dev
)

947 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

948 
æags
;

951 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

952 ià(
	`Ãtif_ruÂšg
(
dev
è&& 
	`Ãtif_deviû_´e£Á
(dev))

953 
	`__ı_g‘_¡©s
(
ı
);

954 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

956  &
dev
->
¡©s
;

957 
	}
}

959 
	$ı_¡İ_hw
 (
ı_´iv©e
 *
ı
)

961 
	`ıw16
(
IÁrStus
, ~(
	`ır16
(IntrStatus)));

962 
	`ıw16_f
(
IÁrMask
, 0);

963 
	`ıw8
(
Cmd
, 0);

964 
	`ıw16_f
(
CpCmd
, 0);

965 
	`ıw16_f
(
IÁrStus
, ~(
	`ır16
(IntrStatus)));

967 
ı
->
rx_
 = 0;

968 
ı
->
tx_h—d
 = cp->
tx_
 = 0;

970 
	`Ãtdev_»£t_queue
(
ı
->
dev
);

971 
	}
}

973 
	$ı_»£t_hw
 (
ı_´iv©e
 *
ı
)

975 
wÜk
 = 1000;

977 
	`ıw8
(
Cmd
, 
CmdRe£t
);

979 
wÜk
--) {

980 ià(!(
	`ır8
(
Cmd
è& 
CmdRe£t
))

983 
	`scheduË_timeout_unš‹¼u±ibË
(10);

986 
	`Ãtdev_”r
(
ı
->
dev
, "hardware„esetimeout\n");

987 
	}
}

989 
šlše
 
	$ı_¡¬t_hw
 (
ı_´iv©e
 *
ı
)

991 
dma_addr_t
 
ršg_dma
;

993 
	`ıw16
(
CpCmd
, 
ı
->
ıcmd
);

1003 
	`ıw32_f
(
HiTxRšgAddr
, 0);

1004 
	`ıw32_f
(
HiTxRšgAddr
 + 4, 0);

1006 
ršg_dma
 = 
ı
->ring_dma;

1007 
	`ıw32_f
(
RxRšgAddr
, 
ršg_dma
 & 0xffffffff);

1008 
	`ıw32_f
(
RxRšgAddr
 + 4, (
ršg_dma
 >> 16) >> 16);

1010 
ršg_dma
 +ğ(
ı_desc
è* 
CP_RX_RING_SIZE
;

1011 
	`ıw32_f
(
TxRšgAddr
, 
ršg_dma
 & 0xffffffff);

1012 
	`ıw32_f
(
TxRšgAddr
 + 4, (
ršg_dma
 >> 16) >> 16);

1020 
	`ıw8
(
Cmd
, 
RxOn
 | 
TxOn
);

1022 
	`Ãtdev_»£t_queue
(
ı
->
dev
);

1023 
	}
}

1025 
	$ı_’abË_œq
(
ı_´iv©e
 *
ı
)

1027 
	`ıw16_f
(
IÁrMask
, 
ı_šŒ_mask
);

1028 
	}
}

1030 
	$ı_š™_hw
 (
ı_´iv©e
 *
ı
)

1032 
Ãt_deviû
 *
dev
 = 
ı
->dev;

1034 
	`ı_»£t_hw
(
ı
);

1036 
	`ıw8_f
 (
Cfg9346
, 
Cfg9346_UÆock
);

1039 
	`ıw32_f
 (
MAC0
 + 0, 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
dev
->
dev_addr
 + 0)));

1040 
	`ıw32_f
 (
MAC0
 + 4, 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
dev
->
dev_addr
 + 4)));

1042 
	`ı_¡¬t_hw
(
ı
);

1043 
	`ıw8
(
TxTh»sh
, 0x06);

1045 
	`__ı_£t_rx_mode
(
dev
);

1046 
	`ıw32_f
 (
TxCÚfig
, 
IFG
 | (
TX_DMA_BURST
 << 
TxDMAShiá
));

1048 
	`ıw8
(
CÚfig1
, 
	`ır8
(CÚfig1è| 
Driv”Lßded
 | 
PMEÇbË
);

1050 
	`ıw8
(
CÚfig3
, 
PARMEÇbË
);

1051 
ı
->
wŞ_’abËd
 = 0;

1053 
	`ıw8
(
CÚfig5
, 
	`ır8
(CÚfig5è& 
PMEStus
);

1055 
	`ıw16
(
MuÉiIÁr
, 0);

1057 
	`ıw8_f
(
Cfg9346
, 
Cfg9346_Lock
);

1058 
	}
}

1060 
	$ı_»fl_rx
(
ı_´iv©e
 *
ı
)

1062 
Ãt_deviû
 *
dev
 = 
ı
->dev;

1063 
i
;

1065 
i
 = 0; i < 
CP_RX_RING_SIZE
; i++) {

1066 
sk_buff
 *
skb
;

1067 
dma_addr_t
 
m­pšg
;

1069 
skb
 = 
	`Ãtdev_®loc_skb__®ign
(
dev
, 
ı
->
rx_buf_sz
);

1070 ià(!
skb
)

1071 
”r_out
;

1073 
m­pšg
 = 
	`dma_m­_sšgË
(&
ı
->
pdev
->
dev
, 
skb
->
d©a
,

1074 
ı
->
rx_buf_sz
, 
PCI_DMA_FROMDEVICE
);

1075 ià(
	`dma_m­pšg_”rÜ
(&
ı
->
pdev
->
dev
, 
m­pšg
)) {

1076 
	`kä“_skb
(
skb
);

1077 
”r_out
;

1079 
ı
->
rx_skb
[
i
] = 
skb
;

1081 
ı
->
rx_ršg
[
i
].
İts2
 = 0;

1082 
ı
->
rx_ršg
[
i
].
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

1083 ià(
i
 =ğ(
CP_RX_RING_SIZE
 - 1))

1084 
ı
->
rx_ršg
[
i
].
İts1
 =

1085 
	`ıu_to_Ë32
(
DescOwn
 | 
RšgEnd
 | 
ı
->
rx_buf_sz
);

1087 
ı
->
rx_ršg
[
i
].
İts1
 =

1088 
	`ıu_to_Ë32
(
DescOwn
 | 
ı
->
rx_buf_sz
);

1093 
”r_out
:

1094 
	`ı_ş—n_ršgs
(
ı
);

1095  -
ENOMEM
;

1096 
	}
}

1098 
	$ı_š™_ršgs_šdex
 (
ı_´iv©e
 *
ı
)

1100 
ı
->
rx_
 = 0;

1101 
ı
->
tx_h—d
 = cp->
tx_
 = 0;

1102 
	}
}

1104 
	$ı_š™_ršgs
 (
ı_´iv©e
 *
ı
)

1106 
	`mem£t
(
ı
->
tx_ršg
, 0, (
ı_desc
è* 
CP_TX_RING_SIZE
);

1107 
ı
->
tx_ršg
[
CP_TX_RING_SIZE
 - 1].
İts1
 = 
	`ıu_to_Ë32
(
RšgEnd
);

1108 
	`mem£t
(
ı
->
tx_İts
, 0, (cp->tx_opts));

1110 
	`ı_š™_ršgs_šdex
(
ı
);

1112  
	`ı_»fl_rx
 (
ı
);

1113 
	}
}

1115 
	$ı_®loc_ršgs
 (
ı_´iv©e
 *
ı
)

1117 
deviû
 *
d
 = &
ı
->
pdev
->
dev
;

1118 *
mem
;

1119 
rc
;

1121 
mem
 = 
	`dma_®loc_coh”’t
(
d
, 
CP_RING_BYTES
, &
ı
->
ršg_dma
, 
GFP_KERNEL
);

1122 ià(!
mem
)

1123  -
ENOMEM
;

1125 
ı
->
rx_ršg
 = 
mem
;

1126 
ı
->
tx_ršg
 = &ı->
rx_ršg
[
CP_RX_RING_SIZE
];

1128 
rc
 = 
	`ı_š™_ršgs
(
ı
);

1129 ià(
rc
 < 0)

1130 
	`dma_ä“_coh”’t
(
d
, 
CP_RING_BYTES
, 
ı
->
rx_ršg
, cp->
ršg_dma
);

1132  
rc
;

1133 
	}
}

1135 
	$ı_ş—n_ršgs
 (
ı_´iv©e
 *
ı
)

1137 
ı_desc
 *
desc
;

1138 
i
;

1140 
i
 = 0; i < 
CP_RX_RING_SIZE
; i++) {

1141 ià(
ı
->
rx_skb
[
i
]) {

1142 
desc
 = 
ı
->
rx_ršg
 + 
i
;

1143 
	`dma_unm­_sšgË
(&
ı
->
pdev
->
dev
,
	`Ë64_to_ıu
(
desc
->
addr
),

1144 
ı
->
rx_buf_sz
, 
PCI_DMA_FROMDEVICE
);

1145 
	`dev_kä“_skb_ªy
(
ı
->
rx_skb
[
i
]);

1149 
i
 = 0; i < 
CP_TX_RING_SIZE
; i++) {

1150 ià(
ı
->
tx_skb
[
i
]) {

1151 
sk_buff
 *
skb
 = 
ı
->
tx_skb
[
i
];

1153 
desc
 = 
ı
->
tx_ršg
 + 
i
;

1154 
	`dma_unm­_sšgË
(&
ı
->
pdev
->
dev
,
	`Ë64_to_ıu
(
desc
->
addr
),

1155 
	`Ë32_to_ıu
(
desc
->
İts1
) & 0xffff,

1156 
PCI_DMA_TODEVICE
);

1157 ià(
	`Ë32_to_ıu
(
desc
->
İts1
è& 
La¡F¿g
)

1158 
	`dev_kä“_skb_ªy
(
skb
);

1159 
ı
->
dev
->
¡©s
.
tx_drİ³d
++;

1162 
	`Ãtdev_»£t_queue
(
ı
->
dev
);

1164 
	`mem£t
(
ı
->
rx_ršg
, 0, (
ı_desc
è* 
CP_RX_RING_SIZE
);

1165 
	`mem£t
(
ı
->
tx_ršg
, 0, (
ı_desc
è* 
CP_TX_RING_SIZE
);

1166 
	`mem£t
(
ı
->
tx_İts
, 0, (cp->tx_opts));

1168 
	`mem£t
(
ı
->
rx_skb
, 0, (
sk_buff
 *è* 
CP_RX_RING_SIZE
);

1169 
	`mem£t
(
ı
->
tx_skb
, 0, (
sk_buff
 *è* 
CP_TX_RING_SIZE
);

1170 
	}
}

1172 
	$ı_ä“_ršgs
 (
ı_´iv©e
 *
ı
)

1174 
	`ı_ş—n_ršgs
(
ı
);

1175 
	`dma_ä“_coh”’t
(&
ı
->
pdev
->
dev
, 
CP_RING_BYTES
, cp->
rx_ršg
,

1176 
ı
->
ršg_dma
);

1177 
ı
->
rx_ršg
 = 
NULL
;

1178 
ı
->
tx_ršg
 = 
NULL
;

1179 
	}
}

1181 
	$ı_İ’
 (
Ãt_deviû
 *
dev
)

1183 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1184 cÚ¡ 
œq
 = 
ı
->
pdev
->irq;

1185 
rc
;

1187 
	`Ãtif_dbg
(
ı
, 
ifup
, 
dev
, "enabling interface\n");

1189 
rc
 = 
	`ı_®loc_ršgs
(
ı
);

1190 ià(
rc
)

1191  
rc
;

1193 
	`Çpi_’abË
(&
ı
->
Çpi
);

1195 
	`ı_š™_hw
(
ı
);

1197 
rc
 = 
	`»que¡_œq
(
œq
, 
ı_š‹¼u±
, 
IRQF_SHARED
, 
dev
->
Çme
, dev);

1198 ià(
rc
)

1199 
”r_out_hw
;

1201 
	`ı_’abË_œq
(
ı
);

1203 
	`Ãtif_ÿ¼›r_off
(
dev
);

1204 
	`mii_check_medŸ
(&
ı
->
mii_if
, 
	`Ãtif_msg_lšk
(ı), 
Œue
);

1205 
	`Ãtif_¡¬t_queue
(
dev
);

1209 
”r_out_hw
:

1210 
	`Çpi_di§bË
(&
ı
->
Çpi
);

1211 
	`ı_¡İ_hw
(
ı
);

1212 
	`ı_ä“_ršgs
(
ı
);

1213  
rc
;

1214 
	}
}

1216 
	$ı_şo£
 (
Ãt_deviû
 *
dev
)

1218 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1219 
æags
;

1221 
	`Çpi_di§bË
(&
ı
->
Çpi
);

1223 
	`Ãtif_dbg
(
ı
, 
ifdown
, 
dev
, "disabling interface\n");

1225 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1227 
	`Ãtif_¡İ_queue
(
dev
);

1228 
	`Ãtif_ÿ¼›r_off
(
dev
);

1230 
	`ı_¡İ_hw
(
ı
);

1232 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1234 
	`ä“_œq
(
ı
->
pdev
->
œq
, 
dev
);

1236 
	`ı_ä“_ršgs
(
ı
);

1238 
	}
}

1240 
	$ı_tx_timeout
(
Ãt_deviû
 *
dev
)

1242 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1243 
æags
;

1244 
rc
, 
i
;

1246 
	`Ãtdev_w¬n
(
dev
, "Transmitimeout, status %2x %4x %4x %4x\n",

1247 
	`ır8
(
Cmd
), 
	`ır16
(
CpCmd
),

1248 
	`ır16
(
IÁrStus
), c´16(
IÁrMask
));

1250 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1252 
	`Ãtif_dbg
(
ı
, 
tx_”r
, cp->
dev
, "TX„ing head %dail %d desc %x\n",

1253 
ı
->
tx_h—d
, cp->
tx_
, 
	`ır16
(
TxDmaOkLowDesc
));

1254 
i
 = 0; i < 
CP_TX_RING_SIZE
; i++) {

1255 
	`Ãtif_dbg
(
ı
, 
tx_”r
, cp->
dev
,

1257 
i
, &
ı
->
tx_ršg
[i], 
	`Ë32_to_ıu
(ı->tx_ršg[i].
İts1
),

1258 
ı
->
tx_İts
[
i
], 
	`Ë32_to_ıu
(ı->
tx_ršg
[i].
İts2
),

1259 
	`Ë64_to_ıu
(
ı
->
tx_ršg
[
i
].
addr
),

1260 
ı
->
tx_skb
[
i
]);

1263 
	`ı_¡İ_hw
(
ı
);

1264 
	`ı_ş—n_ršgs
(
ı
);

1265 
rc
 = 
	`ı_š™_ršgs
(
ı
);

1266 
	`ı_¡¬t_hw
(
ı
);

1267 
	`__ı_£t_rx_mode
(
dev
);

1268 
	`ıw16_f
(
IÁrMask
, 
ı_nÜx_šŒ_mask
);

1270 
	`Ãtif_wake_queue
(
dev
);

1271 
	`Çpi_scheduË_œqoff
(&
ı
->
Çpi
);

1273 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1274 
	}
}

1276 
	$ı_chªge_mtu
(
Ãt_deviû
 *
dev
, 
Ãw_mtu
)

1278 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1281 ià(
Ãw_mtu
 < 
CP_MIN_MTU
 ||‚ew_mtu > 
CP_MAX_MTU
)

1282  -
EINVAL
;

1285 ià(!
	`Ãtif_ruÂšg
(
dev
)) {

1286 
dev
->
mtu
 = 
Ãw_mtu
;

1287 
	`ı_£t_rxbufsize
(
ı
);

1292 
	`ı_şo£
(
dev
);

1293 
dev
->
mtu
 = 
Ãw_mtu
;

1294 
	`ı_£t_rxbufsize
(
ı
);

1295  
	`ı_İ’
(
dev
);

1296 
	}
}

1298 cÚ¡ 
	gmii_2_8139_m­
[8] = {

1299 
BasicModeCŒl
,

1300 
BasicModeStus
,

1303 
NWayAdv”t
,

1304 
NWayLPAR
,

1305 
NWayEx·nsiÚ
,

1309 
	$mdio_»ad
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
)

1311 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1313  
loÿtiÚ
 < 8 && 
mii_2_8139_m­
[location] ?

1314 
	`»adw
(
ı
->
»gs
 + 
mii_2_8139_m­
[
loÿtiÚ
]) : 0;

1315 
	}
}

1318 
	$mdio_wr™e
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
,

1319 
v®ue
)

1321 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1323 ià(
loÿtiÚ
 == 0) {

1324 
	`ıw8
(
Cfg9346
, 
Cfg9346_UÆock
);

1325 
	`ıw16
(
BasicModeCŒl
, 
v®ue
);

1326 
	`ıw8
(
Cfg9346
, 
Cfg9346_Lock
);

1327 } ià(
loÿtiÚ
 < 8 && 
mii_2_8139_m­
[location])

1328 
	`ıw16
(
mii_2_8139_m­
[
loÿtiÚ
], 
v®ue
);

1329 
	}
}

1332 
	$Ãtdev_£t_wŞ
 (
ı_´iv©e
 *
ı
,

1333 cÚ¡ 
‘htoŞ_wŞšfo
 *
wŞ
)

1335 
u8
 
İtiÚs
;

1337 
İtiÚs
 = 
	`ır8
 (
CÚfig3
è& ~(
LškUp
 | 
MagicPack‘
);

1339 ià(
wŞ
->
wŞİts
) {

1340 ià(
wŞ
->
wŞİts
 & 
WAKE_PHY
è
İtiÚs
 |ğ
LškUp
;

1341 ià(
wŞ
->
wŞİts
 & 
WAKE_MAGIC
è
İtiÚs
 |ğ
MagicPack‘
;

1344 
	`ıw8
 (
Cfg9346
, 
Cfg9346_UÆock
);

1345 
	`ıw8
 (
CÚfig3
, 
İtiÚs
);

1346 
	`ıw8
 (
Cfg9346
, 
Cfg9346_Lock
);

1348 
İtiÚs
 = 0;

1349 
İtiÚs
 = 
	`ır8
 (
CÚfig5
è& ~(
UWF
 | 
MWF
 | 
BWF
);

1351 ià(
wŞ
->
wŞİts
) {

1352 ià(
wŞ
->
wŞİts
 & 
WAKE_UCAST
è
İtiÚs
 |ğ
UWF
;

1353 ià(
wŞ
->
wŞİts
 & 
WAKE_BCAST
è
İtiÚs
 |ğ
BWF
;

1354 ià(
wŞ
->
wŞİts
 & 
WAKE_MCAST
è
İtiÚs
 |ğ
MWF
;

1357 
	`ıw8
 (
CÚfig5
, 
İtiÚs
);

1359 
ı
->
wŞ_’abËd
 = (
wŞ
->
wŞİts
) ? 1 : 0;

1362 
	}
}

1365 
	$Ãtdev_g‘_wŞ
 (
ı_´iv©e
 *
ı
,

1366 
‘htoŞ_wŞšfo
 *
wŞ
)

1368 
u8
 
İtiÚs
;

1370 
wŞ
->
wŞİts
 = 0;

1371 
wŞ
->
suµÜ‹d
 = 
WAKE_PHY
 | 
WAKE_BCAST
 | 
WAKE_MAGIC
 |

1372 
WAKE_MCAST
 | 
WAKE_UCAST
;

1374 ià(!
ı
->
wŞ_’abËd
) ;

1376 
İtiÚs
 = 
	`ır8
 (
CÚfig3
);

1377 ià(
İtiÚs
 & 
LškUp
è
wŞ
->
wŞİts
 |ğ
WAKE_PHY
;

1378 ià(
İtiÚs
 & 
MagicPack‘
è
wŞ
->
wŞİts
 |ğ
WAKE_MAGIC
;

1380 
İtiÚs
 = 0;

1381 
İtiÚs
 = 
	`ır8
 (
CÚfig5
);

1382 ià(
İtiÚs
 & 
UWF
è
wŞ
->
wŞİts
 |ğ
WAKE_UCAST
;

1383 ià(
İtiÚs
 & 
BWF
è
wŞ
->
wŞİts
 |ğ
WAKE_BCAST
;

1384 ià(
İtiÚs
 & 
MWF
è
wŞ
->
wŞİts
 |ğ
WAKE_MCAST
;

1385 
	}
}

1387 
	$ı_g‘_drvšfo
 (
Ãt_deviû
 *
dev
, 
‘htoŞ_drvšfo
 *
šfo
)

1389 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1391 
	`¡¾ıy
(
šfo
->
driv”
, 
DRV_NAME
, (info->driver));

1392 
	`¡¾ıy
(
šfo
->
v”siÚ
, 
DRV_VERSION
, (info->version));

1393 
	`¡¾ıy
(
šfo
->
bus_šfo
, 
	`pci_Çme
(
ı
->
pdev
), (info->bus_info));

1394 
	}
}

1396 
	$ı_g‘_ršg·¿m
(
Ãt_deviû
 *
dev
,

1397 
‘htoŞ_ršg·¿m
 *
ršg
)

1399 
ršg
->
rx_max_³ndšg
 = 
CP_RX_RING_SIZE
;

1400 
ršg
->
tx_max_³ndšg
 = 
CP_TX_RING_SIZE
;

1401 
ršg
->
rx_³ndšg
 = 
CP_RX_RING_SIZE
;

1402 
ršg
->
tx_³ndšg
 = 
CP_TX_RING_SIZE
;

1403 
	}
}

1405 
	$ı_g‘_»gs_Ën
(
Ãt_deviû
 *
dev
)

1407  
CP_REGS_SIZE
;

1408 
	}
}

1410 
	$ı_g‘_s£t_couÁ
 (
Ãt_deviû
 *
dev
, 
s£t
)

1412 
s£t
) {

1413 
ETH_SS_STATS
:

1414  
CP_NUM_STATS
;

1416  -
EOPNOTSUPP
;

1418 
	}
}

1420 
	$ı_g‘_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

1422 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1423 
rc
;

1424 
æags
;

1426 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1427 
rc
 = 
	`mii_‘htoŞ_g£t
(&
ı
->
mii_if
, 
cmd
);

1428 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1430  
rc
;

1431 
	}
}

1433 
	$ı_£t_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

1435 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1436 
rc
;

1437 
æags
;

1439 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1440 
rc
 = 
	`mii_‘htoŞ_s£t
(&
ı
->
mii_if
, 
cmd
);

1441 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1443  
rc
;

1444 
	}
}

1446 
	$ı_nway_»£t
(
Ãt_deviû
 *
dev
)

1448 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1449  
	`mii_nway_»¡¬t
(&
ı
->
mii_if
);

1450 
	}
}

1452 
u32
 
	$ı_g‘_msgËv–
(
Ãt_deviû
 *
dev
)

1454 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1455  
ı
->
msg_’abË
;

1456 
	}
}

1458 
	$ı_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
v®ue
)

1460 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1461 
ı
->
msg_’abË
 = 
v®ue
;

1462 
	}
}

1464 
	$ı_£t_ã©u»s
(
Ãt_deviû
 *
dev
, 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1466 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1467 
æags
;

1469 ià(!((
dev
->
ã©u»s
 ^ f—tu»sè& 
NETIF_F_RXCSUM
))

1472 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1474 ià(
ã©u»s
 & 
NETIF_F_RXCSUM
)

1475 
ı
->
ıcmd
 |ğ
RxChkSum
;

1477 
ı
->
ıcmd
 &ğ~
RxChkSum
;

1479 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_RX
)

1480 
ı
->
ıcmd
 |ğ
RxVÏnOn
;

1482 
ı
->
ıcmd
 &ğ~
RxVÏnOn
;

1484 
	`ıw16_f
(
CpCmd
, 
ı
->
ıcmd
);

1485 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1488 
	}
}

1490 
	$ı_g‘_»gs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_»gs
 *
»gs
,

1491 *
p
)

1493 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1494 
æags
;

1496 ià(
»gs
->
Ën
 < 
CP_REGS_SIZE
)

1499 
»gs
->
v”siÚ
 = 
CP_REGS_VER
;

1501 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1502 
	`memıy_äomio
(
p
, 
ı
->
»gs
, 
CP_REGS_SIZE
);

1503 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1504 
	}
}

1506 
	$ı_g‘_wŞ
 (
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1508 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1509 
æags
;

1511 
	`¥š_lock_œq§ve
 (&
ı
->
lock
, 
æags
);

1512 
	`Ãtdev_g‘_wŞ
 (
ı
, 
wŞ
);

1513 
	`¥š_uÆock_œq»¡Üe
 (&
ı
->
lock
, 
æags
);

1514 
	}
}

1516 
	$ı_£t_wŞ
 (
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1518 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1519 
æags
;

1520 
rc
;

1522 
	`¥š_lock_œq§ve
 (&
ı
->
lock
, 
æags
);

1523 
rc
 = 
	`Ãtdev_£t_wŞ
 (
ı
, 
wŞ
);

1524 
	`¥š_uÆock_œq»¡Üe
 (&
ı
->
lock
, 
æags
);

1526  
rc
;

1527 
	}
}

1529 
	$ı_g‘_¡ršgs
 (
Ãt_deviû
 *
dev
, 
u32
 
¡ršg£t
, 
u8
 *
buf
)

1531 
¡ršg£t
) {

1532 
ETH_SS_STATS
:

1533 
	`memıy
(
buf
, &
‘htoŞ_¡©s_keys
, (ethtool_stats_keys));

1536 
	`BUG
();

1539 
	}
}

1541 
	$ı_g‘_‘htoŞ_¡©s
 (
Ãt_deviû
 *
dev
,

1542 
‘htoŞ_¡©s
 *
e¡©s
, 
u64
 *
tmp_¡©s
)

1544 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1545 
ı_dma_¡©s
 *
nic_¡©s
;

1546 
dma_addr_t
 
dma
;

1547 
i
;

1549 
nic_¡©s
 = 
	`dma_®loc_coh”’t
(&
ı
->
pdev
->
dev
, (*nic_stats),

1550 &
dma
, 
GFP_KERNEL
);

1551 ià(!
nic_¡©s
)

1555 
	`ıw32
(
StsAddr
 + 4, (
u64
)
dma
 >> 32);

1556 
	`ıw32
(
StsAddr
, ((
u64
)
dma
 & 
	`DMA_BIT_MASK
(32)è| 
DumpSts
);

1557 
	`ır32
(
StsAddr
);

1559 
i
 = 0; i < 1000; i++) {

1560 ià((
	`ır32
(
StsAddr
è& 
DumpSts
) == 0)

1562 
	`ud–ay
(10);

1564 
	`ıw32
(
StsAddr
, 0);

1565 
	`ıw32
(
StsAddr
 + 4, 0);

1566 
	`ır32
(
StsAddr
);

1568 
i
 = 0;

1569 
tmp_¡©s
[
i
++] = 
	`Ë64_to_ıu
(
nic_¡©s
->
tx_ok
);

1570 
tmp_¡©s
[
i
++] = 
	`Ë64_to_ıu
(
nic_¡©s
->
rx_ok
);

1571 
tmp_¡©s
[
i
++] = 
	`Ë64_to_ıu
(
nic_¡©s
->
tx_”r
);

1572 
tmp_¡©s
[
i
++] = 
	`Ë32_to_ıu
(
nic_¡©s
->
rx_”r
);

1573 
tmp_¡©s
[
i
++] = 
	`Ë16_to_ıu
(
nic_¡©s
->
rx_fifo
);

1574 
tmp_¡©s
[
i
++] = 
	`Ë16_to_ıu
(
nic_¡©s
->
äame_®ign
);

1575 
tmp_¡©s
[
i
++] = 
	`Ë32_to_ıu
(
nic_¡©s
->
tx_ok_1cŞ
);

1576 
tmp_¡©s
[
i
++] = 
	`Ë32_to_ıu
(
nic_¡©s
->
tx_ok_mcŞ
);

1577 
tmp_¡©s
[
i
++] = 
	`Ë64_to_ıu
(
nic_¡©s
->
rx_ok_phys
);

1578 
tmp_¡©s
[
i
++] = 
	`Ë64_to_ıu
(
nic_¡©s
->
rx_ok_bÿ¡
);

1579 
tmp_¡©s
[
i
++] = 
	`Ë32_to_ıu
(
nic_¡©s
->
rx_ok_mÿ¡
);

1580 
tmp_¡©s
[
i
++] = 
	`Ë16_to_ıu
(
nic_¡©s
->
tx_abÜt
);

1581 
tmp_¡©s
[
i
++] = 
	`Ë16_to_ıu
(
nic_¡©s
->
tx_und”run
);

1582 
tmp_¡©s
[
i
++] = 
ı
->
ı_¡©s
.
rx_äags
;

1583 
	`BUG_ON
(
i
 !ğ
CP_NUM_STATS
);

1585 
	`dma_ä“_coh”’t
(&
ı
->
pdev
->
dev
, (*
nic_¡©s
),‚ic_¡©s, 
dma
);

1586 
	}
}

1588 cÚ¡ 
‘htoŞ_İs
 
	gı_‘htoŞ_İs
 = {

1589 .
g‘_drvšfo
 = 
ı_g‘_drvšfo
,

1590 .
	gg‘_»gs_Ën
 = 
ı_g‘_»gs_Ën
,

1591 .
	gg‘_s£t_couÁ
 = 
ı_g‘_s£t_couÁ
,

1592 .
	gg‘_£‰šgs
 = 
ı_g‘_£‰šgs
,

1593 .
	g£t_£‰šgs
 = 
ı_£t_£‰šgs
,

1594 .
	gnway_»£t
 = 
ı_nway_»£t
,

1595 .
	gg‘_lšk
 = 
‘htoŞ_İ_g‘_lšk
,

1596 .
	gg‘_msgËv–
 = 
ı_g‘_msgËv–
,

1597 .
	g£t_msgËv–
 = 
ı_£t_msgËv–
,

1598 .
	gg‘_»gs
 = 
ı_g‘_»gs
,

1599 .
	gg‘_wŞ
 = 
ı_g‘_wŞ
,

1600 .
	g£t_wŞ
 = 
ı_£t_wŞ
,

1601 .
	gg‘_¡ršgs
 = 
ı_g‘_¡ršgs
,

1602 .
	gg‘_‘htoŞ_¡©s
 = 
ı_g‘_‘htoŞ_¡©s
,

1603 .
	gg‘_“´om_Ën
 = 
ı_g‘_“´om_Ën
,

1604 .
	gg‘_“´om
 = 
ı_g‘_“´om
,

1605 .
	g£t_“´om
 = 
ı_£t_“´om
,

1606 .
	gg‘_ršg·¿m
 = 
ı_g‘_ršg·¿m
,

1609 
	$ı_ioùl
 (
Ãt_deviû
 *
dev
, 
iäeq
 *
rq
, 
cmd
)

1611 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1612 
rc
;

1613 
æags
;

1615 ià(!
	`Ãtif_ruÂšg
(
dev
))

1616  -
EINVAL
;

1618 
	`¥š_lock_œq§ve
(&
ı
->
lock
, 
æags
);

1619 
rc
 = 
	`g’”ic_mii_ioùl
(&
ı
->
mii_if
, 
	`if_mii
(
rq
), 
cmd
, 
NULL
);

1620 
	`¥š_uÆock_œq»¡Üe
(&
ı
->
lock
, 
æags
);

1621  
rc
;

1622 
	}
}

1624 
	$ı_£t_mac_add»ss
(
Ãt_deviû
 *
dev
, *
p
)

1626 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1627 
sockaddr
 *
addr
 = 
p
;

1629 ià(!
	`is_v®id_‘h”_addr
(
addr
->
§_d©a
))

1630  -
EADDRNOTAVAIL
;

1632 
	`memıy
(
dev
->
dev_addr
, 
addr
->
§_d©a
, dev->
addr_Ën
);

1634 
	`¥š_lock_œq
(&
ı
->
lock
);

1636 
	`ıw8_f
(
Cfg9346
, 
Cfg9346_UÆock
);

1637 
	`ıw32_f
(
MAC0
 + 0, 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
dev
->
dev_addr
 + 0)));

1638 
	`ıw32_f
(
MAC0
 + 4, 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
dev
->
dev_addr
 + 4)));

1639 
	`ıw8_f
(
Cfg9346
, 
Cfg9346_Lock
);

1641 
	`¥š_uÆock_œq
(&
ı
->
lock
);

1644 
	}
}

1649 
	#EE_SHIFT_CLK
 0x04

	)

1650 
	#EE_CS
 0x08

	)

1651 
	#EE_DATA_WRITE
 0x02

	)

1652 
	#EE_WRITE_0
 0x00

	)

1653 
	#EE_WRITE_1
 0x02

	)

1654 
	#EE_DATA_READ
 0x01

	)

1655 
	#EE_ENB
 (0x80 | 
EE_CS
)

	)

1661 
	#“´om_d–ay
(è
	`»adb
(
“_addr
)

	)

1664 
	#EE_EXTEND_CMD
 (4)

	)

1665 
	#EE_WRITE_CMD
 (5)

	)

1666 
	#EE_READ_CMD
 (6)

	)

1667 
	#EE_ERASE_CMD
 (7)

	)

1669 
	#EE_EWDS_ADDR
 (0)

	)

1670 
	#EE_WRAL_ADDR
 (1)

	)

1671 
	#EE_ERAL_ADDR
 (2)

	)

1672 
	#EE_EWEN_ADDR
 (3)

	)

1674 
	#CP_EEPROM_MAGIC
 
PCI_DEVICE_ID_REALTEK_8139


	)

1676 
	$“´om_cmd_¡¬t
(
__iomem
 *
“_addr
)

1678 
	`wr™eb
 (
EE_ENB
 & ~
EE_CS
, 
“_addr
);

1679 
	`wr™eb
 (
EE_ENB
, 
“_addr
);

1680 
	`“´om_d–ay
 ();

1681 
	}
}

1683 
	$“´om_cmd
(
__iomem
 *
“_addr
, 
cmd
, 
cmd_Ën
)

1685 
i
;

1688 
i
 = 
cmd_Ën
 - 1; i >= 0; i--) {

1689 
d©av®
 = (
cmd
 & (1 << 
i
)è? 
EE_DATA_WRITE
 : 0;

1690 
	`wr™eb
 (
EE_ENB
 | 
d©av®
, 
“_addr
);

1691 
	`“´om_d–ay
 ();

1692 
	`wr™eb
 (
EE_ENB
 | 
d©av®
 | 
EE_SHIFT_CLK
, 
“_addr
);

1693 
	`“´om_d–ay
 ();

1695 
	`wr™eb
 (
EE_ENB
, 
“_addr
);

1696 
	`“´om_d–ay
 ();

1697 
	}
}

1699 
	$“´om_cmd_’d
(
__iomem
 *
“_addr
)

1701 
	`wr™eb
(0, 
“_addr
);

1702 
	`“´om_d–ay
 ();

1703 
	}
}

1705 
	$“´om_ex‹nd_cmd
(
__iomem
 *
“_addr
, 
ex‹nd_cmd
,

1706 
addr_Ën
)

1708 
cmd
 = (
EE_EXTEND_CMD
 << 
addr_Ën
è| (
ex‹nd_cmd
 << (addr_len - 2));

1710 
	`“´om_cmd_¡¬t
(
“_addr
);

1711 
	`“´om_cmd
(
“_addr
, 
cmd
, 3 + 
addr_Ën
);

1712 
	`“´om_cmd_’d
(
“_addr
);

1713 
	}
}

1715 
u16
 
	$»ad_“´om
 (
__iomem
 *
ißddr
, 
loÿtiÚ
, 
addr_Ën
)

1717 
i
;

1718 
u16
 
»tv®
 = 0;

1719 
__iomem
 *
“_addr
 = 
ißddr
 + 
Cfg9346
;

1720 
»ad_cmd
 = 
loÿtiÚ
 | (
EE_READ_CMD
 << 
addr_Ën
);

1722 
	`“´om_cmd_¡¬t
(
“_addr
);

1723 
	`“´om_cmd
(
“_addr
, 
»ad_cmd
, 3 + 
addr_Ën
);

1725 
i
 = 16; i > 0; i--) {

1726 
	`wr™eb
 (
EE_ENB
 | 
EE_SHIFT_CLK
, 
“_addr
);

1727 
	`“´om_d–ay
 ();

1728 
»tv®
 =

1729 (
»tv®
 << 1è| ((
	`»adb
 (
“_addr
è& 
EE_DATA_READ
) ? 1 :

1731 
	`wr™eb
 (
EE_ENB
, 
“_addr
);

1732 
	`“´om_d–ay
 ();

1735 
	`“´om_cmd_’d
(
“_addr
);

1737  
»tv®
;

1738 
	}
}

1740 
	$wr™e_“´om
(
__iomem
 *
ißddr
, 
loÿtiÚ
, 
u16
 
v®
,

1741 
addr_Ën
)

1743 
i
;

1744 
__iomem
 *
“_addr
 = 
ißddr
 + 
Cfg9346
;

1745 
wr™e_cmd
 = 
loÿtiÚ
 | (
EE_WRITE_CMD
 << 
addr_Ën
);

1747 
	`“´om_ex‹nd_cmd
(
“_addr
, 
EE_EWEN_ADDR
, 
addr_Ën
);

1749 
	`“´om_cmd_¡¬t
(
“_addr
);

1750 
	`“´om_cmd
(
“_addr
, 
wr™e_cmd
, 3 + 
addr_Ën
);

1751 
	`“´om_cmd
(
“_addr
, 
v®
, 16);

1752 
	`“´om_cmd_’d
(
“_addr
);

1754 
	`“´om_cmd_¡¬t
(
“_addr
);

1755 
i
 = 0; i < 20000; i++)

1756 ià(
	`»adb
(
“_addr
è& 
EE_DATA_READ
)

1758 
	`“´om_cmd_’d
(
“_addr
);

1760 
	`“´om_ex‹nd_cmd
(
“_addr
, 
EE_EWDS_ADDR
, 
addr_Ën
);

1761 
	}
}

1763 
	$ı_g‘_“´om_Ën
(
Ãt_deviû
 *
dev
)

1765 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1766 
size
;

1768 
	`¥š_lock_œq
(&
ı
->
lock
);

1769 
size
 = 
	`»ad_“´om
(
ı
->
»gs
, 0, 8) == 0x8129 ? 256 : 128;

1770 
	`¥š_uÆock_œq
(&
ı
->
lock
);

1772  
size
;

1773 
	}
}

1775 
	$ı_g‘_“´om
(
Ãt_deviû
 *
dev
,

1776 
‘htoŞ_“´om
 *
“´om
, 
u8
 *
d©a
)

1778 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1779 
addr_Ën
;

1780 
u16
 
v®
;

1781 
u32
 
off£t
 = 
“´om
->offset >> 1;

1782 
u32
 
Ën
 = 
“´om
->len;

1783 
u32
 
i
 = 0;

1785 
“´om
->
magic
 = 
CP_EEPROM_MAGIC
;

1787 
	`¥š_lock_œq
(&
ı
->
lock
);

1789 
addr_Ën
 = 
	`»ad_“´om
(
ı
->
»gs
, 0, 8) == 0x8129 ? 8 : 6;

1791 ià(
“´om
->
off£t
 & 1) {

1792 
v®
 = 
	`»ad_“´om
(
ı
->
»gs
, 
off£t
, 
addr_Ën
);

1793 
d©a
[
i
++] = (
u8
)(
v®
 >> 8);

1794 
off£t
++;

1797 
i
 < 
Ën
 - 1) {

1798 
v®
 = 
	`»ad_“´om
(
ı
->
»gs
, 
off£t
, 
addr_Ën
);

1799 
d©a
[
i
++] = (
u8
)
v®
;

1800 
d©a
[
i
++] = (
u8
)(
v®
 >> 8);

1801 
off£t
++;

1804 ià(
i
 < 
Ën
) {

1805 
v®
 = 
	`»ad_“´om
(
ı
->
»gs
, 
off£t
, 
addr_Ën
);

1806 
d©a
[
i
] = (
u8
)
v®
;

1809 
	`¥š_uÆock_œq
(&
ı
->
lock
);

1811 
	}
}

1813 
	$ı_£t_“´om
(
Ãt_deviû
 *
dev
,

1814 
‘htoŞ_“´om
 *
“´om
, 
u8
 *
d©a
)

1816 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

1817 
addr_Ën
;

1818 
u16
 
v®
;

1819 
u32
 
off£t
 = 
“´om
->offset >> 1;

1820 
u32
 
Ën
 = 
“´om
->len;

1821 
u32
 
i
 = 0;

1823 ià(
“´om
->
magic
 !ğ
CP_EEPROM_MAGIC
)

1824  -
EINVAL
;

1826 
	`¥š_lock_œq
(&
ı
->
lock
);

1828 
addr_Ën
 = 
	`»ad_“´om
(
ı
->
»gs
, 0, 8) == 0x8129 ? 8 : 6;

1830 ià(
“´om
->
off£t
 & 1) {

1831 
v®
 = 
	`»ad_“´om
(
ı
->
»gs
, 
off£t
, 
addr_Ën
) & 0xff;

1832 
v®
 |ğ(
u16
)
d©a
[
i
++] << 8;

1833 
	`wr™e_“´om
(
ı
->
»gs
, 
off£t
, 
v®
, 
addr_Ën
);

1834 
off£t
++;

1837 
i
 < 
Ën
 - 1) {

1838 
v®
 = (
u16
)
d©a
[
i
++];

1839 
v®
 |ğ(
u16
)
d©a
[
i
++] << 8;

1840 
	`wr™e_“´om
(
ı
->
»gs
, 
off£t
, 
v®
, 
addr_Ën
);

1841 
off£t
++;

1844 ià(
i
 < 
Ën
) {

1845 
v®
 = 
	`»ad_“´om
(
ı
->
»gs
, 
off£t
, 
addr_Ën
) & 0xff00;

1846 
v®
 |ğ(
u16
)
d©a
[
i
];

1847 
	`wr™e_“´om
(
ı
->
»gs
, 
off£t
, 
v®
, 
addr_Ën
);

1850 
	`¥š_uÆock_œq
(&
ı
->
lock
);

1852 
	}
}

1855 
	$ı_£t_d3_¡©e
 (
ı_´iv©e
 *
ı
)

1857 
	`pci_’abË_wake
(
ı
->
pdev
, 
PCI_D0
, 1);

1858 
	`pci_£t_pow”_¡©e
 (
ı
->
pdev
, 
PCI_D3hÙ
);

1859 
	}
}

1861 
Ãtdev_ã©u»s_t
 
	$ı_ã©u»s_check
(
sk_buff
 *
skb
,

1862 
Ãt_deviû
 *
dev
,

1863 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1865 ià(
	`skb_shšfo
(
skb
)->
gso_size
 > 
MSSMask
)

1866 
ã©u»s
 &ğ~
NETIF_F_TSO
;

1868  
	`vÏn_ã©u»s_check
(
skb
, 
ã©u»s
);

1869 
	}
}

1870 cÚ¡ 
Ãt_deviû_İs
 
	gı_Ãtdev_İs
 = {

1871 .
ndo_İ’
 = 
ı_İ’
,

1872 .
	gndo_¡İ
 = 
ı_şo£
,

1873 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

1874 .
	gndo_£t_mac_add»ss
 = 
ı_£t_mac_add»ss
,

1875 .
	gndo_£t_rx_mode
 = 
ı_£t_rx_mode
,

1876 .
	gndo_g‘_¡©s
 = 
ı_g‘_¡©s
,

1877 .
	gndo_do_ioùl
 = 
ı_ioùl
,

1878 .
	gndo_¡¬t_xm™
 = 
ı_¡¬t_xm™
,

1879 .
	gndo_tx_timeout
 = 
ı_tx_timeout
,

1880 .
	gndo_£t_ã©u»s
 = 
ı_£t_ã©u»s
,

1881 .
	gndo_chªge_mtu
 = 
ı_chªge_mtu
,

1882 .
	gndo_ã©u»s_check
 = 
ı_ã©u»s_check
,

1884 #ifdeà
CONFIG_NET_POLL_CONTROLLER


1885 .
	gndo_pŞl_cÚŒŞËr
 = 
ı_pŞl_cÚŒŞËr
,

1889 
	$ı_š™_Úe
 (
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
’t
)

1891 
Ãt_deviû
 *
dev
;

1892 
ı_´iv©e
 *
ı
;

1893 
rc
;

1894 
__iomem
 *
»gs
;

1895 
»sourû_size_t
 
pcŸddr
;

1896 
addr_Ën
, 
i
, 
pci_usšg_dac
;

1898 
	`´_šfo_Úû
("%s", 
v”siÚ
);

1900 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_REALTEK
 &&

1901 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_REALTEK_8139
 &&…dev->
»visiÚ
 < 0x20) {

1902 
	`dev_šfo
(&
pdev
->
dev
,

1904 
pdev
->
v’dÜ
,…dev->
deviû
,…dev->
»visiÚ
);

1905  -
ENODEV
;

1908 
dev
 = 
	`®loc_‘h”dev
((
ı_´iv©e
));

1909 ià(!
dev
)

1910  -
ENOMEM
;

1911 
	`SET_NETDEV_DEV
(
dev
, &
pdev
->dev);

1913 
ı
 = 
	`Ãtdev_´iv
(
dev
);

1914 
ı
->
pdev
 =…dev;

1915 
ı
->
dev
 = dev;

1916 
ı
->
msg_’abË
 = (
debug
 < 0 ? 
CP_DEF_MSG_ENABLE
 : debug);

1917 
	`¥š_lock_š™
 (&
ı
->
lock
);

1918 
ı
->
mii_if
.
dev
 = dev;

1919 
ı
->
mii_if
.
mdio_»ad
 = mdio_read;

1920 
ı
->
mii_if
.
mdio_wr™e
 = mdio_write;

1921 
ı
->
mii_if
.
phy_id
 = 
CP_INTERNAL_PHY
;

1922 
ı
->
mii_if
.
phy_id_mask
 = 0x1f;

1923 
ı
->
mii_if
.
»g_num_mask
 = 0x1f;

1924 
	`ı_£t_rxbufsize
(
ı
);

1926 
rc
 = 
	`pci_’abË_deviû
(
pdev
);

1927 ià(
rc
)

1928 
”r_out_ä“
;

1930 
rc
 = 
	`pci_£t_mwi
(
pdev
);

1931 ià(
rc
)

1932 
”r_out_di§bË
;

1934 
rc
 = 
	`pci_»que¡_»giÚs
(
pdev
, 
DRV_NAME
);

1935 ià(
rc
)

1936 
”r_out_mwi
;

1938 
pcŸddr
 = 
	`pci_»sourû_¡¬t
(
pdev
, 1);

1939 ià(!
pcŸddr
) {

1940 
rc
 = -
EIO
;

1941 
	`dev_”r
(&
pdev
->
dev
, "no MMIO„esource\n");

1942 
”r_out_»s
;

1944 ià(
	`pci_»sourû_Ën
(
pdev
, 1è< 
CP_REGS_SIZE
) {

1945 
rc
 = -
EIO
;

1946 
	`dev_”r
(&
pdev
->
dev
, "MMIO„esource (%llx)oo small\n",

1947 ()
	`pci_»sourû_Ën
(
pdev
, 1));

1948 
”r_out_»s
;

1952 ià(((
dma_addr_t
) > 4) &&

1953 !
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64)) &&

1954 !
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64))) {

1955 
pci_usšg_dac
 = 1;

1957 
pci_usšg_dac
 = 0;

1959 
rc
 = 
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

1960 ià(
rc
) {

1961 
	`dev_”r
(&
pdev
->
dev
,

1963 
”r_out_»s
;

1965 
rc
 = 
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

1966 ià(
rc
) {

1967 
	`dev_”r
(&
pdev
->
dev
,

1969 
”r_out_»s
;

1973 
ı
->
ıcmd
 = (
pci_usšg_dac
 ? 
PCIDAC
 : 0) |

1974 
PCIMulRW
 | 
RxChkSum
 | 
CpRxOn
 | 
CpTxOn
;

1976 
dev
->
ã©u»s
 |ğ
NETIF_F_RXCSUM
;

1977 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXCSUM
;

1979 
»gs
 = 
	`iÜem­
(
pcŸddr
, 
CP_REGS_SIZE
);

1980 ià(!
»gs
) {

1981 
rc
 = -
EIO
;

1982 
	`dev_”r
(&
pdev
->
dev
, "Cannot map PCI MMIO (%Lx@%Lx)\n",

1983 ()
	`pci_»sourû_Ën
(
pdev
, 1),

1984 ()
pcŸddr
);

1985 
”r_out_»s
;

1987 
ı
->
»gs
 =„egs;

1989 
	`ı_¡İ_hw
(
ı
);

1992 
addr_Ën
 = 
	`»ad_“´om
 (
»gs
, 0, 8) == 0x8129 ? 8 : 6;

1993 
i
 = 0; i < 3; i++)

1994 ((
__Ë16
 *è(
dev
->
dev_addr
))[
i
] =

1995 
	`ıu_to_Ë16
(
	`»ad_“´om
 (
»gs
, 
i
 + 7, 
addr_Ën
));

1997 
dev
->
Ãtdev_İs
 = &
ı_Ãtdev_İs
;

1998 
	`Ãtif_Çpi_add
(
dev
, &
ı
->
Çpi
, 
ı_rx_pŞl
, 16);

1999 
dev
->
‘htoŞ_İs
 = &
ı_‘htoŞ_İs
;

2000 
dev
->
w©chdog_timeo
 = 
TX_TIMEOUT
;

2002 
dev
->
ã©u»s
 |ğ
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

2003 
NETIF_F_HW_VLAN_CTAG_TX
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

2005 ià(
pci_usšg_dac
)

2006 
dev
->
ã©u»s
 |ğ
NETIF_F_HIGHDMA
;

2008 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

2009 
NETIF_F_HW_VLAN_CTAG_TX
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

2010 
dev
->
vÏn_ã©u»s
 = 
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

2011 
NETIF_F_HIGHDMA
;

2013 
rc
 = 
	`»gi¡”_Ãtdev
(
dev
);

2014 ià(
rc
)

2015 
”r_out_iom­
;

2017 
	`Ãtdev_šfo
(
dev
, "RTL-8139C+‡t 0x%p, %pM, IRQ %d\n",

2018 
»gs
, 
dev
->
dev_addr
, 
pdev
->
œq
);

2020 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

2023 
	`pci_£t_ma¡”
(
pdev
);

2025 ià(
ı
->
wŞ_’abËd
)

2026 
	`ı_£t_d3_¡©e
 (
ı
);

2030 
”r_out_iom­
:

2031 
	`iounm­
(
»gs
);

2032 
”r_out_»s
:

2033 
	`pci_»Ëa£_»giÚs
(
pdev
);

2034 
”r_out_mwi
:

2035 
	`pci_ş—r_mwi
(
pdev
);

2036 
”r_out_di§bË
:

2037 
	`pci_di§bË_deviû
(
pdev
);

2038 
”r_out_ä“
:

2039 
	`ä“_Ãtdev
(
dev
);

2040  
rc
;

2041 
	}
}

2043 
	$ı_»move_Úe
 (
pci_dev
 *
pdev
)

2045 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2046 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

2048 
	`uÄegi¡”_Ãtdev
(
dev
);

2049 
	`iounm­
(
ı
->
»gs
);

2050 ià(
ı
->
wŞ_’abËd
)

2051 
	`pci_£t_pow”_¡©e
 (
pdev
, 
PCI_D0
);

2052 
	`pci_»Ëa£_»giÚs
(
pdev
);

2053 
	`pci_ş—r_mwi
(
pdev
);

2054 
	`pci_di§bË_deviû
(
pdev
);

2055 
	`ä“_Ãtdev
(
dev
);

2056 
	}
}

2058 #ifdeà
CONFIG_PM


2059 
	$ı_su¥’d
 (
pci_dev
 *
pdev
, 
pm_mes§ge_t
 
¡©e
)

2061 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

2062 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

2063 
æags
;

2065 ià(!
	`Ãtif_ruÂšg
(
dev
))

2068 
	`Ãtif_deviû_d‘ach
 (
dev
);

2069 
	`Ãtif_¡İ_queue
 (
dev
);

2071 
	`¥š_lock_œq§ve
 (&
ı
->
lock
, 
æags
);

2074 
	`ıw16
 (
IÁrMask
, 0);

2075 
	`ıw8
 (
Cmd
, 
	`ır8
 (Cmdè& (~
RxOn
 | ~
TxOn
));

2077 
	`¥š_uÆock_œq»¡Üe
 (&
ı
->
lock
, 
æags
);

2079 
	`pci_§ve_¡©e
(
pdev
);

2080 
	`pci_’abË_wake
(
pdev
, 
	`pci_choo£_¡©e
Õdev, 
¡©e
), 
ı
->
wŞ_’abËd
);

2081 
	`pci_£t_pow”_¡©e
(
pdev
, 
	`pci_choo£_¡©e
Õdev, 
¡©e
));

2084 
	}
}

2086 
	$ı_»sume
 (
pci_dev
 *
pdev
)

2088 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
 (
pdev
);

2089 
ı_´iv©e
 *
ı
 = 
	`Ãtdev_´iv
(
dev
);

2090 
æags
;

2092 ià(!
	`Ãtif_ruÂšg
(
dev
))

2095 
	`Ãtif_deviû_©ch
 (
dev
);

2097 
	`pci_£t_pow”_¡©e
(
pdev
, 
PCI_D0
);

2098 
	`pci_»¡Üe_¡©e
(
pdev
);

2099 
	`pci_’abË_wake
(
pdev
, 
PCI_D0
, 0);

2102 
	`ı_š™_ršgs_šdex
 (
ı
);

2103 
	`ı_š™_hw
 (
ı
);

2104 
	`ı_’abË_œq
(
ı
);

2105 
	`Ãtif_¡¬t_queue
 (
dev
);

2107 
	`¥š_lock_œq§ve
 (&
ı
->
lock
, 
æags
);

2109 
	`mii_check_medŸ
(&
ı
->
mii_if
, 
	`Ãtif_msg_lšk
(ı), 
çl£
);

2111 
	`¥š_uÆock_œq»¡Üe
 (&
ı
->
lock
, 
æags
);

2114 
	}
}

2117 cÚ¡ 
pci_deviû_id
 
	gı_pci_tbl
[] = {

2118 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 
PCI_DEVICE_ID_REALTEK_8139
), },

2119 { 
PCI_DEVICE
(
PCI_VENDOR_ID_TTTECH
, 
PCI_DEVICE_ID_TTTECH_MC322
), },

2122 
MODULE_DEVICE_TABLE
(
pci
, 
ı_pci_tbl
);

2124 
pci_driv”
 
	gı_driv”
 = {

2125 .
Çme
 = 
DRV_NAME
,

2126 .
	gid_bË
 = 
ı_pci_tbl
,

2127 .
	g´obe
 = 
ı_š™_Úe
,

2128 .
	g»move
 = 
ı_»move_Úe
,

2129 #ifdeà
CONFIG_PM


2130 .
	g»sume
 = 
ı_»sume
,

2131 .
	gsu¥’d
 = 
ı_su¥’d
,

2135 
moduË_pci_driv”
(
ı_driv”
);

	@8139too.c

92 
	#´_fmt
(
fmt
è
KBUILD_MODNAME
 ": " 
	)
fmt

94 
	#DRV_NAME
 "8139too"

	)

95 
	#DRV_VERSION
 "0.9.28"

	)

98 
	~<lšux/moduË.h
>

99 
	~<lšux/k”Ãl.h
>

100 
	~<lšux/comp”.h
>

101 
	~<lšux/pci.h
>

102 
	~<lšux/š™.h
>

103 
	~<lšux/š‹¼u±.h
>

104 
	~<lšux/Ãtdeviû.h
>

105 
	~<lšux/‘h”deviû.h
>

106 
	~<lšux/¹Ãšk.h
>

107 
	~<lšux/d–ay.h
>

108 
	~<lšux/‘htoŞ.h
>

109 
	~<lšux/mii.h
>

110 
	~<lšux/com¶‘iÚ.h
>

111 
	~<lšux/üc32.h
>

112 
	~<lšux/io.h
>

113 
	~<lšux/uacûss.h
>

114 
	~<lšux/gå.h
>

115 
	~<lšux/if_vÏn.h
>

116 
	~<asm/œq.h
>

118 
	#RTL8139_DRIVER_NAME
 
DRV_NAME
 " Fa¡ Eth”Ãˆdriv” " 
DRV_VERSION


	)

121 
	#RTL8139_DEF_MSG_ENABLE
 (
NETIF_MSG_DRV
 | \

122 
NETIF_MSG_PROBE
 | \

123 
NETIF_MSG_LINK
)

	)

127 
	#RTL8139_DEBUG
 0

	)

130 #undeà
RTL8139_NDEBUG


133 #ifdeà
RTL8139_NDEBUG


134 
	#as£¹
(
ex´
èdØ{} 0)

	)

136 
	#as£¹
(
ex´
) \

137 ià(
	`uÆik–y
(!(
ex´
))) { \

138 
	`´_”r
("Assertion failed! %s,%s,%s,line=%d\n", \

139 #ex´, 
__FILE__
, 
__func__
, 
__LINE__
); \

140 }

	)

146 
	#MAX_UNITS
 8

	)

147 
	gmedŸ
[
MAX_UNITS
] = {-1, -1, -1, -1, -1, -1, -1, -1};

148 
	gfuÎ_du¶ex
[
MAX_UNITS
] = {-1, -1, -1, -1, -1, -1, -1, -1};

151 #ifdeà
CONFIG_8139TOO_PIO


152 
boŞ
 
	gu£_io
 = 
Œue
;

154 
boŞ
 
	gu£_io
 = 
çl£
;

159 
	gmuÉiÿ¡_f‹r_lim™
 = 32;

162 
	gdebug
 = -1;

168 #ià
defšed
(
CONFIG_SH_DREAMCAST
)

169 
	#RX_BUF_IDX
 0

	)

171 
	#RX_BUF_IDX
 2

	)

173 
	#RX_BUF_LEN
 (8192 << 
RX_BUF_IDX
)

	)

174 
	#RX_BUF_PAD
 16

	)

175 
	#RX_BUF_WRAP_PAD
 2048

	)

177 #ià
RX_BUF_LEN
 == 65536

178 
	#RX_BUF_TOT_LEN
 
RX_BUF_LEN


	)

180 
	#RX_BUF_TOT_LEN
 (
RX_BUF_LEN
 + 
RX_BUF_PAD
 + 
RX_BUF_WRAP_PAD
)

	)

184 
	#NUM_TX_DESC
 4

	)

187 
	#MAX_ETH_FRAME_SIZE
 1792

	)

190 
	#MAX_ETH_DATA_SIZE
 (
MAX_ETH_FRAME_SIZE
 - 
VLAN_ETH_HLEN
 - 
ETH_FCS_LEN
)

	)

193 
	#TX_BUF_SIZE
 
MAX_ETH_FRAME_SIZE


	)

194 
	#TX_BUF_TOT_LEN
 (
TX_BUF_SIZE
 * 
NUM_TX_DESC
)

	)

198 
	#TX_FIFO_THRESH
 256

	)

201 
	#RX_FIFO_THRESH
 7

	)

202 
	#RX_DMA_BURST
 7

	)

203 
	#TX_DMA_BURST
 6

	)

204 
	#TX_RETRY
 8

	)

208 
	#TX_TIMEOUT
 (6*
HZ
)

	)

212 
	mHAS_MII_XCVR
 = 0x010000,

213 
	mHAS_CHIP_XCVR
 = 0x020000,

214 
	mHAS_LNK_CHNG
 = 0x040000,

217 
	#RTL_NUM_STATS
 4

	)

218 
	#RTL_REGS_VER
 1

	)

219 
	#RTL_MIN_IO_SIZE
 0x80

	)

220 
	#RTL8139B_IO_SIZE
 256

	)

222 
	#RTL8129_CAPS
 
HAS_MII_XCVR


	)

223 
	#RTL8139_CAPS
 (
HAS_CHIP_XCVR
|
HAS_LNK_CHNG
)

	)

226 
	mRTL8139
 = 0,

227 
	mRTL8129
,

228 } 
	tbßrd_t
;

233 cÚ¡ *
	mÇme
;

234 
u32
 
	mhw_æags
;

235 } 
	gbßrd_šfo
[] = {

236 { "R—lTek RTL8139", 
RTL8139_CAPS
 },

237 { "R—lTek RTL8129", 
RTL8129_CAPS
 },

241 cÚ¡ 
pci_deviû_id
 
	g¹l8139_pci_tbl
[] = {

242 {0x10ec, 0x8139, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

243 {0x10ec, 0x8138, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

244 {0x1113, 0x1211, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

245 {0x1500, 0x1360, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

246 {0x4033, 0x1360, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

247 {0x1186, 0x1300, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

248 {0x1186, 0x1340, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

249 {0x13d1, 0xab06, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

250 {0x1259, 0xa117, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

251 {0x1259, 0xa11e, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

252 {0x14—, 0xab06, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

253 {0x14—, 0xab07, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

254 {0x11db, 0x1234, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

255 {0x1432, 0x9130, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

256 {0x02ac, 0x1012, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

257 {0x018a, 0x0106, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

258 {0x126c, 0x1211, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

259 {0x1743, 0x8139, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

260 {0x021b, 0x8139, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

262 #ifdeà
CONFIG_SH_SECUREEDGE5410


264 {0x10ec, 0x8129, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8139
 },

266 #ifdeà
CONFIG_8139TOO_8129


267 {0x10ec, 0x8129, 
PCI_ANY_ID
, PCI_ANY_ID, 0, 0, 
RTL8129
 },

274 {
PCI_ANY_ID
, 0x8139, 0x10ec, 0x8139, 0, 0, 
RTL8139
 },

275 {
PCI_ANY_ID
, 0x8139, 0x1186, 0x1300, 0, 0, 
RTL8139
 },

276 {
PCI_ANY_ID
, 0x8139, 0x13d1, 0xab06, 0, 0, 
RTL8139
 },

280 
MODULE_DEVICE_TABLE
 (
pci
, 
¹l8139_pci_tbl
);

283 cÚ¡ 
	m¡r
[
ETH_GSTRING_LEN
];

284 } 
	g‘htoŞ_¡©s_keys
[] = {

294 
	eRTL8139_»gi¡”s
 {

295 
	mMAC0
 = 0,

296 
	mMAR0
 = 8,

297 
	mTxStus0
 = 0x10,

298 
	mTxAddr0
 = 0x20,

299 
	mRxBuf
 = 0x30,

300 
	mChCmd
 = 0x37,

301 
	mRxBufPŒ
 = 0x38,

302 
	mRxBufAddr
 = 0x3A,

303 
	mIÁrMask
 = 0x3C,

304 
	mIÁrStus
 = 0x3E,

305 
	mTxCÚfig
 = 0x40,

306 
	mRxCÚfig
 = 0x44,

307 
	mTim”
 = 0x48,

308 
	mRxMis£d
 = 0x4C,

309 
	mCfg9346
 = 0x50,

310 
	mCÚfig0
 = 0x51,

311 
	mCÚfig1
 = 0x52,

312 
	mTim”IÁ
 = 0x54,

313 
	mMedŸStus
 = 0x58,

314 
	mCÚfig3
 = 0x59,

315 
	mCÚfig4
 = 0x5A,

316 
	mHÉClk
 = 0x5B,

317 
	mMuÉiIÁr
 = 0x5C,

318 
	mTxSumm¬y
 = 0x60,

319 
	mBasicModeCŒl
 = 0x62,

320 
	mBasicModeStus
 = 0x64,

321 
	mNWayAdv”t
 = 0x66,

322 
	mNWayLPAR
 = 0x68,

323 
	mNWayEx·nsiÚ
 = 0x6A,

325 
	mFIFOTMS
 = 0x70,

326 
	mCSCR
 = 0x74,

327 
	mPARA78
 = 0x78,

328 
	mFÏshReg
 = 0xD4,

329 
	mPARA7c
 = 0x7c,

330 
	mCÚfig5
 = 0xD8,

333 
	eCË¬B™Masks
 {

334 
	mMuÉiIÁrCË¬
 = 0xF000,

335 
	mChCmdCË¬
 = 0xE2,

336 
	mCÚfig1CË¬
 = (1<<7)|(1<<6)|(1<<3)|(1<<2)|(1<<1),

339 
	eChCmdB™s
 {

340 
	mCmdRe£t
 = 0x10,

341 
	mCmdRxEnb
 = 0x08,

342 
	mCmdTxEnb
 = 0x04,

343 
	mRxBufEm±y
 = 0x01,

347 
	eIÁrStusB™s
 {

348 
	mPCIE¼
 = 0x8000,

349 
	mPCSTimeout
 = 0x4000,

350 
	mRxFIFOOv”
 = 0x40,

351 
	mRxUnd”run
 = 0x20,

352 
	mRxOv”æow
 = 0x10,

353 
	mTxE¼
 = 0x08,

354 
	mTxOK
 = 0x04,

355 
	mRxE¼
 = 0x02,

356 
	mRxOK
 = 0x01,

358 
	mRxAckB™s
 = 
RxFIFOOv”
 | 
RxOv”æow
 | 
RxOK
,

361 
	eTxStusB™s
 {

362 
	mTxHo¡Owns
 = 0x2000,

363 
	mTxUnd”run
 = 0x4000,

364 
	mTxStOK
 = 0x8000,

365 
	mTxOutOfWšdow
 = 0x20000000,

366 
	mTxAbÜ‹d
 = 0x40000000,

367 
	mTxC¬r›rLo¡
 = 0x80000000,

369 
	eRxStusB™s
 {

370 
	mRxMuÉiÿ¡
 = 0x8000,

371 
	mRxPhysiÿl
 = 0x4000,

372 
	mRxBrßdÿ¡
 = 0x2000,

373 
	mRxBadSymbŞ
 = 0x0020,

374 
	mRxRuÁ
 = 0x0010,

375 
	mRxTooLÚg
 = 0x0008,

376 
	mRxCRCE¼
 = 0x0004,

377 
	mRxBadAlign
 = 0x0002,

378 
	mRxStusOK
 = 0x0001,

382 
	erx_mode_b™s
 {

383 
	mAcû±E¼
 = 0x20,

384 
	mAcû±RuÁ
 = 0x10,

385 
	mAcû±Brßdÿ¡
 = 0x08,

386 
	mAcû±MuÉiÿ¡
 = 0x04,

387 
	mAcû±MyPhys
 = 0x02,

388 
	mAcû±AÎPhys
 = 0x01,

392 
	etx_cÚfig_b™s
 {

394 
	mTxIFGShiá
 = 24,

395 
	mTxIFG84
 = (0 << 
TxIFGShiá
),

396 
	mTxIFG88
 = (1 << 
TxIFGShiá
),

397 
	mTxIFG92
 = (2 << 
TxIFGShiá
),

398 
	mTxIFG96
 = (3 << 
TxIFGShiá
),

400 
	mTxLoİBack
 = (1 << 18) | (1 << 17),

401 
	mTxCRC
 = (1 << 16),

402 
	mTxCË¬Abt
 = (1 << 0),

403 
	mTxDMAShiá
 = 8,

404 
	mTxR‘ryShiá
 = 4,

406 
	mTxV”siÚMask
 = 0x7C800000,

410 
	eCÚfig1B™s
 {

411 
	mCfg1_PM_EÇbË
 = 0x01,

412 
	mCfg1_VPD_EÇbË
 = 0x02,

413 
	mCfg1_PIO
 = 0x04,

414 
	mCfg1_MMIO
 = 0x08,

415 
	mLWAKE
 = 0x10,

416 
	mCfg1_Driv”_Lßd
 = 0x20,

417 
	mCfg1_LED0
 = 0x40,

418 
	mCfg1_LED1
 = 0x80,

419 
	mSLEEP
 = (1 << 1),

420 
	mPWRDN
 = (1 << 0),

424 
	eCÚfig3B™s
 {

425 
	mCfg3_FBtBEn
 = (1 << 0),

426 
	mCfg3_FuncRegEn
 = (1 << 1),

427 
	mCfg3_CLKRUN_En
 = (1 << 2),

428 
	mCfg3_C¬dB_En
 = (1 << 3),

429 
	mCfg3_LškUp
 = (1 << 4),

430 
	mCfg3_Magic
 = (1 << 5),

431 
	mCfg3_PARM_En
 = (1 << 6),

432 
	mCfg3_GNTS–
 = (1 << 7),

436 
	eCÚfig4B™s
 {

437 
	mLWPTN
 = (1 << 2),

441 
	eCÚfig5B™s
 {

442 
	mCfg5_PME_STS
 = (1 << 0),

443 
	mCfg5_LANWake
 = (1 << 1),

444 
	mCfg5_LDPS
 = (1 << 2),

445 
	mCfg5_FIFOAddrPŒ
= (1 << 3),

446 
	mCfg5_UWF
 = (1 << 4),

447 
	mCfg5_MWF
 = (1 << 5),

448 
	mCfg5_BWF
 = (1 << 6),

451 
	eRxCÚfigB™s
 {

453 
	mRxCfgFIFOShiá
 = 13,

454 
	mRxCfgFIFONÚe
 = (7 << 
RxCfgFIFOShiá
),

457 
	mRxCfgDMAShiá
 = 8,

458 
	mRxCfgDMAUÆim™ed
 = (7 << 
RxCfgDMAShiá
),

461 
	mRxCfgRcv8K
 = 0,

462 
	mRxCfgRcv16K
 = (1 << 11),

463 
	mRxCfgRcv32K
 = (1 << 12),

464 
	mRxCfgRcv64K
 = (1 << 11) | (1 << 12),

467 
	mRxNoW¿p
 = (1 << 7),

472 
	eCSCRB™s
 {

473 
	mCSCR_LškOKB™
 = 0x0400,

474 
	mCSCR_LškChªgeB™
 = 0x0800,

475 
	mCSCR_LškStusB™s
 = 0x0f000,

476 
	mCSCR_LškDownOffCmd
 = 0x003c0,

477 
	mCSCR_LškDownCmd
 = 0x0f3c0,

480 
	eCfg9346B™s
 {

481 
	mCfg9346_Lock
 = 0x00,

482 
	mCfg9346_UÆock
 = 0xC0,

486 
	mCH_8139
 = 0,

487 
	mCH_8139_K
,

488 
	mCH_8139A
,

489 
	mCH_8139A_G
,

490 
	mCH_8139B
,

491 
	mCH_8130
,

492 
	mCH_8139C
,

493 
	mCH_8100
,

494 
	mCH_8100B_8139D
,

495 
	mCH_8101
,

496 } 
	tch_t
;

498 
	ech_æags
 {

499 
	mHasHÉClk
 = (1 << 0),

500 
	mHasLWake
 = (1 << 1),

503 
	#HW_REVID
(
b30
, 
b29
, 
b28
, 
b27
, 
b26
, 
b23
, 
b22
) \

504 (
b30
<<30 | 
b29
<<29 | 
b28
<<28 | 
b27
<<27 | 
b26
<<26 | 
b23
<<23 | 
b22
<<22)

	)

505 
	#HW_REVID_MASK
 
	`HW_REVID
(1, 1, 1, 1, 1, 1, 1)

	)

509 cÚ¡ *
	mÇme
;

510 
u32
 
	mv”siÚ
;

511 
u32
 
	mæags
;

512 } 
	g¹l_ch_šfo
[] = {

514 
HW_REVID
(1, 0, 0, 0, 0, 0, 0),

515 
HasHÉClk
,

519 
HW_REVID
(1, 1, 0, 0, 0, 0, 0),

520 
HasHÉClk
,

524 
HW_REVID
(1, 1, 1, 0, 0, 0, 0),

525 
HasHÉClk
,

529 
HW_REVID
(1, 1, 1, 0, 0, 1, 0),

530 
HasHÉClk
,

534 
HW_REVID
(1, 1, 1, 1, 0, 0, 0),

535 
HasLWake
,

539 
HW_REVID
(1, 1, 1, 1, 1, 0, 0),

540 
HasLWake
,

544 
HW_REVID
(1, 1, 1, 0, 1, 0, 0),

545 
HasLWake
,

549 
HW_REVID
(1, 1, 1, 1, 0, 1, 0),

550 
HasLWake
,

554 
HW_REVID
(1, 1, 1, 0, 1, 0, 1),

555 
HasHÉClk


556 | 
HasLWake
,

560 
HW_REVID
(1, 1, 1, 0, 1, 1, 1),

561 
HasLWake
,

565 
	s¹l_exŒa_¡©s
 {

566 
	m—¾y_rx
;

567 
	mtx_buf_m­³d
;

568 
	mtx_timeouts
;

569 
	mrx_lo¡_š_ršg
;

572 
	s¹l8139_¡©s
 {

573 
u64
 
	m·ck‘s
;

574 
u64
 
	mby‹s
;

575 
u64_¡©s_sync
 
	msynı
;

578 
	s¹l8139_´iv©e
 {

579 
__iomem
 *
	mmmio_addr
;

580 
	mdrv_æags
;

581 
pci_dev
 *
	mpci_dev
;

582 
u32
 
	mmsg_’abË
;

583 
Çpi_¡ruù
 
	mÇpi
;

584 
Ãt_deviû
 *
	mdev
;

586 *
	mrx_ršg
;

587 
	mcur_rx
;

588 
¹l8139_¡©s
 
	mrx_¡©s
;

589 
dma_addr_t
 
	mrx_ršg_dma
;

591 
	mtx_æag
;

592 
	mcur_tx
;

593 
	mdœty_tx
;

594 
¹l8139_¡©s
 
	mtx_¡©s
;

595 *
	mtx_buf
[
NUM_TX_DESC
];

596 *
	mtx_bufs
;

597 
dma_addr_t
 
	mtx_bufs_dma
;

599 sigÃd 
	mphys
[4];

602 
	mtwi¡›
, 
	mtwi¡_row
, 
	mtwi¡_cŞ
;

604 
	mw©chdog_fœed
 : 1;

605 
	mdeçuÉ_pÜt
 : 4;

606 
	mhave_th»ad
 : 1;

608 
¥šlock_t
 
	mlock
;

609 
¥šlock_t
 
	mrx_lock
;

611 
ch_t
 
	mch£t
;

612 
u32
 
	mrx_cÚfig
;

613 
¹l_exŒa_¡©s
 
	mx¡©s
;

615 
d–ayed_wÜk
 
	mth»ad
;

617 
mii_if_šfo
 
	mmii
;

618 
	m»gs_Ën
;

619 
	mfifo_cİy_timeout
;

622 
MODULE_AUTHOR
 ("Jeff Garzik <jgarzik@pobox.com>");

623 
MODULE_DESCRIPTION
 ("RealTek RTL-8139 Fast Ethernet driver");

624 
MODULE_LICENSE
("GPL");

625 
MODULE_VERSION
(
DRV_VERSION
);

627 
moduË_·¿m
(
u£_io
, 
boŞ
, 0);

628 
MODULE_PARM_DESC
(
u£_io
, "Force use of I/O‡ccess mode. 0=MMIO 1=PIO");

629 
moduË_·¿m
(
muÉiÿ¡_f‹r_lim™
, , 0);

630 
moduË_·¿m_¬¿y
(
medŸ
, , 
NULL
, 0);

631 
moduË_·¿m_¬¿y
(
fuÎ_du¶ex
, , 
NULL
, 0);

632 
moduË_·¿m
(
debug
, , 0);

633 
MODULE_PARM_DESC
 (
debug
, "8139too bitmapped messageƒnable‚umber");

634 
MODULE_PARM_DESC
 (
muÉiÿ¡_f‹r_lim™
, "8139too maximum‚umber of filtered multicast‡ddresses");

635 
MODULE_PARM_DESC
 (
medŸ
, "8139too: Bits 4+9: force full duplex, bit 5: 100Mbps");

636 
MODULE_PARM_DESC
 (
fuÎ_du¶ex
, "8139too: Force full duplex for board(s) (1)");

638 
»ad_“´om
 (
__iomem
 *
ißddr
, 
loÿtiÚ
, 
addr_Ën
);

639 
¹l8139_İ’
 (
Ãt_deviû
 *
dev
);

640 
mdio_»ad
 (
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
);

641 
mdio_wr™e
 (
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
,

642 
v®
);

643 
¹l8139_¡¬t_th»ad
(
¹l8139_´iv©e
 *

);

644 
¹l8139_tx_timeout
 (
Ãt_deviû
 *
dev
);

645 
¹l8139_š™_ršg
 (
Ãt_deviû
 *
dev
);

646 
Ãtdev_tx_t
 
¹l8139_¡¬t_xm™
 (
sk_buff
 *
skb
,

647 
Ãt_deviû
 *
dev
);

648 #ifdeà
CONFIG_NET_POLL_CONTROLLER


649 
¹l8139_pŞl_cÚŒŞËr
(
Ãt_deviû
 *
dev
);

651 
¹l8139_£t_mac_add»ss
(
Ãt_deviû
 *
dev
, *
p
);

652 
¹l8139_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
);

653 
œq»tuº_t
 
¹l8139_š‹¼u±
 (
œq
, *
dev_š¡ªû
);

654 
¹l8139_şo£
 (
Ãt_deviû
 *
dev
);

655 
Ãtdev_ioùl
 (
Ãt_deviû
 *
dev
, 
iäeq
 *
rq
, 
cmd
);

656 
¹Æ_lšk_¡©s64
 *
¹l8139_g‘_¡©s64
(
Ãt_deviû
 *
dev
,

657 
¹Æ_lšk_¡©s64


658 *
¡©s
);

659 
¹l8139_£t_rx_mode
 (
Ãt_deviû
 *
dev
);

660 
__£t_rx_mode
 (
Ãt_deviû
 *
dev
);

661 
¹l8139_hw_¡¬t
 (
Ãt_deviû
 *
dev
);

662 
¹l8139_th»ad
 (
wÜk_¡ruù
 *
wÜk
);

663 
¹l8139_tx_timeout_sk
(
wÜk_¡ruù
 *
wÜk
);

664 cÚ¡ 
‘htoŞ_İs
 
	g¹l8139_‘htoŞ_İs
;

668 
	#RTL_W8_F
(
»g
, 
v®8
èdØ{ 
	`iowr™e8
 ((v®8), 
ißddr
 + (»g)); 
	`iÜ—d8
 (ißdd¸+ (»g)); } 0)

	)

669 
	#RTL_W16_F
(
»g
, 
v®16
èdØ{ 
	`iowr™e16
 ((v®16), 
ißddr
 + (»g)); 
	`iÜ—d16
 (ißdd¸+ (»g)); } 0)

	)

670 
	#RTL_W32_F
(
»g
, 
v®32
èdØ{ 
	`iowr™e32
 ((v®32), 
ißddr
 + (»g)); 
	`iÜ—d32
 (ißdd¸+ (»g)); } 0)

	)

673 
	#RTL_W8
(
»g
, 
v®8
è
	`iowr™e8
 ((v®8), 
ißddr
 + (»g))

	)

674 
	#RTL_W16
(
»g
, 
v®16
è
	`iowr™e16
 ((v®16), 
ißddr
 + (»g))

	)

675 
	#RTL_W32
(
»g
, 
v®32
è
	`iowr™e32
 ((v®32), 
ißddr
 + (»g))

	)

678 
	#RTL_R8
(
»g
è
	`iÜ—d8
 (
ißddr
 + (»g))

	)

679 
	#RTL_R16
(
»g
è
	`iÜ—d16
 (
ißddr
 + (»g))

	)

680 
	#RTL_R32
(
»g
è
	`iÜ—d32
 (
ißddr
 + (»g))

	)

683 cÚ¡ 
u16
 
	g¹l8139_šŒ_mask
 =

684 
PCIE¼
 | 
PCSTimeout
 | 
RxUnd”run
 | 
RxOv”æow
 | 
RxFIFOOv”
 |

685 
TxE¼
 | 
TxOK
 | 
RxE¼
 | 
RxOK
;

687 cÚ¡ 
u16
 
	g¹l8139_nÜx_šŒ_mask
 =

688 
PCIE¼
 | 
PCSTimeout
 | 
RxUnd”run
 |

689 
TxE¼
 | 
TxOK
 | 
RxE¼
 ;

691 #ià
RX_BUF_IDX
 == 0

692 cÚ¡ 
	g¹l8139_rx_cÚfig
 =

693 
RxCfgRcv8K
 | 
RxNoW¿p
 |

694 (
RX_FIFO_THRESH
 << 
RxCfgFIFOShiá
) |

695 (
RX_DMA_BURST
 << 
RxCfgDMAShiá
);

696 #–ià
RX_BUF_IDX
 == 1

697 cÚ¡ 
	g¹l8139_rx_cÚfig
 =

698 
RxCfgRcv16K
 | 
RxNoW¿p
 |

699 (
RX_FIFO_THRESH
 << 
RxCfgFIFOShiá
) |

700 (
RX_DMA_BURST
 << 
RxCfgDMAShiá
);

701 #–ià
RX_BUF_IDX
 == 2

702 cÚ¡ 
	g¹l8139_rx_cÚfig
 =

703 
RxCfgRcv32K
 | 
RxNoW¿p
 |

704 (
RX_FIFO_THRESH
 << 
RxCfgFIFOShiá
) |

705 (
RX_DMA_BURST
 << 
RxCfgDMAShiá
);

706 #–ià
RX_BUF_IDX
 == 3

707 cÚ¡ 
	g¹l8139_rx_cÚfig
 =

708 
RxCfgRcv64K
 |

709 (
RX_FIFO_THRESH
 << 
RxCfgFIFOShiá
) |

710 (
RX_DMA_BURST
 << 
RxCfgDMAShiá
);

715 cÚ¡ 
	g¹l8139_tx_cÚfig
 =

716 
TxIFG96
 | (
TX_DMA_BURST
 << 
TxDMAShiá
è| (
TX_RETRY
 << 
TxR‘ryShiá
);

718 
	$__¹l8139_ş—nup_dev
 (
Ãt_deviû
 *
dev
)

720 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

721 
pci_dev
 *
pdev
;

723 
	`as£¹
 (
dev
 !ğ
NULL
);

724 
	`as£¹
 (

->
pci_dev
 !ğ
NULL
);

725 
pdev
 = 

->
pci_dev
;

727 ià(

->
mmio_addr
)

728 
	`pci_iounm­
 (
pdev
, 

->
mmio_addr
);

731 
	`pci_»Ëa£_»giÚs
 (
pdev
);

733 
	`ä“_Ãtdev
(
dev
);

734 
	}
}

737 
	$¹l8139_ch_»£t
 (
__iomem
 *
ißddr
)

739 
i
;

742 
	`RTL_W8
 (
ChCmd
, 
CmdRe£t
);

745 
i
 = 1000; i > 0; i--) {

746 
	`b¬r›r
();

747 ià((
	`RTL_R8
 (
ChCmd
è& 
CmdRe£t
) == 0)

749 
	`ud–ay
 (10);

751 
	}
}

754 
Ãt_deviû
 *
	$¹l8139_š™_bßrd
(
pci_dev
 *
pdev
)

756 
deviû
 *
d
 = &
pdev
->
dev
;

757 
__iomem
 *
ißddr
;

758 
Ãt_deviû
 *
dev
;

759 
¹l8139_´iv©e
 *

;

760 
u8
 
tmp8
;

761 
rc
, 
di§bË_dev_Ú_”r
 = 0;

762 
i
, 
b¬
;

763 
io_Ën
;

764 
u32
 
v”siÚ
;

766 
mask
;

767 *
ty³
;

768 } 
»s
[] = {

769 { 
IORESOURCE_IO
, "PIO" },

770 { 
IORESOURCE_MEM
, "MMIO" }

773 
	`as£¹
 (
pdev
 !ğ
NULL
);

776 
dev
 = 
	`®loc_‘h”dev
 ( (*

));

777 ià(
dev
 =ğ
NULL
)

778  
	`ERR_PTR
(-
ENOMEM
);

780 
	`SET_NETDEV_DEV
(
dev
, &
pdev
->dev);

782 

 = 
	`Ãtdev_´iv
(
dev
);

783 

->
pci_dev
 = 
pdev
;

786 
rc
 = 
	`pci_’abË_deviû
 (
pdev
);

787 ià(
rc
)

788 
”r_out
;

790 
di§bË_dev_Ú_”r
 = 1;

791 
rc
 = 
	`pci_»que¡_»giÚs
 (
pdev
, 
DRV_NAME
);

792 ià(
rc
)

793 
”r_out
;

795 
	`pci_£t_ma¡”
 (
pdev
);

797 
	`u64_¡©s_š™
(&

->
rx_¡©s
.
synı
);

798 
	`u64_¡©s_š™
(&

->
tx_¡©s
.
synı
);

800 
»Œy
:

802 
b¬
 = !
u£_io
;

804 
io_Ën
 = 
	`pci_»sourû_Ën
(
pdev
, 
b¬
);

806 
	`dev_dbg
(
d
, "% »giÚ sizğ0x%02lX\n", 
»s
[
b¬
].
ty³
, 
io_Ën
);

808 ià(!(
	`pci_»sourû_æags
(
pdev
, 
b¬
è& 
»s
[b¬].
mask
)) {

809 
	`dev_”r
(
d
, "»giÚ #%d‚Ù‡ % »sourû,‡bÜtšg\n", 
b¬
,

810 
»s
[
b¬
].
ty³
);

811 
rc
 = -
ENODEV
;

812 
”r_out
;

814 ià(
io_Ën
 < 
RTL_MIN_IO_SIZE
) {

815 
	`dev_”r
(
d
, "Invalid PCI %s„egion size(s),‡borting\n",

816 
»s
[
b¬
].
ty³
);

817 
rc
 = -
ENODEV
;

818 
”r_out
;

821 
ißddr
 = 
	`pci_iom­
(
pdev
, 
b¬
, 0);

822 ià(!
ißddr
) {

823 
	`dev_”r
(
d
, "ÿÂÙ m­ %s\n", 
»s
[
b¬
].
ty³
);

824 ià(!
u£_io
) {

825 
u£_io
 = 
Œue
;

826 
»Œy
;

828 
rc
 = -
ENODEV
;

829 
”r_out
;

831 

->
»gs_Ën
 = 
io_Ën
;

832 

->
mmio_addr
 = 
ißddr
;

835 
	`RTL_W8
 (
HÉClk
, 'R');

838 ià(
	`RTL_R32
 (
TxCÚfig
) == 0xFFFFFFFF) {

839 
	`dev_”r
(&
pdev
->
dev
, "Chip‚ot„esponding, ignoring board\n");

840 
rc
 = -
EIO
;

841 
”r_out
;

845 
v”siÚ
 = 
	`RTL_R32
 (
TxCÚfig
è& 
HW_REVID_MASK
;

846 
i
 = 0; i < 
	`ARRAY_SIZE
 (
¹l_ch_šfo
); i++)

847 ià(
v”siÚ
 =ğ
¹l_ch_šfo
[
i
].version) {

848 

->
ch£t
 = 
i
;

849 
m©ch
;

853 
i
 = 0;

854 
	`dev_dbg
(&
pdev
->
dev
, "unknown chip version,‡ssuming RTL-8139\n");

855 
	`dev_dbg
(&
pdev
->
dev
, "TxCÚfig = 0x%x\n", 
	`RTL_R32
 (
TxCÚfig
));

856 

->
ch£t
 = 0;

858 
m©ch
:

859 
	`´_debug
("chipset id (%d) == index %d, '%s'\n",

860 
v”siÚ
, 
i
, 
¹l_ch_šfo
[i].
Çme
);

862 ià(

->
ch£t
 >ğ
CH_8139B
) {

863 
u8
 
Ãw_tmp8
 = 
tmp8
 = 
	`RTL_R8
 (
CÚfig1
);

864 
	`´_debug
("PCI PM wakeup\n");

865 ià((
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasLWake
) &&

866 (
tmp8
 & 
LWAKE
))

867 
Ãw_tmp8
 &ğ~
LWAKE
;

868 
Ãw_tmp8
 |ğ
Cfg1_PM_EÇbË
;

869 ià(
Ãw_tmp8
 !ğ
tmp8
) {

870 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

871 
	`RTL_W8
 (
CÚfig1
, 
tmp8
);

872 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

874 ià(
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasLWake
) {

875 
tmp8
 = 
	`RTL_R8
 (
CÚfig4
);

876 ià(
tmp8
 & 
LWPTN
) {

877 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

878 
	`RTL_W8
 (
CÚfig4
, 
tmp8
 & ~
LWPTN
);

879 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

883 
	`´_debug
("Old chip wakeup\n");

884 
tmp8
 = 
	`RTL_R8
 (
CÚfig1
);

885 
tmp8
 &ğ~(
SLEEP
 | 
PWRDN
);

886 
	`RTL_W8
 (
CÚfig1
, 
tmp8
);

889 
	`¹l8139_ch_»£t
 (
ißddr
);

891  
dev
;

893 
”r_out
:

894 
	`__¹l8139_ş—nup_dev
 (
dev
);

895 ià(
di§bË_dev_Ú_”r
)

896 
	`pci_di§bË_deviû
 (
pdev
);

897  
	`ERR_PTR
(
rc
);

898 
	}
}

900 
	$¹l8139_£t_ã©u»s
(
Ãt_deviû
 *
dev
, 
Ãtdev_ã©u»s_t
 
ã©u»s
)

902 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

903 
æags
;

904 
Ãtdev_ã©u»s_t
 
chªged
 = 
ã©u»s
 ^ 
dev
->features;

905 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

907 ià(!(
chªged
 & (
NETIF_F_RXALL
)))

910 
	`¥š_lock_œq§ve
(&

->
lock
, 
æags
);

912 ià(
chªged
 & 
NETIF_F_RXALL
) {

913 
rx_mode
 = 

->
rx_cÚfig
;

914 ià(
ã©u»s
 & 
NETIF_F_RXALL
)

915 
rx_mode
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

917 
rx_mode
 &ğ~(
Acû±E¼
 | 
Acû±RuÁ
);

918 

->
rx_cÚfig
 = 
¹l8139_rx_cÚfig
 | 
rx_mode
;

919 
	`RTL_W32_F
(
RxCÚfig
, 

->
rx_cÚfig
);

922 
	`¥š_uÆock_œq»¡Üe
(&

->
lock
, 
æags
);

925 
	}
}

927 
	$¹l8139_chªge_mtu
(
Ãt_deviû
 *
dev
, 
Ãw_mtu
)

929 ià(
Ãw_mtu
 < 68 ||‚ew_mtu > 
MAX_ETH_DATA_SIZE
)

930  -
EINVAL
;

931 
dev
->
mtu
 = 
Ãw_mtu
;

933 
	}
}

935 cÚ¡ 
Ãt_deviû_İs
 
	g¹l8139_Ãtdev_İs
 = {

936 .
ndo_İ’
 = 
¹l8139_İ’
,

937 .
	gndo_¡İ
 = 
¹l8139_şo£
,

938 .
	gndo_g‘_¡©s64
 = 
¹l8139_g‘_¡©s64
,

939 .
	gndo_chªge_mtu
 = 
¹l8139_chªge_mtu
,

940 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

941 .
	gndo_£t_mac_add»ss
 = 
¹l8139_£t_mac_add»ss
,

942 .
	gndo_¡¬t_xm™
 = 
¹l8139_¡¬t_xm™
,

943 .
	gndo_£t_rx_mode
 = 
¹l8139_£t_rx_mode
,

944 .
	gndo_do_ioùl
 = 
Ãtdev_ioùl
,

945 .
	gndo_tx_timeout
 = 
¹l8139_tx_timeout
,

946 #ifdeà
CONFIG_NET_POLL_CONTROLLER


947 .
	gndo_pŞl_cÚŒŞËr
 = 
¹l8139_pŞl_cÚŒŞËr
,

949 .
	gndo_£t_ã©u»s
 = 
¹l8139_£t_ã©u»s
,

952 
	$¹l8139_š™_Úe
(
pci_dev
 *
pdev
,

953 cÚ¡ 
pci_deviû_id
 *
’t
)

955 
Ãt_deviû
 *
dev
 = 
NULL
;

956 
¹l8139_´iv©e
 *

;

957 
i
, 
addr_Ën
, 
İtiÚ
;

958 
__iomem
 *
ißddr
;

959 
bßrd_idx
 = -1;

961 
	`as£¹
 (
pdev
 !ğ
NULL
);

962 
	`as£¹
 (
’t
 !ğ
NULL
);

964 
bßrd_idx
++;

969 #iâdeà
MODULE


971 
´š‹d_v”siÚ
;

972 ià(!
´š‹d_v”siÚ
++)

973 
	`´_šfo
(
RTL8139_DRIVER_NAME
 "\n");

977 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_REALTEK
 &&

978 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_REALTEK_8139
 &&…dev->
»visiÚ
 >= 0x20) {

979 
	`dev_šfo
(&
pdev
->
dev
,

981 
pdev
->
v’dÜ
,…dev->
deviû
,…dev->
»visiÚ
);

982  -
ENODEV
;

985 ià(
pdev
->
v’dÜ
 =ğ
PCI_VENDOR_ID_REALTEK
 &&

986 
pdev
->
deviû
 =ğ
PCI_DEVICE_ID_REALTEK_8139
 &&

987 
pdev
->
subsy¡em_v’dÜ
 =ğ
PCI_VENDOR_ID_ATHEROS
 &&

988 
pdev
->
subsy¡em_deviû
 =ğ
PCI_DEVICE_ID_REALTEK_8139
) {

989 
	`´_šfo
("OQO Model 2 detected. Forcing PIO\n");

990 
u£_io
 = 1;

993 
dev
 = 
	`¹l8139_š™_bßrd
 (
pdev
);

994 ià(
	`IS_ERR
(
dev
))

995  
	`PTR_ERR
(
dev
);

997 
	`as£¹
 (
dev
 !ğ
NULL
);

998 

 = 
	`Ãtdev_´iv
(
dev
);

999 

->
dev
 = dev;

1001 
ißddr
 = 

->
mmio_addr
;

1002 
	`as£¹
 (
ißddr
 !ğ
NULL
);

1004 
addr_Ën
 = 
	`»ad_“´om
 (
ißddr
, 0, 8) == 0x8129 ? 8 : 6;

1005 
i
 = 0; i < 3; i++)

1006 ((
__Ë16
 *è(
dev
->
dev_addr
))[
i
] =

1007 
	`ıu_to_Ë16
(
	`»ad_“´om
 (
ißddr
, 
i
 + 7, 
addr_Ën
));

1010 
dev
->
Ãtdev_İs
 = &
¹l8139_Ãtdev_İs
;

1011 
dev
->
‘htoŞ_İs
 = &
¹l8139_‘htoŞ_İs
;

1012 
dev
->
w©chdog_timeo
 = 
TX_TIMEOUT
;

1013 
	`Ãtif_Çpi_add
(
dev
, &

->
Çpi
, 
¹l8139_pŞl
, 64);

1019 
dev
->
ã©u»s
 |ğ
NETIF_F_SG
 | 
NETIF_F_HW_CSUM
 | 
NETIF_F_HIGHDMA
;

1020 
dev
->
vÏn_ã©u»s
 = dev->
ã©u»s
;

1022 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXALL
;

1023 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXFCS
;

1026 

 = 
	`Ãtdev_´iv
(
dev
);

1029 

->
drv_æags
 = 
bßrd_šfo
[
’t
->
driv”_d©a
].
hw_æags
;

1030 

->
mmio_addr
 = 
ißddr
;

1031 

->
msg_’abË
 =

1032 (
debug
 < 0 ? 
RTL8139_DEF_MSG_ENABLE
 : ((1 << debug) - 1));

1033 
	`¥š_lock_š™
 (&

->
lock
);

1034 
	`¥š_lock_š™
 (&

->
rx_lock
);

1035 
	`INIT_DELAYED_WORK
(&

->
th»ad
, 
¹l8139_th»ad
);

1036 

->
mii
.
dev
 = dev;

1037 

->
mii
.
mdio_»ad
 = mdio_read;

1038 

->
mii
.
mdio_wr™e
 = mdio_write;

1039 

->
mii
.
phy_id_mask
 = 0x3f;

1040 

->
mii
.
»g_num_mask
 = 0x1f;

1043 
	`´_debug
("abouto„egister device‚amed %s (%p)...\n",

1044 
dev
->
Çme
, dev);

1045 
i
 = 
	`»gi¡”_Ãtdev
 (
dev
);

1046 ià(
i
è
”r_out
;

1048 
	`pci_£t_drvd©a
 (
pdev
, 
dev
);

1050 
	`Ãtdev_šfo
(
dev
, "%s‡t 0x%p, %pM, IRQ %d\n",

1051 
bßrd_šfo
[
’t
->
driv”_d©a
].
Çme
,

1052 
ißddr
, 
dev
->
dev_addr
, 
pdev
->
œq
);

1054 
	`Ãtdev_dbg
(
dev
, "Identified 8139 chipype '%s'\n",

1055 
¹l_ch_šfo
[

->
ch£t
].
Çme
);

1060 #ifdeà
CONFIG_8139TOO_8129


1061 ià(

->
drv_æags
 & 
HAS_MII_XCVR
) {

1062 
phy
, 
phy_idx
 = 0;

1063 
phy
 = 0;…hy < 32 && 
phy_idx
 < (

->
phys
);…hy++) {

1064 
mii_¡©us
 = 
	`mdio_»ad
(
dev
, 
phy
, 1);

1065 ià(
mii_¡©us
 != 0xffff && mii_status != 0x0000) {

1066 
u16
 
adv”tisšg
 = 
	`mdio_»ad
(
dev
, 
phy
, 4);

1067 

->
phys
[
phy_idx
++] = 
phy
;

1068 
	`Ãtdev_šfo
(
dev
, "MIIransceiver %d status 0x%04x‡dvertising %04x\n",

1069 
phy
, 
mii_¡©us
, 
adv”tisšg
);

1072 ià(
phy_idx
 == 0) {

1073 
	`Ãtdev_šfo
(
dev
, "No MIIransceivers found! Assuming SYMransceiver\n");

1074 

->
phys
[0] = 32;

1078 

->
phys
[0] = 32;

1079 

->
mii
.
phy_id
 =p->
phys
[0];

1082 
İtiÚ
 = (
bßrd_idx
 >ğ
MAX_UNITS
è? 0 : 
medŸ
[board_idx];

1083 ià(
İtiÚ
 > 0) {

1084 

->
mii
.
fuÎ_du¶ex
 = (
İtiÚ
 & 0x210) ? 1 : 0;

1085 

->
deçuÉ_pÜt
 = 
İtiÚ
 & 0xFF;

1086 ià(

->
deçuÉ_pÜt
)

1087 

->
mii
.
fÜû_medŸ
 = 1;

1089 ià(
bßrd_idx
 < 
MAX_UNITS
 && 
fuÎ_du¶ex
[board_idx] > 0)

1090 

->
mii
.
fuÎ_du¶ex
 = fuÎ_du¶ex[
bßrd_idx
];

1091 ià(

->
mii
.
fuÎ_du¶ex
) {

1092 
	`Ãtdev_šfo
(
dev
, "Mediaype forcedo Full Duplex\n");

1095 

->
mii
.
fÜû_medŸ
 = 1;

1097 ià(

->
deçuÉ_pÜt
) {

1098 
	`Ãtdev_šfo
(
dev
, " Forcing %dMbps %s-duplex operation\n",

1099 (
İtiÚ
 & 0x20 ? 100 : 10),

1100 (
İtiÚ
 & 0x10 ? "full" : "half"));

1101 
	`mdio_wr™e
(
dev
, 

->
phys
[0], 0,

1102 ((
İtiÚ
 & 0x20) ? 0x2000 : 0) |

1103 ((
İtiÚ
 & 0x10) ? 0x0100 : 0));

1107 ià(
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasHÉClk
)

1108 
	`RTL_W8
 (
HÉClk
, 'H');

1112 
”r_out
:

1113 
	`Ãtif_Çpi_d–
(&

->
Çpi
);

1114 
	`__¹l8139_ş—nup_dev
 (
dev
);

1115 
	`pci_di§bË_deviû
 (
pdev
);

1116  
i
;

1117 
	}
}

1120 
	$¹l8139_»move_Úe
(
pci_dev
 *
pdev
)

1122 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
 (
pdev
);

1123 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1125 
	`as£¹
 (
dev
 !ğ
NULL
);

1127 
	`ÿnûl_d–ayed_wÜk_sync
(&

->
th»ad
);

1128 
	`Ãtif_Çpi_d–
(&

->
Çpi
);

1130 
	`uÄegi¡”_Ãtdev
 (
dev
);

1132 
	`__¹l8139_ş—nup_dev
 (
dev
);

1133 
	`pci_di§bË_deviû
 (
pdev
);

1134 
	}
}

1140 
	#EE_SHIFT_CLK
 0x04

	)

1141 
	#EE_CS
 0x08

	)

1142 
	#EE_DATA_WRITE
 0x02

	)

1143 
	#EE_WRITE_0
 0x00

	)

1144 
	#EE_WRITE_1
 0x02

	)

1145 
	#EE_DATA_READ
 0x01

	)

1146 
	#EE_ENB
 (0x80 | 
EE_CS
)

	)

1152 
	#“´om_d–ay
(è()
	`RTL_R8
(
Cfg9346
)

	)

1155 
	#EE_WRITE_CMD
 (5)

	)

1156 
	#EE_READ_CMD
 (6)

	)

1157 
	#EE_ERASE_CMD
 (7)

	)

1159 
	$»ad_“´om
(
__iomem
 *
ißddr
, 
loÿtiÚ
, 
addr_Ën
)

1161 
i
;

1162 
»tv®
 = 0;

1163 
»ad_cmd
 = 
loÿtiÚ
 | (
EE_READ_CMD
 << 
addr_Ën
);

1165 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
 & ~
EE_CS
);

1166 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
);

1167 
	`“´om_d–ay
 ();

1170 
i
 = 4 + 
addr_Ën
; i >= 0; i--) {

1171 
d©av®
 = (
»ad_cmd
 & (1 << 
i
)è? 
EE_DATA_WRITE
 : 0;

1172 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
 | 
d©av®
);

1173 
	`“´om_d–ay
 ();

1174 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
 | 
d©av®
 | 
EE_SHIFT_CLK
);

1175 
	`“´om_d–ay
 ();

1177 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
);

1178 
	`“´om_d–ay
 ();

1180 
i
 = 16; i > 0; i--) {

1181 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
 | 
EE_SHIFT_CLK
);

1182 
	`“´om_d–ay
 ();

1183 
»tv®
 =

1184 (
»tv®
 << 1è| ((
	`RTL_R8
 (
Cfg9346
è& 
EE_DATA_READ
) ? 1 :

1186 
	`RTL_W8
 (
Cfg9346
, 
EE_ENB
);

1187 
	`“´om_d–ay
 ();

1191 
	`RTL_W8
(
Cfg9346
, 0);

1192 
	`“´om_d–ay
 ();

1194  
»tv®
;

1195 
	}
}

1203 
	#MDIO_DIR
 0x80

	)

1204 
	#MDIO_DATA_OUT
 0x04

	)

1205 
	#MDIO_DATA_IN
 0x02

	)

1206 
	#MDIO_CLK
 0x01

	)

1207 
	#MDIO_WRITE0
 (
MDIO_DIR
)

	)

1208 
	#MDIO_WRITE1
 (
MDIO_DIR
 | 
MDIO_DATA_OUT
)

	)

1210 
	#mdio_d–ay
(è
	`RTL_R8
(
CÚfig4
)

	)

1213 cÚ¡ 
	gmii_2_8139_m­
[8] = {

1214 
BasicModeCŒl
,

1215 
BasicModeStus
,

1218 
NWayAdv”t
,

1219 
NWayLPAR
,

1220 
NWayEx·nsiÚ
,

1225 #ifdeà
CONFIG_8139TOO_8129


1227 
	$mdio_sync
 (
__iomem
 *
ißddr
)

1229 
i
;

1231 
i
 = 32; i >= 0; i--) {

1232 
	`RTL_W8
 (
CÚfig4
, 
MDIO_WRITE1
);

1233 
	`mdio_d–ay
 ();

1234 
	`RTL_W8
 (
CÚfig4
, 
MDIO_WRITE1
 | 
MDIO_CLK
);

1235 
	`mdio_d–ay
 ();

1237 
	}
}

1240 
	$mdio_»ad
 (
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
)

1242 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1243 
»tv®
 = 0;

1244 #ifdeà
CONFIG_8139TOO_8129


1245 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1246 
mii_cmd
 = (0xf6 << 10è| (
phy_id
 << 5è| 
loÿtiÚ
;

1247 
i
;

1250 ià(
phy_id
 > 31) {

1251 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1252  
loÿtiÚ
 < 8 && 
mii_2_8139_m­
[location] ?

1253 
	`RTL_R16
 (
mii_2_8139_m­
[
loÿtiÚ
]) : 0;

1256 #ifdeà
CONFIG_8139TOO_8129


1257 
	`mdio_sync
 (
ißddr
);

1259 
i
 = 15; i >= 0; i--) {

1260 
d©av®
 = (
mii_cmd
 & (1 << 
i
)è? 
MDIO_DATA_OUT
 : 0;

1262 
	`RTL_W8
 (
CÚfig4
, 
MDIO_DIR
 | 
d©av®
);

1263 
	`mdio_d–ay
 ();

1264 
	`RTL_W8
 (
CÚfig4
, 
MDIO_DIR
 | 
d©av®
 | 
MDIO_CLK
);

1265 
	`mdio_d–ay
 ();

1269 
i
 = 19; i > 0; i--) {

1270 
	`RTL_W8
 (
CÚfig4
, 0);

1271 
	`mdio_d–ay
 ();

1272 
»tv®
 = (»tv® << 1è| ((
	`RTL_R8
 (
CÚfig4
è& 
MDIO_DATA_IN
) ? 1 : 0);

1273 
	`RTL_W8
 (
CÚfig4
, 
MDIO_CLK
);

1274 
	`mdio_d–ay
 ();

1278  (
»tv®
 >> 1) & 0xffff;

1279 
	}
}

1282 
	$mdio_wr™e
 (
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
,

1283 
v®ue
)

1285 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1286 #ifdeà
CONFIG_8139TOO_8129


1287 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1288 
mii_cmd
 = (0x5002 << 16è| (
phy_id
 << 23è| (
loÿtiÚ
 << 18è| 
v®ue
;

1289 
i
;

1292 ià(
phy_id
 > 31) {

1293 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1294 ià(
loÿtiÚ
 == 0) {

1295 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

1296 
	`RTL_W16
 (
BasicModeCŒl
, 
v®ue
);

1297 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

1298 } ià(
loÿtiÚ
 < 8 && 
mii_2_8139_m­
[location])

1299 
	`RTL_W16
 (
mii_2_8139_m­
[
loÿtiÚ
], 
v®ue
);

1303 #ifdeà
CONFIG_8139TOO_8129


1304 
	`mdio_sync
 (
ißddr
);

1307 
i
 = 31; i >= 0; i--) {

1308 
d©av®
 =

1309 (
mii_cmd
 & (1 << 
i
)è? 
MDIO_WRITE1
 : 
MDIO_WRITE0
;

1310 
	`RTL_W8
 (
CÚfig4
, 
d©av®
);

1311 
	`mdio_d–ay
 ();

1312 
	`RTL_W8
 (
CÚfig4
, 
d©av®
 | 
MDIO_CLK
);

1313 
	`mdio_d–ay
 ();

1316 
i
 = 2; i > 0; i--) {

1317 
	`RTL_W8
 (
CÚfig4
, 0);

1318 
	`mdio_d–ay
 ();

1319 
	`RTL_W8
 (
CÚfig4
, 
MDIO_CLK
);

1320 
	`mdio_d–ay
 ();

1323 
	}
}

1326 
	$¹l8139_İ’
 (
Ãt_deviû
 *
dev
)

1328 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1329 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1330 cÚ¡ 
œq
 = 

->
pci_dev
->irq;

1331 
»tv®
;

1333 
»tv®
 = 
	`»que¡_œq
(
œq
, 
¹l8139_š‹¼u±
, 
IRQF_SHARED
, 
dev
->
Çme
, dev);

1334 ià(
»tv®
)

1335  
»tv®
;

1337 

->
tx_bufs
 = 
	`dma_®loc_coh”’t
(&->
pci_dev
->
dev
, 
TX_BUF_TOT_LEN
,

1338 &

->
tx_bufs_dma
, 
GFP_KERNEL
);

1339 

->
rx_ršg
 = 
	`dma_®loc_coh”’t
(&->
pci_dev
->
dev
, 
RX_BUF_TOT_LEN
,

1340 &

->
rx_ršg_dma
, 
GFP_KERNEL
);

1341 ià(

->
tx_bufs
 =ğ
NULL
 ||p->
rx_ršg
 == NULL) {

1342 
	`ä“_œq
(
œq
, 
dev
);

1344 ià(

->
tx_bufs
)

1345 
	`dma_ä“_coh”’t
(&

->
pci_dev
->
dev
, 
TX_BUF_TOT_LEN
,

1346 

->
tx_bufs
,p->
tx_bufs_dma
);

1347 ià(

->
rx_ršg
)

1348 
	`dma_ä“_coh”’t
(&

->
pci_dev
->
dev
, 
RX_BUF_TOT_LEN
,

1349 

->
rx_ršg
,p->
rx_ršg_dma
);

1351  -
ENOMEM
;

1355 
	`Çpi_’abË
(&

->
Çpi
);

1357 

->
mii
.
fuÎ_du¶ex
 =p->mii.
fÜû_medŸ
;

1358 

->
tx_æag
 = (
TX_FIFO_THRESH
 << 11) & 0x003f0000;

1360 
	`¹l8139_š™_ršg
 (
dev
);

1361 
	`¹l8139_hw_¡¬t
 (
dev
);

1362 
	`Ãtif_¡¬t_queue
 (
dev
);

1364 
	`Ãtif_dbg
(

, 
ifup
, 
dev
,

1366 
__func__
,

1367 ()
	`pci_»sourû_¡¬t
 (

->
pci_dev
, 1),

1368 
œq
, 
	`RTL_R8
 (
MedŸStus
),

1369 

->
mii
.
fuÎ_du¶ex
 ? "full" : "half");

1371 
	`¹l8139_¡¬t_th»ad
(

);

1374 
	}
}

1377 
	$¹l_check_medŸ
 (
Ãt_deviû
 *
dev
, 
š™_medŸ
)

1379 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1381 ià(

->
phys
[0] >= 0) {

1382 
	`mii_check_medŸ
(&

->
mii
, 
	`Ãtif_msg_lšk
Ñp), 
š™_medŸ
);

1384 
	}
}

1387 
	$¹l8139_hw_¡¬t
 (
Ãt_deviû
 *
dev
)

1389 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1390 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1391 
u32
 
i
;

1392 
u8
 
tmp
;

1395 ià(
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasHÉClk
)

1396 
	`RTL_W8
 (
HÉClk
, 'R');

1398 
	`¹l8139_ch_»£t
 (
ißddr
);

1401 
	`RTL_W8_F
 (
Cfg9346
, 
Cfg9346_UÆock
);

1403 
	`RTL_W32_F
 (
MAC0
 + 0, 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
dev
->
dev_addr
 + 0)));

1404 
	`RTL_W32_F
 (
MAC0
 + 4, 
	`Ë16_to_ıu
 (*(
__Ë16
 *è(
dev
->
dev_addr
 + 4)));

1406 

->
cur_rx
 = 0;

1409 
	`RTL_W32_F
 (
RxBuf
, 

->
rx_ršg_dma
);

1412 
	`RTL_W8
 (
ChCmd
, 
CmdRxEnb
 | 
CmdTxEnb
);

1414 

->
rx_cÚfig
 = 
¹l8139_rx_cÚfig
 | 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

1415 
	`RTL_W32
 (
RxCÚfig
, 

->
rx_cÚfig
);

1416 
	`RTL_W32
 (
TxCÚfig
, 
¹l8139_tx_cÚfig
);

1418 
	`¹l_check_medŸ
 (
dev
, 1);

1420 ià(

->
ch£t
 >ğ
CH_8139B
) {

1424 
	`RTL_W8
 (
CÚfig3
, 
	`RTL_R8
 (CÚfig3è& ~
Cfg3_Magic
);

1427 
	`Ãtdev_dbg
(
dev
, "init buffer‡ddresses\n");

1430 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

1433 
i
 = 0; i < 
NUM_TX_DESC
; i++)

1434 
	`RTL_W32_F
 (
TxAddr0
 + (
i
 * 4), 

->
tx_bufs_dma
 + (->
tx_buf
[i] -p->
tx_bufs
));

1436 
	`RTL_W32
 (
RxMis£d
, 0);

1438 
	`¹l8139_£t_rx_mode
 (
dev
);

1441 
	`RTL_W16
 (
MuÉiIÁr
, 
	`RTL_R16
 (MuÉiIÁrè& 
MuÉiIÁrCË¬
);

1444 
tmp
 = 
	`RTL_R8
 (
ChCmd
);

1445 ià((!(
tmp
 & 
CmdRxEnb
)è|| (!Ñm°& 
CmdTxEnb
)))

1446 
	`RTL_W8
 (
ChCmd
, 
CmdRxEnb
 | 
CmdTxEnb
);

1449 
	`RTL_W16
 (
IÁrMask
, 
¹l8139_šŒ_mask
);

1450 
	}
}

1454 
	$¹l8139_š™_ršg
 (
Ãt_deviû
 *
dev
)

1456 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1457 
i
;

1459 

->
cur_rx
 = 0;

1460 

->
cur_tx
 = 0;

1461 

->
dœty_tx
 = 0;

1463 
i
 = 0; i < 
NUM_TX_DESC
; i++)

1464 

->
tx_buf
[
i
] = &->
tx_bufs
[˜* 
TX_BUF_SIZE
];

1465 
	}
}

1469 
	gÃxt_tick
 = 3 * 
HZ
;

1471 #iâdeà
CONFIG_8139TOO_TUNE_TWISTER


1472 
šlše
 
	$¹l8139_tuÃ_twi¡”
 (
Ãt_deviû
 *
dev
,

1473 
¹l8139_´iv©e
 *

è{
	}
}

1475 
	eTwi¡”P¬amV®s
 {

1476 
	mPARA78_deçuÉ
 = 0x78fa8388,

1477 
	mPARA7c_deçuÉ
 = 0xcb38de43,

1478 
	mPARA7c_xxx
 = 0xcb38de43,

1481 cÚ¡ 
	g·¿m
[4][4] = {

1488 
	$¹l8139_tuÃ_twi¡”
 (
Ãt_deviû
 *
dev
,

1489 
¹l8139_´iv©e
 *

)

1491 
lškÿ£
;

1492 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1498 

->
twi¡›
) {

1500 ià(
	`RTL_R16
 (
CSCR
è& 
CSCR_LškOKB™
) {

1502 
	`RTL_W16
 (
CSCR
, 
CSCR_LškDownOffCmd
);

1503 

->
twi¡›
 = 2;

1504 
Ãxt_tick
 = 
HZ
 / 10;

1507 
	`RTL_W16
 (
CSCR
, 
CSCR_LškDownCmd
);

1508 
	`RTL_W32
 (
FIFOTMS
, 0x20);

1509 
	`RTL_W32
 (
PARA78
, 
PARA78_deçuÉ
);

1510 
	`RTL_W32
 (
PARA7c
, 
PARA7c_deçuÉ
);

1511 

->
twi¡›
 = 0;

1516 
lškÿ£
 = 
	`RTL_R16
 (
CSCR
è& 
CSCR_LškStusB™s
;

1517 ià(
lškÿ£
 == 0x7000)

1518 

->
twi¡_row
 = 3;

1519 ià(
lškÿ£
 == 0x3000)

1520 

->
twi¡_row
 = 2;

1521 ià(
lškÿ£
 == 0x1000)

1522 

->
twi¡_row
 = 1;

1524 

->
twi¡_row
 = 0;

1525 

->
twi¡_cŞ
 = 0;

1526 

->
twi¡›
 = 3;

1527 
Ãxt_tick
 = 
HZ
 / 10;

1531 ià(

->
twi¡_cŞ
 == 0)

1532 
	`RTL_W16
 (
FIFOTMS
, 0);

1533 
	`RTL_W32
 (
PARA7c
, 
·¿m
[(è

->
twi¡_row
]

1534 [(è

->
twi¡_cŞ
]);

1535 
Ãxt_tick
 = 
HZ
 / 10;

1536 ià(++

->
twi¡_cŞ
 >= 4) {

1539 

->
twi¡›
 =

1540 (

->
twi¡_row
 == 3) ? 4 : 0;

1545 ià((
	`RTL_R16
 (
CSCR
) &

1546 
CSCR_LškStusB™s
) == 0x7000) {

1547 

->
twi¡›
 = 0;

1550 
	`RTL_W32
 (
PARA7c
, 0xfb38de03);

1551 

->
twi¡›
 = 5;

1552 
Ãxt_tick
 = 
HZ
 / 10;

1557 
	`RTL_W32
 (
FIFOTMS
, 0x20);

1558 
	`RTL_W32
 (
PARA78
, 
PARA78_deçuÉ
);

1559 
	`RTL_W32
 (
PARA7c
, 
PARA7c_deçuÉ
);

1560 
	`RTL_W32
 (
FIFOTMS
, 0x00);

1561 

->
twi¡_row
 = 2;

1562 

->
twi¡_cŞ
 = 0;

1563 

->
twi¡›
 = 3;

1564 
Ãxt_tick
 = 
HZ
 / 10;

1571 
	}
}

1574 
šlše
 
	$¹l8139_th»ad_™”
 (
Ãt_deviû
 *
dev
,

1575 
¹l8139_´iv©e
 *

,

1576 
__iomem
 *
ißddr
)

1578 
mii_Ía
;

1580 
mii_Ía
 = 
	`mdio_»ad
 (
dev
, 

->
phys
[0], 
MII_LPA
);

1582 ià(!

->
mii
.
fÜû_medŸ
 && 
mii_Ía
 != 0xffff) {

1583 
du¶ex
 = ((
mii_Ía
 & 
LPA_100FULL
) ||

1584 (
mii_Ía
 & 0x01C0) == 0x0040);

1585 ià(

->
mii
.
fuÎ_du¶ex
 !ğ
du¶ex
) {

1586 

->
mii
.
fuÎ_du¶ex
 = 
du¶ex
;

1588 ià(
mii_Ía
) {

1589 
	`Ãtdev_šfo
(
dev
, "Setting %s-duplex based on MII #%d†ink…artner‡bility of %04x\n",

1590 

->
mii
.
fuÎ_du¶ex
 ? "full" : "half",

1591 

->
phys
[0], 
mii_Ía
);

1593 
	`Ãtdev_šfo
(
dev
, "media is unconnected,†ink down, or incompatible connection\n");

1596 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

1597 
	`RTL_W8
 (
CÚfig1
, 

->
mii
.
fuÎ_du¶ex
 ? 0x60 : 0x20);

1598 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

1603 
Ãxt_tick
 = 
HZ
 * 60;

1605 
	`¹l8139_tuÃ_twi¡”
 (
dev
, 

);

1607 
	`Ãtdev_dbg
(
dev
, "Media selectionick, Link…artner %04x\n",

1608 
	`RTL_R16
(
NWayLPAR
));

1609 
	`Ãtdev_dbg
(
dev
, "Other„egisters‡re IntMask %04x IntStatus %04x\n",

1610 
	`RTL_R16
(
IÁrMask
), RTL_R16(
IÁrStus
));

1611 
	`Ãtdev_dbg
(
dev
, "Chip config %02x %02x\n",

1612 
	`RTL_R8
(
CÚfig0
), RTL_R8(
CÚfig1
));

1613 
	}
}

1615 
	$¹l8139_th»ad
 (
wÜk_¡ruù
 *
wÜk
)

1617 
¹l8139_´iv©e
 *

 =

1618 
	`cÚš”_of
(
wÜk
, 
¹l8139_´iv©e
, 
th»ad
.work);

1619 
Ãt_deviû
 *
dev
 = 

->
mii
.dev;

1620 
thr_d–ay
 = 
Ãxt_tick
;

1622 
	`¹Æ_lock
();

1624 ià(!
	`Ãtif_ruÂšg
(
dev
))

1625 
out_uÆock
;

1627 ià(

->
w©chdog_fœed
) {

1628 

->
w©chdog_fœed
 = 0;

1629 
	`¹l8139_tx_timeout_sk
(
wÜk
);

1631 
	`¹l8139_th»ad_™”
(
dev
, 

,p->
mmio_addr
);

1633 ià(

->
have_th»ad
)

1634 
	`scheduË_d–ayed_wÜk
(&

->
th»ad
, 
thr_d–ay
);

1635 
out_uÆock
:

1636 
	`¹Æ_uÆock
 ();

1637 
	}
}

1639 
	$¹l8139_¡¬t_th»ad
(
¹l8139_´iv©e
 *

)

1641 

->
twi¡›
 = 0;

1642 ià(

->
ch£t
 =ğ
CH_8139_K
)

1643 

->
twi¡›
 = 1;

1644 ià(

->
drv_æags
 & 
HAS_LNK_CHNG
)

1647 

->
have_th»ad
 = 1;

1648 

->
w©chdog_fœed
 = 0;

1650 
	`scheduË_d–ayed_wÜk
(&

->
th»ad
, 
Ãxt_tick
);

1651 
	}
}

1653 
šlše
 
	$¹l8139_tx_ş—r
 (
¹l8139_´iv©e
 *

)

1655 

->
cur_tx
 = 0;

1656 

->
dœty_tx
 = 0;

1659 
	}
}

1661 
	$¹l8139_tx_timeout_sk
 (
wÜk_¡ruù
 *
wÜk
)

1663 
¹l8139_´iv©e
 *

 =

1664 
	`cÚš”_of
(
wÜk
, 
¹l8139_´iv©e
, 
th»ad
.work);

1665 
Ãt_deviû
 *
dev
 = 

->
mii
.dev;

1666 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1667 
i
;

1668 
u8
 
tmp8
;

1670 
	`Çpi_di§bË
(&

->
Çpi
);

1671 
	`Ãtif_¡İ_queue
(
dev
);

1672 
	`synchrÚize_sched
();

1674 
	`Ãtdev_dbg
(
dev
, "Transmitimeout, status %02x %04x %04x media %02x\n",

1675 
	`RTL_R8
(
ChCmd
), 
	`RTL_R16
(
IÁrStus
),

1676 
	`RTL_R16
(
IÁrMask
), 
	`RTL_R8
(
MedŸStus
));

1678 
	`Ãtdev_dbg
(
dev
, "Tx queue startƒntry %ld dirtyƒntry %ld\n",

1679 

->
cur_tx
,p->
dœty_tx
);

1680 
i
 = 0; i < 
NUM_TX_DESC
; i++)

1681 
	`Ãtdev_dbg
(
dev
, "Tx descriptor %d is %08x%s\n",

1682 
i
, 
	`RTL_R32
(
TxStus0
 + (i * 4)),

1683 
i
 =ğ

->
dœty_tx
 % 
NUM_TX_DESC
 ?

1686 

->
x¡©s
.
tx_timeouts
++;

1689 
tmp8
 = 
	`RTL_R8
 (
ChCmd
);

1690 ià(
tmp8
 & 
CmdTxEnb
)

1691 
	`RTL_W8
 (
ChCmd
, 
CmdRxEnb
);

1693 
	`¥š_lock_bh
(&

->
rx_lock
);

1695 
	`RTL_W16
 (
IÁrMask
, 0x0000);

1698 
	`¥š_lock_œq
(&

->
lock
);

1699 
	`¹l8139_tx_ş—r
 (

);

1700 
	`¥š_uÆock_œq
(&

->
lock
);

1703 
	`Çpi_’abË
(&

->
Çpi
);

1704 
	`¹l8139_hw_¡¬t
(
dev
);

1705 
	`Ãtif_wake_queue
(
dev
);

1707 
	`¥š_uÆock_bh
(&

->
rx_lock
);

1708 
	}
}

1710 
	$¹l8139_tx_timeout
 (
Ãt_deviû
 *
dev
)

1712 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1714 

->
w©chdog_fœed
 = 1;

1715 ià(!

->
have_th»ad
) {

1716 
	`INIT_DELAYED_WORK
(&

->
th»ad
, 
¹l8139_th»ad
);

1717 
	`scheduË_d–ayed_wÜk
(&

->
th»ad
, 
Ãxt_tick
);

1719 
	}
}

1721 
Ãtdev_tx_t
 
	$¹l8139_¡¬t_xm™
 (
sk_buff
 *
skb
,

1722 
Ãt_deviû
 *
dev
)

1724 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1725 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1726 
’Œy
;

1727 
Ën
 = 
skb
->len;

1728 
æags
;

1731 
’Œy
 = 

->
cur_tx
 % 
NUM_TX_DESC
;

1734 ià(
	`lik–y
(
Ën
 < 
TX_BUF_SIZE
)) {

1735 ià(
Ën
 < 
ETH_ZLEN
)

1736 
	`mem£t
(

->
tx_buf
[
’Œy
], 0, 
ETH_ZLEN
);

1737 
	`skb_cİy_ªd_csum_dev
(
skb
, 

->
tx_buf
[
’Œy
]);

1738 
	`dev_kä“_skb_ªy
(
skb
);

1740 
	`dev_kä“_skb_ªy
(
skb
);

1741 
dev
->
¡©s
.
tx_drİ³d
++;

1742  
NETDEV_TX_OK
;

1745 
	`¥š_lock_œq§ve
(&

->
lock
, 
æags
);

1751 
	`wmb
();

1752 
	`RTL_W32_F
 (
TxStus0
 + (
’Œy
 *  (
u32
)),

1753 

->
tx_æag
 | 
	`max
(
Ën
, ()
ETH_ZLEN
));

1755 

->
cur_tx
++;

1757 ià((

->
cur_tx
 - 
NUM_TX_DESC
è=ğ->
dœty_tx
)

1758 
	`Ãtif_¡İ_queue
 (
dev
);

1759 
	`¥š_uÆock_œq»¡Üe
(&

->
lock
, 
æags
);

1761 
	`Ãtif_dbg
(

, 
tx_queued
, 
dev
, "Queued Tx…acket size %uo slot %d\n",

1762 
Ën
, 
’Œy
);

1764  
NETDEV_TX_OK
;

1765 
	}
}

1768 
	$¹l8139_tx_š‹¼u±
 (
Ãt_deviû
 *
dev
,

1769 
¹l8139_´iv©e
 *

,

1770 
__iomem
 *
ißddr
)

1772 
dœty_tx
, 
tx_Ëá
;

1774 
	`as£¹
 (
dev
 !ğ
NULL
);

1775 
	`as£¹
 (
ißddr
 !ğ
NULL
);

1777 
dœty_tx
 = 

->dirty_tx;

1778 
tx_Ëá
 = 

->
cur_tx
 - 
dœty_tx
;

1779 
tx_Ëá
 > 0) {

1780 
’Œy
 = 
dœty_tx
 % 
NUM_TX_DESC
;

1781 
tx¡©us
;

1783 
tx¡©us
 = 
	`RTL_R32
 (
TxStus0
 + (
’Œy
 *  (
u32
)));

1785 ià(!(
tx¡©us
 & (
TxStOK
 | 
TxUnd”run
 | 
TxAbÜ‹d
)))

1789 ià(
tx¡©us
 & (
TxOutOfWšdow
 | 
TxAbÜ‹d
)) {

1791 
	`Ãtif_dbg
(

, 
tx_”r
, 
dev
, "Transmitƒrror, Tx status %08x\n",

1792 
tx¡©us
);

1793 
dev
->
¡©s
.
tx_”rÜs
++;

1794 ià(
tx¡©us
 & 
TxAbÜ‹d
) {

1795 
dev
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

1796 
	`RTL_W32
 (
TxCÚfig
, 
TxCË¬Abt
);

1797 
	`RTL_W16
 (
IÁrStus
, 
TxE¼
);

1798 
	`wmb
();

1800 ià(
tx¡©us
 & 
TxC¬r›rLo¡
)

1801 
dev
->
¡©s
.
tx_ÿ¼›r_”rÜs
++;

1802 ià(
tx¡©us
 & 
TxOutOfWšdow
)

1803 
dev
->
¡©s
.
tx_wšdow_”rÜs
++;

1805 ià(
tx¡©us
 & 
TxUnd”run
) {

1807 ià(

->
tx_æag
 < 0x00300000)

1808 

->
tx_æag
 += 0x00020000;

1809 
dev
->
¡©s
.
tx_fifo_”rÜs
++;

1811 
dev
->
¡©s
.
cŞlisiÚs
 +ğ(
tx¡©us
 >> 24) & 15;

1812 
	`u64_¡©s_upd©e_begš
(&

->
tx_¡©s
.
synı
);

1813 

->
tx_¡©s
.
·ck‘s
++;

1814 

->
tx_¡©s
.
by‹s
 +ğ
tx¡©us
 & 0x7ff;

1815 
	`u64_¡©s_upd©e_’d
(&

->
tx_¡©s
.
synı
);

1818 
dœty_tx
++;

1819 
tx_Ëá
--;

1822 #iâdeà
RTL8139_NDEBUG


1823 ià(

->
cur_tx
 - 
dœty_tx
 > 
NUM_TX_DESC
) {

1824 
	`Ãtdev_”r
(
dev
, "Out-of-sync dirty…ointer, %ld vs. %ld\n",

1825 
dœty_tx
, 

->
cur_tx
);

1826 
dœty_tx
 +ğ
NUM_TX_DESC
;

1831 ià(

->
dœty_tx
 != dirty_tx) {

1832 

->
dœty_tx
 = dirty_tx;

1833 
	`mb
();

1834 
	`Ãtif_wake_queue
 (
dev
);

1836 
	}
}

1840 
	$¹l8139_rx_”r
 (
u32
 
rx_¡©us
, 
Ãt_deviû
 *
dev
,

1841 
¹l8139_´iv©e
 *

, 
__iomem
 *
ißddr
)

1843 
u8
 
tmp8
;

1844 #ifdeà
CONFIG_8139_OLD_RX_RESET


1845 
tmp_wÜk
;

1848 
	`Ãtif_dbg
(

, 
rx_”r
, 
dev
, "Ethernet frame hadƒrrors, status %08x\n",

1849 
rx_¡©us
);

1850 
dev
->
¡©s
.
rx_”rÜs
++;

1851 ià(!(
rx_¡©us
 & 
RxStusOK
)) {

1852 ià(
rx_¡©us
 & 
RxTooLÚg
) {

1853 
	`Ãtdev_dbg
(
dev
, "Oversized Ethernet frame, status %04x!\n",

1854 
rx_¡©us
);

1857 ià(
rx_¡©us
 & (
RxBadSymbŞ
 | 
RxBadAlign
))

1858 
dev
->
¡©s
.
rx_äame_”rÜs
++;

1859 ià(
rx_¡©us
 & (
RxRuÁ
 | 
RxTooLÚg
))

1860 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

1861 ià(
rx_¡©us
 & 
RxCRCE¼
)

1862 
dev
->
¡©s
.
rx_üc_”rÜs
++;

1864 

->
x¡©s
.
rx_lo¡_š_ršg
++;

1867 #iâdeà
CONFIG_8139_OLD_RX_RESET


1868 
tmp8
 = 
	`RTL_R8
 (
ChCmd
);

1869 
	`RTL_W8
 (
ChCmd
, 
tmp8
 & ~
CmdRxEnb
);

1870 
	`RTL_W8
 (
ChCmd
, 
tmp8
);

1871 
	`RTL_W32
 (
RxCÚfig
, 

->
rx_cÚfig
);

1872 

->
cur_rx
 = 0;

1877 
	`RTL_W8_F
 (
ChCmd
, 
CmdTxEnb
);

1878 
tmp_wÜk
 = 200;

1879 --
tmp_wÜk
 > 0) {

1880 
	`ud–ay
(1);

1881 
tmp8
 = 
	`RTL_R8
 (
ChCmd
);

1882 ià(!(
tmp8
 & 
CmdRxEnb
))

1885 ià(
tmp_wÜk
 <= 0)

1886 
	`Ãtdev_w¬n
(
dev
, "rx stop waitoo†ong\n");

1888 
tmp_wÜk
 = 200;

1889 --
tmp_wÜk
 > 0) {

1890 
	`RTL_W8_F
 (
ChCmd
, 
CmdRxEnb
 | 
CmdTxEnb
);

1891 
	`ud–ay
(1);

1892 
tmp8
 = 
	`RTL_R8
 (
ChCmd
);

1893 ià((
tmp8
 & 
CmdRxEnb
è&& (tmp8 & 
CmdTxEnb
))

1896 ià(
tmp_wÜk
 <= 0)

1897 
	`Ãtdev_w¬n
(
dev
, "tx/rxƒnable waitoo†ong\n");

1900 
	`RTL_W8_F
 (
Cfg9346
, 
Cfg9346_UÆock
);

1902 
	`RTL_W8
 (
ChCmd
, 
CmdRxEnb
 | 
CmdTxEnb
);

1904 

->
rx_cÚfig
 = 
¹l8139_rx_cÚfig
 | 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

1905 
	`RTL_W32
 (
RxCÚfig
, 

->
rx_cÚfig
);

1906 

->
cur_rx
 = 0;

1908 
	`Ãtdev_dbg
(
dev
, "init buffer‡ddresses\n");

1911 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

1914 
	`RTL_W32_F
 (
RxBuf
, 

->
rx_ršg_dma
);

1917 
	`__£t_rx_mode
 (
dev
);

1919 
	}
}

1921 #ià
RX_BUF_IDX
 == 3

1922 
šlše
 
	$w¿p_cİy
(
sk_buff
 *
skb
, cÚ¡ *
ršg
,

1923 
u32
 
off£t
, 
size
)

1925 
u32
 
Ëá
 = 
RX_BUF_LEN
 - 
off£t
;

1927 ià(
size
 > 
Ëá
) {

1928 
	`skb_cİy_to_lš—r_d©a
(
skb
, 
ršg
 + 
off£t
, 
Ëá
);

1929 
	`skb_cİy_to_lš—r_d©a_off£t
(
skb
, 
Ëá
, 
ršg
, 
size
 -†eft);

1931 
	`skb_cİy_to_lš—r_d©a
(
skb
, 
ršg
 + 
off£t
, 
size
);

1932 
	}
}

1935 
	$¹l8139_i¤_ack
(
¹l8139_´iv©e
 *

)

1937 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1938 
u16
 
¡©us
;

1940 
¡©us
 = 
	`RTL_R16
 (
IÁrStus
è& 
RxAckB™s
;

1943 ià(
	`lik–y
(
¡©us
 != 0)) {

1944 ià(
	`uÆik–y
(
¡©us
 & (
RxFIFOOv”
 | 
RxOv”æow
))) {

1945 

->
dev
->
¡©s
.
rx_”rÜs
++;

1946 ià(
¡©us
 & 
RxFIFOOv”
)

1947 

->
dev
->
¡©s
.
rx_fifo_”rÜs
++;

1949 
	`RTL_W16_F
 (
IÁrStus
, 
RxAckB™s
);

1951 
	}
}

1953 
	$¹l8139_rx
(
Ãt_deviû
 *
dev
, 
¹l8139_´iv©e
 *

,

1954 
budg‘
)

1956 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1957 
»ûived
 = 0;

1958 *
rx_ršg
 = 

->rx_ring;

1959 
cur_rx
 = 

->cur_rx;

1960 
rx_size
 = 0;

1962 
	`Ãtdev_dbg
(
dev
, "In %s(), current %04x BufAddr %04x, freeo %04x, Cmd %02x\n",

1963 
__func__
, (
u16
)
cur_rx
,

1964 
	`RTL_R16
(
RxBufAddr
), RTL_R16(
RxBufPŒ
), 
	`RTL_R8
(
ChCmd
));

1966 
	`Ãtif_ruÂšg
(
dev
è&& 
»ûived
 < 
budg‘
 &&

1967 (
	`RTL_R8
 (
ChCmd
è& 
RxBufEm±y
) == 0) {

1968 
u32
 
ršg_off£t
 = 
cur_rx
 % 
RX_BUF_LEN
;

1969 
u32
 
rx_¡©us
;

1970 
pkt_size
;

1971 
sk_buff
 *
skb
;

1973 
	`rmb
();

1976 
rx_¡©us
 = 
	`Ë32_to_ıu
 (*(
__Ë32
 *è(
rx_ršg
 + 
ršg_off£t
));

1977 
rx_size
 = 
rx_¡©us
 >> 16;

1978 ià(
	`lik–y
(!(
dev
->
ã©u»s
 & 
NETIF_F_RXFCS
)))

1979 
pkt_size
 = 
rx_size
 - 4;

1981 
pkt_size
 = 
rx_size
;

1983 
	`Ãtif_dbg
(

, 
rx_¡©us
, 
dev
, "%s() status %04x, size %04x, cur %04x\n",

1984 
__func__
, 
rx_¡©us
, 
rx_size
, 
cur_rx
);

1985 #ià
RTL8139_DEBUG
 > 2

1986 
	`´št_hex_dump
(
KERN_DEBUG
, "Frame contents: ",

1987 
DUMP_PREFIX_OFFSET
, 16, 1,

1988 &
rx_ršg
[
ršg_off£t
], 70, 
Œue
);

1995 ià(
	`uÆik–y
(
rx_size
 == 0xfff0)) {

1996 ià(!

->
fifo_cİy_timeout
)

1997 

->
fifo_cİy_timeout
 = 
jiff›s
 + 2;

1998 ià(
	`time_aá”
(
jiff›s
, 

->
fifo_cİy_timeout
)) {

1999 
	`Ãtdev_dbg
(
dev
, "hung FIFO. Reset\n");

2000 
rx_size
 = 0;

2001 
no_—¾y_rx
;

2003 
	`Ãtif_dbg
(

, 
šŒ
, 
dev
, "fifo copy in…rogress\n");

2004 

->
x¡©s
.
—¾y_rx
++;

2008 
no_—¾y_rx
:

2009 

->
fifo_cİy_timeout
 = 0;

2016 ià(
	`uÆik–y
((
rx_size
 > (
MAX_ETH_FRAME_SIZE
+4)) ||

2017 (
rx_size
 < 8) ||

2018 (!(
rx_¡©us
 & 
RxStusOK
)))) {

2019 ià((
dev
->
ã©u»s
 & 
NETIF_F_RXALL
) &&

2020 (
rx_size
 <ğ(
MAX_ETH_FRAME_SIZE
 + 4)) &&

2021 (
rx_size
 >= 8) &&

2022 (!(
rx_¡©us
 & 
RxStusOK
))) {

2027 
dev
->
¡©s
.
rx_”rÜs
++;

2028 ià(
rx_¡©us
 & 
RxCRCE¼
) {

2029 
dev
->
¡©s
.
rx_üc_”rÜs
++;

2030 
k“p_pkt
;

2032 ià(
rx_¡©us
 & 
RxRuÁ
) {

2033 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

2034 
k“p_pkt
;

2037 
	`¹l8139_rx_”r
 (
rx_¡©us
, 
dev
, 

, 
ißddr
);

2038 
»ûived
 = -1;

2039 
out
;

2042 
k“p_pkt
:

2046 
skb
 = 
	`Çpi_®loc_skb
(&

->
Çpi
, 
pkt_size
);

2047 ià(
	`lik–y
(
skb
)) {

2048 #ià
RX_BUF_IDX
 == 3

2049 
	`w¿p_cİy
(
skb
, 
rx_ršg
, 
ršg_off£t
+4, 
pkt_size
);

2051 
	`skb_cİy_to_lš—r_d©a
 (
skb
, &
rx_ršg
[
ršg_off£t
 + 4], 
pkt_size
);

2053 
	`skb_put
 (
skb
, 
pkt_size
);

2055 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
 (skb, 
dev
);

2057 
	`u64_¡©s_upd©e_begš
(&

->
rx_¡©s
.
synı
);

2058 

->
rx_¡©s
.
·ck‘s
++;

2059 

->
rx_¡©s
.
by‹s
 +ğ
pkt_size
;

2060 
	`u64_¡©s_upd©e_’d
(&

->
rx_¡©s
.
synı
);

2062 
	`Ãtif_»ûive_skb
 (
skb
);

2064 
dev
->
¡©s
.
rx_drİ³d
++;

2066 
»ûived
++;

2068 
cur_rx
 = (cur_rx + 
rx_size
 + 4 + 3) & ~3;

2069 
	`RTL_W16
 (
RxBufPŒ
, (
u16
è(
cur_rx
 - 16));

2071 
	`¹l8139_i¤_ack
(

);

2074 ià(
	`uÆik–y
(!
»ûived
 || 
rx_size
 == 0xfff0))

2075 
	`¹l8139_i¤_ack
(

);

2077 
	`Ãtdev_dbg
(
dev
, "Done %s(), current %04x BufAddr %04x, freeo %04x, Cmd %02x\n",

2078 
__func__
, 
cur_rx
,

2079 
	`RTL_R16
(
RxBufAddr
), RTL_R16(
RxBufPŒ
), 
	`RTL_R8
(
ChCmd
));

2081 

->
cur_rx
 = cur_rx;

2087 ià(

->
fifo_cİy_timeout
)

2088 
»ûived
 = 
budg‘
;

2090 
out
:

2091  
»ûived
;

2092 
	}
}

2095 
	$¹l8139_weœd_š‹¼u±
 (
Ãt_deviû
 *
dev
,

2096 
¹l8139_´iv©e
 *

,

2097 
__iomem
 *
ißddr
,

2098 
¡©us
, 
lšk_chªged
)

2100 
	`Ãtdev_dbg
(
dev
, "AbnÜm® iÁ”ru±, stu %08x\n", 
¡©us
);

2102 
	`as£¹
 (
dev
 !ğ
NULL
);

2103 
	`as£¹
 (

 !ğ
NULL
);

2104 
	`as£¹
 (
ißddr
 !ğ
NULL
);

2107 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ
	`RTL_R32
 (
RxMis£d
);

2108 
	`RTL_W32
 (
RxMis£d
, 0);

2110 ià((
¡©us
 & 
RxUnd”run
è&& 
lšk_chªged
 &&

2111 (

->
drv_æags
 & 
HAS_LNK_CHNG
)) {

2112 
	`¹l_check_medŸ
(
dev
, 0);

2113 
¡©us
 &ğ~
RxUnd”run
;

2116 ià(
¡©us
 & (
RxUnd”run
 | 
RxE¼
))

2117 
dev
->
¡©s
.
rx_”rÜs
++;

2119 ià(
¡©us
 & 
PCSTimeout
)

2120 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

2121 ià(
¡©us
 & 
RxUnd”run
)

2122 
dev
->
¡©s
.
rx_fifo_”rÜs
++;

2123 ià(
¡©us
 & 
PCIE¼
) {

2124 
u16
 
pci_cmd_¡©us
;

2125 
	`pci_»ad_cÚfig_wÜd
 (

->
pci_dev
, 
PCI_STATUS
, &
pci_cmd_¡©us
);

2126 
	`pci_wr™e_cÚfig_wÜd
 (

->
pci_dev
, 
PCI_STATUS
, 
pci_cmd_¡©us
);

2128 
	`Ãtdev_”r
(
dev
, "PCI Bu ”rÜ %04x\n", 
pci_cmd_¡©us
);

2130 
	}
}

2132 
	$¹l8139_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

2134 
¹l8139_´iv©e
 *

 = 
	`cÚš”_of
(
Çpi
, rtl8139_private,‚api);

2135 
Ãt_deviû
 *
dev
 = 

->dev;

2136 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2137 
wÜk_dÚe
;

2139 
	`¥š_lock
(&

->
rx_lock
);

2140 
wÜk_dÚe
 = 0;

2141 ià(
	`lik–y
(
	`RTL_R16
(
IÁrStus
è& 
RxAckB™s
))

2142 
wÜk_dÚe
 +ğ
	`¹l8139_rx
(
dev
, 

, 
budg‘
);

2144 ià(
wÜk_dÚe
 < 
budg‘
) {

2145 
æags
;

2150 
	`¥š_lock_œq§ve
(&

->
lock
, 
æags
);

2151 
	`__Çpi_com¶‘e
(
Çpi
);

2152 
	`RTL_W16_F
(
IÁrMask
, 
¹l8139_šŒ_mask
);

2153 
	`¥š_uÆock_œq»¡Üe
(&

->
lock
, 
æags
);

2155 
	`¥š_uÆock
(&

->
rx_lock
);

2157  
wÜk_dÚe
;

2158 
	}
}

2162 
œq»tuº_t
 
	$¹l8139_š‹¼u±
 (
œq
, *
dev_š¡ªû
)

2164 
Ãt_deviû
 *
dev
 = (Ãt_deviû *è
dev_š¡ªû
;

2165 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2166 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2167 
u16
 
¡©us
, 
ack¡©
;

2168 
lšk_chªged
 = 0;

2169 
hªdËd
 = 0;

2171 
	`¥š_lock
 (&

->
lock
);

2172 
¡©us
 = 
	`RTL_R16
 (
IÁrStus
);

2175 ià(
	`uÆik–y
((
¡©us
 & 
¹l8139_šŒ_mask
) == 0))

2176 
out
;

2178 
hªdËd
 = 1;

2181 ià(
	`uÆik–y
(
¡©us
 == 0xFFFF))

2182 
out
;

2185 ià(
	`uÆik–y
(!
	`Ãtif_ruÂšg
(
dev
))) {

2186 
	`RTL_W16
 (
IÁrMask
, 0);

2187 
out
;

2192 ià(
	`uÆik–y
(
¡©us
 & 
RxUnd”run
))

2193 
lšk_chªged
 = 
	`RTL_R16
 (
CSCR
è& 
CSCR_LškChªgeB™
;

2195 
ack¡©
 = 
¡©us
 & ~(
RxAckB™s
 | 
TxE¼
);

2196 ià(
ack¡©
)

2197 
	`RTL_W16
 (
IÁrStus
, 
ack¡©
);

2201 ià(
¡©us
 & 
RxAckB™s
){

2202 ià(
	`Çpi_scheduË_´•
(&

->
Çpi
)) {

2203 
	`RTL_W16_F
 (
IÁrMask
, 
¹l8139_nÜx_šŒ_mask
);

2204 
	`__Çpi_scheduË
(&

->
Çpi
);

2209 ià(
	`uÆik–y
(
¡©us
 & (
PCIE¼
 | 
PCSTimeout
 | 
RxUnd”run
 | 
RxE¼
)))

2210 
	`¹l8139_weœd_š‹¼u±
 (
dev
, 

, 
ißddr
,

2211 
¡©us
, 
lšk_chªged
);

2213 ià(
¡©us
 & (
TxOK
 | 
TxE¼
)) {

2214 
	`¹l8139_tx_š‹¼u±
 (
dev
, 

, 
ißddr
);

2215 ià(
¡©us
 & 
TxE¼
)

2216 
	`RTL_W16
 (
IÁrStus
, 
TxE¼
);

2218 
out
:

2219 
	`¥š_uÆock
 (&

->
lock
);

2221 
	`Ãtdev_dbg
(
dev
, "exiting interrupt, intr_status=%#4.4x\n",

2222 
	`RTL_R16
(
IÁrStus
));

2223  
	`IRQ_RETVAL
(
hªdËd
);

2224 
	}
}

2226 #ifdeà
CONFIG_NET_POLL_CONTROLLER


2231 
	$¹l8139_pŞl_cÚŒŞËr
(
Ãt_deviû
 *
dev
)

2233 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2234 cÚ¡ 
œq
 = 

->
pci_dev
->irq;

2236 
	`di§bË_œq
(
œq
);

2237 
	`¹l8139_š‹¼u±
(
œq
, 
dev
);

2238 
	`’abË_œq
(
œq
);

2239 
	}
}

2242 
	$¹l8139_£t_mac_add»ss
(
Ãt_deviû
 *
dev
, *
p
)

2244 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2245 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2246 
sockaddr
 *
addr
 = 
p
;

2248 ià(!
	`is_v®id_‘h”_addr
(
addr
->
§_d©a
))

2249  -
EADDRNOTAVAIL
;

2251 
	`memıy
(
dev
->
dev_addr
, 
addr
->
§_d©a
, dev->
addr_Ën
);

2253 
	`¥š_lock_œq
(&

->
lock
);

2255 
	`RTL_W8_F
(
Cfg9346
, 
Cfg9346_UÆock
);

2256 
	`RTL_W32_F
(
MAC0
 + 0, 
	`ıu_to_Ë32
 (*(
u32
 *è(
dev
->
dev_addr
 + 0)));

2257 
	`RTL_W32_F
(
MAC0
 + 4, 
	`ıu_to_Ë32
 (*(
u32
 *è(
dev
->
dev_addr
 + 4)));

2258 
	`RTL_W8_F
(
Cfg9346
, 
Cfg9346_Lock
);

2260 
	`¥š_uÆock_œq
(&

->
lock
);

2263 
	}
}

2265 
	$¹l8139_şo£
 (
Ãt_deviû
 *
dev
)

2267 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2268 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2269 
æags
;

2271 
	`Ãtif_¡İ_queue
(
dev
);

2272 
	`Çpi_di§bË
(&

->
Çpi
);

2274 
	`Ãtif_dbg
(

, 
ifdown
, 
dev
, "Shutting downƒthercard, status was 0x%04x\n",

2275 
	`RTL_R16
(
IÁrStus
));

2277 
	`¥š_lock_œq§ve
 (&

->
lock
, 
æags
);

2280 
	`RTL_W8
 (
ChCmd
, 0);

2283 
	`RTL_W16
 (
IÁrMask
, 0);

2286 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ
	`RTL_R32
 (
RxMis£d
);

2287 
	`RTL_W32
 (
RxMis£d
, 0);

2289 
	`¥š_uÆock_œq»¡Üe
 (&

->
lock
, 
æags
);

2291 
	`ä“_œq
(

->
pci_dev
->
œq
, 
dev
);

2293 
	`¹l8139_tx_ş—r
 (

);

2295 
	`dma_ä“_coh”’t
(&

->
pci_dev
->
dev
, 
RX_BUF_TOT_LEN
,

2296 

->
rx_ršg
,p->
rx_ršg_dma
);

2297 
	`dma_ä“_coh”’t
(&

->
pci_dev
->
dev
, 
TX_BUF_TOT_LEN
,

2298 

->
tx_bufs
,p->
tx_bufs_dma
);

2299 

->
rx_ršg
 = 
NULL
;

2300 

->
tx_bufs
 = 
NULL
;

2303 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

2305 ià(
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasHÉClk
)

2306 
	`RTL_W8
 (
HÉClk
, 'H');

2309 
	}
}

2315 
	$¹l8139_g‘_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

2317 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2318 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2320 
	`¥š_lock_œq
(&

->
lock
);

2321 ià(
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasLWake
) {

2322 
u8
 
cfg3
 = 
	`RTL_R8
 (
CÚfig3
);

2323 
u8
 
cfg5
 = 
	`RTL_R8
 (
CÚfig5
);

2325 
wŞ
->
suµÜ‹d
 = 
WAKE_PHY
 | 
WAKE_MAGIC


2326 | 
WAKE_UCAST
 | 
WAKE_MCAST
 | 
WAKE_BCAST
;

2328 
wŞ
->
wŞİts
 = 0;

2329 ià(
cfg3
 & 
Cfg3_LškUp
)

2330 
wŞ
->
wŞİts
 |ğ
WAKE_PHY
;

2331 ià(
cfg3
 & 
Cfg3_Magic
)

2332 
wŞ
->
wŞİts
 |ğ
WAKE_MAGIC
;

2335 ià(
cfg5
 & 
Cfg5_UWF
)

2336 
wŞ
->
wŞİts
 |ğ
WAKE_UCAST
;

2337 ià(
cfg5
 & 
Cfg5_MWF
)

2338 
wŞ
->
wŞİts
 |ğ
WAKE_MCAST
;

2339 ià(
cfg5
 & 
Cfg5_BWF
)

2340 
wŞ
->
wŞİts
 |ğ
WAKE_BCAST
;

2342 
	`¥š_uÆock_œq
(&

->
lock
);

2343 
	}
}

2349 
	$¹l8139_£t_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

2351 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2352 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2353 
u32
 
suµÜt
;

2354 
u8
 
cfg3
, 
cfg5
;

2356 
suµÜt
 = ((
¹l_ch_šfo
[

->
ch£t
].
æags
 & 
HasLWake
)

2357 ? (
WAKE_PHY
 | 
WAKE_MAGIC


2358 | 
WAKE_UCAST
 | 
WAKE_MCAST
 | 
WAKE_BCAST
)

2360 ià(
wŞ
->
wŞİts
 & ~
suµÜt
)

2361  -
EINVAL
;

2363 
	`¥š_lock_œq
(&

->
lock
);

2364 
cfg3
 = 
	`RTL_R8
 (
CÚfig3
è& ~(
Cfg3_LškUp
 | 
Cfg3_Magic
);

2365 ià(
wŞ
->
wŞİts
 & 
WAKE_PHY
)

2366 
cfg3
 |ğ
Cfg3_LškUp
;

2367 ià(
wŞ
->
wŞİts
 & 
WAKE_MAGIC
)

2368 
cfg3
 |ğ
Cfg3_Magic
;

2369 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_UÆock
);

2370 
	`RTL_W8
 (
CÚfig3
, 
cfg3
);

2371 
	`RTL_W8
 (
Cfg9346
, 
Cfg9346_Lock
);

2373 
cfg5
 = 
	`RTL_R8
 (
CÚfig5
è& ~(
Cfg5_UWF
 | 
Cfg5_MWF
 | 
Cfg5_BWF
);

2377 ià(
wŞ
->
wŞİts
 & 
WAKE_UCAST
)

2378 
cfg5
 |ğ
Cfg5_UWF
;

2379 ià(
wŞ
->
wŞİts
 & 
WAKE_MCAST
)

2380 
cfg5
 |ğ
Cfg5_MWF
;

2381 ià(
wŞ
->
wŞİts
 & 
WAKE_BCAST
)

2382 
cfg5
 |ğ
Cfg5_BWF
;

2383 
	`RTL_W8
 (
CÚfig5
, 
cfg5
);

2384 
	`¥š_uÆock_œq
(&

->
lock
);

2387 
	}
}

2389 
	$¹l8139_g‘_drvšfo
(
Ãt_deviû
 *
dev
, 
‘htoŞ_drvšfo
 *
šfo
)

2391 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2392 
	`¡¾ıy
(
šfo
->
driv”
, 
DRV_NAME
, (info->driver));

2393 
	`¡¾ıy
(
šfo
->
v”siÚ
, 
DRV_VERSION
, (info->version));

2394 
	`¡¾ıy
(
šfo
->
bus_šfo
, 
	`pci_Çme
(

->
pci_dev
), (info->bus_info));

2395 
	}
}

2397 
	$¹l8139_g‘_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2399 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2400 
	`¥š_lock_œq
(&

->
lock
);

2401 
	`mii_‘htoŞ_g£t
(&

->
mii
, 
cmd
);

2402 
	`¥š_uÆock_œq
(&

->
lock
);

2404 
	}
}

2406 
	$¹l8139_£t_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2408 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2409 
rc
;

2410 
	`¥š_lock_œq
(&

->
lock
);

2411 
rc
 = 
	`mii_‘htoŞ_s£t
(&

->
mii
, 
cmd
);

2412 
	`¥š_uÆock_œq
(&

->
lock
);

2413  
rc
;

2414 
	}
}

2416 
	$¹l8139_nway_»£t
(
Ãt_deviû
 *
dev
)

2418 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2419  
	`mii_nway_»¡¬t
(&

->
mii
);

2420 
	}
}

2422 
u32
 
	$¹l8139_g‘_lšk
(
Ãt_deviû
 *
dev
)

2424 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2425  
	`mii_lšk_ok
(&

->
mii
);

2426 
	}
}

2428 
u32
 
	$¹l8139_g‘_msgËv–
(
Ãt_deviû
 *
dev
)

2430 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2431  

->
msg_’abË
;

2432 
	}
}

2434 
	$¹l8139_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
d©um
)

2436 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2437 

->
msg_’abË
 = 
d©um
;

2438 
	}
}

2440 
	$¹l8139_g‘_»gs_Ën
(
Ãt_deviû
 *
dev
)

2442 
¹l8139_´iv©e
 *

;

2444 ià(
u£_io
)

2446 

 = 
	`Ãtdev_´iv
(
dev
);

2447  

->
»gs_Ën
;

2448 
	}
}

2450 
	$¹l8139_g‘_»gs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_»gs
 *
»gs
, *
»gbuf
)

2452 
¹l8139_´iv©e
 *

;

2455 ià(
u£_io
)

2457 

 = 
	`Ãtdev_´iv
(
dev
);

2459 
»gs
->
v”siÚ
 = 
RTL_REGS_VER
;

2461 
	`¥š_lock_œq
(&

->
lock
);

2462 
	`memıy_äomio
(
»gbuf
, 

->
mmio_addr
, 
»gs
->
Ën
);

2463 
	`¥š_uÆock_œq
(&

->
lock
);

2464 
	}
}

2466 
	$¹l8139_g‘_s£t_couÁ
(
Ãt_deviû
 *
dev
, 
s£t
)

2468 
s£t
) {

2469 
ETH_SS_STATS
:

2470  
RTL_NUM_STATS
;

2472  -
EOPNOTSUPP
;

2474 
	}
}

2476 
	$¹l8139_g‘_‘htoŞ_¡©s
(
Ãt_deviû
 *
dev
, 
‘htoŞ_¡©s
 *
¡©s
, 
u64
 *
d©a
)

2478 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2480 
d©a
[0] = 

->
x¡©s
.
—¾y_rx
;

2481 
d©a
[1] = 

->
x¡©s
.
tx_buf_m­³d
;

2482 
d©a
[2] = 

->
x¡©s
.
tx_timeouts
;

2483 
d©a
[3] = 

->
x¡©s
.
rx_lo¡_š_ršg
;

2484 
	}
}

2486 
	$¹l8139_g‘_¡ršgs
(
Ãt_deviû
 *
dev
, 
u32
 
¡ršg£t
, 
u8
 *
d©a
)

2488 
	`memıy
(
d©a
, 
‘htoŞ_¡©s_keys
, (ethtool_stats_keys));

2489 
	}
}

2491 cÚ¡ 
‘htoŞ_İs
 
	g¹l8139_‘htoŞ_İs
 = {

2492 .
g‘_drvšfo
 = 
¹l8139_g‘_drvšfo
,

2493 .
	gg‘_£‰šgs
 = 
¹l8139_g‘_£‰šgs
,

2494 .
	g£t_£‰šgs
 = 
¹l8139_£t_£‰šgs
,

2495 .
	gg‘_»gs_Ën
 = 
¹l8139_g‘_»gs_Ën
,

2496 .
	gg‘_»gs
 = 
¹l8139_g‘_»gs
,

2497 .
	gnway_»£t
 = 
¹l8139_nway_»£t
,

2498 .
	gg‘_lšk
 = 
¹l8139_g‘_lšk
,

2499 .
	gg‘_msgËv–
 = 
¹l8139_g‘_msgËv–
,

2500 .
	g£t_msgËv–
 = 
¹l8139_£t_msgËv–
,

2501 .
	gg‘_wŞ
 = 
¹l8139_g‘_wŞ
,

2502 .
	g£t_wŞ
 = 
¹l8139_£t_wŞ
,

2503 .
	gg‘_¡ršgs
 = 
¹l8139_g‘_¡ršgs
,

2504 .
	gg‘_s£t_couÁ
 = 
¹l8139_g‘_s£t_couÁ
,

2505 .
	gg‘_‘htoŞ_¡©s
 = 
¹l8139_g‘_‘htoŞ_¡©s
,

2508 
	$Ãtdev_ioùl
(
Ãt_deviû
 *
dev
, 
iäeq
 *
rq
, 
cmd
)

2510 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2511 
rc
;

2513 ià(!
	`Ãtif_ruÂšg
(
dev
))

2514  -
EINVAL
;

2516 
	`¥š_lock_œq
(&

->
lock
);

2517 
rc
 = 
	`g’”ic_mii_ioùl
(&

->
mii
, 
	`if_mii
(
rq
), 
cmd
, 
NULL
);

2518 
	`¥š_uÆock_œq
(&

->
lock
);

2520  
rc
;

2521 
	}
}

2524 
¹Æ_lšk_¡©s64
 *

2525 
	$¹l8139_g‘_¡©s64
(
Ãt_deviû
 *
dev
, 
¹Æ_lšk_¡©s64
 *
¡©s
)

2527 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2528 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2529 
æags
;

2530 
¡¬t
;

2532 ià(
	`Ãtif_ruÂšg
(
dev
)) {

2533 
	`¥š_lock_œq§ve
 (&

->
lock
, 
æags
);

2534 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ
	`RTL_R32
 (
RxMis£d
);

2535 
	`RTL_W32
 (
RxMis£d
, 0);

2536 
	`¥š_uÆock_œq»¡Üe
 (&

->
lock
, 
æags
);

2539 
	`Ãtdev_¡©s_to_¡©s64
(
¡©s
, &
dev
->stats);

2542 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
rx_¡©s
.
synı
);

2543 
¡©s
->
rx_·ck‘s
 = 

->
rx_¡©s
.
·ck‘s
;

2544 
¡©s
->
rx_by‹s
 = 

->
rx_¡©s
.
by‹s
;

2545 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
rx_¡©s
.
synı
, 
¡¬t
));

2548 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
tx_¡©s
.
synı
);

2549 
¡©s
->
tx_·ck‘s
 = 

->
tx_¡©s
.
·ck‘s
;

2550 
¡©s
->
tx_by‹s
 = 

->
tx_¡©s
.
by‹s
;

2551 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
tx_¡©s
.
synı
, 
¡¬t
));

2553  
¡©s
;

2554 
	}
}

2559 
	$__£t_rx_mode
 (
Ãt_deviû
 *
dev
)

2561 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2562 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2563 
u32
 
mc_f‹r
[2];

2564 
rx_mode
;

2565 
u32
 
tmp
;

2567 
	`Ãtdev_dbg
(
dev
, "rtl8139_set_rx_mode(%04x) done -- Rx config %08x\n",

2568 
dev
->
æags
, 
	`RTL_R32
(
RxCÚfig
));

2571 ià(
dev
->
æags
 & 
IFF_PROMISC
) {

2572 
rx_mode
 =

2573 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
 |

2574 
Acû±AÎPhys
;

2575 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

2576 } ià((
	`Ãtdev_mc_couÁ
(
dev
è> 
muÉiÿ¡_f‹r_lim™
) ||

2577 (
dev
->
æags
 & 
IFF_ALLMULTI
)) {

2579 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
;

2580 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

2582 
Ãtdev_hw_addr
 *
ha
;

2583 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

2584 
mc_f‹r
[1] = mc_filter[0] = 0;

2585 
	`Ãtdev_fÜ_—ch_mc_addr
(
ha
, 
dev
) {

2586 
b™_Ä
 = 
	`‘h”_üc
(
ETH_ALEN
, 
ha
->
addr
) >> 26;

2588 
mc_f‹r
[
b™_Ä
 >> 5] |= 1 << (bit_nr & 31);

2589 
rx_mode
 |ğ
Acû±MuÉiÿ¡
;

2593 ià(
dev
->
ã©u»s
 & 
NETIF_F_RXALL
)

2594 
rx_mode
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

2597 
tmp
 = 
¹l8139_rx_cÚfig
 | 
rx_mode
;

2598 ià(

->
rx_cÚfig
 !ğ
tmp
) {

2599 
	`RTL_W32_F
 (
RxCÚfig
, 
tmp
);

2600 

->
rx_cÚfig
 = 
tmp
;

2602 
	`RTL_W32_F
 (
MAR0
 + 0, 
mc_f‹r
[0]);

2603 
	`RTL_W32_F
 (
MAR0
 + 4, 
mc_f‹r
[1]);

2604 
	}
}

2606 
	$¹l8139_£t_rx_mode
 (
Ãt_deviû
 *
dev
)

2608 
æags
;

2609 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2611 
	`¥š_lock_œq§ve
 (&

->
lock
, 
æags
);

2612 
	`__£t_rx_mode
(
dev
);

2613 
	`¥š_uÆock_œq»¡Üe
 (&

->
lock
, 
æags
);

2614 
	}
}

2616 #ifdeà
CONFIG_PM


2618 
	$¹l8139_su¥’d
 (
pci_dev
 *
pdev
, 
pm_mes§ge_t
 
¡©e
)

2620 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
 (
pdev
);

2621 
¹l8139_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2622 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2623 
æags
;

2625 
	`pci_§ve_¡©e
 (
pdev
);

2627 ià(!
	`Ãtif_ruÂšg
 (
dev
))

2630 
	`Ãtif_deviû_d‘ach
 (
dev
);

2632 
	`¥š_lock_œq§ve
 (&

->
lock
, 
æags
);

2635 
	`RTL_W16
 (
IÁrMask
, 0);

2636 
	`RTL_W8
 (
ChCmd
, 0);

2639 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ
	`RTL_R32
 (
RxMis£d
);

2640 
	`RTL_W32
 (
RxMis£d
, 0);

2642 
	`¥š_uÆock_œq»¡Üe
 (&

->
lock
, 
æags
);

2644 
	`pci_£t_pow”_¡©e
 (
pdev
, 
PCI_D3hÙ
);

2647 
	}
}

2650 
	$¹l8139_»sume
 (
pci_dev
 *
pdev
)

2652 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
 (
pdev
);

2654 
	`pci_»¡Üe_¡©e
 (
pdev
);

2655 ià(!
	`Ãtif_ruÂšg
 (
dev
))

2657 
	`pci_£t_pow”_¡©e
 (
pdev
, 
PCI_D0
);

2658 
	`¹l8139_š™_ršg
 (
dev
);

2659 
	`¹l8139_hw_¡¬t
 (
dev
);

2660 
	`Ãtif_deviû_©ch
 (
dev
);

2662 
	}
}

2667 
pci_driv”
 
	g¹l8139_pci_driv”
 = {

2668 .
Çme
 = 
DRV_NAME
,

2669 .
	gid_bË
 = 
¹l8139_pci_tbl
,

2670 .
	g´obe
 = 
¹l8139_š™_Úe
,

2671 .
	g»move
 = 
¹l8139_»move_Úe
,

2672 #ifdeà
CONFIG_PM


2673 .
	gsu¥’d
 = 
¹l8139_su¥’d
,

2674 .
	g»sume
 = 
¹l8139_»sume
,

2679 
__š™
 
	$¹l8139_š™_moduË
 ()

2684 #ifdeà
MODULE


2685 
	`´_šfo
(
RTL8139_DRIVER_NAME
 "\n");

2688  
	`pci_»gi¡”_driv”
(&
¹l8139_pci_driv”
);

2689 
	}
}

2692 
__ex™
 
	$¹l8139_ş—nup_moduË
 ()

2694 
	`pci_uÄegi¡”_driv”
 (&
¹l8139_pci_driv”
);

2695 
	}
}

2698 
moduË_š™
(
¹l8139_š™_moduË
);

2699 
moduË_ex™
(
¹l8139_ş—nup_moduË
);

	@atp.c

34 cÚ¡ 
	gv”siÚ
[] =

40 
	gdebug
 = 1;

41 
	#Ãt_debug
 
debug


	)

44 
	gmax_š‹¼u±_wÜk
 = 15;

46 
	#NUM_UNITS
 2

	)

48 
	gio
[
NUM_UNITS
];

49 
	gœq
[
NUM_UNITS
];

50 
	gxcvr
[
NUM_UNITS
];

55 
	#TX_TIMEOUT
 (400*
HZ
/1000)

	)

125 
	~<lšux/k”Ãl.h
>

126 
	~<lšux/moduË.h
>

127 
	~<lšux/ty³s.h
>

128 
	~<lšux/fú.h
>

129 
	~<lšux/š‹¼u±.h
>

130 
	~<lšux/iİÜt.h
>

131 
	~<lšux/š.h
>

132 
	~<lšux/¡ršg.h
>

133 
	~<lšux/”ºo.h
>

134 
	~<lšux/š™.h
>

135 
	~<lšux/üc32.h
>

136 
	~<lšux/Ãtdeviû.h
>

137 
	~<lšux/‘h”deviû.h
>

138 
	~<lšux/skbuff.h
>

139 
	~<lšux/¥šlock.h
>

140 
	~<lšux/d–ay.h
>

141 
	~<lšux/b™İs.h
>

143 
	~<asm/io.h
>

144 
	~<asm/dma.h
>

146 
	~"©p.h
"

148 
MODULE_AUTHOR
("Donald Becker <becker@scyld.com>");

149 
MODULE_DESCRIPTION
("RealTek RTL8002/8012…arallel…ort Ethernet driver");

150 
MODULE_LICENSE
("GPL");

152 
moduË_·¿m
(
max_š‹¼u±_wÜk
, , 0);

153 
moduË_·¿m
(
debug
, , 0);

154 
moduË_·¿m_¬¿y
(
io
, , 
NULL
, 0);

155 
moduË_·¿m_¬¿y
(
œq
, , 
NULL
, 0);

156 
moduË_·¿m_¬¿y
(
xcvr
, , 
NULL
, 0);

157 
MODULE_PARM_DESC
(
max_š‹¼u±_wÜk
, "ATP maximumƒvents handled…er interrupt");

158 
MODULE_PARM_DESC
(
debug
, "ATP debug†evel (0-7)");

159 
MODULE_PARM_DESC
(
io
, "ATP I/O base‡ddress(es)");

160 
MODULE_PARM_DESC
(
œq
, "ATP IRQ‚umber(s)");

161 
MODULE_PARM_DESC
(
xcvr
, "ATPransceiver(s) (0=internal, 1=external)");

164 
	#ETHERCARD_TOTAL_SIZE
 3

	)

167 
	gmux_8012
[] = { 0xff, 0xf7, 0xff, 0xfb, 0xf3, 0xfb, 0xff, 0xf7,};

169 
	sÃt_loÿl
 {

170 
¥šlock_t
 
	mlock
;

171 
Ãt_deviû
 *
	mÃxt_moduË
;

172 
tim”_li¡
 
	mtim”
;

173 
	mÏ¡_rx_time
;

174 
	m§ved_tx_size
;

175 
	mtx_un™_busy
:1;

176 
	m»_tx
,

177 
	maddr_mode
,

178 
	m·c_út_š_tx_buf
;

184 
	#TIMED_CHECKER
 (
HZ
/4)

	)

185 #ifdeà
TIMED_CHECKER


186 
	~<lšux/tim”.h
>

187 
©p_timed_check”
(
ignÜed
);

192 
©p_´obe1
(
ißddr
);

193 
g‘_node_ID
(
Ãt_deviû
 *
dev
);

194 
“´om_İ
(
ißddr
, 
cmd
);

195 
Ãt_İ’
(
Ãt_deviû
 *
dev
);

196 
h¬dw¬e_š™
(
Ãt_deviû
 *
dev
);

197 
wr™e_·ck‘
(
ißddr
, 
Ëngth
, *
·ck‘
, 
·d
, 
mode
);

198 
Œigg”_£nd
(
ißddr
, 
Ëngth
);

199 
Ãtdev_tx_t
 
©p_£nd_·ck‘
(
sk_buff
 *
skb
,

200 
Ãt_deviû
 *
dev
);

201 
œq»tuº_t
 
©p_š‹¼u±
(
œq
, *
dev_id
);

202 
Ãt_rx
(
Ãt_deviû
 *
dev
);

203 
»ad_block
(
ißddr
, 
Ëngth
, *
bufãr
, 
d©a_mode
);

204 
Ãt_şo£
(
Ãt_deviû
 *
dev
);

205 
£t_rx_mode
(
Ãt_deviû
 *
dev
);

206 
tx_timeout
(
Ãt_deviû
 *
dev
);

210 
Ãt_deviû
 *
	groÙ_©p_dev
;

220 
__š™
 
	$©p_š™
()

222 *
pÜt
, 
pÜts
[] = {0x378, 0x278, 0x3bc, 0};

223 
ba£_addr
 = 
io
[0];

225 ià(
ba£_addr
 > 0x1ff)

226  
	`©p_´obe1
(
ba£_addr
);

227 ià(
ba£_addr
 == 1)

228  -
ENXIO
;

230 
pÜt
 = 
pÜts
; *port;…ort++) {

231 
ißddr
 = *
pÜt
;

232 
	`outb
(0x57, 
ißddr
 + 
PAR_DATA
);

233 ià(
	`šb
(
ißddr
 + 
PAR_DATA
) != 0x57)

235 ià(
	`©p_´obe1
(
ißddr
) == 0)

239  -
ENODEV
;

240 
	}
}

242 cÚ¡ 
Ãt_deviû_İs
 
	g©p_Ãtdev_İs
 = {

243 .
ndo_İ’
 = 
Ãt_İ’
,

244 .
	gndo_¡İ
 = 
Ãt_şo£
,

245 .
	gndo_¡¬t_xm™
 = 
©p_£nd_·ck‘
,

246 .
	gndo_£t_rx_mode
 = 
£t_rx_mode
,

247 .
	gndo_tx_timeout
 = 
tx_timeout
,

248 .
	gndo_chªge_mtu
 = 
‘h_chªge_mtu
,

249 .
	gndo_£t_mac_add»ss
 = 
‘h_mac_addr
,

250 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

253 
__š™
 
	$©p_´obe1
(
ißddr
)

255 
Ãt_deviû
 *
dev
 = 
NULL
;

256 
Ãt_loÿl
 *
Í
;

257 
§ved_ù¾_»g
, 
¡©us
, 
i
;

258 
»s
;

260 
	`outb
(0xff, 
ißddr
 + 
PAR_DATA
);

263 
§ved_ù¾_»g
 = 
	`šb
(
ißddr
 + 
PAR_CONTROL
);

264 ià(
Ãt_debug
 > 3)

265 
	`´štk
("©p: CÚŒŞ„egi¡” wa %#2.2x.\n", 
§ved_ù¾_»g
);

267 
	`outb
(0x04, 
ißddr
 + 
PAR_CONTROL
);

268 #iâdeà
fš®_v”siÚ


269 ià(
Ãt_debug
 > 3) {

271 
i
 = 0; i < 8; i++)

272 
	`outb
(
mux_8012
[
i
], 
ißddr
 + 
PAR_DATA
);

273 
	`wr™e_»g
(
ißddr
, 
MODSEL
, 0x00);

274 
	`´štk
("atp: Registers‡re ");

275 
i
 = 0; i < 32; i++)

276 
	`´štk
(" %2.2x", 
	`»ad_nibbË
(
ißddr
, 
i
));

277 
	`´štk
(".\n");

281 
i
 = 0; i < 8; i++)

282 
	`outb
(
mux_8012
[
i
], 
ißddr
 + 
PAR_DATA
);

283 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

285 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR1
);

287 ià(
Ãt_debug
 > 3) {

288 
	`´štk
(
KERN_DEBUG
 "©p: Stu nibbË wa %#2.2x..", 
¡©us
);

289 
i
 = 0; i < 32; i++)

290 
	`´štk
(" %2.2x", 
	`»ad_nibbË
(
ißddr
, 
i
));

291 
	`´štk
("\n");

294 ià((
¡©us
 & 0x78) != 0x08) {

296 
	`outb
(
§ved_ù¾_»g
, 
ißddr
 + 
PAR_CONTROL
);

297  -
ENODEV
;

299 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR2_h
);

300 ià((
¡©us
 & 0x78) != 0x10) {

301 
	`outb
(
§ved_ù¾_»g
, 
ißddr
 + 
PAR_CONTROL
);

302  -
ENODEV
;

305 
dev
 = 
	`®loc_‘h”dev
((
Ãt_loÿl
));

306 ià(!
dev
)

307  -
ENOMEM
;

310 
	`wr™e_»g_by‹
(
ißddr
, 
CMR2
, 0x01);

311 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RxENABLE
 | 
CMR1h_TxENABLE
);

314 ià(
œq
[0])

315 
dev
->
œq
 = irq[0];

316 ià(
ißddr
 == 0x378)

317 
dev
->
œq
 = 7;

319 
dev
->
œq
 = 5;

320 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_TxRxOFF
);

321 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

323 
dev
->
ba£_addr
 = 
ißddr
;

326 
	`g‘_node_ID
(
dev
);

328 #iâdeà
MODULE


329 ià(
Ãt_debug
)

330 
	`´štk
(
KERN_INFO
 "%s", 
v”siÚ
);

333 
	`´štk
(
KERN_NOTICE
 "%s: Pocket‡dapter found‡t %#3lx, IRQ %d, "

335 
dev
->
Çme
, dev->
ba£_addr
, dev->
œq
, dev->
dev_addr
);

338 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
 | 
CMR1h_MUX
);

340 
Í
 = 
	`Ãtdev_´iv
(
dev
);

341 
Í
->
addr_mode
 = 
CMR2h_NÜm®
;

342 
	`¥š_lock_š™
(&
Í
->
lock
);

345 ià(
xcvr
[0])

346 
dev
->
if_pÜt
 = 
xcvr
[0];

348 
dev
->
if_pÜt
 = (dev->
mem_¡¬t
 & 0xf) ? (dev->mem_start & 0x7) : 4;

349 ià(
dev
->
mem_’d
 & 0xf)

350 
Ãt_debug
 = 
dev
->
mem_’d
 & 7;

352 
dev
->
Ãtdev_İs
 = &
©p_Ãtdev_İs
;

353 
dev
->
w©chdog_timeo
 = 
TX_TIMEOUT
;

355 
»s
 = 
	`»gi¡”_Ãtdev
(
dev
);

356 ià(
»s
) {

357 
	`ä“_Ãtdev
(
dev
);

358  
»s
;

361 
Í
->
Ãxt_moduË
 = 
roÙ_©p_dev
;

362 
roÙ_©p_dev
 = 
dev
;

365 
	}
}

368 
__š™
 
	$g‘_node_ID
(
Ãt_deviû
 *
dev
)

370 
ißddr
 = 
dev
->
ba£_addr
;

371 
§_off£t
 = 0;

372 
i
;

374 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_EEPROM
);

378 ià(
	`“´om_İ
(
ißddr
, 
	`EE_READ
(0)) == 0xffff)

379 
§_off£t
 = 15;

381 
i
 = 0; i < 3; i++)

382 ((
__be16
 *)
dev
->
dev_addr
)[
i
] =

383 
	`ıu_to_be16
(
	`“´om_İ
(
ißddr
, 
	`EE_READ
(
§_off£t
 + 
i
)));

385 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

386 
	}
}

400 
__š™
 
	$“´om_İ
(
ißddr
, 
u32
 
cmd
)

402 
“d©a_out
 = 0;

403 
num_b™s
 = 
EE_CMD_SIZE
;

405 --
num_b™s
 >= 0) {

406 
outv®
 = (
cmd
 & (1<<
num_b™s
)è? 
EE_DATA_WRITE
 : 0;

407 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
outv®
 | 
EE_CLK_LOW
);

408 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
outv®
 | 
EE_CLK_HIGH
);

409 
“d©a_out
 <<= 1;

410 ià(
	`»ad_nibbË
(
ißddr
, 
PROM_DATA
è& 
EE_DATA_READ
)

411 
“d©a_out
++;

413 
	`wr™e_»g_high
(
ißddr
, 
PROM_CMD
, 
EE_CLK_LOW
 & ~
EE_CS
);

414  
“d©a_out
;

415 
	}
}

428 
	$Ãt_İ’
(
Ãt_deviû
 *
dev
)

430 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

431 
»t
;

436 
»t
 = 
	`»que¡_œq
(
dev
->
œq
, 
©p_š‹¼u±
, 0, dev->
Çme
, dev);

437 ià(
»t
)

438  
»t
;

440 
	`h¬dw¬e_š™
(
dev
);

442 
	`š™_tim”
(&
Í
->
tim”
);

443 
Í
->
tim”
.
expœes
 = 
jiff›s
 + 
TIMED_CHECKER
;

444 
Í
->
tim”
.
d©a
 = ()
dev
;

445 
Í
->
tim”
.
funùiÚ
 = 
©p_timed_check”
;

446 
	`add_tim”
(&
Í
->
tim”
);

448 
	`Ãtif_¡¬t_queue
(
dev
);

450 
	}
}

454 
	$h¬dw¬e_š™
(
Ãt_deviû
 *
dev
)

456 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

457 
ißddr
 = 
dev
->
ba£_addr
;

458 
i
;

461 
i
 = 0; i < 8; i++)

462 
	`outb
(
mux_8012
[
i
], 
ißddr
 + 
PAR_DATA
);

463 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
);

465 
i
 = 0; i < 6; i++)

466 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
dev
->
dev_addr
[i]);

468 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

470 ià(
Ãt_debug
 > 2) {

471 
	`´štk
(
KERN_DEBUG
 "%s: Re£t: cu¼’ˆRx mod%d.\n", 
dev
->
Çme
,

472 (
	`»ad_nibbË
(
ißddr
, 
CMR2_h
) >> 3) & 0x0f);

475 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_IRQOUT
);

476 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RxENABLE
 | 
CMR1h_TxENABLE
);

479 
	`outb
(
CŒl_S–D©a
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

482 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

483 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

485 
Í
->
tx_un™_busy
 = 0;

486 
Í
->
·c_út_š_tx_buf
 = 0;

487 
Í
->
§ved_tx_size
 = 0;

488 
	}
}

490 
	$Œigg”_£nd
(
ißddr
, 
Ëngth
)

492 
	`wr™e_»g_by‹
(
ißddr
, 
TxCNT0
, 
Ëngth
 & 0xff);

493 
	`wr™e_»g
(
ißddr
, 
TxCNT1
, 
Ëngth
 >> 8);

494 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_Xm™
);

495 
	}
}

497 
	$wr™e_·ck‘
(
ißddr
, 
Ëngth
, *
·ck‘
, 
·d_Ën
, 
d©a_mode
)

499 ià(
Ëngth
 & 1)

501 
Ëngth
++;

502 
·d_Ën
++;

505 
	`outb
(
EOC
+
MAR
, 
ißddr
 + 
PAR_DATA
);

506 ià((
d©a_mode
 & 1) == 0) {

508 
	`outb
(
WrAddr
+
MAR
, 
ißddr
 + 
PAR_DATA
);

510 
	`wr™e_by‹_mode0
(
ißddr
, *
·ck‘
++);

511 } --
Ëngth
 > 
·d_Ën
) ;

513 
	`wr™e_by‹_mode0
(
ißddr
, 0);

514 } --
Ëngth
 > 0) ;

517 
outby‹
 = *
·ck‘
++;

519 
	`outb
(
CŒl_LNibWr™e
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

520 
	`outb
(
WrAddr
+
MAR
, 
ißddr
 + 
PAR_DATA
);

522 
	`outb
((
outby‹
 & 0x0f)|0x40, 
ißddr
 + 
PAR_DATA
);

523 
	`outb
(
outby‹
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

524 
outby‹
 >>= 4;

525 
	`outb
(
outby‹
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

526 
	`outb
(
CŒl_HNibWr™e
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

527 --
Ëngth
 > 
·d_Ën
)

528 
	`wr™e_by‹_mode1
(
ißddr
, *
·ck‘
++);

529 --
Ëngth
 > 0)

530 
	`wr™e_by‹_mode1
(
ißddr
, 0);

533 
	`outb
(0xff, 
ißddr
 + 
PAR_DATA
);

534 
	`outb
(
CŒl_HNibWr™e
 | 
CŒl_S–D©a
 | 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

535 
	}
}

537 
	$tx_timeout
(
Ãt_deviû
 *
dev
)

539 
ißddr
 = 
dev
->
ba£_addr
;

541 
	`´štk
(
KERN_WARNING
 "%s: T¿nsm™imed out, %s?\n", 
dev
->
Çme
,

542 
	`šb
(
ißddr
 + 
PAR_CONTROL
) & 0x10 ? "network cable…roblem"

544 
dev
->
¡©s
.
tx_”rÜs
++;

546 
	`h¬dw¬e_š™
(
dev
);

547 
	`Ãtif_Œªs_upd©e
(
dev
);

548 
	`Ãtif_wake_queue
(
dev
);

549 
dev
->
¡©s
.
tx_”rÜs
++;

550 
	}
}

552 
Ãtdev_tx_t
 
	$©p_£nd_·ck‘
(
sk_buff
 *
skb
,

553 
Ãt_deviû
 *
dev
)

555 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

556 
ißddr
 = 
dev
->
ba£_addr
;

557 
Ëngth
;

558 
æags
;

560 
Ëngth
 = 
ETH_ZLEN
 < 
skb
->
Ën
 ? skb->len : ETH_ZLEN;

562 
	`Ãtif_¡İ_queue
(
dev
);

567 
	`¥š_lock_œq§ve
(&
Í
->
lock
, 
æags
);

568 
	`wr™e_»g
(
ißddr
, 
IMR
, 0);

569 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 0);

570 
	`¥š_uÆock_œq»¡Üe
(&
Í
->
lock
, 
æags
);

572 
	`wr™e_·ck‘
(
ißddr
, 
Ëngth
, 
skb
->
d©a
,†’gth-skb->
Ën
, 
dev
->
if_pÜt
);

574 
Í
->
·c_út_š_tx_buf
++;

575 ià(
Í
->
tx_un™_busy
 == 0) {

576 
	`Œigg”_£nd
(
ißddr
, 
Ëngth
);

577 
Í
->
§ved_tx_size
 = 0;

578 
Í
->
»_tx
 = 0;

579 
Í
->
tx_un™_busy
 = 1;

581 
Í
->
§ved_tx_size
 = 
Ëngth
;

583 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

584 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

586 
	`dev_kä“_skb
 (
skb
);

587  
NETDEV_TX_OK
;

588 
	}
}

593 
œq»tuº_t
 
	$©p_š‹¼u±
(
œq
, *
dev_š¡ªû
)

595 
Ãt_deviû
 *
dev
 = 
dev_š¡ªû
;

596 
Ãt_loÿl
 *
Í
;

597 
ißddr
;

598 
num_tx_sšû_rx
;

599 
boguscouÁ
 = 
max_š‹¼u±_wÜk
;

600 
hªdËd
 = 0;

602 
ißddr
 = 
dev
->
ba£_addr
;

603 
Í
 = 
	`Ãtdev_´iv
(
dev
);

605 
	`¥š_lock
(&
Í
->
lock
);

608 
	`outb
(
CŒl_S–D©a
, 
ißddr
 + 
PAR_CONTROL
);

611 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_NULL
);

612 
	`wr™e_»g
(
ißddr
, 
IMR
, 0);

614 ià(
Ãt_debug
 > 5è
	`´štk
(
KERN_DEBUG
 "%s: IÀš‹¼u± ", 
dev
->
Çme
);

615 --
boguscouÁ
 > 0) {

616 
¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
ISR
);

617 ià(
Ãt_debug
 > 5è
	`´štk
("loİ stu %02x..", 
¡©us
);

619 ià(
¡©us
 & (
ISR_RxOK
<<3)) {

620 
hªdËd
 = 1;

621 
	`wr™e_»g
(
ißddr
, 
ISR
, 
ISR_RxOK
);

623 
»ad_¡©us
 = 
	`»ad_nibbË
(
ißddr
, 
CMR1
);

624 ià(
Ãt_debug
 > 6)

625 
	`´štk
("hªdlšg Rx…ack‘ %02x..", 
»ad_¡©us
);

628 ià(
»ad_¡©us
 & (
CMR1_IRQ
 << 3)) {

629 
dev
->
¡©s
.
rx_ov”_”rÜs
++;

631 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
CMR2h_OFF
);

632 
	`Ãt_rx
(
dev
);

634 
	`wr™e_»g_high
(
ißddr
, 
ISR
, 
ISRh_RxE¼
);

635 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

636 } ià((
»ad_¡©us
 & (
CMR1_BufEnb
 << 3)) == 0) {

637 
	`Ãt_rx
(
dev
);

638 
num_tx_sšû_rx
 = 0;

641 } --
boguscouÁ
 > 0);

642 } ià(
¡©us
 & ((
ISR_TxE¼
 + 
ISR_TxOK
)<<3)) {

643 
hªdËd
 = 1;

644 ià(
Ãt_debug
 > 6è
	`´štk
("handling Tx done..");

647 
	`wr™e_»g
(
ißddr
, 
ISR
, 
ISR_TxE¼
 + 
ISR_TxOK
);

648 ià(
¡©us
 & (
ISR_TxE¼
<<3)) {

649 
dev
->
¡©s
.
cŞlisiÚs
++;

650 ià(++
Í
->
»_tx
 > 15) {

651 
dev
->
¡©s
.
tx_abÜ‹d_”rÜs
++;

652 
	`h¬dw¬e_š™
(
dev
);

656 ià(
Ãt_debug
 > 6è
	`´štk
("attemptingo ReTx");

657 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_ReXm™
 + 
CMR1_Xm™
);

660 
dev
->
¡©s
.
tx_·ck‘s
++;

661 
Í
->
·c_út_š_tx_buf
--;

662 iàĞ
Í
->
§ved_tx_size
) {

663 
	`Œigg”_£nd
(
ißddr
, 
Í
->
§ved_tx_size
);

664 
Í
->
§ved_tx_size
 = 0;

665 
Í
->
»_tx
 = 0;

667 
Í
->
tx_un™_busy
 = 0;

668 
	`Ãtif_wake_queue
(
dev
);

670 
num_tx_sšû_rx
++;

671 } ià(
num_tx_sšû_rx
 > 8 &&

672 
	`time_aá”
(
jiff›s
, 
dev
->
Ï¡_rx
 + 
HZ
)) {

673 ià(
Ãt_debug
 > 2)

674 
	`´štk
(
KERN_DEBUG
 "%s: Missed…acket? No Rx‡fter %d Tx‡nd "

675 "%ld jiff› ¡©u %02x CMR1 %02x.\n", 
dev
->
Çme
,

676 
num_tx_sšû_rx
, 
jiff›s
 - 
dev
->
Ï¡_rx
, 
¡©us
,

677 (
	`»ad_nibbË
(
ißddr
, 
CMR1
) >> 3) & 15);

678 
dev
->
¡©s
.
rx_mis£d_”rÜs
++;

679 
	`h¬dw¬e_š™
(
dev
);

680 
num_tx_sšû_rx
 = 0;

689 
i
;

690 
i
 = 0; i < 6; i++)

691 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
dev
->
dev_addr
[i]);

692 #ià0 && 
	`defšed
(
TIMED_CHECKER
)

693 
	`mod_tim”
(&
Í
->
tim”
, 
jiff›s
 + 
TIMED_CHECKER
);

698 
	`wr™e_»g
(
ißddr
, 
CMR2
, 
CMR2_IRQOUT
);

700 
	`outb
(
CŒl_S–D©a
 + 
CŒl_IRQEN
, 
ißddr
 + 
PAR_CONTROL
);

702 
	`wr™e_»g
(
ißddr
, 
IMR
, 
ISR_RxOK
 | 
ISR_TxE¼
 | 
ISR_TxOK
);

703 
	`wr™e_»g_high
(
ißddr
, 
IMR
, 
ISRh_RxE¼
);

705 
	`¥š_uÆock
(&
Í
->
lock
);

707 ià(
Ãt_debug
 > 5è
	`´štk
("exiting interrupt.\n");

708  
	`IRQ_RETVAL
(
hªdËd
);

709 
	}
}

711 #ifdeà
TIMED_CHECKER


714 
	$©p_timed_check”
(
d©a
)

716 
Ãt_deviû
 *
dev
 = (Ãt_deviû *)
d©a
;

717 
ißddr
 = 
dev
->
ba£_addr
;

718 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

719 
tickssoçr
 = 
jiff›s
 - 
Í
->
Ï¡_rx_time
;

720 
i
;

722 
	`¥š_lock
(&
Í
->
lock
);

723 ià(
tickssoçr
 > 2*
HZ
) {

725 
i
 = 0; i < 6; i++)

726 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
dev
->
dev_addr
[i]);

727 
Í
->
Ï¡_rx_time
 = 
jiff›s
;

729 
i
 = 0; i < 6; i++)

730 ià(
	`»ad_cmd_by‹
(
ißddr
, 
PAR0
 + 
i
è!ğ
©p_timed_dev
->
dev_addr
[i])

732 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
©p_timed_dev
);

733 
	`wr™e_»g_by‹
(
ißddr
, 
PAR0
 + 
i
, 
©p_timed_dev
->
dev_addr
[i]);

734 ià(
i
 == 2)

735 
dev
->
¡©s
.
tx_”rÜs
++;

736 ià(
i
 == 3)

737 
dev
->
¡©s
.
tx_drİ³d
++;

738 ià(
i
 == 4)

739 
dev
->
¡©s
.
cŞlisiÚs
++;

741 
dev
->
¡©s
.
rx_”rÜs
++;

745 
	`¥š_uÆock
(&
Í
->
lock
);

746 
Í
->
tim”
.
expœes
 = 
jiff›s
 + 
TIMED_CHECKER
;

747 
	`add_tim”
(&
Í
->
tim”
);

748 
	}
}

752 
	$Ãt_rx
(
Ãt_deviû
 *
dev
)

754 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

755 
ißddr
 = 
dev
->
ba£_addr
;

756 
rx_h—d”
 
rx_h—d
;

759 
	`outb
(
EOC
+
MAR
, 
ißddr
 + 
PAR_DATA
);

760 
	`»ad_block
(
ißddr
, 8, (*)&
rx_h—d
, 
dev
->
if_pÜt
);

761 ià(
Ãt_debug
 > 5)

762 
	`´štk
(
KERN_DEBUG
 "„x_couÁ %04x %04x %04x %04x..", 
rx_h—d
.
·d
,

763 
rx_h—d
.
rx_couÁ
,„x_h—d.
rx_¡©us
,„x_h—d.
cur_addr
);

764 ià((
rx_h—d
.
rx_¡©us
 & 0x77) != 0x01) {

765 
dev
->
¡©s
.
rx_”rÜs
++;

766 ià(
rx_h—d
.
rx_¡©us
 & 0x0004è
dev
->
¡©s
.
rx_äame_”rÜs
++;

767 ià(
rx_h—d
.
rx_¡©us
 & 0x0002è
dev
->
¡©s
.
rx_üc_”rÜs
++;

768 ià(
Ãt_debug
 > 3)

769 
	`´štk
(
KERN_DEBUG
 "%s: Unknown ATP Rxƒrror %04x.\n",

770 
dev
->
Çme
, 
rx_h—d
.
rx_¡©us
);

771 ià(
rx_h—d
.
rx_¡©us
 & 0x0020) {

772 
dev
->
¡©s
.
rx_fifo_”rÜs
++;

773 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_TxENABLE
);

774 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RxENABLE
 | 
CMR1h_TxENABLE
);

775 } ià(
rx_h—d
.
rx_¡©us
 & 0x0050)

776 
	`h¬dw¬e_š™
(
dev
);

780 
pkt_Ën
 = (
rx_h—d
.
rx_couÁ
 & 0x7ff) - 4;

781 
sk_buff
 *
skb
;

783 
skb
 = 
	`Ãtdev_®loc_skb
(
dev
, 
pkt_Ën
 + 2);

784 ià(
skb
 =ğ
NULL
) {

785 
dev
->
¡©s
.
rx_drİ³d
++;

786 
dÚe
;

789 
	`skb_»£rve
(
skb
, 2);

790 
	`»ad_block
(
ißddr
, 
pkt_Ën
, 
	`skb_put
(
skb
,pkt_Ën), 
dev
->
if_pÜt
);

791 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, 
dev
);

792 
	`Ãtif_rx
(
skb
);

793 
dev
->
Ï¡_rx
 = 
jiff›s
;

794 
dev
->
¡©s
.
rx_·ck‘s
++;

795 
dev
->
¡©s
.
rx_by‹s
 +ğ
pkt_Ën
;

797 
dÚe
:

798 
	`wr™e_»g
(
ißddr
, 
CMR1
, 
CMR1_NextPkt
);

799 
Í
->
Ï¡_rx_time
 = 
jiff›s
;

800 
	}
}

802 
	$»ad_block
(
ißddr
, 
Ëngth
, *
p
, 
d©a_mode
)

804 ià(
d©a_mode
 <= 3) {

805 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

806 
	`outb
(
Ëngth
 =ğ8 ? 
RdAddr
 | 
HNib
 | 
MAR
 : RdAddr | MAR,

807 
ißddr
 + 
PAR_DATA
);

808 ià(
d©a_mode
 <= 1) {

809 dØ{ *
p
++ = 
	`»ad_by‹_mode0
(
ißddr
); } --
Ëngth
 > 0);

811 dØ{ *
p
++ = 
	`»ad_by‹_mode2
(
ißddr
); } --
Ëngth
 > 0);

813 } ià(
d©a_mode
 <= 5) {

814 dØ{ *
p
++ = 
	`»ad_by‹_mode4
(
ißddr
); } --
Ëngth
 > 0);

816 dØ{ *
p
++ = 
	`»ad_by‹_mode6
(
ißddr
); } --
Ëngth
 > 0);

819 
	`outb
(
EOC
+
HNib
+
MAR
, 
ißddr
 + 
PAR_DATA
);

820 
	`outb
(
CŒl_S–D©a
, 
ißddr
 + 
PAR_CONTROL
);

821 
	}
}

825 
	$Ãt_şo£
(
Ãt_deviû
 *
dev
)

827 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

828 
ißddr
 = 
dev
->
ba£_addr
;

830 
	`Ãtif_¡İ_queue
(
dev
);

832 
	`d–_tim”_sync
(&
Í
->
tim”
);

835 
Í
->
addr_mode
 = 
CMR2h_OFF
;

836 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
CMR2h_OFF
);

839 
	`outb
(0x00, 
ißddr
 + 
PAR_CONTROL
);

840 
	`ä“_œq
(
dev
->
œq
, dev);

843 
	`wr™e_»g_high
(
ißddr
, 
CMR1
, 
CMR1h_RESET
 | 
CMR1h_MUX
);

845 
	}
}

851 
	$£t_rx_mode
(
Ãt_deviû
 *
dev
)

853 
Ãt_loÿl
 *
Í
 = 
	`Ãtdev_´iv
(
dev
);

854 
ißddr
 = 
dev
->
ba£_addr
;

856 ià(!
	`Ãtdev_mc_em±y
(
dev
è|| (dev->
æags
 & (
IFF_ALLMULTI
|
IFF_PROMISC
)))

857 
Í
->
addr_mode
 = 
CMR2h_PROMISC
;

859 
Í
->
addr_mode
 = 
CMR2h_NÜm®
;

860 
	`wr™e_»g_high
(
ißddr
, 
CMR2
, 
Í
->
addr_mode
);

861 
	}
}

863 
__š™
 
	$©p_š™_moduË
() {

864 ià(
debug
)

865 
	`´štk
(
KERN_INFO
 "%s", 
v”siÚ
);

866  
	`©p_š™
();

867 
	}
}

869 
__ex™
 
	$©p_ş—nup_moduË
() {

870 
Ãt_deviû
 *
Ãxt_dev
;

872 
roÙ_©p_dev
) {

873 
Ãt_loÿl
 *
©p_loÿl
 = 
	`Ãtdev_´iv
(
roÙ_©p_dev
);

874 
Ãxt_dev
 = 
©p_loÿl
->
Ãxt_moduË
;

875 
	`uÄegi¡”_Ãtdev
(
roÙ_©p_dev
);

877 
	`ä“_Ãtdev
(
roÙ_©p_dev
);

878 
roÙ_©p_dev
 = 
Ãxt_dev
;

880 
	}
}

882 
moduË_š™
(
©p_š™_moduË
);

883 
moduË_ex™
(
©p_ş—nup_moduË
);

	@atp.h

4 
	~<lšux/if_‘h”.h
>

5 
	~<lšux/ty³s.h
>

8 
	srx_h—d”
 {

9 
ushÜt
 
	m·d
;

10 
ushÜt
 
	mrx_couÁ
;

11 
ushÜt
 
	mrx_¡©us
;

12 
ushÜt
 
	mcur_addr
;

15 
	#PAR_DATA
 0

	)

16 
	#PAR_STATUS
 1

	)

17 
	#PAR_CONTROL
 2

	)

19 
	#CŒl_LNibR—d
 0x08

	)

20 
	#CŒl_HNibR—d
 0

	)

21 
	#CŒl_LNibWr™e
 0x08

	)

22 
	#CŒl_HNibWr™e
 0

	)

23 
	#CŒl_S–D©a
 0x04

	)

24 
	#CŒl_IRQEN
 0x10

	)

26 
	#EOW
 0xE0

	)

27 
	#EOC
 0xE0

	)

28 
	#WrAddr
 0x40

	)

29 
	#RdAddr
 0xC0

	)

30 
	#HNib
 0x10

	)

32 
	e·ge0_»gs
 {

36 
	mPAR0
 = 0, 
	mPAR1
 = 1, 
	mPAR2
 = 2, 
	mPAR3
 = 3, 
	mPAR4
 = 4, 
	mPAR5
 = 5,

37 
	mTxCNT0
 = 6, 
	mTxCNT1
 = 7,

38 
	mTxSTAT
 = 8, 
	mRxSTAT
 = 9,

39 
	mISR
 = 10, 
	mIMR
 = 11,

40 
	mCMR1
 = 12,

41 
	mCMR2
 = 13,

42 
	mMODSEL
 = 14,

43 
	mMAR
 = 14,

44 
	mCMR2_h
 = 0x1d,

47 
	e“·ge_»gs
 {

48 
	mPROM_CMD
 = 6,

49 
	mPROM_DATA
 = 7

52 
	#ISR_TxOK
 0x01

	)

53 
	#ISR_RxOK
 0x04

	)

54 
	#ISR_TxE¼
 0x02

	)

55 
	#ISRh_RxE¼
 0x11

	)

57 
	#CMR1h_MUX
 0x08

	)

58 
	#CMR1h_RESET
 0x04

	)

59 
	#CMR1h_RxENABLE
 0x02

	)

60 
	#CMR1h_TxENABLE
 0x01

	)

61 
	#CMR1h_TxRxOFF
 0x00

	)

62 
	#CMR1_ReXm™
 0x08

	)

63 
	#CMR1_Xm™
 0x04

	)

64 
	#CMR1_IRQ
 0x02

	)

65 
	#CMR1_BufEnb
 0x01

	)

66 
	#CMR1_NextPkt
 0x01

	)

68 
	#CMR2_NULL
 8

	)

69 
	#CMR2_IRQOUT
 9

	)

70 
	#CMR2_RAMTEST
 10

	)

71 
	#CMR2_EEPROM
 12

	)

73 
	#CMR2h_OFF
 0

	)

74 
	#CMR2h_Physiÿl
 1

	)

75 
	#CMR2h_NÜm®
 2

	)

76 
	#CMR2h_PROMISC
 3

	)

81 
šlše
 
	$šby‹
(
pÜt
)

83 
_v
;

85 
__asm__
 
	`__vŞ©e__
 ("šb %w1,%b0" : "÷" (
_v
è: "d" (
pÜt
));

86  
_v
;

87 
	}
}

92 
šlše
 
	$»ad_nibbË
(
pÜt
, 
off£t
)

94 
»tv®
;

96 
	`outb
(
EOC
+
off£t
, 
pÜt
 + 
PAR_DATA
);

97 
	`outb
(
RdAddr
+
off£t
, 
pÜt
 + 
PAR_DATA
);

98 
	`šby‹
(
pÜt
 + 
PAR_STATUS
);

99 
»tv®
 = 
	`šby‹
(
pÜt
 + 
PAR_STATUS
);

100 
	`outb
(
EOC
+
off£t
, 
pÜt
 + 
PAR_DATA
);

102  
»tv®
;

103 
	}
}

107 
šlše
 
	$»ad_by‹_mode0
(
ißddr
)

109 
low_nib
;

111 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

112 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

113 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

114 
	`outb
(
CŒl_HNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

115 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

116 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

117  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

118 
	}
}

121 
šlše
 
	$»ad_by‹_mode2
(
ißddr
)

123 
low_nib
;

125 
	`outb
(
CŒl_LNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

126 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

127 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

128 
	`outb
(
CŒl_HNibR—d
, 
ißddr
 + 
PAR_CONTROL
);

129 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

130  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

131 
	}
}

134 
šlše
 
	$»ad_by‹_mode4
(
ißddr
)

136 
low_nib
;

138 
	`outb
(
RdAddr
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

139 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

140 
	`outb
(
RdAddr
 | 
HNib
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

141  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

142 
	}
}

145 
šlše
 
	$»ad_by‹_mode6
(
ißddr
)

147 
low_nib
;

149 
	`outb
(
RdAddr
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

150 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

151 
low_nib
 = (
	`šby‹
(
ißddr
 + 
PAR_STATUS
) >> 3) & 0x0f;

152 
	`outb
(
RdAddr
 | 
HNib
 | 
MAR
, 
ißddr
 + 
PAR_DATA
);

153 
	`šby‹
(
ißddr
 + 
PAR_STATUS
);

154  
low_nib
 | ((
	`šby‹
(
ißddr
 + 
PAR_STATUS
) << 1) & 0xf0);

155 
	}
}

157 
šlše
 

158 
	$wr™e_»g
(
pÜt
, 
»g
, 
v®ue
)

160 
outv®
;

162 
	`outb
(
EOC
 | 
»g
, 
pÜt
 + 
PAR_DATA
);

163 
outv®
 = 
WrAddr
 | 
»g
;

164 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

165 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

167 
outv®
 &= 0xf0;

168 
outv®
 |ğ
v®ue
;

169 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

170 
outv®
 &= 0x1f;

171 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

172 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

174 
	`outb
(
EOC
 | 
outv®
, 
pÜt
 + 
PAR_DATA
);

175 
	}
}

177 
šlše
 

178 
	$wr™e_»g_high
(
pÜt
, 
»g
, 
v®ue
)

180 
outv®
 = 
EOC
 | 
HNib
 | 
»g
;

182 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

183 
outv®
 &ğ
WrAddr
 | 
HNib
 | 0x0f;

184 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

185 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

187 
outv®
 = 
WrAddr
 | 
HNib
 | 
v®ue
;

188 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

189 
outv®
 &ğ
HNib
 | 0x0f;

190 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

191 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

193 
	`outb
(
EOC
 | 
HNib
 | 
outv®
, 
pÜt
 + 
PAR_DATA
);

194 
	}
}

197 
šlše
 

198 
	$wr™e_»g_by‹
(
pÜt
, 
»g
, 
v®ue
)

200 
outv®
;

202 
	`outb
(
EOC
 | 
»g
, 
pÜt
 + 
PAR_DATA
);

203 
outv®
 = 
WrAddr
 | 
»g
;

204 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

205 
	`outb
(
outv®
, 
pÜt
 + 
PAR_DATA
);

207 
	`outb
((
outv®
 & 0xf0è| (
v®ue
 & 0x0f), 
pÜt
 + 
PAR_DATA
);

208 
	`outb
(
v®ue
 & 0x0f, 
pÜt
 + 
PAR_DATA
);

209 
v®ue
 >>= 4;

210 
	`outb
(
v®ue
, 
pÜt
 + 
PAR_DATA
);

211 
	`outb
(0x10 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

212 
	`outb
(0x10 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

214 
	`outb
(
EOC
 | 
v®ue
, 
pÜt
 + 
PAR_DATA
);

215 
	}
}

223 
šlše
 
	$wr™e_by‹_mode0
(
ißddr
, 
v®ue
)

225 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

226 
	`outb
((
v®ue
>>4è| 0x10, 
ißddr
 + 
PAR_DATA
);

227 
	}
}

229 
šlše
 
	$wr™e_by‹_mode1
(
ißddr
, 
v®ue
)

231 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

232 
	`outb
(
CŒl_IRQEN
 | 
CŒl_LNibWr™e
, 
ißddr
 + 
PAR_CONTROL
);

233 
	`outb
((
v®ue
>>4è| 0x10, 
ißddr
 + 
PAR_DATA
);

234 
	`outb
(
CŒl_IRQEN
 | 
CŒl_HNibWr™e
, 
ißddr
 + 
PAR_CONTROL
);

235 
	}
}

238 
šlše
 
	$wr™e_wÜd_mode0
(
ißddr
, 
v®ue
)

240 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

241 
v®ue
 >>= 4;

242 
	`outb
((
v®ue
 & 0x0fè| 0x10, 
ißddr
 + 
PAR_DATA
);

243 
v®ue
 >>= 4;

244 
	`outb
(
v®ue
 & 0x0f, 
ißddr
 + 
PAR_DATA
);

245 
v®ue
 >>= 4;

246 
	`outb
((
v®ue
 & 0x0fè| 0x10, 
ißddr
 + 
PAR_DATA
);

247 
	}
}

250 
	#EE_SHIFT_CLK
 0x04

	)

251 
	#EE_CS
 0x02

	)

252 
	#EE_CLK_HIGH
 0x12

	)

253 
	#EE_CLK_LOW
 0x16

	)

254 
	#EE_DATA_WRITE
 0x01

	)

255 
	#EE_DATA_READ
 0x08

	)

258 
	#“´om_d–ay
(
ticks
) \

259 dØ{ 
_i
 = 40; --_˜> 0è{ 
__SLOW_DOWN_IO
; } } 0)

	)

262 
	#EE_WRITE_CMD
(
off£t
è(((5 << 6è+ (off£t)è<< 17)

	)

263 
	#EE_READ
(
off£t
è(((6 << 6è+ (off£t)è<< 17)

	)

264 
	#EE_ERASE
(
off£t
è(((7 << 6è+ (off£t)è<< 17)

	)

265 
	#EE_CMD_SIZE
 27

	)

	@r8169-old.c

11 
	~<lšux/moduË.h
>

12 
	~<lšux/moduË·¿m.h
>

13 
	~<lšux/pci.h
>

14 
	~<lšux/Ãtdeviû.h
>

15 
	~<lšux/‘h”deviû.h
>

16 
	~<lšux/d–ay.h
>

17 
	~<lšux/‘htoŞ.h
>

18 
	~<lšux/mii.h
>

19 
	~<lšux/if_vÏn.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/š.h
>

22 
	~<lšux/.h
>

23 
	~<lšux/tı.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/dma-m­pšg.h
>

26 
	~<lšux/pm_ruÁime.h
>

27 
	~<lšux/fœmw¬e.h
>

28 
	~<lšux/pci-a¥m.h
>

29 
	~<lšux/´eãtch.h
>

30 
	~<lšux/v6.h
>

31 
	~<Ãt/6_checksum.h
>

33 
	~<asm/io.h
>

34 
	~<asm/œq.h
>

36 
	#RTL8169_VERSION
 "2.3LK-NAPI"

	)

37 
	#MODULENAME
 "r8169"

	)

38 
	#PFX
 
MODULENAME
 ": "

	)

40 
	#FIRMWARE_8168D_1
 "¹l_nic/¹l8168d-1.fw"

	)

41 
	#FIRMWARE_8168D_2
 "¹l_nic/¹l8168d-2.fw"

	)

42 
	#FIRMWARE_8168E_1
 "¹l_nic/¹l8168e-1.fw"

	)

43 
	#FIRMWARE_8168E_2
 "¹l_nic/¹l8168e-2.fw"

	)

44 
	#FIRMWARE_8168E_3
 "¹l_nic/¹l8168e-3.fw"

	)

45 
	#FIRMWARE_8168F_1
 "¹l_nic/¹l8168f-1.fw"

	)

46 
	#FIRMWARE_8168F_2
 "¹l_nic/¹l8168f-2.fw"

	)

47 
	#FIRMWARE_8105E_1
 "¹l_nic/¹l8105e-1.fw"

	)

48 
	#FIRMWARE_8402_1
 "¹l_nic/¹l8402-1.fw"

	)

49 
	#FIRMWARE_8411_1
 "¹l_nic/¹l8411-1.fw"

	)

50 
	#FIRMWARE_8411_2
 "¹l_nic/¹l8411-2.fw"

	)

51 
	#FIRMWARE_8106E_1
 "¹l_nic/¹l8106e-1.fw"

	)

52 
	#FIRMWARE_8106E_2
 "¹l_nic/¹l8106e-2.fw"

	)

53 
	#FIRMWARE_8168G_2
 "¹l_nic/¹l8168g-2.fw"

	)

54 
	#FIRMWARE_8168G_3
 "¹l_nic/¹l8168g-3.fw"

	)

55 
	#FIRMWARE_8168H_1
 "¹l_nic/¹l8168h-1.fw"

	)

56 
	#FIRMWARE_8168H_2
 "¹l_nic/¹l8168h-2.fw"

	)

57 
	#FIRMWARE_8107E_1
 "¹l_nic/¹l8107e-1.fw"

	)

58 
	#FIRMWARE_8107E_2
 "¹l_nic/¹l8107e-2.fw"

	)

60 #ifdeà
RTL8169_DEBUG


61 
	#as£¹
(
ex´
) \

62 ià(!(
ex´
)) { \

63 
	`´štk
( "Assertion failed! %s,%s,%s,line=%d\n", \

64 #ex´,
__FILE__
,
__func__
,
__LINE__
); \

65 }

	)

66 
	#d´štk
(
fmt
, 
¬gs
...) \

67 dØ{ 
	`´štk
(
KERN_DEBUG
 
PFX
 
fmt
, ## 
¬gs
); } 0)

	)

69 
	#as£¹
(
ex´
èdØ{} 0)

	)

70 
	#d´štk
(
fmt
, 
¬gs
...èdØ{} 0)

	)

73 
	#R8169_MSG_DEFAULT
 \

74 (
NETIF_MSG_DRV
 | 
NETIF_MSG_PROBE
 | 
NETIF_MSG_IFUP
 | 
NETIF_MSG_IFDOWN
)

	)

76 
	#TX_SLOTS_AVAIL
(

) \

77 (

->
dœty_tx
 + 
NUM_TX_DESC
 -p->
cur_tx
)

	)

80 
	#TX_FRAGS_READY_FOR
(

,
Ä_äags
) \

81 (
	`TX_SLOTS_AVAIL
(

è>ğ(
Ä_äags
 + 1))

	)

85 cÚ¡ 
	gmuÉiÿ¡_f‹r_lim™
 = 32;

87 
	#MAX_READ_REQUEST_SHIFT
 12

	)

88 
	#TX_DMA_BURST
 7

	)

89 
	#IÁ”F¿meG­
 0x03

	)

91 
	#R8169_REGS_SIZE
 256

	)

92 
	#R8169_NAPI_WEIGHT
 64

	)

93 
	#NUM_TX_DESC
 64

	)

94 
	#NUM_RX_DESC
 256U

	)

95 
	#R8169_TX_RING_BYTES
 (
NUM_TX_DESC
 * (
TxDesc
))

	)

96 
	#R8169_RX_RING_BYTES
 (
NUM_RX_DESC
 * (
RxDesc
))

	)

98 
	#RTL8169_TX_TIMEOUT
 (6*
HZ
)

	)

99 
	#RTL8169_PHY_TIMEOUT
 (10*
HZ
)

	)

102 
	#RTL_W8
(

, 
»g
, 
v®8
è
	`wr™eb
((v®8),p->
mmio_addr
 + (»g))

	)

103 
	#RTL_W16
(

, 
»g
, 
v®16
è
	`wr™ew
((v®16),p->
mmio_addr
 + (»g))

	)

104 
	#RTL_W32
(

, 
»g
, 
v®32
è
	`wr™–
((v®32),p->
mmio_addr
 + (»g))

	)

105 
	#RTL_R8
(

, 
»g
è
	`»adb
Ñp->
mmio_addr
 + (»g))

	)

106 
	#RTL_R16
(

, 
»g
è
	`»adw
Ñp->
mmio_addr
 + (»g))

	)

107 
	#RTL_R32
(

, 
»g
è
	`»adl
Ñp->
mmio_addr
 + (»g))

	)

109 
	emac_v”siÚ
 {

110 
	mRTL_GIGA_MAC_VER_01
 = 0,

111 
	mRTL_GIGA_MAC_VER_02
,

112 
	mRTL_GIGA_MAC_VER_03
,

113 
	mRTL_GIGA_MAC_VER_04
,

114 
	mRTL_GIGA_MAC_VER_05
,

115 
	mRTL_GIGA_MAC_VER_06
,

116 
	mRTL_GIGA_MAC_VER_07
,

117 
	mRTL_GIGA_MAC_VER_08
,

118 
	mRTL_GIGA_MAC_VER_09
,

119 
	mRTL_GIGA_MAC_VER_10
,

120 
	mRTL_GIGA_MAC_VER_11
,

121 
	mRTL_GIGA_MAC_VER_12
,

122 
	mRTL_GIGA_MAC_VER_13
,

123 
	mRTL_GIGA_MAC_VER_14
,

124 
	mRTL_GIGA_MAC_VER_15
,

125 
	mRTL_GIGA_MAC_VER_16
,

126 
	mRTL_GIGA_MAC_VER_17
,

127 
	mRTL_GIGA_MAC_VER_18
,

128 
	mRTL_GIGA_MAC_VER_19
,

129 
	mRTL_GIGA_MAC_VER_20
,

130 
	mRTL_GIGA_MAC_VER_21
,

131 
	mRTL_GIGA_MAC_VER_22
,

132 
	mRTL_GIGA_MAC_VER_23
,

133 
	mRTL_GIGA_MAC_VER_24
,

134 
	mRTL_GIGA_MAC_VER_25
,

135 
	mRTL_GIGA_MAC_VER_26
,

136 
	mRTL_GIGA_MAC_VER_27
,

137 
	mRTL_GIGA_MAC_VER_28
,

138 
	mRTL_GIGA_MAC_VER_29
,

139 
	mRTL_GIGA_MAC_VER_30
,

140 
	mRTL_GIGA_MAC_VER_31
,

141 
	mRTL_GIGA_MAC_VER_32
,

142 
	mRTL_GIGA_MAC_VER_33
,

143 
	mRTL_GIGA_MAC_VER_34
,

144 
	mRTL_GIGA_MAC_VER_35
,

145 
	mRTL_GIGA_MAC_VER_36
,

146 
	mRTL_GIGA_MAC_VER_37
,

147 
	mRTL_GIGA_MAC_VER_38
,

148 
	mRTL_GIGA_MAC_VER_39
,

149 
	mRTL_GIGA_MAC_VER_40
,

150 
	mRTL_GIGA_MAC_VER_41
,

151 
	mRTL_GIGA_MAC_VER_42
,

152 
	mRTL_GIGA_MAC_VER_43
,

153 
	mRTL_GIGA_MAC_VER_44
,

154 
	mRTL_GIGA_MAC_VER_45
,

155 
	mRTL_GIGA_MAC_VER_46
,

156 
	mRTL_GIGA_MAC_VER_47
,

157 
	mRTL_GIGA_MAC_VER_48
,

158 
	mRTL_GIGA_MAC_VER_49
,

159 
	mRTL_GIGA_MAC_VER_50
,

160 
	mRTL_GIGA_MAC_VER_51
,

161 
	mRTL_GIGA_MAC_NONE
 = 0xff,

164 
	e¹l_tx_desc_v”siÚ
 {

165 
	mRTL_TD_0
 = 0,

166 
	mRTL_TD_1
 = 1,

169 
	#JUMBO_1K
 
ETH_DATA_LEN


	)

170 
	#JUMBO_4K
 (4*1024 - 
ETH_HLEN
 - 2)

	)

171 
	#JUMBO_6K
 (6*1024 - 
ETH_HLEN
 - 2)

	)

172 
	#JUMBO_7K
 (7*1024 - 
ETH_HLEN
 - 2)

	)

173 
	#JUMBO_9K
 (9*1024 - 
ETH_HLEN
 - 2)

	)

175 
	#_R
(
NAME
,
TD
,
FW
,
SZ
,
B
) { \

176 .
Çme
 = 
NAME
, \

177 .
txd_v”siÚ
 = 
TD
, \

178 .
fw_Çme
 = 
FW
, \

179 .
jumbo_max
 = 
SZ
, \

180 .
jumbo_tx_csum
 = 
B
 \

181 }

	)

184 cÚ¡ *
	mÇme
;

185 
¹l_tx_desc_v”siÚ
 
	mtxd_v”siÚ
;

186 cÚ¡ *
	mfw_Çme
;

187 
u16
 
	mjumbo_max
;

188 
boŞ
 
	mjumbo_tx_csum
;

189 } 
	g¹l_ch_šfos
[] = {

191 [
RTL_GIGA_MAC_VER_01
] =

192 
_R
("RTL8169", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

193 [
RTL_GIGA_MAC_VER_02
] =

194 
_R
("RTL8169s", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

195 [
RTL_GIGA_MAC_VER_03
] =

196 
_R
("RTL8110s", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

197 [
RTL_GIGA_MAC_VER_04
] =

198 
_R
("RTL8169sb/8110sb", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

199 [
RTL_GIGA_MAC_VER_05
] =

200 
_R
("RTL8169sc/8110sc", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

201 [
RTL_GIGA_MAC_VER_06
] =

202 
_R
("RTL8169sc/8110sc", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

204 [
RTL_GIGA_MAC_VER_07
] =

205 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

206 [
RTL_GIGA_MAC_VER_08
] =

207 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

208 [
RTL_GIGA_MAC_VER_09
] =

209 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

210 [
RTL_GIGA_MAC_VER_10
] =

211 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

212 [
RTL_GIGA_MAC_VER_11
] =

213 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

214 [
RTL_GIGA_MAC_VER_12
] =

215 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

216 [
RTL_GIGA_MAC_VER_13
] =

217 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

218 [
RTL_GIGA_MAC_VER_14
] =

219 
_R
("RTL8100e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

220 [
RTL_GIGA_MAC_VER_15
] =

221 
_R
("RTL8100e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

222 [
RTL_GIGA_MAC_VER_16
] =

223 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

224 [
RTL_GIGA_MAC_VER_17
] =

225 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

226 [
RTL_GIGA_MAC_VER_18
] =

227 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

228 [
RTL_GIGA_MAC_VER_19
] =

229 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

230 [
RTL_GIGA_MAC_VER_20
] =

231 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

232 [
RTL_GIGA_MAC_VER_21
] =

233 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

234 [
RTL_GIGA_MAC_VER_22
] =

235 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

236 [
RTL_GIGA_MAC_VER_23
] =

237 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

238 [
RTL_GIGA_MAC_VER_24
] =

239 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

240 [
RTL_GIGA_MAC_VER_25
] =

241 
_R
("RTL8168d/8111d", 
RTL_TD_1
, 
FIRMWARE_8168D_1
,

242 
JUMBO_9K
, 
çl£
),

243 [
RTL_GIGA_MAC_VER_26
] =

244 
_R
("RTL8168d/8111d", 
RTL_TD_1
, 
FIRMWARE_8168D_2
,

245 
JUMBO_9K
, 
çl£
),

246 [
RTL_GIGA_MAC_VER_27
] =

247 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

248 [
RTL_GIGA_MAC_VER_28
] =

249 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

250 [
RTL_GIGA_MAC_VER_29
] =

251 
_R
("RTL8105e", 
RTL_TD_1
, 
FIRMWARE_8105E_1
,

252 
JUMBO_1K
, 
Œue
),

253 [
RTL_GIGA_MAC_VER_30
] =

254 
_R
("RTL8105e", 
RTL_TD_1
, 
FIRMWARE_8105E_1
,

255 
JUMBO_1K
, 
Œue
),

256 [
RTL_GIGA_MAC_VER_31
] =

257 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

258 [
RTL_GIGA_MAC_VER_32
] =

259 
_R
("RTL8168e/8111e", 
RTL_TD_1
, 
FIRMWARE_8168E_1
,

260 
JUMBO_9K
, 
çl£
),

261 [
RTL_GIGA_MAC_VER_33
] =

262 
_R
("RTL8168e/8111e", 
RTL_TD_1
, 
FIRMWARE_8168E_2
,

263 
JUMBO_9K
, 
çl£
),

264 [
RTL_GIGA_MAC_VER_34
] =

265 
_R
("RTL8168evl/8111evl",
RTL_TD_1
, 
FIRMWARE_8168E_3
,

266 
JUMBO_9K
, 
çl£
),

267 [
RTL_GIGA_MAC_VER_35
] =

268 
_R
("RTL8168f/8111f", 
RTL_TD_1
, 
FIRMWARE_8168F_1
,

269 
JUMBO_9K
, 
çl£
),

270 [
RTL_GIGA_MAC_VER_36
] =

271 
_R
("RTL8168f/8111f", 
RTL_TD_1
, 
FIRMWARE_8168F_2
,

272 
JUMBO_9K
, 
çl£
),

273 [
RTL_GIGA_MAC_VER_37
] =

274 
_R
("RTL8402", 
RTL_TD_1
, 
FIRMWARE_8402_1
,

275 
JUMBO_1K
, 
Œue
),

276 [
RTL_GIGA_MAC_VER_38
] =

277 
_R
("RTL8411", 
RTL_TD_1
, 
FIRMWARE_8411_1
,

278 
JUMBO_9K
, 
çl£
),

279 [
RTL_GIGA_MAC_VER_39
] =

280 
_R
("RTL8106e", 
RTL_TD_1
, 
FIRMWARE_8106E_1
,

281 
JUMBO_1K
, 
Œue
),

282 [
RTL_GIGA_MAC_VER_40
] =

283 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
FIRMWARE_8168G_2
,

284 
JUMBO_9K
, 
çl£
),

285 [
RTL_GIGA_MAC_VER_41
] =

286 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

287 [
RTL_GIGA_MAC_VER_42
] =

288 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
FIRMWARE_8168G_3
,

289 
JUMBO_9K
, 
çl£
),

290 [
RTL_GIGA_MAC_VER_43
] =

291 
_R
("RTL8106e", 
RTL_TD_1
, 
FIRMWARE_8106E_2
,

292 
JUMBO_1K
, 
Œue
),

293 [
RTL_GIGA_MAC_VER_44
] =

294 
_R
("RTL8411", 
RTL_TD_1
, 
FIRMWARE_8411_2
,

295 
JUMBO_9K
, 
çl£
),

296 [
RTL_GIGA_MAC_VER_45
] =

297 
_R
("RTL8168h/8111h", 
RTL_TD_1
, 
FIRMWARE_8168H_1
,

298 
JUMBO_9K
, 
çl£
),

299 [
RTL_GIGA_MAC_VER_46
] =

300 
_R
("RTL8168h/8111h", 
RTL_TD_1
, 
FIRMWARE_8168H_2
,

301 
JUMBO_9K
, 
çl£
),

302 [
RTL_GIGA_MAC_VER_47
] =

303 
_R
("RTL8107e", 
RTL_TD_1
, 
FIRMWARE_8107E_1
,

304 
JUMBO_1K
, 
çl£
),

305 [
RTL_GIGA_MAC_VER_48
] =

306 
_R
("RTL8107e", 
RTL_TD_1
, 
FIRMWARE_8107E_2
,

307 
JUMBO_1K
, 
çl£
),

308 [
RTL_GIGA_MAC_VER_49
] =

309 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

310 
JUMBO_9K
, 
çl£
),

311 [
RTL_GIGA_MAC_VER_50
] =

312 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

313 
JUMBO_9K
, 
çl£
),

314 [
RTL_GIGA_MAC_VER_51
] =

315 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

316 
JUMBO_9K
, 
çl£
),

318 #undeà
_R


320 
	ecfg_v”siÚ
 {

321 
	mRTL_CFG_0
 = 0x00,

322 
	mRTL_CFG_1
,

323 
	mRTL_CFG_2


326 cÚ¡ 
pci_deviû_id
 
	g¹l8169_pci_tbl
[] = {

327 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8129), 0, 0, 
RTL_CFG_0
 },

328 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8136), 0, 0, 
RTL_CFG_2
 },

329 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8161), 0, 0, 
RTL_CFG_1
 },

330 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8167), 0, 0, 
RTL_CFG_0
 },

331 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8168), 0, 0, 
RTL_CFG_1
 },

332 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8169), 0, 0, 
RTL_CFG_0
 },

333 { 
PCI_VENDOR_ID_DLINK
, 0x4300,

334 
PCI_VENDOR_ID_DLINK
, 0x4b10, 0, 0, 
RTL_CFG_1
 },

335 { 
PCI_DEVICE
(
PCI_VENDOR_ID_DLINK
, 0x4300), 0, 0, 
RTL_CFG_0
 },

336 { 
PCI_DEVICE
(
PCI_VENDOR_ID_DLINK
, 0x4302), 0, 0, 
RTL_CFG_0
 },

337 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AT
, 0xc107), 0, 0, 
RTL_CFG_0
 },

338 { 
PCI_DEVICE
(0x16ec, 0x0116), 0, 0, 
RTL_CFG_0
 },

339 { 
PCI_VENDOR_ID_LINKSYS
, 0x1032,

340 
PCI_ANY_ID
, 0x0024, 0, 0, 
RTL_CFG_0
 },

342 
PCI_ANY_ID
, 0x2410, 0, 0, 
RTL_CFG_2
 },

346 
MODULE_DEVICE_TABLE
(
pci
, 
¹l8169_pci_tbl
);

348 
	grx_buf_sz
 = 16383;

349 
	gu£_dac
 = -1;

351 
u32
 
	mmsg_’abË
;

352 } 
	gdebug
 = { -1 };

354 
	e¹l_»gi¡”s
 {

355 
	mMAC0
 = 0,

356 
	mMAC4
 = 4,

357 
	mMAR0
 = 8,

358 
	mCouÁ”AddrLow
 = 0x10,

359 
	mCouÁ”AddrHigh
 = 0x14,

360 
	mTxDescS¹AddrLow
 = 0x20,

361 
	mTxDescS¹AddrHigh
 = 0x24,

362 
	mTxHDescS¹AddrLow
 = 0x28,

363 
	mTxHDescS¹AddrHigh
 = 0x2c,

364 
	mFLASH
 = 0x30,

365 
	mERSR
 = 0x36,

366 
	mChCmd
 = 0x37,

367 
	mTxPŞl
 = 0x38,

368 
	mIÁrMask
 = 0x3c,

369 
	mIÁrStus
 = 0x3e,

371 
	mTxCÚfig
 = 0x40,

372 
	#TXCFG_AUTO_FIFO
 (1 << 7è

	)

373 
	#TXCFG_EMPTY
 (1 << 11è

	)

375 
	mRxCÚfig
 = 0x44,

376 
	#RX128_INT_EN
 (1 << 15è

	)

377 
	#RX_MULTI_EN
 (1 << 14è

	)

378 
	#RXCFG_FIFO_SHIFT
 13

	)

380 
	#RX_FIFO_THRESH
 (7 << 
RXCFG_FIFO_SHIFT
)

	)

381 
	#RX_EARLY_OFF
 (1 << 11)

	)

382 
	#RXCFG_DMA_SHIFT
 8

	)

384 
	#RX_DMA_BURST
 (7 << 
RXCFG_DMA_SHIFT
)

	)

386 
	mRxMis£d
 = 0x4c,

387 
	mCfg9346
 = 0x50,

388 
	mCÚfig0
 = 0x51,

389 
	mCÚfig1
 = 0x52,

390 
	mCÚfig2
 = 0x53,

391 
	#PME_SIGNAL
 (1 << 5è

	)

393 
	mCÚfig3
 = 0x54,

394 
	mCÚfig4
 = 0x55,

395 
	mCÚfig5
 = 0x56,

396 
	mMuÉiIÁr
 = 0x5c,

397 
	mPHYAR
 = 0x60,

398 
	mPHY¡©us
 = 0x6c,

399 
	mRxMaxSize
 = 0xda,

400 
	mCPlusCmd
 = 0xe0,

401 
	mIÁrM™ig©e
 = 0xe2,

403 
	#RTL_COALESCE_MASK
 0x0f

	)

404 
	#RTL_COALESCE_SHIFT
 4

	)

405 
	#RTL_COALESCE_T_MAX
 (
RTL_COALESCE_MASK
)

	)

406 
	#RTL_COALESCE_FRAME_MAX
 (
RTL_COALESCE_MASK
 << 2)

	)

408 
	mRxDescAddrLow
 = 0xe4,

409 
	mRxDescAddrHigh
 = 0xe8,

410 
	mE¬lyTxTh»s
 = 0xec,

412 
	#NoE¬lyTx
 0x3à

	)

414 
	mMaxTxPack‘Size
 = 0xec,

416 
	#TxPack‘Max
 (8064 >> 7)

	)

417 
	#E¬lySize
 0x27

	)

419 
	mFuncEv’t
 = 0xf0,

420 
	mFuncEv’tMask
 = 0xf4,

421 
	mFuncP»£tS‹
 = 0xf8,

422 
	mIBCR0
 = 0xf8,

423 
	mIBCR2
 = 0xf9,

424 
	mIBIMR0
 = 0xfa,

425 
	mIBISR0
 = 0xfb,

426 
	mFuncFÜûEv’t
 = 0xfc,

429 
	e¹l8110_»gi¡”s
 {

430 
	mTBICSR
 = 0x64,

431 
	mTBI_ANAR
 = 0x68,

432 
	mTBI_LPAR
 = 0x6a,

435 
	e¹l8168_8101_»gi¡”s
 {

436 
	mCSIDR
 = 0x64,

437 
	mCSIAR
 = 0x68,

438 
	#CSIAR_FLAG
 0x80000000

	)

439 
	#CSIAR_WRITE_CMD
 0x80000000

	)

440 
	#CSIAR_BYTE_ENABLE
 0x0f

	)

441 
	#CSIAR_BYTE_ENABLE_SHIFT
 12

	)

442 
	#CSIAR_ADDR_MASK
 0x0fff

	)

443 
	#CSIAR_FUNC_CARD
 0x00000000

	)

444 
	#CSIAR_FUNC_SDIO
 0x00010000

	)

445 
	#CSIAR_FUNC_NIC
 0x00020000

	)

446 
	#CSIAR_FUNC_NIC2
 0x00010000

	)

447 
	mPMCH
 = 0x6f,

448 
	mEPHYAR
 = 0x80,

449 
	#EPHYAR_FLAG
 0x80000000

	)

450 
	#EPHYAR_WRITE_CMD
 0x80000000

	)

451 
	#EPHYAR_REG_MASK
 0x1f

	)

452 
	#EPHYAR_REG_SHIFT
 16

	)

453 
	#EPHYAR_DATA_MASK
 0xffff

	)

454 
	mDLLPR
 = 0xd0,

455 
	#PFM_EN
 (1 << 6)

	)

456 
	#TX_10M_PS_EN
 (1 << 7)

	)

457 
	mDBG_REG
 = 0xd1,

458 
	#FIX_NAK_1
 (1 << 4)

	)

459 
	#FIX_NAK_2
 (1 << 3)

	)

460 
	mTWSI
 = 0xd2,

461 
	mMCU
 = 0xd3,

462 
	#NOW_IS_OOB
 (1 << 7)

	)

463 
	#TX_EMPTY
 (1 << 5)

	)

464 
	#RX_EMPTY
 (1 << 4)

	)

465 
	#RXTX_EMPTY
 (
TX_EMPTY
 | 
RX_EMPTY
)

	)

466 
	#EN_NDP
 (1 << 3)

	)

467 
	#EN_OOB_RESET
 (1 << 2)

	)

468 
	#LINK_LIST_RDY
 (1 << 1)

	)

469 
	mEFUSEAR
 = 0xdc,

470 
	#EFUSEAR_FLAG
 0x80000000

	)

471 
	#EFUSEAR_WRITE_CMD
 0x80000000

	)

472 
	#EFUSEAR_READ_CMD
 0x00000000

	)

473 
	#EFUSEAR_REG_MASK
 0x03ff

	)

474 
	#EFUSEAR_REG_SHIFT
 8

	)

475 
	#EFUSEAR_DATA_MASK
 0xff

	)

476 
	mMISC_1
 = 0xf2,

477 
	#PFM_D3COLD_EN
 (1 << 6)

	)

480 
	e¹l8168_»gi¡”s
 {

481 
	mLED_FREQ
 = 0x1a,

482 
	mEEE_LED
 = 0x1b,

483 
	mERIDR
 = 0x70,

484 
	mERIAR
 = 0x74,

485 
	#ERIAR_FLAG
 0x80000000

	)

486 
	#ERIAR_WRITE_CMD
 0x80000000

	)

487 
	#ERIAR_READ_CMD
 0x00000000

	)

488 
	#ERIAR_ADDR_BYTE_ALIGN
 4

	)

489 
	#ERIAR_TYPE_SHIFT
 16

	)

490 
	#ERIAR_EXGMAC
 (0x00 << 
ERIAR_TYPE_SHIFT
)

	)

491 
	#ERIAR_MSIX
 (0x01 << 
ERIAR_TYPE_SHIFT
)

	)

492 
	#ERIAR_ASF
 (0x02 << 
ERIAR_TYPE_SHIFT
)

	)

493 
	#ERIAR_OOB
 (0x02 << 
ERIAR_TYPE_SHIFT
)

	)

494 
	#ERIAR_MASK_SHIFT
 12

	)

495 
	#ERIAR_MASK_0001
 (0x1 << 
ERIAR_MASK_SHIFT
)

	)

496 
	#ERIAR_MASK_0011
 (0x3 << 
ERIAR_MASK_SHIFT
)

	)

497 
	#ERIAR_MASK_0100
 (0x4 << 
ERIAR_MASK_SHIFT
)

	)

498 
	#ERIAR_MASK_0101
 (0x5 << 
ERIAR_MASK_SHIFT
)

	)

499 
	#ERIAR_MASK_1111
 (0xà<< 
ERIAR_MASK_SHIFT
)

	)

500 
	mEPHY_RXER_NUM
 = 0x7c,

501 
	mOCPDR
 = 0xb0,

502 
	#OCPDR_WRITE_CMD
 0x80000000

	)

503 
	#OCPDR_READ_CMD
 0x00000000

	)

504 
	#OCPDR_REG_MASK
 0x7f

	)

505 
	#OCPDR_GPHY_REG_SHIFT
 16

	)

506 
	#OCPDR_DATA_MASK
 0xffff

	)

507 
	mOCPAR
 = 0xb4,

508 
	#OCPAR_FLAG
 0x80000000

	)

509 
	#OCPAR_GPHY_WRITE_CMD
 0x8000f060

	)

510 
	#OCPAR_GPHY_READ_CMD
 0x0000f060

	)

511 
	mGPHY_OCP
 = 0xb8,

512 
	mRDSAR1
 = 0xd0,

513 
	mMISC
 = 0xf0,

514 
	#TXPLA_RST
 (1 << 29)

	)

515 
	#DISABLE_LAN_EN
 (1 << 23è

	)

516 
	#PWM_EN
 (1 << 22)

	)

517 
	#RXDV_GATED_EN
 (1 << 19)

	)

518 
	#EARLY_TALLY_EN
 (1 << 16)

	)

521 
	e¹l_»gi¡”_cÚ‹Á
 {

523 
	mSYSE¼
 = 0x8000,

524 
	mPCSTimeout
 = 0x4000,

525 
	mSWIÁ
 = 0x0100,

526 
	mTxDescUÇva
 = 0x0080,

527 
	mRxFIFOOv”
 = 0x0040,

528 
	mLškChg
 = 0x0020,

529 
	mRxOv”æow
 = 0x0010,

530 
	mTxE¼
 = 0x0008,

531 
	mTxOK
 = 0x0004,

532 
	mRxE¼
 = 0x0002,

533 
	mRxOK
 = 0x0001,

536 
	mRxBOVF
 = (1 << 24),

537 
	mRxFOVF
 = (1 << 23),

538 
	mRxRWT
 = (1 << 22),

539 
	mRxRES
 = (1 << 21),

540 
	mRxRUNT
 = (1 << 20),

541 
	mRxCRC
 = (1 << 19),

544 
	mStİReq
 = 0x80,

545 
	mCmdRe£t
 = 0x10,

546 
	mCmdRxEnb
 = 0x08,

547 
	mCmdTxEnb
 = 0x04,

548 
	mRxBufEm±y
 = 0x01,

551 
	mHPQ
 = 0x80,

552 
	mNPQ
 = 0x40,

553 
	mFSWIÁ
 = 0x01,

556 
	mCfg9346_Lock
 = 0x00,

557 
	mCfg9346_UÆock
 = 0xc0,

560 
	mAcû±E¼
 = 0x20,

561 
	mAcû±RuÁ
 = 0x10,

562 
	mAcû±Brßdÿ¡
 = 0x08,

563 
	mAcû±MuÉiÿ¡
 = 0x04,

564 
	mAcû±MyPhys
 = 0x02,

565 
	mAcû±AÎPhys
 = 0x01,

566 
	#RX_CONFIG_ACCEPT_MASK
 0x3f

	)

569 
	mTxIÁ”F¿meG­Shiá
 = 24,

570 
	mTxDMAShiá
 = 8,

573 
	mLEDS1
 = (1 << 7),

574 
	mLEDS0
 = (1 << 6),

575 
	mS³ed_down
 = (1 << 4),

576 
	mMEMMAP
 = (1 << 3),

577 
	mIOMAP
 = (1 << 2),

578 
	mVPD
 = (1 << 1),

579 
	mPMEÇbË
 = (1 << 0),

582 
	mClkReqEn
 = (1 << 7),

583 
	mMSIEÇbË
 = (1 << 5),

584 
	mPCI_Clock_66MHz
 = 0x01,

585 
	mPCI_Clock_33MHz
 = 0x00,

588 
	mMagicPack‘
 = (1 << 5),

589 
	mLškUp
 = (1 << 4),

590 
	mJumbo_En0
 = (1 << 2),

591 
	mRdy_to_L23
 = (1 << 1),

592 
	mB—cÚ_’
 = (1 << 0),

595 
	mJumbo_En1
 = (1 << 1),

598 
	mBWF
 = (1 << 6),

599 
	mMWF
 = (1 << 5),

600 
	mUWF
 = (1 << 4),

601 
	mSpi_’
 = (1 << 3),

602 
	mLªWake
 = (1 << 1),

603 
	mPMEStus
 = (1 << 0),

604 
	mASPM_’
 = (1 << 0),

607 
	mTBIRe£t
 = 0x80000000,

608 
	mTBILoİback
 = 0x40000000,

609 
	mTBINwEÇbË
 = 0x20000000,

610 
	mTBINwRe¡¬t
 = 0x10000000,

611 
	mTBILškOk
 = 0x02000000,

612 
	mTBINwCom¶‘e
 = 0x01000000,

615 
	mEÇbËBi¡
 = (1 << 15),

616 
	mMac_dbgo_Û
 = (1 << 14),

617 
	mNÜm®_mode
 = (1 << 13),

618 
	mFÜû_h®f_dup
 = (1 << 12),

619 
	mFÜû_rxæow_’
 = (1 << 11),

620 
	mFÜû_txæow_’
 = (1 << 10),

621 
	mCx¶_dbg_£l
 = (1 << 9),

622 
	mASF
 = (1 << 8),

623 
	mPktCÁrDi§bË
 = (1 << 7),

624 
	mMac_dbgo_£l
 = 0x001c,

625 
	mRxVÏn
 = (1 << 6),

626 
	mRxChkSum
 = (1 << 5),

627 
	mPCIDAC
 = (1 << 4),

628 
	mPCIMulRW
 = (1 << 3),

629 
	mINTT_0
 = 0x0000,

630 
	mINTT_1
 = 0x0001,

631 
	mINTT_2
 = 0x0002,

632 
	mINTT_3
 = 0x0003,

635 
	mTBI_EÇbË
 = 0x80,

636 
	mTxFlowCŒl
 = 0x40,

637 
	mRxFlowCŒl
 = 0x20,

638 
	m_1000bpsF
 = 0x10,

639 
	m_100bps
 = 0x08,

640 
	m_10bps
 = 0x04,

641 
	mLškStus
 = 0x02,

642 
	mFuÎDup
 = 0x01,

645 
	mTBILškOK
 = 0x02000000,

648 
	mCouÁ”Re£t
 = 0x1,

651 
	mCouÁ”Dump
 = 0x8,

654 
	mMagicPack‘_v2
 = (1 << 16),

657 
	e¹l_desc_b™
 {

659 
	mDescOwn
 = (1 << 31),

660 
	mRšgEnd
 = (1 << 30),

661 
	mFœ¡F¿g
 = (1 << 29),

662 
	mLa¡F¿g
 = (1 << 28),

666 
	e¹l_tx_desc_b™
 {

668 
	mTD_LSO
 = (1 << 27),

669 
	#TD_MSS_MAX
 0x07ffu

	)

672 
	mTxVÏnTag
 = (1 << 17),

676 
	e¹l_tx_desc_b™_0
 {

678 
	#TD0_MSS_SHIFT
 16

	)

679 
	mTD0_TCP_CS
 = (1 << 16),

680 
	mTD0_UDP_CS
 = (1 << 17),

681 
	mTD0_IP_CS
 = (1 << 18),

685 
	e¹l_tx_desc_b™_1
 {

687 
	mTD1_GTSENV4
 = (1 << 26),

688 
	mTD1_GTSENV6
 = (1 << 25),

689 
	#GTTCPHO_SHIFT
 18

	)

690 
	#GTTCPHO_MAX
 0x7fU

	)

693 
	#TCPHO_SHIFT
 18

	)

694 
	#TCPHO_MAX
 0x3ffU

	)

695 
	#TD1_MSS_SHIFT
 18

	)

696 
	mTD1_IPv6_CS
 = (1 << 28),

697 
	mTD1_IPv4_CS
 = (1 << 29),

698 
	mTD1_TCP_CS
 = (1 << 30),

699 
	mTD1_UDP_CS
 = (1 << 31),

702 
	e¹l_rx_desc_b™
 {

704 
	mPID1
 = (1 << 18),

705 
	mPID0
 = (1 << 17),

707 
	#RxPrÙoUDP
 (
PID1
)

	)

708 
	#RxPrÙoTCP
 (
PID0
)

	)

709 
	#RxPrÙoIP
 (
PID1
 | 
PID0
)

	)

710 
	#RxPrÙoMask
 
RxPrÙoIP


	)

712 
	mIPFa
 = (1 << 16),

713 
	mUDPFa
 = (1 << 15),

714 
	mTCPFa
 = (1 << 14),

715 
	mRxVÏnTag
 = (1 << 16),

718 
	#RsvdMask
 0x3fffc000

	)

720 
	sTxDesc
 {

721 
__Ë32
 
	mİts1
;

722 
__Ë32
 
	mİts2
;

723 
__Ë64
 
	maddr
;

726 
	sRxDesc
 {

727 
__Ë32
 
	mİts1
;

728 
__Ë32
 
	mİts2
;

729 
__Ë64
 
	maddr
;

732 
	sršg_šfo
 {

733 
sk_buff
 *
	mskb
;

734 
u32
 
	mËn
;

735 
u8
 
	m__·d
[(*è- (
u32
)];

738 
	s¹l8169_couÁ”s
 {

739 
__Ë64
 
	mtx_·ck‘s
;

740 
__Ë64
 
	mrx_·ck‘s
;

741 
__Ë64
 
	mtx_”rÜs
;

742 
__Ë32
 
	mrx_”rÜs
;

743 
__Ë16
 
	mrx_mis£d
;

744 
__Ë16
 
	m®ign_”rÜs
;

745 
__Ë32
 
	mtx_Úe_cŞlisiÚ
;

746 
__Ë32
 
	mtx_muÉi_cŞlisiÚ
;

747 
__Ë64
 
	mrx_uniÿ¡
;

748 
__Ë64
 
	mrx_brßdÿ¡
;

749 
__Ë32
 
	mrx_muÉiÿ¡
;

750 
__Ë16
 
	mtx_abÜ‹d
;

751 
__Ë16
 
	mtx_und”un
;

754 
	s¹l8169_tc_off£ts
 {

755 
boŞ
 
	mš™ed
;

756 
__Ë64
 
	mtx_”rÜs
;

757 
__Ë32
 
	mtx_muÉi_cŞlisiÚ
;

758 
__Ë16
 
	mtx_abÜ‹d
;

761 
	e¹l_æag
 {

762 
	mRTL_FLAG_TASK_ENABLED
,

763 
	mRTL_FLAG_TASK_SLOW_PENDING
,

764 
	mRTL_FLAG_TASK_RESET_PENDING
,

765 
	mRTL_FLAG_TASK_PHY_PENDING
,

766 
	mRTL_FLAG_MAX


769 
	s¹l8169_¡©s
 {

770 
u64
 
	m·ck‘s
;

771 
u64
 
	mby‹s
;

772 
u64_¡©s_sync
 
	msynı
;

775 
	s¹l8169_´iv©e
 {

776 
__iomem
 *
	mmmio_addr
;

777 
pci_dev
 *
	mpci_dev
;

778 
Ãt_deviû
 *
	mdev
;

779 
Çpi_¡ruù
 
	mÇpi
;

780 
u32
 
	mmsg_’abË
;

781 
u16
 
	mtxd_v”siÚ
;

782 
u16
 
	mmac_v”siÚ
;

783 
u32
 
	mcur_rx
;

784 
u32
 
	mcur_tx
;

785 
u32
 
	mdœty_tx
;

786 
¹l8169_¡©s
 
	mrx_¡©s
;

787 
¹l8169_¡©s
 
	mtx_¡©s
;

788 
TxDesc
 *
	mTxDescA¼ay
;

789 
RxDesc
 *
	mRxDescA¼ay
;

790 
dma_addr_t
 
	mTxPhyAddr
;

791 
dma_addr_t
 
	mRxPhyAddr
;

792 *
	mRx_d©abuff
[
NUM_RX_DESC
];

793 
ršg_šfo
 
	mtx_skb
[
NUM_TX_DESC
];

794 
tim”_li¡
 
	mtim”
;

795 
u16
 
	mı_cmd
;

797 
u16
 
	mev’t_¦ow
;

798 cÚ¡ 
¹l_cßËsû_šfo
 *
	mcßËsû_šfo
;

800 
	smdio_İs
 {

801 (*
	mwr™e
)(
	m¹l8169_´iv©e
 *, , );

802 (*
	m»ad
)(
	m¹l8169_´iv©e
 *, );

803 } 
	mmdio_İs
;

805 
	s¶l_pow”_İs
 {

806 (*
	mdown
)(
	m¹l8169_´iv©e
 *);

807 (*
	mup
)(
	m¹l8169_´iv©e
 *);

808 } 
	m¶l_pow”_İs
;

810 
	sjumbo_İs
 {

811 (*
	m’abË
)(
	m¹l8169_´iv©e
 *);

812 (*
	mdi§bË
)(
	m¹l8169_´iv©e
 *);

813 } 
	mjumbo_İs
;

815 
	scsi_İs
 {

816 (*
	mwr™e
)(
	m¹l8169_´iv©e
 *, , );

817 
u32
 (*
»ad
)(
	m¹l8169_´iv©e
 *, );

818 } 
	mcsi_İs
;

820 (*
	m£t_¥“d
)(
	mÃt_deviû
 *, 
u8
 
	mªeg
, 
u16
 
	m¥
, u8 
	mdpx
, 
u32
 
	madv
);

821 (*
	mg‘_lšk_k£‰šgs
)(
	mÃt_deviû
 *,

822 
	m‘htoŞ_lšk_k£‰šgs
 *);

823 (*
	mphy_»£t_’abË
)(
¹l8169_´iv©e
 *
	m
);

824 (*
	mhw_¡¬t
)(
	mÃt_deviû
 *);

825 (*
	mphy_»£t_³ndšg
)(
¹l8169_´iv©e
 *
	m
);

826 (*
	mlšk_ok
)(
¹l8169_´iv©e
 *
	m
);

827 (*
	mdo_ioùl
)(
¹l8169_´iv©e
 *
	m
, 
mii_ioùl_d©a
 *
	md©a
, 
	mcmd
);

828 
boŞ
 (*
tso_csum
)(
	m¹l8169_´iv©e
 *, 
	msk_buff
 *, 
	mu32
 *);

831 
DECLARE_BITMAP
(
æags
, 
RTL_FLAG_MAX
);

832 
mu‹x
 
	mmu‹x
;

833 
wÜk_¡ruù
 
	mwÜk
;

834 } 
	mwk
;

836 
	mã©u»s
;

838 
mii_if_šfo
 
	mmii
;

839 
dma_addr_t
 
	mcouÁ”s_phys_addr
;

840 
¹l8169_couÁ”s
 *
	mcouÁ”s
;

841 
¹l8169_tc_off£ts
 
	mtc_off£t
;

842 
u32
 
	m§ved_wŞİts
;

843 
u32
 
	mİts1_mask
;

845 
	s¹l_fw
 {

846 cÚ¡ 
fœmw¬e
 *
	mfw
;

848 
	#RTL_VER_SIZE
 32

	)

850 
	mv”siÚ
[
RTL_VER_SIZE
];

852 
	s¹l_fw_phy_aùiÚ
 {

853 
__Ë32
 *
	mcode
;

854 
size_t
 
	msize
;

855 } 
	mphy_aùiÚ
;

856 } *
	m¹l_fw
;

857 
	#RTL_FIRMWARE_UNKNOWN
 
	`ERR_PTR
(-
EAGAIN
)

	)

859 
u32
 
	moı_ba£
;

862 
MODULE_AUTHOR
("Realtek‡ndhe Linux„8169 crew <netdev@vger.kernel.org>");

863 
MODULE_DESCRIPTION
("RealTek RTL-8169 Gigabit Ethernet driver");

864 
moduË_·¿m
(
u£_dac
, , 0);

865 
MODULE_PARM_DESC
(
u£_dac
, "Enable PCI DAC. Unsafe on 32 bit PCI slot.");

866 
moduË_·¿m_Çmed
(
debug
, debug.
msg_’abË
, , 0);

867 
MODULE_PARM_DESC
(
debug
, "Debug verbosity†evel (0=none, ..., 16=all)");

868 
MODULE_LICENSE
("GPL");

869 
MODULE_VERSION
(
RTL8169_VERSION
);

870 
MODULE_FIRMWARE
(
FIRMWARE_8168D_1
);

871 
MODULE_FIRMWARE
(
FIRMWARE_8168D_2
);

872 
MODULE_FIRMWARE
(
FIRMWARE_8168E_1
);

873 
MODULE_FIRMWARE
(
FIRMWARE_8168E_2
);

874 
MODULE_FIRMWARE
(
FIRMWARE_8168E_3
);

875 
MODULE_FIRMWARE
(
FIRMWARE_8105E_1
);

876 
MODULE_FIRMWARE
(
FIRMWARE_8168F_1
);

877 
MODULE_FIRMWARE
(
FIRMWARE_8168F_2
);

878 
MODULE_FIRMWARE
(
FIRMWARE_8402_1
);

879 
MODULE_FIRMWARE
(
FIRMWARE_8411_1
);

880 
MODULE_FIRMWARE
(
FIRMWARE_8411_2
);

881 
MODULE_FIRMWARE
(
FIRMWARE_8106E_1
);

882 
MODULE_FIRMWARE
(
FIRMWARE_8106E_2
);

883 
MODULE_FIRMWARE
(
FIRMWARE_8168G_2
);

884 
MODULE_FIRMWARE
(
FIRMWARE_8168G_3
);

885 
MODULE_FIRMWARE
(
FIRMWARE_8168H_1
);

886 
MODULE_FIRMWARE
(
FIRMWARE_8168H_2
);

887 
MODULE_FIRMWARE
(
FIRMWARE_8107E_1
);

888 
MODULE_FIRMWARE
(
FIRMWARE_8107E_2
);

890 
šlše
 
deviû
 *
	$_to_dev
(
¹l8169_´iv©e
 *

)

892  &

->
pci_dev
->
dev
;

893 
	}
}

895 
	$¹l_lock_wÜk
(
¹l8169_´iv©e
 *

)

897 
	`mu‹x_lock
(&

->
wk
.
mu‹x
);

898 
	}
}

900 
	$¹l_uÆock_wÜk
(
¹l8169_´iv©e
 *

)

902 
	`mu‹x_uÆock
(&

->
wk
.
mu‹x
);

903 
	}
}

905 
	$¹l_tx_³rfÜmªû_tw—k
(
¹l8169_´iv©e
 *

, 
u16
 
fÜû
)

907 
	`pc›_ÿ·b™y_ş—r_ªd_£t_wÜd
(

->
pci_dev
, 
PCI_EXP_DEVCTL
,

908 
PCI_EXP_DEVCTL_READRQ
, 
fÜû
);

909 
	}
}

911 
	s¹l_cÚd
 {

912 
boŞ
 (*
check
)(
	m¹l8169_´iv©e
 *);

913 cÚ¡ *
	mmsg
;

916 
	$¹l_ud–ay
(
d
)

918 
	`ud–ay
(
d
);

919 
	}
}

921 
boŞ
 
	$¹l_loİ_wa™
(
¹l8169_´iv©e
 *

, cÚ¡ 
¹l_cÚd
 *
c
,

922 (*
d–ay
)(), 
d
, 
n
,

923 
boŞ
 
high
)

925 
i
;

927 
i
 = 0; i < 
n
; i++) {

928 
	`d–ay
(
d
);

929 ià(
c
->
	`check
(

è=ğ
high
)

930  
Œue
;

932 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "%s == %d (loop: %d, delay: %d).\n",

933 
c
->
msg
, !
high
, 
n
, 
d
);

934  
çl£
;

935 
	}
}

937 
boŞ
 
	$¹l_ud–ay_loİ_wa™_high
(
¹l8169_´iv©e
 *

,

938 cÚ¡ 
¹l_cÚd
 *
c
,

939 
d
, 
n
)

941  
	`¹l_loİ_wa™
(

, 
c
, 
¹l_ud–ay
, 
d
, 
n
, 
Œue
);

942 
	}
}

944 
boŞ
 
	$¹l_ud–ay_loİ_wa™_low
(
¹l8169_´iv©e
 *

,

945 cÚ¡ 
¹l_cÚd
 *
c
,

946 
d
, 
n
)

948  
	`¹l_loİ_wa™
(

, 
c
, 
¹l_ud–ay
, 
d
, 
n
, 
çl£
);

949 
	}
}

951 
boŞ
 
	$¹l_m¦“p_loİ_wa™_high
(
¹l8169_´iv©e
 *

,

952 cÚ¡ 
¹l_cÚd
 *
c
,

953 
d
, 
n
)

955  
	`¹l_loİ_wa™
(

, 
c
, 
m¦“p
, 
d
, 
n
, 
Œue
);

956 
	}
}

958 
boŞ
 
	$¹l_m¦“p_loİ_wa™_low
(
¹l8169_´iv©e
 *

,

959 cÚ¡ 
¹l_cÚd
 *
c
,

960 
d
, 
n
)

962  
	`¹l_loİ_wa™
(

, 
c
, 
m¦“p
, 
d
, 
n
, 
çl£
);

963 
	}
}

965 
	#DECLARE_RTL_COND
(
Çme
) \

966 
boŞ
 
Çme
 ## 
	`_check
(
¹l8169_´iv©e
 *); \

968 cÚ¡ 
¹l_cÚd
 
Çme
 = { \

969 .
check
 = 
Çme
 ## 
_check
, \

970 .
msg
 = #name \

973 
boŞ
 
Çme
 ## 
	`_check
(
¹l8169_´iv©e
 *

)

	)

975 
boŞ
 
	$¹l_oı_»g_çu»
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

977 ià(
»g
 & 0xffff0001) {

978 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "Inv®id oı„eg %x!\n", 
»g
);

979  
Œue
;

981  
çl£
;

982 
	}
}

984 
	$DECLARE_RTL_COND
(
¹l_oı_gphy_cÚd
)

986  
	`RTL_R32
(

, 
GPHY_OCP
è& 
OCPAR_FLAG
;

987 
	}
}

989 
	$r8168_phy_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u32
 
»g
, u32 
d©a
)

991 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

994 
	`RTL_W32
(

, 
GPHY_OCP
, 
OCPAR_FLAG
 | (
»g
 << 15è| 
d©a
);

996 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı_gphy_cÚd
, 25, 10);

997 
	}
}

999 
u16
 
	$r8168_phy_oı_»ad
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

1001 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1004 
	`RTL_W32
(

, 
GPHY_OCP
, 
»g
 << 15);

1006  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı_gphy_cÚd
, 25, 10) ?

1007 (
	`RTL_R32
(

, 
GPHY_OCP
) & 0xffff) : ~0;

1008 
	}
}

1010 
	$r8168_mac_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u32
 
»g
, u32 
d©a
)

1012 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1015 
	`RTL_W32
(

, 
OCPDR
, 
OCPAR_FLAG
 | (
»g
 << 15è| 
d©a
);

1016 
	}
}

1018 
u16
 
	$r8168_mac_oı_»ad
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

1020 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1023 
	`RTL_W32
(

, 
OCPDR
, 
»g
 << 15);

1025  
	`RTL_R32
(

, 
OCPDR
);

1026 
	}
}

1028 
	#OCP_STD_PHY_BASE
 0xa400

	)

1030 
	$r8168g_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1032 ià(
»g
 == 0x1f) {

1033 

->
oı_ba£
 = 
v®ue
 ? v®u<< 4 : 
OCP_STD_PHY_BASE
;

1037 ià(

->
oı_ba£
 !ğ
OCP_STD_PHY_BASE
)

1038 
»g
 -= 0x10;

1040 
	`r8168_phy_oı_wr™e
(

,p->
oı_ba£
 + 
»g
 * 2, 
v®ue
);

1041 
	}
}

1043 
	$r8168g_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1045 ià(

->
oı_ba£
 !ğ
OCP_STD_PHY_BASE
)

1046 
»g
 -= 0x10;

1048  
	`r8168_phy_oı_»ad
(

,p->
oı_ba£
 + 
»g
 * 2);

1049 
	}
}

1051 
	$mac_mcu_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1053 ià(
»g
 == 0x1f) {

1054 

->
oı_ba£
 = 
v®ue
 << 4;

1058 
	`r8168_mac_oı_wr™e
(

,p->
oı_ba£
 + 
»g
, 
v®ue
);

1059 
	}
}

1061 
	$mac_mcu_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1063  
	`r8168_mac_oı_»ad
(

,p->
oı_ba£
 + 
»g
);

1064 
	}
}

1066 
	$DECLARE_RTL_COND
(
¹l_phy¬_cÚd
)

1068  
	`RTL_R32
(

, 
PHYAR
) & 0x80000000;

1069 
	}
}

1071 
	$r8169_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1073 
	`RTL_W32
(

, 
PHYAR
, 0x80000000 | (
»g
 & 0x1fè<< 16 | (
v®ue
 & 0xffff));

1075 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_phy¬_cÚd
, 25, 20);

1080 
	`ud–ay
(20);

1081 
	}
}

1083 
	$r8169_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1085 
v®ue
;

1087 
	`RTL_W32
(

, 
PHYAR
, 0x0 | (
»g
 & 0x1f) << 16);

1089 
v®ue
 = 
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_phy¬_cÚd
, 25, 20) ?

1090 
	`RTL_R32
(

, 
PHYAR
) & 0xffff : ~0;

1096 
	`ud–ay
(20);

1098  
v®ue
;

1099 
	}
}

1101 
	$DECLARE_RTL_COND
(
¹l_oı¬_cÚd
)

1103  
	`RTL_R32
(

, 
OCPAR
è& 
OCPAR_FLAG
;

1104 
	}
}

1106 
	$r8168dp_1_mdio_acûss
(
¹l8169_´iv©e
 *

, 
»g
, 
u32
 
d©a
)

1108 
	`RTL_W32
(

, 
OCPDR
, 
d©a
 | ((
»g
 & 
OCPDR_REG_MASK
è<< 
OCPDR_GPHY_REG_SHIFT
));

1109 
	`RTL_W32
(

, 
OCPAR
, 
OCPAR_GPHY_WRITE_CMD
);

1110 
	`RTL_W32
(

, 
EPHY_RXER_NUM
, 0);

1112 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı¬_cÚd
, 1000, 100);

1113 
	}
}

1115 
	$r8168dp_1_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1117 
	`r8168dp_1_mdio_acûss
(

, 
»g
,

1118 
OCPDR_WRITE_CMD
 | (
v®ue
 & 
OCPDR_DATA_MASK
));

1119 
	}
}

1121 
	$r8168dp_1_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1123 
	`r8168dp_1_mdio_acûss
(

, 
»g
, 
OCPDR_READ_CMD
);

1125 
	`md–ay
(1);

1126 
	`RTL_W32
(

, 
OCPAR
, 
OCPAR_GPHY_READ_CMD
);

1127 
	`RTL_W32
(

, 
EPHY_RXER_NUM
, 0);

1129  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı¬_cÚd
, 1000, 100) ?

1130 
	`RTL_R32
(

, 
OCPDR
è& 
OCPDR_DATA_MASK
 : ~0;

1131 
	}
}

1133 
	#R8168DP_1_MDIO_ACCESS_BIT
 0x00020000

	)

1135 
	$r8168dp_2_mdio_¡¬t
(
¹l8169_´iv©e
 *

)

1137 
	`RTL_W32
(

, 0xd0, 
	`RTL_R32
Ñp, 0xd0è& ~
R8168DP_1_MDIO_ACCESS_BIT
);

1138 
	}
}

1140 
	$r8168dp_2_mdio_¡İ
(
¹l8169_´iv©e
 *

)

1142 
	`RTL_W32
(

, 0xd0, 
	`RTL_R32
Ñp, 0xd0è| 
R8168DP_1_MDIO_ACCESS_BIT
);

1143 
	}
}

1145 
	$r8168dp_2_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1147 
	`r8168dp_2_mdio_¡¬t
(

);

1149 
	`r8169_mdio_wr™e
(

, 
»g
, 
v®ue
);

1151 
	`r8168dp_2_mdio_¡İ
(

);

1152 
	}
}

1154 
	$r8168dp_2_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1156 
v®ue
;

1158 
	`r8168dp_2_mdio_¡¬t
(

);

1160 
v®ue
 = 
	`r8169_mdio_»ad
(

, 
»g
);

1162 
	`r8168dp_2_mdio_¡İ
(

);

1164  
v®ue
;

1165 
	}
}

1167 
	$¹l_wr™•hy
(
¹l8169_´iv©e
 *

, 
loÿtiÚ
, 
u32
 
v®
)

1169 

->
mdio_İs
.
	`wr™e
Ñp, 
loÿtiÚ
, 
v®
);

1170 
	}
}

1172 
	$¹l_»adphy
(
¹l8169_´iv©e
 *

, 
loÿtiÚ
)

1174  

->
mdio_İs
.
	`»ad
Ñp, 
loÿtiÚ
);

1175 
	}
}

1177 
	$¹l_·tchphy
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
v®ue
)

1179 
	`¹l_wr™•hy
(

, 
»g_addr
, 
	`¹l_»adphy
Ñp,„eg_addrè| 
v®ue
);

1180 
	}
}

1182 
	$¹l_w0w1_phy
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
p
, 
m
)

1184 
v®
;

1186 
v®
 = 
	`¹l_»adphy
(

, 
»g_addr
);

1187 
	`¹l_wr™•hy
(

, 
»g_addr
, (
v®
 & ~
m
è| 
p
);

1188 
	}
}

1190 
	$¹l_mdio_wr™e
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
,

1191 
v®
)

1193 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1195 
	`¹l_wr™•hy
(

, 
loÿtiÚ
, 
v®
);

1196 
	}
}

1198 
	$¹l_mdio_»ad
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
)

1200 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1202  
	`¹l_»adphy
(

, 
loÿtiÚ
);

1203 
	}
}

1205 
	$DECLARE_RTL_COND
(
¹l_•hy¬_cÚd
)

1207  
	`RTL_R32
(

, 
EPHYAR
è& 
EPHYAR_FLAG
;

1208 
	}
}

1210 
	$¹l_•hy_wr™e
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
v®ue
)

1212 
	`RTL_W32
(

, 
EPHYAR
, 
EPHYAR_WRITE_CMD
 | (
v®ue
 & 
EPHYAR_DATA_MASK
) |

1213 (
»g_addr
 & 
EPHYAR_REG_MASK
è<< 
EPHYAR_REG_SHIFT
);

1215 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_•hy¬_cÚd
, 10, 100);

1217 
	`ud–ay
(10);

1218 
	}
}

1220 
u16
 
	$¹l_•hy_»ad
(
¹l8169_´iv©e
 *

, 
»g_addr
)

1222 
	`RTL_W32
(

, 
EPHYAR
, (
»g_addr
 & 
EPHYAR_REG_MASK
è<< 
EPHYAR_REG_SHIFT
);

1224  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_•hy¬_cÚd
, 10, 100) ?

1225 
	`RTL_R32
(

, 
EPHYAR
è& 
EPHYAR_DATA_MASK
 : ~0;

1226 
	}
}

1228 
	$DECLARE_RTL_COND
(
¹l_”Ÿr_cÚd
)

1230  
	`RTL_R32
(

, 
ERIAR
è& 
ERIAR_FLAG
;

1231 
	}
}

1233 
	$¹l_”i_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
u32
 
mask
,

1234 
u32
 
v®
, 
ty³
)

1236 
	`BUG_ON
((
addr
 & 3è|| (
mask
 == 0));

1237 
	`RTL_W32
(

, 
ERIDR
, 
v®
);

1238 
	`RTL_W32
(

, 
ERIAR
, 
ERIAR_WRITE_CMD
 | 
ty³
 | 
mask
 | 
addr
);

1240 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_”Ÿr_cÚd
, 100, 100);

1241 
	}
}

1243 
u32
 
	$¹l_”i_»ad
(
¹l8169_´iv©e
 *

, 
addr
, 
ty³
)

1245 
	`RTL_W32
(

, 
ERIAR
, 
ERIAR_READ_CMD
 | 
ty³
 | 
ERIAR_MASK_1111
 | 
addr
);

1247  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_”Ÿr_cÚd
, 100, 100) ?

1248 
	`RTL_R32
(

, 
ERIDR
) : ~0;

1249 
	}
}

1251 
	$¹l_w0w1_”i
(
¹l8169_´iv©e
 *

, 
addr
, 
u32
 
mask
, u32 
p
,

1252 
u32
 
m
, 
ty³
)

1254 
u32
 
v®
;

1256 
v®
 = 
	`¹l_”i_»ad
(

, 
addr
, 
ty³
);

1257 
	`¹l_”i_wr™e
(

, 
addr
, 
mask
, (
v®
 & ~
m
è| 
p
, 
ty³
);

1258 
	}
}

1260 
u32
 
	$r8168dp_oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1262 
	`RTL_W32
(

, 
OCPAR
, ((
u32
)
mask
 & 0x0fè<< 12 | (
»g
 & 0x0fff));

1263  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı¬_cÚd
, 100, 20) ?

1264 
	`RTL_R32
(

, 
OCPDR
) : ~0;

1265 
	}
}

1267 
u32
 
	$r8168•_oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1269  
	`¹l_”i_»ad
(

, 
»g
, 
ERIAR_OOB
);

1270 
	}
}

1272 
u32
 
	$oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1274 

->
mac_v”siÚ
) {

1275 
RTL_GIGA_MAC_VER_27
:

1276 
RTL_GIGA_MAC_VER_28
:

1277 
RTL_GIGA_MAC_VER_31
:

1278  
	`r8168dp_oı_»ad
(

, 
mask
, 
»g
);

1279 
RTL_GIGA_MAC_VER_49
:

1280 
RTL_GIGA_MAC_VER_50
:

1281 
RTL_GIGA_MAC_VER_51
:

1282  
	`r8168•_oı_»ad
(

, 
mask
, 
»g
);

1284 
	`BUG
();

1287 
	}
}

1289 
	$r8168dp_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
,

1290 
u32
 
d©a
)

1292 
	`RTL_W32
(

, 
OCPDR
, 
d©a
);

1293 
	`RTL_W32
(

, 
OCPAR
, 
OCPAR_FLAG
 | ((
u32
)
mask
 & 0x0fè<< 12 | (
»g
 & 0x0fff));

1294 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı¬_cÚd
, 100, 20);

1295 
	}
}

1297 
	$r8168•_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
,

1298 
u32
 
d©a
)

1300 
	`¹l_”i_wr™e
(

, 
»g
, ((
u32
)
mask
 & 0x0fè<< 
ERIAR_MASK_SHIFT
,

1301 
d©a
, 
ERIAR_OOB
);

1302 
	}
}

1304 
	$oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
, 
u32
 
d©a
)

1306 

->
mac_v”siÚ
) {

1307 
RTL_GIGA_MAC_VER_27
:

1308 
RTL_GIGA_MAC_VER_28
:

1309 
RTL_GIGA_MAC_VER_31
:

1310 
	`r8168dp_oı_wr™e
(

, 
mask
, 
»g
, 
d©a
);

1312 
RTL_GIGA_MAC_VER_49
:

1313 
RTL_GIGA_MAC_VER_50
:

1314 
RTL_GIGA_MAC_VER_51
:

1315 
	`r8168•_oı_wr™e
(

, 
mask
, 
»g
, 
d©a
);

1318 
	`BUG
();

1321 
	}
}

1323 
	$¹l8168_oob_nÙify
(
¹l8169_´iv©e
 *

, 
u8
 
cmd
)

1325 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_0001
, 
cmd
, 
ERIAR_EXGMAC
);

1327 
	`oı_wr™e
(

, 0x1, 0x30, 0x00000001);

1328 
	}
}

1330 
	#OOB_CMD_RESET
 0x00

	)

1331 
	#OOB_CMD_DRIVER_START
 0x05

	)

1332 
	#OOB_CMD_DRIVER_STOP
 0x06

	)

1334 
u16
 
	$¹l8168_g‘_oı_»g
(
¹l8169_´iv©e
 *

)

1336  (

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
) ? 0xb8 : 0x10;

1337 
	}
}

1339 
	$DECLARE_RTL_COND
(
¹l_oı_»ad_cÚd
)

1341 
u16
 
»g
;

1343 
»g
 = 
	`¹l8168_g‘_oı_»g
(

);

1345  
	`oı_»ad
(

, 0x0f, 
»g
) & 0x00000800;

1346 
	}
}

1348 
	$DECLARE_RTL_COND
(
¹l_•_oı_»ad_cÚd
)

1350  
	`oı_»ad
(

, 0x0f, 0x124) & 0x00000001;

1351 
	}
}

1353 
	$DECLARE_RTL_COND
(
¹l_oı_tx_cÚd
)

1355  
	`RTL_R8
(

, 
IBISR0
) & 0x20;

1356 
	}
}

1358 
	$¹l8168•_¡İ_cmac
(
¹l8169_´iv©e
 *

)

1360 
	`RTL_W8
(

, 
IBCR2
, 
	`RTL_R8
(tp, IBCR2) & ~0x01);

1361 
	`¹l_m¦“p_loİ_wa™_high
(

, &
¹l_oı_tx_cÚd
, 50, 2000);

1362 
	`RTL_W8
(

, 
IBISR0
, 
	`RTL_R8
(tp, IBISR0) | 0x20);

1363 
	`RTL_W8
(

, 
IBCR0
, 
	`RTL_R8
(tp, IBCR0) & ~0x01);

1364 
	}
}

1366 
	$¹l8168dp_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1368 
	`¹l8168_oob_nÙify
(

, 
OOB_CMD_DRIVER_START
);

1369 
	`¹l_m¦“p_loİ_wa™_high
(

, &
¹l_oı_»ad_cÚd
, 10, 10);

1370 
	}
}

1372 
	$¹l8168•_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1374 
	`oı_wr™e
(

, 0x01, 0x180, 
OOB_CMD_DRIVER_START
);

1375 
	`oı_wr™e
(

, 0x01, 0x30, 
	`oı_»ad
(tp, 0x01, 0x30) | 0x01);

1376 
	`¹l_m¦“p_loİ_wa™_high
(

, &
¹l_•_oı_»ad_cÚd
, 10, 10);

1377 
	}
}

1379 
	$¹l8168_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1381 

->
mac_v”siÚ
) {

1382 
RTL_GIGA_MAC_VER_27
:

1383 
RTL_GIGA_MAC_VER_28
:

1384 
RTL_GIGA_MAC_VER_31
:

1385 
	`¹l8168dp_driv”_¡¬t
(

);

1387 
RTL_GIGA_MAC_VER_49
:

1388 
RTL_GIGA_MAC_VER_50
:

1389 
RTL_GIGA_MAC_VER_51
:

1390 
	`¹l8168•_driv”_¡¬t
(

);

1393 
	`BUG
();

1396 
	}
}

1398 
	$¹l8168dp_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1400 
	`¹l8168_oob_nÙify
(

, 
OOB_CMD_DRIVER_STOP
);

1401 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_oı_»ad_cÚd
, 10, 10);

1402 
	}
}

1404 
	$¹l8168•_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1406 
	`¹l8168•_¡İ_cmac
(

);

1407 
	`oı_wr™e
(

, 0x01, 0x180, 
OOB_CMD_DRIVER_STOP
);

1408 
	`oı_wr™e
(

, 0x01, 0x30, 
	`oı_»ad
(tp, 0x01, 0x30) | 0x01);

1409 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_•_oı_»ad_cÚd
, 10, 10);

1410 
	}
}

1412 
	$¹l8168_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1414 

->
mac_v”siÚ
) {

1415 
RTL_GIGA_MAC_VER_27
:

1416 
RTL_GIGA_MAC_VER_28
:

1417 
RTL_GIGA_MAC_VER_31
:

1418 
	`¹l8168dp_driv”_¡İ
(

);

1420 
RTL_GIGA_MAC_VER_49
:

1421 
RTL_GIGA_MAC_VER_50
:

1422 
RTL_GIGA_MAC_VER_51
:

1423 
	`¹l8168•_driv”_¡İ
(

);

1426 
	`BUG
();

1429 
	}
}

1431 
boŞ
 
	$r8168dp_check_dash
(
¹l8169_´iv©e
 *

)

1433 
u16
 
»g
 = 
	`¹l8168_g‘_oı_»g
(

);

1435  !!(
	`oı_»ad
(

, 0x0f, 
»g
) & 0x00008000);

1436 
	}
}

1438 
boŞ
 
	$r8168•_check_dash
(
¹l8169_´iv©e
 *

)

1440  !!(
	`oı_»ad
(

, 0x0f, 0x128) & 0x00000001);

1441 
	}
}

1443 
boŞ
 
	$r8168_check_dash
(
¹l8169_´iv©e
 *

)

1445 

->
mac_v”siÚ
) {

1446 
RTL_GIGA_MAC_VER_27
:

1447 
RTL_GIGA_MAC_VER_28
:

1448 
RTL_GIGA_MAC_VER_31
:

1449  
	`r8168dp_check_dash
(

);

1450 
RTL_GIGA_MAC_VER_49
:

1451 
RTL_GIGA_MAC_VER_50
:

1452 
RTL_GIGA_MAC_VER_51
:

1453  
	`r8168•_check_dash
(

);

1455  
çl£
;

1457 
	}
}

1459 
	sexgmac_»g
 {

1460 
u16
 
	maddr
;

1461 
u16
 
	mmask
;

1462 
u32
 
	mv®
;

1465 
	$¹l_wr™e_exgmac_b©ch
(
¹l8169_´iv©e
 *

,

1466 cÚ¡ 
exgmac_»g
 *
r
, 
Ën
)

1468 
Ën
-- > 0) {

1469 
	`¹l_”i_wr™e
(

, 
r
->
addr
,„->
mask
,„->
v®
, 
ERIAR_EXGMAC
);

1470 
r
++;

1472 
	}
}

1474 
	$DECLARE_RTL_COND
(
¹l_efu£¬_cÚd
)

1476  
	`RTL_R32
(

, 
EFUSEAR
è& 
EFUSEAR_FLAG
;

1477 
	}
}

1479 
u8
 
	$¹l8168d_efu£_»ad
(
¹l8169_´iv©e
 *

, 
»g_addr
)

1481 
	`RTL_W32
(

, 
EFUSEAR
, (
»g_addr
 & 
EFUSEAR_REG_MASK
è<< 
EFUSEAR_REG_SHIFT
);

1483  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_efu£¬_cÚd
, 100, 300) ?

1484 
	`RTL_R32
(

, 
EFUSEAR
è& 
EFUSEAR_DATA_MASK
 : ~0;

1485 
	}
}

1487 
u16
 
	$¹l_g‘_ev’ts
(
¹l8169_´iv©e
 *

)

1489  
	`RTL_R16
(

, 
IÁrStus
);

1490 
	}
}

1492 
	$¹l_ack_ev’ts
(
¹l8169_´iv©e
 *

, 
u16
 
b™s
)

1494 
	`RTL_W16
(

, 
IÁrStus
, 
b™s
);

1495 
	`mmiowb
();

1496 
	}
}

1498 
	$¹l_œq_di§bË
(
¹l8169_´iv©e
 *

)

1500 
	`RTL_W16
(

, 
IÁrMask
, 0);

1501 
	`mmiowb
();

1502 
	}
}

1504 
	$¹l_œq_’abË
(
¹l8169_´iv©e
 *

, 
u16
 
b™s
)

1506 
	`RTL_W16
(

, 
IÁrMask
, 
b™s
);

1507 
	}
}

1509 
	#RTL_EVENT_NAPI_RX
 (
RxOK
 | 
RxE¼
)

	)

1510 
	#RTL_EVENT_NAPI_TX
 (
TxOK
 | 
TxE¼
)

	)

1511 
	#RTL_EVENT_NAPI
 (
RTL_EVENT_NAPI_RX
 | 
RTL_EVENT_NAPI_TX
)

	)

1513 
	$¹l_œq_’abË_®l
(
¹l8169_´iv©e
 *

)

1515 
	`¹l_œq_’abË
(

, 
RTL_EVENT_NAPI
 |p->
ev’t_¦ow
);

1516 
	}
}

1518 
	$¹l8169_œq_mask_ªd_ack
(
¹l8169_´iv©e
 *

)

1520 
	`¹l_œq_di§bË
(

);

1521 
	`¹l_ack_ev’ts
(

, 
RTL_EVENT_NAPI
 |p->
ev’t_¦ow
);

1522 
	`RTL_R8
(

, 
ChCmd
);

1523 
	}
}

1525 
	$¹l8169_tbi_»£t_³ndšg
(
¹l8169_´iv©e
 *

)

1527  
	`RTL_R32
(

, 
TBICSR
è& 
TBIRe£t
;

1528 
	}
}

1530 
	$¹l8169_xmii_»£t_³ndšg
(
¹l8169_´iv©e
 *

)

1532  
	`¹l_»adphy
(

, 
MII_BMCR
è& 
BMCR_RESET
;

1533 
	}
}

1535 
	$¹l8169_tbi_lšk_ok
(
¹l8169_´iv©e
 *

)

1537  
	`RTL_R32
(

, 
TBICSR
è& 
TBILškOk
;

1538 
	}
}

1540 
	$¹l8169_xmii_lšk_ok
(
¹l8169_´iv©e
 *

)

1542  
	`RTL_R8
(

, 
PHY¡©us
è& 
LškStus
;

1543 
	}
}

1545 
	$¹l8169_tbi_»£t_’abË
(
¹l8169_´iv©e
 *

)

1547 
	`RTL_W32
(

, 
TBICSR
, 
	`RTL_R32
Ñp, TBICSRè| 
TBIRe£t
);

1548 
	}
}

1550 
	$¹l8169_xmii_»£t_’abË
(
¹l8169_´iv©e
 *

)

1552 
v®
;

1554 
v®
 = 
	`¹l_»adphy
(

, 
MII_BMCR
è| 
BMCR_RESET
;

1555 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
v®
 & 0xffff);

1556 
	}
}

1558 
	$¹l_lšk_chg_·tch
(
¹l8169_´iv©e
 *

)

1560 
Ãt_deviû
 *
dev
 = 

->dev;

1562 ià(!
	`Ãtif_ruÂšg
(
dev
))

1565 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
 ||

1566 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
) {

1567 ià(
	`RTL_R8
(

, 
PHY¡©us
è& 
_1000bpsF
) {

1568 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x00000011,

1569 
ERIAR_EXGMAC
);

1570 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1571 
ERIAR_EXGMAC
);

1572 } ià(
	`RTL_R8
(

, 
PHY¡©us
è& 
_100bps
) {

1573 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1574 
ERIAR_EXGMAC
);

1575 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1576 
ERIAR_EXGMAC
);

1578 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1579 
ERIAR_EXGMAC
);

1580 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x0000003f,

1581 
ERIAR_EXGMAC
);

1584 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01,

1585 
ERIAR_EXGMAC
);

1586 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00,

1587 
ERIAR_EXGMAC
);

1588 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

1589 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
) {

1590 ià(
	`RTL_R8
(

, 
PHY¡©us
è& 
_1000bpsF
) {

1591 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x00000011,

1592 
ERIAR_EXGMAC
);

1593 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1594 
ERIAR_EXGMAC
);

1596 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1597 
ERIAR_EXGMAC
);

1598 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x0000003f,

1599 
ERIAR_EXGMAC
);

1601 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
) {

1602 ià(
	`RTL_R8
(

, 
PHY¡©us
è& 
_10bps
) {

1603 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x4d02,

1604 
ERIAR_EXGMAC
);

1605 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_0011
, 0x0060,

1606 
ERIAR_EXGMAC
);

1608 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x0000,

1609 
ERIAR_EXGMAC
);

1612 
	}
}

1614 
	$¹l8169_check_lšk_¡©us
(
Ãt_deviû
 *
dev
,

1615 
¹l8169_´iv©e
 *

)

1617 
deviû
 *
d
 = 
	`_to_dev
(

);

1619 ià(

->
	`lšk_ok
(tp)) {

1620 
	`¹l_lšk_chg_·tch
(

);

1622 
	`pm_»que¡_»sume
(
d
);

1623 
	`Ãtif_ÿ¼›r_Ú
(
dev
);

1624 ià(
	`Ãt_¿‹lim™
())

1625 
	`Ãtif_šfo
(

, 
ifup
, 
dev
, "link up\n");

1627 
	`Ãtif_ÿ¼›r_off
(
dev
);

1628 
	`Ãtif_šfo
(

, 
ifdown
, 
dev
, "link down\n");

1629 
	`pm_ruÁime_idË
(
d
);

1631 
	}
}

1633 
	#WAKE_ANY
 (
WAKE_PHY
 | 
WAKE_MAGIC
 | 
WAKE_UCAST
 | 
WAKE_BCAST
 | 
WAKE_MCAST
)

	)

1635 
u32
 
	$__¹l8169_g‘_wŞ
(
¹l8169_´iv©e
 *

)

1637 
u8
 
İtiÚs
;

1638 
u32
 
wŞİts
 = 0;

1640 
İtiÚs
 = 
	`RTL_R8
(

, 
CÚfig1
);

1641 ià(!(
İtiÚs
 & 
PMEÇbË
))

1644 
İtiÚs
 = 
	`RTL_R8
(

, 
CÚfig3
);

1645 ià(
İtiÚs
 & 
LškUp
)

1646 
wŞİts
 |ğ
WAKE_PHY
;

1647 

->
mac_v”siÚ
) {

1648 
RTL_GIGA_MAC_VER_34
:

1649 
RTL_GIGA_MAC_VER_35
:

1650 
RTL_GIGA_MAC_VER_36
:

1651 
RTL_GIGA_MAC_VER_37
:

1652 
RTL_GIGA_MAC_VER_38
:

1653 
RTL_GIGA_MAC_VER_40
:

1654 
RTL_GIGA_MAC_VER_41
:

1655 
RTL_GIGA_MAC_VER_42
:

1656 
RTL_GIGA_MAC_VER_43
:

1657 
RTL_GIGA_MAC_VER_44
:

1658 
RTL_GIGA_MAC_VER_45
:

1659 
RTL_GIGA_MAC_VER_46
:

1660 
RTL_GIGA_MAC_VER_47
:

1661 
RTL_GIGA_MAC_VER_48
:

1662 
RTL_GIGA_MAC_VER_49
:

1663 
RTL_GIGA_MAC_VER_50
:

1664 
RTL_GIGA_MAC_VER_51
:

1665 ià(
	`¹l_”i_»ad
(

, 0xdc, 
ERIAR_EXGMAC
è& 
MagicPack‘_v2
)

1666 
wŞİts
 |ğ
WAKE_MAGIC
;

1669 ià(
İtiÚs
 & 
MagicPack‘
)

1670 
wŞİts
 |ğ
WAKE_MAGIC
;

1674 
İtiÚs
 = 
	`RTL_R8
(

, 
CÚfig5
);

1675 ià(
İtiÚs
 & 
UWF
)

1676 
wŞİts
 |ğ
WAKE_UCAST
;

1677 ià(
İtiÚs
 & 
BWF
)

1678 
wŞİts
 |ğ
WAKE_BCAST
;

1679 ià(
İtiÚs
 & 
MWF
)

1680 
wŞİts
 |ğ
WAKE_MCAST
;

1682  
wŞİts
;

1683 
	}
}

1685 
	$¹l8169_g‘_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1687 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1688 
deviû
 *
d
 = 
	`_to_dev
(

);

1690 
	`pm_ruÁime_g‘_nÜesume
(
d
);

1692 
	`¹l_lock_wÜk
(

);

1694 
wŞ
->
suµÜ‹d
 = 
WAKE_ANY
;

1695 ià(
	`pm_ruÁime_aùive
(
d
))

1696 
wŞ
->
wŞİts
 = 
	`__¹l8169_g‘_wŞ
(

);

1698 
wŞ
->
wŞİts
 = 

->
§ved_wŞİts
;

1700 
	`¹l_uÆock_wÜk
(

);

1702 
	`pm_ruÁime_put_noidË
(
d
);

1703 
	}
}

1705 
	$__¹l8169_£t_wŞ
(
¹l8169_´iv©e
 *

, 
u32
 
wŞİts
)

1707 
i
, 
tmp
;

1709 
u32
 
İt
;

1710 
u16
 
»g
;

1711 
u8
 
mask
;

1712 } 
cfg
[] = {

1713 { 
WAKE_PHY
, 
CÚfig3
, 
LškUp
 },

1714 { 
WAKE_UCAST
, 
CÚfig5
, 
UWF
 },

1715 { 
WAKE_BCAST
, 
CÚfig5
, 
BWF
 },

1716 { 
WAKE_MCAST
, 
CÚfig5
, 
MWF
 },

1717 { 
WAKE_ANY
, 
CÚfig5
, 
LªWake
 },

1718 { 
WAKE_MAGIC
, 
CÚfig3
, 
MagicPack‘
 }

1720 
u8
 
İtiÚs
;

1722 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

1724 

->
mac_v”siÚ
) {

1725 
RTL_GIGA_MAC_VER_34
:

1726 
RTL_GIGA_MAC_VER_35
:

1727 
RTL_GIGA_MAC_VER_36
:

1728 
RTL_GIGA_MAC_VER_37
:

1729 
RTL_GIGA_MAC_VER_38
:

1730 
RTL_GIGA_MAC_VER_40
:

1731 
RTL_GIGA_MAC_VER_41
:

1732 
RTL_GIGA_MAC_VER_42
:

1733 
RTL_GIGA_MAC_VER_43
:

1734 
RTL_GIGA_MAC_VER_44
:

1735 
RTL_GIGA_MAC_VER_45
:

1736 
RTL_GIGA_MAC_VER_46
:

1737 
RTL_GIGA_MAC_VER_47
:

1738 
RTL_GIGA_MAC_VER_48
:

1739 
RTL_GIGA_MAC_VER_49
:

1740 
RTL_GIGA_MAC_VER_50
:

1741 
RTL_GIGA_MAC_VER_51
:

1742 
tmp
 = 
	`ARRAY_SIZE
(
cfg
) - 1;

1743 ià(
wŞİts
 & 
WAKE_MAGIC
)

1744 
	`¹l_w0w1_”i
(

,

1746 
ERIAR_MASK_0100
,

1747 
MagicPack‘_v2
,

1749 
ERIAR_EXGMAC
);

1751 
	`¹l_w0w1_”i
(

,

1753 
ERIAR_MASK_0100
,

1755 
MagicPack‘_v2
,

1756 
ERIAR_EXGMAC
);

1759 
tmp
 = 
	`ARRAY_SIZE
(
cfg
);

1763 
i
 = 0; i < 
tmp
; i++) {

1764 
İtiÚs
 = 
	`RTL_R8
(

, 
cfg
[
i
].
»g
è& ~cfg[i].
mask
;

1765 ià(
wŞİts
 & 
cfg
[
i
].
İt
)

1766 
İtiÚs
 |ğ
cfg
[
i
].
mask
;

1767 
	`RTL_W8
(

, 
cfg
[
i
].
»g
, 
İtiÚs
);

1770 

->
mac_v”siÚ
) {

1771 
RTL_GIGA_MAC_VER_01
 ... 
RTL_GIGA_MAC_VER_17
:

1772 
İtiÚs
 = 
	`RTL_R8
(

, 
CÚfig1
è& ~
PMEÇbË
;

1773 ià(
wŞİts
)

1774 
İtiÚs
 |ğ
PMEÇbË
;

1775 
	`RTL_W8
(

, 
CÚfig1
, 
İtiÚs
);

1778 
İtiÚs
 = 
	`RTL_R8
(

, 
CÚfig2
è& ~
PME_SIGNAL
;

1779 ià(
wŞİts
)

1780 
İtiÚs
 |ğ
PME_SIGNAL
;

1781 
	`RTL_W8
(

, 
CÚfig2
, 
İtiÚs
);

1785 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

1786 
	}
}

1788 
	$¹l8169_£t_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1790 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1791 
deviû
 *
d
 = 
	`_to_dev
(

);

1793 
	`pm_ruÁime_g‘_nÜesume
(
d
);

1795 
	`¹l_lock_wÜk
(

);

1797 ià(
	`pm_ruÁime_aùive
(
d
))

1798 
	`__¹l8169_£t_wŞ
(

, 
wŞ
->
wŞİts
);

1800 

->
§ved_wŞİts
 = 
wŞ
->
wŞİts
;

1802 
	`¹l_uÆock_wÜk
(

);

1804 
	`deviû_£t_wakeup_’abË
(
d
, 
wŞ
->
wŞİts
);

1806 
	`pm_ruÁime_put_noidË
(
d
);

1809 
	}
}

1811 cÚ¡ *
	$¹l_lookup_fœmw¬e_Çme
(
¹l8169_´iv©e
 *

)

1813  
¹l_ch_šfos
[

->
mac_v”siÚ
].
fw_Çme
;

1814 
	}
}

1816 
	$¹l8169_g‘_drvšfo
(
Ãt_deviû
 *
dev
,

1817 
‘htoŞ_drvšfo
 *
šfo
)

1819 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1820 
¹l_fw
 *¹l_fw = 

->rtl_fw;

1822 
	`¡¾ıy
(
šfo
->
driv”
, 
MODULENAME
, (info->driver));

1823 
	`¡¾ıy
(
šfo
->
v”siÚ
, 
RTL8169_VERSION
, (info->version));

1824 
	`¡¾ıy
(
šfo
->
bus_šfo
, 
	`pci_Çme
(

->
pci_dev
), (info->bus_info));

1825 
	`BUILD_BUG_ON
((
šfo
->
fw_v”siÚ
è< (
¹l_fw
->
v”siÚ
));

1826 ià(!
	`IS_ERR_OR_NULL
(
¹l_fw
))

1827 
	`¡¾ıy
(
šfo
->
fw_v”siÚ
, 
¹l_fw
->
v”siÚ
,

1828 (
šfo
->
fw_v”siÚ
));

1829 
	}
}

1831 
	$¹l8169_g‘_»gs_Ën
(
Ãt_deviû
 *
dev
)

1833  
R8169_REGS_SIZE
;

1834 
	}
}

1836 
	$¹l8169_£t_¥“d_tbi
(
Ãt_deviû
 *
dev
,

1837 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
ignÜed
)

1839 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1840 
»t
 = 0;

1841 
u32
 
»g
;

1843 
»g
 = 
	`RTL_R32
(

, 
TBICSR
);

1844 ià((
autÚeg
 =ğ
AUTONEG_DISABLE
è&& (
¥“d
 =ğ
SPEED_1000
) &&

1845 (
du¶ex
 =ğ
DUPLEX_FULL
)) {

1846 
	`RTL_W32
(

, 
TBICSR
, 
»g
 & ~(
TBINwEÇbË
 | 
TBINwRe¡¬t
));

1847 } ià(
autÚeg
 =ğ
AUTONEG_ENABLE
)

1848 
	`RTL_W32
(

, 
TBICSR
, 
»g
 | 
TBINwEÇbË
 | 
TBINwRe¡¬t
);

1850 
	`Ãtif_w¬n
(

, 
lšk
, 
dev
,

1852 
»t
 = -
EOPNOTSUPP
;

1855  
»t
;

1856 
	}
}

1858 
	$¹l8169_£t_¥“d_xmii
(
Ãt_deviû
 *
dev
,

1859 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
adv
)

1861 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1862 
giga_ù¾
, 
bmü
;

1863 
rc
 = -
EINVAL
;

1865 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

1867 ià(
autÚeg
 =ğ
AUTONEG_ENABLE
) {

1868 
auto_Ãgo
;

1870 
auto_Ãgo
 = 
	`¹l_»adphy
(

, 
MII_ADVERTISE
);

1871 
auto_Ãgo
 &ğ~(
ADVERTISE_10HALF
 | 
ADVERTISE_10FULL
 |

1872 
ADVERTISE_100HALF
 | 
ADVERTISE_100FULL
);

1874 ià(
adv
 & 
ADVERTISED_10ba£T_H®f
)

1875 
auto_Ãgo
 |ğ
ADVERTISE_10HALF
;

1876 ià(
adv
 & 
ADVERTISED_10ba£T_FuÎ
)

1877 
auto_Ãgo
 |ğ
ADVERTISE_10FULL
;

1878 ià(
adv
 & 
ADVERTISED_100ba£T_H®f
)

1879 
auto_Ãgo
 |ğ
ADVERTISE_100HALF
;

1880 ià(
adv
 & 
ADVERTISED_100ba£T_FuÎ
)

1881 
auto_Ãgo
 |ğ
ADVERTISE_100FULL
;

1883 
auto_Ãgo
 |ğ
ADVERTISE_PAUSE_CAP
 | 
ADVERTISE_PAUSE_ASYM
;

1885 
giga_ù¾
 = 
	`¹l_»adphy
(

, 
MII_CTRL1000
);

1886 
giga_ù¾
 &ğ~(
ADVERTISE_1000FULL
 | 
ADVERTISE_1000HALF
);

1889 ià(

->
mii
.
suµÜts_gmii
) {

1890 ià(
adv
 & 
ADVERTISED_1000ba£T_H®f
)

1891 
giga_ù¾
 |ğ
ADVERTISE_1000HALF
;

1892 ià(
adv
 & 
ADVERTISED_1000ba£T_FuÎ
)

1893 
giga_ù¾
 |ğ
ADVERTISE_1000FULL
;

1894 } ià(
adv
 & (
ADVERTISED_1000ba£T_H®f
 |

1895 
ADVERTISED_1000ba£T_FuÎ
)) {

1896 
	`Ãtif_šfo
(

, 
lšk
, 
dev
,

1898 
out
;

1901 
bmü
 = 
BMCR_ANENABLE
 | 
BMCR_ANRESTART
;

1903 
	`¹l_wr™•hy
(

, 
MII_ADVERTISE
, 
auto_Ãgo
);

1904 
	`¹l_wr™•hy
(

, 
MII_CTRL1000
, 
giga_ù¾
);

1906 ià(
¥“d
 =ğ
SPEED_10
)

1907 
bmü
 = 0;

1908 ià(
¥“d
 =ğ
SPEED_100
)

1909 
bmü
 = 
BMCR_SPEED100
;

1911 
out
;

1913 ià(
du¶ex
 =ğ
DUPLEX_FULL
)

1914 
bmü
 |ğ
BMCR_FULLDPLX
;

1917 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
bmü
);

1919 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

1920 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
) {

1921 ià((
¥“d
 =ğ
SPEED_100
è&& (
autÚeg
 !ğ
AUTONEG_ENABLE
)) {

1922 
	`¹l_wr™•hy
(

, 0x17, 0x2138);

1923 
	`¹l_wr™•hy
(

, 0x0e, 0x0260);

1925 
	`¹l_wr™•hy
(

, 0x17, 0x2108);

1926 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

1930 
rc
 = 0;

1931 
out
:

1932  
rc
;

1933 
	}
}

1935 
	$¹l8169_£t_¥“d
(
Ãt_deviû
 *
dev
,

1936 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
adv”tisšg
)

1938 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1939 
»t
;

1941 
»t
 = 

->
	`£t_¥“d
(
dev
, 
autÚeg
, 
¥“d
, 
du¶ex
, 
adv”tisšg
);

1942 ià(
»t
 < 0)

1943 
out
;

1945 ià(
	`Ãtif_ruÂšg
(
dev
è&& (
autÚeg
 =ğ
AUTONEG_ENABLE
) &&

1946 (
adv”tisšg
 & 
ADVERTISED_1000ba£T_FuÎ
) &&

1947 !
	`pci_is_pc›
(

->
pci_dev
)) {

1948 
	`mod_tim”
(&

->
tim”
, 
jiff›s
 + 
RTL8169_PHY_TIMEOUT
);

1950 
out
:

1951  
»t
;

1952 
	}
}

1954 
Ãtdev_ã©u»s_t
 
	$¹l8169_fix_ã©u»s
(
Ãt_deviû
 *
dev
,

1955 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1957 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1959 ià(
dev
->
mtu
 > 
TD_MSS_MAX
)

1960 
ã©u»s
 &ğ~
NETIF_F_ALL_TSO
;

1962 ià(
dev
->
mtu
 > 
JUMBO_1K
 &&

1963 !
¹l_ch_šfos
[

->
mac_v”siÚ
].
jumbo_tx_csum
)

1964 
ã©u»s
 &ğ~
NETIF_F_IP_CSUM
;

1966  
ã©u»s
;

1967 
	}
}

1969 
	$__¹l8169_£t_ã©u»s
(
Ãt_deviû
 *
dev
,

1970 
Ãtdev_ã©u»s_t
 
ã©u»s
)

1972 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1973 
u32
 
rx_cÚfig
;

1975 
rx_cÚfig
 = 
	`RTL_R32
(

, 
RxCÚfig
);

1976 ià(
ã©u»s
 & 
NETIF_F_RXALL
)

1977 
rx_cÚfig
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

1979 
rx_cÚfig
 &ğ~(
Acû±E¼
 | 
Acû±RuÁ
);

1981 
	`RTL_W32
(

, 
RxCÚfig
, 
rx_cÚfig
);

1983 ià(
ã©u»s
 & 
NETIF_F_RXCSUM
)

1984 

->
ı_cmd
 |ğ
RxChkSum
;

1986 

->
ı_cmd
 &ğ~
RxChkSum
;

1988 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_RX
)

1989 

->
ı_cmd
 |ğ
RxVÏn
;

1991 

->
ı_cmd
 &ğ~
RxVÏn
;

1993 

->
ı_cmd
 |ğ
	`RTL_R16
Ñp, 
CPlusCmd
è& ~(
RxVÏn
 | 
RxChkSum
);

1995 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

1996 
	`RTL_R16
(

, 
CPlusCmd
);

1997 
	}
}

1999 
	$¹l8169_£t_ã©u»s
(
Ãt_deviû
 *
dev
,

2000 
Ãtdev_ã©u»s_t
 
ã©u»s
)

2002 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2004 
ã©u»s
 &ğ
NETIF_F_RXALL
 | 
NETIF_F_RXCSUM
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

2006 
	`¹l_lock_wÜk
(

);

2007 ià(
ã©u»s
 ^ 
dev
->features)

2008 
	`__¹l8169_£t_ã©u»s
(
dev
, 
ã©u»s
);

2009 
	`¹l_uÆock_wÜk
(

);

2012 
	}
}

2015 
šlše
 
u32
 
	$¹l8169_tx_vÏn_g
(
sk_buff
 *
skb
)

2017  (
	`skb_vÏn_g_´e£Á
(
skb
)) ?

2018 
TxVÏnTag
 | 
	`swab16
(
	`skb_vÏn_g_g‘
(
skb
)) : 0x00;

2019 
	}
}

2021 
	$¹l8169_rx_vÏn_g
(
RxDesc
 *
desc
, 
sk_buff
 *
skb
)

2023 
u32
 
İts2
 = 
	`Ë32_to_ıu
(
desc
->opts2);

2025 ià(
İts2
 & 
RxVÏnTag
)

2026 
	`__vÏn_hwacûl_put_g
(
skb
, 
	`htÚs
(
ETH_P_8021Q
), 
	`swab16
(
İts2
 & 0xffff));

2027 
	}
}

2029 
	$¹l8169_g‘_lšk_k£‰šgs_tbi
(
Ãt_deviû
 *
dev
,

2030 
‘htoŞ_lšk_k£‰šgs
 *
cmd
)

2032 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2033 
u32
 
¡©us
;

2034 
u32
 
suµÜ‹d
, 
adv”tisšg
;

2036 
suµÜ‹d
 =

2037 
SUPPORTED_1000ba£T_FuÎ
 | 
SUPPORTED_AutÚeg
 | 
SUPPORTED_FIBRE
;

2038 
cmd
->
ba£
.
pÜt
 = 
PORT_FIBRE
;

2040 
¡©us
 = 
	`RTL_R32
(

, 
TBICSR
);

2041 
adv”tisšg
 = (
¡©us
 & 
TBINwEÇbË
è? 
ADVERTISED_AutÚeg
 : 0;

2042 
cmd
->
ba£
.
autÚeg
 = !!(
¡©us
 & 
TBINwEÇbË
);

2044 
cmd
->
ba£
.
¥“d
 = 
SPEED_1000
;

2045 
cmd
->
ba£
.
du¶ex
 = 
DUPLEX_FULL
;

2047 
	`‘htoŞ_cÚv”t_Ëgacy_u32_to_lšk_mode
(
cmd
->
lšk_modes
.
suµÜ‹d
,

2048 
suµÜ‹d
);

2049 
	`‘htoŞ_cÚv”t_Ëgacy_u32_to_lšk_mode
(
cmd
->
lšk_modes
.
adv”tisšg
,

2050 
adv”tisšg
);

2053 
	}
}

2055 
	$¹l8169_g‘_lšk_k£‰šgs_xmii
(
Ãt_deviû
 *
dev
,

2056 
‘htoŞ_lšk_k£‰šgs
 *
cmd
)

2058 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2060 
	`mii_‘htoŞ_g‘_lšk_k£‰šgs
(&

->
mii
, 
cmd
);

2063 
	}
}

2065 
	$¹l8169_g‘_lšk_k£‰šgs
(
Ãt_deviû
 *
dev
,

2066 
‘htoŞ_lšk_k£‰šgs
 *
cmd
)

2068 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2069 
rc
;

2071 
	`¹l_lock_wÜk
(

);

2072 
rc
 = 

->
	`g‘_lšk_k£‰šgs
(
dev
, 
cmd
);

2073 
	`¹l_uÆock_wÜk
(

);

2075  
rc
;

2076 
	}
}

2078 
	$¹l8169_£t_lšk_k£‰šgs
(
Ãt_deviû
 *
dev
,

2079 cÚ¡ 
‘htoŞ_lšk_k£‰šgs
 *
cmd
)

2081 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2082 
rc
;

2083 
u32
 
adv”tisšg
;

2085 ià(!
	`‘htoŞ_cÚv”t_lšk_mode_to_Ëgacy_u32
(&
adv”tisšg
,

2086 
cmd
->
lšk_modes
.
adv”tisšg
))

2087  -
EINVAL
;

2089 
	`d–_tim”_sync
(&

->
tim”
);

2091 
	`¹l_lock_wÜk
(

);

2092 
rc
 = 
	`¹l8169_£t_¥“d
(
dev
, 
cmd
->
ba£
.
autÚeg
, cmd->ba£.
¥“d
,

2093 
cmd
->
ba£
.
du¶ex
, 
adv”tisšg
);

2094 
	`¹l_uÆock_wÜk
(

);

2096  
rc
;

2097 
	}
}

2099 
	$¹l8169_g‘_»gs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_»gs
 *
»gs
,

2100 *
p
)

2102 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2103 
u32
 
__iomem
 *
d©a
 = 

->
mmio_addr
;

2104 
u32
 *
dw
 = 
p
;

2105 
i
;

2107 
	`¹l_lock_wÜk
(

);

2108 
i
 = 0; i < 
R8169_REGS_SIZE
; i += 4)

2109 
	`memıy_äomio
(
dw
++, 
d©a
++, 4);

2110 
	`¹l_uÆock_wÜk
(

);

2111 
	}
}

2113 
u32
 
	$¹l8169_g‘_msgËv–
(
Ãt_deviû
 *
dev
)

2115 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2117  

->
msg_’abË
;

2118 
	}
}

2120 
	$¹l8169_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
v®ue
)

2122 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2124 

->
msg_’abË
 = 
v®ue
;

2125 
	}
}

2127 cÚ¡ 
	g¹l8169_g¡ršgs
[][
ETH_GSTRING_LEN
] = {

2143 
	$¹l8169_g‘_s£t_couÁ
(
Ãt_deviû
 *
dev
, 
s£t
)

2145 
s£t
) {

2146 
ETH_SS_STATS
:

2147  
	`ARRAY_SIZE
(
¹l8169_g¡ršgs
);

2149  -
EOPNOTSUPP
;

2151 
	}
}

2153 
	$DECLARE_RTL_COND
(
¹l_couÁ”s_cÚd
)

2155  
	`RTL_R32
(

, 
CouÁ”AddrLow
è& (
CouÁ”Re£t
 | 
CouÁ”Dump
);

2156 
	}
}

2158 
boŞ
 
	$¹l8169_do_couÁ”s
(
Ãt_deviû
 *
dev
, 
u32
 
couÁ”_cmd
)

2160 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2161 
dma_addr_t
 
·ddr
 = 

->
couÁ”s_phys_addr
;

2162 
u32
 
cmd
;

2164 
	`RTL_W32
(

, 
CouÁ”AddrHigh
, (
u64
)
·ddr
 >> 32);

2165 
	`RTL_R32
(

, 
CouÁ”AddrHigh
);

2166 
cmd
 = (
u64
)
·ddr
 & 
	`DMA_BIT_MASK
(32);

2167 
	`RTL_W32
(

, 
CouÁ”AddrLow
, 
cmd
);

2168 
	`RTL_W32
(

, 
CouÁ”AddrLow
, 
cmd
 | 
couÁ”_cmd
);

2170  
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_couÁ”s_cÚd
, 10, 1000);

2171 
	}
}

2173 
boŞ
 
	$¹l8169_»£t_couÁ”s
(
Ãt_deviû
 *
dev
)

2175 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2181 ià(

->
mac_v”siÚ
 < 
RTL_GIGA_MAC_VER_19
)

2182  
Œue
;

2184  
	`¹l8169_do_couÁ”s
(
dev
, 
CouÁ”Re£t
);

2185 
	}
}

2187 
boŞ
 
	$¹l8169_upd©e_couÁ”s
(
Ãt_deviû
 *
dev
)

2189 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2195 ià((
	`RTL_R8
(

, 
ChCmd
è& 
CmdRxEnb
) == 0)

2196  
Œue
;

2198  
	`¹l8169_do_couÁ”s
(
dev
, 
CouÁ”Dump
);

2199 
	}
}

2201 
boŞ
 
	$¹l8169_š™_couÁ”_off£ts
(
Ãt_deviû
 *
dev
)

2203 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2204 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

2205 
boŞ
 
»t
 = 
çl£
;

2222 ià(

->
tc_off£t
.
š™ed
)

2223  
Œue
;

2226 ià(
	`¹l8169_»£t_couÁ”s
(
dev
))

2227 
»t
 = 
Œue
;

2229 ià(
	`¹l8169_upd©e_couÁ”s
(
dev
))

2230 
»t
 = 
Œue
;

2232 

->
tc_off£t
.
tx_”rÜs
 = 
couÁ”s
->tx_errors;

2233 

->
tc_off£t
.
tx_muÉi_cŞlisiÚ
 = 
couÁ”s
->tx_multi_collision;

2234 

->
tc_off£t
.
tx_abÜ‹d
 = 
couÁ”s
->tx_aborted;

2235 

->
tc_off£t
.
š™ed
 = 
Œue
;

2237  
»t
;

2238 
	}
}

2240 
	$¹l8169_g‘_‘htoŞ_¡©s
(
Ãt_deviû
 *
dev
,

2241 
‘htoŞ_¡©s
 *
¡©s
, 
u64
 *
d©a
)

2243 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2244 
deviû
 *
d
 = 
	`_to_dev
(

);

2245 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

2247 
	`ASSERT_RTNL
();

2249 
	`pm_ruÁime_g‘_nÜesume
(
d
);

2251 ià(
	`pm_ruÁime_aùive
(
d
))

2252 
	`¹l8169_upd©e_couÁ”s
(
dev
);

2254 
	`pm_ruÁime_put_noidË
(
d
);

2256 
d©a
[0] = 
	`Ë64_to_ıu
(
couÁ”s
->
tx_·ck‘s
);

2257 
d©a
[1] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_·ck‘s
);

2258 
d©a
[2] = 
	`Ë64_to_ıu
(
couÁ”s
->
tx_”rÜs
);

2259 
d©a
[3] = 
	`Ë32_to_ıu
(
couÁ”s
->
rx_”rÜs
);

2260 
d©a
[4] = 
	`Ë16_to_ıu
(
couÁ”s
->
rx_mis£d
);

2261 
d©a
[5] = 
	`Ë16_to_ıu
(
couÁ”s
->
®ign_”rÜs
);

2262 
d©a
[6] = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_Úe_cŞlisiÚ
);

2263 
d©a
[7] = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_muÉi_cŞlisiÚ
);

2264 
d©a
[8] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_uniÿ¡
);

2265 
d©a
[9] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_brßdÿ¡
);

2266 
d©a
[10] = 
	`Ë32_to_ıu
(
couÁ”s
->
rx_muÉiÿ¡
);

2267 
d©a
[11] = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_abÜ‹d
);

2268 
d©a
[12] = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_und”un
);

2269 
	}
}

2271 
	$¹l8169_g‘_¡ršgs
(
Ãt_deviû
 *
dev
, 
u32
 
¡ršg£t
, 
u8
 *
d©a
)

2273 
¡ršg£t
) {

2274 
ETH_SS_STATS
:

2275 
	`memıy
(
d©a
, *
¹l8169_g¡ršgs
, (rtl8169_gstrings));

2278 
	}
}

2280 
	$¹l8169_nway_»£t
(
Ãt_deviû
 *
dev
)

2282 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2284  
	`mii_nway_»¡¬t
(&

->
mii
);

2285 
	}
}

2316 
	s¹l_cßËsû_sÿË
 {

2318 
u32
 
	mn£cs
[2];

2322 
	s¹l_cßËsû_šfo
 {

2323 
u32
 
	m¥“d
;

2324 
¹l_cßËsû_sÿË
 
	msÿËv
[4];

2328 
	#rxtx_x1822
(
r
, 
t
) { \

2329 {{(
r
), (
t
)}}, \

2330 {{(
r
)*8, (
t
)*8}}, \

2331 {{(
r
)*8*2, (
t
)*8*2}}, \

2332 {{(
r
)*8*2*2, (
t
)*8*2*2}}, \

2333 }

	)

2334 cÚ¡ 
¹l_cßËsû_šfo
 
	g¹l_cßËsû_šfo_8169
[] = {

2336 { 
SPEED_10
, 
rxtx_x1822
(40960, 40960) },

2337 { 
SPEED_100
, 
rxtx_x1822
( 2560, 2560) },

2338 { 
SPEED_1000
, 
rxtx_x1822
( 320, 320) },

2342 cÚ¡ 
¹l_cßËsû_šfo
 
	g¹l_cßËsû_šfo_8168_8136
[] = {

2344 { 
SPEED_10
, 
rxtx_x1822
(40960, 40960) },

2345 { 
SPEED_100
, 
rxtx_x1822
( 2560, 2560) },

2346 { 
SPEED_1000
, 
rxtx_x1822
( 5000, 5000) },

2349 #undeà
rxtx_x1822


2352 cÚ¡ 
¹l_cßËsû_šfo
 *
	$¹l_cßËsû_šfo
(
Ãt_deviû
 *
dev
)

2354 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2355 
‘htoŞ_lšk_k£‰šgs
 
ecmd
;

2356 cÚ¡ 
¹l_cßËsû_šfo
 *
ci
;

2357 
rc
;

2359 
rc
 = 
	`¹l8169_g‘_lšk_k£‰šgs
(
dev
, &
ecmd
);

2360 ià(
rc
 < 0)

2361  
	`ERR_PTR
(
rc
);

2363 
ci
 = 

->
cßËsû_šfo
; ci->
¥“d
 != 0; ci++) {

2364 ià(
ecmd
.
ba£
.
¥“d
 =ğ
ci
->speed) {

2365  
ci
;

2369  
	`ERR_PTR
(-
ELNRNG
);

2370 
	}
}

2372 
	$¹l_g‘_cßËsû
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cßËsû
 *
ec
)

2374 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2375 cÚ¡ 
¹l_cßËsû_šfo
 *
ci
;

2376 cÚ¡ 
¹l_cßËsû_sÿË
 *
sÿË
;

2378 
u32
 *
max_äames
;

2379 
u32
 *
u£cs
;

2380 } 
cßl_£‰šgs
 [] = {

2381 { &
ec
->
rx_max_cßËsûd_äames
, &ec->
rx_cßËsû_u£cs
 },

2382 { &
ec
->
tx_max_cßËsûd_äames
, &ec->
tx_cßËsû_u£cs
 }

2383 }, *
p
 = 
cßl_£‰šgs
;

2384 
i
;

2385 
u16
 
w
;

2387 
	`mem£t
(
ec
, 0, (*ec));

2390 
ci
 = 
	`¹l_cßËsû_šfo
(
dev
);

2391 ià(
	`IS_ERR
(
ci
))

2392  
	`PTR_ERR
(
ci
);

2394 
sÿË
 = &
ci
->
sÿËv
[
	`RTL_R16
(

, 
CPlusCmd
) & 3];

2397 
w
 = 
	`RTL_R16
(

, 
IÁrM™ig©e
); w; w >>ğ
RTL_COALESCE_SHIFT
, 
p
++) {

2398 *
p
->
max_äames
 = (
w
 & 
RTL_COALESCE_MASK
) << 2;

2399 
w
 >>ğ
RTL_COALESCE_SHIFT
;

2400 *
p
->
u£cs
 = 
w
 & 
RTL_COALESCE_MASK
;

2403 
i
 = 0; i < 2; i++) {

2404 
p
 = 
cßl_£‰šgs
 + 
i
;

2405 *
p
->
u£cs
 = (*p->u£c * 
sÿË
->
n£cs
[
i
]) / 1000;

2411 ià(!*
p
->
u£cs
 && !*p->
max_äames
)

2412 *
p
->
max_äames
 = 1;

2416 
	}
}

2419 cÚ¡ 
¹l_cßËsû_sÿË
 *
	$¹l_cßËsû_choo£_sÿË
(

2420 
Ãt_deviû
 *
dev
, 
u32
 
n£c
, 
u16
 *
ı01
)

2422 cÚ¡ 
¹l_cßËsû_šfo
 *
ci
;

2423 
u16
 
i
;

2425 
ci
 = 
	`¹l_cßËsû_šfo
(
dev
);

2426 ià(
	`IS_ERR
(
ci
))

2427  
	`ERR_CAST
(
ci
);

2429 
i
 = 0; i < 4; i++) {

2430 
u32
 
rxtx_maxsÿË
 = 
	`max
(
ci
->
sÿËv
[
i
].
n£cs
[0],

2431 
ci
->
sÿËv
[
i
].
n£cs
[1]);

2432 ià(
n£c
 <ğ
rxtx_maxsÿË
 * 
RTL_COALESCE_T_MAX
) {

2433 *
ı01
 = 
i
;

2434  &
ci
->
sÿËv
[
i
];

2438  
	`ERR_PTR
(-
EINVAL
);

2439 
	}
}

2441 
	$¹l_£t_cßËsû
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cßËsû
 *
ec
)

2443 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2444 cÚ¡ 
¹l_cßËsû_sÿË
 *
sÿË
;

2446 
u32
 
äames
;

2447 
u32
 
u£cs
;

2448 } 
cßl_£‰šgs
 [] = {

2449 { 
ec
->
rx_max_cßËsûd_äames
,ƒc->
rx_cßËsû_u£cs
 },

2450 { 
ec
->
tx_max_cßËsûd_äames
,ƒc->
tx_cßËsû_u£cs
 }

2451 }, *
p
 = 
cßl_£‰šgs
;

2452 
u16
 
w
 = 0, 
ı01
;

2453 
i
;

2455 
sÿË
 = 
	`¹l_cßËsû_choo£_sÿË
(
dev
,

2456 
	`max
(
p
[0].
u£cs
,…[1].u£csè* 1000, &
ı01
);

2457 ià(
	`IS_ERR
(
sÿË
))

2458  
	`PTR_ERR
(
sÿË
);

2460 
i
 = 0; i < 2; i++, 
p
++) {

2461 
u32
 
un™s
;

2475 ià(
p
->
äames
 == 1) {

2476 
p
->
äames
 = 0;

2479 
un™s
 = 
p
->
u£cs
 * 1000 / 
sÿË
->
n£cs
[
i
];

2480 ià(
p
->
äames
 > 
RTL_COALESCE_FRAME_MAX
 ||…->frames % 4)

2481  -
EINVAL
;

2483 
w
 <<ğ
RTL_COALESCE_SHIFT
;

2484 
w
 |ğ
un™s
;

2485 
w
 <<ğ
RTL_COALESCE_SHIFT
;

2486 
w
 |ğ
p
->
äames
 >> 2;

2489 
	`¹l_lock_wÜk
(

);

2491 
	`RTL_W16
(

, 
IÁrM™ig©e
, 
	`swab16
(
w
));

2493 

->
ı_cmd
 = (->ı_cmd & ~3è| 
ı01
;

2494 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

2495 
	`RTL_R16
(

, 
CPlusCmd
);

2497 
	`¹l_uÆock_wÜk
(

);

2500 
	}
}

2502 cÚ¡ 
‘htoŞ_İs
 
	g¹l8169_‘htoŞ_İs
 = {

2503 .
g‘_drvšfo
 = 
¹l8169_g‘_drvšfo
,

2504 .
	gg‘_»gs_Ën
 = 
¹l8169_g‘_»gs_Ën
,

2505 .
	gg‘_lšk
 = 
‘htoŞ_İ_g‘_lšk
,

2506 .
	gg‘_cßËsû
 = 
¹l_g‘_cßËsû
,

2507 .
	g£t_cßËsû
 = 
¹l_£t_cßËsû
,

2508 .
	gg‘_msgËv–
 = 
¹l8169_g‘_msgËv–
,

2509 .
	g£t_msgËv–
 = 
¹l8169_£t_msgËv–
,

2510 .
	gg‘_»gs
 = 
¹l8169_g‘_»gs
,

2511 .
	gg‘_wŞ
 = 
¹l8169_g‘_wŞ
,

2512 .
	g£t_wŞ
 = 
¹l8169_£t_wŞ
,

2513 .
	gg‘_¡ršgs
 = 
¹l8169_g‘_¡ršgs
,

2514 .
	gg‘_s£t_couÁ
 = 
¹l8169_g‘_s£t_couÁ
,

2515 .
	gg‘_‘htoŞ_¡©s
 = 
¹l8169_g‘_‘htoŞ_¡©s
,

2516 .
	gg‘_ts_šfo
 = 
‘htoŞ_İ_g‘_ts_šfo
,

2517 .
	gnway_»£t
 = 
¹l8169_nway_»£t
,

2518 .
	gg‘_lšk_k£‰šgs
 = 
¹l8169_g‘_lšk_k£‰šgs
,

2519 .
	g£t_lšk_k£‰šgs
 = 
¹l8169_£t_lšk_k£‰šgs
,

2522 
	$¹l8169_g‘_mac_v”siÚ
(
¹l8169_´iv©e
 *

,

2523 
Ãt_deviû
 *
dev
, 
u8
 
deçuÉ_v”siÚ
)

2536 cÚ¡ 
	s¹l_mac_šfo
 {

2537 
u32
 
mask
;

2538 
u32
 
v®
;

2539 
mac_v”siÚ
;

2540 } 
mac_šfo
[] = {

2542 { 0x7cf00000, 0x50200000, 
RTL_GIGA_MAC_VER_51
 },

2543 { 0x7cf00000, 0x50100000, 
RTL_GIGA_MAC_VER_50
 },

2544 { 0x7cf00000, 0x50000000, 
RTL_GIGA_MAC_VER_49
 },

2547 { 0x7cf00000, 0x54100000, 
RTL_GIGA_MAC_VER_46
 },

2548 { 0x7cf00000, 0x54000000, 
RTL_GIGA_MAC_VER_45
 },

2551 { 0x7cf00000, 0x5c800000, 
RTL_GIGA_MAC_VER_44
 },

2552 { 0x7cf00000, 0x50900000, 
RTL_GIGA_MAC_VER_42
 },

2553 { 0x7cf00000, 0x4c100000, 
RTL_GIGA_MAC_VER_41
 },

2554 { 0x7cf00000, 0x4c000000, 
RTL_GIGA_MAC_VER_40
 },

2557 { 0x7c800000, 0x48800000, 
RTL_GIGA_MAC_VER_38
 },

2558 { 0x7cf00000, 0x48100000, 
RTL_GIGA_MAC_VER_36
 },

2559 { 0x7cf00000, 0x48000000, 
RTL_GIGA_MAC_VER_35
 },

2562 { 0x7c800000, 0x2c800000, 
RTL_GIGA_MAC_VER_34
 },

2563 { 0x7cf00000, 0x2c200000, 
RTL_GIGA_MAC_VER_33
 },

2564 { 0x7cf00000, 0x2c100000, 
RTL_GIGA_MAC_VER_32
 },

2565 { 0x7c800000, 0x2c000000, 
RTL_GIGA_MAC_VER_33
 },

2568 { 0x7cf00000, 0x28300000, 
RTL_GIGA_MAC_VER_26
 },

2569 { 0x7cf00000, 0x28100000, 
RTL_GIGA_MAC_VER_25
 },

2570 { 0x7c800000, 0x28000000, 
RTL_GIGA_MAC_VER_26
 },

2573 { 0x7cf00000, 0x28800000, 
RTL_GIGA_MAC_VER_27
 },

2574 { 0x7cf00000, 0x28a00000, 
RTL_GIGA_MAC_VER_28
 },

2575 { 0x7cf00000, 0x28b00000, 
RTL_GIGA_MAC_VER_31
 },

2578 { 0x7cf00000, 0x3cb00000, 
RTL_GIGA_MAC_VER_24
 },

2579 { 0x7cf00000, 0x3c900000, 
RTL_GIGA_MAC_VER_23
 },

2580 { 0x7cf00000, 0x3c800000, 
RTL_GIGA_MAC_VER_18
 },

2581 { 0x7c800000, 0x3c800000, 
RTL_GIGA_MAC_VER_24
 },

2582 { 0x7cf00000, 0x3c000000, 
RTL_GIGA_MAC_VER_19
 },

2583 { 0x7cf00000, 0x3c200000, 
RTL_GIGA_MAC_VER_20
 },

2584 { 0x7cf00000, 0x3c300000, 
RTL_GIGA_MAC_VER_21
 },

2585 { 0x7cf00000, 0x3c400000, 
RTL_GIGA_MAC_VER_22
 },

2586 { 0x7c800000, 0x3c000000, 
RTL_GIGA_MAC_VER_22
 },

2589 { 0x7cf00000, 0x38000000, 
RTL_GIGA_MAC_VER_12
 },

2590 { 0x7cf00000, 0x38500000, 
RTL_GIGA_MAC_VER_17
 },

2591 { 0x7c800000, 0x38000000, 
RTL_GIGA_MAC_VER_17
 },

2592 { 0x7c800000, 0x30000000, 
RTL_GIGA_MAC_VER_11
 },

2595 { 0x7cf00000, 0x44900000, 
RTL_GIGA_MAC_VER_39
 },

2596 { 0x7c800000, 0x44800000, 
RTL_GIGA_MAC_VER_39
 },

2597 { 0x7c800000, 0x44000000, 
RTL_GIGA_MAC_VER_37
 },

2598 { 0x7cf00000, 0x40b00000, 
RTL_GIGA_MAC_VER_30
 },

2599 { 0x7cf00000, 0x40a00000, 
RTL_GIGA_MAC_VER_30
 },

2600 { 0x7cf00000, 0x40900000, 
RTL_GIGA_MAC_VER_29
 },

2601 { 0x7c800000, 0x40800000, 
RTL_GIGA_MAC_VER_30
 },

2602 { 0x7cf00000, 0x34a00000, 
RTL_GIGA_MAC_VER_09
 },

2603 { 0x7cf00000, 0x24a00000, 
RTL_GIGA_MAC_VER_09
 },

2604 { 0x7cf00000, 0x34900000, 
RTL_GIGA_MAC_VER_08
 },

2605 { 0x7cf00000, 0x24900000, 
RTL_GIGA_MAC_VER_08
 },

2606 { 0x7cf00000, 0x34800000, 
RTL_GIGA_MAC_VER_07
 },

2607 { 0x7cf00000, 0x24800000, 
RTL_GIGA_MAC_VER_07
 },

2608 { 0x7cf00000, 0x34000000, 
RTL_GIGA_MAC_VER_13
 },

2609 { 0x7cf00000, 0x34300000, 
RTL_GIGA_MAC_VER_10
 },

2610 { 0x7cf00000, 0x34200000, 
RTL_GIGA_MAC_VER_16
 },

2611 { 0x7c800000, 0x34800000, 
RTL_GIGA_MAC_VER_09
 },

2612 { 0x7c800000, 0x24800000, 
RTL_GIGA_MAC_VER_09
 },

2613 { 0x7c800000, 0x34000000, 
RTL_GIGA_MAC_VER_16
 },

2615 { 0xfc800000, 0x38800000, 
RTL_GIGA_MAC_VER_15
 },

2616 { 0xfc800000, 0x30800000, 
RTL_GIGA_MAC_VER_14
 },

2619 { 0xfc800000, 0x98000000, 
RTL_GIGA_MAC_VER_06
 },

2620 { 0xfc800000, 0x18000000, 
RTL_GIGA_MAC_VER_05
 },

2621 { 0xfc800000, 0x10000000, 
RTL_GIGA_MAC_VER_04
 },

2622 { 0xfc800000, 0x04000000, 
RTL_GIGA_MAC_VER_03
 },

2623 { 0xfc800000, 0x00800000, 
RTL_GIGA_MAC_VER_02
 },

2624 { 0xfc800000, 0x00000000, 
RTL_GIGA_MAC_VER_01
 },

2627 { 0x00000000, 0x00000000, 
RTL_GIGA_MAC_NONE
 }

2629 cÚ¡ 
¹l_mac_šfo
 *
p
 = 
mac_šfo
;

2630 
u32
 
»g
;

2632 
»g
 = 
	`RTL_R32
(

, 
TxCÚfig
);

2633 (
»g
 & 
p
->
mask
è!ğp->
v®
)

2634 
p
++;

2635 

->
mac_v”siÚ
 = 
p
->mac_version;

2637 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_NONE
) {

2638 
	`Ãtif_nÙiû
(

, 
´obe
, 
dev
,

2640 

->
mac_v”siÚ
 = 
deçuÉ_v”siÚ
;

2641 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
) {

2642 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2643 
RTL_GIGA_MAC_VER_42
 :

2644 
RTL_GIGA_MAC_VER_43
;

2645 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
) {

2646 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2647 
RTL_GIGA_MAC_VER_45
 :

2648 
RTL_GIGA_MAC_VER_47
;

2649 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
) {

2650 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2651 
RTL_GIGA_MAC_VER_46
 :

2652 
RTL_GIGA_MAC_VER_48
;

2654 
	}
}

2656 
	$¹l8169_´št_mac_v”siÚ
(
¹l8169_´iv©e
 *

)

2658 
	`d´štk
("mac_v”siÚ = 0x%02x\n", 

->
mac_v”siÚ
);

2659 
	}
}

2661 
	sphy_»g
 {

2662 
u16
 
	m»g
;

2663 
u16
 
	mv®
;

2666 
	$¹l_wr™•hy_b©ch
(
¹l8169_´iv©e
 *

,

2667 cÚ¡ 
phy_»g
 *
»gs
, 
Ën
)

2669 
Ën
-- > 0) {

2670 
	`¹l_wr™•hy
(

, 
»gs
->
»g
,„egs->
v®
);

2671 
»gs
++;

2673 
	}
}

2675 
	#PHY_READ
 0x00000000

	)

2676 
	#PHY_DATA_OR
 0x10000000

	)

2677 
	#PHY_DATA_AND
 0x20000000

	)

2678 
	#PHY_BJMPN
 0x30000000

	)

2679 
	#PHY_MDIO_CHG
 0x40000000

	)

2680 
	#PHY_CLEAR_READCOUNT
 0x70000000

	)

2681 
	#PHY_WRITE
 0x80000000

	)

2682 
	#PHY_READCOUNT_EQ_SKIP
 0x90000000

	)

2683 
	#PHY_COMP_EQ_SKIPN
 0xa0000000

	)

2684 
	#PHY_COMP_NEQ_SKIPN
 0xb0000000

	)

2685 
	#PHY_WRITE_PREVIOUS
 0xc0000000

	)

2686 
	#PHY_SKIPN
 0xd0000000

	)

2687 
	#PHY_DELAY_MS
 0xe0000000

	)

2689 
	sfw_šfo
 {

2690 
u32
 
	mmagic
;

2691 
	mv”siÚ
[
RTL_VER_SIZE
];

2692 
__Ë32
 
	mfw_¡¬t
;

2693 
__Ë32
 
	mfw_Ën
;

2694 
u8
 
	mchksum
;

2695 } 
	g__·cked
;

2697 
	#FW_OPCODE_SIZE
 (
	`ty³of
(*((
¹l_fw_phy_aùiÚ
 *)0)->
code
))

	)

2699 
boŞ
 
	$¹l_fw_fÜm©_ok
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2701 cÚ¡ 
fœmw¬e
 *
fw
 = 
¹l_fw
->fw;

2702 
fw_šfo
 *fw_šfØğ(fw_šfØ*)
fw
->
d©a
;

2703 
¹l_fw_phy_aùiÚ
 *
·
 = &
¹l_fw
->
phy_aùiÚ
;

2704 *
v”siÚ
 = 
¹l_fw
->version;

2705 
boŞ
 
rc
 = 
çl£
;

2707 ià(
fw
->
size
 < 
FW_OPCODE_SIZE
)

2708 
out
;

2710 ià(!
fw_šfo
->
magic
) {

2711 
size_t
 
i
, 
size
, 
¡¬t
;

2712 
u8
 
checksum
 = 0;

2714 ià(
fw
->
size
 < (*
fw_šfo
))

2715 
out
;

2717 
i
 = 0; i < 
fw
->
size
; i++)

2718 
checksum
 +ğ
fw
->
d©a
[
i
];

2719 ià(
checksum
 != 0)

2720 
out
;

2722 
¡¬t
 = 
	`Ë32_to_ıu
(
fw_šfo
->
fw_¡¬t
);

2723 ià(
¡¬t
 > 
fw
->
size
)

2724 
out
;

2726 
size
 = 
	`Ë32_to_ıu
(
fw_šfo
->
fw_Ën
);

2727 ià(
size
 > (
fw
->siz- 
¡¬t
è/ 
FW_OPCODE_SIZE
)

2728 
out
;

2730 
	`memıy
(
v”siÚ
, 
fw_šfo
->v”siÚ, 
RTL_VER_SIZE
);

2732 
·
->
code
 = (
__Ë32
 *)(
fw
->
d©a
 + 
¡¬t
);

2733 
·
->
size
 = size;

2735 ià(
fw
->
size
 % 
FW_OPCODE_SIZE
)

2736 
out
;

2738 
	`¡¾ıy
(
v”siÚ
, 
	`¹l_lookup_fœmw¬e_Çme
(

), 
RTL_VER_SIZE
);

2740 
·
->
code
 = (
__Ë32
 *)
fw
->
d©a
;

2741 
·
->
size
 = 
fw
->siz/ 
FW_OPCODE_SIZE
;

2743 
v”siÚ
[
RTL_VER_SIZE
 - 1] = 0;

2745 
rc
 = 
Œue
;

2746 
out
:

2747  
rc
;

2748 
	}
}

2750 
boŞ
 
	$¹l_fw_d©a_ok
(
¹l8169_´iv©e
 *

, 
Ãt_deviû
 *
dev
,

2751 
¹l_fw_phy_aùiÚ
 *
·
)

2753 
boŞ
 
rc
 = 
çl£
;

2754 
size_t
 
šdex
;

2756 
šdex
 = 0; index < 
·
->
size
; index++) {

2757 
u32
 
aùiÚ
 = 
	`Ë32_to_ıu
(
·
->
code
[
šdex
]);

2758 
u32
 
»gno
 = (
aùiÚ
 & 0x0fff0000) >> 16;

2760 
aùiÚ
 & 0xf0000000) {

2761 
PHY_READ
:

2762 
PHY_DATA_OR
:

2763 
PHY_DATA_AND
:

2764 
PHY_MDIO_CHG
:

2765 
PHY_CLEAR_READCOUNT
:

2766 
PHY_WRITE
:

2767 
PHY_WRITE_PREVIOUS
:

2768 
PHY_DELAY_MS
:

2771 
PHY_BJMPN
:

2772 ià(
»gno
 > 
šdex
) {

2773 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2775 
out
;

2778 
PHY_READCOUNT_EQ_SKIP
:

2779 ià(
šdex
 + 2 >ğ
·
->
size
) {

2780 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2782 
out
;

2785 
PHY_COMP_EQ_SKIPN
:

2786 
PHY_COMP_NEQ_SKIPN
:

2787 
PHY_SKIPN
:

2788 ià(
šdex
 + 1 + 
»gno
 >ğ
·
->
size
) {

2789 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2791 
out
;

2796 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2797 "Inv®id‡ùiÚ 0x%08x\n", 
aùiÚ
);

2798 
out
;

2801 
rc
 = 
Œue
;

2802 
out
:

2803  
rc
;

2804 
	}
}

2806 
	$¹l_check_fœmw¬e
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2808 
Ãt_deviû
 *
dev
 = 

->dev;

2809 
rc
 = -
EINVAL
;

2811 ià(!
	`¹l_fw_fÜm©_ok
(

, 
¹l_fw
)) {

2812 
	`Ãtif_”r
(

, 
ifup
, 
dev
, "invalid firmware\n");

2813 
out
;

2816 ià(
	`¹l_fw_d©a_ok
(

, 
dev
, &
¹l_fw
->
phy_aùiÚ
))

2817 
rc
 = 0;

2818 
out
:

2819  
rc
;

2820 
	}
}

2822 
	$¹l_phy_wr™e_fw
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2824 
¹l_fw_phy_aùiÚ
 *
·
 = &
¹l_fw
->
phy_aùiÚ
;

2825 
mdio_İs
 
Üg
, *
İs
 = &

->mdio_ops;

2826 
u32
 
´ed©a
, 
couÁ
;

2827 
size_t
 
šdex
;

2829 
´ed©a
 = 
couÁ
 = 0;

2830 
Üg
.
wr™e
 = 
İs
->write;

2831 
Üg
.
»ad
 = 
İs
->read;

2833 
šdex
 = 0; index < 
·
->
size
; ) {

2834 
u32
 
aùiÚ
 = 
	`Ë32_to_ıu
(
·
->
code
[
šdex
]);

2835 
u32
 
d©a
 = 
aùiÚ
 & 0x0000ffff;

2836 
u32
 
»gno
 = (
aùiÚ
 & 0x0fff0000) >> 16;

2838 ià(!
aùiÚ
)

2841 
aùiÚ
 & 0xf0000000) {

2842 
PHY_READ
:

2843 
´ed©a
 = 
	`¹l_»adphy
(

, 
»gno
);

2844 
couÁ
++;

2845 
šdex
++;

2847 
PHY_DATA_OR
:

2848 
´ed©a
 |ğ
d©a
;

2849 
šdex
++;

2851 
PHY_DATA_AND
:

2852 
´ed©a
 &ğ
d©a
;

2853 
šdex
++;

2855 
PHY_BJMPN
:

2856 
šdex
 -ğ
»gno
;

2858 
PHY_MDIO_CHG
:

2859 ià(
d©a
 == 0) {

2860 
İs
->
wr™e
 = 
Üg
.write;

2861 
İs
->
»ad
 = 
Üg
.read;

2862 } ià(
d©a
 == 1) {

2863 
İs
->
wr™e
 = 
mac_mcu_wr™e
;

2864 
İs
->
»ad
 = 
mac_mcu_»ad
;

2867 
šdex
++;

2869 
PHY_CLEAR_READCOUNT
:

2870 
couÁ
 = 0;

2871 
šdex
++;

2873 
PHY_WRITE
:

2874 
	`¹l_wr™•hy
(

, 
»gno
, 
d©a
);

2875 
šdex
++;

2877 
PHY_READCOUNT_EQ_SKIP
:

2878 
šdex
 +ğ(
couÁ
 =ğ
d©a
) ? 2 : 1;

2880 
PHY_COMP_EQ_SKIPN
:

2881 ià(
´ed©a
 =ğ
d©a
)

2882 
šdex
 +ğ
»gno
;

2883 
šdex
++;

2885 
PHY_COMP_NEQ_SKIPN
:

2886 ià(
´ed©a
 !ğ
d©a
)

2887 
šdex
 +ğ
»gno
;

2888 
šdex
++;

2890 
PHY_WRITE_PREVIOUS
:

2891 
	`¹l_wr™•hy
(

, 
»gno
, 
´ed©a
);

2892 
šdex
++;

2894 
PHY_SKIPN
:

2895 
šdex
 +ğ
»gno
 + 1;

2897 
PHY_DELAY_MS
:

2898 
	`md–ay
(
d©a
);

2899 
šdex
++;

2903 
	`BUG
();

2907 
İs
->
wr™e
 = 
Üg
.write;

2908 
İs
->
»ad
 = 
Üg
.read;

2909 
	}
}

2911 
	$¹l_»Ëa£_fœmw¬e
(
¹l8169_´iv©e
 *

)

2913 ià(!
	`IS_ERR_OR_NULL
(

->
¹l_fw
)) {

2914 
	`»Ëa£_fœmw¬e
(

->
¹l_fw
->
fw
);

2915 
	`kä“
(

->
¹l_fw
);

2917 

->
¹l_fw
 = 
RTL_FIRMWARE_UNKNOWN
;

2918 
	}
}

2920 
	$¹l_­¶y_fœmw¬e
(
¹l8169_´iv©e
 *

)

2922 
¹l_fw
 *¹l_fw = 

->rtl_fw;

2925 ià(!
	`IS_ERR_OR_NULL
(
¹l_fw
))

2926 
	`¹l_phy_wr™e_fw
(

, 
¹l_fw
);

2927 
	}
}

2929 
	$¹l_­¶y_fœmw¬e_cÚd
(
¹l8169_´iv©e
 *

, 
u8
 
»g
, 
u16
 
v®
)

2931 ià(
	`¹l_»adphy
(

, 
»g
è!ğ
v®
)

2932 
	`Ãtif_w¬n
(

, 
hw
,p->
dev
, "chipset‚ot„eady for firmware\n");

2934 
	`¹l_­¶y_fœmw¬e
(

);

2935 
	}
}

2937 
	$¹l8169s_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

2939 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3001 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3002 
	}
}

3004 
	$¹l8169sb_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3006 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3012 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3013 
	}
}

3015 
	$¹l8169scd_hw_phy_cÚfig_quœk
(
¹l8169_´iv©e
 *

)

3017 
pci_dev
 *
pdev
 = 

->pci_dev;

3019 ià((
pdev
->
subsy¡em_v’dÜ
 !ğ
PCI_VENDOR_ID_GIGABYTE
) ||

3020 (
pdev
->
subsy¡em_deviû
 != 0xe000))

3023 
	`¹l_wr™•hy
(

, 0x1f, 0x0001);

3024 
	`¹l_wr™•hy
(

, 0x10, 0xf01b);

3025 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3026 
	}
}

3028 
	$¹l8169scd_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3030 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3070 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3072 
	`¹l8169scd_hw_phy_cÚfig_quœk
(

);

3073 
	}
}

3075 
	$¹l8169sû_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3077 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3125 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3126 
	}
}

3128 
	$¹l8168bb_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3130 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3135 
	`¹l_wr™•hy
(

, 0x1f, 0x0001);

3136 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3138 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3139 
	}
}

3141 
	$¹l8168bef_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3143 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3149 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3150 
	}
}

3152 
	$¹l8168ı_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3154 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3162 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3163 
	}
}

3165 
	$¹l8168ı_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3167 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3173 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3174 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3175 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3177 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3178 
	}
}

3180 
	$¹l8168c_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3182 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3202 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3204 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3205 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3206 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3207 
	}
}

3209 
	$¹l8168c_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3211 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3229 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3231 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3232 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3233 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3234 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3235 
	}
}

3237 
	$¹l8168c_3_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3239 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3251 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3253 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3254 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3255 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3256 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3257 
	}
}

3259 
	$¹l8168c_4_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3261 
	`¹l8168c_3_hw_phy_cÚfig
(

);

3262 
	}
}

3264 
	$¹l8168d_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3266 cÚ¡ 
phy_»g
 
phy_»g_š™_0
[] = {

3307 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™_0
, 
	`ARRAY_SIZE
(phy_reg_init_0));

3313 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3314 
	`¹l_w0w1_phy
(

, 0x0b, 0x0010, 0x00ef);

3315 
	`¹l_w0w1_phy
(

, 0x0c, 0xa200, 0x5d00);

3317 ià(
	`¹l8168d_efu£_»ad
(

, 0x01) == 0xb1) {

3318 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3326 
v®
;

3328 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3330 
v®
 = 
	`¹l_»adphy
(

, 0x0d);

3332 ià((
v®
 & 0x00ff) != 0x006c) {

3333 cÚ¡ 
u32
 
£t
[] = {

3337 
i
;

3339 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3341 
v®
 &= 0xff00;

3342 
i
 = 0; i < 
	`ARRAY_SIZE
(
£t
); i++)

3343 
	`¹l_wr™•hy
(

, 0x0d, 
v®
 | 
£t
[
i
]);

3346 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3354 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3358 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3359 
	`¹l_·tchphy
(

, 0x0d, 0x0300);

3360 
	`¹l_·tchphy
(

, 0x0f, 0x0010);

3363 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3364 
	`¹l_w0w1_phy
(

, 0x02, 0x0100, 0x0600);

3365 
	`¹l_w0w1_phy
(

, 0x03, 0x0000, 0xe000);

3367 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3368 
	`¹l_wr™•hy
(

, 0x05, 0x001b);

3370 
	`¹l_­¶y_fœmw¬e_cÚd
(

, 
MII_EXPANSION
, 0xbf00);

3372 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3373 
	}
}

3375 
	$¹l8168d_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3377 cÚ¡ 
phy_»g
 
phy_»g_š™_0
[] = {

3418 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™_0
, 
	`ARRAY_SIZE
(phy_reg_init_0));

3420 ià(
	`¹l8168d_efu£_»ad
(

, 0x01) == 0xb1) {

3421 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3430 
v®
;

3432 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3434 
v®
 = 
	`¹l_»adphy
(

, 0x0d);

3435 ià((
v®
 & 0x00ff) != 0x006c) {

3436 cÚ¡ 
u32
 
£t
[] = {

3440 
i
;

3442 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3444 
v®
 &= 0xff00;

3445 
i
 = 0; i < 
	`ARRAY_SIZE
(
£t
); i++)

3446 
	`¹l_wr™•hy
(

, 0x0d, 
v®
 | 
£t
[
i
]);

3449 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3457 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3461 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3462 
	`¹l_w0w1_phy
(

, 0x02, 0x0100, 0x0600);

3463 
	`¹l_w0w1_phy
(

, 0x03, 0x0000, 0xe000);

3466 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3467 
	`¹l_·tchphy
(

, 0x0f, 0x0017);

3469 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3470 
	`¹l_wr™•hy
(

, 0x05, 0x001b);

3472 
	`¹l_­¶y_fœmw¬e_cÚd
(

, 
MII_EXPANSION
, 0xb300);

3474 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3475 
	}
}

3477 
	$¹l8168d_3_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3479 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3535 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3536 
	}
}

3538 
	$¹l8168d_4_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3540 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3550 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3551 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3552 
	}
}

3554 
	$¹l8168e_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3556 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3584 
	`¹l_­¶y_fœmw¬e
(

);

3586 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3589 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3590 
	`¹l_wr™•hy
(

, 0x1e, 0x0023);

3591 
	`¹l_w0w1_phy
(

, 0x17, 0x0006, 0x0000);

3592 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3595 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3596 
	`¹l_w0w1_phy
(

, 0x08, 0x8000, 0x7f00);

3597 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3600 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3601 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3602 
	`¹l_w0w1_phy
(

, 0x18, 0x0050, 0x0000);

3603 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3604 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3606 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3607 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3608 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3609 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3611 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3612 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3613 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x2000);

3614 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3615 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3616 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x1100);

3617 
	`¹l_wr™•hy
(

, 0x1f, 0x0006);

3618 
	`¹l_wr™•hy
(

, 0x00, 0x5a00);

3619 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3620 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3621 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3622 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3623 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

3624 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3625 
	}
}

3627 
	$¹l_¿r_exgmac_£t
(
¹l8169_´iv©e
 *

, 
u8
 *
addr
)

3629 cÚ¡ 
u16
 
w
[] = {

3630 
addr
[0] | (addr[1] << 8),

3631 
addr
[2] | (addr[3] << 8),

3632 
addr
[4] | (addr[5] << 8)

3634 cÚ¡ 
exgmac_»g
 
e
[] = {

3635 { .
addr
 = 0xe0, 
ERIAR_MASK_1111
, .
v®
 = 
w
[0] | (w[1] << 16) },

3636 { .
addr
 = 0xe4, 
ERIAR_MASK_1111
, .
v®
 = 
w
[2] },

3637 { .
addr
 = 0xf0, 
ERIAR_MASK_1111
, .
v®
 = 
w
[0] << 16 },

3638 { .
addr
 = 0xf4, 
ERIAR_MASK_1111
, .
v®
 = 
w
[1] | (w[2] << 16) }

3641 
	`¹l_wr™e_exgmac_b©ch
(

, 
e
, 
	`ARRAY_SIZE
(e));

3642 
	}
}

3644 
	$¹l8168e_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3646 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3673 
	`¹l_­¶y_fœmw¬e
(

);

3675 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3678 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3679 
	`¹l_wr™•hy
(

, 0x05, 0x8b80);

3680 
	`¹l_w0w1_phy
(

, 0x17, 0x0006, 0x0000);

3681 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3684 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3685 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3686 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3687 
	`¹l_w0w1_phy
(

, 0x18, 0x0010, 0x0000);

3688 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3689 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3690 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3693 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3694 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3695 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3696 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3699 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3700 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3701 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3702 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3705 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_1111
, 0x0003, 0x0000, 
ERIAR_EXGMAC
);

3706 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3707 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3708 
	`¹l_w0w1_phy
(

, 0x06, 0x2000, 0x0000);

3709 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3710 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3711 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3712 
	`¹l_w0w1_phy
(

, 0x15, 0x0100, 0x0000);

3713 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3714 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3715 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3716 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3717 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3718 
	`¹l_wr™•hy
(

, 0x0e, 0x0006);

3719 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3722 
	`¹l_wr™•hy
(

, 0x1f, 0x0003);

3723 
	`¹l_w0w1_phy
(

, 0x19, 0x0001, 0x0000);

3724 
	`¹l_w0w1_phy
(

, 0x10, 0x0400, 0x0000);

3725 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3726 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3727 
	`¹l_w0w1_phy
(

, 0x01, 0x0100, 0x0000);

3728 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3731 
	`¹l_¿r_exgmac_£t
(

,p->
dev
->
dev_addr
);

3732 
	}
}

3734 
	$¹l8168f_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3737 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3738 
	`¹l_wr™•hy
(

, 0x05, 0x8b80);

3739 
	`¹l_w0w1_phy
(

, 0x06, 0x0006, 0x0000);

3740 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3743 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3744 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3745 
	`¹l_w0w1_phy
(

, 0x18, 0x0010, 0x0000);

3746 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3747 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3750 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3751 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3752 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3753 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3754 
	}
}

3756 
	$¹l8168f_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3758 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3793 
	`¹l_­¶y_fœmw¬e
(

);

3795 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3797 
	`¹l8168f_hw_phy_cÚfig
(

);

3800 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3801 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3802 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3803 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3804 
	}
}

3806 
	$¹l8168f_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3808 
	`¹l_­¶y_fœmw¬e
(

);

3810 
	`¹l8168f_hw_phy_cÚfig
(

);

3811 
	}
}

3813 
	$¹l8411_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3815 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3851 
	`¹l_­¶y_fœmw¬e
(

);

3853 
	`¹l8168f_hw_phy_cÚfig
(

);

3856 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3857 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3858 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3859 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3861 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3864 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3865 
	`¹l_wr™•hy
(

, 0x05, 0x8b54);

3866 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0800);

3867 
	`¹l_wr™•hy
(

, 0x05, 0x8b5d);

3868 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0800);

3869 
	`¹l_wr™•hy
(

, 0x05, 0x8a7c);

3870 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3871 
	`¹l_wr™•hy
(

, 0x05, 0x8a7f);

3872 
	`¹l_w0w1_phy
(

, 0x06, 0x0100, 0x0000);

3873 
	`¹l_wr™•hy
(

, 0x05, 0x8a82);

3874 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3875 
	`¹l_wr™•hy
(

, 0x05, 0x8a85);

3876 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3877 
	`¹l_wr™•hy
(

, 0x05, 0x8a88);

3878 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3879 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3882 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3883 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3884 
	`¹l_w0w1_phy
(

, 0x06, 0x8000, 0x0000);

3885 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3888 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x00, 0x03, 
ERIAR_EXGMAC
);

3889 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3890 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3891 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x2000);

3892 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3893 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3894 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3895 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x0100);

3896 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3897 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3898 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3899 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3900 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

3901 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3904 
	`¹l_wr™•hy
(

, 0x1f, 0x0003);

3905 
	`¹l_w0w1_phy
(

, 0x19, 0x0000, 0x0001);

3906 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0400);

3907 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3908 
	}
}

3910 
	$¹l8168g_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3912 
	`¹l_­¶y_fœmw¬e
(

);

3914 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

3915 ià(
	`¹l_»adphy
(

, 0x10) & 0x0100) {

3916 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3917 
	`¹l_w0w1_phy
(

, 0x12, 0x0000, 0x8000);

3919 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3920 
	`¹l_w0w1_phy
(

, 0x12, 0x8000, 0x0000);

3923 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

3924 ià(
	`¹l_»adphy
(

, 0x13) & 0x0100) {

3925 
	`¹l_wr™•hy
(

, 0x1f, 0x0c41);

3926 
	`¹l_w0w1_phy
(

, 0x15, 0x0002, 0x0000);

3928 
	`¹l_wr™•hy
(

, 0x1f, 0x0c41);

3929 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x0002);

3933 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3934 
	`¹l_w0w1_phy
(

, 0x11, 0x000c, 0x0000);

3936 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3937 
	`¹l_w0w1_phy
(

, 0x14, 0x0100, 0x0000);

3938 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3939 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

3940 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3941 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

3942 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

3943 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

3946 
	`¹l_wr™•hy
(

, 0x1f, 0x0a4b);

3947 
	`¹l_w0w1_phy
(

, 0x11, 0x0004, 0x0000);

3950 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3951 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

3952 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3954 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

3955 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

3958 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

3959 
	`¹l_wr™•hy
(

, 0x14, 0x5065);

3960 
	`¹l_wr™•hy
(

, 0x14, 0xd065);

3961 
	`¹l_wr™•hy
(

, 0x1f, 0x0bc8);

3962 
	`¹l_wr™•hy
(

, 0x11, 0x5655);

3963 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

3964 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

3965 
	`¹l_wr™•hy
(

, 0x14, 0x9065);

3966 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

3969 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3970 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

3971 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

3973 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3974 
	}
}

3976 
	$¹l8168g_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3978 
	`¹l_­¶y_fœmw¬e
(

);

3979 
	}
}

3981 
	$¹l8168h_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3983 
u16
 
dout_pbš
;

3984 
u32
 
d©a
;

3986 
	`¹l_­¶y_fœmw¬e
(

);

3989 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3990 
	`¹l_wr™•hy
(

, 0x13, 0x809b);

3991 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0xf800);

3992 
	`¹l_wr™•hy
(

, 0x13, 0x80a2);

3993 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0xff00);

3994 
	`¹l_wr™•hy
(

, 0x13, 0x80a4);

3995 
	`¹l_w0w1_phy
(

, 0x14, 0x8500, 0xff00);

3996 
	`¹l_wr™•hy
(

, 0x13, 0x809c);

3997 
	`¹l_w0w1_phy
(

, 0x14, 0xbd00, 0xff00);

3998 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4001 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4002 
	`¹l_wr™•hy
(

, 0x13, 0x80ad);

4003 
	`¹l_w0w1_phy
(

, 0x14, 0x7000, 0xf800);

4004 
	`¹l_wr™•hy
(

, 0x13, 0x80b4);

4005 
	`¹l_w0w1_phy
(

, 0x14, 0x5000, 0xff00);

4006 
	`¹l_wr™•hy
(

, 0x13, 0x80ac);

4007 
	`¹l_w0w1_phy
(

, 0x14, 0x4000, 0xff00);

4008 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4011 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4012 
	`¹l_wr™•hy
(

, 0x13, 0x808e);

4013 
	`¹l_w0w1_phy
(

, 0x14, 0x1200, 0xff00);

4014 
	`¹l_wr™•hy
(

, 0x13, 0x8090);

4015 
	`¹l_w0w1_phy
(

, 0x14, 0xe500, 0xff00);

4016 
	`¹l_wr™•hy
(

, 0x13, 0x8092);

4017 
	`¹l_w0w1_phy
(

, 0x14, 0x9f00, 0xff00);

4018 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4021 
dout_pbš
 = 0;

4022 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

4023 
d©a
 = 
	`¹l_»adphy
(

, 0x13);

4024 
d©a
 &= 3;

4025 
d©a
 <<= 2;

4026 
dout_pbš
 |ğ
d©a
;

4027 
d©a
 = 
	`¹l_»adphy
(

, 0x12);

4028 
d©a
 &= 0xc000;

4029 
d©a
 >>= 14;

4030 
dout_pbš
 |ğ
d©a
;

4031 
dout_pbš
 = ~(dout_tapbin^0x08);

4032 
dout_pbš
 <<= 12;

4033 
dout_pbš
 &= 0xf000;

4034 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4035 
	`¹l_wr™•hy
(

, 0x13, 0x827a);

4036 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

4037 
	`¹l_wr™•hy
(

, 0x13, 0x827b);

4038 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

4039 
	`¹l_wr™•hy
(

, 0x13, 0x827c);

4040 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

4041 
	`¹l_wr™•hy
(

, 0x13, 0x827d);

4042 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

4044 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4045 
	`¹l_wr™•hy
(

, 0x13, 0x0811);

4046 
	`¹l_w0w1_phy
(

, 0x14, 0x0800, 0x0000);

4047 
	`¹l_wr™•hy
(

, 0x1f, 0x0a42);

4048 
	`¹l_w0w1_phy
(

, 0x16, 0x0002, 0x0000);

4049 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4052 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4053 
	`¹l_w0w1_phy
(

, 0x11, 0x0800, 0x0000);

4054 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4057 
	`¹l_wr™•hy
(

, 0x1f, 0x0bca);

4058 
	`¹l_w0w1_phy
(

, 0x17, 0x4000, 0x3000);

4059 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4061 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4062 
	`¹l_wr™•hy
(

, 0x13, 0x803f);

4063 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4064 
	`¹l_wr™•hy
(

, 0x13, 0x8047);

4065 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4066 
	`¹l_wr™•hy
(

, 0x13, 0x804f);

4067 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4068 
	`¹l_wr™•hy
(

, 0x13, 0x8057);

4069 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4070 
	`¹l_wr™•hy
(

, 0x13, 0x805f);

4071 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4072 
	`¹l_wr™•hy
(

, 0x13, 0x8067);

4073 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4074 
	`¹l_wr™•hy
(

, 0x13, 0x806f);

4075 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

4076 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4079 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4080 
	`¹l_w0w1_phy
(

, 0x11, 0x0000, 0x0080);

4081 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4084 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4085 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4086 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4088 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4089 
	}
}

4091 
	$¹l8168h_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4093 
u16
 
ioff£t_p3
, 
ioff£t_p2
, 
ioff£t_p1
, 
ioff£t_p0
;

4094 
u16
 
¾’
;

4095 
u32
 
d©a
;

4097 
	`¹l_­¶y_fœmw¬e
(

);

4100 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4101 
	`¹l_wr™•hy
(

, 0x13, 0x808a);

4102 
	`¹l_w0w1_phy
(

, 0x14, 0x000a, 0x003f);

4103 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4106 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4107 
	`¹l_wr™•hy
(

, 0x13, 0x0811);

4108 
	`¹l_w0w1_phy
(

, 0x14, 0x0800, 0x0000);

4109 
	`¹l_wr™•hy
(

, 0x1f, 0x0a42);

4110 
	`¹l_w0w1_phy
(

, 0x16, 0x0002, 0x0000);

4111 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4114 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4115 
	`¹l_w0w1_phy
(

, 0x11, 0x0800, 0x0000);

4116 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4118 
	`r8168_mac_oı_wr™e
(

, 0xdd02, 0x807d);

4119 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xdd02);

4120 
ioff£t_p3
 = ((
d©a
 & 0x80)>>7);

4121 
ioff£t_p3
 <<= 3;

4123 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xdd00);

4124 
ioff£t_p3
 |ğ((
d©a
 & (0xe000))>>13);

4125 
ioff£t_p2
 = ((
d©a
 & (0x1e00))>>9);

4126 
ioff£t_p1
 = ((
d©a
 & (0x01e0))>>5);

4127 
ioff£t_p0
 = ((
d©a
 & 0x0010)>>4);

4128 
ioff£t_p0
 <<= 3;

4129 
ioff£t_p0
 |ğ(
d©a
 & (0x07));

4130 
d©a
 = (
ioff£t_p3
<<12)|(
ioff£t_p2
<<8)|(
ioff£t_p1
<<4)|(
ioff£t_p0
);

4132 ià((
ioff£t_p3
 !ğ0x0fè|| (
ioff£t_p2
 != 0x0f) ||

4133 (
ioff£t_p1
 !ğ0x0fè|| (
ioff£t_p0
 != 0x0f)) {

4134 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcf);

4135 
	`¹l_wr™•hy
(

, 0x16, 
d©a
);

4136 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4140 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4141 
d©a
 = 
	`¹l_»adphy
(

, 0x16);

4142 
d©a
 &= 0x000f;

4143 
¾’
 = 0;

4144 ià(
d©a
 > 3)

4145 
¾’
 = 
d©a
 - 3;

4146 
d©a
 = 
¾’
 | (rlen<<4) | (rlen<<8) | (rlen<<12);

4147 
	`¹l_wr™•hy
(

, 0x17, 
d©a
);

4148 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4149 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4152 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4153 
	`¹l_w0w1_phy
(

, 0x11, 0x0000, 0x0080);

4154 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4157 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4158 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4159 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4161 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4162 
	}
}

4164 
	$¹l8168•_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4167 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4168 
	`¹l_w0w1_phy
(

, 0x11, 0x000c, 0x0000);

4169 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4172 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

4173 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x0100);

4174 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4175 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

4176 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4177 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

4178 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

4179 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

4180 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4183 
	`¹l_wr™•hy
(

, 0x1f, 0x0a4b);

4184 
	`¹l_w0w1_phy
(

, 0x11, 0x0004, 0x0000);

4185 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4188 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4189 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

4190 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

4191 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4194 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

4195 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

4196 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4199 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4200 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4201 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4203 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4204 
	}
}

4206 
	$¹l8168•_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4209 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

4210 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x0100);

4211 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4212 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

4213 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4214 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

4215 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

4216 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

4217 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4220 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4221 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

4222 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

4223 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4226 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

4227 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

4228 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4231 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4232 
	`¹l_wr™•hy
(

, 0x13, 0x80f3);

4233 
	`¹l_w0w1_phy
(

, 0x14, 0x8b00, ~0x8bff);

4234 
	`¹l_wr™•hy
(

, 0x13, 0x80f0);

4235 
	`¹l_w0w1_phy
(

, 0x14, 0x3a00, ~0x3aff);

4236 
	`¹l_wr™•hy
(

, 0x13, 0x80ef);

4237 
	`¹l_w0w1_phy
(

, 0x14, 0x0500, ~0x05ff);

4238 
	`¹l_wr™•hy
(

, 0x13, 0x80f6);

4239 
	`¹l_w0w1_phy
(

, 0x14, 0x6e00, ~0x6eff);

4240 
	`¹l_wr™•hy
(

, 0x13, 0x80ec);

4241 
	`¹l_w0w1_phy
(

, 0x14, 0x6800, ~0x68ff);

4242 
	`¹l_wr™•hy
(

, 0x13, 0x80ed);

4243 
	`¹l_w0w1_phy
(

, 0x14, 0x7c00, ~0x7cff);

4244 
	`¹l_wr™•hy
(

, 0x13, 0x80f2);

4245 
	`¹l_w0w1_phy
(

, 0x14, 0xf400, ~0xf4ff);

4246 
	`¹l_wr™•hy
(

, 0x13, 0x80f4);

4247 
	`¹l_w0w1_phy
(

, 0x14, 0x8500, ~0x85ff);

4248 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4249 
	`¹l_wr™•hy
(

, 0x13, 0x8110);

4250 
	`¹l_w0w1_phy
(

, 0x14, 0xa800, ~0xa8ff);

4251 
	`¹l_wr™•hy
(

, 0x13, 0x810f);

4252 
	`¹l_w0w1_phy
(

, 0x14, 0x1d00, ~0x1dff);

4253 
	`¹l_wr™•hy
(

, 0x13, 0x8111);

4254 
	`¹l_w0w1_phy
(

, 0x14, 0xf500, ~0xf5ff);

4255 
	`¹l_wr™•hy
(

, 0x13, 0x8113);

4256 
	`¹l_w0w1_phy
(

, 0x14, 0x6100, ~0x61ff);

4257 
	`¹l_wr™•hy
(

, 0x13, 0x8115);

4258 
	`¹l_w0w1_phy
(

, 0x14, 0x9200, ~0x92ff);

4259 
	`¹l_wr™•hy
(

, 0x13, 0x810e);

4260 
	`¹l_w0w1_phy
(

, 0x14, 0x0400, ~0x04ff);

4261 
	`¹l_wr™•hy
(

, 0x13, 0x810c);

4262 
	`¹l_w0w1_phy
(

, 0x14, 0x7c00, ~0x7cff);

4263 
	`¹l_wr™•hy
(

, 0x13, 0x810b);

4264 
	`¹l_w0w1_phy
(

, 0x14, 0x5a00, ~0x5aff);

4265 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4266 
	`¹l_wr™•hy
(

, 0x13, 0x80d1);

4267 
	`¹l_w0w1_phy
(

, 0x14, 0xff00, ~0xffff);

4268 
	`¹l_wr™•hy
(

, 0x13, 0x80cd);

4269 
	`¹l_w0w1_phy
(

, 0x14, 0x9e00, ~0x9eff);

4270 
	`¹l_wr™•hy
(

, 0x13, 0x80d3);

4271 
	`¹l_w0w1_phy
(

, 0x14, 0x0e00, ~0x0eff);

4272 
	`¹l_wr™•hy
(

, 0x13, 0x80d5);

4273 
	`¹l_w0w1_phy
(

, 0x14, 0xca00, ~0xcaff);

4274 
	`¹l_wr™•hy
(

, 0x13, 0x80d7);

4275 
	`¹l_w0w1_phy
(

, 0x14, 0x8400, ~0x84ff);

4278 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4279 
	`¹l_wr™•hy
(

, 0x14, 0x5065);

4280 
	`¹l_wr™•hy
(

, 0x14, 0xd065);

4281 
	`¹l_wr™•hy
(

, 0x1f, 0x0bc8);

4282 
	`¹l_wr™•hy
(

, 0x12, 0x00ed);

4283 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4284 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

4285 
	`¹l_wr™•hy
(

, 0x14, 0x9065);

4286 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

4287 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4290 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4291 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4292 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4294 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4295 
	}
}

4297 
	$¹l8102e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4299 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4306 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4307 
	`¹l_·tchphy
(

, 0x11, 1 << 12);

4308 
	`¹l_·tchphy
(

, 0x19, 1 << 13);

4309 
	`¹l_·tchphy
(

, 0x10, 1 << 15);

4311 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4312 
	}
}

4314 
	$¹l8105e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4316 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4331 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4332 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4333 
	`m¦“p
(100);

4335 
	`¹l_­¶y_fœmw¬e
(

);

4337 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4338 
	}
}

4340 
	$¹l8402_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4343 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4344 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4345 
	`m¦“p
(20);

4347 
	`¹l_­¶y_fœmw¬e
(

);

4350 
	`¹l_”i_wr™e
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4351 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

4352 
	`¹l_wr™•hy
(

, 0x10, 0x401f);

4353 
	`¹l_wr™•hy
(

, 0x19, 0x7030);

4354 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4355 
	}
}

4357 
	$¹l8106e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4359 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4367 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4368 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4369 
	`m¦“p
(100);

4371 
	`¹l_­¶y_fœmw¬e
(

);

4373 
	`¹l_”i_wr™e
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4374 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4376 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4377 
	}
}

4379 
	$¹l_hw_phy_cÚfig
(
Ãt_deviû
 *
dev
)

4381 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4383 
	`¹l8169_´št_mac_v”siÚ
(

);

4385 

->
mac_v”siÚ
) {

4386 
RTL_GIGA_MAC_VER_01
:

4388 
RTL_GIGA_MAC_VER_02
:

4389 
RTL_GIGA_MAC_VER_03
:

4390 
	`¹l8169s_hw_phy_cÚfig
(

);

4392 
RTL_GIGA_MAC_VER_04
:

4393 
	`¹l8169sb_hw_phy_cÚfig
(

);

4395 
RTL_GIGA_MAC_VER_05
:

4396 
	`¹l8169scd_hw_phy_cÚfig
(

);

4398 
RTL_GIGA_MAC_VER_06
:

4399 
	`¹l8169sû_hw_phy_cÚfig
(

);

4401 
RTL_GIGA_MAC_VER_07
:

4402 
RTL_GIGA_MAC_VER_08
:

4403 
RTL_GIGA_MAC_VER_09
:

4404 
	`¹l8102e_hw_phy_cÚfig
(

);

4406 
RTL_GIGA_MAC_VER_11
:

4407 
	`¹l8168bb_hw_phy_cÚfig
(

);

4409 
RTL_GIGA_MAC_VER_12
:

4410 
	`¹l8168bef_hw_phy_cÚfig
(

);

4412 
RTL_GIGA_MAC_VER_17
:

4413 
	`¹l8168bef_hw_phy_cÚfig
(

);

4415 
RTL_GIGA_MAC_VER_18
:

4416 
	`¹l8168ı_1_hw_phy_cÚfig
(

);

4418 
RTL_GIGA_MAC_VER_19
:

4419 
	`¹l8168c_1_hw_phy_cÚfig
(

);

4421 
RTL_GIGA_MAC_VER_20
:

4422 
	`¹l8168c_2_hw_phy_cÚfig
(

);

4424 
RTL_GIGA_MAC_VER_21
:

4425 
	`¹l8168c_3_hw_phy_cÚfig
(

);

4427 
RTL_GIGA_MAC_VER_22
:

4428 
	`¹l8168c_4_hw_phy_cÚfig
(

);

4430 
RTL_GIGA_MAC_VER_23
:

4431 
RTL_GIGA_MAC_VER_24
:

4432 
	`¹l8168ı_2_hw_phy_cÚfig
(

);

4434 
RTL_GIGA_MAC_VER_25
:

4435 
	`¹l8168d_1_hw_phy_cÚfig
(

);

4437 
RTL_GIGA_MAC_VER_26
:

4438 
	`¹l8168d_2_hw_phy_cÚfig
(

);

4440 
RTL_GIGA_MAC_VER_27
:

4441 
	`¹l8168d_3_hw_phy_cÚfig
(

);

4443 
RTL_GIGA_MAC_VER_28
:

4444 
	`¹l8168d_4_hw_phy_cÚfig
(

);

4446 
RTL_GIGA_MAC_VER_29
:

4447 
RTL_GIGA_MAC_VER_30
:

4448 
	`¹l8105e_hw_phy_cÚfig
(

);

4450 
RTL_GIGA_MAC_VER_31
:

4453 
RTL_GIGA_MAC_VER_32
:

4454 
RTL_GIGA_MAC_VER_33
:

4455 
	`¹l8168e_1_hw_phy_cÚfig
(

);

4457 
RTL_GIGA_MAC_VER_34
:

4458 
	`¹l8168e_2_hw_phy_cÚfig
(

);

4460 
RTL_GIGA_MAC_VER_35
:

4461 
	`¹l8168f_1_hw_phy_cÚfig
(

);

4463 
RTL_GIGA_MAC_VER_36
:

4464 
	`¹l8168f_2_hw_phy_cÚfig
(

);

4467 
RTL_GIGA_MAC_VER_37
:

4468 
	`¹l8402_hw_phy_cÚfig
(

);

4471 
RTL_GIGA_MAC_VER_38
:

4472 
	`¹l8411_hw_phy_cÚfig
(

);

4475 
RTL_GIGA_MAC_VER_39
:

4476 
	`¹l8106e_hw_phy_cÚfig
(

);

4479 
RTL_GIGA_MAC_VER_40
:

4480 
	`¹l8168g_1_hw_phy_cÚfig
(

);

4482 
RTL_GIGA_MAC_VER_42
:

4483 
RTL_GIGA_MAC_VER_43
:

4484 
RTL_GIGA_MAC_VER_44
:

4485 
	`¹l8168g_2_hw_phy_cÚfig
(

);

4487 
RTL_GIGA_MAC_VER_45
:

4488 
RTL_GIGA_MAC_VER_47
:

4489 
	`¹l8168h_1_hw_phy_cÚfig
(

);

4491 
RTL_GIGA_MAC_VER_46
:

4492 
RTL_GIGA_MAC_VER_48
:

4493 
	`¹l8168h_2_hw_phy_cÚfig
(

);

4496 
RTL_GIGA_MAC_VER_49
:

4497 
	`¹l8168•_1_hw_phy_cÚfig
(

);

4499 
RTL_GIGA_MAC_VER_50
:

4500 
RTL_GIGA_MAC_VER_51
:

4501 
	`¹l8168•_2_hw_phy_cÚfig
(

);

4504 
RTL_GIGA_MAC_VER_41
:

4508 
	}
}

4510 
	$¹l_phy_wÜk
(
¹l8169_´iv©e
 *

)

4512 
tim”_li¡
 *
tim”
 = &

->timer;

4513 
timeout
 = 
RTL8169_PHY_TIMEOUT
;

4515 
	`as£¹
(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_01
);

4517 ià(

->
	`phy_»£t_³ndšg
(tp)) {

4522 
timeout
 = 
HZ
/10;

4523 
out_mod_tim”
;

4526 ià(

->
	`lšk_ok
(tp))

4529 
	`Ãtif_dbg
(

, 
lšk
,p->
dev
, "PHY„eset until†ink up\n");

4531 

->
	`phy_»£t_’abË
(tp);

4533 
out_mod_tim”
:

4534 
	`mod_tim”
(
tim”
, 
jiff›s
 + 
timeout
);

4535 
	}
}

4537 
	$¹l_scheduË_sk
(
¹l8169_´iv©e
 *

, 
¹l_æag
 
æag
)

4539 ià(!
	`‹¡_ªd_£t_b™
(
æag
, 

->
wk
.
æags
))

4540 
	`scheduË_wÜk
(&

->
wk
.
wÜk
);

4541 
	}
}

4543 
	$¹l8169_phy_tim”
(
tim”_li¡
 *
t
)

4545 
¹l8169_´iv©e
 *

 = 
	`äom_tim”
Ñp, 
t
, 
tim”
);

4547 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_PHY_PENDING
);

4548 
	}
}

4550 
	$DECLARE_RTL_COND
(
¹l_phy_»£t_cÚd
)

4552  

->
	`phy_»£t_³ndšg
(tp);

4553 
	}
}

4555 
	$¹l8169_phy_»£t
(
Ãt_deviû
 *
dev
,

4556 
¹l8169_´iv©e
 *

)

4558 

->
	`phy_»£t_’abË
(tp);

4559 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_phy_»£t_cÚd
, 1, 100);

4560 
	}
}

4562 
boŞ
 
	$¹l_tbi_’abËd
(
¹l8169_´iv©e
 *

)

4564  (

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
) &&

4565 (
	`RTL_R8
(

, 
PHY¡©us
è& 
TBI_EÇbË
);

4566 
	}
}

4568 
	$¹l8169_š™_phy
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

)

4570 
	`¹l_hw_phy_cÚfig
(
dev
);

4572 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
) {

4573 
	`d´štk
("Set MAC Reg C+CR Offset 0x82h = 0x01h\n");

4574 
	`RTL_W8
(

, 0x82, 0x01);

4577 
	`pci_wr™e_cÚfig_by‹
(

->
pci_dev
, 
PCI_LATENCY_TIMER
, 0x40);

4579 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
)

4580 
	`pci_wr™e_cÚfig_by‹
(

->
pci_dev
, 
PCI_CACHE_LINE_SIZE
, 0x08);

4582 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
) {

4583 
	`d´štk
("Set MAC Reg C+CR Offset 0x82h = 0x01h\n");

4584 
	`RTL_W8
(

, 0x82, 0x01);

4585 
	`d´štk
("Set PHY Reg 0x0bh = 0x00h\n");

4586 
	`¹l_wr™•hy
(

, 0x0b, 0x0000);

4589 
	`¹l8169_phy_»£t
(
dev
, 

);

4591 
	`¹l8169_£t_¥“d
(
dev
, 
AUTONEG_ENABLE
, 
SPEED_1000
, 
DUPLEX_FULL
,

4592 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4593 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
 |

4594 (

->
mii
.
suµÜts_gmii
 ?

4595 
ADVERTISED_1000ba£T_H®f
 |

4596 
ADVERTISED_1000ba£T_FuÎ
 : 0));

4598 ià(
	`¹l_tbi_’abËd
(

))

4599 
	`Ãtif_šfo
(

, 
lšk
, 
dev
, "TBI‡uto-negotiating\n");

4600 
	}
}

4602 
	$¹l_¿r_£t
(
¹l8169_´iv©e
 *

, 
u8
 *
addr
)

4604 
	`¹l_lock_wÜk
(

);

4606 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

4608 
	`RTL_W32
(

, 
MAC4
, 
addr
[4] |‡ddr[5] << 8);

4609 
	`RTL_R32
(

, 
MAC4
);

4611 
	`RTL_W32
(

, 
MAC0
, 
addr
[0] |‡ddr[1] << 8 |‡ddr[2] << 16 |‡ddr[3] << 24);

4612 
	`RTL_R32
(

, 
MAC0
);

4614 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
)

4615 
	`¹l_¿r_exgmac_£t
(

, 
addr
);

4617 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

4619 
	`¹l_uÆock_wÜk
(

);

4620 
	}
}

4622 
	$¹l_£t_mac_add»ss
(
Ãt_deviû
 *
dev
, *
p
)

4624 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4625 
deviû
 *
d
 = 
	`_to_dev
(

);

4626 
»t
;

4628 
»t
 = 
	`‘h_mac_addr
(
dev
, 
p
);

4629 ià(
»t
)

4630  
»t
;

4632 
	`pm_ruÁime_g‘_nÜesume
(
d
);

4634 ià(
	`pm_ruÁime_aùive
(
d
))

4635 
	`¹l_¿r_£t
(

, 
dev
->
dev_addr
);

4637 
	`pm_ruÁime_put_noidË
(
d
);

4640 
	}
}

4642 
	$¹l8169_ioùl
(
Ãt_deviû
 *
dev
, 
iäeq
 *
iä
, 
cmd
)

4644 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4645 
mii_ioùl_d©a
 *
d©a
 = 
	`if_mii
(
iä
);

4647  
	`Ãtif_ruÂšg
(
dev
è? 

->
	`do_ioùl
Ñp, 
d©a
, 
cmd
è: -
ENODEV
;

4648 
	}
}

4650 
	$¹l_xmii_ioùl
(
¹l8169_´iv©e
 *

,

4651 
mii_ioùl_d©a
 *
d©a
, 
cmd
)

4653 
cmd
) {

4654 
SIOCGMIIPHY
:

4655 
d©a
->
phy_id
 = 32;

4658 
SIOCGMIIREG
:

4659 
d©a
->
v®_out
 = 
	`¹l_»adphy
(

, d©a->
»g_num
 & 0x1f);

4662 
SIOCSMIIREG
:

4663 
	`¹l_wr™•hy
(

, 
d©a
->
»g_num
 & 0x1f, d©a->
v®_š
);

4666  -
EOPNOTSUPP
;

4667 
	}
}

4669 
	$¹l_tbi_ioùl
(
¹l8169_´iv©e
 *

, 
mii_ioùl_d©a
 *
d©a
, 
cmd
)

4671  -
EOPNOTSUPP
;

4672 
	}
}

4674 
	$¹l_š™_mdio_İs
(
¹l8169_´iv©e
 *

)

4676 
mdio_İs
 *
İs
 = &

->mdio_ops;

4678 

->
mac_v”siÚ
) {

4679 
RTL_GIGA_MAC_VER_27
:

4680 
İs
->
wr™e
 = 
r8168dp_1_mdio_wr™e
;

4681 
İs
->
»ad
 = 
r8168dp_1_mdio_»ad
;

4683 
RTL_GIGA_MAC_VER_28
:

4684 
RTL_GIGA_MAC_VER_31
:

4685 
İs
->
wr™e
 = 
r8168dp_2_mdio_wr™e
;

4686 
İs
->
»ad
 = 
r8168dp_2_mdio_»ad
;

4688 
RTL_GIGA_MAC_VER_40
:

4689 
RTL_GIGA_MAC_VER_41
:

4690 
RTL_GIGA_MAC_VER_42
:

4691 
RTL_GIGA_MAC_VER_43
:

4692 
RTL_GIGA_MAC_VER_44
:

4693 
RTL_GIGA_MAC_VER_45
:

4694 
RTL_GIGA_MAC_VER_46
:

4695 
RTL_GIGA_MAC_VER_47
:

4696 
RTL_GIGA_MAC_VER_48
:

4697 
RTL_GIGA_MAC_VER_49
:

4698 
RTL_GIGA_MAC_VER_50
:

4699 
RTL_GIGA_MAC_VER_51
:

4700 
İs
->
wr™e
 = 
r8168g_mdio_wr™e
;

4701 
İs
->
»ad
 = 
r8168g_mdio_»ad
;

4704 
İs
->
wr™e
 = 
r8169_mdio_wr™e
;

4705 
İs
->
»ad
 = 
r8169_mdio_»ad
;

4708 
	}
}

4710 
	$¹l_¥“d_down
(
¹l8169_´iv©e
 *

)

4712 
u32
 
adv
;

4713 
Ía
;

4715 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4716 
Ía
 = 
	`¹l_»adphy
(

, 
MII_LPA
);

4718 ià(
Ía
 & (
LPA_10HALF
 | 
LPA_10FULL
))

4719 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
;

4720 ià(
Ía
 & (
LPA_100HALF
 | 
LPA_100FULL
))

4721 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4722 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
;

4724 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4725 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
 |

4726 (

->
mii
.
suµÜts_gmii
 ?

4727 
ADVERTISED_1000ba£T_H®f
 |

4728 
ADVERTISED_1000ba£T_FuÎ
 : 0);

4730 
	`¹l8169_£t_¥“d
(

->
dev
, 
AUTONEG_ENABLE
, 
SPEED_1000
, 
DUPLEX_FULL
,

4731 
adv
);

4732 
	}
}

4734 
	$¹l_wŞ_su¥’d_quœk
(
¹l8169_´iv©e
 *

)

4736 

->
mac_v”siÚ
) {

4737 
RTL_GIGA_MAC_VER_25
:

4738 
RTL_GIGA_MAC_VER_26
:

4739 
RTL_GIGA_MAC_VER_29
:

4740 
RTL_GIGA_MAC_VER_30
:

4741 
RTL_GIGA_MAC_VER_32
:

4742 
RTL_GIGA_MAC_VER_33
:

4743 
RTL_GIGA_MAC_VER_34
:

4744 
RTL_GIGA_MAC_VER_37
:

4745 
RTL_GIGA_MAC_VER_38
:

4746 
RTL_GIGA_MAC_VER_39
:

4747 
RTL_GIGA_MAC_VER_40
:

4748 
RTL_GIGA_MAC_VER_41
:

4749 
RTL_GIGA_MAC_VER_42
:

4750 
RTL_GIGA_MAC_VER_43
:

4751 
RTL_GIGA_MAC_VER_44
:

4752 
RTL_GIGA_MAC_VER_45
:

4753 
RTL_GIGA_MAC_VER_46
:

4754 
RTL_GIGA_MAC_VER_47
:

4755 
RTL_GIGA_MAC_VER_48
:

4756 
RTL_GIGA_MAC_VER_49
:

4757 
RTL_GIGA_MAC_VER_50
:

4758 
RTL_GIGA_MAC_VER_51
:

4759 
	`RTL_W32
(

, 
RxCÚfig
, 
	`RTL_R32
(tp, RxConfig) |

4760 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
);

4765 
	}
}

4767 
boŞ
 
	$¹l_wŞ_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4769 ià(!(
	`__¹l8169_g‘_wŞ
(

è& 
WAKE_ANY
))

4770  
çl£
;

4772 
	`¹l_¥“d_down
(

);

4773 
	`¹l_wŞ_su¥’d_quœk
(

);

4775  
Œue
;

4776 
	}
}

4778 
	$r810x_phy_pow”_down
(
¹l8169_´iv©e
 *

)

4780 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4781 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_PDOWN
);

4782 
	}
}

4784 
	$r810x_phy_pow”_up
(
¹l8169_´iv©e
 *

)

4786 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4787 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
);

4788 
	}
}

4790 
	$r810x_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4792 ià(
	`¹l_wŞ_¶l_pow”_down
(

))

4795 
	`r810x_phy_pow”_down
(

);

4797 

->
mac_v”siÚ
) {

4798 
RTL_GIGA_MAC_VER_07
:

4799 
RTL_GIGA_MAC_VER_08
:

4800 
RTL_GIGA_MAC_VER_09
:

4801 
RTL_GIGA_MAC_VER_10
:

4802 
RTL_GIGA_MAC_VER_13
:

4803 
RTL_GIGA_MAC_VER_16
:

4806 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) & ~0x80);

4809 
	}
}

4811 
	$r810x_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4813 
	`r810x_phy_pow”_up
(

);

4815 

->
mac_v”siÚ
) {

4816 
RTL_GIGA_MAC_VER_07
:

4817 
RTL_GIGA_MAC_VER_08
:

4818 
RTL_GIGA_MAC_VER_09
:

4819 
RTL_GIGA_MAC_VER_10
:

4820 
RTL_GIGA_MAC_VER_13
:

4821 
RTL_GIGA_MAC_VER_16
:

4823 
RTL_GIGA_MAC_VER_47
:

4824 
RTL_GIGA_MAC_VER_48
:

4825 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) | 0xc0);

4828 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) | 0x80);

4831 
	}
}

4833 
	$r8168_phy_pow”_up
(
¹l8169_´iv©e
 *

)

4835 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4836 

->
mac_v”siÚ
) {

4837 
RTL_GIGA_MAC_VER_11
:

4838 
RTL_GIGA_MAC_VER_12
:

4839 
RTL_GIGA_MAC_VER_17
:

4840 
RTL_GIGA_MAC_VER_18
:

4841 
RTL_GIGA_MAC_VER_19
:

4842 
RTL_GIGA_MAC_VER_20
:

4843 
RTL_GIGA_MAC_VER_21
:

4844 
RTL_GIGA_MAC_VER_22
:

4845 
RTL_GIGA_MAC_VER_23
:

4846 
RTL_GIGA_MAC_VER_24
:

4847 
RTL_GIGA_MAC_VER_25
:

4848 
RTL_GIGA_MAC_VER_26
:

4849 
RTL_GIGA_MAC_VER_27
:

4850 
RTL_GIGA_MAC_VER_28
:

4851 
RTL_GIGA_MAC_VER_31
:

4852 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

4857 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
);

4858 
	}
}

4860 
	$r8168_phy_pow”_down
(
¹l8169_´iv©e
 *

)

4862 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4863 

->
mac_v”siÚ
) {

4864 
RTL_GIGA_MAC_VER_32
:

4865 
RTL_GIGA_MAC_VER_33
:

4866 
RTL_GIGA_MAC_VER_40
:

4867 
RTL_GIGA_MAC_VER_41
:

4868 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
 | 
BMCR_PDOWN
);

4871 
RTL_GIGA_MAC_VER_11
:

4872 
RTL_GIGA_MAC_VER_12
:

4873 
RTL_GIGA_MAC_VER_17
:

4874 
RTL_GIGA_MAC_VER_18
:

4875 
RTL_GIGA_MAC_VER_19
:

4876 
RTL_GIGA_MAC_VER_20
:

4877 
RTL_GIGA_MAC_VER_21
:

4878 
RTL_GIGA_MAC_VER_22
:

4879 
RTL_GIGA_MAC_VER_23
:

4880 
RTL_GIGA_MAC_VER_24
:

4881 
RTL_GIGA_MAC_VER_25
:

4882 
RTL_GIGA_MAC_VER_26
:

4883 
RTL_GIGA_MAC_VER_27
:

4884 
RTL_GIGA_MAC_VER_28
:

4885 
RTL_GIGA_MAC_VER_31
:

4886 
	`¹l_wr™•hy
(

, 0x0e, 0x0200);

4888 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_PDOWN
);

4891 
	}
}

4893 
	$r8168_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4895 ià(
	`r8168_check_dash
(

))

4898 ià((

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_23
 ||

4899 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_24
) &&

4900 (
	`RTL_R16
(

, 
CPlusCmd
è& 
ASF
)) {

4904 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_32
 ||

4905 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_33
)

4906 
	`¹l_•hy_wr™e
(

, 0x19, 0xff64);

4908 ià(
	`¹l_wŞ_¶l_pow”_down
(

))

4911 
	`r8168_phy_pow”_down
(

);

4913 

->
mac_v”siÚ
) {

4914 
RTL_GIGA_MAC_VER_25
:

4915 
RTL_GIGA_MAC_VER_26
:

4916 
RTL_GIGA_MAC_VER_27
:

4917 
RTL_GIGA_MAC_VER_28
:

4918 
RTL_GIGA_MAC_VER_31
:

4919 
RTL_GIGA_MAC_VER_32
:

4920 
RTL_GIGA_MAC_VER_33
:

4921 
RTL_GIGA_MAC_VER_44
:

4922 
RTL_GIGA_MAC_VER_45
:

4923 
RTL_GIGA_MAC_VER_46
:

4924 
RTL_GIGA_MAC_VER_50
:

4925 
RTL_GIGA_MAC_VER_51
:

4926 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) & ~0x80);

4928 
RTL_GIGA_MAC_VER_40
:

4929 
RTL_GIGA_MAC_VER_41
:

4930 
RTL_GIGA_MAC_VER_49
:

4931 
	`¹l_w0w1_”i
(

, 0x1a8, 
ERIAR_MASK_1111
, 0x00000000,

4932 0xfc000000, 
ERIAR_EXGMAC
);

4933 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) & ~0x80);

4936 
	}
}

4938 
	$r8168_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4940 

->
mac_v”siÚ
) {

4941 
RTL_GIGA_MAC_VER_25
:

4942 
RTL_GIGA_MAC_VER_26
:

4943 
RTL_GIGA_MAC_VER_27
:

4944 
RTL_GIGA_MAC_VER_28
:

4945 
RTL_GIGA_MAC_VER_31
:

4946 
RTL_GIGA_MAC_VER_32
:

4947 
RTL_GIGA_MAC_VER_33
:

4948 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) | 0x80);

4950 
RTL_GIGA_MAC_VER_44
:

4951 
RTL_GIGA_MAC_VER_45
:

4952 
RTL_GIGA_MAC_VER_46
:

4953 
RTL_GIGA_MAC_VER_50
:

4954 
RTL_GIGA_MAC_VER_51
:

4955 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) | 0xc0);

4957 
RTL_GIGA_MAC_VER_40
:

4958 
RTL_GIGA_MAC_VER_41
:

4959 
RTL_GIGA_MAC_VER_49
:

4960 
	`RTL_W8
(

, 
PMCH
, 
	`RTL_R8
(tp, PMCH) | 0xc0);

4961 
	`¹l_w0w1_”i
(

, 0x1a8, 
ERIAR_MASK_1111
, 0xfc000000,

4962 0x00000000, 
ERIAR_EXGMAC
);

4966 
	`r8168_phy_pow”_up
(

);

4967 
	}
}

4969 
	$¹l_g’”ic_İ
(
¹l8169_´iv©e
 *

,

4970 (*
İ
)(
¹l8169_´iv©e
 *))

4972 ià(
İ
)

4973 
	`İ
(

);

4974 
	}
}

4976 
	$¹l_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4978 
	`¹l_g’”ic_İ
(

,p->
¶l_pow”_İs
.
down
);

4979 
	}
}

4981 
	$¹l_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4983 
	`¹l_g’”ic_İ
(

,p->
¶l_pow”_İs
.
up
);

4986 
	`m¦“p
(20);

4987 
	}
}

4989 
	$¹l_š™_¶l_pow”_İs
(
¹l8169_´iv©e
 *

)

4991 
¶l_pow”_İs
 *
İs
 = &

->pll_power_ops;

4993 

->
mac_v”siÚ
) {

4994 
RTL_GIGA_MAC_VER_07
:

4995 
RTL_GIGA_MAC_VER_08
:

4996 
RTL_GIGA_MAC_VER_09
:

4997 
RTL_GIGA_MAC_VER_10
:

4998 
RTL_GIGA_MAC_VER_16
:

4999 
RTL_GIGA_MAC_VER_29
:

5000 
RTL_GIGA_MAC_VER_30
:

5001 
RTL_GIGA_MAC_VER_37
:

5002 
RTL_GIGA_MAC_VER_39
:

5003 
RTL_GIGA_MAC_VER_43
:

5004 
RTL_GIGA_MAC_VER_47
:

5005 
RTL_GIGA_MAC_VER_48
:

5006 
İs
->
down
 = 
r810x_¶l_pow”_down
;

5007 
İs
->
up
 = 
r810x_¶l_pow”_up
;

5010 
RTL_GIGA_MAC_VER_11
:

5011 
RTL_GIGA_MAC_VER_12
:

5012 
RTL_GIGA_MAC_VER_17
:

5013 
RTL_GIGA_MAC_VER_18
:

5014 
RTL_GIGA_MAC_VER_19
:

5015 
RTL_GIGA_MAC_VER_20
:

5016 
RTL_GIGA_MAC_VER_21
:

5017 
RTL_GIGA_MAC_VER_22
:

5018 
RTL_GIGA_MAC_VER_23
:

5019 
RTL_GIGA_MAC_VER_24
:

5020 
RTL_GIGA_MAC_VER_25
:

5021 
RTL_GIGA_MAC_VER_26
:

5022 
RTL_GIGA_MAC_VER_27
:

5023 
RTL_GIGA_MAC_VER_28
:

5024 
RTL_GIGA_MAC_VER_31
:

5025 
RTL_GIGA_MAC_VER_32
:

5026 
RTL_GIGA_MAC_VER_33
:

5027 
RTL_GIGA_MAC_VER_34
:

5028 
RTL_GIGA_MAC_VER_35
:

5029 
RTL_GIGA_MAC_VER_36
:

5030 
RTL_GIGA_MAC_VER_38
:

5031 
RTL_GIGA_MAC_VER_40
:

5032 
RTL_GIGA_MAC_VER_41
:

5033 
RTL_GIGA_MAC_VER_42
:

5034 
RTL_GIGA_MAC_VER_44
:

5035 
RTL_GIGA_MAC_VER_45
:

5036 
RTL_GIGA_MAC_VER_46
:

5037 
RTL_GIGA_MAC_VER_49
:

5038 
RTL_GIGA_MAC_VER_50
:

5039 
RTL_GIGA_MAC_VER_51
:

5040 
İs
->
down
 = 
r8168_¶l_pow”_down
;

5041 
İs
->
up
 = 
r8168_¶l_pow”_up
;

5045 
İs
->
down
 = 
NULL
;

5046 
İs
->
up
 = 
NULL
;

5049 
	}
}

5051 
	$¹l_š™_rxcfg
(
¹l8169_´iv©e
 *

)

5053 

->
mac_v”siÚ
) {

5054 
RTL_GIGA_MAC_VER_01
:

5055 
RTL_GIGA_MAC_VER_02
:

5056 
RTL_GIGA_MAC_VER_03
:

5057 
RTL_GIGA_MAC_VER_04
:

5058 
RTL_GIGA_MAC_VER_05
:

5059 
RTL_GIGA_MAC_VER_06
:

5060 
RTL_GIGA_MAC_VER_10
:

5061 
RTL_GIGA_MAC_VER_11
:

5062 
RTL_GIGA_MAC_VER_12
:

5063 
RTL_GIGA_MAC_VER_13
:

5064 
RTL_GIGA_MAC_VER_14
:

5065 
RTL_GIGA_MAC_VER_15
:

5066 
RTL_GIGA_MAC_VER_16
:

5067 
RTL_GIGA_MAC_VER_17
:

5068 
	`RTL_W32
(

, 
RxCÚfig
, 
RX_FIFO_THRESH
 | 
RX_DMA_BURST
);

5070 
RTL_GIGA_MAC_VER_18
:

5071 
RTL_GIGA_MAC_VER_19
:

5072 
RTL_GIGA_MAC_VER_20
:

5073 
RTL_GIGA_MAC_VER_21
:

5074 
RTL_GIGA_MAC_VER_22
:

5075 
RTL_GIGA_MAC_VER_23
:

5076 
RTL_GIGA_MAC_VER_24
:

5077 
RTL_GIGA_MAC_VER_34
:

5078 
RTL_GIGA_MAC_VER_35
:

5079 
	`RTL_W32
(

, 
RxCÚfig
, 
RX128_INT_EN
 | 
RX_MULTI_EN
 | 
RX_DMA_BURST
);

5081 
RTL_GIGA_MAC_VER_40
:

5082 
RTL_GIGA_MAC_VER_41
:

5083 
RTL_GIGA_MAC_VER_42
:

5084 
RTL_GIGA_MAC_VER_43
:

5085 
RTL_GIGA_MAC_VER_44
:

5086 
RTL_GIGA_MAC_VER_45
:

5087 
RTL_GIGA_MAC_VER_46
:

5088 
RTL_GIGA_MAC_VER_47
:

5089 
RTL_GIGA_MAC_VER_48
:

5090 
RTL_GIGA_MAC_VER_49
:

5091 
RTL_GIGA_MAC_VER_50
:

5092 
RTL_GIGA_MAC_VER_51
:

5093 
	`RTL_W32
(

, 
RxCÚfig
, 
RX128_INT_EN
 | 
RX_MULTI_EN
 | 
RX_DMA_BURST
 | 
RX_EARLY_OFF
);

5096 
	`RTL_W32
(

, 
RxCÚfig
, 
RX128_INT_EN
 | 
RX_DMA_BURST
);

5099 
	}
}

5101 
	$¹l8169_š™_ršg_šdexes
(
¹l8169_´iv©e
 *

)

5103 

->
dœty_tx
 =p->
cur_tx
 =p->
cur_rx
 = 0;

5104 
	}
}

5106 
	$¹l_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5108 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

5109 
	`¹l_g’”ic_İ
(

,p->
jumbo_İs
.
’abË
);

5110 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

5111 
	}
}

5113 
	$¹l_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5115 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

5116 
	`¹l_g’”ic_İ
(

,p->
jumbo_İs
.
di§bË
);

5117 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

5118 
	}
}

5120 
	$r8168c_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5122 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è| 
Jumbo_En0
);

5123 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
Ñp, CÚfig4è| 
Jumbo_En1
);

5124 
	`¹l_tx_³rfÜmªû_tw—k
(

, 
PCI_EXP_DEVCTL_READRQ_512B
);

5125 
	}
}

5127 
	$r8168c_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5129 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
Jumbo_En0
);

5130 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
Ñp, CÚfig4è& ~
Jumbo_En1
);

5131 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5132 
	}
}

5134 
	$r8168dp_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5136 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è| 
Jumbo_En0
);

5137 
	}
}

5139 
	$r8168dp_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5141 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
Jumbo_En0
);

5142 
	}
}

5144 
	$r8168e_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5146 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 0x3f);

5147 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è| 
Jumbo_En0
);

5148 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
(tp, Config4) | 0x01);

5149 
	`¹l_tx_³rfÜmªû_tw—k
(

, 
PCI_EXP_DEVCTL_READRQ_512B
);

5150 
	}
}

5152 
	$r8168e_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5154 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 0x0c);

5155 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
Jumbo_En0
);

5156 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
(tp, Config4) & ~0x01);

5157 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5158 
	}
}

5160 
	$r8168b_0_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5162 
	`¹l_tx_³rfÜmªû_tw—k
(

,

5163 
PCI_EXP_DEVCTL_READRQ_512B
 | 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5164 
	}
}

5166 
	$r8168b_0_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5168 
	`¹l_tx_³rfÜmªû_tw—k
(

,

5169 (0x5 << 
MAX_READ_REQUEST_SHIFT
è| 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5170 
	}
}

5172 
	$r8168b_1_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5174 
	`r8168b_0_hw_jumbo_’abË
(

);

5176 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
(tp, Config4) | (1 << 0));

5177 
	}
}

5179 
	$r8168b_1_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5181 
	`r8168b_0_hw_jumbo_di§bË
(

);

5183 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
(tp, Config4) & ~(1 << 0));

5184 
	}
}

5186 
	$¹l_š™_jumbo_İs
(
¹l8169_´iv©e
 *

)

5188 
jumbo_İs
 *
İs
 = &

->jumbo_ops;

5190 

->
mac_v”siÚ
) {

5191 
RTL_GIGA_MAC_VER_11
:

5192 
İs
->
di§bË
 = 
r8168b_0_hw_jumbo_di§bË
;

5193 
İs
->
’abË
 = 
r8168b_0_hw_jumbo_’abË
;

5195 
RTL_GIGA_MAC_VER_12
:

5196 
RTL_GIGA_MAC_VER_17
:

5197 
İs
->
di§bË
 = 
r8168b_1_hw_jumbo_di§bË
;

5198 
İs
->
’abË
 = 
r8168b_1_hw_jumbo_’abË
;

5200 
RTL_GIGA_MAC_VER_18
:

5201 
RTL_GIGA_MAC_VER_19
:

5202 
RTL_GIGA_MAC_VER_20
:

5203 
RTL_GIGA_MAC_VER_21
:

5204 
RTL_GIGA_MAC_VER_22
:

5205 
RTL_GIGA_MAC_VER_23
:

5206 
RTL_GIGA_MAC_VER_24
:

5207 
RTL_GIGA_MAC_VER_25
:

5208 
RTL_GIGA_MAC_VER_26
:

5209 
İs
->
di§bË
 = 
r8168c_hw_jumbo_di§bË
;

5210 
İs
->
’abË
 = 
r8168c_hw_jumbo_’abË
;

5212 
RTL_GIGA_MAC_VER_27
:

5213 
RTL_GIGA_MAC_VER_28
:

5214 
İs
->
di§bË
 = 
r8168dp_hw_jumbo_di§bË
;

5215 
İs
->
’abË
 = 
r8168dp_hw_jumbo_’abË
;

5217 
RTL_GIGA_MAC_VER_31
:

5218 
RTL_GIGA_MAC_VER_32
:

5219 
RTL_GIGA_MAC_VER_33
:

5220 
RTL_GIGA_MAC_VER_34
:

5221 
İs
->
di§bË
 = 
r8168e_hw_jumbo_di§bË
;

5222 
İs
->
’abË
 = 
r8168e_hw_jumbo_’abË
;

5229 
RTL_GIGA_MAC_VER_40
:

5230 
RTL_GIGA_MAC_VER_41
:

5231 
RTL_GIGA_MAC_VER_42
:

5232 
RTL_GIGA_MAC_VER_43
:

5233 
RTL_GIGA_MAC_VER_44
:

5234 
RTL_GIGA_MAC_VER_45
:

5235 
RTL_GIGA_MAC_VER_46
:

5236 
RTL_GIGA_MAC_VER_47
:

5237 
RTL_GIGA_MAC_VER_48
:

5238 
RTL_GIGA_MAC_VER_49
:

5239 
RTL_GIGA_MAC_VER_50
:

5240 
RTL_GIGA_MAC_VER_51
:

5242 
İs
->
di§bË
 = 
NULL
;

5243 
İs
->
’abË
 = 
NULL
;

5246 
	}
}

5248 
	$DECLARE_RTL_COND
(
¹l_chcmd_cÚd
)

5250  
	`RTL_R8
(

, 
ChCmd
è& 
CmdRe£t
;

5251 
	}
}

5253 
	$¹l_hw_»£t
(
¹l8169_´iv©e
 *

)

5255 
	`RTL_W8
(

, 
ChCmd
, 
CmdRe£t
);

5257 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_chcmd_cÚd
, 100, 100);

5258 
	}
}

5260 
	$¹l_»que¡_unÿched_fœmw¬e
(
¹l8169_´iv©e
 *

)

5262 
¹l_fw
 *rtl_fw;

5263 cÚ¡ *
Çme
;

5264 
rc
 = -
ENOMEM
;

5266 
Çme
 = 
	`¹l_lookup_fœmw¬e_Çme
(

);

5267 ià(!
Çme
)

5268 
out_no_fœmw¬e
;

5270 
¹l_fw
 = 
	`kz®loc
((*¹l_fw), 
GFP_KERNEL
);

5271 ià(!
¹l_fw
)

5272 
”r_w¬n
;

5274 
rc
 = 
	`»que¡_fœmw¬e
(&
¹l_fw
->
fw
, 
Çme
, 
	`_to_dev
(

));

5275 ià(
rc
 < 0)

5276 
”r_ä“
;

5278 
rc
 = 
	`¹l_check_fœmw¬e
(

, 
¹l_fw
);

5279 ià(
rc
 < 0)

5280 
”r_»Ëa£_fœmw¬e
;

5282 

->
¹l_fw
 =„tl_fw;

5283 
out
:

5286 
”r_»Ëa£_fœmw¬e
:

5287 
	`»Ëa£_fœmw¬e
(
¹l_fw
->
fw
);

5288 
”r_ä“
:

5289 
	`kä“
(
¹l_fw
);

5290 
”r_w¬n
:

5291 
	`Ãtif_w¬n
(

, 
ifup
,p->
dev
, "unableo†oad firmware…atch %s (%d)\n",

5292 
Çme
, 
rc
);

5293 
out_no_fœmw¬e
:

5294 

->
¹l_fw
 = 
NULL
;

5295 
out
;

5296 
	}
}

5298 
	$¹l_»que¡_fœmw¬e
(
¹l8169_´iv©e
 *

)

5300 ià(
	`IS_ERR
(

->
¹l_fw
))

5301 
	`¹l_»que¡_unÿched_fœmw¬e
(

);

5302 
	}
}

5304 
	$¹l_rx_şo£
(
¹l8169_´iv©e
 *

)

5306 
	`RTL_W32
(

, 
RxCÚfig
, 
	`RTL_R32
Ñp, RxCÚfigè& ~
RX_CONFIG_ACCEPT_MASK
);

5307 
	}
}

5309 
	$DECLARE_RTL_COND
(
¹l_Åq_cÚd
)

5311  
	`RTL_R8
(

, 
TxPŞl
è& 
NPQ
;

5312 
	}
}

5314 
	$DECLARE_RTL_COND
(
¹l_txcfg_em±y_cÚd
)

5316  
	`RTL_R32
(

, 
TxCÚfig
è& 
TXCFG_EMPTY
;

5317 
	}
}

5319 
	$¹l8169_hw_»£t
(
¹l8169_´iv©e
 *

)

5322 
	`¹l8169_œq_mask_ªd_ack
(

);

5324 
	`¹l_rx_şo£
(

);

5326 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_27
 ||

5327 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_28
 ||

5328 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
) {

5329 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_Åq_cÚd
, 20, 42*42);

5330 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
 ||

5331 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

5332 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
 ||

5333 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
 ||

5334 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
 ||

5335 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_40
 ||

5336 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_41
 ||

5337 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
 ||

5338 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_43
 ||

5339 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_44
 ||

5340 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
 ||

5341 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
 ||

5342 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_47
 ||

5343 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_48
 ||

5344 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

5345 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

5346 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) {

5347 
	`RTL_W8
(

, 
ChCmd
, 
	`RTL_R8
Ñp, ChCmdè| 
StİReq
);

5348 
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_txcfg_em±y_cÚd
, 100, 666);

5350 
	`RTL_W8
(

, 
ChCmd
, 
	`RTL_R8
Ñp, ChCmdè| 
StİReq
);

5351 
	`ud–ay
(100);

5354 
	`¹l_hw_»£t
(

);

5355 
	}
}

5357 
	$¹l_£t_rx_tx_cÚfig_»gi¡”s
(
¹l8169_´iv©e
 *

)

5360 
	`RTL_W32
(

, 
TxCÚfig
, (
TX_DMA_BURST
 << 
TxDMAShiá
) |

5361 (
IÁ”F¿meG­
 << 
TxIÁ”F¿meG­Shiá
));

5362 
	}
}

5364 
	$¹l_hw_¡¬t
(
Ãt_deviû
 *
dev
)

5366 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5368 

->
	`hw_¡¬t
(
dev
);

5370 
	`¹l_œq_’abË_®l
(

);

5371 
	}
}

5373 
	$¹l_£t_rx_tx_desc_»gi¡”s
(
¹l8169_´iv©e
 *

)

5380 
	`RTL_W32
(

, 
TxDescS¹AddrHigh
, ((
u64
è->
TxPhyAddr
) >> 32);

5381 
	`RTL_W32
(

, 
TxDescS¹AddrLow
, ((
u64
è->
TxPhyAddr
è& 
	`DMA_BIT_MASK
(32));

5382 
	`RTL_W32
(

, 
RxDescAddrHigh
, ((
u64
è->
RxPhyAddr
) >> 32);

5383 
	`RTL_W32
(

, 
RxDescAddrLow
, ((
u64
è->
RxPhyAddr
è& 
	`DMA_BIT_MASK
(32));

5384 
	}
}

5386 
u16
 
	$¹l_rw_ıluscmd
(
¹l8169_´iv©e
 *

)

5388 
u16
 
cmd
;

5390 
cmd
 = 
	`RTL_R16
(

, 
CPlusCmd
);

5391 
	`RTL_W16
(

, 
CPlusCmd
, 
cmd
);

5392  
cmd
;

5393 
	}
}

5395 
	$¹l_£t_rx_max_size
(
¹l8169_´iv©e
 *

, 
rx_buf_sz
)

5398 
	`RTL_W16
(

, 
RxMaxSize
, 
rx_buf_sz
 + 1);

5399 
	}
}

5401 
	$¹l8169_£t_magic_»g
(
¹l8169_´iv©e
 *

, 
mac_v”siÚ
)

5403 cÚ¡ 
	s¹l_cfg2_šfo
 {

5404 
u32
 
mac_v”siÚ
;

5405 
u32
 
şk
;

5406 
u32
 
v®
;

5407 } 
cfg2_šfo
 [] = {

5408 { 
RTL_GIGA_MAC_VER_05
, 
PCI_Clock_33MHz
, 0x000fff00 },

5409 { 
RTL_GIGA_MAC_VER_05
, 
PCI_Clock_66MHz
, 0x000fffff },

5410 { 
RTL_GIGA_MAC_VER_06
, 
PCI_Clock_33MHz
, 0x00ffff00 },

5411 { 
RTL_GIGA_MAC_VER_06
, 
PCI_Clock_66MHz
, 0x00ffffff }

5413 cÚ¡ 
¹l_cfg2_šfo
 *
p
 = 
cfg2_šfo
;

5414 
i
;

5415 
u32
 
şk
;

5417 
şk
 = 
	`RTL_R8
(

, 
CÚfig2
è& 
PCI_Clock_66MHz
;

5418 
i
 = 0; i < 
	`ARRAY_SIZE
(
cfg2_šfo
); i++, 
p
++) {

5419 ià((
p
->
mac_v”siÚ
 =ğmac_v”siÚè&& (p->
şk
 == clk)) {

5420 
	`RTL_W32
(

, 0x7c, 
p
->
v®
);

5424 
	}
}

5426 
	$¹l_£t_rx_mode
(
Ãt_deviû
 *
dev
)

5428 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5429 
u32
 
mc_f‹r
[2];

5430 
rx_mode
;

5431 
u32
 
tmp
 = 0;

5433 ià(
dev
->
æags
 & 
IFF_PROMISC
) {

5435 
	`Ãtif_nÙiû
(

, 
lšk
, 
dev
, "Promiscuous modeƒnabled\n");

5436 
rx_mode
 =

5437 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
 |

5438 
Acû±AÎPhys
;

5439 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5440 } ià((
	`Ãtdev_mc_couÁ
(
dev
è> 
muÉiÿ¡_f‹r_lim™
) ||

5441 (
dev
->
æags
 & 
IFF_ALLMULTI
)) {

5443 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
;

5444 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5446 
Ãtdev_hw_addr
 *
ha
;

5448 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

5449 
mc_f‹r
[1] = mc_filter[0] = 0;

5450 
	`Ãtdev_fÜ_—ch_mc_addr
(
ha
, 
dev
) {

5451 
b™_Ä
 = 
	`‘h”_üc
(
ETH_ALEN
, 
ha
->
addr
) >> 26;

5452 
mc_f‹r
[
b™_Ä
 >> 5] |= 1 << (bit_nr & 31);

5453 
rx_mode
 |ğ
Acû±MuÉiÿ¡
;

5457 ià(
dev
->
ã©u»s
 & 
NETIF_F_RXALL
)

5458 
rx_mode
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

5460 
tmp
 = (
	`RTL_R32
(

, 
RxCÚfig
è& ~
RX_CONFIG_ACCEPT_MASK
è| 
rx_mode
;

5462 ià(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_06
) {

5463 
u32
 
d©a
 = 
mc_f‹r
[0];

5465 
mc_f‹r
[0] = 
	`swab32
(mc_filter[1]);

5466 
mc_f‹r
[1] = 
	`swab32
(
d©a
);

5469 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
)

5470 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5472 
	`RTL_W32
(

, 
MAR0
 + 4, 
mc_f‹r
[1]);

5473 
	`RTL_W32
(

, 
MAR0
 + 0, 
mc_f‹r
[0]);

5475 
	`RTL_W32
(

, 
RxCÚfig
, 
tmp
);

5476 
	}
}

5478 
	$¹l_hw_¡¬t_8169
(
Ãt_deviû
 *
dev
)

5480 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5481 
pci_dev
 *
pdev
 = 

->pci_dev;

5483 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_05
) {

5484 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè| 
PCIMulRW
);

5485 
	`pci_wr™e_cÚfig_by‹
(
pdev
, 
PCI_CACHE_LINE_SIZE
, 0x08);

5488 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

5489 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
 ||

5490 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5491 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
 ||

5492 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_04
)

5493 
	`RTL_W8
(

, 
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

5495 
	`¹l_š™_rxcfg
(

);

5497 
	`RTL_W8
(

, 
E¬lyTxTh»s
, 
NoE¬lyTx
);

5499 
	`¹l_£t_rx_max_size
(

, 
rx_buf_sz
);

5501 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
 ||

5502 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5503 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
 ||

5504 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_04
)

5505 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

5507 

->
ı_cmd
 |ğ
	`¹l_rw_ıluscmd
Ñpè| 
PCIMulRW
;

5509 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5510 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
) {

5511 
	`d´štk
("Set MAC Reg C+CR Offset 0xe0. "

5513 

->
ı_cmd
 |= (1 << 14);

5516 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

5518 
	`¹l8169_£t_magic_»g
(

,p->
mac_v”siÚ
);

5524 
	`RTL_W16
(

, 
IÁrM™ig©e
, 0x0000);

5526 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

);

5528 ià(

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_01
 &&

5529 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_02
 &&

5530 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_03
 &&

5531 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_04
) {

5532 
	`RTL_W8
(

, 
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

5533 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

5536 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

5539 
	`RTL_R8
(

, 
IÁrMask
);

5541 
	`RTL_W32
(

, 
RxMis£d
, 0);

5543 
	`¹l_£t_rx_mode
(
dev
);

5546 
	`RTL_W16
(

, 
MuÉiIÁr
, 
	`RTL_R16
(tp, MultiIntr) & 0xf000);

5547 
	}
}

5549 
	$¹l_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5551 ià(

->
csi_İs
.
wr™e
)

5552 

->
csi_İs
.
	`wr™e
Ñp, 
addr
, 
v®ue
);

5553 
	}
}

5555 
u32
 
	$¹l_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5557  

->
csi_İs
.
»ad
 ?p->csi_İs.
	`»ad
Ñp, 
addr
) : ~0;

5558 
	}
}

5560 
	$¹l_csi_acûss_’abË
(
¹l8169_´iv©e
 *

, 
u32
 
b™s
)

5562 
u32
 
csi
;

5564 
csi
 = 
	`¹l_csi_»ad
(

, 0x070c) & 0x00ffffff;

5565 
	`¹l_csi_wr™e
(

, 0x070c, 
csi
 | 
b™s
);

5566 
	}
}

5568 
	$¹l_csi_acûss_’abË_1
(
¹l8169_´iv©e
 *

)

5570 
	`¹l_csi_acûss_’abË
(

, 0x17000000);

5571 
	}
}

5573 
	$¹l_csi_acûss_’abË_2
(
¹l8169_´iv©e
 *

)

5575 
	`¹l_csi_acûss_’abË
(

, 0x27000000);

5576 
	}
}

5578 
	$DECLARE_RTL_COND
(
¹l_csŸr_cÚd
)

5580  
	`RTL_R32
(

, 
CSIAR
è& 
CSIAR_FLAG
;

5581 
	}
}

5583 
	$r8169_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5585 
	`RTL_W32
(

, 
CSIDR
, 
v®ue
);

5586 
	`RTL_W32
(

, 
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5587 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5589 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5590 
	}
}

5592 
u32
 
	$r8169_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5594 
	`RTL_W32
(

, 
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
) |

5595 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5597  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5598 
	`RTL_R32
(

, 
CSIDR
) : ~0;

5599 
	}
}

5601 
	$r8402_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5603 
	`RTL_W32
(

, 
CSIDR
, 
v®ue
);

5604 
	`RTL_W32
(

, 
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5605 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
 |

5606 
CSIAR_FUNC_NIC
);

5608 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5609 
	}
}

5611 
u32
 
	$r8402_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5613 
	`RTL_W32
(

, 
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
è| 
CSIAR_FUNC_NIC
 |

5614 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5616  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5617 
	`RTL_R32
(

, 
CSIDR
) : ~0;

5618 
	}
}

5620 
	$r8411_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5622 
	`RTL_W32
(

, 
CSIDR
, 
v®ue
);

5623 
	`RTL_W32
(

, 
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5624 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
 |

5625 
CSIAR_FUNC_NIC2
);

5627 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5628 
	}
}

5630 
u32
 
	$r8411_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5632 
	`RTL_W32
(

, 
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
è| 
CSIAR_FUNC_NIC2
 |

5633 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5635  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5636 
	`RTL_R32
(

, 
CSIDR
) : ~0;

5637 
	}
}

5639 
	$¹l_š™_csi_İs
(
¹l8169_´iv©e
 *

)

5641 
csi_İs
 *
İs
 = &

->csi_ops;

5643 

->
mac_v”siÚ
) {

5644 
RTL_GIGA_MAC_VER_01
:

5645 
RTL_GIGA_MAC_VER_02
:

5646 
RTL_GIGA_MAC_VER_03
:

5647 
RTL_GIGA_MAC_VER_04
:

5648 
RTL_GIGA_MAC_VER_05
:

5649 
RTL_GIGA_MAC_VER_06
:

5650 
RTL_GIGA_MAC_VER_10
:

5651 
RTL_GIGA_MAC_VER_11
:

5652 
RTL_GIGA_MAC_VER_12
:

5653 
RTL_GIGA_MAC_VER_13
:

5654 
RTL_GIGA_MAC_VER_14
:

5655 
RTL_GIGA_MAC_VER_15
:

5656 
RTL_GIGA_MAC_VER_16
:

5657 
RTL_GIGA_MAC_VER_17
:

5658 
İs
->
wr™e
 = 
NULL
;

5659 
İs
->
»ad
 = 
NULL
;

5662 
RTL_GIGA_MAC_VER_37
:

5663 
RTL_GIGA_MAC_VER_38
:

5664 
İs
->
wr™e
 = 
r8402_csi_wr™e
;

5665 
İs
->
»ad
 = 
r8402_csi_»ad
;

5668 
RTL_GIGA_MAC_VER_44
:

5669 
İs
->
wr™e
 = 
r8411_csi_wr™e
;

5670 
İs
->
»ad
 = 
r8411_csi_»ad
;

5674 
İs
->
wr™e
 = 
r8169_csi_wr™e
;

5675 
İs
->
»ad
 = 
r8169_csi_»ad
;

5678 
	}
}

5680 
	s•hy_šfo
 {

5681 
	moff£t
;

5682 
u16
 
	mmask
;

5683 
u16
 
	mb™s
;

5686 
	$¹l_•hy_š™
(
¹l8169_´iv©e
 *

, cÚ¡ 
•hy_šfo
 *
e
,

5687 
Ën
)

5689 
u16
 
w
;

5691 
Ën
-- > 0) {

5692 
w
 = (
	`¹l_•hy_»ad
(

, 
e
->
off£t
è& ~e->
mask
è|ƒ->
b™s
;

5693 
	`¹l_•hy_wr™e
(

, 
e
->
off£t
, 
w
);

5694 
e
++;

5696 
	}
}

5698 
	$¹l_di§bË_şock_»que¡
(
¹l8169_´iv©e
 *

)

5700 
	`pc›_ÿ·b™y_ş—r_wÜd
(

->
pci_dev
, 
PCI_EXP_LNKCTL
,

5701 
PCI_EXP_LNKCTL_CLKREQ_EN
);

5702 
	}
}

5704 
	$¹l_’abË_şock_»que¡
(
¹l8169_´iv©e
 *

)

5706 
	`pc›_ÿ·b™y_£t_wÜd
(

->
pci_dev
, 
PCI_EXP_LNKCTL
,

5707 
PCI_EXP_LNKCTL_CLKREQ_EN
);

5708 
	}
}

5710 
	$¹l_pc›_¡©e_l2l3_’abË
(
¹l8169_´iv©e
 *

, 
boŞ
 
’abË
)

5712 
u8
 
d©a
;

5714 
d©a
 = 
	`RTL_R8
(

, 
CÚfig3
);

5716 ià(
’abË
)

5717 
d©a
 |ğ
Rdy_to_L23
;

5719 
d©a
 &ğ~
Rdy_to_L23
;

5721 
	`RTL_W8
(

, 
CÚfig3
, 
d©a
);

5722 
	}
}

5724 
	#R8168_CPCMD_QUIRK_MASK
 (\

5725 
EÇbËBi¡
 | \

5726 
Mac_dbgo_Û
 | \

5727 
FÜû_h®f_dup
 | \

5728 
FÜû_rxæow_’
 | \

5729 
FÜû_txæow_’
 | \

5730 
Cx¶_dbg_£l
 | \

5731 
ASF
 | \

5732 
PktCÁrDi§bË
 | \

5733 
Mac_dbgo_£l
)

	)

5735 
	$¹l_hw_¡¬t_8168bb
(
¹l8169_´iv©e
 *

)

5737 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

5739 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5741 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
) {

5742 
	`¹l_tx_³rfÜmªû_tw—k
(

, (0x5 << 
MAX_READ_REQUEST_SHIFT
) |

5743 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5745 
	}
}

5747 
	$¹l_hw_¡¬t_8168bef
(
¹l8169_´iv©e
 *

)

5749 
	`¹l_hw_¡¬t_8168bb
(

);

5751 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5753 
	`RTL_W8
(

, 
CÚfig4
, 
	`RTL_R8
(tp, Config4) & ~(1 << 0));

5754 
	}
}

5756 
	$__¹l_hw_¡¬t_8168ı
(
¹l8169_´iv©e
 *

)

5758 
	`RTL_W8
(

, 
CÚfig1
, 
	`RTL_R8
Ñp, CÚfig1è| 
S³ed_down
);

5760 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

5762 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5763 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5765 
	`¹l_di§bË_şock_»que¡
(

);

5767 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5768 
	}
}

5770 
	$¹l_hw_¡¬t_8168ı_1
(
¹l8169_´iv©e
 *

)

5772 cÚ¡ 
•hy_šfo
 
e_šfo_8168ı
[] = {

5780 
	`¹l_csi_acûss_’abË_2
(

);

5782 
	`¹l_•hy_š™
(

, 
e_šfo_8168ı
, 
	`ARRAY_SIZE
(e_info_8168cp));

5784 
	`__¹l_hw_¡¬t_8168ı
(

);

5785 
	}
}

5787 
	$¹l_hw_¡¬t_8168ı_2
(
¹l8169_´iv©e
 *

)

5789 
	`¹l_csi_acûss_’abË_2
(

);

5791 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

5793 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5794 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5796 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5797 
	}
}

5799 
	$¹l_hw_¡¬t_8168ı_3
(
¹l8169_´iv©e
 *

)

5801 
	`¹l_csi_acûss_’abË_2
(

);

5803 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

5806 
	`RTL_W8
(

, 
DBG_REG
, 0x20);

5808 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5810 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5811 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5813 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5814 
	}
}

5816 
	$¹l_hw_¡¬t_8168c_1
(
¹l8169_´iv©e
 *

)

5818 cÚ¡ 
•hy_šfo
 
e_šfo_8168c_1
[] = {

5824 
	`¹l_csi_acûss_’abË_2
(

);

5826 
	`RTL_W8
(

, 
DBG_REG
, 0x06 | 
FIX_NAK_1
 | 
FIX_NAK_2
);

5828 
	`¹l_•hy_š™
(

, 
e_šfo_8168c_1
, 
	`ARRAY_SIZE
(e_info_8168c_1));

5830 
	`__¹l_hw_¡¬t_8168ı
(

);

5831 
	}
}

5833 
	$¹l_hw_¡¬t_8168c_2
(
¹l8169_´iv©e
 *

)

5835 cÚ¡ 
•hy_šfo
 
e_šfo_8168c_2
[] = {

5840 
	`¹l_csi_acûss_’abË_2
(

);

5842 
	`¹l_•hy_š™
(

, 
e_šfo_8168c_2
, 
	`ARRAY_SIZE
(e_info_8168c_2));

5844 
	`__¹l_hw_¡¬t_8168ı
(

);

5845 
	}
}

5847 
	$¹l_hw_¡¬t_8168c_3
(
¹l8169_´iv©e
 *

)

5849 
	`¹l_hw_¡¬t_8168c_2
(

);

5850 
	}
}

5852 
	$¹l_hw_¡¬t_8168c_4
(
¹l8169_´iv©e
 *

)

5854 
	`¹l_csi_acûss_’abË_2
(

);

5856 
	`__¹l_hw_¡¬t_8168ı
(

);

5857 
	}
}

5859 
	$¹l_hw_¡¬t_8168d
(
¹l8169_´iv©e
 *

)

5861 
	`¹l_csi_acûss_’abË_2
(

);

5863 
	`¹l_di§bË_şock_»que¡
(

);

5865 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5867 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5868 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5870 
	`RTL_W16
(

, 
CPlusCmd
, 
	`RTL_R16
Ñp, CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5871 
	}
}

5873 
	$¹l_hw_¡¬t_8168dp
(
¹l8169_´iv©e
 *

)

5875 
	`¹l_csi_acûss_’abË_1
(

);

5877 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5878 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5880 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5882 
	`¹l_di§bË_şock_»que¡
(

);

5883 
	}
}

5885 
	$¹l_hw_¡¬t_8168d_4
(
¹l8169_´iv©e
 *

)

5887 cÚ¡ 
•hy_šfo
 
e_šfo_8168d_4
[] = {

5893 
	`¹l_csi_acûss_’abË_1
(

);

5895 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5897 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5899 
	`¹l_•hy_š™
(

, 
e_šfo_8168d_4
, 
	`ARRAY_SIZE
(e_info_8168d_4));

5901 
	`¹l_’abË_şock_»que¡
(

);

5902 
	}
}

5904 
	$¹l_hw_¡¬t_8168e_1
(
¹l8169_´iv©e
 *

)

5906 cÚ¡ 
•hy_šfo
 
e_šfo_8168e_1
[] = {

5922 
	`¹l_csi_acûss_’abË_2
(

);

5924 
	`¹l_•hy_š™
(

, 
e_šfo_8168e_1
, 
	`ARRAY_SIZE
(e_info_8168e_1));

5926 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5927 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5929 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

5931 
	`¹l_di§bË_şock_»que¡
(

);

5934 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè| 
TXPLA_RST
);

5935 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè& ~
TXPLA_RST
);

5937 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
Spi_’
);

5938 
	}
}

5940 
	$¹l_hw_¡¬t_8168e_2
(
¹l8169_´iv©e
 *

)

5942 cÚ¡ 
•hy_šfo
 
e_šfo_8168e_2
[] = {

5947 
	`¹l_csi_acûss_’abË_1
(

);

5949 
	`¹l_•hy_š™
(

, 
e_šfo_8168e_2
, 
	`ARRAY_SIZE
(e_info_8168e_2));

5951 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5952 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5954 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5955 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5956 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00100002, 
ERIAR_EXGMAC
);

5957 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

5958 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_1111
, 0x00000050, 
ERIAR_EXGMAC
);

5959 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_1111
, 0x07ff0060, 
ERIAR_EXGMAC
);

5960 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5961 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0xff00, 
ERIAR_EXGMAC
);

5963 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
E¬lySize
);

5965 
	`¹l_di§bË_şock_»que¡
(

);

5967 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

5968 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè& ~
NOW_IS_OOB
);

5971 
	`RTL_W8
(

, 
EEE_LED
, 
	`RTL_R8
(tp, EEE_LED) & ~0x07);

5973 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè| 
PFM_EN
);

5974 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè| 
PWM_EN
);

5975 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
Spi_’
);

5976 
	}
}

5978 
	$¹l_hw_¡¬t_8168f
(
¹l8169_´iv©e
 *

)

5980 
	`¹l_csi_acûss_’abË_2
(

);

5982 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5984 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5985 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5986 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00100002, 
ERIAR_EXGMAC
);

5987 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

5988 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

5989 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

5990 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5991 
	`¹l_w0w1_”i
(

, 0x1d0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5992 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_1111
, 0x00000050, 
ERIAR_EXGMAC
);

5993 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_1111
, 0x00000060, 
ERIAR_EXGMAC
);

5995 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
E¬lySize
);

5997 
	`¹l_di§bË_şock_»que¡
(

);

5999 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6000 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè& ~
NOW_IS_OOB
);

6001 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè| 
PFM_EN
);

6002 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè| 
PWM_EN
);

6003 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
Spi_’
);

6004 
	}
}

6006 
	$¹l_hw_¡¬t_8168f_1
(
¹l8169_´iv©e
 *

)

6008 cÚ¡ 
•hy_šfo
 
e_šfo_8168f_1
[] = {

6015 
	`¹l_hw_¡¬t_8168f
(

);

6017 
	`¹l_•hy_š™
(

, 
e_šfo_8168f_1
, 
	`ARRAY_SIZE
(e_info_8168f_1));

6019 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0xff00, 
ERIAR_EXGMAC
);

6022 
	`RTL_W8
(

, 
EEE_LED
, 
	`RTL_R8
(tp, EEE_LED) & ~0x07);

6023 
	}
}

6025 
	$¹l_hw_¡¬t_8411
(
¹l8169_´iv©e
 *

)

6027 cÚ¡ 
•hy_šfo
 
e_šfo_8168f_1
[] = {

6034 
	`¹l_hw_¡¬t_8168f
(

);

6035 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6037 
	`¹l_•hy_š™
(

, 
e_šfo_8168f_1
, 
	`ARRAY_SIZE
(e_info_8168f_1));

6039 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0x0000, 
ERIAR_EXGMAC
);

6040 
	}
}

6042 
	$¹l_hw_¡¬t_8168g
(
¹l8169_´iv©e
 *

)

6044 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6046 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x080002, 
ERIAR_EXGMAC
);

6047 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x38, 
ERIAR_EXGMAC
);

6048 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x48, 
ERIAR_EXGMAC
);

6049 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6051 
	`¹l_csi_acûss_’abË_1
(

);

6053 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6055 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6056 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6057 
	`¹l_”i_wr™e
(

, 0x2f8, 
ERIAR_MASK_0011
, 0x1d8f, 
ERIAR_EXGMAC
);

6059 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè& ~
RXDV_GATED_EN
);

6060 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
E¬lySize
);

6062 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6063 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6066 
	`RTL_W8
(

, 
EEE_LED
, 
	`RTL_R8
(tp, EEE_LED) & ~0x07);

6068 
	`¹l_w0w1_”i
(

, 0x2fc, 
ERIAR_MASK_0001
, 0x01, 0x06, 
ERIAR_EXGMAC
);

6069 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 0x1000, 
ERIAR_EXGMAC
);

6071 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6072 
	}
}

6074 
	$¹l_hw_¡¬t_8168g_1
(
¹l8169_´iv©e
 *

)

6076 cÚ¡ 
•hy_šfo
 
e_šfo_8168g_1
[] = {

6083 
	`¹l_hw_¡¬t_8168g
(

);

6086 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6087 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6088 
	`¹l_•hy_š™
(

, 
e_šfo_8168g_1
, 
	`ARRAY_SIZE
(e_info_8168g_1));

6089 
	}
}

6091 
	$¹l_hw_¡¬t_8168g_2
(
¹l8169_´iv©e
 *

)

6093 cÚ¡ 
•hy_šfo
 
e_šfo_8168g_2
[] = {

6100 
	`¹l_hw_¡¬t_8168g
(

);

6103 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6104 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6105 
	`¹l_•hy_š™
(

, 
e_šfo_8168g_2
, 
	`ARRAY_SIZE
(e_info_8168g_2));

6106 
	}
}

6108 
	$¹l_hw_¡¬t_8411_2
(
¹l8169_´iv©e
 *

)

6110 cÚ¡ 
•hy_šfo
 
e_šfo_8411_2
[] = {

6118 
	`¹l_hw_¡¬t_8168g
(

);

6121 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6122 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6123 
	`¹l_•hy_š™
(

, 
e_šfo_8411_2
, 
	`ARRAY_SIZE
(e_info_8411_2));

6124 
	}
}

6126 
	$¹l_hw_¡¬t_8168h_1
(
¹l8169_´iv©e
 *

)

6128 
rg_§w_út
;

6129 
u32
 
d©a
;

6130 cÚ¡ 
•hy_šfo
 
e_šfo_8168h_1
[] = {

6140 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6141 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6142 
	`¹l_•hy_š™
(

, 
e_šfo_8168h_1
, 
	`ARRAY_SIZE
(e_info_8168h_1));

6144 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6146 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x00080002, 
ERIAR_EXGMAC
);

6147 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x38, 
ERIAR_EXGMAC
);

6148 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x48, 
ERIAR_EXGMAC
);

6149 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6151 
	`¹l_csi_acûss_’abË_1
(

);

6153 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6155 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6156 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6158 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_1111
, 0x0010, 0x00, 
ERIAR_EXGMAC
);

6160 
	`¹l_w0w1_”i
(

, 0xd4, 
ERIAR_MASK_1111
, 0x1f00, 0x00, 
ERIAR_EXGMAC
);

6162 
	`¹l_”i_wr™e
(

, 0x5f0, 
ERIAR_MASK_0011
, 0x4f87, 
ERIAR_EXGMAC
);

6164 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè& ~
RXDV_GATED_EN
);

6165 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
E¬lySize
);

6167 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6168 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6171 
	`RTL_W8
(

, 
EEE_LED
, 
	`RTL_R8
(tp, EEE_LED) & ~0x07);

6173 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
PFM_EN
);

6174 
	`RTL_W8
(

, 
MISC_1
, 
	`RTL_R8
Ñp, MISC_1è& ~
PFM_D3COLD_EN
);

6176 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
TX_10M_PS_EN
);

6178 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 0x1000, 
ERIAR_EXGMAC
);

6180 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6182 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

6183 
rg_§w_út
 = (
	`¹l_»adphy
(

, 0x13) & 0x3fff);

6184 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

6185 ià(
rg_§w_út
 > 0) {

6186 
u16
 
sw_út_1ms_ši
;

6188 
sw_út_1ms_ši
 = 16000000/
rg_§w_út
;

6189 
sw_út_1ms_ši
 &= 0x0fff;

6190 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd412);

6191 
d©a
 &= ~0x0fff;

6192 
d©a
 |ğ
sw_út_1ms_ši
;

6193 
	`r8168_mac_oı_wr™e
(

, 0xd412, 
d©a
);

6196 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe056);

6197 
d©a
 &= ~0xf0;

6198 
d©a
 |= 0x70;

6199 
	`r8168_mac_oı_wr™e
(

, 0xe056, 
d©a
);

6201 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe052);

6202 
d©a
 &= ~0x6000;

6203 
d©a
 |= 0x8008;

6204 
	`r8168_mac_oı_wr™e
(

, 0xe052, 
d©a
);

6206 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe0d6);

6207 
d©a
 &= ~0x01ff;

6208 
d©a
 |= 0x017f;

6209 
	`r8168_mac_oı_wr™e
(

, 0xe0d6, 
d©a
);

6211 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd420);

6212 
d©a
 &= ~0x0fff;

6213 
d©a
 |= 0x047f;

6214 
	`r8168_mac_oı_wr™e
(

, 0xd420, 
d©a
);

6216 
	`r8168_mac_oı_wr™e
(

, 0xe63e, 0x0001);

6217 
	`r8168_mac_oı_wr™e
(

, 0xe63e, 0x0000);

6218 
	`r8168_mac_oı_wr™e
(

, 0xc094, 0x0000);

6219 
	`r8168_mac_oı_wr™e
(

, 0xc09e, 0x0000);

6220 
	}
}

6222 
	$¹l_hw_¡¬t_8168•
(
¹l8169_´iv©e
 *

)

6224 
	`¹l8168•_¡İ_cmac
(

);

6226 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6228 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x00080002, 
ERIAR_EXGMAC
);

6229 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x2f, 
ERIAR_EXGMAC
);

6230 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x5f, 
ERIAR_EXGMAC
);

6231 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6233 
	`¹l_csi_acûss_’abË_1
(

);

6235 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6237 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6238 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6240 
	`¹l_w0w1_”i
(

, 0xd4, 
ERIAR_MASK_1111
, 0x1f80, 0x00, 
ERIAR_EXGMAC
);

6242 
	`¹l_”i_wr™e
(

, 0x5f0, 
ERIAR_MASK_0011
, 0x4f87, 
ERIAR_EXGMAC
);

6244 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè& ~
RXDV_GATED_EN
);

6245 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
E¬lySize
);

6247 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6248 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6251 
	`RTL_W8
(

, 
EEE_LED
, 
	`RTL_R8
(tp, EEE_LED) & ~0x07);

6253 
	`¹l_w0w1_”i
(

, 0x2fc, 
ERIAR_MASK_0001
, 0x01, 0x06, 
ERIAR_EXGMAC
);

6255 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
TX_10M_PS_EN
);

6257 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6258 
	}
}

6260 
	$¹l_hw_¡¬t_8168•_1
(
¹l8169_´iv©e
 *

)

6262 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_1
[] = {

6271 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6272 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6273 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_1
, 
	`ARRAY_SIZE
(e_info_8168ep_1));

6275 
	`¹l_hw_¡¬t_8168•
(

);

6276 
	}
}

6278 
	$¹l_hw_¡¬t_8168•_2
(
¹l8169_´iv©e
 *

)

6280 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_2
[] = {

6287 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6288 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6289 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_2
, 
	`ARRAY_SIZE
(e_info_8168ep_2));

6291 
	`¹l_hw_¡¬t_8168•
(

);

6293 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
PFM_EN
);

6294 
	`RTL_W8
(

, 
MISC_1
, 
	`RTL_R8
Ñp, MISC_1è& ~
PFM_D3COLD_EN
);

6295 
	}
}

6297 
	$¹l_hw_¡¬t_8168•_3
(
¹l8169_´iv©e
 *

)

6299 
u32
 
d©a
;

6300 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_3
[] = {

6308 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
ClkReqEn
);

6309 
	`RTL_W8
(

, 
CÚfig5
, 
	`RTL_R8
Ñp, CÚfig5è& ~
ASPM_’
);

6310 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_3
, 
	`ARRAY_SIZE
(e_info_8168ep_3));

6312 
	`¹l_hw_¡¬t_8168•
(

);

6314 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
PFM_EN
);

6315 
	`RTL_W8
(

, 
MISC_1
, 
	`RTL_R8
Ñp, MISC_1è& ~
PFM_D3COLD_EN
);

6317 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd3e2);

6318 
d©a
 &= 0xf000;

6319 
d©a
 |= 0x0271;

6320 
	`r8168_mac_oı_wr™e
(

, 0xd3e2, 
d©a
);

6322 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd3e4);

6323 
d©a
 &= 0xff00;

6324 
	`r8168_mac_oı_wr™e
(

, 0xd3e4, 
d©a
);

6326 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe860);

6327 
d©a
 |= 0x0080;

6328 
	`r8168_mac_oı_wr™e
(

, 0xe860, 
d©a
);

6329 
	}
}

6331 
	$¹l_hw_¡¬t_8168
(
Ãt_deviû
 *
dev
)

6333 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6335 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

6337 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

6339 
	`¹l_£t_rx_max_size
(

, 
rx_buf_sz
);

6341 

->
ı_cmd
 |ğ
	`RTL_R16
Ñp, 
CPlusCmd
è| 
PktCÁrDi§bË
 | 
INTT_1
;

6343 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

6345 
	`RTL_W16
(

, 
IÁrM™ig©e
, 0x5151);

6348 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_11
) {

6349 

->
ev’t_¦ow
 |ğ
RxFIFOOv”
 | 
PCSTimeout
;

6350 

->
ev’t_¦ow
 &ğ~
RxOv”æow
;

6353 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

);

6355 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

6357 
	`RTL_R8
(

, 
IÁrMask
);

6359 

->
mac_v”siÚ
) {

6360 
RTL_GIGA_MAC_VER_11
:

6361 
	`¹l_hw_¡¬t_8168bb
(

);

6364 
RTL_GIGA_MAC_VER_12
:

6365 
RTL_GIGA_MAC_VER_17
:

6366 
	`¹l_hw_¡¬t_8168bef
(

);

6369 
RTL_GIGA_MAC_VER_18
:

6370 
	`¹l_hw_¡¬t_8168ı_1
(

);

6373 
RTL_GIGA_MAC_VER_19
:

6374 
	`¹l_hw_¡¬t_8168c_1
(

);

6377 
RTL_GIGA_MAC_VER_20
:

6378 
	`¹l_hw_¡¬t_8168c_2
(

);

6381 
RTL_GIGA_MAC_VER_21
:

6382 
	`¹l_hw_¡¬t_8168c_3
(

);

6385 
RTL_GIGA_MAC_VER_22
:

6386 
	`¹l_hw_¡¬t_8168c_4
(

);

6389 
RTL_GIGA_MAC_VER_23
:

6390 
	`¹l_hw_¡¬t_8168ı_2
(

);

6393 
RTL_GIGA_MAC_VER_24
:

6394 
	`¹l_hw_¡¬t_8168ı_3
(

);

6397 
RTL_GIGA_MAC_VER_25
:

6398 
RTL_GIGA_MAC_VER_26
:

6399 
RTL_GIGA_MAC_VER_27
:

6400 
	`¹l_hw_¡¬t_8168d
(

);

6403 
RTL_GIGA_MAC_VER_28
:

6404 
	`¹l_hw_¡¬t_8168d_4
(

);

6407 
RTL_GIGA_MAC_VER_31
:

6408 
	`¹l_hw_¡¬t_8168dp
(

);

6411 
RTL_GIGA_MAC_VER_32
:

6412 
RTL_GIGA_MAC_VER_33
:

6413 
	`¹l_hw_¡¬t_8168e_1
(

);

6415 
RTL_GIGA_MAC_VER_34
:

6416 
	`¹l_hw_¡¬t_8168e_2
(

);

6419 
RTL_GIGA_MAC_VER_35
:

6420 
RTL_GIGA_MAC_VER_36
:

6421 
	`¹l_hw_¡¬t_8168f_1
(

);

6424 
RTL_GIGA_MAC_VER_38
:

6425 
	`¹l_hw_¡¬t_8411
(

);

6428 
RTL_GIGA_MAC_VER_40
:

6429 
RTL_GIGA_MAC_VER_41
:

6430 
	`¹l_hw_¡¬t_8168g_1
(

);

6432 
RTL_GIGA_MAC_VER_42
:

6433 
	`¹l_hw_¡¬t_8168g_2
(

);

6436 
RTL_GIGA_MAC_VER_44
:

6437 
	`¹l_hw_¡¬t_8411_2
(

);

6440 
RTL_GIGA_MAC_VER_45
:

6441 
RTL_GIGA_MAC_VER_46
:

6442 
	`¹l_hw_¡¬t_8168h_1
(

);

6445 
RTL_GIGA_MAC_VER_49
:

6446 
	`¹l_hw_¡¬t_8168•_1
(

);

6449 
RTL_GIGA_MAC_VER_50
:

6450 
	`¹l_hw_¡¬t_8168•_2
(

);

6453 
RTL_GIGA_MAC_VER_51
:

6454 
	`¹l_hw_¡¬t_8168•_3
(

);

6458 
	`´štk
(
KERN_ERR
 
PFX
 "%s: unknown chipset (mac_version = %d).\n",

6459 
dev
->
Çme
, 

->
mac_v”siÚ
);

6463 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

6465 
	`RTL_W8
(

, 
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

6467 
	`¹l_£t_rx_mode
(
dev
);

6469 
	`RTL_W16
(

, 
MuÉiIÁr
, 
	`RTL_R16
(tp, MultiIntr) & 0xf000);

6470 
	}
}

6472 
	#R810X_CPCMD_QUIRK_MASK
 (\

6473 
EÇbËBi¡
 | \

6474 
Mac_dbgo_Û
 | \

6475 
FÜû_h®f_dup
 | \

6476 
FÜû_rxæow_’
 | \

6477 
FÜû_txæow_’
 | \

6478 
Cx¶_dbg_£l
 | \

6479 
ASF
 | \

6480 
PktCÁrDi§bË
 | \

6481 
Mac_dbgo_£l
)

	)

6483 
	$¹l_hw_¡¬t_8102e_1
(
¹l8169_´iv©e
 *

)

6485 cÚ¡ 
•hy_šfo
 
e_šfo_8102e_1
[] = {

6495 
u8
 
cfg1
;

6497 
	`¹l_csi_acûss_’abË_2
(

);

6499 
	`RTL_W8
(

, 
DBG_REG
, 
FIX_NAK_1
);

6501 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6503 
	`RTL_W8
(

, 
CÚfig1
,

6504 
LEDS1
 | 
LEDS0
 | 
S³ed_down
 | 
MEMMAP
 | 
IOMAP
 | 
VPD
 | 
PMEÇbË
);

6505 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

6507 
cfg1
 = 
	`RTL_R8
(

, 
CÚfig1
);

6508 ià((
cfg1
 & 
LEDS0
è&& (cfg1 & 
LEDS1
))

6509 
	`RTL_W8
(

, 
CÚfig1
, 
cfg1
 & ~
LEDS0
);

6511 
	`¹l_•hy_š™
(

, 
e_šfo_8102e_1
, 
	`ARRAY_SIZE
(e_info_8102e_1));

6512 
	}
}

6514 
	$¹l_hw_¡¬t_8102e_2
(
¹l8169_´iv©e
 *

)

6516 
	`¹l_csi_acûss_’abË_2
(

);

6518 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6520 
	`RTL_W8
(

, 
CÚfig1
, 
MEMMAP
 | 
IOMAP
 | 
VPD
 | 
PMEÇbË
);

6521 
	`RTL_W8
(

, 
CÚfig3
, 
	`RTL_R8
Ñp, CÚfig3è& ~
B—cÚ_’
);

6522 
	}
}

6524 
	$¹l_hw_¡¬t_8102e_3
(
¹l8169_´iv©e
 *

)

6526 
	`¹l_hw_¡¬t_8102e_2
(

);

6528 
	`¹l_•hy_wr™e
(

, 0x03, 0xc2f9);

6529 
	}
}

6531 
	$¹l_hw_¡¬t_8105e_1
(
¹l8169_´iv©e
 *

)

6533 cÚ¡ 
•hy_šfo
 
e_šfo_8105e_1
[] = {

6545 
	`RTL_W32
(

, 
FuncEv’t
, 
	`RTL_R32
(tp, FuncEvent) | 0x002800);

6548 
	`RTL_W32
(

, 
FuncEv’t
, 
	`RTL_R32
(tp, FuncEvent) & ~0x010000);

6550 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè| 
EN_NDP
 | 
EN_OOB_RESET
);

6551 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè| 
PFM_EN
);

6553 
	`¹l_•hy_š™
(

, 
e_šfo_8105e_1
, 
	`ARRAY_SIZE
(e_info_8105e_1));

6555 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6556 
	}
}

6558 
	$¹l_hw_¡¬t_8105e_2
(
¹l8169_´iv©e
 *

)

6560 
	`¹l_hw_¡¬t_8105e_1
(

);

6561 
	`¹l_•hy_wr™e
(

, 0x1e, 
	`¹l_•hy_»ad
(tp, 0x1e) | 0x8000);

6562 
	}
}

6564 
	$¹l_hw_¡¬t_8402
(
¹l8169_´iv©e
 *

)

6566 cÚ¡ 
•hy_šfo
 
e_šfo_8402
[] = {

6571 
	`¹l_csi_acûss_’abË_2
(

);

6574 
	`RTL_W32
(

, 
FuncEv’t
, 
	`RTL_R32
(tp, FuncEvent) | 0x002800);

6576 
	`RTL_W32
(

, 
TxCÚfig
, 
	`RTL_R32
Ñp, TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6577 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè& ~
NOW_IS_OOB
);

6579 
	`¹l_•hy_š™
(

, 
e_šfo_8402
, 
	`ARRAY_SIZE
(e_info_8402));

6581 
	`¹l_tx_³rfÜmªû_tw—k
(

, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6583 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00000002, 
ERIAR_EXGMAC
);

6584 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00000006, 
ERIAR_EXGMAC
);

6585 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6586 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6587 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6588 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6589 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0e00, 0xff00, 
ERIAR_EXGMAC
);

6591 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6592 
	}
}

6594 
	$¹l_hw_¡¬t_8106
(
¹l8169_´iv©e
 *

)

6597 
	`RTL_W32
(

, 
FuncEv’t
, 
	`RTL_R32
(tp, FuncEvent) | 0x002800);

6599 
	`RTL_W32
(

, 
MISC
, (
	`RTL_R32
Ñp, MISCè| 
DISABLE_LAN_EN
è& ~
EARLY_TALLY_EN
);

6600 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè| 
EN_NDP
 | 
EN_OOB_RESET
);

6601 
	`RTL_W8
(

, 
DLLPR
, 
	`RTL_R8
Ñp, DLLPRè& ~
PFM_EN
);

6603 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6604 
	}
}

6606 
	$¹l_hw_¡¬t_8101
(
Ãt_deviû
 *
dev
)

6608 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6609 
pci_dev
 *
pdev
 = 

->pci_dev;

6611 ià(

->
mac_v”siÚ
 >ğ
RTL_GIGA_MAC_VER_30
)

6612 

->
ev’t_¦ow
 &ğ~
RxFIFOOv”
;

6614 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_13
 ||

6615 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_16
)

6616 
	`pc›_ÿ·b™y_£t_wÜd
(
pdev
, 
PCI_EXP_DEVCTL
,

6617 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

6619 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

6621 
	`RTL_W8
(

, 
MaxTxPack‘Size
, 
TxPack‘Max
);

6623 
	`¹l_£t_rx_max_size
(

, 
rx_buf_sz
);

6625 

->
ı_cmd
 &ğ~
R810X_CPCMD_QUIRK_MASK
;

6626 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

6628 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

);

6630 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

6632 

->
mac_v”siÚ
) {

6633 
RTL_GIGA_MAC_VER_07
:

6634 
	`¹l_hw_¡¬t_8102e_1
(

);

6637 
RTL_GIGA_MAC_VER_08
:

6638 
	`¹l_hw_¡¬t_8102e_3
(

);

6641 
RTL_GIGA_MAC_VER_09
:

6642 
	`¹l_hw_¡¬t_8102e_2
(

);

6645 
RTL_GIGA_MAC_VER_29
:

6646 
	`¹l_hw_¡¬t_8105e_1
(

);

6648 
RTL_GIGA_MAC_VER_30
:

6649 
	`¹l_hw_¡¬t_8105e_2
(

);

6652 
RTL_GIGA_MAC_VER_37
:

6653 
	`¹l_hw_¡¬t_8402
(

);

6656 
RTL_GIGA_MAC_VER_39
:

6657 
	`¹l_hw_¡¬t_8106
(

);

6659 
RTL_GIGA_MAC_VER_43
:

6660 
	`¹l_hw_¡¬t_8168g_2
(

);

6662 
RTL_GIGA_MAC_VER_47
:

6663 
RTL_GIGA_MAC_VER_48
:

6664 
	`¹l_hw_¡¬t_8168h_1
(

);

6668 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

6670 
	`RTL_W16
(

, 
IÁrM™ig©e
, 0x0000);

6672 
	`RTL_W8
(

, 
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

6674 
	`¹l_£t_rx_mode
(
dev
);

6676 
	`RTL_R8
(

, 
IÁrMask
);

6678 
	`RTL_W16
(

, 
MuÉiIÁr
, 
	`RTL_R16
(tp, MultiIntr) & 0xf000);

6679 
	}
}

6681 
	$¹l8169_chªge_mtu
(
Ãt_deviû
 *
dev
, 
Ãw_mtu
)

6683 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6685 ià(
Ãw_mtu
 > 
ETH_DATA_LEN
)

6686 
	`¹l_hw_jumbo_’abË
(

);

6688 
	`¹l_hw_jumbo_di§bË
(

);

6690 
dev
->
mtu
 = 
Ãw_mtu
;

6691 
	`Ãtdev_upd©e_ã©u»s
(
dev
);

6694 
	}
}

6696 
šlše
 
	$¹l8169_make_unu§bË_by_asic
(
RxDesc
 *
desc
)

6698 
desc
->
addr
 = 
	`ıu_to_Ë64
(0x0badbadbadbadbadull);

6699 
desc
->
İts1
 &ğ~
	`ıu_to_Ë32
(
DescOwn
 | 
RsvdMask
);

6700 
	}
}

6702 
	$¹l8169_ä“_rx_d©abuff
(
¹l8169_´iv©e
 *

,

6703 **
d©a_buff
, 
RxDesc
 *
desc
)

6705 
	`dma_unm­_sšgË
(
	`_to_dev
(

), 
	`Ë64_to_ıu
(
desc
->
addr
), 
rx_buf_sz
,

6706 
DMA_FROM_DEVICE
);

6708 
	`kä“
(*
d©a_buff
);

6709 *
d©a_buff
 = 
NULL
;

6710 
	`¹l8169_make_unu§bË_by_asic
(
desc
);

6711 
	}
}

6713 
šlše
 
	$¹l8169_m¬k_to_asic
(
RxDesc
 *
desc
, 
u32
 
rx_buf_sz
)

6715 
u32
 
eÜ
 = 
	`Ë32_to_ıu
(
desc
->
İts1
è& 
RšgEnd
;

6718 
	`dma_wmb
();

6720 
desc
->
İts1
 = 
	`ıu_to_Ë32
(
DescOwn
 | 
eÜ
 | 
rx_buf_sz
);

6721 
	}
}

6723 
šlše
 
	$¹l8169_m­_to_asic
(
RxDesc
 *
desc
, 
dma_addr_t
 
m­pšg
,

6724 
u32
 
rx_buf_sz
)

6726 
desc
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

6727 
	`¹l8169_m¬k_to_asic
(
desc
, 
rx_buf_sz
);

6728 
	}
}

6730 
šlše
 *
	$¹l8169_®ign
(*
d©a
)

6732  (*)
	`ALIGN
(()
d©a
, 16);

6733 
	}
}

6735 
sk_buff
 *
	$¹l8169_®loc_rx_d©a
(
¹l8169_´iv©e
 *

,

6736 
RxDesc
 *
desc
)

6738 *
d©a
;

6739 
dma_addr_t
 
m­pšg
;

6740 
deviû
 *
d
 = 
	`_to_dev
(

);

6741 
Ãt_deviû
 *
dev
 = 

->dev;

6742 
node
 = 
dev
->dev.
·»Á
 ? 
	`dev_to_node
(dev->dev.parent) : -1;

6744 
d©a
 = 
	`km®loc_node
(
rx_buf_sz
, 
GFP_KERNEL
, 
node
);

6745 ià(!
d©a
)

6746  
NULL
;

6748 ià(
	`¹l8169_®ign
(
d©a
) != data) {

6749 
	`kä“
(
d©a
);

6750 
d©a
 = 
	`km®loc_node
(
rx_buf_sz
 + 15, 
GFP_KERNEL
, 
node
);

6751 ià(!
d©a
)

6752  
NULL
;

6755 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
	`¹l8169_®ign
(
d©a
), 
rx_buf_sz
,

6756 
DMA_FROM_DEVICE
);

6757 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

6758 ià(
	`Ãt_¿‹lim™
())

6759 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "Failedo map RX DMA!\n");

6760 
”r_out
;

6763 
	`¹l8169_m­_to_asic
(
desc
, 
m­pšg
, 
rx_buf_sz
);

6764  
d©a
;

6766 
”r_out
:

6767 
	`kä“
(
d©a
);

6768  
NULL
;

6769 
	}
}

6771 
	$¹l8169_rx_ş—r
(
¹l8169_´iv©e
 *

)

6773 
i
;

6775 
i
 = 0; i < 
NUM_RX_DESC
; i++) {

6776 ià(

->
Rx_d©abuff
[
i
]) {

6777 
	`¹l8169_ä“_rx_d©abuff
(

,p->
Rx_d©abuff
 + 
i
,

6778 

->
RxDescA¼ay
 + 
i
);

6781 
	}
}

6783 
šlše
 
	$¹l8169_m¬k_as_Ï¡_desütÜ
(
RxDesc
 *
desc
)

6785 
desc
->
İts1
 |ğ
	`ıu_to_Ë32
(
RšgEnd
);

6786 
	}
}

6788 
	$¹l8169_rx_fl
(
¹l8169_´iv©e
 *

)

6790 
i
;

6792 
i
 = 0; i < 
NUM_RX_DESC
; i++) {

6793 *
d©a
;

6795 ià(

->
Rx_d©abuff
[
i
])

6798 
d©a
 = 
	`¹l8169_®loc_rx_d©a
(

,p->
RxDescA¼ay
 + 
i
);

6799 ià(!
d©a
) {

6800 
	`¹l8169_make_unu§bË_by_asic
(

->
RxDescA¼ay
 + 
i
);

6801 
”r_out
;

6803 

->
Rx_d©abuff
[
i
] = 
d©a
;

6806 
	`¹l8169_m¬k_as_Ï¡_desütÜ
(

->
RxDescA¼ay
 + 
NUM_RX_DESC
 - 1);

6809 
”r_out
:

6810 
	`¹l8169_rx_ş—r
(

);

6811  -
ENOMEM
;

6812 
	}
}

6814 
	$¹l8169_š™_ršg
(
Ãt_deviû
 *
dev
)

6816 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6818 
	`¹l8169_š™_ršg_šdexes
(

);

6820 
	`mem£t
(

->
tx_skb
, 0x0, 
NUM_TX_DESC
 * (
ršg_šfo
));

6821 
	`mem£t
(

->
Rx_d©abuff
, 0x0, 
NUM_RX_DESC
 * (*));

6823  
	`¹l8169_rx_fl
(

);

6824 
	}
}

6826 
	$¹l8169_unm­_tx_skb
(
deviû
 *
d
, 
ršg_šfo
 *
tx_skb
,

6827 
TxDesc
 *
desc
)

6829 
Ën
 = 
tx_skb
->len;

6831 
	`dma_unm­_sšgË
(
d
, 
	`Ë64_to_ıu
(
desc
->
addr
), 
Ën
, 
DMA_TO_DEVICE
);

6833 
desc
->
İts1
 = 0x00;

6834 
desc
->
İts2
 = 0x00;

6835 
desc
->
addr
 = 0x00;

6836 
tx_skb
->
Ën
 = 0;

6837 
	}
}

6839 
	$¹l8169_tx_ş—r_¿nge
(
¹l8169_´iv©e
 *

, 
u32
 
¡¬t
,

6840 
n
)

6842 
i
;

6844 
i
 = 0; i < 
n
; i++) {

6845 
’Œy
 = (
¡¬t
 + 
i
è% 
NUM_TX_DESC
;

6846 
ršg_šfo
 *
tx_skb
 = 

->tx_skb + 
’Œy
;

6847 
Ën
 = 
tx_skb
->len;

6849 ià(
Ën
) {

6850 
sk_buff
 *
skb
 = 
tx_skb
->skb;

6852 
	`¹l8169_unm­_tx_skb
(
	`_to_dev
(

), 
tx_skb
,

6853 

->
TxDescA¼ay
 + 
’Œy
);

6854 ià(
skb
) {

6855 
	`dev_cÚsume_skb_ªy
(
skb
);

6856 
tx_skb
->
skb
 = 
NULL
;

6860 
	}
}

6862 
	$¹l8169_tx_ş—r
(
¹l8169_´iv©e
 *

)

6864 
	`¹l8169_tx_ş—r_¿nge
(

,p->
dœty_tx
, 
NUM_TX_DESC
);

6865 

->
cur_tx
 =p->
dœty_tx
 = 0;

6866 
	}
}

6868 
	$¹l_»£t_wÜk
(
¹l8169_´iv©e
 *

)

6870 
Ãt_deviû
 *
dev
 = 

->dev;

6871 
i
;

6873 
	`Çpi_di§bË
(&

->
Çpi
);

6874 
	`Ãtif_¡İ_queue
(
dev
);

6875 
	`synchrÚize_sched
();

6877 
	`¹l8169_hw_»£t
(

);

6879 
i
 = 0; i < 
NUM_RX_DESC
; i++)

6880 
	`¹l8169_m¬k_to_asic
(

->
RxDescA¼ay
 + 
i
, 
rx_buf_sz
);

6882 
	`¹l8169_tx_ş—r
(

);

6883 
	`¹l8169_š™_ršg_šdexes
(

);

6885 
	`Çpi_’abË
(&

->
Çpi
);

6886 
	`¹l_hw_¡¬t
(
dev
);

6887 
	`Ãtif_wake_queue
(
dev
);

6888 
	`¹l8169_check_lšk_¡©us
(
dev
, 

);

6889 
	}
}

6891 
	$¹l8169_tx_timeout
(
Ãt_deviû
 *
dev
)

6893 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6895 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

6896 
	}
}

6898 
	$¹l8169_xm™_äags
(
¹l8169_´iv©e
 *

, 
sk_buff
 *
skb
,

6899 
u32
 *
İts
)

6901 
skb_sh¬ed_šfo
 *
šfo
 = 
	`skb_shšfo
(
skb
);

6902 
cur_äag
, 
’Œy
;

6903 
TxDesc
 *
	`unš™Ÿlized_v¬
(
txd
);

6904 
deviû
 *
d
 = 
	`_to_dev
(

);

6906 
’Œy
 = 

->
cur_tx
;

6907 
cur_äag
 = 0; cur_äag < 
šfo
->
Ä_äags
; cur_frag++) {

6908 cÚ¡ 
skb_äag_t
 *
äag
 = 
šfo
->
äags
 + 
cur_äag
;

6909 
dma_addr_t
 
m­pšg
;

6910 
u32
 
¡©us
, 
Ën
;

6911 *
addr
;

6913 
’Œy
 = (’Œy + 1è% 
NUM_TX_DESC
;

6915 
txd
 = 

->
TxDescA¼ay
 + 
’Œy
;

6916 
Ën
 = 
	`skb_äag_size
(
äag
);

6917 
addr
 = 
	`skb_äag_add»ss
(
äag
);

6918 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
addr
, 
Ën
, 
DMA_TO_DEVICE
);

6919 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

6920 ià(
	`Ãt_¿‹lim™
())

6921 
	`Ãtif_”r
(

, 
drv
,p->
dev
,

6923 
”r_out
;

6927 
¡©us
 = 
İts
[0] | 
Ën
 |

6928 (
RšgEnd
 * !((
’Œy
 + 1è% 
NUM_TX_DESC
));

6930 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
¡©us
);

6931 
txd
->
İts2
 = 
	`ıu_to_Ë32
(
İts
[1]);

6932 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

6934 

->
tx_skb
[
’Œy
].
Ën
 =†en;

6937 ià(
cur_äag
) {

6938 

->
tx_skb
[
’Œy
].
skb
 = skb;

6939 
txd
->
İts1
 |ğ
	`ıu_to_Ë32
(
La¡F¿g
);

6942  
cur_äag
;

6944 
”r_out
:

6945 
	`¹l8169_tx_ş—r_¿nge
(

,p->
cur_tx
 + 1, 
cur_äag
);

6946  -
EIO
;

6947 
	}
}

6949 
boŞ
 
	$¹l_‹¡_hw_·d_bug
(
¹l8169_´iv©e
 *

, 
sk_buff
 *
skb
)

6951  
skb
->
Ën
 < 
ETH_ZLEN
 && 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
;

6952 
	}
}

6954 
Ãtdev_tx_t
 
¹l8169_¡¬t_xm™
(
sk_buff
 *
skb
,

6955 
Ãt_deviû
 *
dev
);

6960 
	$r8169_csum_wÜk¬ound
(
¹l8169_´iv©e
 *

,

6961 
sk_buff
 *
skb
)

6963 ià(
	`skb_shšfo
(
skb
)->
gso_size
) {

6964 
Ãtdev_ã©u»s_t
 
ã©u»s
 = 

->
dev
->features;

6965 
sk_buff
 *
£gs
, *
nskb
;

6967 
ã©u»s
 &ğ~(
NETIF_F_SG
 | 
NETIF_F_IPV6_CSUM
 | 
NETIF_F_TSO6
);

6968 
£gs
 = 
	`skb_gso_£gm’t
(
skb
, 
ã©u»s
);

6969 ià(
	`IS_ERR
(
£gs
) || !segs)

6970 
drİ
;

6973 
nskb
 = 
£gs
;

6974 
£gs
 = segs->
Ãxt
;

6975 
nskb
->
Ãxt
 = 
NULL
;

6976 
	`¹l8169_¡¬t_xm™
(
nskb
, 

->
dev
);

6977 } 
£gs
);

6979 
	`dev_cÚsume_skb_ªy
(
skb
);

6980 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

6981 ià(
	`skb_checksum_h–p
(
skb
) < 0)

6982 
drİ
;

6984 
	`¹l8169_¡¬t_xm™
(
skb
, 

->
dev
);

6986 
Ãt_deviû_¡©s
 *
¡©s
;

6988 
drİ
:

6989 
¡©s
 = &

->
dev
->stats;

6990 
¡©s
->
tx_drİ³d
++;

6991 
	`dev_kä“_skb_ªy
(
skb
);

6993 
	}
}

6999 
	$msdn_gŸÁ_£nd_check
(
sk_buff
 *
skb
)

7001 cÚ¡ 
v6hdr
 *
v6h
;

7002 
tıhdr
 *
th
;

7003 
»t
;

7005 
»t
 = 
	`skb_cow_h—d
(
skb
, 0);

7006 ià(
»t
)

7007  
»t
;

7009 
v6h
 = 
	`v6_hdr
(
skb
);

7010 
th
 = 
	`tı_hdr
(
skb
);

7012 
th
->
check
 = 0;

7013 
th
->
check
 = ~
	`tı_v6_check
(0, &
v6h
->
§ddr
, &v6h->
daddr
, 0);

7015  
»t
;

7016 
	}
}

7018 
šlše
 
__be16
 
	$g‘_´ÙocŞ
(
sk_buff
 *
skb
)

7020 
__be16
 
´ÙocŞ
;

7022 ià(
skb
->
´ÙocŞ
 =ğ
	`htÚs
(
ETH_P_8021Q
))

7023 
´ÙocŞ
 = 
	`vÏn_‘h_hdr
(
skb
)->
h_vÏn_’ÿpsuÏ‹d_´Ùo
;

7025 
´ÙocŞ
 = 
skb
->protocol;

7027  
´ÙocŞ
;

7028 
	}
}

7030 
boŞ
 
	$¹l8169_tso_csum_v1
(
¹l8169_´iv©e
 *

,

7031 
sk_buff
 *
skb
, 
u32
 *
İts
)

7033 
u32
 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
;

7035 ià(
mss
) {

7036 
İts
[0] |ğ
TD_LSO
;

7037 
İts
[0] |ğ
	`mš
(
mss
, 
TD_MSS_MAX
è<< 
TD0_MSS_SHIFT
;

7038 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

7039 cÚ¡ 
hdr
 *

 = 
	`_hdr
(
skb
);

7041 ià(

->
´ÙocŞ
 =ğ
IPPROTO_TCP
)

7042 
İts
[0] |ğ
TD0_IP_CS
 | 
TD0_TCP_CS
;

7043 ià(

->
´ÙocŞ
 =ğ
IPPROTO_UDP
)

7044 
İts
[0] |ğ
TD0_IP_CS
 | 
TD0_UDP_CS
;

7046 
	`WARN_ON_ONCE
(1);

7049  
Œue
;

7050 
	}
}

7052 
boŞ
 
	$¹l8169_tso_csum_v2
(
¹l8169_´iv©e
 *

,

7053 
sk_buff
 *
skb
, 
u32
 *
İts
)

7055 
u32
 
Œª¥Üt_off£t
 = (u32)
	`skb_Œª¥Üt_off£t
(
skb
);

7056 
u32
 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
;

7058 ià(
mss
) {

7059 ià(
Œª¥Üt_off£t
 > 
GTTCPHO_MAX
) {

7060 
	`Ãtif_w¬n
(

, 
tx_”r
,p->
dev
,

7062 
Œª¥Üt_off£t
);

7063  
çl£
;

7066 
	`g‘_´ÙocŞ
(
skb
)) {

7067 
	`htÚs
(
ETH_P_IP
):

7068 
İts
[0] |ğ
TD1_GTSENV4
;

7071 
	`htÚs
(
ETH_P_IPV6
):

7072 ià(
	`msdn_gŸÁ_£nd_check
(
skb
))

7073  
çl£
;

7075 
İts
[0] |ğ
TD1_GTSENV6
;

7079 
	`WARN_ON_ONCE
(1);

7083 
İts
[0] |ğ
Œª¥Üt_off£t
 << 
GTTCPHO_SHIFT
;

7084 
İts
[1] |ğ
	`mš
(
mss
, 
TD_MSS_MAX
è<< 
TD1_MSS_SHIFT
;

7085 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

7086 
u8
 
_´ÙocŞ
;

7088 ià(
	`uÆik–y
(
	`¹l_‹¡_hw_·d_bug
(

, 
skb
)))

7089  !(
	`skb_checksum_h–p
(
skb
è|| 
	`‘h_skb_·d
(skb));

7091 ià(
Œª¥Üt_off£t
 > 
TCPHO_MAX
) {

7092 
	`Ãtif_w¬n
(

, 
tx_”r
,p->
dev
,

7094 
Œª¥Üt_off£t
);

7095  
çl£
;

7098 
	`g‘_´ÙocŞ
(
skb
)) {

7099 
	`htÚs
(
ETH_P_IP
):

7100 
İts
[1] |ğ
TD1_IPv4_CS
;

7101 
_´ÙocŞ
 = 
	`_hdr
(
skb
)->
´ÙocŞ
;

7104 
	`htÚs
(
ETH_P_IPV6
):

7105 
İts
[1] |ğ
TD1_IPv6_CS
;

7106 
_´ÙocŞ
 = 
	`v6_hdr
(
skb
)->
Ãxthdr
;

7110 
_´ÙocŞ
 = 
IPPROTO_RAW
;

7114 ià(
_´ÙocŞ
 =ğ
IPPROTO_TCP
)

7115 
İts
[1] |ğ
TD1_TCP_CS
;

7116 ià(
_´ÙocŞ
 =ğ
IPPROTO_UDP
)

7117 
İts
[1] |ğ
TD1_UDP_CS
;

7119 
	`WARN_ON_ONCE
(1);

7121 
İts
[1] |ğ
Œª¥Üt_off£t
 << 
TCPHO_SHIFT
;

7123 ià(
	`uÆik–y
(
	`¹l_‹¡_hw_·d_bug
(

, 
skb
)))

7124  !
	`‘h_skb_·d
(
skb
);

7127  
Œue
;

7128 
	}
}

7130 
Ãtdev_tx_t
 
	$¹l8169_¡¬t_xm™
(
sk_buff
 *
skb
,

7131 
Ãt_deviû
 *
dev
)

7133 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7134 
’Œy
 = 

->
cur_tx
 % 
NUM_TX_DESC
;

7135 
TxDesc
 *
txd
 = 

->
TxDescA¼ay
 + 
’Œy
;

7136 
deviû
 *
d
 = 
	`_to_dev
(

);

7137 
dma_addr_t
 
m­pšg
;

7138 
u32
 
¡©us
, 
Ën
;

7139 
u32
 
İts
[2];

7140 
äags
;

7142 ià(
	`uÆik–y
(!
	`TX_FRAGS_READY_FOR
(

, 
	`skb_shšfo
(
skb
)->
Ä_äags
))) {

7143 
	`Ãtif_”r
(

, 
drv
, 
dev
, "BUG! Tx Ring full when queue‡wake!\n");

7144 
”r_¡İ_0
;

7147 ià(
	`uÆik–y
(
	`Ë32_to_ıu
(
txd
->
İts1
è& 
DescOwn
))

7148 
”r_¡İ_0
;

7150 
İts
[1] = 
	`ıu_to_Ë32
(
	`¹l8169_tx_vÏn_g
(
skb
));

7151 
İts
[0] = 
DescOwn
;

7153 ià(!

->
	`tso_csum
Ñp, 
skb
, 
İts
)) {

7154 
	`r8169_csum_wÜk¬ound
(

, 
skb
);

7155  
NETDEV_TX_OK
;

7158 
Ën
 = 
	`skb_h—dËn
(
skb
);

7159 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
skb
->
d©a
, 
Ën
, 
DMA_TO_DEVICE
);

7160 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

7161 ià(
	`Ãt_¿‹lim™
())

7162 
	`Ãtif_”r
(

, 
drv
, 
dev
, "Failedo map TX DMA!\n");

7163 
”r_dma_0
;

7166 

->
tx_skb
[
’Œy
].
Ën
 =†en;

7167 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

7169 
äags
 = 
	`¹l8169_xm™_äags
(

, 
skb
, 
İts
);

7170 ià(
äags
 < 0)

7171 
”r_dma_1
;

7172 ià(
äags
)

7173 
İts
[0] |ğ
Fœ¡F¿g
;

7175 
İts
[0] |ğ
Fœ¡F¿g
 | 
La¡F¿g
;

7176 

->
tx_skb
[
’Œy
].
skb
 = skb;

7179 
txd
->
İts2
 = 
	`ıu_to_Ë32
(
İts
[1]);

7181 
	`skb_tx_time¡amp
(
skb
);

7184 
	`dma_wmb
();

7187 
¡©us
 = 
İts
[0] | 
Ën
 | (
RšgEnd
 * !((
’Œy
 + 1è% 
NUM_TX_DESC
));

7188 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
¡©us
);

7191 
	`wmb
();

7193 

->
cur_tx
 +ğ
äags
 + 1;

7195 
	`RTL_W8
(

, 
TxPŞl
, 
NPQ
);

7197 
	`mmiowb
();

7199 ià(!
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
)) {

7203 
	`smp_wmb
();

7204 
	`Ãtif_¡İ_queue
(
dev
);

7212 
	`smp_mb
();

7213 ià(
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
))

7214 
	`Ãtif_wake_queue
(
dev
);

7217  
NETDEV_TX_OK
;

7219 
”r_dma_1
:

7220 
	`¹l8169_unm­_tx_skb
(
d
, 

->
tx_skb
 + 
’Œy
, 
txd
);

7221 
”r_dma_0
:

7222 
	`dev_kä“_skb_ªy
(
skb
);

7223 
dev
->
¡©s
.
tx_drİ³d
++;

7224  
NETDEV_TX_OK
;

7226 
”r_¡İ_0
:

7227 
	`Ãtif_¡İ_queue
(
dev
);

7228 
dev
->
¡©s
.
tx_drİ³d
++;

7229  
NETDEV_TX_BUSY
;

7230 
	}
}

7232 
	$¹l8169_pc›¼_š‹¼u±
(
Ãt_deviû
 *
dev
)

7234 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7235 
pci_dev
 *
pdev
 = 

->pci_dev;

7236 
u16
 
pci_¡©us
, 
pci_cmd
;

7238 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
PCI_COMMAND
, &
pci_cmd
);

7239 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
PCI_STATUS
, &
pci_¡©us
);

7241 
	`Ãtif_”r
(

, 
šŒ
, 
dev
, "PCIƒrror (cmd = 0x%04x, status = 0x%04x)\n",

7242 
pci_cmd
, 
pci_¡©us
);

7252 ià(
pdev
->
brok’_·r™y_¡©us
)

7253 
pci_cmd
 &ğ~
PCI_COMMAND_PARITY
;

7255 
pci_cmd
 |ğ
PCI_COMMAND_SERR
 | 
PCI_COMMAND_PARITY
;

7257 
	`pci_wr™e_cÚfig_wÜd
(
pdev
, 
PCI_COMMAND
, 
pci_cmd
);

7259 
	`pci_wr™e_cÚfig_wÜd
(
pdev
, 
PCI_STATUS
,

7260 
pci_¡©us
 & (
PCI_STATUS_DETECTED_PARITY
 |

7261 
PCI_STATUS_SIG_SYSTEM_ERROR
 | 
PCI_STATUS_REC_MASTER_ABORT
 |

7262 
PCI_STATUS_REC_TARGET_ABORT
 | 
PCI_STATUS_SIG_TARGET_ABORT
));

7265 ià((

->
ı_cmd
 & 
PCIDAC
è&& !->
cur_rx
) {

7266 
	`Ãtif_šfo
(

, 
šŒ
, 
dev
, "disabling PCI DAC\n");

7267 

->
ı_cmd
 &ğ~
PCIDAC
;

7268 
	`RTL_W16
(

, 
CPlusCmd
,p->
ı_cmd
);

7269 
dev
->
ã©u»s
 &ğ~
NETIF_F_HIGHDMA
;

7272 
	`¹l8169_hw_»£t
(

);

7274 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7275 
	}
}

7277 
	$¹l_tx
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

)

7279 
dœty_tx
, 
tx_Ëá
;

7281 
dœty_tx
 = 

->dirty_tx;

7282 
	`smp_rmb
();

7283 
tx_Ëá
 = 

->
cur_tx
 - 
dœty_tx
;

7285 
tx_Ëá
 > 0) {

7286 
’Œy
 = 
dœty_tx
 % 
NUM_TX_DESC
;

7287 
ršg_šfo
 *
tx_skb
 = 

->tx_skb + 
’Œy
;

7288 
u32
 
¡©us
;

7290 
¡©us
 = 
	`Ë32_to_ıu
(

->
TxDescA¼ay
[
’Œy
].
İts1
);

7291 ià(
¡©us
 & 
DescOwn
)

7298 
	`dma_rmb
();

7300 
	`¹l8169_unm­_tx_skb
(
	`_to_dev
(

), 
tx_skb
,

7301 

->
TxDescA¼ay
 + 
’Œy
);

7302 ià(
¡©us
 & 
La¡F¿g
) {

7303 
	`u64_¡©s_upd©e_begš
(&

->
tx_¡©s
.
synı
);

7304 

->
tx_¡©s
.
·ck‘s
++;

7305 

->
tx_¡©s
.
by‹s
 +ğ
tx_skb
->
skb
->
Ën
;

7306 
	`u64_¡©s_upd©e_’d
(&

->
tx_¡©s
.
synı
);

7307 
	`dev_cÚsume_skb_ªy
(
tx_skb
->
skb
);

7308 
tx_skb
->
skb
 = 
NULL
;

7310 
dœty_tx
++;

7311 
tx_Ëá
--;

7314 ià(

->
dœty_tx
 != dirty_tx) {

7315 

->
dœty_tx
 = dirty_tx;

7323 
	`smp_mb
();

7324 ià(
	`Ãtif_queue_¡İ³d
(
dev
) &&

7325 
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
)) {

7326 
	`Ãtif_wake_queue
(
dev
);

7334 ià(

->
cur_tx
 !ğ
dœty_tx
)

7335 
	`RTL_W8
(

, 
TxPŞl
, 
NPQ
);

7337 
	}
}

7339 
šlše
 
	$¹l8169_äagm’‹d_äame
(
u32
 
¡©us
)

7341  (
¡©us
 & (
Fœ¡F¿g
 | 
La¡F¿g
)) != (FirstFrag | LastFrag);

7342 
	}
}

7344 
šlše
 
	$¹l8169_rx_csum
(
sk_buff
 *
skb
, 
u32
 
İts1
)

7346 
u32
 
¡©us
 = 
İts1
 & 
RxPrÙoMask
;

7348 ià(((
¡©us
 =ğ
RxPrÙoTCP
è&& !(
İts1
 & 
TCPFa
)) ||

7349 ((
¡©us
 =ğ
RxPrÙoUDP
è&& !(
İts1
 & 
UDPFa
)))

7350 
skb
->
_summed
 = 
CHECKSUM_UNNECESSARY
;

7352 
	`skb_checksum_nÚe_as£¹
(
skb
);

7353 
	}
}

7355 
sk_buff
 *
	$¹l8169_Œy_rx_cİy
(*
d©a
,

7356 
¹l8169_´iv©e
 *

,

7357 
pkt_size
,

7358 
dma_addr_t
 
addr
)

7360 
sk_buff
 *
skb
;

7361 
deviû
 *
d
 = 
	`_to_dev
(

);

7363 
d©a
 = 
	`¹l8169_®ign
(data);

7364 
	`dma_sync_sšgË_fÜ_ıu
(
d
, 
addr
, 
pkt_size
, 
DMA_FROM_DEVICE
);

7365 
	`´eãtch
(
d©a
);

7366 
skb
 = 
	`Çpi_®loc_skb
(&

->
Çpi
, 
pkt_size
);

7367 ià(
skb
)

7368 
	`memıy
(
skb
->
d©a
, d©a, 
pkt_size
);

7369 
	`dma_sync_sšgË_fÜ_deviû
(
d
, 
addr
, 
pkt_size
, 
DMA_FROM_DEVICE
);

7371  
skb
;

7372 
	}
}

7374 
	$¹l_rx
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

, 
u32
 
budg‘
)

7376 
cur_rx
, 
rx_Ëá
;

7377 
couÁ
;

7379 
cur_rx
 = 

->cur_rx;

7381 
rx_Ëá
 = 
	`mš
(
budg‘
, 
NUM_RX_DESC
);„x_Ëá > 0;„x_Ëá--, 
cur_rx
++) {

7382 
’Œy
 = 
cur_rx
 % 
NUM_RX_DESC
;

7383 
RxDesc
 *
desc
 = 

->
RxDescA¼ay
 + 
’Œy
;

7384 
u32
 
¡©us
;

7386 
¡©us
 = 
	`Ë32_to_ıu
(
desc
->
İts1
è& 

->
İts1_mask
;

7387 ià(
¡©us
 & 
DescOwn
)

7394 
	`dma_rmb
();

7396 ià(
	`uÆik–y
(
¡©us
 & 
RxRES
)) {

7397 
	`Ãtif_šfo
(

, 
rx_”r
, 
dev
, "Rx ERROR. status = %08x\n",

7398 
¡©us
);

7399 
dev
->
¡©s
.
rx_”rÜs
++;

7400 ià(
¡©us
 & (
RxRWT
 | 
RxRUNT
))

7401 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

7402 ià(
¡©us
 & 
RxCRC
)

7403 
dev
->
¡©s
.
rx_üc_”rÜs
++;

7404 ià(
¡©us
 & 
RxFOVF
) {

7405 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7406 
dev
->
¡©s
.
rx_fifo_”rÜs
++;

7408 ià((
¡©us
 & (
RxRUNT
 | 
RxCRC
)) &&

7409 !(
¡©us
 & (
RxRWT
 | 
RxFOVF
)) &&

7410 (
dev
->
ã©u»s
 & 
NETIF_F_RXALL
))

7411 
´oûss_pkt
;

7413 
sk_buff
 *
skb
;

7414 
dma_addr_t
 
addr
;

7415 
pkt_size
;

7417 
´oûss_pkt
:

7418 
addr
 = 
	`Ë64_to_ıu
(
desc
->addr);

7419 ià(
	`lik–y
(!(
dev
->
ã©u»s
 & 
NETIF_F_RXFCS
)))

7420 
pkt_size
 = (
¡©us
 & 0x00003fff) - 4;

7422 
pkt_size
 = 
¡©us
 & 0x00003fff;

7429 ià(
	`uÆik–y
(
	`¹l8169_äagm’‹d_äame
(
¡©us
))) {

7430 
dev
->
¡©s
.
rx_drİ³d
++;

7431 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

7432 
»Ëa£_desütÜ
;

7435 
skb
 = 
	`¹l8169_Œy_rx_cİy
(

->
Rx_d©abuff
[
’Œy
],

7436 

, 
pkt_size
, 
addr
);

7437 ià(!
skb
) {

7438 
dev
->
¡©s
.
rx_drİ³d
++;

7439 
»Ëa£_desütÜ
;

7442 
	`¹l8169_rx_csum
(
skb
, 
¡©us
);

7443 
	`skb_put
(
skb
, 
pkt_size
);

7444 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, 
dev
);

7446 
	`¹l8169_rx_vÏn_g
(
desc
, 
skb
);

7448 ià(
skb
->
pkt_ty³
 =ğ
PACKET_MULTICAST
)

7449 
dev
->
¡©s
.
muÉiÿ¡
++;

7451 
	`Çpi_gro_»ûive
(&

->
Çpi
, 
skb
);

7453 
	`u64_¡©s_upd©e_begš
(&

->
rx_¡©s
.
synı
);

7454 

->
rx_¡©s
.
·ck‘s
++;

7455 

->
rx_¡©s
.
by‹s
 +ğ
pkt_size
;

7456 
	`u64_¡©s_upd©e_’d
(&

->
rx_¡©s
.
synı
);

7458 
»Ëa£_desütÜ
:

7459 
desc
->
İts2
 = 0;

7460 
	`¹l8169_m¬k_to_asic
(
desc
, 
rx_buf_sz
);

7463 
couÁ
 = 
cur_rx
 - 

->cur_rx;

7464 

->
cur_rx
 = cur_rx;

7466  
couÁ
;

7467 
	}
}

7469 
œq»tuº_t
 
	$¹l8169_š‹¼u±
(
œq
, *
dev_š¡ªû
)

7471 
Ãt_deviû
 *
dev
 = 
dev_š¡ªû
;

7472 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7473 
hªdËd
 = 0;

7474 
u16
 
¡©us
;

7476 
¡©us
 = 
	`¹l_g‘_ev’ts
(

);

7477 ià(
¡©us
 && status != 0xffff) {

7478 
¡©us
 &ğ
RTL_EVENT_NAPI
 | 

->
ev’t_¦ow
;

7479 ià(
¡©us
) {

7480 
hªdËd
 = 1;

7482 
	`¹l_œq_di§bË
(

);

7483 
	`Çpi_scheduË
(&

->
Çpi
);

7486  
	`IRQ_RETVAL
(
hªdËd
);

7487 
	}
}

7492 
	$¹l_¦ow_ev’t_wÜk
(
¹l8169_´iv©e
 *

)

7494 
Ãt_deviû
 *
dev
 = 

->dev;

7495 
u16
 
¡©us
;

7497 
¡©us
 = 
	`¹l_g‘_ev’ts
(

è&p->
ev’t_¦ow
;

7498 
	`¹l_ack_ev’ts
(

, 
¡©us
);

7500 ià(
	`uÆik–y
(
¡©us
 & 
RxFIFOOv”
)) {

7501 

->
mac_v”siÚ
) {

7503 
RTL_GIGA_MAC_VER_11
:

7504 
	`Ãtif_¡İ_queue
(
dev
);

7506 
	`£t_b™
(
RTL_FLAG_TASK_RESET_PENDING
, 

->
wk
.
æags
);

7512 ià(
	`uÆik–y
(
¡©us
 & 
SYSE¼
))

7513 
	`¹l8169_pc›¼_š‹¼u±
(
dev
);

7515 ià(
¡©us
 & 
LškChg
)

7516 
	`¹l8169_check_lšk_¡©us
(
dev
, 

);

7518 
	`¹l_œq_’abË_®l
(

);

7519 
	}
}

7521 
	$¹l_sk
(
wÜk_¡ruù
 *
wÜk
)

7524 
b™Ä
;

7525 (*
aùiÚ
)(
¹l8169_´iv©e
 *);

7526 } 
¹l_wÜk
[] = {

7528 { 
RTL_FLAG_TASK_SLOW_PENDING
, 
¹l_¦ow_ev’t_wÜk
 },

7529 { 
RTL_FLAG_TASK_RESET_PENDING
, 
¹l_»£t_wÜk
 },

7530 { 
RTL_FLAG_TASK_PHY_PENDING
, 
¹l_phy_wÜk
 }

7532 
¹l8169_´iv©e
 *

 =

7533 
	`cÚš”_of
(
wÜk
, 
¹l8169_´iv©e
, 
wk
.work);

7534 
Ãt_deviû
 *
dev
 = 

->dev;

7535 
i
;

7537 
	`¹l_lock_wÜk
(

);

7539 ià(!
	`Ãtif_ruÂšg
(
dev
) ||

7540 !
	`‹¡_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
))

7541 
out_uÆock
;

7543 
i
 = 0; i < 
	`ARRAY_SIZE
(
¹l_wÜk
); i++) {

7544 
boŞ
 
³ndšg
;

7546 
³ndšg
 = 
	`‹¡_ªd_ş—r_b™
(
¹l_wÜk
[
i
].
b™Ä
, 

->
wk
.
æags
);

7547 ià(
³ndšg
)

7548 
¹l_wÜk
[
i
].
	`aùiÚ
(

);

7551 
out_uÆock
:

7552 
	`¹l_uÆock_wÜk
(

);

7553 
	}
}

7555 
	$¹l8169_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

7557 
¹l8169_´iv©e
 *

 = 
	`cÚš”_of
(
Çpi
, rtl8169_private,‚api);

7558 
Ãt_deviû
 *
dev
 = 

->dev;

7559 
u16
 
’abË_mask
 = 
RTL_EVENT_NAPI
 | 

->
ev’t_¦ow
;

7560 
wÜk_dÚe
= 0;

7561 
u16
 
¡©us
;

7563 
¡©us
 = 
	`¹l_g‘_ev’ts
(

);

7564 
	`¹l_ack_ev’ts
(

, 
¡©us
 & ~->
ev’t_¦ow
);

7566 ià(
¡©us
 & 
RTL_EVENT_NAPI_RX
)

7567 
wÜk_dÚe
 = 
	`¹l_rx
(
dev
, 

, (
u32
è
budg‘
);

7569 ià(
¡©us
 & 
RTL_EVENT_NAPI_TX
)

7570 
	`¹l_tx
(
dev
, 

);

7572 ià(
¡©us
 & 

->
ev’t_¦ow
) {

7573 
’abË_mask
 &ğ~

->
ev’t_¦ow
;

7575 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_SLOW_PENDING
);

7578 ià(
wÜk_dÚe
 < 
budg‘
) {

7579 
	`Çpi_com¶‘e_dÚe
(
Çpi
, 
wÜk_dÚe
);

7581 
	`¹l_œq_’abË
(

, 
’abË_mask
);

7582 
	`mmiowb
();

7585  
wÜk_dÚe
;

7586 
	}
}

7588 
	$¹l8169_rx_mis£d
(
Ãt_deviû
 *
dev
)

7590 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7592 ià(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_06
)

7595 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ
	`RTL_R32
(

, 
RxMis£d
) & 0xffffff;

7596 
	`RTL_W32
(

, 
RxMis£d
, 0);

7597 
	}
}

7599 
	$¹l8169_down
(
Ãt_deviû
 *
dev
)

7601 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7603 
	`d–_tim”_sync
(&

->
tim”
);

7605 
	`Çpi_di§bË
(&

->
Çpi
);

7606 
	`Ãtif_¡İ_queue
(
dev
);

7608 
	`¹l8169_hw_»£t
(

);

7614 
	`¹l8169_rx_mis£d
(
dev
);

7617 
	`synchrÚize_sched
();

7619 
	`¹l8169_tx_ş—r
(

);

7621 
	`¹l8169_rx_ş—r
(

);

7623 
	`¹l_¶l_pow”_down
(

);

7624 
	}
}

7626 
	$¹l8169_şo£
(
Ãt_deviû
 *
dev
)

7628 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7629 
pci_dev
 *
pdev
 = 

->pci_dev;

7631 
	`pm_ruÁime_g‘_sync
(&
pdev
->
dev
);

7634 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7636 
	`¹l_lock_wÜk
(

);

7637 
	`ş—r_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7639 
	`¹l8169_down
(
dev
);

7640 
	`¹l_uÆock_wÜk
(

);

7642 
	`ÿnûl_wÜk_sync
(&

->
wk
.
wÜk
);

7644 
	`pci_ä“_œq
(
pdev
, 0, 
dev
);

7646 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
, 

->
RxDescA¼ay
,

7647 

->
RxPhyAddr
);

7648 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
, 

->
TxDescA¼ay
,

7649 

->
TxPhyAddr
);

7650 

->
TxDescA¼ay
 = 
NULL
;

7651 

->
RxDescA¼ay
 = 
NULL
;

7653 
	`pm_ruÁime_put_sync
(&
pdev
->
dev
);

7656 
	}
}

7658 #ifdeà
CONFIG_NET_POLL_CONTROLLER


7659 
	$¹l8169_ÃŞl
(
Ãt_deviû
 *
dev
)

7661 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7663 
	`¹l8169_š‹¼u±
(
	`pci_œq_veùÜ
(

->
pci_dev
, 0), 
dev
);

7664 
	}
}

7667 
	$¹l_İ’
(
Ãt_deviû
 *
dev
)

7669 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7670 
pci_dev
 *
pdev
 = 

->pci_dev;

7671 
»tv®
 = -
ENOMEM
;

7673 
	`pm_ruÁime_g‘_sync
(&
pdev
->
dev
);

7679 

->
TxDescA¼ay
 = 
	`dma_®loc_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
,

7680 &

->
TxPhyAddr
, 
GFP_KERNEL
);

7681 ià(!

->
TxDescA¼ay
)

7682 
”r_pm_ruÁime_put
;

7684 

->
RxDescA¼ay
 = 
	`dma_®loc_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
,

7685 &

->
RxPhyAddr
, 
GFP_KERNEL
);

7686 ià(!

->
RxDescA¼ay
)

7687 
”r_ä“_tx_0
;

7689 
»tv®
 = 
	`¹l8169_š™_ršg
(
dev
);

7690 ià(
»tv®
 < 0)

7691 
”r_ä“_rx_1
;

7693 
	`INIT_WORK
(&

->
wk
.
wÜk
, 
¹l_sk
);

7695 
	`smp_mb
();

7697 
	`¹l_»que¡_fœmw¬e
(

);

7699 
»tv®
 = 
	`pci_»que¡_œq
(
pdev
, 0, 
¹l8169_š‹¼u±
, 
NULL
, 
dev
,

7700 
dev
->
Çme
);

7701 ià(
»tv®
 < 0)

7702 
”r_»Ëa£_fw_2
;

7704 
	`¹l_lock_wÜk
(

);

7706 
	`£t_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7708 
	`Çpi_’abË
(&

->
Çpi
);

7710 
	`¹l8169_š™_phy
(
dev
, 

);

7712 
	`__¹l8169_£t_ã©u»s
(
dev
, dev->
ã©u»s
);

7714 
	`¹l_¶l_pow”_up
(

);

7716 
	`¹l_hw_¡¬t
(
dev
);

7718 ià(!
	`¹l8169_š™_couÁ”_off£ts
(
dev
))

7719 
	`Ãtif_w¬n
(

, 
hw
, 
dev
, "counter„eset/update failed\n");

7721 
	`Ãtif_¡¬t_queue
(
dev
);

7723 
	`¹l_uÆock_wÜk
(

);

7725 

->
§ved_wŞİts
 = 0;

7726 
	`pm_ruÁime_put_sync
(&
pdev
->
dev
);

7728 
	`¹l8169_check_lšk_¡©us
(
dev
, 

);

7729 
out
:

7730  
»tv®
;

7732 
”r_»Ëa£_fw_2
:

7733 
	`¹l_»Ëa£_fœmw¬e
(

);

7734 
	`¹l8169_rx_ş—r
(

);

7735 
”r_ä“_rx_1
:

7736 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
, 

->
RxDescA¼ay
,

7737 

->
RxPhyAddr
);

7738 

->
RxDescA¼ay
 = 
NULL
;

7739 
”r_ä“_tx_0
:

7740 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
, 

->
TxDescA¼ay
,

7741 

->
TxPhyAddr
);

7742 

->
TxDescA¼ay
 = 
NULL
;

7743 
”r_pm_ruÁime_put
:

7744 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

7745 
out
;

7746 
	}
}

7749 
	$¹l8169_g‘_¡©s64
(
Ãt_deviû
 *
dev
, 
¹Æ_lšk_¡©s64
 *
¡©s
)

7751 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7752 
pci_dev
 *
pdev
 = 

->pci_dev;

7753 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

7754 
¡¬t
;

7756 
	`pm_ruÁime_g‘_nÜesume
(&
pdev
->
dev
);

7758 ià(
	`Ãtif_ruÂšg
(
dev
è&& 
	`pm_ruÁime_aùive
(&
pdev
->dev))

7759 
	`¹l8169_rx_mis£d
(
dev
);

7762 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
rx_¡©s
.
synı
);

7763 
¡©s
->
rx_·ck‘s
 = 

->
rx_¡©s
.
·ck‘s
;

7764 
¡©s
->
rx_by‹s
 = 

->
rx_¡©s
.
by‹s
;

7765 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
rx_¡©s
.
synı
, 
¡¬t
));

7768 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
tx_¡©s
.
synı
);

7769 
¡©s
->
tx_·ck‘s
 = 

->
tx_¡©s
.
·ck‘s
;

7770 
¡©s
->
tx_by‹s
 = 

->
tx_¡©s
.
by‹s
;

7771 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
tx_¡©s
.
synı
, 
¡¬t
));

7773 
¡©s
->
rx_drİ³d
 = 
dev
->stats.rx_dropped;

7774 
¡©s
->
tx_drİ³d
 = 
dev
->stats.tx_dropped;

7775 
¡©s
->
rx_Ëngth_”rÜs
 = 
dev
->stats.rx_length_errors;

7776 
¡©s
->
rx_”rÜs
 = 
dev
->stats.rx_errors;

7777 
¡©s
->
rx_üc_”rÜs
 = 
dev
->stats.rx_crc_errors;

7778 
¡©s
->
rx_fifo_”rÜs
 = 
dev
->stats.rx_fifo_errors;

7779 
¡©s
->
rx_mis£d_”rÜs
 = 
dev
->stats.rx_missed_errors;

7780 
¡©s
->
muÉiÿ¡
 = 
dev
->stats.multicast;

7786 ià(
	`pm_ruÁime_aùive
(&
pdev
->
dev
))

7787 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7793 
¡©s
->
tx_”rÜs
 = 
	`Ë64_to_ıu
(
couÁ”s
->tx_errors) -

7794 
	`Ë64_to_ıu
(

->
tc_off£t
.
tx_”rÜs
);

7795 
¡©s
->
cŞlisiÚs
 = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_muÉi_cŞlisiÚ
) -

7796 
	`Ë32_to_ıu
(

->
tc_off£t
.
tx_muÉi_cŞlisiÚ
);

7797 
¡©s
->
tx_abÜ‹d_”rÜs
 = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_abÜ‹d
) -

7798 
	`Ë16_to_ıu
(

->
tc_off£t
.
tx_abÜ‹d
);

7800 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

7801 
	}
}

7803 
	$¹l8169_Ãt_su¥’d
(
Ãt_deviû
 *
dev
)

7805 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7807 ià(!
	`Ãtif_ruÂšg
(
dev
))

7810 
	`Ãtif_deviû_d‘ach
(
dev
);

7811 
	`Ãtif_¡İ_queue
(
dev
);

7813 
	`¹l_lock_wÜk
(

);

7814 
	`Çpi_di§bË
(&

->
Çpi
);

7815 
	`ş—r_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7816 
	`¹l_uÆock_wÜk
(

);

7818 
	`¹l_¶l_pow”_down
(

);

7819 
	}
}

7821 #ifdeà
CONFIG_PM


7823 
	$¹l8169_su¥’d
(
deviû
 *device)

7825 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7826 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7828 
	`¹l8169_Ãt_su¥’d
(
dev
);

7831 
	}
}

7833 
	$__¹l8169_»sume
(
Ãt_deviû
 *
dev
)

7835 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7837 
	`Ãtif_deviû_©ch
(
dev
);

7839 
	`¹l_¶l_pow”_up
(

);

7841 
	`¹l_lock_wÜk
(

);

7842 
	`Çpi_’abË
(&

->
Çpi
);

7843 
	`£t_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7844 
	`¹l_uÆock_wÜk
(

);

7846 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7847 
	}
}

7849 
	$¹l8169_»sume
(
deviû
 *device)

7851 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7852 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7853 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7855 
	`¹l8169_š™_phy
(
dev
, 

);

7857 ià(
	`Ãtif_ruÂšg
(
dev
))

7858 
	`__¹l8169_»sume
(
dev
);

7861 
	}
}

7863 
	$¹l8169_ruÁime_su¥’d
(
deviû
 *device)

7865 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7866 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7867 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7869 ià(!

->
TxDescA¼ay
) {

7870 
	`¹l_¶l_pow”_down
(

);

7874 
	`¹l_lock_wÜk
(

);

7875 

->
§ved_wŞİts
 = 
	`__¹l8169_g‘_wŞ
(tp);

7876 
	`__¹l8169_£t_wŞ
(

, 
WAKE_ANY
);

7877 
	`¹l_uÆock_wÜk
(

);

7879 
	`¹l8169_Ãt_su¥’d
(
dev
);

7882 
	`¹l8169_rx_mis£d
(
dev
);

7883 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7886 
	}
}

7888 
	$¹l8169_ruÁime_»sume
(
deviû
 *device)

7890 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7891 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7892 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7893 
	`¹l_¿r_£t
(

, 
dev
->
dev_addr
);

7895 ià(!

->
TxDescA¼ay
)

7898 
	`¹l_lock_wÜk
(

);

7899 
	`__¹l8169_£t_wŞ
(

,p->
§ved_wŞİts
);

7900 

->
§ved_wŞİts
 = 0;

7901 
	`¹l_uÆock_wÜk
(

);

7903 
	`¹l8169_š™_phy
(
dev
, 

);

7905 
	`__¹l8169_»sume
(
dev
);

7908 
	}
}

7910 
	$¹l8169_ruÁime_idË
(
deviû
 *device)

7912 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7913 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7915 ià(!
	`Ãtif_ruÂšg
(
dev
è|| !
	`Ãtif_ÿ¼›r_ok
(dev))

7916 
	`pm_scheduË_su¥’d
(
deviû
, 10000);

7918  -
EBUSY
;

7919 
	}
}

7921 cÚ¡ 
dev_pm_İs
 
	g¹l8169_pm_İs
 = {

7922 .
su¥’d
 = 
¹l8169_su¥’d
,

7923 .
	g»sume
 = 
¹l8169_»sume
,

7924 .
	gä“ze
 = 
¹l8169_su¥’d
,

7925 .
	gthaw
 = 
¹l8169_»sume
,

7926 .
	gpow”off
 = 
¹l8169_su¥’d
,

7927 .
	g»¡Üe
 = 
¹l8169_»sume
,

7928 .
	gruÁime_su¥’d
 = 
¹l8169_ruÁime_su¥’d
,

7929 .
	gruÁime_»sume
 = 
¹l8169_ruÁime_»sume
,

7930 .
	gruÁime_idË
 = 
¹l8169_ruÁime_idË
,

7933 
	#RTL8169_PM_OPS
 (&
¹l8169_pm_İs
)

	)

7937 
	#RTL8169_PM_OPS
 
NULL


	)

7941 
	$¹l_wŞ_shutdown_quœk
(
¹l8169_´iv©e
 *

)

7944 

->
mac_v”siÚ
) {

7945 
RTL_GIGA_MAC_VER_11
:

7946 
RTL_GIGA_MAC_VER_12
:

7947 
RTL_GIGA_MAC_VER_17
:

7948 
	`pci_ş—r_ma¡”
(

->
pci_dev
);

7950 
	`RTL_W8
(

, 
ChCmd
, 
CmdRxEnb
);

7952 
	`RTL_R8
(

, 
ChCmd
);

7957 
	}
}

7959 
	$¹l_shutdown
(
pci_dev
 *
pdev
)

7961 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7962 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7964 
	`¹l8169_Ãt_su¥’d
(
dev
);

7967 
	`¹l_¿r_£t
(

, 
dev
->
³rm_addr
);

7969 
	`¹l8169_hw_»£t
(

);

7971 ià(
sy¡em_¡©e
 =ğ
SYSTEM_POWER_OFF
) {

7972 ià(
	`__¹l8169_g‘_wŞ
(

è& 
WAKE_ANY
) {

7973 
	`¹l_wŞ_su¥’d_quœk
(

);

7974 
	`¹l_wŞ_shutdown_quœk
(

);

7977 
	`pci_wake_äom_d3
(
pdev
, 
Œue
);

7978 
	`pci_£t_pow”_¡©e
(
pdev
, 
PCI_D3hÙ
);

7980 
	}
}

7982 
	$¹l_»move_Úe
(
pci_dev
 *
pdev
)

7984 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7985 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7987 ià(
	`r8168_check_dash
(

))

7988 
	`¹l8168_driv”_¡İ
(

);

7990 
	`Ãtif_Çpi_d–
(&

->
Çpi
);

7992 
	`uÄegi¡”_Ãtdev
(
dev
);

7994 
	`¹l_»Ëa£_fœmw¬e
(

);

7996 ià(
	`pci_dev_run_wake
(
pdev
))

7997 
	`pm_ruÁime_g‘_nÜesume
(&
pdev
->
dev
);

8000 
	`¹l_¿r_£t
(

, 
dev
->
³rm_addr
);

8001 
	}
}

8003 cÚ¡ 
Ãt_deviû_İs
 
	g¹l_Ãtdev_İs
 = {

8004 .
ndo_İ’
 = 
¹l_İ’
,

8005 .
	gndo_¡İ
 = 
¹l8169_şo£
,

8006 .
	gndo_g‘_¡©s64
 = 
¹l8169_g‘_¡©s64
,

8007 .
	gndo_¡¬t_xm™
 = 
¹l8169_¡¬t_xm™
,

8008 .
	gndo_tx_timeout
 = 
¹l8169_tx_timeout
,

8009 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

8010 .
	gndo_chªge_mtu
 = 
¹l8169_chªge_mtu
,

8011 .
	gndo_fix_ã©u»s
 = 
¹l8169_fix_ã©u»s
,

8012 .
	gndo_£t_ã©u»s
 = 
¹l8169_£t_ã©u»s
,

8013 .
	gndo_£t_mac_add»ss
 = 
¹l_£t_mac_add»ss
,

8014 .
	gndo_do_ioùl
 = 
¹l8169_ioùl
,

8015 .
	gndo_£t_rx_mode
 = 
¹l_£t_rx_mode
,

8016 #ifdeà
CONFIG_NET_POLL_CONTROLLER


8017 .
	gndo_pŞl_cÚŒŞËr
 = 
¹l8169_ÃŞl
,

8022 cÚ¡ 
	s¹l_cfg_šfo
 {

8023 (*
	mhw_¡¬t
)(
	mÃt_deviû
 *);

8024 
	m»giÚ
;

8025 
	m®ign
;

8026 
u16
 
	mev’t_¦ow
;

8027 
	mhas_gmii
:1;

8028 cÚ¡ 
¹l_cßËsû_šfo
 *
	mcßËsû_šfo
;

8029 
u8
 
	mdeçuÉ_v”
;

8030 } 
	g¹l_cfg_šfos
 [] = {

8031 [
RTL_CFG_0
] = {

8032 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8169
,

8033 .
	g»giÚ
 = 1,

8034 .
	g®ign
 = 0,

8035 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
 | 
RxFIFOOv”
,

8036 .
	ghas_gmii
 = 1,

8037 .
	gcßËsû_šfo
 = 
¹l_cßËsû_šfo_8169
,

8038 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_01
,

8040 [
RTL_CFG_1
] = {

8041 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8168
,

8042 .
	g»giÚ
 = 2,

8043 .
	g®ign
 = 8,

8044 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
,

8045 .
	ghas_gmii
 = 1,

8046 .
	gcßËsû_šfo
 = 
¹l_cßËsû_šfo_8168_8136
,

8047 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_11
,

8049 [
RTL_CFG_2
] = {

8050 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8101
,

8051 .
	g»giÚ
 = 2,

8052 .
	g®ign
 = 8,

8053 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
 | 
RxFIFOOv”
 |

8054 
PCSTimeout
,

8055 .
	gcßËsû_šfo
 = 
¹l_cßËsû_šfo_8168_8136
,

8056 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_13
,

8060 
	$¹l_®loc_œq
(
¹l8169_´iv©e
 *

)

8062 
æags
;

8064 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
) {

8065 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_UÆock
);

8066 
	`RTL_W8
(

, 
CÚfig2
, 
	`RTL_R8
Ñp, CÚfig2è& ~
MSIEÇbË
);

8067 
	`RTL_W8
(

, 
Cfg9346
, 
Cfg9346_Lock
);

8068 
æags
 = 
PCI_IRQ_LEGACY
;

8070 
æags
 = 
PCI_IRQ_ALL_TYPES
;

8073  
	`pci_®loc_œq_veùÜs
(

->
pci_dev
, 1, 1, 
æags
);

8074 
	}
}

8076 
	$DECLARE_RTL_COND
(
¹l_lšk_li¡_»ady_cÚd
)

8078  
	`RTL_R8
(

, 
MCU
è& 
LINK_LIST_RDY
;

8079 
	}
}

8081 
	$DECLARE_RTL_COND
(
¹l_rxtx_em±y_cÚd
)

8083  (
	`RTL_R8
(

, 
MCU
è& 
RXTX_EMPTY
) == RXTX_EMPTY;

8084 
	}
}

8086 
	$¹l_hw_š™_8168g
(
¹l8169_´iv©e
 *

)

8088 
u32
 
d©a
;

8090 

->
oı_ba£
 = 
OCP_STD_PHY_BASE
;

8092 
	`RTL_W32
(

, 
MISC
, 
	`RTL_R32
Ñp, MISCè| 
RXDV_GATED_EN
);

8094 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_txcfg_em±y_cÚd
, 100, 42))

8097 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_rxtx_em±y_cÚd
, 100, 42))

8100 
	`RTL_W8
(

, 
ChCmd
, 
	`RTL_R8
Ñp, ChCmdè& ~(
CmdTxEnb
 | 
CmdRxEnb
));

8101 
	`m¦“p
(1);

8102 
	`RTL_W8
(

, 
MCU
, 
	`RTL_R8
Ñp, MCUè& ~
NOW_IS_OOB
);

8104 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe8de);

8105 
d©a
 &= ~(1 << 14);

8106 
	`r8168_mac_oı_wr™e
(

, 0xe8de, 
d©a
);

8108 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_lšk_li¡_»ady_cÚd
, 100, 42))

8111 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe8de);

8112 
d©a
 |= (1 << 15);

8113 
	`r8168_mac_oı_wr™e
(

, 0xe8de, 
d©a
);

8115 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_lšk_li¡_»ady_cÚd
, 100, 42))

8117 
	}
}

8119 
	$¹l_hw_š™_8168•
(
¹l8169_´iv©e
 *

)

8121 
	`¹l8168•_¡İ_cmac
(

);

8122 
	`¹l_hw_š™_8168g
(

);

8123 
	}
}

8125 
	$¹l_hw_š™Ÿlize
(
¹l8169_´iv©e
 *

)

8127 

->
mac_v”siÚ
) {

8128 
RTL_GIGA_MAC_VER_40
:

8129 
RTL_GIGA_MAC_VER_41
:

8130 
RTL_GIGA_MAC_VER_42
:

8131 
RTL_GIGA_MAC_VER_43
:

8132 
RTL_GIGA_MAC_VER_44
:

8133 
RTL_GIGA_MAC_VER_45
:

8134 
RTL_GIGA_MAC_VER_46
:

8135 
RTL_GIGA_MAC_VER_47
:

8136 
RTL_GIGA_MAC_VER_48
:

8137 
	`¹l_hw_š™_8168g
(

);

8139 
RTL_GIGA_MAC_VER_49
:

8140 
RTL_GIGA_MAC_VER_50
:

8141 
RTL_GIGA_MAC_VER_51
:

8142 
	`¹l_hw_š™_8168•
(

);

8147 
	}
}

8149 
	$¹l_š™_Úe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
’t
)

8151 cÚ¡ 
¹l_cfg_šfo
 *
cfg
 = 
¹l_cfg_šfos
 + 
’t
->
driv”_d©a
;

8152 cÚ¡ 
»giÚ
 = 
cfg
->region;

8153 
¹l8169_´iv©e
 *

;

8154 
mii_if_šfo
 *
mii
;

8155 
Ãt_deviû
 *
dev
;

8156 
ch£t
, 
i
;

8157 
rc
;

8159 ià(
	`Ãtif_msg_drv
(&
debug
)) {

8160 
	`´štk
(
KERN_INFO
 "%s Gigabit Ethernet driver %s†oaded\n",

8161 
MODULENAME
, 
RTL8169_VERSION
);

8164 
dev
 = 
	`devm_®loc_‘h”dev
(&
pdev
->dev,  (*

));

8165 ià(!
dev
)

8166  -
ENOMEM
;

8168 
	`SET_NETDEV_DEV
(
dev
, &
pdev
->dev);

8169 
dev
->
Ãtdev_İs
 = &
¹l_Ãtdev_İs
;

8170 

 = 
	`Ãtdev_´iv
(
dev
);

8171 

->
dev
 = dev;

8172 

->
pci_dev
 = 
pdev
;

8173 

->
msg_’abË
 = 
	`Ãtif_msg_š™
(
debug
.msg_’abË, 
R8169_MSG_DEFAULT
);

8175 
mii
 = &

->mii;

8176 
mii
->
dev
 = dev;

8177 
mii
->
mdio_»ad
 = 
¹l_mdio_»ad
;

8178 
mii
->
mdio_wr™e
 = 
¹l_mdio_wr™e
;

8179 
mii
->
phy_id_mask
 = 0x1f;

8180 
mii
->
»g_num_mask
 = 0x1f;

8181 
mii
->
suµÜts_gmii
 = 
cfg
->
has_gmii
;

8185 
	`pci_di§bË_lšk_¡©e
(
pdev
, 
PCIE_LINK_STATE_L0S
 | 
PCIE_LINK_STATE_L1
 |

8186 
PCIE_LINK_STATE_CLKPM
);

8189 
rc
 = 
	`pcim_’abË_deviû
(
pdev
);

8190 ià(
rc
 < 0) {

8191 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "enable failure\n");

8192  
rc
;

8195 ià(
	`pcim_£t_mwi
(
pdev
) < 0)

8196 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "Mem-Wr-Inval unavailable\n");

8199 ià(!(
	`pci_»sourû_æags
(
pdev
, 
»giÚ
è& 
IORESOURCE_MEM
)) {

8200 
	`Ãtif_”r
(

, 
´obe
, 
dev
,

8202 
»giÚ
);

8203  -
ENODEV
;

8207 ià(
	`pci_»sourû_Ën
(
pdev
, 
»giÚ
è< 
R8169_REGS_SIZE
) {

8208 
	`Ãtif_”r
(

, 
´obe
, 
dev
,

8210  -
ENODEV
;

8213 
rc
 = 
	`pcim_iom­_»giÚs
(
pdev
, 
	`BIT
(
»giÚ
), 
MODULENAME
);

8214 ià(
rc
 < 0) {

8215 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "cannot„emap MMIO,‡borting\n");

8216  
rc
;

8219 

->
mmio_addr
 = 
	`pcim_iom­_bË
(
pdev
)[
»giÚ
];

8221 ià(!
	`pci_is_pc›
(
pdev
))

8222 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "not PCI Express\n");

8225 
	`¹l8169_g‘_mac_v”siÚ
(

, 
dev
, 
cfg
->
deçuÉ_v”
);

8227 

->
ı_cmd
 = 0;

8229 ià(((
dma_addr_t
) > 4) &&

8230 (
u£_dac
 =ğ1 || (u£_daø=ğ-1 && 
	`pci_is_pc›
(
pdev
) &&

8231 

->
mac_v”siÚ
 >ğ
RTL_GIGA_MAC_VER_18
)) &&

8232 !
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64)) &&

8233 !
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64))) {

8236 ià(!
	`pci_is_pc›
(
pdev
))

8237 

->
ı_cmd
 |ğ
PCIDAC
;

8238 
dev
->
ã©u»s
 |ğ
NETIF_F_HIGHDMA
;

8240 
rc
 = 
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

8241 ià(
rc
 < 0) {

8242 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "DMA configuration failed\n");

8243  
rc
;

8247 
	`¹l_š™_rxcfg
(

);

8249 
	`¹l_œq_di§bË
(

);

8251 
	`¹l_hw_š™Ÿlize
(

);

8253 
	`¹l_hw_»£t
(

);

8255 
	`¹l_ack_ev’ts
(

, 0xffff);

8257 
	`pci_£t_ma¡”
(
pdev
);

8259 
	`¹l_š™_mdio_İs
(

);

8260 
	`¹l_š™_¶l_pow”_İs
(

);

8261 
	`¹l_š™_jumbo_İs
(

);

8262 
	`¹l_š™_csi_İs
(

);

8264 
	`¹l8169_´št_mac_v”siÚ
(

);

8266 
ch£t
 = 

->
mac_v”siÚ
;

8267 

->
txd_v”siÚ
 = 
¹l_ch_šfos
[
ch£t
].txd_version;

8269 
rc
 = 
	`¹l_®loc_œq
(

);

8270 ià(
rc
 < 0) {

8271 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "Can't‡llocate interrupt\n");

8272  
rc
;

8275 

->
§ved_wŞİts
 = 
	`__¹l8169_g‘_wŞ
(tp);

8277 ià(
	`¹l_tbi_’abËd
(

)) {

8278 

->
£t_¥“d
 = 
¹l8169_£t_¥“d_tbi
;

8279 

->
g‘_lšk_k£‰šgs
 = 
¹l8169_g‘_lšk_k£‰šgs_tbi
;

8280 

->
phy_»£t_’abË
 = 
¹l8169_tbi_»£t_’abË
;

8281 

->
phy_»£t_³ndšg
 = 
¹l8169_tbi_»£t_³ndšg
;

8282 

->
lšk_ok
 = 
¹l8169_tbi_lšk_ok
;

8283 

->
do_ioùl
 = 
¹l_tbi_ioùl
;

8285 

->
£t_¥“d
 = 
¹l8169_£t_¥“d_xmii
;

8286 

->
g‘_lšk_k£‰šgs
 = 
¹l8169_g‘_lšk_k£‰šgs_xmii
;

8287 

->
phy_»£t_’abË
 = 
¹l8169_xmii_»£t_’abË
;

8288 

->
phy_»£t_³ndšg
 = 
¹l8169_xmii_»£t_³ndšg
;

8289 

->
lšk_ok
 = 
¹l8169_xmii_lšk_ok
;

8290 

->
do_ioùl
 = 
¹l_xmii_ioùl
;

8293 
	`mu‹x_š™
(&

->
wk
.
mu‹x
);

8294 
	`u64_¡©s_š™
(&

->
rx_¡©s
.
synı
);

8295 
	`u64_¡©s_š™
(&

->
tx_¡©s
.
synı
);

8298 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

8299 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
 ||

8300 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
 ||

8301 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
 ||

8302 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_40
 ||

8303 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_41
 ||

8304 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
 ||

8305 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_43
 ||

8306 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_44
 ||

8307 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
 ||

8308 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
 ||

8309 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_47
 ||

8310 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_48
 ||

8311 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

8312 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

8313 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) {

8314 
u16
 
mac_addr
[3];

8316 *(
u32
 *)&
mac_addr
[0] = 
	`¹l_”i_»ad
(

, 0xe0, 
ERIAR_EXGMAC
);

8317 *(
u16
 *)&
mac_addr
[2] = 
	`¹l_”i_»ad
(

, 0xe4, 
ERIAR_EXGMAC
);

8319 ià(
	`is_v®id_‘h”_addr
((
u8
 *)
mac_addr
))

8320 
	`¹l_¿r_£t
(

, (
u8
 *)
mac_addr
);

8322 
i
 = 0; i < 
ETH_ALEN
; i++)

8323 
dev
->
dev_addr
[
i
] = 
	`RTL_R8
(

, 
MAC0
 + i);

8325 
dev
->
‘htoŞ_İs
 = &
¹l8169_‘htoŞ_İs
;

8326 
dev
->
w©chdog_timeo
 = 
RTL8169_TX_TIMEOUT
;

8328 
	`Ãtif_Çpi_add
(
dev
, &

->
Çpi
, 
¹l8169_pŞl
, 
R8169_NAPI_WEIGHT
);

8332 
dev
->
ã©u»s
 |ğ
NETIF_F_RXCSUM
 |

8333 
NETIF_F_HW_VLAN_CTAG_TX
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

8335 
dev
->
hw_ã©u»s
 = 
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

8336 
NETIF_F_RXCSUM
 | 
NETIF_F_HW_VLAN_CTAG_TX
 |

8337 
NETIF_F_HW_VLAN_CTAG_RX
;

8338 
dev
->
vÏn_ã©u»s
 = 
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

8339 
NETIF_F_HIGHDMA
;

8341 

->
ı_cmd
 |ğ
RxChkSum
 | 
RxVÏn
;

8347 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_05
)

8349 
dev
->
hw_ã©u»s
 &ğ~
NETIF_F_HW_VLAN_CTAG_RX
;

8351 ià(

->
txd_v”siÚ
 =ğ
RTL_TD_0
)

8352 

->
tso_csum
 = 
¹l8169_tso_csum_v1
;

8353 ià(

->
txd_v”siÚ
 =ğ
RTL_TD_1
) {

8354 

->
tso_csum
 = 
¹l8169_tso_csum_v2
;

8355 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_IPV6_CSUM
 | 
NETIF_F_TSO6
;

8357 
	`WARN_ON_ONCE
(1);

8359 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXALL
;

8360 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXFCS
;

8363 
dev
->
mš_mtu
 = 
ETH_ZLEN
;

8364 
dev
->
max_mtu
 = 
¹l_ch_šfos
[
ch£t
].
jumbo_max
;

8366 

->
hw_¡¬t
 = 
cfg
->hw_start;

8367 

->
ev’t_¦ow
 = 
cfg
->event_slow;

8368 

->
cßËsû_šfo
 = 
cfg
->coalesce_info;

8370 

->
İts1_mask
 = (->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_01
) ?

8371 ~(
RxBOVF
 | 
RxFOVF
) : ~0;

8373 
	`tim”_£tup
(&

->
tim”
, 
¹l8169_phy_tim”
, 0);

8375 

->
¹l_fw
 = 
RTL_FIRMWARE_UNKNOWN
;

8377 

->
couÁ”s
 = 
	`dmam_®loc_coh”’t
 (&
pdev
->
dev
, (*tp->counters),

8378 &

->
couÁ”s_phys_addr
,

8379 
GFP_KERNEL
);

8380 ià(!

->
couÁ”s
)

8381  -
ENOMEM
;

8383 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

8385 
rc
 = 
	`»gi¡”_Ãtdev
(
dev
);

8386 ià(
rc
 < 0)

8387  
rc
;

8389 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "%s‡t 0x%p, %pM, XID %08x IRQ %d\n",

8390 
¹l_ch_šfos
[
ch£t
].
Çme
, 

->
mmio_addr
, 
dev
->
dev_addr
,

8391 (
u32
)(
	`RTL_R32
(

, 
TxCÚfig
) & 0x9cf0f8ff),

8392 
	`pci_œq_veùÜ
(
pdev
, 0));

8393 ià(
¹l_ch_šfos
[
ch£t
].
jumbo_max
 !ğ
JUMBO_1K
) {

8394 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "jumbo features [frames: %d bytes, "

8396 
¹l_ch_šfos
[
ch£t
].
jumbo_max
,

8397 
¹l_ch_šfos
[
ch£t
].
jumbo_tx_csum
 ? "ok" : "ko");

8400 ià(
	`r8168_check_dash
(

))

8401 
	`¹l8168_driv”_¡¬t
(

);

8403 
	`Ãtif_ÿ¼›r_off
(
dev
);

8405 ià(
	`pci_dev_run_wake
(
pdev
))

8406 
	`pm_ruÁime_put_sync
(&
pdev
->
dev
);

8409 
	}
}

8411 
pci_driv”
 
	g¹l8169_pci_driv”
 = {

8412 .
Çme
 = 
MODULENAME
,

8413 .
	gid_bË
 = 
¹l8169_pci_tbl
,

8414 .
	g´obe
 = 
¹l_š™_Úe
,

8415 .
	g»move
 = 
¹l_»move_Úe
,

8416 .
	gshutdown
 = 
¹l_shutdown
,

8417 .
	gdriv”
.
	gpm
 = 
RTL8169_PM_OPS
,

8420 
moduË_pci_driv”
(
¹l8169_pci_driv”
);

	@r8169.c

11 
	~<lšux/moduË.h
>

12 
	~<lšux/moduË·¿m.h
>

13 
	~<lšux/pci.h
>

14 
	~<lšux/Ãtdeviû.h
>

15 
	~<lšux/‘h”deviû.h
>

16 
	~<lšux/d–ay.h
>

17 
	~<lšux/‘htoŞ.h
>

18 
	~<lšux/mii.h
>

19 
	~<lšux/if_vÏn.h
>

20 
	~<lšux/üc32.h
>

21 
	~<lšux/š.h
>

22 
	~<lšux/.h
>

23 
	~<lšux/tı.h
>

24 
	~<lšux/š‹¼u±.h
>

25 
	~<lšux/dma-m­pšg.h
>

26 
	~<lšux/pm_ruÁime.h
>

27 
	~<lšux/fœmw¬e.h
>

28 
	~<lšux/pci-a¥m.h
>

29 
	~<lšux/´eãtch.h
>

30 
	~<lšux/v6.h
>

31 
	~<Ãt/6_checksum.h
>

32 
	~<lšux/bpf.h
>

33 
	~<lšux/rcupd©e.h
>

35 
	~<asm/io.h
>

36 
	~<asm/œq.h
>

38 
	#RTL8169_VERSION
 "2.3LK-NAPI"

	)

39 
	#MODULENAME
 "r8169"

	)

40 
	#PFX
 
MODULENAME
 ": "

	)

42 
	#FIRMWARE_8168D_1
 "¹l_nic/¹l8168d-1.fw"

	)

43 
	#FIRMWARE_8168D_2
 "¹l_nic/¹l8168d-2.fw"

	)

44 
	#FIRMWARE_8168E_1
 "¹l_nic/¹l8168e-1.fw"

	)

45 
	#FIRMWARE_8168E_2
 "¹l_nic/¹l8168e-2.fw"

	)

46 
	#FIRMWARE_8168E_3
 "¹l_nic/¹l8168e-3.fw"

	)

47 
	#FIRMWARE_8168F_1
 "¹l_nic/¹l8168f-1.fw"

	)

48 
	#FIRMWARE_8168F_2
 "¹l_nic/¹l8168f-2.fw"

	)

49 
	#FIRMWARE_8105E_1
 "¹l_nic/¹l8105e-1.fw"

	)

50 
	#FIRMWARE_8402_1
 "¹l_nic/¹l8402-1.fw"

	)

51 
	#FIRMWARE_8411_1
 "¹l_nic/¹l8411-1.fw"

	)

52 
	#FIRMWARE_8411_2
 "¹l_nic/¹l8411-2.fw"

	)

53 
	#FIRMWARE_8106E_1
 "¹l_nic/¹l8106e-1.fw"

	)

54 
	#FIRMWARE_8106E_2
 "¹l_nic/¹l8106e-2.fw"

	)

55 
	#FIRMWARE_8168G_2
 "¹l_nic/¹l8168g-2.fw"

	)

56 
	#FIRMWARE_8168G_3
 "¹l_nic/¹l8168g-3.fw"

	)

57 
	#FIRMWARE_8168H_1
 "¹l_nic/¹l8168h-1.fw"

	)

58 
	#FIRMWARE_8168H_2
 "¹l_nic/¹l8168h-2.fw"

	)

59 
	#FIRMWARE_8107E_1
 "¹l_nic/¹l8107e-1.fw"

	)

60 
	#FIRMWARE_8107E_2
 "¹l_nic/¹l8107e-2.fw"

	)

62 #ifdeà
RTL8169_DEBUG


63 
	#as£¹
(
ex´
) \

64 ià(!(
ex´
)) { \

65 
	`´štk
( "Assertion failed! %s,%s,%s,line=%d\n", \

66 #ex´,
__FILE__
,
__func__
,
__LINE__
); \

67 }

	)

68 
	#d´štk
(
fmt
, 
¬gs
...) \

69 dØ{ 
	`´štk
(
KERN_DEBUG
 
PFX
 
fmt
, ## 
¬gs
); } 0)

	)

71 
	#as£¹
(
ex´
èdØ{} 0)

	)

72 
	#d´štk
(
fmt
, 
¬gs
...èdØ{} 0)

	)

75 
	#R8169_MSG_DEFAULT
 \

76 (
NETIF_MSG_DRV
 | 
NETIF_MSG_PROBE
 | 
NETIF_MSG_IFUP
 | 
NETIF_MSG_IFDOWN
)

	)

78 
	#TX_SLOTS_AVAIL
(

) \

79 (

->
dœty_tx
 + 
NUM_TX_DESC
 -p->
cur_tx
)

	)

82 
	#TX_FRAGS_READY_FOR
(

,
Ä_äags
) \

83 (
	`TX_SLOTS_AVAIL
(

è>ğ(
Ä_äags
 + 1))

	)

87 cÚ¡ 
	gmuÉiÿ¡_f‹r_lim™
 = 32;

89 
	#MAX_READ_REQUEST_SHIFT
 12

	)

90 
	#TX_DMA_BURST
 7

	)

91 
	#IÁ”F¿meG­
 0x03

	)

93 
	#R8169_REGS_SIZE
 256

	)

94 
	#R8169_NAPI_WEIGHT
 64

	)

95 
	#NUM_TX_DESC
 64

	)

96 
	#NUM_RX_DESC
 256U

	)

97 
	#R8169_TX_RING_BYTES
 (
NUM_TX_DESC
 * (
TxDesc
))

	)

98 
	#R8169_RX_RING_BYTES
 (
NUM_RX_DESC
 * (
RxDesc
))

	)

100 
	#RTL8169_TX_TIMEOUT
 (6*
HZ
)

	)

101 
	#RTL8169_PHY_TIMEOUT
 (10*
HZ
)

	)

104 
	#RTL_W8
(
»g
, 
v®8
è
	`wr™eb
 ((v®8), 
ißddr
 + (»g))

	)

105 
	#RTL_W16
(
»g
, 
v®16
è
	`wr™ew
 ((v®16), 
ißddr
 + (»g))

	)

106 
	#RTL_W32
(
»g
, 
v®32
è
	`wr™–
 ((v®32), 
ißddr
 + (»g))

	)

107 
	#RTL_R8
(
»g
è
	`»adb
 (
ißddr
 + (»g))

	)

108 
	#RTL_R16
(
»g
è
	`»adw
 (
ißddr
 + (»g))

	)

109 
	#RTL_R32
(
»g
è
	`»adl
 (
ißddr
 + (»g))

	)

111 
	emac_v”siÚ
 {

112 
	mRTL_GIGA_MAC_VER_01
 = 0,

113 
	mRTL_GIGA_MAC_VER_02
,

114 
	mRTL_GIGA_MAC_VER_03
,

115 
	mRTL_GIGA_MAC_VER_04
,

116 
	mRTL_GIGA_MAC_VER_05
,

117 
	mRTL_GIGA_MAC_VER_06
,

118 
	mRTL_GIGA_MAC_VER_07
,

119 
	mRTL_GIGA_MAC_VER_08
,

120 
	mRTL_GIGA_MAC_VER_09
,

121 
	mRTL_GIGA_MAC_VER_10
,

122 
	mRTL_GIGA_MAC_VER_11
,

123 
	mRTL_GIGA_MAC_VER_12
,

124 
	mRTL_GIGA_MAC_VER_13
,

125 
	mRTL_GIGA_MAC_VER_14
,

126 
	mRTL_GIGA_MAC_VER_15
,

127 
	mRTL_GIGA_MAC_VER_16
,

128 
	mRTL_GIGA_MAC_VER_17
,

129 
	mRTL_GIGA_MAC_VER_18
,

130 
	mRTL_GIGA_MAC_VER_19
,

131 
	mRTL_GIGA_MAC_VER_20
,

132 
	mRTL_GIGA_MAC_VER_21
,

133 
	mRTL_GIGA_MAC_VER_22
,

134 
	mRTL_GIGA_MAC_VER_23
,

135 
	mRTL_GIGA_MAC_VER_24
,

136 
	mRTL_GIGA_MAC_VER_25
,

137 
	mRTL_GIGA_MAC_VER_26
,

138 
	mRTL_GIGA_MAC_VER_27
,

139 
	mRTL_GIGA_MAC_VER_28
,

140 
	mRTL_GIGA_MAC_VER_29
,

141 
	mRTL_GIGA_MAC_VER_30
,

142 
	mRTL_GIGA_MAC_VER_31
,

143 
	mRTL_GIGA_MAC_VER_32
,

144 
	mRTL_GIGA_MAC_VER_33
,

145 
	mRTL_GIGA_MAC_VER_34
,

146 
	mRTL_GIGA_MAC_VER_35
,

147 
	mRTL_GIGA_MAC_VER_36
,

148 
	mRTL_GIGA_MAC_VER_37
,

149 
	mRTL_GIGA_MAC_VER_38
,

150 
	mRTL_GIGA_MAC_VER_39
,

151 
	mRTL_GIGA_MAC_VER_40
,

152 
	mRTL_GIGA_MAC_VER_41
,

153 
	mRTL_GIGA_MAC_VER_42
,

154 
	mRTL_GIGA_MAC_VER_43
,

155 
	mRTL_GIGA_MAC_VER_44
,

156 
	mRTL_GIGA_MAC_VER_45
,

157 
	mRTL_GIGA_MAC_VER_46
,

158 
	mRTL_GIGA_MAC_VER_47
,

159 
	mRTL_GIGA_MAC_VER_48
,

160 
	mRTL_GIGA_MAC_VER_49
,

161 
	mRTL_GIGA_MAC_VER_50
,

162 
	mRTL_GIGA_MAC_VER_51
,

163 
	mRTL_GIGA_MAC_NONE
 = 0xff,

166 
	e¹l_tx_desc_v”siÚ
 {

167 
	mRTL_TD_0
 = 0,

168 
	mRTL_TD_1
 = 1,

171 
	#JUMBO_1K
 
ETH_DATA_LEN


	)

172 
	#JUMBO_4K
 (4*1024 - 
ETH_HLEN
 - 2)

	)

173 
	#JUMBO_6K
 (6*1024 - 
ETH_HLEN
 - 2)

	)

174 
	#JUMBO_7K
 (7*1024 - 
ETH_HLEN
 - 2)

	)

175 
	#JUMBO_9K
 (9*1024 - 
ETH_HLEN
 - 2)

	)

177 
	#_R
(
NAME
,
TD
,
FW
,
SZ
,
B
) { \

178 .
Çme
 = 
NAME
, \

179 .
txd_v”siÚ
 = 
TD
, \

180 .
fw_Çme
 = 
FW
, \

181 .
jumbo_max
 = 
SZ
, \

182 .
jumbo_tx_csum
 = 
B
 \

183 }

	)

186 cÚ¡ *
	mÇme
;

187 
¹l_tx_desc_v”siÚ
 
	mtxd_v”siÚ
;

188 cÚ¡ *
	mfw_Çme
;

189 
u16
 
	mjumbo_max
;

190 
boŞ
 
	mjumbo_tx_csum
;

191 } 
	g¹l_ch_šfos
[] = {

193 [
RTL_GIGA_MAC_VER_01
] =

194 
_R
("RTL8169", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

195 [
RTL_GIGA_MAC_VER_02
] =

196 
_R
("RTL8169s", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

197 [
RTL_GIGA_MAC_VER_03
] =

198 
_R
("RTL8110s", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

199 [
RTL_GIGA_MAC_VER_04
] =

200 
_R
("RTL8169sb/8110sb", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

201 [
RTL_GIGA_MAC_VER_05
] =

202 
_R
("RTL8169sc/8110sc", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

203 [
RTL_GIGA_MAC_VER_06
] =

204 
_R
("RTL8169sc/8110sc", 
RTL_TD_0
, 
NULL
, 
JUMBO_7K
, 
Œue
),

206 [
RTL_GIGA_MAC_VER_07
] =

207 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

208 [
RTL_GIGA_MAC_VER_08
] =

209 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

210 [
RTL_GIGA_MAC_VER_09
] =

211 
_R
("RTL8102e", 
RTL_TD_1
, 
NULL
, 
JUMBO_1K
, 
Œue
),

212 [
RTL_GIGA_MAC_VER_10
] =

213 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

214 [
RTL_GIGA_MAC_VER_11
] =

215 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

216 [
RTL_GIGA_MAC_VER_12
] =

217 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

218 [
RTL_GIGA_MAC_VER_13
] =

219 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

220 [
RTL_GIGA_MAC_VER_14
] =

221 
_R
("RTL8100e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

222 [
RTL_GIGA_MAC_VER_15
] =

223 
_R
("RTL8100e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

224 [
RTL_GIGA_MAC_VER_16
] =

225 
_R
("RTL8101e", 
RTL_TD_0
, 
NULL
, 
JUMBO_1K
, 
Œue
),

226 [
RTL_GIGA_MAC_VER_17
] =

227 
_R
("RTL8168b/8111b", 
RTL_TD_0
, 
NULL
, 
JUMBO_4K
, 
çl£
),

228 [
RTL_GIGA_MAC_VER_18
] =

229 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

230 [
RTL_GIGA_MAC_VER_19
] =

231 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

232 [
RTL_GIGA_MAC_VER_20
] =

233 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

234 [
RTL_GIGA_MAC_VER_21
] =

235 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

236 [
RTL_GIGA_MAC_VER_22
] =

237 
_R
("RTL8168c/8111c", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

238 [
RTL_GIGA_MAC_VER_23
] =

239 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

240 [
RTL_GIGA_MAC_VER_24
] =

241 
_R
("RTL8168ı/8111ı", 
RTL_TD_1
, 
NULL
, 
JUMBO_6K
, 
çl£
),

242 [
RTL_GIGA_MAC_VER_25
] =

243 
_R
("RTL8168d/8111d", 
RTL_TD_1
, 
FIRMWARE_8168D_1
,

244 
JUMBO_9K
, 
çl£
),

245 [
RTL_GIGA_MAC_VER_26
] =

246 
_R
("RTL8168d/8111d", 
RTL_TD_1
, 
FIRMWARE_8168D_2
,

247 
JUMBO_9K
, 
çl£
),

248 [
RTL_GIGA_MAC_VER_27
] =

249 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

250 [
RTL_GIGA_MAC_VER_28
] =

251 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

252 [
RTL_GIGA_MAC_VER_29
] =

253 
_R
("RTL8105e", 
RTL_TD_1
, 
FIRMWARE_8105E_1
,

254 
JUMBO_1K
, 
Œue
),

255 [
RTL_GIGA_MAC_VER_30
] =

256 
_R
("RTL8105e", 
RTL_TD_1
, 
FIRMWARE_8105E_1
,

257 
JUMBO_1K
, 
Œue
),

258 [
RTL_GIGA_MAC_VER_31
] =

259 
_R
("RTL8168dp/8111dp", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

260 [
RTL_GIGA_MAC_VER_32
] =

261 
_R
("RTL8168e/8111e", 
RTL_TD_1
, 
FIRMWARE_8168E_1
,

262 
JUMBO_9K
, 
çl£
),

263 [
RTL_GIGA_MAC_VER_33
] =

264 
_R
("RTL8168e/8111e", 
RTL_TD_1
, 
FIRMWARE_8168E_2
,

265 
JUMBO_9K
, 
çl£
),

266 [
RTL_GIGA_MAC_VER_34
] =

267 
_R
("RTL8168evl/8111evl",
RTL_TD_1
, 
FIRMWARE_8168E_3
,

268 
JUMBO_9K
, 
çl£
),

269 [
RTL_GIGA_MAC_VER_35
] =

270 
_R
("RTL8168f/8111f", 
RTL_TD_1
, 
FIRMWARE_8168F_1
,

271 
JUMBO_9K
, 
çl£
),

272 [
RTL_GIGA_MAC_VER_36
] =

273 
_R
("RTL8168f/8111f", 
RTL_TD_1
, 
FIRMWARE_8168F_2
,

274 
JUMBO_9K
, 
çl£
),

275 [
RTL_GIGA_MAC_VER_37
] =

276 
_R
("RTL8402", 
RTL_TD_1
, 
FIRMWARE_8402_1
,

277 
JUMBO_1K
, 
Œue
),

278 [
RTL_GIGA_MAC_VER_38
] =

279 
_R
("RTL8411", 
RTL_TD_1
, 
FIRMWARE_8411_1
,

280 
JUMBO_9K
, 
çl£
),

281 [
RTL_GIGA_MAC_VER_39
] =

282 
_R
("RTL8106e", 
RTL_TD_1
, 
FIRMWARE_8106E_1
,

283 
JUMBO_1K
, 
Œue
),

284 [
RTL_GIGA_MAC_VER_40
] =

285 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
FIRMWARE_8168G_2
,

286 
JUMBO_9K
, 
çl£
),

287 [
RTL_GIGA_MAC_VER_41
] =

288 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
NULL
, 
JUMBO_9K
, 
çl£
),

289 [
RTL_GIGA_MAC_VER_42
] =

290 
_R
("RTL8168g/8111g", 
RTL_TD_1
, 
FIRMWARE_8168G_3
,

291 
JUMBO_9K
, 
çl£
),

292 [
RTL_GIGA_MAC_VER_43
] =

293 
_R
("RTL8106e", 
RTL_TD_1
, 
FIRMWARE_8106E_2
,

294 
JUMBO_1K
, 
Œue
),

295 [
RTL_GIGA_MAC_VER_44
] =

296 
_R
("RTL8411", 
RTL_TD_1
, 
FIRMWARE_8411_2
,

297 
JUMBO_9K
, 
çl£
),

298 [
RTL_GIGA_MAC_VER_45
] =

299 
_R
("RTL8168h/8111h", 
RTL_TD_1
, 
FIRMWARE_8168H_1
,

300 
JUMBO_9K
, 
çl£
),

301 [
RTL_GIGA_MAC_VER_46
] =

302 
_R
("RTL8168h/8111h", 
RTL_TD_1
, 
FIRMWARE_8168H_2
,

303 
JUMBO_9K
, 
çl£
),

304 [
RTL_GIGA_MAC_VER_47
] =

305 
_R
("RTL8107e", 
RTL_TD_1
, 
FIRMWARE_8107E_1
,

306 
JUMBO_1K
, 
çl£
),

307 [
RTL_GIGA_MAC_VER_48
] =

308 
_R
("RTL8107e", 
RTL_TD_1
, 
FIRMWARE_8107E_2
,

309 
JUMBO_1K
, 
çl£
),

310 [
RTL_GIGA_MAC_VER_49
] =

311 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

312 
JUMBO_9K
, 
çl£
),

313 [
RTL_GIGA_MAC_VER_50
] =

314 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

315 
JUMBO_9K
, 
çl£
),

316 [
RTL_GIGA_MAC_VER_51
] =

317 
_R
("RTL8168•/8111•", 
RTL_TD_1
, 
NULL
,

318 
JUMBO_9K
, 
çl£
),

320 #undeà
_R


322 
	ecfg_v”siÚ
 {

323 
	mRTL_CFG_0
 = 0x00,

324 
	mRTL_CFG_1
,

325 
	mRTL_CFG_2


328 cÚ¡ 
pci_deviû_id
 
	g¹l8169_pci_tbl
[] = {

329 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8129), 0, 0, 
RTL_CFG_0
 },

330 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8136), 0, 0, 
RTL_CFG_2
 },

331 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8161), 0, 0, 
RTL_CFG_1
 },

332 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8167), 0, 0, 
RTL_CFG_0
 },

333 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8168), 0, 0, 
RTL_CFG_1
 },

334 { 
PCI_DEVICE
(
PCI_VENDOR_ID_REALTEK
, 0x8169), 0, 0, 
RTL_CFG_0
 },

335 { 
PCI_VENDOR_ID_DLINK
, 0x4300,

336 
PCI_VENDOR_ID_DLINK
, 0x4b10, 0, 0, 
RTL_CFG_1
 },

337 { 
PCI_DEVICE
(
PCI_VENDOR_ID_DLINK
, 0x4300), 0, 0, 
RTL_CFG_0
 },

338 { 
PCI_DEVICE
(
PCI_VENDOR_ID_DLINK
, 0x4302), 0, 0, 
RTL_CFG_0
 },

339 { 
PCI_DEVICE
(
PCI_VENDOR_ID_AT
, 0xc107), 0, 0, 
RTL_CFG_0
 },

340 { 
PCI_DEVICE
(0x16ec, 0x0116), 0, 0, 
RTL_CFG_0
 },

341 { 
PCI_VENDOR_ID_LINKSYS
, 0x1032,

342 
PCI_ANY_ID
, 0x0024, 0, 0, 
RTL_CFG_0
 },

344 
PCI_ANY_ID
, 0x2410, 0, 0, 
RTL_CFG_2
 },

348 
MODULE_DEVICE_TABLE
(
pci
, 
¹l8169_pci_tbl
);

350 
	grx_buf_sz
 = 16383;

351 
	gu£_dac
 = -1;

353 
u32
 
	mmsg_’abË
;

354 } 
	gdebug
 = { -1 };

356 
	e¹l_»gi¡”s
 {

357 
	mMAC0
 = 0,

358 
	mMAC4
 = 4,

359 
	mMAR0
 = 8,

360 
	mCouÁ”AddrLow
 = 0x10,

361 
	mCouÁ”AddrHigh
 = 0x14,

362 
	mTxDescS¹AddrLow
 = 0x20,

363 
	mTxDescS¹AddrHigh
 = 0x24,

364 
	mTxHDescS¹AddrLow
 = 0x28,

365 
	mTxHDescS¹AddrHigh
 = 0x2c,

366 
	mFLASH
 = 0x30,

367 
	mERSR
 = 0x36,

368 
	mChCmd
 = 0x37,

369 
	mTxPŞl
 = 0x38,

370 
	mIÁrMask
 = 0x3c,

371 
	mIÁrStus
 = 0x3e,

373 
	mTxCÚfig
 = 0x40,

374 
	#TXCFG_AUTO_FIFO
 (1 << 7è

	)

375 
	#TXCFG_EMPTY
 (1 << 11è

	)

377 
	mRxCÚfig
 = 0x44,

378 
	#RX128_INT_EN
 (1 << 15è

	)

379 
	#RX_MULTI_EN
 (1 << 14è

	)

380 
	#RXCFG_FIFO_SHIFT
 13

	)

382 
	#RX_FIFO_THRESH
 (7 << 
RXCFG_FIFO_SHIFT
)

	)

383 
	#RX_EARLY_OFF
 (1 << 11)

	)

384 
	#RXCFG_DMA_SHIFT
 8

	)

386 
	#RX_DMA_BURST
 (7 << 
RXCFG_DMA_SHIFT
)

	)

388 
	mRxMis£d
 = 0x4c,

389 
	mCfg9346
 = 0x50,

390 
	mCÚfig0
 = 0x51,

391 
	mCÚfig1
 = 0x52,

392 
	mCÚfig2
 = 0x53,

393 
	#PME_SIGNAL
 (1 << 5è

	)

395 
	mCÚfig3
 = 0x54,

396 
	mCÚfig4
 = 0x55,

397 
	mCÚfig5
 = 0x56,

398 
	mMuÉiIÁr
 = 0x5c,

399 
	mPHYAR
 = 0x60,

400 
	mPHY¡©us
 = 0x6c,

401 
	mRxMaxSize
 = 0xda,

402 
	mCPlusCmd
 = 0xe0,

403 
	mIÁrM™ig©e
 = 0xe2,

404 
	mRxDescAddrLow
 = 0xe4,

405 
	mRxDescAddrHigh
 = 0xe8,

406 
	mE¬lyTxTh»s
 = 0xec,

408 
	#NoE¬lyTx
 0x3à

	)

410 
	mMaxTxPack‘Size
 = 0xec,

412 
	#TxPack‘Max
 (8064 >> 7)

	)

413 
	#E¬lySize
 0x27

	)

415 
	mFuncEv’t
 = 0xf0,

416 
	mFuncEv’tMask
 = 0xf4,

417 
	mFuncP»£tS‹
 = 0xf8,

418 
	mIBCR0
 = 0xf8,

419 
	mIBCR2
 = 0xf9,

420 
	mIBIMR0
 = 0xfa,

421 
	mIBISR0
 = 0xfb,

422 
	mFuncFÜûEv’t
 = 0xfc,

425 
	e¹l8110_»gi¡”s
 {

426 
	mTBICSR
 = 0x64,

427 
	mTBI_ANAR
 = 0x68,

428 
	mTBI_LPAR
 = 0x6a,

431 
	e¹l8168_8101_»gi¡”s
 {

432 
	mCSIDR
 = 0x64,

433 
	mCSIAR
 = 0x68,

434 
	#CSIAR_FLAG
 0x80000000

	)

435 
	#CSIAR_WRITE_CMD
 0x80000000

	)

436 
	#CSIAR_BYTE_ENABLE
 0x0f

	)

437 
	#CSIAR_BYTE_ENABLE_SHIFT
 12

	)

438 
	#CSIAR_ADDR_MASK
 0x0fff

	)

439 
	#CSIAR_FUNC_CARD
 0x00000000

	)

440 
	#CSIAR_FUNC_SDIO
 0x00010000

	)

441 
	#CSIAR_FUNC_NIC
 0x00020000

	)

442 
	#CSIAR_FUNC_NIC2
 0x00010000

	)

443 
	mPMCH
 = 0x6f,

444 
	mEPHYAR
 = 0x80,

445 
	#EPHYAR_FLAG
 0x80000000

	)

446 
	#EPHYAR_WRITE_CMD
 0x80000000

	)

447 
	#EPHYAR_REG_MASK
 0x1f

	)

448 
	#EPHYAR_REG_SHIFT
 16

	)

449 
	#EPHYAR_DATA_MASK
 0xffff

	)

450 
	mDLLPR
 = 0xd0,

451 
	#PFM_EN
 (1 << 6)

	)

452 
	#TX_10M_PS_EN
 (1 << 7)

	)

453 
	mDBG_REG
 = 0xd1,

454 
	#FIX_NAK_1
 (1 << 4)

	)

455 
	#FIX_NAK_2
 (1 << 3)

	)

456 
	mTWSI
 = 0xd2,

457 
	mMCU
 = 0xd3,

458 
	#NOW_IS_OOB
 (1 << 7)

	)

459 
	#TX_EMPTY
 (1 << 5)

	)

460 
	#RX_EMPTY
 (1 << 4)

	)

461 
	#RXTX_EMPTY
 (
TX_EMPTY
 | 
RX_EMPTY
)

	)

462 
	#EN_NDP
 (1 << 3)

	)

463 
	#EN_OOB_RESET
 (1 << 2)

	)

464 
	#LINK_LIST_RDY
 (1 << 1)

	)

465 
	mEFUSEAR
 = 0xdc,

466 
	#EFUSEAR_FLAG
 0x80000000

	)

467 
	#EFUSEAR_WRITE_CMD
 0x80000000

	)

468 
	#EFUSEAR_READ_CMD
 0x00000000

	)

469 
	#EFUSEAR_REG_MASK
 0x03ff

	)

470 
	#EFUSEAR_REG_SHIFT
 8

	)

471 
	#EFUSEAR_DATA_MASK
 0xff

	)

472 
	mMISC_1
 = 0xf2,

473 
	#PFM_D3COLD_EN
 (1 << 6)

	)

476 
	e¹l8168_»gi¡”s
 {

477 
	mLED_FREQ
 = 0x1a,

478 
	mEEE_LED
 = 0x1b,

479 
	mERIDR
 = 0x70,

480 
	mERIAR
 = 0x74,

481 
	#ERIAR_FLAG
 0x80000000

	)

482 
	#ERIAR_WRITE_CMD
 0x80000000

	)

483 
	#ERIAR_READ_CMD
 0x00000000

	)

484 
	#ERIAR_ADDR_BYTE_ALIGN
 4

	)

485 
	#ERIAR_TYPE_SHIFT
 16

	)

486 
	#ERIAR_EXGMAC
 (0x00 << 
ERIAR_TYPE_SHIFT
)

	)

487 
	#ERIAR_MSIX
 (0x01 << 
ERIAR_TYPE_SHIFT
)

	)

488 
	#ERIAR_ASF
 (0x02 << 
ERIAR_TYPE_SHIFT
)

	)

489 
	#ERIAR_OOB
 (0x02 << 
ERIAR_TYPE_SHIFT
)

	)

490 
	#ERIAR_MASK_SHIFT
 12

	)

491 
	#ERIAR_MASK_0001
 (0x1 << 
ERIAR_MASK_SHIFT
)

	)

492 
	#ERIAR_MASK_0011
 (0x3 << 
ERIAR_MASK_SHIFT
)

	)

493 
	#ERIAR_MASK_0100
 (0x4 << 
ERIAR_MASK_SHIFT
)

	)

494 
	#ERIAR_MASK_0101
 (0x5 << 
ERIAR_MASK_SHIFT
)

	)

495 
	#ERIAR_MASK_1111
 (0xà<< 
ERIAR_MASK_SHIFT
)

	)

496 
	mEPHY_RXER_NUM
 = 0x7c,

497 
	mOCPDR
 = 0xb0,

498 
	#OCPDR_WRITE_CMD
 0x80000000

	)

499 
	#OCPDR_READ_CMD
 0x00000000

	)

500 
	#OCPDR_REG_MASK
 0x7f

	)

501 
	#OCPDR_GPHY_REG_SHIFT
 16

	)

502 
	#OCPDR_DATA_MASK
 0xffff

	)

503 
	mOCPAR
 = 0xb4,

504 
	#OCPAR_FLAG
 0x80000000

	)

505 
	#OCPAR_GPHY_WRITE_CMD
 0x8000f060

	)

506 
	#OCPAR_GPHY_READ_CMD
 0x0000f060

	)

507 
	mGPHY_OCP
 = 0xb8,

508 
	mRDSAR1
 = 0xd0,

509 
	mMISC
 = 0xf0,

510 
	#TXPLA_RST
 (1 << 29)

	)

511 
	#DISABLE_LAN_EN
 (1 << 23è

	)

512 
	#PWM_EN
 (1 << 22)

	)

513 
	#RXDV_GATED_EN
 (1 << 19)

	)

514 
	#EARLY_TALLY_EN
 (1 << 16)

	)

517 
	e¹l_»gi¡”_cÚ‹Á
 {

519 
	mSYSE¼
 = 0x8000,

520 
	mPCSTimeout
 = 0x4000,

521 
	mSWIÁ
 = 0x0100,

522 
	mTxDescUÇva
 = 0x0080,

523 
	mRxFIFOOv”
 = 0x0040,

524 
	mLškChg
 = 0x0020,

525 
	mRxOv”æow
 = 0x0010,

526 
	mTxE¼
 = 0x0008,

527 
	mTxOK
 = 0x0004,

528 
	mRxE¼
 = 0x0002,

529 
	mRxOK
 = 0x0001,

532 
	mRxBOVF
 = (1 << 24),

533 
	mRxFOVF
 = (1 << 23),

534 
	mRxRWT
 = (1 << 22),

535 
	mRxRES
 = (1 << 21),

536 
	mRxRUNT
 = (1 << 20),

537 
	mRxCRC
 = (1 << 19),

540 
	mStİReq
 = 0x80,

541 
	mCmdRe£t
 = 0x10,

542 
	mCmdRxEnb
 = 0x08,

543 
	mCmdTxEnb
 = 0x04,

544 
	mRxBufEm±y
 = 0x01,

547 
	mHPQ
 = 0x80,

548 
	mNPQ
 = 0x40,

549 
	mFSWIÁ
 = 0x01,

552 
	mCfg9346_Lock
 = 0x00,

553 
	mCfg9346_UÆock
 = 0xc0,

556 
	mAcû±E¼
 = 0x20,

557 
	mAcû±RuÁ
 = 0x10,

558 
	mAcû±Brßdÿ¡
 = 0x08,

559 
	mAcû±MuÉiÿ¡
 = 0x04,

560 
	mAcû±MyPhys
 = 0x02,

561 
	mAcû±AÎPhys
 = 0x01,

562 
	#RX_CONFIG_ACCEPT_MASK
 0x3f

	)

565 
	mTxIÁ”F¿meG­Shiá
 = 24,

566 
	mTxDMAShiá
 = 8,

569 
	mLEDS1
 = (1 << 7),

570 
	mLEDS0
 = (1 << 6),

571 
	mS³ed_down
 = (1 << 4),

572 
	mMEMMAP
 = (1 << 3),

573 
	mIOMAP
 = (1 << 2),

574 
	mVPD
 = (1 << 1),

575 
	mPMEÇbË
 = (1 << 0),

578 
	mClkReqEn
 = (1 << 7),

579 
	mMSIEÇbË
 = (1 << 5),

580 
	mPCI_Clock_66MHz
 = 0x01,

581 
	mPCI_Clock_33MHz
 = 0x00,

584 
	mMagicPack‘
 = (1 << 5),

585 
	mLškUp
 = (1 << 4),

586 
	mJumbo_En0
 = (1 << 2),

587 
	mRdy_to_L23
 = (1 << 1),

588 
	mB—cÚ_’
 = (1 << 0),

591 
	mJumbo_En1
 = (1 << 1),

594 
	mBWF
 = (1 << 6),

595 
	mMWF
 = (1 << 5),

596 
	mUWF
 = (1 << 4),

597 
	mSpi_’
 = (1 << 3),

598 
	mLªWake
 = (1 << 1),

599 
	mPMEStus
 = (1 << 0),

600 
	mASPM_’
 = (1 << 0),

603 
	mTBIRe£t
 = 0x80000000,

604 
	mTBILoİback
 = 0x40000000,

605 
	mTBINwEÇbË
 = 0x20000000,

606 
	mTBINwRe¡¬t
 = 0x10000000,

607 
	mTBILškOk
 = 0x02000000,

608 
	mTBINwCom¶‘e
 = 0x01000000,

611 
	mEÇbËBi¡
 = (1 << 15),

612 
	mMac_dbgo_Û
 = (1 << 14),

613 
	mNÜm®_mode
 = (1 << 13),

614 
	mFÜû_h®f_dup
 = (1 << 12),

615 
	mFÜû_rxæow_’
 = (1 << 11),

616 
	mFÜû_txæow_’
 = (1 << 10),

617 
	mCx¶_dbg_£l
 = (1 << 9),

618 
	mASF
 = (1 << 8),

619 
	mPktCÁrDi§bË
 = (1 << 7),

620 
	mMac_dbgo_£l
 = 0x001c,

621 
	mRxVÏn
 = (1 << 6),

622 
	mRxChkSum
 = (1 << 5),

623 
	mPCIDAC
 = (1 << 4),

624 
	mPCIMulRW
 = (1 << 3),

625 
	mINTT_0
 = 0x0000,

626 
	mINTT_1
 = 0x0001,

627 
	mINTT_2
 = 0x0002,

628 
	mINTT_3
 = 0x0003,

631 
	mTBI_EÇbË
 = 0x80,

632 
	mTxFlowCŒl
 = 0x40,

633 
	mRxFlowCŒl
 = 0x20,

634 
	m_1000bpsF
 = 0x10,

635 
	m_100bps
 = 0x08,

636 
	m_10bps
 = 0x04,

637 
	mLškStus
 = 0x02,

638 
	mFuÎDup
 = 0x01,

641 
	mTBILškOK
 = 0x02000000,

644 
	mCouÁ”Re£t
 = 0x1,

647 
	mCouÁ”Dump
 = 0x8,

650 
	mMagicPack‘_v2
 = (1 << 16),

653 
	e¹l_desc_b™
 {

655 
	mDescOwn
 = (1 << 31),

656 
	mRšgEnd
 = (1 << 30),

657 
	mFœ¡F¿g
 = (1 << 29),

658 
	mLa¡F¿g
 = (1 << 28),

662 
	e¹l_tx_desc_b™
 {

664 
	mTD_LSO
 = (1 << 27),

665 
	#TD_MSS_MAX
 0x07ffu

	)

668 
	mTxVÏnTag
 = (1 << 17),

672 
	e¹l_tx_desc_b™_0
 {

674 
	#TD0_MSS_SHIFT
 16

	)

675 
	mTD0_TCP_CS
 = (1 << 16),

676 
	mTD0_UDP_CS
 = (1 << 17),

677 
	mTD0_IP_CS
 = (1 << 18),

681 
	e¹l_tx_desc_b™_1
 {

683 
	mTD1_GTSENV4
 = (1 << 26),

684 
	mTD1_GTSENV6
 = (1 << 25),

685 
	#GTTCPHO_SHIFT
 18

	)

686 
	#GTTCPHO_MAX
 0x7fU

	)

689 
	#TCPHO_SHIFT
 18

	)

690 
	#TCPHO_MAX
 0x3ffU

	)

691 
	#TD1_MSS_SHIFT
 18

	)

692 
	mTD1_IPv6_CS
 = (1 << 28),

693 
	mTD1_IPv4_CS
 = (1 << 29),

694 
	mTD1_TCP_CS
 = (1 << 30),

695 
	mTD1_UDP_CS
 = (1 << 31),

698 
	e¹l_rx_desc_b™
 {

700 
	mPID1
 = (1 << 18),

701 
	mPID0
 = (1 << 17),

703 
	#RxPrÙoUDP
 (
PID1
)

	)

704 
	#RxPrÙoTCP
 (
PID0
)

	)

705 
	#RxPrÙoIP
 (
PID1
 | 
PID0
)

	)

706 
	#RxPrÙoMask
 
RxPrÙoIP


	)

708 
	mIPFa
 = (1 << 16),

709 
	mUDPFa
 = (1 << 15),

710 
	mTCPFa
 = (1 << 14),

711 
	mRxVÏnTag
 = (1 << 16),

714 
	#RsvdMask
 0x3fffc000

	)

716 
	sTxDesc
 {

717 
__Ë32
 
	mİts1
;

718 
__Ë32
 
	mİts2
;

719 
__Ë64
 
	maddr
;

722 
	sRxDesc
 {

723 
__Ë32
 
	mİts1
;

724 
__Ë32
 
	mİts2
;

725 
__Ë64
 
	maddr
;

728 
	sršg_šfo
 {

729 
sk_buff
 *
	mskb
;

730 
u32
 
	mËn
;

731 
u8
 
	m__·d
[(*è- (
u32
)];

734 
	eã©u»s
 {

735 
	mRTL_FEATURE_WOL
 = (1 << 0),

736 
	mRTL_FEATURE_MSI
 = (1 << 1),

737 
	mRTL_FEATURE_GMII
 = (1 << 2),

740 
	s¹l8169_couÁ”s
 {

741 
__Ë64
 
	mtx_·ck‘s
;

742 
__Ë64
 
	mrx_·ck‘s
;

743 
__Ë64
 
	mtx_”rÜs
;

744 
__Ë32
 
	mrx_”rÜs
;

745 
__Ë16
 
	mrx_mis£d
;

746 
__Ë16
 
	m®ign_”rÜs
;

747 
__Ë32
 
	mtx_Úe_cŞlisiÚ
;

748 
__Ë32
 
	mtx_muÉi_cŞlisiÚ
;

749 
__Ë64
 
	mrx_uniÿ¡
;

750 
__Ë64
 
	mrx_brßdÿ¡
;

751 
__Ë32
 
	mrx_muÉiÿ¡
;

752 
__Ë16
 
	mtx_abÜ‹d
;

753 
__Ë16
 
	mtx_und”un
;

756 
	s¹l8169_tc_off£ts
 {

757 
boŞ
 
	mš™ed
;

758 
__Ë64
 
	mtx_”rÜs
;

759 
__Ë32
 
	mtx_muÉi_cŞlisiÚ
;

760 
__Ë16
 
	mtx_abÜ‹d
;

763 
	e¹l_æag
 {

764 
	mRTL_FLAG_TASK_ENABLED
,

765 
	mRTL_FLAG_TASK_SLOW_PENDING
,

766 
	mRTL_FLAG_TASK_RESET_PENDING
,

767 
	mRTL_FLAG_TASK_PHY_PENDING
,

768 
	mRTL_FLAG_MAX


771 
	s¹l8169_¡©s
 {

772 
u64
 
	m·ck‘s
;

773 
u64
 
	mby‹s
;

774 
u64_¡©s_sync
 
	msynı
;

777 
	s¹l8169_´iv©e
 {

778 
__iomem
 *
	mmmio_addr
;

779 
pci_dev
 *
	mpci_dev
;

780 
Ãt_deviû
 *
	mdev
;

781 
Çpi_¡ruù
 
	mÇpi
;

782 
u32
 
	mmsg_’abË
;

783 
u16
 
	mtxd_v”siÚ
;

784 
u16
 
	mmac_v”siÚ
;

785 
u32
 
	mcur_rx
;

786 
u32
 
	mcur_tx
;

787 
u32
 
	mdœty_tx
;

788 
¹l8169_¡©s
 
	mrx_¡©s
;

789 
¹l8169_¡©s
 
	mtx_¡©s
;

790 
TxDesc
 *
	mTxDescA¼ay
;

791 
RxDesc
 *
	mRxDescA¼ay
;

792 
dma_addr_t
 
	mTxPhyAddr
;

793 
dma_addr_t
 
	mRxPhyAddr
;

794 *
	mRx_d©abuff
[
NUM_RX_DESC
];

795 
ršg_šfo
 
	mtx_skb
[
NUM_TX_DESC
];

796 
tim”_li¡
 
	mtim”
;

797 
u16
 
	mı_cmd
;

799 
u16
 
	mev’t_¦ow
;

801 
	smdio_İs
 {

802 (*
	mwr™e
)(
	m¹l8169_´iv©e
 *, , );

803 (*
	m»ad
)(
	m¹l8169_´iv©e
 *, );

804 } 
	mmdio_İs
;

806 
	s¶l_pow”_İs
 {

807 (*
	mdown
)(
	m¹l8169_´iv©e
 *);

808 (*
	mup
)(
	m¹l8169_´iv©e
 *);

809 } 
	m¶l_pow”_İs
;

811 
	sjumbo_İs
 {

812 (*
	m’abË
)(
	m¹l8169_´iv©e
 *);

813 (*
	mdi§bË
)(
	m¹l8169_´iv©e
 *);

814 } 
	mjumbo_İs
;

816 
	scsi_İs
 {

817 (*
	mwr™e
)(
	m¹l8169_´iv©e
 *, , );

818 
u32
 (*
»ad
)(
	m¹l8169_´iv©e
 *, );

819 } 
	mcsi_İs
;

821 (*
	m£t_¥“d
)(
	mÃt_deviû
 *, 
u8
 
	mªeg
, 
u16
 
	m¥
, u8 
	mdpx
, 
u32
 
	madv
);

822 (*
	mg‘_£‰šgs
)(
	mÃt_deviû
 *, 
	m‘htoŞ_cmd
 *);

823 (*
	mphy_»£t_’abË
)(
¹l8169_´iv©e
 *
	m
);

824 (*
	mhw_¡¬t
)(
	mÃt_deviû
 *);

825 (*
	mphy_»£t_³ndšg
)(
¹l8169_´iv©e
 *
	m
);

826 (*
	mlšk_ok
)(
	m__iomem
 *);

827 (*
	mdo_ioùl
)(
¹l8169_´iv©e
 *
	m
, 
mii_ioùl_d©a
 *
	md©a
, 
	mcmd
);

828 
boŞ
 (*
tso_csum
)(
	m¹l8169_´iv©e
 *, 
	msk_buff
 *, 
	mu32
 *);

831 
DECLARE_BITMAP
(
æags
, 
RTL_FLAG_MAX
);

832 
mu‹x
 
	mmu‹x
;

833 
wÜk_¡ruù
 
	mwÜk
;

834 } 
	mwk
;

836 
	mã©u»s
;

838 
mii_if_šfo
 
	mmii
;

839 
dma_addr_t
 
	mcouÁ”s_phys_addr
;

840 
¹l8169_couÁ”s
 *
	mcouÁ”s
;

841 
¹l8169_tc_off£ts
 
	mtc_off£t
;

842 
u32
 
	m§ved_wŞİts
;

843 
u32
 
	mİts1_mask
;

845 
	s¹l_fw
 {

846 cÚ¡ 
fœmw¬e
 *
	mfw
;

848 
	#RTL_VER_SIZE
 32

	)

850 
	mv”siÚ
[
RTL_VER_SIZE
];

852 
	s¹l_fw_phy_aùiÚ
 {

853 
__Ë32
 *
	mcode
;

854 
size_t
 
	msize
;

855 } 
	mphy_aùiÚ
;

856 } *
	m¹l_fw
;

857 
	#RTL_FIRMWARE_UNKNOWN
 
	`ERR_PTR
(-
EAGAIN
)

	)

859 
u32
 
	moı_ba£
;

861 
bpf_´og
 
__rcu
 *
	mxdp_´og
;

862 
	s¹l_xdp_couÁ”s
 {

863 
u64
 
	m£t
;

864 
u64
 
	m·ss
;

865 
u64
 
	mdrİ
;

866 
u64
 
	mtx
;

867 
u64
 
	mabÜ‹d
;

868 
u64
 
	munknown
;

869 } 
	mxdp_couÁ”s
;

872 
MODULE_AUTHOR
("Realtek‡ndhe Linux„8169 crew <netdev@vger.kernel.org>");

873 
MODULE_DESCRIPTION
("RealTek RTL-8169 Gigabit Ethernet driver");

874 
moduË_·¿m
(
u£_dac
, , 0);

875 
MODULE_PARM_DESC
(
u£_dac
, "Enable PCI DAC. Unsafe on 32 bit PCI slot.");

876 
moduË_·¿m_Çmed
(
debug
, debug.
msg_’abË
, , 0);

877 
MODULE_PARM_DESC
(
debug
, "Debug verbosity†evel (0=none, ..., 16=all)");

878 
MODULE_LICENSE
("GPL");

879 
MODULE_VERSION
(
RTL8169_VERSION
);

880 
MODULE_FIRMWARE
(
FIRMWARE_8168D_1
);

881 
MODULE_FIRMWARE
(
FIRMWARE_8168D_2
);

882 
MODULE_FIRMWARE
(
FIRMWARE_8168E_1
);

883 
MODULE_FIRMWARE
(
FIRMWARE_8168E_2
);

884 
MODULE_FIRMWARE
(
FIRMWARE_8168E_3
);

885 
MODULE_FIRMWARE
(
FIRMWARE_8105E_1
);

886 
MODULE_FIRMWARE
(
FIRMWARE_8168F_1
);

887 
MODULE_FIRMWARE
(
FIRMWARE_8168F_2
);

888 
MODULE_FIRMWARE
(
FIRMWARE_8402_1
);

889 
MODULE_FIRMWARE
(
FIRMWARE_8411_1
);

890 
MODULE_FIRMWARE
(
FIRMWARE_8411_2
);

891 
MODULE_FIRMWARE
(
FIRMWARE_8106E_1
);

892 
MODULE_FIRMWARE
(
FIRMWARE_8106E_2
);

893 
MODULE_FIRMWARE
(
FIRMWARE_8168G_2
);

894 
MODULE_FIRMWARE
(
FIRMWARE_8168G_3
);

895 
MODULE_FIRMWARE
(
FIRMWARE_8168H_1
);

896 
MODULE_FIRMWARE
(
FIRMWARE_8168H_2
);

897 
MODULE_FIRMWARE
(
FIRMWARE_8107E_1
);

898 
MODULE_FIRMWARE
(
FIRMWARE_8107E_2
);

900 
	$¹l_lock_wÜk
(
¹l8169_´iv©e
 *

)

902 
	`mu‹x_lock
(&

->
wk
.
mu‹x
);

903 
	}
}

905 
	$¹l_uÆock_wÜk
(
¹l8169_´iv©e
 *

)

907 
	`mu‹x_uÆock
(&

->
wk
.
mu‹x
);

908 
	}
}

911 
	#¹l_wÜk_lock_h–d
(

è
	`lockd•_is_h–d
(&->
wk
.
mu‹x
)

	)

913 
	$¹l_tx_³rfÜmªû_tw—k
(
pci_dev
 *
pdev
, 
u16
 
fÜû
)

915 
	`pc›_ÿ·b™y_ş—r_ªd_£t_wÜd
(
pdev
, 
PCI_EXP_DEVCTL
,

916 
PCI_EXP_DEVCTL_READRQ
, 
fÜû
);

917 
	}
}

919 
	s¹l_cÚd
 {

920 
boŞ
 (*
check
)(
	m¹l8169_´iv©e
 *);

921 cÚ¡ *
	mmsg
;

924 
	$¹l_ud–ay
(
d
)

926 
	`ud–ay
(
d
);

927 
	}
}

929 
boŞ
 
	$¹l_loİ_wa™
(
¹l8169_´iv©e
 *

, cÚ¡ 
¹l_cÚd
 *
c
,

930 (*
d–ay
)(), 
d
, 
n
,

931 
boŞ
 
high
)

933 
i
;

935 
i
 = 0; i < 
n
; i++) {

936 
	`d–ay
(
d
);

937 ià(
c
->
	`check
(

è=ğ
high
)

938  
Œue
;

940 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "%s == %d (loop: %d, delay: %d).\n",

941 
c
->
msg
, !
high
, 
n
, 
d
);

942  
çl£
;

943 
	}
}

945 
boŞ
 
	$¹l_ud–ay_loİ_wa™_high
(
¹l8169_´iv©e
 *

,

946 cÚ¡ 
¹l_cÚd
 *
c
,

947 
d
, 
n
)

949  
	`¹l_loİ_wa™
(

, 
c
, 
¹l_ud–ay
, 
d
, 
n
, 
Œue
);

950 
	}
}

952 
boŞ
 
	$¹l_ud–ay_loİ_wa™_low
(
¹l8169_´iv©e
 *

,

953 cÚ¡ 
¹l_cÚd
 *
c
,

954 
d
, 
n
)

956  
	`¹l_loİ_wa™
(

, 
c
, 
¹l_ud–ay
, 
d
, 
n
, 
çl£
);

957 
	}
}

959 
boŞ
 
	$¹l_m¦“p_loİ_wa™_high
(
¹l8169_´iv©e
 *

,

960 cÚ¡ 
¹l_cÚd
 *
c
,

961 
d
, 
n
)

963  
	`¹l_loİ_wa™
(

, 
c
, 
m¦“p
, 
d
, 
n
, 
Œue
);

964 
	}
}

966 
boŞ
 
	$¹l_m¦“p_loİ_wa™_low
(
¹l8169_´iv©e
 *

,

967 cÚ¡ 
¹l_cÚd
 *
c
,

968 
d
, 
n
)

970  
	`¹l_loİ_wa™
(

, 
c
, 
m¦“p
, 
d
, 
n
, 
çl£
);

971 
	}
}

973 
	#DECLARE_RTL_COND
(
Çme
) \

974 
boŞ
 
Çme
 ## 
	`_check
(
¹l8169_´iv©e
 *); \

976 cÚ¡ 
¹l_cÚd
 
Çme
 = { \

977 .
check
 = 
Çme
 ## 
_check
, \

978 .
msg
 = #name \

981 
boŞ
 
Çme
 ## 
	`_check
(
¹l8169_´iv©e
 *

)

	)

983 
boŞ
 
	$¹l_oı_»g_çu»
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

985 ià(
»g
 & 0xffff0001) {

986 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "Inv®id oı„eg %x!\n", 
»g
);

987  
Œue
;

989  
çl£
;

990 
	}
}

992 
	$DECLARE_RTL_COND
(
¹l_oı_gphy_cÚd
)

994 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

996  
	`RTL_R32
(
GPHY_OCP
è& 
OCPAR_FLAG
;

997 
	}
}

999 
	$r8168_phy_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u32
 
»g
, u32 
d©a
)

1001 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1003 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1006 
	`RTL_W32
(
GPHY_OCP
, 
OCPAR_FLAG
 | (
»g
 << 15è| 
d©a
);

1008 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı_gphy_cÚd
, 25, 10);

1009 
	}
}

1011 
u16
 
	$r8168_phy_oı_»ad
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

1013 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1015 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1018 
	`RTL_W32
(
GPHY_OCP
, 
»g
 << 15);

1020  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı_gphy_cÚd
, 25, 10) ?

1021 (
	`RTL_R32
(
GPHY_OCP
) & 0xffff) : ~0;

1022 
	}
}

1024 
	$r8168_mac_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u32
 
»g
, u32 
d©a
)

1026 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1028 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1031 
	`RTL_W32
(
OCPDR
, 
OCPAR_FLAG
 | (
»g
 << 15è| 
d©a
);

1032 
	}
}

1034 
u16
 
	$r8168_mac_oı_»ad
(
¹l8169_´iv©e
 *

, 
u32
 
»g
)

1036 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1038 ià(
	`¹l_oı_»g_çu»
(

, 
»g
))

1041 
	`RTL_W32
(
OCPDR
, 
»g
 << 15);

1043  
	`RTL_R32
(
OCPDR
);

1044 
	}
}

1046 
	#OCP_STD_PHY_BASE
 0xa400

	)

1048 
	$r8168g_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1050 ià(
»g
 == 0x1f) {

1051 

->
oı_ba£
 = 
v®ue
 ? v®u<< 4 : 
OCP_STD_PHY_BASE
;

1055 ià(

->
oı_ba£
 !ğ
OCP_STD_PHY_BASE
)

1056 
»g
 -= 0x10;

1058 
	`r8168_phy_oı_wr™e
(

,p->
oı_ba£
 + 
»g
 * 2, 
v®ue
);

1059 
	}
}

1061 
	$r8168g_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1063 ià(

->
oı_ba£
 !ğ
OCP_STD_PHY_BASE
)

1064 
»g
 -= 0x10;

1066  
	`r8168_phy_oı_»ad
(

,p->
oı_ba£
 + 
»g
 * 2);

1067 
	}
}

1069 
	$mac_mcu_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1071 ià(
»g
 == 0x1f) {

1072 

->
oı_ba£
 = 
v®ue
 << 4;

1076 
	`r8168_mac_oı_wr™e
(

,p->
oı_ba£
 + 
»g
, 
v®ue
);

1077 
	}
}

1079 
	$mac_mcu_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1081  
	`r8168_mac_oı_»ad
(

,p->
oı_ba£
 + 
»g
);

1082 
	}
}

1084 
	$DECLARE_RTL_COND
(
¹l_phy¬_cÚd
)

1086 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1088  
	`RTL_R32
(
PHYAR
) & 0x80000000;

1089 
	}
}

1091 
	$r8169_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1093 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1095 
	`RTL_W32
(
PHYAR
, 0x80000000 | (
»g
 & 0x1fè<< 16 | (
v®ue
 & 0xffff));

1097 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_phy¬_cÚd
, 25, 20);

1102 
	`ud–ay
(20);

1103 
	}
}

1105 
	$r8169_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1107 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1108 
v®ue
;

1110 
	`RTL_W32
(
PHYAR
, 0x0 | (
»g
 & 0x1f) << 16);

1112 
v®ue
 = 
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_phy¬_cÚd
, 25, 20) ?

1113 
	`RTL_R32
(
PHYAR
) & 0xffff : ~0;

1119 
	`ud–ay
(20);

1121  
v®ue
;

1122 
	}
}

1124 
	$DECLARE_RTL_COND
(
¹l_oı¬_cÚd
)

1126 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1128  
	`RTL_R32
(
OCPAR
è& 
OCPAR_FLAG
;

1129 
	}
}

1131 
	$r8168dp_1_mdio_acûss
(
¹l8169_´iv©e
 *

, 
»g
, 
u32
 
d©a
)

1133 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1135 
	`RTL_W32
(
OCPDR
, 
d©a
 | ((
»g
 & 
OCPDR_REG_MASK
è<< 
OCPDR_GPHY_REG_SHIFT
));

1136 
	`RTL_W32
(
OCPAR
, 
OCPAR_GPHY_WRITE_CMD
);

1137 
	`RTL_W32
(
EPHY_RXER_NUM
, 0);

1139 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı¬_cÚd
, 1000, 100);

1140 
	}
}

1142 
	$r8168dp_1_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1144 
	`r8168dp_1_mdio_acûss
(

, 
»g
,

1145 
OCPDR_WRITE_CMD
 | (
v®ue
 & 
OCPDR_DATA_MASK
));

1146 
	}
}

1148 
	$r8168dp_1_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1150 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1152 
	`r8168dp_1_mdio_acûss
(

, 
»g
, 
OCPDR_READ_CMD
);

1154 
	`md–ay
(1);

1155 
	`RTL_W32
(
OCPAR
, 
OCPAR_GPHY_READ_CMD
);

1156 
	`RTL_W32
(
EPHY_RXER_NUM
, 0);

1158  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı¬_cÚd
, 1000, 100) ?

1159 
	`RTL_R32
(
OCPDR
è& 
OCPDR_DATA_MASK
 : ~0;

1160 
	}
}

1162 
	#R8168DP_1_MDIO_ACCESS_BIT
 0x00020000

	)

1164 
	$r8168dp_2_mdio_¡¬t
(
__iomem
 *
ißddr
)

1166 
	`RTL_W32
(0xd0, 
	`RTL_R32
(0xd0è& ~
R8168DP_1_MDIO_ACCESS_BIT
);

1167 
	}
}

1169 
	$r8168dp_2_mdio_¡İ
(
__iomem
 *
ißddr
)

1171 
	`RTL_W32
(0xd0, 
	`RTL_R32
(0xd0è| 
R8168DP_1_MDIO_ACCESS_BIT
);

1172 
	}
}

1174 
	$r8168dp_2_mdio_wr™e
(
¹l8169_´iv©e
 *

, 
»g
, 
v®ue
)

1176 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1178 
	`r8168dp_2_mdio_¡¬t
(
ißddr
);

1180 
	`r8169_mdio_wr™e
(

, 
»g
, 
v®ue
);

1182 
	`r8168dp_2_mdio_¡İ
(
ißddr
);

1183 
	}
}

1185 
	$r8168dp_2_mdio_»ad
(
¹l8169_´iv©e
 *

, 
»g
)

1187 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1188 
v®ue
;

1190 
	`r8168dp_2_mdio_¡¬t
(
ißddr
);

1192 
v®ue
 = 
	`r8169_mdio_»ad
(

, 
»g
);

1194 
	`r8168dp_2_mdio_¡İ
(
ißddr
);

1196  
v®ue
;

1197 
	}
}

1199 
	$¹l_wr™•hy
(
¹l8169_´iv©e
 *

, 
loÿtiÚ
, 
u32
 
v®
)

1201 

->
mdio_İs
.
	`wr™e
Ñp, 
loÿtiÚ
, 
v®
);

1202 
	}
}

1204 
	$¹l_»adphy
(
¹l8169_´iv©e
 *

, 
loÿtiÚ
)

1206  

->
mdio_İs
.
	`»ad
Ñp, 
loÿtiÚ
);

1207 
	}
}

1209 
	$¹l_·tchphy
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
v®ue
)

1211 
	`¹l_wr™•hy
(

, 
»g_addr
, 
	`¹l_»adphy
Ñp,„eg_addrè| 
v®ue
);

1212 
	}
}

1214 
	$¹l_w0w1_phy
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
p
, 
m
)

1216 
v®
;

1218 
v®
 = 
	`¹l_»adphy
(

, 
»g_addr
);

1219 
	`¹l_wr™•hy
(

, 
»g_addr
, (
v®
 & ~
m
è| 
p
);

1220 
	}
}

1222 
	$¹l_mdio_wr™e
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
,

1223 
v®
)

1225 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1227 
	`¹l_wr™•hy
(

, 
loÿtiÚ
, 
v®
);

1228 
	}
}

1230 
	$¹l_mdio_»ad
(
Ãt_deviû
 *
dev
, 
phy_id
, 
loÿtiÚ
)

1232 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1234  
	`¹l_»adphy
(

, 
loÿtiÚ
);

1235 
	}
}

1237 
	$DECLARE_RTL_COND
(
¹l_•hy¬_cÚd
)

1239 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1241  
	`RTL_R32
(
EPHYAR
è& 
EPHYAR_FLAG
;

1242 
	}
}

1244 
	$¹l_•hy_wr™e
(
¹l8169_´iv©e
 *

, 
»g_addr
, 
v®ue
)

1246 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1248 
	`RTL_W32
(
EPHYAR
, 
EPHYAR_WRITE_CMD
 | (
v®ue
 & 
EPHYAR_DATA_MASK
) |

1249 (
»g_addr
 & 
EPHYAR_REG_MASK
è<< 
EPHYAR_REG_SHIFT
);

1251 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_•hy¬_cÚd
, 10, 100);

1253 
	`ud–ay
(10);

1254 
	}
}

1256 
u16
 
	$¹l_•hy_»ad
(
¹l8169_´iv©e
 *

, 
»g_addr
)

1258 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1260 
	`RTL_W32
(
EPHYAR
, (
»g_addr
 & 
EPHYAR_REG_MASK
è<< 
EPHYAR_REG_SHIFT
);

1262  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_•hy¬_cÚd
, 10, 100) ?

1263 
	`RTL_R32
(
EPHYAR
è& 
EPHYAR_DATA_MASK
 : ~0;

1264 
	}
}

1266 
	$DECLARE_RTL_COND
(
¹l_”Ÿr_cÚd
)

1268 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1270  
	`RTL_R32
(
ERIAR
è& 
ERIAR_FLAG
;

1271 
	}
}

1273 
	$¹l_”i_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
u32
 
mask
,

1274 
u32
 
v®
, 
ty³
)

1276 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1278 
	`BUG_ON
((
addr
 & 3è|| (
mask
 == 0));

1279 
	`RTL_W32
(
ERIDR
, 
v®
);

1280 
	`RTL_W32
(
ERIAR
, 
ERIAR_WRITE_CMD
 | 
ty³
 | 
mask
 | 
addr
);

1282 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_”Ÿr_cÚd
, 100, 100);

1283 
	}
}

1285 
u32
 
	$¹l_”i_»ad
(
¹l8169_´iv©e
 *

, 
addr
, 
ty³
)

1287 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1289 
	`RTL_W32
(
ERIAR
, 
ERIAR_READ_CMD
 | 
ty³
 | 
ERIAR_MASK_1111
 | 
addr
);

1291  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_”Ÿr_cÚd
, 100, 100) ?

1292 
	`RTL_R32
(
ERIDR
) : ~0;

1293 
	}
}

1295 
	$¹l_w0w1_”i
(
¹l8169_´iv©e
 *

, 
addr
, 
u32
 
mask
, u32 
p
,

1296 
u32
 
m
, 
ty³
)

1298 
u32
 
v®
;

1300 
v®
 = 
	`¹l_”i_»ad
(

, 
addr
, 
ty³
);

1301 
	`¹l_”i_wr™e
(

, 
addr
, 
mask
, (
v®
 & ~
m
è| 
p
, 
ty³
);

1302 
	}
}

1304 
u32
 
	$r8168dp_oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1306 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1308 
	`RTL_W32
(
OCPAR
, ((
u32
)
mask
 & 0x0fè<< 12 | (
»g
 & 0x0fff));

1309  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_oı¬_cÚd
, 100, 20) ?

1310 
	`RTL_R32
(
OCPDR
) : ~0;

1311 
	}
}

1313 
u32
 
	$r8168•_oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1315  
	`¹l_”i_»ad
(

, 
»g
, 
ERIAR_OOB
);

1316 
	}
}

1318 
u32
 
	$oı_»ad
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
)

1320 

->
mac_v”siÚ
) {

1321 
RTL_GIGA_MAC_VER_27
:

1322 
RTL_GIGA_MAC_VER_28
:

1323 
RTL_GIGA_MAC_VER_31
:

1324  
	`r8168dp_oı_»ad
(

, 
mask
, 
»g
);

1325 
RTL_GIGA_MAC_VER_49
:

1326 
RTL_GIGA_MAC_VER_50
:

1327 
RTL_GIGA_MAC_VER_51
:

1328  
	`r8168•_oı_»ad
(

, 
mask
, 
»g
);

1330 
	`BUG
();

1333 
	}
}

1335 
	$r8168dp_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
,

1336 
u32
 
d©a
)

1338 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1340 
	`RTL_W32
(
OCPDR
, 
d©a
);

1341 
	`RTL_W32
(
OCPAR
, 
OCPAR_FLAG
 | ((
u32
)
mask
 & 0x0fè<< 12 | (
»g
 & 0x0fff));

1342 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_oı¬_cÚd
, 100, 20);

1343 
	}
}

1345 
	$r8168•_oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
,

1346 
u32
 
d©a
)

1348 
	`¹l_”i_wr™e
(

, 
»g
, ((
u32
)
mask
 & 0x0fè<< 
ERIAR_MASK_SHIFT
,

1349 
d©a
, 
ERIAR_OOB
);

1350 
	}
}

1352 
	$oı_wr™e
(
¹l8169_´iv©e
 *

, 
u8
 
mask
, 
u16
 
»g
, 
u32
 
d©a
)

1354 

->
mac_v”siÚ
) {

1355 
RTL_GIGA_MAC_VER_27
:

1356 
RTL_GIGA_MAC_VER_28
:

1357 
RTL_GIGA_MAC_VER_31
:

1358 
	`r8168dp_oı_wr™e
(

, 
mask
, 
»g
, 
d©a
);

1360 
RTL_GIGA_MAC_VER_49
:

1361 
RTL_GIGA_MAC_VER_50
:

1362 
RTL_GIGA_MAC_VER_51
:

1363 
	`r8168•_oı_wr™e
(

, 
mask
, 
»g
, 
d©a
);

1366 
	`BUG
();

1369 
	}
}

1371 
	$¹l8168_oob_nÙify
(
¹l8169_´iv©e
 *

, 
u8
 
cmd
)

1373 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_0001
, 
cmd
, 
ERIAR_EXGMAC
);

1375 
	`oı_wr™e
(

, 0x1, 0x30, 0x00000001);

1376 
	}
}

1378 
	#OOB_CMD_RESET
 0x00

	)

1379 
	#OOB_CMD_DRIVER_START
 0x05

	)

1380 
	#OOB_CMD_DRIVER_STOP
 0x06

	)

1382 
u16
 
	$¹l8168_g‘_oı_»g
(
¹l8169_´iv©e
 *

)

1384  (

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
) ? 0xb8 : 0x10;

1385 
	}
}

1387 
	$DECLARE_RTL_COND
(
¹l_oı_»ad_cÚd
)

1389 
u16
 
»g
;

1391 
»g
 = 
	`¹l8168_g‘_oı_»g
(

);

1393  
	`oı_»ad
(

, 0x0f, 
»g
) & 0x00000800;

1394 
	}
}

1396 
	$DECLARE_RTL_COND
(
¹l_•_oı_»ad_cÚd
)

1398  
	`oı_»ad
(

, 0x0f, 0x124) & 0x00000001;

1399 
	}
}

1401 
	$DECLARE_RTL_COND
(
¹l_oı_tx_cÚd
)

1403 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1405  
	`RTL_R8
(
IBISR0
) & 0x02;

1406 
	}
}

1408 
	$¹l8168•_¡İ_cmac
(
¹l8169_´iv©e
 *

)

1410 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1412 
	`RTL_W8
(
IBCR2
, 
	`RTL_R8
(IBCR2) & ~0x01);

1413 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_oı_tx_cÚd
, 50, 2000);

1414 
	`RTL_W8
(
IBISR0
, 
	`RTL_R8
(IBISR0) | 0x20);

1415 
	`RTL_W8
(
IBCR0
, 
	`RTL_R8
(IBCR0) & ~0x01);

1416 
	}
}

1418 
	$¹l8168dp_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1420 
	`¹l8168_oob_nÙify
(

, 
OOB_CMD_DRIVER_START
);

1421 
	`¹l_m¦“p_loİ_wa™_high
(

, &
¹l_oı_»ad_cÚd
, 10, 10);

1422 
	}
}

1424 
	$¹l8168•_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1426 
	`oı_wr™e
(

, 0x01, 0x180, 
OOB_CMD_DRIVER_START
);

1427 
	`oı_wr™e
(

, 0x01, 0x30, 
	`oı_»ad
(tp, 0x01, 0x30) | 0x01);

1428 
	`¹l_m¦“p_loİ_wa™_high
(

, &
¹l_•_oı_»ad_cÚd
, 10, 10);

1429 
	}
}

1431 
	$¹l8168_driv”_¡¬t
(
¹l8169_´iv©e
 *

)

1433 

->
mac_v”siÚ
) {

1434 
RTL_GIGA_MAC_VER_27
:

1435 
RTL_GIGA_MAC_VER_28
:

1436 
RTL_GIGA_MAC_VER_31
:

1437 
	`¹l8168dp_driv”_¡¬t
(

);

1439 
RTL_GIGA_MAC_VER_49
:

1440 
RTL_GIGA_MAC_VER_50
:

1441 
RTL_GIGA_MAC_VER_51
:

1442 
	`¹l8168•_driv”_¡¬t
(

);

1445 
	`BUG
();

1448 
	}
}

1450 
	$¹l8168dp_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1452 
	`¹l8168_oob_nÙify
(

, 
OOB_CMD_DRIVER_STOP
);

1453 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_oı_»ad_cÚd
, 10, 10);

1454 
	}
}

1456 
	$¹l8168•_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1458 
	`¹l8168•_¡İ_cmac
(

);

1459 
	`oı_wr™e
(

, 0x01, 0x180, 
OOB_CMD_DRIVER_STOP
);

1460 
	`oı_wr™e
(

, 0x01, 0x30, 
	`oı_»ad
(tp, 0x01, 0x30) | 0x01);

1461 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_•_oı_»ad_cÚd
, 10, 10);

1462 
	}
}

1464 
	$¹l8168_driv”_¡İ
(
¹l8169_´iv©e
 *

)

1466 

->
mac_v”siÚ
) {

1467 
RTL_GIGA_MAC_VER_27
:

1468 
RTL_GIGA_MAC_VER_28
:

1469 
RTL_GIGA_MAC_VER_31
:

1470 
	`¹l8168dp_driv”_¡İ
(

);

1472 
RTL_GIGA_MAC_VER_49
:

1473 
RTL_GIGA_MAC_VER_50
:

1474 
RTL_GIGA_MAC_VER_51
:

1475 
	`¹l8168•_driv”_¡İ
(

);

1478 
	`BUG
();

1481 
	}
}

1483 
	$r8168dp_check_dash
(
¹l8169_´iv©e
 *

)

1485 
u16
 
»g
 = 
	`¹l8168_g‘_oı_»g
(

);

1487  (
	`oı_»ad
(

, 0x0f, 
»g
) & 0x00008000) ? 1 : 0;

1488 
	}
}

1490 
	$r8168•_check_dash
(
¹l8169_´iv©e
 *

)

1492  (
	`oı_»ad
(

, 0x0f, 0x128) & 0x00000001) ? 1 : 0;

1493 
	}
}

1495 
	$r8168_check_dash
(
¹l8169_´iv©e
 *

)

1497 

->
mac_v”siÚ
) {

1498 
RTL_GIGA_MAC_VER_27
:

1499 
RTL_GIGA_MAC_VER_28
:

1500 
RTL_GIGA_MAC_VER_31
:

1501  
	`r8168dp_check_dash
(

);

1502 
RTL_GIGA_MAC_VER_49
:

1503 
RTL_GIGA_MAC_VER_50
:

1504 
RTL_GIGA_MAC_VER_51
:

1505  
	`r8168•_check_dash
(

);

1509 
	}
}

1511 
	sexgmac_»g
 {

1512 
u16
 
	maddr
;

1513 
u16
 
	mmask
;

1514 
u32
 
	mv®
;

1517 
	$¹l_wr™e_exgmac_b©ch
(
¹l8169_´iv©e
 *

,

1518 cÚ¡ 
exgmac_»g
 *
r
, 
Ën
)

1520 
Ën
-- > 0) {

1521 
	`¹l_”i_wr™e
(

, 
r
->
addr
,„->
mask
,„->
v®
, 
ERIAR_EXGMAC
);

1522 
r
++;

1524 
	}
}

1526 
	$DECLARE_RTL_COND
(
¹l_efu£¬_cÚd
)

1528 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1530  
	`RTL_R32
(
EFUSEAR
è& 
EFUSEAR_FLAG
;

1531 
	}
}

1533 
u8
 
	$¹l8168d_efu£_»ad
(
¹l8169_´iv©e
 *

, 
»g_addr
)

1535 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1537 
	`RTL_W32
(
EFUSEAR
, (
»g_addr
 & 
EFUSEAR_REG_MASK
è<< 
EFUSEAR_REG_SHIFT
);

1539  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_efu£¬_cÚd
, 100, 300) ?

1540 
	`RTL_R32
(
EFUSEAR
è& 
EFUSEAR_DATA_MASK
 : ~0;

1541 
	}
}

1543 
u16
 
	$¹l_g‘_ev’ts
(
¹l8169_´iv©e
 *

)

1545 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1547  
	`RTL_R16
(
IÁrStus
);

1548 
	}
}

1550 
	$¹l_ack_ev’ts
(
¹l8169_´iv©e
 *

, 
u16
 
b™s
)

1552 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1554 
	`RTL_W16
(
IÁrStus
, 
b™s
);

1555 
	`mmiowb
();

1556 
	}
}

1558 
	$¹l_œq_di§bË
(
¹l8169_´iv©e
 *

)

1560 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1562 
	`RTL_W16
(
IÁrMask
, 0);

1563 
	`mmiowb
();

1564 
	}
}

1566 
	$¹l_œq_’abË
(
¹l8169_´iv©e
 *

, 
u16
 
b™s
)

1568 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1570 
	`RTL_W16
(
IÁrMask
, 
b™s
);

1571 
	}
}

1573 
	#RTL_EVENT_NAPI_RX
 (
RxOK
 | 
RxE¼
)

	)

1574 
	#RTL_EVENT_NAPI_TX
 (
TxOK
 | 
TxE¼
)

	)

1575 
	#RTL_EVENT_NAPI
 (
RTL_EVENT_NAPI_RX
 | 
RTL_EVENT_NAPI_TX
)

	)

1577 
	$¹l_œq_’abË_®l
(
¹l8169_´iv©e
 *

)

1579 
	`¹l_œq_’abË
(

, 
RTL_EVENT_NAPI
 |p->
ev’t_¦ow
);

1580 
	}
}

1582 
	$¹l8169_œq_mask_ªd_ack
(
¹l8169_´iv©e
 *

)

1584 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1586 
	`¹l_œq_di§bË
(

);

1587 
	`¹l_ack_ev’ts
(

, 
RTL_EVENT_NAPI
 |p->
ev’t_¦ow
);

1588 
	`RTL_R8
(
ChCmd
);

1589 
	}
}

1591 
	$¹l8169_tbi_»£t_³ndšg
(
¹l8169_´iv©e
 *

)

1593 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1595  
	`RTL_R32
(
TBICSR
è& 
TBIRe£t
;

1596 
	}
}

1598 
	$¹l8169_xmii_»£t_³ndšg
(
¹l8169_´iv©e
 *

)

1600  
	`¹l_»adphy
(

, 
MII_BMCR
è& 
BMCR_RESET
;

1601 
	}
}

1603 
	$¹l8169_tbi_lšk_ok
(
__iomem
 *
ißddr
)

1605  
	`RTL_R32
(
TBICSR
è& 
TBILškOk
;

1606 
	}
}

1608 
	$¹l8169_xmii_lšk_ok
(
__iomem
 *
ißddr
)

1610  
	`RTL_R8
(
PHY¡©us
è& 
LškStus
;

1611 
	}
}

1613 
	$¹l8169_tbi_»£t_’abË
(
¹l8169_´iv©e
 *

)

1615 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1617 
	`RTL_W32
(
TBICSR
, 
	`RTL_R32
(TBICSRè| 
TBIRe£t
);

1618 
	}
}

1620 
	$¹l8169_xmii_»£t_’abË
(
¹l8169_´iv©e
 *

)

1622 
v®
;

1624 
v®
 = 
	`¹l_»adphy
(

, 
MII_BMCR
è| 
BMCR_RESET
;

1625 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
v®
 & 0xffff);

1626 
	}
}

1628 
	$¹l_lšk_chg_·tch
(
¹l8169_´iv©e
 *

)

1630 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1631 
Ãt_deviû
 *
dev
 = 

->dev;

1633 ià(!
	`Ãtif_ruÂšg
(
dev
))

1636 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
 ||

1637 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
) {

1638 ià(
	`RTL_R8
(
PHY¡©us
è& 
_1000bpsF
) {

1639 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x00000011,

1640 
ERIAR_EXGMAC
);

1641 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1642 
ERIAR_EXGMAC
);

1643 } ià(
	`RTL_R8
(
PHY¡©us
è& 
_100bps
) {

1644 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1645 
ERIAR_EXGMAC
);

1646 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1647 
ERIAR_EXGMAC
);

1649 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1650 
ERIAR_EXGMAC
);

1651 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x0000003f,

1652 
ERIAR_EXGMAC
);

1655 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01,

1656 
ERIAR_EXGMAC
);

1657 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00,

1658 
ERIAR_EXGMAC
);

1659 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

1660 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
) {

1661 ià(
	`RTL_R8
(
PHY¡©us
è& 
_1000bpsF
) {

1662 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x00000011,

1663 
ERIAR_EXGMAC
);

1664 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x00000005,

1665 
ERIAR_EXGMAC
);

1667 
	`¹l_”i_wr™e
(

, 0x1bc, 
ERIAR_MASK_1111
, 0x0000001f,

1668 
ERIAR_EXGMAC
);

1669 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_1111
, 0x0000003f,

1670 
ERIAR_EXGMAC
);

1672 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
) {

1673 ià(
	`RTL_R8
(
PHY¡©us
è& 
_10bps
) {

1674 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x4d02,

1675 
ERIAR_EXGMAC
);

1676 
	`¹l_”i_wr™e
(

, 0x1dc, 
ERIAR_MASK_0011
, 0x0060,

1677 
ERIAR_EXGMAC
);

1679 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x0000,

1680 
ERIAR_EXGMAC
);

1683 
	}
}

1685 
	$__¹l8169_check_lšk_¡©us
(
Ãt_deviû
 *
dev
,

1686 
¹l8169_´iv©e
 *

,

1687 
__iomem
 *
ißddr
, 
boŞ
 
pm
)

1689 ià(

->
	`lšk_ok
(
ißddr
)) {

1690 
	`¹l_lšk_chg_·tch
(

);

1692 ià(
pm
)

1693 
	`pm_»que¡_»sume
(&

->
pci_dev
->
dev
);

1694 
	`Ãtif_ÿ¼›r_Ú
(
dev
);

1695 ià(
	`Ãt_¿‹lim™
())

1696 
	`Ãtif_šfo
(

, 
ifup
, 
dev
, "link up\n");

1698 
	`Ãtif_ÿ¼›r_off
(
dev
);

1699 
	`Ãtif_šfo
(

, 
ifdown
, 
dev
, "link down\n");

1700 ià(
pm
)

1701 
	`pm_scheduË_su¥’d
(&

->
pci_dev
->
dev
, 5000);

1703 
	}
}

1705 
	$¹l8169_check_lšk_¡©us
(
Ãt_deviû
 *
dev
,

1706 
¹l8169_´iv©e
 *

,

1707 
__iomem
 *
ißddr
)

1709 
	`__¹l8169_check_lšk_¡©us
(
dev
, 

, 
ißddr
, 
çl£
);

1710 
	}
}

1712 
	#WAKE_ANY
 (
WAKE_PHY
 | 
WAKE_MAGIC
 | 
WAKE_UCAST
 | 
WAKE_BCAST
 | 
WAKE_MCAST
)

	)

1714 
u32
 
	$__¹l8169_g‘_wŞ
(
¹l8169_´iv©e
 *

)

1716 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1717 
u8
 
İtiÚs
;

1718 
u32
 
wŞİts
 = 0;

1720 
İtiÚs
 = 
	`RTL_R8
(
CÚfig1
);

1721 ià(!(
İtiÚs
 & 
PMEÇbË
))

1724 
İtiÚs
 = 
	`RTL_R8
(
CÚfig3
);

1725 ià(
İtiÚs
 & 
LškUp
)

1726 
wŞİts
 |ğ
WAKE_PHY
;

1727 

->
mac_v”siÚ
) {

1728 
RTL_GIGA_MAC_VER_34
:

1729 
RTL_GIGA_MAC_VER_35
:

1730 
RTL_GIGA_MAC_VER_36
:

1731 
RTL_GIGA_MAC_VER_37
:

1732 
RTL_GIGA_MAC_VER_38
:

1733 
RTL_GIGA_MAC_VER_40
:

1734 
RTL_GIGA_MAC_VER_41
:

1735 
RTL_GIGA_MAC_VER_42
:

1736 
RTL_GIGA_MAC_VER_43
:

1737 
RTL_GIGA_MAC_VER_44
:

1738 
RTL_GIGA_MAC_VER_45
:

1739 
RTL_GIGA_MAC_VER_46
:

1740 
RTL_GIGA_MAC_VER_47
:

1741 
RTL_GIGA_MAC_VER_48
:

1742 
RTL_GIGA_MAC_VER_49
:

1743 
RTL_GIGA_MAC_VER_50
:

1744 
RTL_GIGA_MAC_VER_51
:

1745 ià(
	`¹l_”i_»ad
(

, 0xdc, 
ERIAR_EXGMAC
è& 
MagicPack‘_v2
)

1746 
wŞİts
 |ğ
WAKE_MAGIC
;

1749 ià(
İtiÚs
 & 
MagicPack‘
)

1750 
wŞİts
 |ğ
WAKE_MAGIC
;

1754 
İtiÚs
 = 
	`RTL_R8
(
CÚfig5
);

1755 ià(
İtiÚs
 & 
UWF
)

1756 
wŞİts
 |ğ
WAKE_UCAST
;

1757 ià(
İtiÚs
 & 
BWF
)

1758 
wŞİts
 |ğ
WAKE_BCAST
;

1759 ià(
İtiÚs
 & 
MWF
)

1760 
wŞİts
 |ğ
WAKE_MCAST
;

1762  
wŞİts
;

1763 
	}
}

1765 
	$¹l8169_g‘_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1767 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1768 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

1770 
	`pm_ruÁime_g‘_nÜesume
(
d
);

1772 
	`¹l_lock_wÜk
(

);

1774 
wŞ
->
suµÜ‹d
 = 
WAKE_ANY
;

1775 ià(
	`pm_ruÁime_aùive
(
d
))

1776 
wŞ
->
wŞİts
 = 
	`__¹l8169_g‘_wŞ
(

);

1778 
wŞ
->
wŞİts
 = 

->
§ved_wŞİts
;

1780 
	`¹l_uÆock_wÜk
(

);

1782 
	`pm_ruÁime_put_noidË
(
d
);

1783 
	}
}

1785 
	$__¹l8169_£t_wŞ
(
¹l8169_´iv©e
 *

, 
u32
 
wŞİts
)

1787 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1788 
i
, 
tmp
;

1790 
u32
 
İt
;

1791 
u16
 
»g
;

1792 
u8
 
mask
;

1793 } 
cfg
[] = {

1794 { 
WAKE_PHY
, 
CÚfig3
, 
LškUp
 },

1795 { 
WAKE_UCAST
, 
CÚfig5
, 
UWF
 },

1796 { 
WAKE_BCAST
, 
CÚfig5
, 
BWF
 },

1797 { 
WAKE_MCAST
, 
CÚfig5
, 
MWF
 },

1798 { 
WAKE_ANY
, 
CÚfig5
, 
LªWake
 },

1799 { 
WAKE_MAGIC
, 
CÚfig3
, 
MagicPack‘
 }

1801 
u8
 
İtiÚs
;

1803 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

1805 

->
mac_v”siÚ
) {

1806 
RTL_GIGA_MAC_VER_34
:

1807 
RTL_GIGA_MAC_VER_35
:

1808 
RTL_GIGA_MAC_VER_36
:

1809 
RTL_GIGA_MAC_VER_37
:

1810 
RTL_GIGA_MAC_VER_38
:

1811 
RTL_GIGA_MAC_VER_40
:

1812 
RTL_GIGA_MAC_VER_41
:

1813 
RTL_GIGA_MAC_VER_42
:

1814 
RTL_GIGA_MAC_VER_43
:

1815 
RTL_GIGA_MAC_VER_44
:

1816 
RTL_GIGA_MAC_VER_45
:

1817 
RTL_GIGA_MAC_VER_46
:

1818 
RTL_GIGA_MAC_VER_47
:

1819 
RTL_GIGA_MAC_VER_48
:

1820 
RTL_GIGA_MAC_VER_49
:

1821 
RTL_GIGA_MAC_VER_50
:

1822 
RTL_GIGA_MAC_VER_51
:

1823 
tmp
 = 
	`ARRAY_SIZE
(
cfg
) - 1;

1824 ià(
wŞİts
 & 
WAKE_MAGIC
)

1825 
	`¹l_w0w1_”i
(

,

1827 
ERIAR_MASK_0100
,

1828 
MagicPack‘_v2
,

1830 
ERIAR_EXGMAC
);

1832 
	`¹l_w0w1_”i
(

,

1834 
ERIAR_MASK_0100
,

1836 
MagicPack‘_v2
,

1837 
ERIAR_EXGMAC
);

1840 
tmp
 = 
	`ARRAY_SIZE
(
cfg
);

1844 
i
 = 0; i < 
tmp
; i++) {

1845 
İtiÚs
 = 
	`RTL_R8
(
cfg
[
i
].
»g
è& ~cfg[i].
mask
;

1846 ià(
wŞİts
 & 
cfg
[
i
].
İt
)

1847 
İtiÚs
 |ğ
cfg
[
i
].
mask
;

1848 
	`RTL_W8
(
cfg
[
i
].
»g
, 
İtiÚs
);

1851 

->
mac_v”siÚ
) {

1852 
RTL_GIGA_MAC_VER_01
 ... 
RTL_GIGA_MAC_VER_17
:

1853 
İtiÚs
 = 
	`RTL_R8
(
CÚfig1
è& ~
PMEÇbË
;

1854 ià(
wŞİts
)

1855 
İtiÚs
 |ğ
PMEÇbË
;

1856 
	`RTL_W8
(
CÚfig1
, 
İtiÚs
);

1859 
İtiÚs
 = 
	`RTL_R8
(
CÚfig2
è& ~
PME_SIGNAL
;

1860 ià(
wŞİts
)

1861 
İtiÚs
 |ğ
PME_SIGNAL
;

1862 
	`RTL_W8
(
CÚfig2
, 
İtiÚs
);

1866 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

1867 
	}
}

1869 
	$¹l8169_£t_wŞ
(
Ãt_deviû
 *
dev
, 
‘htoŞ_wŞšfo
 *
wŞ
)

1871 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1872 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

1874 
	`pm_ruÁime_g‘_nÜesume
(
d
);

1876 
	`¹l_lock_wÜk
(

);

1878 ià(
wŞ
->
wŞİts
)

1879 

->
ã©u»s
 |ğ
RTL_FEATURE_WOL
;

1881 

->
ã©u»s
 &ğ~
RTL_FEATURE_WOL
;

1882 ià(
	`pm_ruÁime_aùive
(
d
))

1883 
	`__¹l8169_£t_wŞ
(

, 
wŞ
->
wŞİts
);

1885 

->
§ved_wŞİts
 = 
wŞ
->
wŞİts
;

1887 
	`¹l_uÆock_wÜk
(

);

1889 
	`deviû_£t_wakeup_’abË
(&

->
pci_dev
->
dev
, 
wŞ
->
wŞİts
);

1891 
	`pm_ruÁime_put_noidË
(
d
);

1894 
	}
}

1896 cÚ¡ *
	$¹l_lookup_fœmw¬e_Çme
(
¹l8169_´iv©e
 *

)

1898  
¹l_ch_šfos
[

->
mac_v”siÚ
].
fw_Çme
;

1899 
	}
}

1901 
	$¹l8169_g‘_drvšfo
(
Ãt_deviû
 *
dev
,

1902 
‘htoŞ_drvšfo
 *
šfo
)

1904 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1905 
¹l_fw
 *¹l_fw = 

->rtl_fw;

1907 
	`¡¾ıy
(
šfo
->
driv”
, 
MODULENAME
, (info->driver));

1908 
	`¡¾ıy
(
šfo
->
v”siÚ
, 
RTL8169_VERSION
, (info->version));

1909 
	`¡¾ıy
(
šfo
->
bus_šfo
, 
	`pci_Çme
(

->
pci_dev
), (info->bus_info));

1910 
	`BUILD_BUG_ON
((
šfo
->
fw_v”siÚ
è< (
¹l_fw
->
v”siÚ
));

1911 ià(!
	`IS_ERR_OR_NULL
(
¹l_fw
))

1912 
	`¡¾ıy
(
šfo
->
fw_v”siÚ
, 
¹l_fw
->
v”siÚ
,

1913 (
šfo
->
fw_v”siÚ
));

1914 
	}
}

1916 
	$¹l8169_g‘_»gs_Ën
(
Ãt_deviû
 *
dev
)

1918  
R8169_REGS_SIZE
;

1919 
	}
}

1921 
	$¹l8169_£t_¥“d_tbi
(
Ãt_deviû
 *
dev
,

1922 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
ignÜed
)

1924 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1925 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

1926 
»t
 = 0;

1927 
u32
 
»g
;

1929 
»g
 = 
	`RTL_R32
(
TBICSR
);

1930 ià((
autÚeg
 =ğ
AUTONEG_DISABLE
è&& (
¥“d
 =ğ
SPEED_1000
) &&

1931 (
du¶ex
 =ğ
DUPLEX_FULL
)) {

1932 
	`RTL_W32
(
TBICSR
, 
»g
 & ~(
TBINwEÇbË
 | 
TBINwRe¡¬t
));

1933 } ià(
autÚeg
 =ğ
AUTONEG_ENABLE
)

1934 
	`RTL_W32
(
TBICSR
, 
»g
 | 
TBINwEÇbË
 | 
TBINwRe¡¬t
);

1936 
	`Ãtif_w¬n
(

, 
lšk
, 
dev
,

1938 
»t
 = -
EOPNOTSUPP
;

1941  
»t
;

1942 
	}
}

1944 
	$¹l8169_£t_¥“d_xmii
(
Ãt_deviû
 *
dev
,

1945 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
adv
)

1947 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

1948 
giga_ù¾
, 
bmü
;

1949 
rc
 = -
EINVAL
;

1951 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

1953 ià(
autÚeg
 =ğ
AUTONEG_ENABLE
) {

1954 
auto_Ãgo
;

1956 
auto_Ãgo
 = 
	`¹l_»adphy
(

, 
MII_ADVERTISE
);

1957 
auto_Ãgo
 &ğ~(
ADVERTISE_10HALF
 | 
ADVERTISE_10FULL
 |

1958 
ADVERTISE_100HALF
 | 
ADVERTISE_100FULL
);

1960 ià(
adv
 & 
ADVERTISED_10ba£T_H®f
)

1961 
auto_Ãgo
 |ğ
ADVERTISE_10HALF
;

1962 ià(
adv
 & 
ADVERTISED_10ba£T_FuÎ
)

1963 
auto_Ãgo
 |ğ
ADVERTISE_10FULL
;

1964 ià(
adv
 & 
ADVERTISED_100ba£T_H®f
)

1965 
auto_Ãgo
 |ğ
ADVERTISE_100HALF
;

1966 ià(
adv
 & 
ADVERTISED_100ba£T_FuÎ
)

1967 
auto_Ãgo
 |ğ
ADVERTISE_100FULL
;

1969 
auto_Ãgo
 |ğ
ADVERTISE_PAUSE_CAP
 | 
ADVERTISE_PAUSE_ASYM
;

1971 
giga_ù¾
 = 
	`¹l_»adphy
(

, 
MII_CTRL1000
);

1972 
giga_ù¾
 &ğ~(
ADVERTISE_1000FULL
 | 
ADVERTISE_1000HALF
);

1975 ià(

->
mii
.
suµÜts_gmii
) {

1976 ià(
adv
 & 
ADVERTISED_1000ba£T_H®f
)

1977 
giga_ù¾
 |ğ
ADVERTISE_1000HALF
;

1978 ià(
adv
 & 
ADVERTISED_1000ba£T_FuÎ
)

1979 
giga_ù¾
 |ğ
ADVERTISE_1000FULL
;

1980 } ià(
adv
 & (
ADVERTISED_1000ba£T_H®f
 |

1981 
ADVERTISED_1000ba£T_FuÎ
)) {

1982 
	`Ãtif_šfo
(

, 
lšk
, 
dev
,

1984 
out
;

1987 
bmü
 = 
BMCR_ANENABLE
 | 
BMCR_ANRESTART
;

1989 
	`¹l_wr™•hy
(

, 
MII_ADVERTISE
, 
auto_Ãgo
);

1990 
	`¹l_wr™•hy
(

, 
MII_CTRL1000
, 
giga_ù¾
);

1992 
giga_ù¾
 = 0;

1994 ià(
¥“d
 =ğ
SPEED_10
)

1995 
bmü
 = 0;

1996 ià(
¥“d
 =ğ
SPEED_100
)

1997 
bmü
 = 
BMCR_SPEED100
;

1999 
out
;

2001 ià(
du¶ex
 =ğ
DUPLEX_FULL
)

2002 
bmü
 |ğ
BMCR_FULLDPLX
;

2005 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
bmü
);

2007 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

2008 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
) {

2009 ià((
¥“d
 =ğ
SPEED_100
è&& (
autÚeg
 !ğ
AUTONEG_ENABLE
)) {

2010 
	`¹l_wr™•hy
(

, 0x17, 0x2138);

2011 
	`¹l_wr™•hy
(

, 0x0e, 0x0260);

2013 
	`¹l_wr™•hy
(

, 0x17, 0x2108);

2014 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

2018 
rc
 = 0;

2019 
out
:

2020  
rc
;

2021 
	}
}

2023 
	$¹l8169_£t_¥“d
(
Ãt_deviû
 *
dev
,

2024 
u8
 
autÚeg
, 
u16
 
¥“d
, u8 
du¶ex
, 
u32
 
adv”tisšg
)

2026 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2027 
»t
;

2029 
»t
 = 

->
	`£t_¥“d
(
dev
, 
autÚeg
, 
¥“d
, 
du¶ex
, 
adv”tisšg
);

2030 ià(
»t
 < 0)

2031 
out
;

2033 ià(
	`Ãtif_ruÂšg
(
dev
è&& (
autÚeg
 =ğ
AUTONEG_ENABLE
) &&

2034 (
adv”tisšg
 & 
ADVERTISED_1000ba£T_FuÎ
) &&

2035 !
	`pci_is_pc›
(

->
pci_dev
)) {

2036 
	`mod_tim”
(&

->
tim”
, 
jiff›s
 + 
RTL8169_PHY_TIMEOUT
);

2038 
out
:

2039  
»t
;

2040 
	}
}

2042 
	$¹l8169_£t_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2044 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2045 
»t
;

2047 
	`d–_tim”_sync
(&

->
tim”
);

2049 
	`¹l_lock_wÜk
(

);

2050 
»t
 = 
	`¹l8169_£t_¥“d
(
dev
, 
cmd
->
autÚeg
, 
	`‘htoŞ_cmd_¥“d
(cmd),

2051 
cmd
->
du¶ex
, cmd->
adv”tisšg
);

2052 
	`¹l_uÆock_wÜk
(

);

2054  
»t
;

2055 
	}
}

2057 
Ãtdev_ã©u»s_t
 
	$¹l8169_fix_ã©u»s
(
Ãt_deviû
 *
dev
,

2058 
Ãtdev_ã©u»s_t
 
ã©u»s
)

2060 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2062 ià(
dev
->
mtu
 > 
TD_MSS_MAX
)

2063 
ã©u»s
 &ğ~
NETIF_F_ALL_TSO
;

2065 ià(
dev
->
mtu
 > 
JUMBO_1K
 &&

2066 !
¹l_ch_šfos
[

->
mac_v”siÚ
].
jumbo_tx_csum
)

2067 
ã©u»s
 &ğ~
NETIF_F_IP_CSUM
;

2069  
ã©u»s
;

2070 
	}
}

2072 
	$__¹l8169_£t_ã©u»s
(
Ãt_deviû
 *
dev
,

2073 
Ãtdev_ã©u»s_t
 
ã©u»s
)

2075 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2076 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2077 
u32
 
rx_cÚfig
;

2079 
rx_cÚfig
 = 
	`RTL_R32
(
RxCÚfig
);

2080 ià(
ã©u»s
 & 
NETIF_F_RXALL
)

2081 
rx_cÚfig
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

2083 
rx_cÚfig
 &ğ~(
Acû±E¼
 | 
Acû±RuÁ
);

2085 
	`RTL_W32
(
RxCÚfig
, 
rx_cÚfig
);

2087 ià(
ã©u»s
 & 
NETIF_F_RXCSUM
)

2088 

->
ı_cmd
 |ğ
RxChkSum
;

2090 

->
ı_cmd
 &ğ~
RxChkSum
;

2092 ià(
ã©u»s
 & 
NETIF_F_HW_VLAN_CTAG_RX
)

2093 

->
ı_cmd
 |ğ
RxVÏn
;

2095 

->
ı_cmd
 &ğ~
RxVÏn
;

2097 

->
ı_cmd
 |ğ
	`RTL_R16
(
CPlusCmd
è& ~(
RxVÏn
 | 
RxChkSum
);

2099 
	`RTL_W16
(
CPlusCmd
, 

->
ı_cmd
);

2100 
	`RTL_R16
(
CPlusCmd
);

2101 
	}
}

2103 
	$¹l8169_£t_ã©u»s
(
Ãt_deviû
 *
dev
,

2104 
Ãtdev_ã©u»s_t
 
ã©u»s
)

2106 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2108 
ã©u»s
 &ğ
NETIF_F_RXALL
 | 
NETIF_F_RXCSUM
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

2110 
	`¹l_lock_wÜk
(

);

2111 ià(
ã©u»s
 ^ 
dev
->features)

2112 
	`__¹l8169_£t_ã©u»s
(
dev
, 
ã©u»s
);

2113 
	`¹l_uÆock_wÜk
(

);

2116 
	}
}

2119 
šlše
 
u32
 
	$¹l8169_tx_vÏn_g
(
sk_buff
 *
skb
)

2121  (
	`skb_vÏn_g_´e£Á
(
skb
)) ?

2122 
TxVÏnTag
 | 
	`swab16
(
	`skb_vÏn_g_g‘
(
skb
)) : 0x00;

2123 
	}
}

2125 
	$¹l8169_rx_vÏn_g
(
RxDesc
 *
desc
, 
sk_buff
 *
skb
)

2127 
u32
 
İts2
 = 
	`Ë32_to_ıu
(
desc
->opts2);

2129 ià(
İts2
 & 
RxVÏnTag
)

2130 
	`__vÏn_hwacûl_put_g
(
skb
, 
	`htÚs
(
ETH_P_8021Q
), 
	`swab16
(
İts2
 & 0xffff));

2131 
	}
}

2133 
	$¹l8169_g£t_tbi
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2135 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2136 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2137 
u32
 
¡©us
;

2139 
cmd
->
suµÜ‹d
 =

2140 
SUPPORTED_1000ba£T_FuÎ
 | 
SUPPORTED_AutÚeg
 | 
SUPPORTED_FIBRE
;

2141 
cmd
->
pÜt
 = 
PORT_FIBRE
;

2142 
cmd
->
Œªsûiv”
 = 
XCVR_INTERNAL
;

2144 
¡©us
 = 
	`RTL_R32
(
TBICSR
);

2145 
cmd
->
adv”tisšg
 = (
¡©us
 & 
TBINwEÇbË
è? 
ADVERTISED_AutÚeg
 : 0;

2146 
cmd
->
autÚeg
 = !!(
¡©us
 & 
TBINwEÇbË
);

2148 
	`‘htoŞ_cmd_¥“d_£t
(
cmd
, 
SPEED_1000
);

2149 
cmd
->
du¶ex
 = 
DUPLEX_FULL
;

2152 
	}
}

2154 
	$¹l8169_g£t_xmii
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2156 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2158  
	`mii_‘htoŞ_g£t
(&

->
mii
, 
cmd
);

2159 
	}
}

2161 
	$¹l8169_g‘_£‰šgs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_cmd
 *
cmd
)

2163 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2164 
rc
;

2166 
	`¹l_lock_wÜk
(

);

2167 
rc
 = 

->
	`g‘_£‰šgs
(
dev
, 
cmd
);

2168 
	`¹l_uÆock_wÜk
(

);

2170  
rc
;

2171 
	}
}

2173 
	$¹l8169_g‘_»gs
(
Ãt_deviû
 *
dev
, 
‘htoŞ_»gs
 *
»gs
,

2174 *
p
)

2176 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2177 
u32
 
__iomem
 *
d©a
 = 

->
mmio_addr
;

2178 
u32
 *
dw
 = 
p
;

2179 
i
;

2181 
	`¹l_lock_wÜk
(

);

2182 
i
 = 0; i < 
R8169_REGS_SIZE
; i += 4)

2183 
	`memıy_äomio
(
dw
++, 
d©a
++, 4);

2184 
	`¹l_uÆock_wÜk
(

);

2185 
	}
}

2187 
u32
 
	$¹l8169_g‘_msgËv–
(
Ãt_deviû
 *
dev
)

2189 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2191  

->
msg_’abË
;

2192 
	}
}

2194 
	$¹l8169_£t_msgËv–
(
Ãt_deviû
 *
dev
, 
u32
 
v®ue
)

2196 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2198 

->
msg_’abË
 = 
v®ue
;

2199 
	}
}

2201 cÚ¡ 
	g¹l8169_g¡ršgs
[][
ETH_GSTRING_LEN
] = {

2223 
	$¹l8169_g‘_s£t_couÁ
(
Ãt_deviû
 *
dev
, 
s£t
)

2225 
s£t
) {

2226 
ETH_SS_STATS
:

2227  
	`ARRAY_SIZE
(
¹l8169_g¡ršgs
);

2229  -
EOPNOTSUPP
;

2231 
	}
}

2233 
	$DECLARE_RTL_COND
(
¹l_couÁ”s_cÚd
)

2235 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2237  
	`RTL_R32
(
CouÁ”AddrLow
è& (
CouÁ”Re£t
 | 
CouÁ”Dump
);

2238 
	}
}

2240 
boŞ
 
	$¹l8169_do_couÁ”s
(
Ãt_deviû
 *
dev
, 
u32
 
couÁ”_cmd
)

2242 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2243 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2244 
dma_addr_t
 
·ddr
 = 

->
couÁ”s_phys_addr
;

2245 
u32
 
cmd
;

2246 
boŞ
 
»t
;

2248 
	`RTL_W32
(
CouÁ”AddrHigh
, (
u64
)
·ddr
 >> 32);

2249 
cmd
 = (
u64
)
·ddr
 & 
	`DMA_BIT_MASK
(32);

2250 
	`RTL_W32
(
CouÁ”AddrLow
, 
cmd
);

2251 
	`RTL_W32
(
CouÁ”AddrLow
, 
cmd
 | 
couÁ”_cmd
);

2253 
»t
 = 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_couÁ”s_cÚd
, 10, 1000);

2255 
	`RTL_W32
(
CouÁ”AddrLow
, 0);

2256 
	`RTL_W32
(
CouÁ”AddrHigh
, 0);

2258  
»t
;

2259 
	}
}

2261 
boŞ
 
	$¹l8169_»£t_couÁ”s
(
Ãt_deviû
 *
dev
)

2263 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2269 ià(

->
mac_v”siÚ
 < 
RTL_GIGA_MAC_VER_19
)

2270  
Œue
;

2272  
	`¹l8169_do_couÁ”s
(
dev
, 
CouÁ”Re£t
);

2273 
	}
}

2275 
boŞ
 
	$¹l8169_upd©e_couÁ”s
(
Ãt_deviû
 *
dev
)

2277 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2278 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2284 ià((
	`RTL_R8
(
ChCmd
è& 
CmdRxEnb
) == 0)

2285  
Œue
;

2287  
	`¹l8169_do_couÁ”s
(
dev
, 
CouÁ”Dump
);

2288 
	}
}

2290 
boŞ
 
	$¹l8169_š™_couÁ”_off£ts
(
Ãt_deviû
 *
dev
)

2292 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2293 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

2294 
boŞ
 
»t
 = 
çl£
;

2311 ià(

->
tc_off£t
.
š™ed
)

2312  
Œue
;

2315 ià(
	`¹l8169_»£t_couÁ”s
(
dev
))

2316 
»t
 = 
Œue
;

2318 ià(
	`¹l8169_upd©e_couÁ”s
(
dev
))

2319 
»t
 = 
Œue
;

2321 

->
tc_off£t
.
tx_”rÜs
 = 
couÁ”s
->tx_errors;

2322 

->
tc_off£t
.
tx_muÉi_cŞlisiÚ
 = 
couÁ”s
->tx_multi_collision;

2323 

->
tc_off£t
.
tx_abÜ‹d
 = 
couÁ”s
->tx_aborted;

2324 

->
tc_off£t
.
š™ed
 = 
Œue
;

2326  
»t
;

2327 
	}
}

2329 
	$¹l8169_g‘_‘htoŞ_¡©s
(
Ãt_deviû
 *
dev
,

2330 
‘htoŞ_¡©s
 *
¡©s
, 
u64
 *
d©a
)

2332 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

2333 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

2334 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

2336 
	`ASSERT_RTNL
();

2338 
	`pm_ruÁime_g‘_nÜesume
(
d
);

2340 ià(
	`pm_ruÁime_aùive
(
d
))

2341 
	`¹l8169_upd©e_couÁ”s
(
dev
);

2343 
	`pm_ruÁime_put_noidË
(
d
);

2345 
d©a
[0] = 
	`Ë64_to_ıu
(
couÁ”s
->
tx_·ck‘s
);

2346 
d©a
[1] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_·ck‘s
);

2347 
d©a
[2] = 
	`Ë64_to_ıu
(
couÁ”s
->
tx_”rÜs
);

2348 
d©a
[3] = 
	`Ë32_to_ıu
(
couÁ”s
->
rx_”rÜs
);

2349 
d©a
[4] = 
	`Ë16_to_ıu
(
couÁ”s
->
rx_mis£d
);

2350 
d©a
[5] = 
	`Ë16_to_ıu
(
couÁ”s
->
®ign_”rÜs
);

2351 
d©a
[6] = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_Úe_cŞlisiÚ
);

2352 
d©a
[7] = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_muÉi_cŞlisiÚ
);

2353 
d©a
[8] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_uniÿ¡
);

2354 
d©a
[9] = 
	`Ë64_to_ıu
(
couÁ”s
->
rx_brßdÿ¡
);

2355 
d©a
[10] = 
	`Ë32_to_ıu
(
couÁ”s
->
rx_muÉiÿ¡
);

2356 
d©a
[11] = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_abÜ‹d
);

2357 
d©a
[12] = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_und”un
);

2358 
d©a
[13] = 

->
xdp_couÁ”s
.
£t
;

2359 
d©a
[14] = 

->
xdp_couÁ”s
.
·ss
;

2360 
d©a
[15] = 

->
xdp_couÁ”s
.
drİ
;

2361 
d©a
[16] = 

->
xdp_couÁ”s
.
tx
;

2362 
d©a
[17] = 

->
xdp_couÁ”s
.
abÜ‹d
;

2363 
d©a
[18] = 

->
xdp_couÁ”s
.
unknown
;

2365 
	}
}

2367 
	$¹l8169_g‘_¡ršgs
(
Ãt_deviû
 *
dev
, 
u32
 
¡ršg£t
, 
u8
 *
d©a
)

2369 
¡ršg£t
) {

2370 
ETH_SS_STATS
:

2371 
	`memıy
(
d©a
, *
¹l8169_g¡ršgs
, (rtl8169_gstrings));

2374 
	}
}

2376 cÚ¡ 
‘htoŞ_İs
 
	g¹l8169_‘htoŞ_İs
 = {

2377 .
g‘_drvšfo
 = 
¹l8169_g‘_drvšfo
,

2378 .
	gg‘_»gs_Ën
 = 
¹l8169_g‘_»gs_Ën
,

2379 .
	gg‘_lšk
 = 
‘htoŞ_İ_g‘_lšk
,

2380 .
	gg‘_£‰šgs
 = 
¹l8169_g‘_£‰šgs
,

2381 .
	g£t_£‰šgs
 = 
¹l8169_£t_£‰šgs
,

2382 .
	gg‘_msgËv–
 = 
¹l8169_g‘_msgËv–
,

2383 .
	g£t_msgËv–
 = 
¹l8169_£t_msgËv–
,

2384 .
	gg‘_»gs
 = 
¹l8169_g‘_»gs
,

2385 .
	gg‘_wŞ
 = 
¹l8169_g‘_wŞ
,

2386 .
	g£t_wŞ
 = 
¹l8169_£t_wŞ
,

2387 .
	gg‘_¡ršgs
 = 
¹l8169_g‘_¡ršgs
,

2388 .
	gg‘_s£t_couÁ
 = 
¹l8169_g‘_s£t_couÁ
,

2389 .
	gg‘_‘htoŞ_¡©s
 = 
¹l8169_g‘_‘htoŞ_¡©s
,

2390 .
	gg‘_ts_šfo
 = 
‘htoŞ_İ_g‘_ts_šfo
,

2393 
	$¹l8169_g‘_mac_v”siÚ
(
¹l8169_´iv©e
 *

,

2394 
Ãt_deviû
 *
dev
, 
u8
 
deçuÉ_v”siÚ
)

2396 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

2408 cÚ¡ 
	s¹l_mac_šfo
 {

2409 
u32
 
mask
;

2410 
u32
 
v®
;

2411 
mac_v”siÚ
;

2412 } 
mac_šfo
[] = {

2414 { 0x7cf00000, 0x50200000, 
RTL_GIGA_MAC_VER_51
 },

2415 { 0x7cf00000, 0x50100000, 
RTL_GIGA_MAC_VER_50
 },

2416 { 0x7cf00000, 0x50000000, 
RTL_GIGA_MAC_VER_49
 },

2419 { 0x7cf00000, 0x54100000, 
RTL_GIGA_MAC_VER_46
 },

2420 { 0x7cf00000, 0x54000000, 
RTL_GIGA_MAC_VER_45
 },

2423 { 0x7cf00000, 0x5c800000, 
RTL_GIGA_MAC_VER_44
 },

2424 { 0x7cf00000, 0x50900000, 
RTL_GIGA_MAC_VER_42
 },

2425 { 0x7cf00000, 0x4c100000, 
RTL_GIGA_MAC_VER_41
 },

2426 { 0x7cf00000, 0x4c000000, 
RTL_GIGA_MAC_VER_40
 },

2429 { 0x7c800000, 0x48800000, 
RTL_GIGA_MAC_VER_38
 },

2430 { 0x7cf00000, 0x48100000, 
RTL_GIGA_MAC_VER_36
 },

2431 { 0x7cf00000, 0x48000000, 
RTL_GIGA_MAC_VER_35
 },

2434 { 0x7c800000, 0x2c800000, 
RTL_GIGA_MAC_VER_34
 },

2435 { 0x7cf00000, 0x2c200000, 
RTL_GIGA_MAC_VER_33
 },

2436 { 0x7cf00000, 0x2c100000, 
RTL_GIGA_MAC_VER_32
 },

2437 { 0x7c800000, 0x2c000000, 
RTL_GIGA_MAC_VER_33
 },

2440 { 0x7cf00000, 0x28300000, 
RTL_GIGA_MAC_VER_26
 },

2441 { 0x7cf00000, 0x28100000, 
RTL_GIGA_MAC_VER_25
 },

2442 { 0x7c800000, 0x28000000, 
RTL_GIGA_MAC_VER_26
 },

2445 { 0x7cf00000, 0x28800000, 
RTL_GIGA_MAC_VER_27
 },

2446 { 0x7cf00000, 0x28a00000, 
RTL_GIGA_MAC_VER_28
 },

2447 { 0x7cf00000, 0x28b00000, 
RTL_GIGA_MAC_VER_31
 },

2450 { 0x7cf00000, 0x3cb00000, 
RTL_GIGA_MAC_VER_24
 },

2451 { 0x7cf00000, 0x3c900000, 
RTL_GIGA_MAC_VER_23
 },

2452 { 0x7cf00000, 0x3c800000, 
RTL_GIGA_MAC_VER_18
 },

2453 { 0x7c800000, 0x3c800000, 
RTL_GIGA_MAC_VER_24
 },

2454 { 0x7cf00000, 0x3c000000, 
RTL_GIGA_MAC_VER_19
 },

2455 { 0x7cf00000, 0x3c200000, 
RTL_GIGA_MAC_VER_20
 },

2456 { 0x7cf00000, 0x3c300000, 
RTL_GIGA_MAC_VER_21
 },

2457 { 0x7cf00000, 0x3c400000, 
RTL_GIGA_MAC_VER_22
 },

2458 { 0x7c800000, 0x3c000000, 
RTL_GIGA_MAC_VER_22
 },

2461 { 0x7cf00000, 0x38000000, 
RTL_GIGA_MAC_VER_12
 },

2462 { 0x7cf00000, 0x38500000, 
RTL_GIGA_MAC_VER_17
 },

2463 { 0x7c800000, 0x38000000, 
RTL_GIGA_MAC_VER_17
 },

2464 { 0x7c800000, 0x30000000, 
RTL_GIGA_MAC_VER_11
 },

2467 { 0x7cf00000, 0x44900000, 
RTL_GIGA_MAC_VER_39
 },

2468 { 0x7c800000, 0x44800000, 
RTL_GIGA_MAC_VER_39
 },

2469 { 0x7c800000, 0x44000000, 
RTL_GIGA_MAC_VER_37
 },

2470 { 0x7cf00000, 0x40b00000, 
RTL_GIGA_MAC_VER_30
 },

2471 { 0x7cf00000, 0x40a00000, 
RTL_GIGA_MAC_VER_30
 },

2472 { 0x7cf00000, 0x40900000, 
RTL_GIGA_MAC_VER_29
 },

2473 { 0x7c800000, 0x40800000, 
RTL_GIGA_MAC_VER_30
 },

2474 { 0x7cf00000, 0x34a00000, 
RTL_GIGA_MAC_VER_09
 },

2475 { 0x7cf00000, 0x24a00000, 
RTL_GIGA_MAC_VER_09
 },

2476 { 0x7cf00000, 0x34900000, 
RTL_GIGA_MAC_VER_08
 },

2477 { 0x7cf00000, 0x24900000, 
RTL_GIGA_MAC_VER_08
 },

2478 { 0x7cf00000, 0x34800000, 
RTL_GIGA_MAC_VER_07
 },

2479 { 0x7cf00000, 0x24800000, 
RTL_GIGA_MAC_VER_07
 },

2480 { 0x7cf00000, 0x34000000, 
RTL_GIGA_MAC_VER_13
 },

2481 { 0x7cf00000, 0x34300000, 
RTL_GIGA_MAC_VER_10
 },

2482 { 0x7cf00000, 0x34200000, 
RTL_GIGA_MAC_VER_16
 },

2483 { 0x7c800000, 0x34800000, 
RTL_GIGA_MAC_VER_09
 },

2484 { 0x7c800000, 0x24800000, 
RTL_GIGA_MAC_VER_09
 },

2485 { 0x7c800000, 0x34000000, 
RTL_GIGA_MAC_VER_16
 },

2487 { 0xfc800000, 0x38800000, 
RTL_GIGA_MAC_VER_15
 },

2488 { 0xfc800000, 0x30800000, 
RTL_GIGA_MAC_VER_14
 },

2491 { 0xfc800000, 0x98000000, 
RTL_GIGA_MAC_VER_06
 },

2492 { 0xfc800000, 0x18000000, 
RTL_GIGA_MAC_VER_05
 },

2493 { 0xfc800000, 0x10000000, 
RTL_GIGA_MAC_VER_04
 },

2494 { 0xfc800000, 0x04000000, 
RTL_GIGA_MAC_VER_03
 },

2495 { 0xfc800000, 0x00800000, 
RTL_GIGA_MAC_VER_02
 },

2496 { 0xfc800000, 0x00000000, 
RTL_GIGA_MAC_VER_01
 },

2499 { 0x00000000, 0x00000000, 
RTL_GIGA_MAC_NONE
 }

2501 cÚ¡ 
¹l_mac_šfo
 *
p
 = 
mac_šfo
;

2502 
u32
 
»g
;

2504 
»g
 = 
	`RTL_R32
(
TxCÚfig
);

2505 (
»g
 & 
p
->
mask
è!ğp->
v®
)

2506 
p
++;

2507 

->
mac_v”siÚ
 = 
p
->mac_version;

2509 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_NONE
) {

2510 
	`Ãtif_nÙiû
(

, 
´obe
, 
dev
,

2512 

->
mac_v”siÚ
 = 
deçuÉ_v”siÚ
;

2513 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
) {

2514 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2515 
RTL_GIGA_MAC_VER_42
 :

2516 
RTL_GIGA_MAC_VER_43
;

2517 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
) {

2518 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2519 
RTL_GIGA_MAC_VER_45
 :

2520 
RTL_GIGA_MAC_VER_47
;

2521 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
) {

2522 

->
mac_v”siÚ
 =p->
mii
.
suµÜts_gmii
 ?

2523 
RTL_GIGA_MAC_VER_46
 :

2524 
RTL_GIGA_MAC_VER_48
;

2526 
	}
}

2528 
	$¹l8169_´št_mac_v”siÚ
(
¹l8169_´iv©e
 *

)

2530 
	`d´štk
("mac_v”siÚ = 0x%02x\n", 

->
mac_v”siÚ
);

2531 
	}
}

2533 
	sphy_»g
 {

2534 
u16
 
	m»g
;

2535 
u16
 
	mv®
;

2538 
	$¹l_wr™•hy_b©ch
(
¹l8169_´iv©e
 *

,

2539 cÚ¡ 
phy_»g
 *
»gs
, 
Ën
)

2541 
Ën
-- > 0) {

2542 
	`¹l_wr™•hy
(

, 
»gs
->
»g
,„egs->
v®
);

2543 
»gs
++;

2545 
	}
}

2547 
	#PHY_READ
 0x00000000

	)

2548 
	#PHY_DATA_OR
 0x10000000

	)

2549 
	#PHY_DATA_AND
 0x20000000

	)

2550 
	#PHY_BJMPN
 0x30000000

	)

2551 
	#PHY_MDIO_CHG
 0x40000000

	)

2552 
	#PHY_CLEAR_READCOUNT
 0x70000000

	)

2553 
	#PHY_WRITE
 0x80000000

	)

2554 
	#PHY_READCOUNT_EQ_SKIP
 0x90000000

	)

2555 
	#PHY_COMP_EQ_SKIPN
 0xa0000000

	)

2556 
	#PHY_COMP_NEQ_SKIPN
 0xb0000000

	)

2557 
	#PHY_WRITE_PREVIOUS
 0xc0000000

	)

2558 
	#PHY_SKIPN
 0xd0000000

	)

2559 
	#PHY_DELAY_MS
 0xe0000000

	)

2561 
	sfw_šfo
 {

2562 
u32
 
	mmagic
;

2563 
	mv”siÚ
[
RTL_VER_SIZE
];

2564 
__Ë32
 
	mfw_¡¬t
;

2565 
__Ë32
 
	mfw_Ën
;

2566 
u8
 
	mchksum
;

2567 } 
	g__·cked
;

2569 
	#FW_OPCODE_SIZE
 (
	`ty³of
(*((
¹l_fw_phy_aùiÚ
 *)0)->
code
))

	)

2571 
boŞ
 
	$¹l_fw_fÜm©_ok
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2573 cÚ¡ 
fœmw¬e
 *
fw
 = 
¹l_fw
->fw;

2574 
fw_šfo
 *fw_šfØğ(fw_šfØ*)
fw
->
d©a
;

2575 
¹l_fw_phy_aùiÚ
 *
·
 = &
¹l_fw
->
phy_aùiÚ
;

2576 *
v”siÚ
 = 
¹l_fw
->version;

2577 
boŞ
 
rc
 = 
çl£
;

2579 ià(
fw
->
size
 < 
FW_OPCODE_SIZE
)

2580 
out
;

2582 ià(!
fw_šfo
->
magic
) {

2583 
size_t
 
i
, 
size
, 
¡¬t
;

2584 
u8
 
checksum
 = 0;

2586 ià(
fw
->
size
 < (*
fw_šfo
))

2587 
out
;

2589 
i
 = 0; i < 
fw
->
size
; i++)

2590 
checksum
 +ğ
fw
->
d©a
[
i
];

2591 ià(
checksum
 != 0)

2592 
out
;

2594 
¡¬t
 = 
	`Ë32_to_ıu
(
fw_šfo
->
fw_¡¬t
);

2595 ià(
¡¬t
 > 
fw
->
size
)

2596 
out
;

2598 
size
 = 
	`Ë32_to_ıu
(
fw_šfo
->
fw_Ën
);

2599 ià(
size
 > (
fw
->siz- 
¡¬t
è/ 
FW_OPCODE_SIZE
)

2600 
out
;

2602 
	`memıy
(
v”siÚ
, 
fw_šfo
->v”siÚ, 
RTL_VER_SIZE
);

2604 
·
->
code
 = (
__Ë32
 *)(
fw
->
d©a
 + 
¡¬t
);

2605 
·
->
size
 = size;

2607 ià(
fw
->
size
 % 
FW_OPCODE_SIZE
)

2608 
out
;

2610 
	`¡¾ıy
(
v”siÚ
, 
	`¹l_lookup_fœmw¬e_Çme
(

), 
RTL_VER_SIZE
);

2612 
·
->
code
 = (
__Ë32
 *)
fw
->
d©a
;

2613 
·
->
size
 = 
fw
->siz/ 
FW_OPCODE_SIZE
;

2615 
v”siÚ
[
RTL_VER_SIZE
 - 1] = 0;

2617 
rc
 = 
Œue
;

2618 
out
:

2619  
rc
;

2620 
	}
}

2622 
boŞ
 
	$¹l_fw_d©a_ok
(
¹l8169_´iv©e
 *

, 
Ãt_deviû
 *
dev
,

2623 
¹l_fw_phy_aùiÚ
 *
·
)

2625 
boŞ
 
rc
 = 
çl£
;

2626 
size_t
 
šdex
;

2628 
šdex
 = 0; index < 
·
->
size
; index++) {

2629 
u32
 
aùiÚ
 = 
	`Ë32_to_ıu
(
·
->
code
[
šdex
]);

2630 
u32
 
»gno
 = (
aùiÚ
 & 0x0fff0000) >> 16;

2632 
aùiÚ
 & 0xf0000000) {

2633 
PHY_READ
:

2634 
PHY_DATA_OR
:

2635 
PHY_DATA_AND
:

2636 
PHY_MDIO_CHG
:

2637 
PHY_CLEAR_READCOUNT
:

2638 
PHY_WRITE
:

2639 
PHY_WRITE_PREVIOUS
:

2640 
PHY_DELAY_MS
:

2643 
PHY_BJMPN
:

2644 ià(
»gno
 > 
šdex
) {

2645 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2647 
out
;

2650 
PHY_READCOUNT_EQ_SKIP
:

2651 ià(
šdex
 + 2 >ğ
·
->
size
) {

2652 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2654 
out
;

2657 
PHY_COMP_EQ_SKIPN
:

2658 
PHY_COMP_NEQ_SKIPN
:

2659 
PHY_SKIPN
:

2660 ià(
šdex
 + 1 + 
»gno
 >ğ
·
->
size
) {

2661 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2663 
out
;

2668 
	`Ãtif_”r
(

, 
ifup
,p->
dev
,

2669 "Inv®id‡ùiÚ 0x%08x\n", 
aùiÚ
);

2670 
out
;

2673 
rc
 = 
Œue
;

2674 
out
:

2675  
rc
;

2676 
	}
}

2678 
	$¹l_check_fœmw¬e
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2680 
Ãt_deviû
 *
dev
 = 

->dev;

2681 
rc
 = -
EINVAL
;

2683 ià(!
	`¹l_fw_fÜm©_ok
(

, 
¹l_fw
)) {

2684 
	`Ãtif_”r
(

, 
ifup
, 
dev
, "invalid firmware\n");

2685 
out
;

2688 ià(
	`¹l_fw_d©a_ok
(

, 
dev
, &
¹l_fw
->
phy_aùiÚ
))

2689 
rc
 = 0;

2690 
out
:

2691  
rc
;

2692 
	}
}

2694 
	$¹l_phy_wr™e_fw
(
¹l8169_´iv©e
 *

, 
¹l_fw
 *rtl_fw)

2696 
¹l_fw_phy_aùiÚ
 *
·
 = &
¹l_fw
->
phy_aùiÚ
;

2697 
mdio_İs
 
Üg
, *
İs
 = &

->mdio_ops;

2698 
u32
 
´ed©a
, 
couÁ
;

2699 
size_t
 
šdex
;

2701 
´ed©a
 = 
couÁ
 = 0;

2702 
Üg
.
wr™e
 = 
İs
->write;

2703 
Üg
.
»ad
 = 
İs
->read;

2705 
šdex
 = 0; index < 
·
->
size
; ) {

2706 
u32
 
aùiÚ
 = 
	`Ë32_to_ıu
(
·
->
code
[
šdex
]);

2707 
u32
 
d©a
 = 
aùiÚ
 & 0x0000ffff;

2708 
u32
 
»gno
 = (
aùiÚ
 & 0x0fff0000) >> 16;

2710 ià(!
aùiÚ
)

2713 
aùiÚ
 & 0xf0000000) {

2714 
PHY_READ
:

2715 
´ed©a
 = 
	`¹l_»adphy
(

, 
»gno
);

2716 
couÁ
++;

2717 
šdex
++;

2719 
PHY_DATA_OR
:

2720 
´ed©a
 |ğ
d©a
;

2721 
šdex
++;

2723 
PHY_DATA_AND
:

2724 
´ed©a
 &ğ
d©a
;

2725 
šdex
++;

2727 
PHY_BJMPN
:

2728 
šdex
 -ğ
»gno
;

2730 
PHY_MDIO_CHG
:

2731 ià(
d©a
 == 0) {

2732 
İs
->
wr™e
 = 
Üg
.write;

2733 
İs
->
»ad
 = 
Üg
.read;

2734 } ià(
d©a
 == 1) {

2735 
İs
->
wr™e
 = 
mac_mcu_wr™e
;

2736 
İs
->
»ad
 = 
mac_mcu_»ad
;

2739 
šdex
++;

2741 
PHY_CLEAR_READCOUNT
:

2742 
couÁ
 = 0;

2743 
šdex
++;

2745 
PHY_WRITE
:

2746 
	`¹l_wr™•hy
(

, 
»gno
, 
d©a
);

2747 
šdex
++;

2749 
PHY_READCOUNT_EQ_SKIP
:

2750 
šdex
 +ğ(
couÁ
 =ğ
d©a
) ? 2 : 1;

2752 
PHY_COMP_EQ_SKIPN
:

2753 ià(
´ed©a
 =ğ
d©a
)

2754 
šdex
 +ğ
»gno
;

2755 
šdex
++;

2757 
PHY_COMP_NEQ_SKIPN
:

2758 ià(
´ed©a
 !ğ
d©a
)

2759 
šdex
 +ğ
»gno
;

2760 
šdex
++;

2762 
PHY_WRITE_PREVIOUS
:

2763 
	`¹l_wr™•hy
(

, 
»gno
, 
´ed©a
);

2764 
šdex
++;

2766 
PHY_SKIPN
:

2767 
šdex
 +ğ
»gno
 + 1;

2769 
PHY_DELAY_MS
:

2770 
	`md–ay
(
d©a
);

2771 
šdex
++;

2775 
	`BUG
();

2779 
İs
->
wr™e
 = 
Üg
.write;

2780 
İs
->
»ad
 = 
Üg
.read;

2781 
	}
}

2783 
	$¹l_»Ëa£_fœmw¬e
(
¹l8169_´iv©e
 *

)

2785 ià(!
	`IS_ERR_OR_NULL
(

->
¹l_fw
)) {

2786 
	`»Ëa£_fœmw¬e
(

->
¹l_fw
->
fw
);

2787 
	`kä“
(

->
¹l_fw
);

2789 

->
¹l_fw
 = 
RTL_FIRMWARE_UNKNOWN
;

2790 
	}
}

2792 
	$¹l_­¶y_fœmw¬e
(
¹l8169_´iv©e
 *

)

2794 
¹l_fw
 *¹l_fw = 

->rtl_fw;

2797 ià(!
	`IS_ERR_OR_NULL
(
¹l_fw
))

2798 
	`¹l_phy_wr™e_fw
(

, 
¹l_fw
);

2799 
	}
}

2801 
	$¹l_­¶y_fœmw¬e_cÚd
(
¹l8169_´iv©e
 *

, 
u8
 
»g
, 
u16
 
v®
)

2803 ià(
	`¹l_»adphy
(

, 
»g
è!ğ
v®
)

2804 
	`Ãtif_w¬n
(

, 
hw
,p->
dev
, "chipset‚ot„eady for firmware\n");

2806 
	`¹l_­¶y_fœmw¬e
(

);

2807 
	}
}

2809 
	$¹l8169s_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

2811 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

2873 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

2874 
	}
}

2876 
	$¹l8169sb_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

2878 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

2884 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

2885 
	}
}

2887 
	$¹l8169scd_hw_phy_cÚfig_quœk
(
¹l8169_´iv©e
 *

)

2889 
pci_dev
 *
pdev
 = 

->pci_dev;

2891 ià((
pdev
->
subsy¡em_v’dÜ
 !ğ
PCI_VENDOR_ID_GIGABYTE
) ||

2892 (
pdev
->
subsy¡em_deviû
 != 0xe000))

2895 
	`¹l_wr™•hy
(

, 0x1f, 0x0001);

2896 
	`¹l_wr™•hy
(

, 0x10, 0xf01b);

2897 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

2898 
	}
}

2900 
	$¹l8169scd_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

2902 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

2942 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

2944 
	`¹l8169scd_hw_phy_cÚfig_quœk
(

);

2945 
	}
}

2947 
	$¹l8169sû_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

2949 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

2997 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

2998 
	}
}

3000 
	$¹l8168bb_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3002 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3007 
	`¹l_wr™•hy
(

, 0x1f, 0x0001);

3008 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3010 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3011 
	}
}

3013 
	$¹l8168bef_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3015 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3021 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3022 
	}
}

3024 
	$¹l8168ı_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3026 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3034 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3035 
	}
}

3037 
	$¹l8168ı_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3039 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3045 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3046 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3047 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3049 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3050 
	}
}

3052 
	$¹l8168c_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3054 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3074 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3076 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3077 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3078 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3079 
	}
}

3081 
	$¹l8168c_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3083 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3101 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3103 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3104 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3105 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3106 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3107 
	}
}

3109 
	$¹l8168c_3_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3111 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3123 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3125 
	`¹l_·tchphy
(

, 0x16, 1 << 0);

3126 
	`¹l_·tchphy
(

, 0x14, 1 << 5);

3127 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3128 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3129 
	}
}

3131 
	$¹l8168c_4_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3133 
	`¹l8168c_3_hw_phy_cÚfig
(

);

3134 
	}
}

3136 
	$¹l8168d_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3138 cÚ¡ 
phy_»g
 
phy_»g_š™_0
[] = {

3179 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™_0
, 
	`ARRAY_SIZE
(phy_reg_init_0));

3185 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3186 
	`¹l_w0w1_phy
(

, 0x0b, 0x0010, 0x00ef);

3187 
	`¹l_w0w1_phy
(

, 0x0c, 0xa200, 0x5d00);

3189 ià(
	`¹l8168d_efu£_»ad
(

, 0x01) == 0xb1) {

3190 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3198 
v®
;

3200 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3202 
v®
 = 
	`¹l_»adphy
(

, 0x0d);

3204 ià((
v®
 & 0x00ff) != 0x006c) {

3205 cÚ¡ 
u32
 
£t
[] = {

3209 
i
;

3211 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3213 
v®
 &= 0xff00;

3214 
i
 = 0; i < 
	`ARRAY_SIZE
(
£t
); i++)

3215 
	`¹l_wr™•hy
(

, 0x0d, 
v®
 | 
£t
[
i
]);

3218 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3226 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3230 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3231 
	`¹l_·tchphy
(

, 0x0d, 0x0300);

3232 
	`¹l_·tchphy
(

, 0x0f, 0x0010);

3235 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3236 
	`¹l_w0w1_phy
(

, 0x02, 0x0100, 0x0600);

3237 
	`¹l_w0w1_phy
(

, 0x03, 0x0000, 0xe000);

3239 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3240 
	`¹l_wr™•hy
(

, 0x05, 0x001b);

3242 
	`¹l_­¶y_fœmw¬e_cÚd
(

, 
MII_EXPANSION
, 0xbf00);

3244 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3245 
	}
}

3247 
	$¹l8168d_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3249 cÚ¡ 
phy_»g
 
phy_»g_š™_0
[] = {

3290 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™_0
, 
	`ARRAY_SIZE
(phy_reg_init_0));

3292 ià(
	`¹l8168d_efu£_»ad
(

, 0x01) == 0xb1) {

3293 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3302 
v®
;

3304 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3306 
v®
 = 
	`¹l_»adphy
(

, 0x0d);

3307 ià((
v®
 & 0x00ff) != 0x006c) {

3308 cÚ¡ 
u32
 
£t
[] = {

3312 
i
;

3314 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3316 
v®
 &= 0xff00;

3317 
i
 = 0; i < 
	`ARRAY_SIZE
(
£t
); i++)

3318 
	`¹l_wr™•hy
(

, 0x0d, 
v®
 | 
£t
[
i
]);

3321 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3329 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3333 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3334 
	`¹l_w0w1_phy
(

, 0x02, 0x0100, 0x0600);

3335 
	`¹l_w0w1_phy
(

, 0x03, 0x0000, 0xe000);

3338 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3339 
	`¹l_·tchphy
(

, 0x0f, 0x0017);

3341 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3342 
	`¹l_wr™•hy
(

, 0x05, 0x001b);

3344 
	`¹l_­¶y_fœmw¬e_cÚd
(

, 
MII_EXPANSION
, 0xb300);

3346 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3347 
	}
}

3349 
	$¹l8168d_3_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3351 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3407 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3408 
	}
}

3410 
	$¹l8168d_4_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3412 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3422 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3423 
	`¹l_·tchphy
(

, 0x0d, 1 << 5);

3424 
	}
}

3426 
	$¹l8168e_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3428 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3456 
	`¹l_­¶y_fœmw¬e
(

);

3458 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3461 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3462 
	`¹l_wr™•hy
(

, 0x1e, 0x0023);

3463 
	`¹l_w0w1_phy
(

, 0x17, 0x0006, 0x0000);

3464 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3467 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3468 
	`¹l_w0w1_phy
(

, 0x08, 0x8000, 0x7f00);

3469 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3472 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3473 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3474 
	`¹l_w0w1_phy
(

, 0x18, 0x0050, 0x0000);

3475 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3476 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3478 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3479 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3480 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3481 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3483 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3484 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3485 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x2000);

3486 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3487 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3488 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x1100);

3489 
	`¹l_wr™•hy
(

, 0x1f, 0x0006);

3490 
	`¹l_wr™•hy
(

, 0x00, 0x5a00);

3491 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3492 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3493 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3494 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3495 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

3496 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3497 
	}
}

3499 
	$¹l_¿r_exgmac_£t
(
¹l8169_´iv©e
 *

, 
u8
 *
addr
)

3501 cÚ¡ 
u16
 
w
[] = {

3502 
addr
[0] | (addr[1] << 8),

3503 
addr
[2] | (addr[3] << 8),

3504 
addr
[4] | (addr[5] << 8)

3506 cÚ¡ 
exgmac_»g
 
e
[] = {

3507 { .
addr
 = 0xe0, 
ERIAR_MASK_1111
, .
v®
 = 
w
[0] | (w[1] << 16) },

3508 { .
addr
 = 0xe4, 
ERIAR_MASK_1111
, .
v®
 = 
w
[2] },

3509 { .
addr
 = 0xf0, 
ERIAR_MASK_1111
, .
v®
 = 
w
[0] << 16 },

3510 { .
addr
 = 0xf4, 
ERIAR_MASK_1111
, .
v®
 = 
w
[1] | (w[2] << 16) }

3513 
	`¹l_wr™e_exgmac_b©ch
(

, 
e
, 
	`ARRAY_SIZE
(e));

3514 
	}
}

3516 
	$¹l8168e_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3518 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3545 
	`¹l_­¶y_fœmw¬e
(

);

3547 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3550 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3551 
	`¹l_wr™•hy
(

, 0x05, 0x8b80);

3552 
	`¹l_w0w1_phy
(

, 0x17, 0x0006, 0x0000);

3553 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3556 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3557 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3558 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3559 
	`¹l_w0w1_phy
(

, 0x18, 0x0010, 0x0000);

3560 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3561 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3562 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3565 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3566 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3567 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3568 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3571 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3572 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3573 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3574 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3577 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_1111
, 0x0000, 0x0003, 
ERIAR_EXGMAC
);

3578 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3579 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3580 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x2000);

3581 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3582 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3583 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3584 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x0100);

3585 
	`¹l_wr™•hy
(

, 0x1f, 0x0002);

3586 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3587 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3588 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3589 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3590 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

3591 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3594 
	`¹l_wr™•hy
(

, 0x1f, 0x0003);

3595 
	`¹l_w0w1_phy
(

, 0x19, 0x0000, 0x0001);

3596 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0400);

3597 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3600 
	`¹l_¿r_exgmac_£t
(

,p->
dev
->
dev_addr
);

3601 
	}
}

3603 
	$¹l8168f_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3606 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3607 
	`¹l_wr™•hy
(

, 0x05, 0x8b80);

3608 
	`¹l_w0w1_phy
(

, 0x06, 0x0006, 0x0000);

3609 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3612 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3613 
	`¹l_wr™•hy
(

, 0x1e, 0x002d);

3614 
	`¹l_w0w1_phy
(

, 0x18, 0x0010, 0x0000);

3615 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3616 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3619 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3620 
	`¹l_wr™•hy
(

, 0x05, 0x8b86);

3621 
	`¹l_w0w1_phy
(

, 0x06, 0x0001, 0x0000);

3622 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3623 
	}
}

3625 
	$¹l8168f_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3627 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3662 
	`¹l_­¶y_fœmw¬e
(

);

3664 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3666 
	`¹l8168f_hw_phy_cÚfig
(

);

3669 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3670 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3671 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3672 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3673 
	}
}

3675 
	$¹l8168f_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3677 
	`¹l_­¶y_fœmw¬e
(

);

3679 
	`¹l8168f_hw_phy_cÚfig
(

);

3680 
	}
}

3682 
	$¹l8411_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3684 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

3720 
	`¹l_­¶y_fœmw¬e
(

);

3722 
	`¹l8168f_hw_phy_cÚfig
(

);

3725 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3726 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3727 
	`¹l_w0w1_phy
(

, 0x06, 0x4000, 0x0000);

3728 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3730 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

3733 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3734 
	`¹l_wr™•hy
(

, 0x05, 0x8b54);

3735 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0800);

3736 
	`¹l_wr™•hy
(

, 0x05, 0x8b5d);

3737 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0800);

3738 
	`¹l_wr™•hy
(

, 0x05, 0x8a7c);

3739 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3740 
	`¹l_wr™•hy
(

, 0x05, 0x8a7f);

3741 
	`¹l_w0w1_phy
(

, 0x06, 0x0100, 0x0000);

3742 
	`¹l_wr™•hy
(

, 0x05, 0x8a82);

3743 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3744 
	`¹l_wr™•hy
(

, 0x05, 0x8a85);

3745 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3746 
	`¹l_wr™•hy
(

, 0x05, 0x8a88);

3747 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x0100);

3748 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3751 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3752 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3753 
	`¹l_w0w1_phy
(

, 0x06, 0x8000, 0x0000);

3754 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3757 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x00, 0x03, 
ERIAR_EXGMAC
);

3758 
	`¹l_wr™•hy
(

, 0x1f, 0x0005);

3759 
	`¹l_wr™•hy
(

, 0x05, 0x8b85);

3760 
	`¹l_w0w1_phy
(

, 0x06, 0x0000, 0x2000);

3761 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

3762 
	`¹l_wr™•hy
(

, 0x1f, 0x0007);

3763 
	`¹l_wr™•hy
(

, 0x1e, 0x0020);

3764 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x0100);

3765 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3766 
	`¹l_wr™•hy
(

, 0x0d, 0x0007);

3767 
	`¹l_wr™•hy
(

, 0x0e, 0x003c);

3768 
	`¹l_wr™•hy
(

, 0x0d, 0x4007);

3769 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

3770 
	`¹l_wr™•hy
(

, 0x0d, 0x0000);

3773 
	`¹l_wr™•hy
(

, 0x1f, 0x0003);

3774 
	`¹l_w0w1_phy
(

, 0x19, 0x0000, 0x0001);

3775 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0400);

3776 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3777 
	}
}

3779 
	$¹l8168g_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3781 
	`¹l_­¶y_fœmw¬e
(

);

3783 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

3784 ià(
	`¹l_»adphy
(

, 0x10) & 0x0100) {

3785 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3786 
	`¹l_w0w1_phy
(

, 0x12, 0x0000, 0x8000);

3788 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3789 
	`¹l_w0w1_phy
(

, 0x12, 0x8000, 0x0000);

3792 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

3793 ià(
	`¹l_»adphy
(

, 0x13) & 0x0100) {

3794 
	`¹l_wr™•hy
(

, 0x1f, 0x0c41);

3795 
	`¹l_w0w1_phy
(

, 0x15, 0x0002, 0x0000);

3797 
	`¹l_wr™•hy
(

, 0x1f, 0x0c41);

3798 
	`¹l_w0w1_phy
(

, 0x15, 0x0000, 0x0002);

3802 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3803 
	`¹l_w0w1_phy
(

, 0x11, 0x000c, 0x0000);

3805 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

3806 
	`¹l_w0w1_phy
(

, 0x14, 0x0100, 0x0000);

3807 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3808 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

3809 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3810 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

3811 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

3812 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

3815 
	`¹l_wr™•hy
(

, 0x1f, 0x0a4b);

3816 
	`¹l_w0w1_phy
(

, 0x11, 0x0004, 0x0000);

3819 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3820 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

3821 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

3823 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

3824 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

3827 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

3828 
	`¹l_wr™•hy
(

, 0x14, 0x5065);

3829 
	`¹l_wr™•hy
(

, 0x14, 0xd065);

3830 
	`¹l_wr™•hy
(

, 0x1f, 0x0bc8);

3831 
	`¹l_wr™•hy
(

, 0x11, 0x5655);

3832 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

3833 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

3834 
	`¹l_wr™•hy
(

, 0x14, 0x9065);

3835 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

3838 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3839 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

3840 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

3842 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3843 
	}
}

3845 
	$¹l8168g_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3847 
	`¹l_­¶y_fœmw¬e
(

);

3848 
	}
}

3850 
	$¹l8168h_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3852 
u16
 
dout_pbš
;

3853 
u32
 
d©a
;

3855 
	`¹l_­¶y_fœmw¬e
(

);

3858 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3859 
	`¹l_wr™•hy
(

, 0x13, 0x809b);

3860 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0xf800);

3861 
	`¹l_wr™•hy
(

, 0x13, 0x80a2);

3862 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0xff00);

3863 
	`¹l_wr™•hy
(

, 0x13, 0x80a4);

3864 
	`¹l_w0w1_phy
(

, 0x14, 0x8500, 0xff00);

3865 
	`¹l_wr™•hy
(

, 0x13, 0x809c);

3866 
	`¹l_w0w1_phy
(

, 0x14, 0xbd00, 0xff00);

3867 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3870 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3871 
	`¹l_wr™•hy
(

, 0x13, 0x80ad);

3872 
	`¹l_w0w1_phy
(

, 0x14, 0x7000, 0xf800);

3873 
	`¹l_wr™•hy
(

, 0x13, 0x80b4);

3874 
	`¹l_w0w1_phy
(

, 0x14, 0x5000, 0xff00);

3875 
	`¹l_wr™•hy
(

, 0x13, 0x80ac);

3876 
	`¹l_w0w1_phy
(

, 0x14, 0x4000, 0xff00);

3877 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3880 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3881 
	`¹l_wr™•hy
(

, 0x13, 0x808e);

3882 
	`¹l_w0w1_phy
(

, 0x14, 0x1200, 0xff00);

3883 
	`¹l_wr™•hy
(

, 0x13, 0x8090);

3884 
	`¹l_w0w1_phy
(

, 0x14, 0xe500, 0xff00);

3885 
	`¹l_wr™•hy
(

, 0x13, 0x8092);

3886 
	`¹l_w0w1_phy
(

, 0x14, 0x9f00, 0xff00);

3887 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3890 
dout_pbš
 = 0;

3891 
	`¹l_wr™•hy
(

, 0x1f, 0x0a46);

3892 
d©a
 = 
	`¹l_»adphy
(

, 0x13);

3893 
d©a
 &= 3;

3894 
d©a
 <<= 2;

3895 
dout_pbš
 |ğ
d©a
;

3896 
d©a
 = 
	`¹l_»adphy
(

, 0x12);

3897 
d©a
 &= 0xc000;

3898 
d©a
 >>= 14;

3899 
dout_pbš
 |ğ
d©a
;

3900 
dout_pbš
 = ~(dout_tapbin^0x08);

3901 
dout_pbš
 <<= 12;

3902 
dout_pbš
 &= 0xf000;

3903 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3904 
	`¹l_wr™•hy
(

, 0x13, 0x827a);

3905 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

3906 
	`¹l_wr™•hy
(

, 0x13, 0x827b);

3907 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

3908 
	`¹l_wr™•hy
(

, 0x13, 0x827c);

3909 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

3910 
	`¹l_wr™•hy
(

, 0x13, 0x827d);

3911 
	`¹l_w0w1_phy
(

, 0x14, 
dout_pbš
, 0xf000);

3913 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3914 
	`¹l_wr™•hy
(

, 0x13, 0x0811);

3915 
	`¹l_w0w1_phy
(

, 0x14, 0x0800, 0x0000);

3916 
	`¹l_wr™•hy
(

, 0x1f, 0x0a42);

3917 
	`¹l_w0w1_phy
(

, 0x16, 0x0002, 0x0000);

3918 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3921 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3922 
	`¹l_w0w1_phy
(

, 0x11, 0x0800, 0x0000);

3923 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3926 
	`¹l_wr™•hy
(

, 0x1f, 0x0bca);

3927 
	`¹l_w0w1_phy
(

, 0x17, 0x4000, 0x3000);

3928 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3930 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3931 
	`¹l_wr™•hy
(

, 0x13, 0x803f);

3932 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3933 
	`¹l_wr™•hy
(

, 0x13, 0x8047);

3934 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3935 
	`¹l_wr™•hy
(

, 0x13, 0x804f);

3936 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3937 
	`¹l_wr™•hy
(

, 0x13, 0x8057);

3938 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3939 
	`¹l_wr™•hy
(

, 0x13, 0x805f);

3940 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3941 
	`¹l_wr™•hy
(

, 0x13, 0x8067);

3942 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3943 
	`¹l_wr™•hy
(

, 0x13, 0x806f);

3944 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x3000);

3945 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3948 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3949 
	`¹l_w0w1_phy
(

, 0x11, 0x0000, 0x0080);

3950 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3953 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3954 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

3955 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

3957 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3958 
	}
}

3960 
	$¹l8168h_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

3962 
u16
 
ioff£t_p3
, 
ioff£t_p2
, 
ioff£t_p1
, 
ioff£t_p0
;

3963 
u16
 
¾’
;

3964 
u32
 
d©a
;

3966 
	`¹l_­¶y_fœmw¬e
(

);

3969 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3970 
	`¹l_wr™•hy
(

, 0x13, 0x808a);

3971 
	`¹l_w0w1_phy
(

, 0x14, 0x000a, 0x003f);

3972 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3975 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

3976 
	`¹l_wr™•hy
(

, 0x13, 0x0811);

3977 
	`¹l_w0w1_phy
(

, 0x14, 0x0800, 0x0000);

3978 
	`¹l_wr™•hy
(

, 0x1f, 0x0a42);

3979 
	`¹l_w0w1_phy
(

, 0x16, 0x0002, 0x0000);

3980 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3983 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

3984 
	`¹l_w0w1_phy
(

, 0x11, 0x0800, 0x0000);

3985 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

3987 
	`r8168_mac_oı_wr™e
(

, 0xdd02, 0x807d);

3988 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xdd02);

3989 
ioff£t_p3
 = ((
d©a
 & 0x80)>>7);

3990 
ioff£t_p3
 <<= 3;

3992 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xdd00);

3993 
ioff£t_p3
 |ğ((
d©a
 & (0xe000))>>13);

3994 
ioff£t_p2
 = ((
d©a
 & (0x1e00))>>9);

3995 
ioff£t_p1
 = ((
d©a
 & (0x01e0))>>5);

3996 
ioff£t_p0
 = ((
d©a
 & 0x0010)>>4);

3997 
ioff£t_p0
 <<= 3;

3998 
ioff£t_p0
 |ğ(
d©a
 & (0x07));

3999 
d©a
 = (
ioff£t_p3
<<12)|(
ioff£t_p2
<<8)|(
ioff£t_p1
<<4)|(
ioff£t_p0
);

4001 ià((
ioff£t_p3
 !ğ0x0fè|| (
ioff£t_p2
 != 0x0f) ||

4002 (
ioff£t_p1
 !ğ0x0fè|| (
ioff£t_p0
 != 0x0f)) {

4003 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcf);

4004 
	`¹l_wr™•hy
(

, 0x16, 
d©a
);

4005 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4009 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4010 
d©a
 = 
	`¹l_»adphy
(

, 0x16);

4011 
d©a
 &= 0x000f;

4012 
¾’
 = 0;

4013 ià(
d©a
 > 3)

4014 
¾’
 = 
d©a
 - 3;

4015 
d©a
 = 
¾’
 | (rlen<<4) | (rlen<<8) | (rlen<<12);

4016 
	`¹l_wr™•hy
(

, 0x17, 
d©a
);

4017 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4018 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4021 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4022 
	`¹l_w0w1_phy
(

, 0x11, 0x0000, 0x0080);

4023 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4026 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4027 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4028 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4030 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4031 
	}
}

4033 
	$¹l8168•_1_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4036 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4037 
	`¹l_w0w1_phy
(

, 0x11, 0x000c, 0x0000);

4038 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4041 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

4042 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x0100);

4043 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4044 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

4045 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4046 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

4047 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

4048 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

4049 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4052 
	`¹l_wr™•hy
(

, 0x1f, 0x0a4b);

4053 
	`¹l_w0w1_phy
(

, 0x11, 0x0004, 0x0000);

4054 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4057 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4058 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

4059 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

4060 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4063 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

4064 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

4065 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4068 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4069 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4070 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4072 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4073 
	}
}

4075 
	$¹l8168•_2_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4078 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcc);

4079 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x0100);

4080 
	`¹l_wr™•hy
(

, 0x1f, 0x0a44);

4081 
	`¹l_w0w1_phy
(

, 0x11, 0x00c0, 0x0000);

4082 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4083 
	`¹l_wr™•hy
(

, 0x13, 0x8084);

4084 
	`¹l_w0w1_phy
(

, 0x14, 0x0000, 0x6000);

4085 
	`¹l_w0w1_phy
(

, 0x10, 0x1003, 0x0000);

4086 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4089 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4090 
	`¹l_wr™•hy
(

, 0x13, 0x8012);

4091 
	`¹l_w0w1_phy
(

, 0x14, 0x8000, 0x0000);

4092 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4095 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

4096 
	`¹l_w0w1_phy
(

, 0x11, 0x4000, 0x2000);

4097 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4100 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4101 
	`¹l_wr™•hy
(

, 0x13, 0x80f3);

4102 
	`¹l_w0w1_phy
(

, 0x14, 0x8b00, ~0x8bff);

4103 
	`¹l_wr™•hy
(

, 0x13, 0x80f0);

4104 
	`¹l_w0w1_phy
(

, 0x14, 0x3a00, ~0x3aff);

4105 
	`¹l_wr™•hy
(

, 0x13, 0x80ef);

4106 
	`¹l_w0w1_phy
(

, 0x14, 0x0500, ~0x05ff);

4107 
	`¹l_wr™•hy
(

, 0x13, 0x80f6);

4108 
	`¹l_w0w1_phy
(

, 0x14, 0x6e00, ~0x6eff);

4109 
	`¹l_wr™•hy
(

, 0x13, 0x80ec);

4110 
	`¹l_w0w1_phy
(

, 0x14, 0x6800, ~0x68ff);

4111 
	`¹l_wr™•hy
(

, 0x13, 0x80ed);

4112 
	`¹l_w0w1_phy
(

, 0x14, 0x7c00, ~0x7cff);

4113 
	`¹l_wr™•hy
(

, 0x13, 0x80f2);

4114 
	`¹l_w0w1_phy
(

, 0x14, 0xf400, ~0xf4ff);

4115 
	`¹l_wr™•hy
(

, 0x13, 0x80f4);

4116 
	`¹l_w0w1_phy
(

, 0x14, 0x8500, ~0x85ff);

4117 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4118 
	`¹l_wr™•hy
(

, 0x13, 0x8110);

4119 
	`¹l_w0w1_phy
(

, 0x14, 0xa800, ~0xa8ff);

4120 
	`¹l_wr™•hy
(

, 0x13, 0x810f);

4121 
	`¹l_w0w1_phy
(

, 0x14, 0x1d00, ~0x1dff);

4122 
	`¹l_wr™•hy
(

, 0x13, 0x8111);

4123 
	`¹l_w0w1_phy
(

, 0x14, 0xf500, ~0xf5ff);

4124 
	`¹l_wr™•hy
(

, 0x13, 0x8113);

4125 
	`¹l_w0w1_phy
(

, 0x14, 0x6100, ~0x61ff);

4126 
	`¹l_wr™•hy
(

, 0x13, 0x8115);

4127 
	`¹l_w0w1_phy
(

, 0x14, 0x9200, ~0x92ff);

4128 
	`¹l_wr™•hy
(

, 0x13, 0x810e);

4129 
	`¹l_w0w1_phy
(

, 0x14, 0x0400, ~0x04ff);

4130 
	`¹l_wr™•hy
(

, 0x13, 0x810c);

4131 
	`¹l_w0w1_phy
(

, 0x14, 0x7c00, ~0x7cff);

4132 
	`¹l_wr™•hy
(

, 0x13, 0x810b);

4133 
	`¹l_w0w1_phy
(

, 0x14, 0x5a00, ~0x5aff);

4134 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4135 
	`¹l_wr™•hy
(

, 0x13, 0x80d1);

4136 
	`¹l_w0w1_phy
(

, 0x14, 0xff00, ~0xffff);

4137 
	`¹l_wr™•hy
(

, 0x13, 0x80cd);

4138 
	`¹l_w0w1_phy
(

, 0x14, 0x9e00, ~0x9eff);

4139 
	`¹l_wr™•hy
(

, 0x13, 0x80d3);

4140 
	`¹l_w0w1_phy
(

, 0x14, 0x0e00, ~0x0eff);

4141 
	`¹l_wr™•hy
(

, 0x13, 0x80d5);

4142 
	`¹l_w0w1_phy
(

, 0x14, 0xca00, ~0xcaff);

4143 
	`¹l_wr™•hy
(

, 0x13, 0x80d7);

4144 
	`¹l_w0w1_phy
(

, 0x14, 0x8400, ~0x84ff);

4147 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4148 
	`¹l_wr™•hy
(

, 0x14, 0x5065);

4149 
	`¹l_wr™•hy
(

, 0x14, 0xd065);

4150 
	`¹l_wr™•hy
(

, 0x1f, 0x0bc8);

4151 
	`¹l_wr™•hy
(

, 0x12, 0x00ed);

4152 
	`¹l_wr™•hy
(

, 0x1f, 0x0bcd);

4153 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

4154 
	`¹l_wr™•hy
(

, 0x14, 0x9065);

4155 
	`¹l_wr™•hy
(

, 0x14, 0x1065);

4156 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4159 
	`¹l_wr™•hy
(

, 0x1f, 0x0a43);

4160 ià(
	`¹l_»adphy
(

, 0x10) & 0x0004)

4161 
	`¹l_w0w1_phy
(

, 0x10, 0x0000, 0x0004);

4163 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4164 
	}
}

4166 
	$¹l8102e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4168 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4175 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4176 
	`¹l_·tchphy
(

, 0x11, 1 << 12);

4177 
	`¹l_·tchphy
(

, 0x19, 1 << 13);

4178 
	`¹l_·tchphy
(

, 0x10, 1 << 15);

4180 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4181 
	}
}

4183 
	$¹l8105e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4185 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4200 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4201 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4202 
	`m¦“p
(100);

4204 
	`¹l_­¶y_fœmw¬e
(

);

4206 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4207 
	}
}

4209 
	$¹l8402_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4212 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4213 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4214 
	`m¦“p
(20);

4216 
	`¹l_­¶y_fœmw¬e
(

);

4219 
	`¹l_”i_wr™e
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4220 
	`¹l_wr™•hy
(

, 0x1f, 0x0004);

4221 
	`¹l_wr™•hy
(

, 0x10, 0x401f);

4222 
	`¹l_wr™•hy
(

, 0x19, 0x7030);

4223 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4224 
	}
}

4226 
	$¹l8106e_hw_phy_cÚfig
(
¹l8169_´iv©e
 *

)

4228 cÚ¡ 
phy_»g
 
phy_»g_š™
[] = {

4236 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4237 
	`¹l_wr™•hy
(

, 0x18, 0x0310);

4238 
	`m¦“p
(100);

4240 
	`¹l_­¶y_fœmw¬e
(

);

4242 
	`¹l_”i_wr™e
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4243 
	`¹l_wr™•hy_b©ch
(

, 
phy_»g_š™
, 
	`ARRAY_SIZE
(phy_reg_init));

4245 
	`¹l_”i_wr™e
(

, 0x1d0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

4246 
	}
}

4248 
	$¹l_hw_phy_cÚfig
(
Ãt_deviû
 *
dev
)

4250 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4252 
	`¹l8169_´št_mac_v”siÚ
(

);

4254 

->
mac_v”siÚ
) {

4255 
RTL_GIGA_MAC_VER_01
:

4257 
RTL_GIGA_MAC_VER_02
:

4258 
RTL_GIGA_MAC_VER_03
:

4259 
	`¹l8169s_hw_phy_cÚfig
(

);

4261 
RTL_GIGA_MAC_VER_04
:

4262 
	`¹l8169sb_hw_phy_cÚfig
(

);

4264 
RTL_GIGA_MAC_VER_05
:

4265 
	`¹l8169scd_hw_phy_cÚfig
(

);

4267 
RTL_GIGA_MAC_VER_06
:

4268 
	`¹l8169sû_hw_phy_cÚfig
(

);

4270 
RTL_GIGA_MAC_VER_07
:

4271 
RTL_GIGA_MAC_VER_08
:

4272 
RTL_GIGA_MAC_VER_09
:

4273 
	`¹l8102e_hw_phy_cÚfig
(

);

4275 
RTL_GIGA_MAC_VER_11
:

4276 
	`¹l8168bb_hw_phy_cÚfig
(

);

4278 
RTL_GIGA_MAC_VER_12
:

4279 
	`¹l8168bef_hw_phy_cÚfig
(

);

4281 
RTL_GIGA_MAC_VER_17
:

4282 
	`¹l8168bef_hw_phy_cÚfig
(

);

4284 
RTL_GIGA_MAC_VER_18
:

4285 
	`¹l8168ı_1_hw_phy_cÚfig
(

);

4287 
RTL_GIGA_MAC_VER_19
:

4288 
	`¹l8168c_1_hw_phy_cÚfig
(

);

4290 
RTL_GIGA_MAC_VER_20
:

4291 
	`¹l8168c_2_hw_phy_cÚfig
(

);

4293 
RTL_GIGA_MAC_VER_21
:

4294 
	`¹l8168c_3_hw_phy_cÚfig
(

);

4296 
RTL_GIGA_MAC_VER_22
:

4297 
	`¹l8168c_4_hw_phy_cÚfig
(

);

4299 
RTL_GIGA_MAC_VER_23
:

4300 
RTL_GIGA_MAC_VER_24
:

4301 
	`¹l8168ı_2_hw_phy_cÚfig
(

);

4303 
RTL_GIGA_MAC_VER_25
:

4304 
	`¹l8168d_1_hw_phy_cÚfig
(

);

4306 
RTL_GIGA_MAC_VER_26
:

4307 
	`¹l8168d_2_hw_phy_cÚfig
(

);

4309 
RTL_GIGA_MAC_VER_27
:

4310 
	`¹l8168d_3_hw_phy_cÚfig
(

);

4312 
RTL_GIGA_MAC_VER_28
:

4313 
	`¹l8168d_4_hw_phy_cÚfig
(

);

4315 
RTL_GIGA_MAC_VER_29
:

4316 
RTL_GIGA_MAC_VER_30
:

4317 
	`¹l8105e_hw_phy_cÚfig
(

);

4319 
RTL_GIGA_MAC_VER_31
:

4322 
RTL_GIGA_MAC_VER_32
:

4323 
RTL_GIGA_MAC_VER_33
:

4324 
	`¹l8168e_1_hw_phy_cÚfig
(

);

4326 
RTL_GIGA_MAC_VER_34
:

4327 
	`¹l8168e_2_hw_phy_cÚfig
(

);

4329 
RTL_GIGA_MAC_VER_35
:

4330 
	`¹l8168f_1_hw_phy_cÚfig
(

);

4332 
RTL_GIGA_MAC_VER_36
:

4333 
	`¹l8168f_2_hw_phy_cÚfig
(

);

4336 
RTL_GIGA_MAC_VER_37
:

4337 
	`¹l8402_hw_phy_cÚfig
(

);

4340 
RTL_GIGA_MAC_VER_38
:

4341 
	`¹l8411_hw_phy_cÚfig
(

);

4344 
RTL_GIGA_MAC_VER_39
:

4345 
	`¹l8106e_hw_phy_cÚfig
(

);

4348 
RTL_GIGA_MAC_VER_40
:

4349 
	`¹l8168g_1_hw_phy_cÚfig
(

);

4351 
RTL_GIGA_MAC_VER_42
:

4352 
RTL_GIGA_MAC_VER_43
:

4353 
RTL_GIGA_MAC_VER_44
:

4354 
	`¹l8168g_2_hw_phy_cÚfig
(

);

4356 
RTL_GIGA_MAC_VER_45
:

4357 
RTL_GIGA_MAC_VER_47
:

4358 
	`¹l8168h_1_hw_phy_cÚfig
(

);

4360 
RTL_GIGA_MAC_VER_46
:

4361 
RTL_GIGA_MAC_VER_48
:

4362 
	`¹l8168h_2_hw_phy_cÚfig
(

);

4365 
RTL_GIGA_MAC_VER_49
:

4366 
	`¹l8168•_1_hw_phy_cÚfig
(

);

4368 
RTL_GIGA_MAC_VER_50
:

4369 
RTL_GIGA_MAC_VER_51
:

4370 
	`¹l8168•_2_hw_phy_cÚfig
(

);

4373 
RTL_GIGA_MAC_VER_41
:

4377 
	}
}

4379 
	$¹l_phy_wÜk
(
¹l8169_´iv©e
 *

)

4381 
tim”_li¡
 *
tim”
 = &

->timer;

4382 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4383 
timeout
 = 
RTL8169_PHY_TIMEOUT
;

4385 
	`as£¹
(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_01
);

4387 ià(

->
	`phy_»£t_³ndšg
(tp)) {

4392 
timeout
 = 
HZ
/10;

4393 
out_mod_tim”
;

4396 ià(

->
	`lšk_ok
(
ißddr
))

4399 
	`Ãtif_dbg
(

, 
lšk
,p->
dev
, "PHY„eset until†ink up\n");

4401 

->
	`phy_»£t_’abË
(tp);

4403 
out_mod_tim”
:

4404 
	`mod_tim”
(
tim”
, 
jiff›s
 + 
timeout
);

4405 
	}
}

4407 
	$¹l_scheduË_sk
(
¹l8169_´iv©e
 *

, 
¹l_æag
 
æag
)

4409 ià(!
	`‹¡_ªd_£t_b™
(
æag
, 

->
wk
.
æags
))

4410 
	`scheduË_wÜk
(&

->
wk
.
wÜk
);

4411 
	}
}

4413 
	$¹l8169_phy_tim”
(
tim”_li¡
 *
t
)

4415 
¹l8169_´iv©e
 *

 = 
	`äom_tim”
Ñp, 
t
, 
tim”
);

4417 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_PHY_PENDING
);

4418 
	}
}

4420 
	$¹l8169_»Ëa£_bßrd
(
pci_dev
 *
pdev
, 
Ãt_deviû
 *
dev
,

4421 
__iomem
 *
ißddr
)

4423 
	`iounm­
(
ißddr
);

4424 
	`pci_»Ëa£_»giÚs
(
pdev
);

4425 
	`pci_ş—r_mwi
(
pdev
);

4426 
	`pci_di§bË_deviû
(
pdev
);

4427 
	`ä“_Ãtdev
(
dev
);

4428 
	}
}

4430 
	$DECLARE_RTL_COND
(
¹l_phy_»£t_cÚd
)

4432  

->
	`phy_»£t_³ndšg
(tp);

4433 
	}
}

4435 
	$¹l8169_phy_»£t
(
Ãt_deviû
 *
dev
,

4436 
¹l8169_´iv©e
 *

)

4438 

->
	`phy_»£t_’abË
(tp);

4439 
	`¹l_m¦“p_loİ_wa™_low
(

, &
¹l_phy_»£t_cÚd
, 1, 100);

4440 
	}
}

4442 
boŞ
 
	$¹l_tbi_’abËd
(
¹l8169_´iv©e
 *

)

4444 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4446  (

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
) &&

4447 (
	`RTL_R8
(
PHY¡©us
è& 
TBI_EÇbË
);

4448 
	}
}

4450 
	$¹l8169_š™_phy
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

)

4452 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4454 
	`¹l_hw_phy_cÚfig
(
dev
);

4456 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
) {

4457 
	`d´štk
("Set MAC Reg C+CR Offset 0x82h = 0x01h\n");

4458 
	`RTL_W8
(0x82, 0x01);

4461 
	`pci_wr™e_cÚfig_by‹
(

->
pci_dev
, 
PCI_LATENCY_TIMER
, 0x40);

4463 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
)

4464 
	`pci_wr™e_cÚfig_by‹
(

->
pci_dev
, 
PCI_CACHE_LINE_SIZE
, 0x08);

4466 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
) {

4467 
	`d´štk
("Set MAC Reg C+CR Offset 0x82h = 0x01h\n");

4468 
	`RTL_W8
(0x82, 0x01);

4469 
	`d´štk
("Set PHY Reg 0x0bh = 0x00h\n");

4470 
	`¹l_wr™•hy
(

, 0x0b, 0x0000);

4473 
	`¹l8169_phy_»£t
(
dev
, 

);

4475 
	`¹l8169_£t_¥“d
(
dev
, 
AUTONEG_ENABLE
, 
SPEED_1000
, 
DUPLEX_FULL
,

4476 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4477 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
 |

4478 (

->
mii
.
suµÜts_gmii
 ?

4479 
ADVERTISED_1000ba£T_H®f
 |

4480 
ADVERTISED_1000ba£T_FuÎ
 : 0));

4482 ià(
	`¹l_tbi_’abËd
(

))

4483 
	`Ãtif_šfo
(

, 
lšk
, 
dev
, "TBI‡uto-negotiating\n");

4484 
	}
}

4486 
	$¹l_¿r_£t
(
¹l8169_´iv©e
 *

, 
u8
 *
addr
)

4488 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4490 
	`¹l_lock_wÜk
(

);

4492 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

4494 
	`RTL_W32
(
MAC4
, 
addr
[4] |‡ddr[5] << 8);

4495 
	`RTL_R32
(
MAC4
);

4497 
	`RTL_W32
(
MAC0
, 
addr
[0] |‡ddr[1] << 8 |‡ddr[2] << 16 |‡ddr[3] << 24);

4498 
	`RTL_R32
(
MAC0
);

4500 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
)

4501 
	`¹l_¿r_exgmac_£t
(

, 
addr
);

4503 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

4505 
	`¹l_uÆock_wÜk
(

);

4506 
	}
}

4508 
	$¹l_£t_mac_add»ss
(
Ãt_deviû
 *
dev
, *
p
)

4510 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4511 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

4512 
sockaddr
 *
addr
 = 
p
;

4514 ià(!
	`is_v®id_‘h”_addr
(
addr
->
§_d©a
))

4515  -
EADDRNOTAVAIL
;

4517 
	`memıy
(
dev
->
dev_addr
, 
addr
->
§_d©a
, dev->
addr_Ën
);

4519 
	`pm_ruÁime_g‘_nÜesume
(
d
);

4521 ià(
	`pm_ruÁime_aùive
(
d
))

4522 
	`¹l_¿r_£t
(

, 
dev
->
dev_addr
);

4524 
	`pm_ruÁime_put_noidË
(
d
);

4527 
	}
}

4529 
	$¹l8169_ioùl
(
Ãt_deviû
 *
dev
, 
iäeq
 *
iä
, 
cmd
)

4531 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

4532 
mii_ioùl_d©a
 *
d©a
 = 
	`if_mii
(
iä
);

4534  
	`Ãtif_ruÂšg
(
dev
è? 

->
	`do_ioùl
Ñp, 
d©a
, 
cmd
è: -
ENODEV
;

4535 
	}
}

4537 
	$¹l_xmii_ioùl
(
¹l8169_´iv©e
 *

,

4538 
mii_ioùl_d©a
 *
d©a
, 
cmd
)

4540 
cmd
) {

4541 
SIOCGMIIPHY
:

4542 
d©a
->
phy_id
 = 32;

4545 
SIOCGMIIREG
:

4546 
d©a
->
v®_out
 = 
	`¹l_»adphy
(

, d©a->
»g_num
 & 0x1f);

4549 
SIOCSMIIREG
:

4550 
	`¹l_wr™•hy
(

, 
d©a
->
»g_num
 & 0x1f, d©a->
v®_š
);

4553  -
EOPNOTSUPP
;

4554 
	}
}

4556 
	$¹l_tbi_ioùl
(
¹l8169_´iv©e
 *

, 
mii_ioùl_d©a
 *
d©a
, 
cmd
)

4558  -
EOPNOTSUPP
;

4559 
	}
}

4561 
	$¹l_di§bË_msi
(
pci_dev
 *
pdev
, 
¹l8169_´iv©e
 *

)

4563 ià(

->
ã©u»s
 & 
RTL_FEATURE_MSI
) {

4564 
	`pci_di§bË_msi
(
pdev
);

4565 

->
ã©u»s
 &ğ~
RTL_FEATURE_MSI
;

4567 
	}
}

4569 
	$¹l_š™_mdio_İs
(
¹l8169_´iv©e
 *

)

4571 
mdio_İs
 *
İs
 = &

->mdio_ops;

4573 

->
mac_v”siÚ
) {

4574 
RTL_GIGA_MAC_VER_27
:

4575 
İs
->
wr™e
 = 
r8168dp_1_mdio_wr™e
;

4576 
İs
->
»ad
 = 
r8168dp_1_mdio_»ad
;

4578 
RTL_GIGA_MAC_VER_28
:

4579 
RTL_GIGA_MAC_VER_31
:

4580 
İs
->
wr™e
 = 
r8168dp_2_mdio_wr™e
;

4581 
İs
->
»ad
 = 
r8168dp_2_mdio_»ad
;

4583 
RTL_GIGA_MAC_VER_40
:

4584 
RTL_GIGA_MAC_VER_41
:

4585 
RTL_GIGA_MAC_VER_42
:

4586 
RTL_GIGA_MAC_VER_43
:

4587 
RTL_GIGA_MAC_VER_44
:

4588 
RTL_GIGA_MAC_VER_45
:

4589 
RTL_GIGA_MAC_VER_46
:

4590 
RTL_GIGA_MAC_VER_47
:

4591 
RTL_GIGA_MAC_VER_48
:

4592 
RTL_GIGA_MAC_VER_49
:

4593 
RTL_GIGA_MAC_VER_50
:

4594 
RTL_GIGA_MAC_VER_51
:

4595 
İs
->
wr™e
 = 
r8168g_mdio_wr™e
;

4596 
İs
->
»ad
 = 
r8168g_mdio_»ad
;

4599 
İs
->
wr™e
 = 
r8169_mdio_wr™e
;

4600 
İs
->
»ad
 = 
r8169_mdio_»ad
;

4603 
	}
}

4605 
	$¹l_¥“d_down
(
¹l8169_´iv©e
 *

)

4607 
u32
 
adv
;

4608 
Ía
;

4610 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4611 
Ía
 = 
	`¹l_»adphy
(

, 
MII_LPA
);

4613 ià(
Ía
 & (
LPA_10HALF
 | 
LPA_10FULL
))

4614 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
;

4615 ià(
Ía
 & (
LPA_100HALF
 | 
LPA_100FULL
))

4616 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4617 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
;

4619 
adv
 = 
ADVERTISED_10ba£T_H®f
 | 
ADVERTISED_10ba£T_FuÎ
 |

4620 
ADVERTISED_100ba£T_H®f
 | 
ADVERTISED_100ba£T_FuÎ
 |

4621 (

->
mii
.
suµÜts_gmii
 ?

4622 
ADVERTISED_1000ba£T_H®f
 |

4623 
ADVERTISED_1000ba£T_FuÎ
 : 0);

4625 
	`¹l8169_£t_¥“d
(

->
dev
, 
AUTONEG_ENABLE
, 
SPEED_1000
, 
DUPLEX_FULL
,

4626 
adv
);

4627 
	}
}

4629 
	$¹l_wŞ_su¥’d_quœk
(
¹l8169_´iv©e
 *

)

4631 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4633 

->
mac_v”siÚ
) {

4634 
RTL_GIGA_MAC_VER_25
:

4635 
RTL_GIGA_MAC_VER_26
:

4636 
RTL_GIGA_MAC_VER_29
:

4637 
RTL_GIGA_MAC_VER_30
:

4638 
RTL_GIGA_MAC_VER_32
:

4639 
RTL_GIGA_MAC_VER_33
:

4640 
RTL_GIGA_MAC_VER_34
:

4641 
RTL_GIGA_MAC_VER_37
:

4642 
RTL_GIGA_MAC_VER_38
:

4643 
RTL_GIGA_MAC_VER_39
:

4644 
RTL_GIGA_MAC_VER_40
:

4645 
RTL_GIGA_MAC_VER_41
:

4646 
RTL_GIGA_MAC_VER_42
:

4647 
RTL_GIGA_MAC_VER_43
:

4648 
RTL_GIGA_MAC_VER_44
:

4649 
RTL_GIGA_MAC_VER_45
:

4650 
RTL_GIGA_MAC_VER_46
:

4651 
RTL_GIGA_MAC_VER_47
:

4652 
RTL_GIGA_MAC_VER_48
:

4653 
RTL_GIGA_MAC_VER_49
:

4654 
RTL_GIGA_MAC_VER_50
:

4655 
RTL_GIGA_MAC_VER_51
:

4656 
	`RTL_W32
(
RxCÚfig
, 
	`RTL_R32
(RxConfig) |

4657 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
);

4662 
	}
}

4664 
boŞ
 
	$¹l_wŞ_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4666 ià(!(
	`__¹l8169_g‘_wŞ
(

è& 
WAKE_ANY
))

4667  
çl£
;

4669 
	`¹l_¥“d_down
(

);

4670 
	`¹l_wŞ_su¥’d_quœk
(

);

4672  
Œue
;

4673 
	}
}

4675 
	$r810x_phy_pow”_down
(
¹l8169_´iv©e
 *

)

4677 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4678 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_PDOWN
);

4679 
	}
}

4681 
	$r810x_phy_pow”_up
(
¹l8169_´iv©e
 *

)

4683 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4684 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
);

4685 
	}
}

4687 
	$r810x_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4689 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4691 ià(
	`¹l_wŞ_¶l_pow”_down
(

))

4694 
	`r810x_phy_pow”_down
(

);

4696 

->
mac_v”siÚ
) {

4697 
RTL_GIGA_MAC_VER_07
:

4698 
RTL_GIGA_MAC_VER_08
:

4699 
RTL_GIGA_MAC_VER_09
:

4700 
RTL_GIGA_MAC_VER_10
:

4701 
RTL_GIGA_MAC_VER_13
:

4702 
RTL_GIGA_MAC_VER_16
:

4705 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) & ~0x80);

4708 
	}
}

4710 
	$r810x_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4712 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4714 
	`r810x_phy_pow”_up
(

);

4716 

->
mac_v”siÚ
) {

4717 
RTL_GIGA_MAC_VER_07
:

4718 
RTL_GIGA_MAC_VER_08
:

4719 
RTL_GIGA_MAC_VER_09
:

4720 
RTL_GIGA_MAC_VER_10
:

4721 
RTL_GIGA_MAC_VER_13
:

4722 
RTL_GIGA_MAC_VER_16
:

4724 
RTL_GIGA_MAC_VER_47
:

4725 
RTL_GIGA_MAC_VER_48
:

4726 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) | 0xc0);

4729 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) | 0x80);

4732 
	}
}

4734 
	$r8168_phy_pow”_up
(
¹l8169_´iv©e
 *

)

4736 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4737 

->
mac_v”siÚ
) {

4738 
RTL_GIGA_MAC_VER_11
:

4739 
RTL_GIGA_MAC_VER_12
:

4740 
RTL_GIGA_MAC_VER_17
:

4741 
RTL_GIGA_MAC_VER_18
:

4742 
RTL_GIGA_MAC_VER_19
:

4743 
RTL_GIGA_MAC_VER_20
:

4744 
RTL_GIGA_MAC_VER_21
:

4745 
RTL_GIGA_MAC_VER_22
:

4746 
RTL_GIGA_MAC_VER_23
:

4747 
RTL_GIGA_MAC_VER_24
:

4748 
RTL_GIGA_MAC_VER_25
:

4749 
RTL_GIGA_MAC_VER_26
:

4750 
RTL_GIGA_MAC_VER_27
:

4751 
RTL_GIGA_MAC_VER_28
:

4752 
RTL_GIGA_MAC_VER_31
:

4753 
	`¹l_wr™•hy
(

, 0x0e, 0x0000);

4758 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
);

4759 
	}
}

4761 
	$r8168_phy_pow”_down
(
¹l8169_´iv©e
 *

)

4763 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

4764 

->
mac_v”siÚ
) {

4765 
RTL_GIGA_MAC_VER_32
:

4766 
RTL_GIGA_MAC_VER_33
:

4767 
RTL_GIGA_MAC_VER_40
:

4768 
RTL_GIGA_MAC_VER_41
:

4769 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_ANENABLE
 | 
BMCR_PDOWN
);

4772 
RTL_GIGA_MAC_VER_11
:

4773 
RTL_GIGA_MAC_VER_12
:

4774 
RTL_GIGA_MAC_VER_17
:

4775 
RTL_GIGA_MAC_VER_18
:

4776 
RTL_GIGA_MAC_VER_19
:

4777 
RTL_GIGA_MAC_VER_20
:

4778 
RTL_GIGA_MAC_VER_21
:

4779 
RTL_GIGA_MAC_VER_22
:

4780 
RTL_GIGA_MAC_VER_23
:

4781 
RTL_GIGA_MAC_VER_24
:

4782 
RTL_GIGA_MAC_VER_25
:

4783 
RTL_GIGA_MAC_VER_26
:

4784 
RTL_GIGA_MAC_VER_27
:

4785 
RTL_GIGA_MAC_VER_28
:

4786 
RTL_GIGA_MAC_VER_31
:

4787 
	`¹l_wr™•hy
(

, 0x0e, 0x0200);

4789 
	`¹l_wr™•hy
(

, 
MII_BMCR
, 
BMCR_PDOWN
);

4792 
	}
}

4794 
	$r8168_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4796 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4798 ià((

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_27
 ||

4799 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_28
 ||

4800 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
 ||

4801 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

4802 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

4803 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) &&

4804 
	`r8168_check_dash
(

)) {

4808 ià((

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_23
 ||

4809 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_24
) &&

4810 (
	`RTL_R16
(
CPlusCmd
è& 
ASF
)) {

4814 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_32
 ||

4815 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_33
)

4816 
	`¹l_•hy_wr™e
(

, 0x19, 0xff64);

4818 ià(
	`¹l_wŞ_¶l_pow”_down
(

))

4821 
	`r8168_phy_pow”_down
(

);

4823 

->
mac_v”siÚ
) {

4824 
RTL_GIGA_MAC_VER_25
:

4825 
RTL_GIGA_MAC_VER_26
:

4826 
RTL_GIGA_MAC_VER_27
:

4827 
RTL_GIGA_MAC_VER_28
:

4828 
RTL_GIGA_MAC_VER_31
:

4829 
RTL_GIGA_MAC_VER_32
:

4830 
RTL_GIGA_MAC_VER_33
:

4831 
RTL_GIGA_MAC_VER_44
:

4832 
RTL_GIGA_MAC_VER_45
:

4833 
RTL_GIGA_MAC_VER_46
:

4834 
RTL_GIGA_MAC_VER_50
:

4835 
RTL_GIGA_MAC_VER_51
:

4836 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) & ~0x80);

4838 
RTL_GIGA_MAC_VER_40
:

4839 
RTL_GIGA_MAC_VER_41
:

4840 
RTL_GIGA_MAC_VER_49
:

4841 
	`¹l_w0w1_”i
(

, 0x1a8, 
ERIAR_MASK_1111
, 0x00000000,

4842 0xfc000000, 
ERIAR_EXGMAC
);

4843 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) & ~0x80);

4846 
	}
}

4848 
	$r8168_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4850 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4852 

->
mac_v”siÚ
) {

4853 
RTL_GIGA_MAC_VER_25
:

4854 
RTL_GIGA_MAC_VER_26
:

4855 
RTL_GIGA_MAC_VER_27
:

4856 
RTL_GIGA_MAC_VER_28
:

4857 
RTL_GIGA_MAC_VER_31
:

4858 
RTL_GIGA_MAC_VER_32
:

4859 
RTL_GIGA_MAC_VER_33
:

4860 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) | 0x80);

4862 
RTL_GIGA_MAC_VER_44
:

4863 
RTL_GIGA_MAC_VER_45
:

4864 
RTL_GIGA_MAC_VER_46
:

4865 
RTL_GIGA_MAC_VER_50
:

4866 
RTL_GIGA_MAC_VER_51
:

4867 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) | 0xc0);

4869 
RTL_GIGA_MAC_VER_40
:

4870 
RTL_GIGA_MAC_VER_41
:

4871 
RTL_GIGA_MAC_VER_49
:

4872 
	`RTL_W8
(
PMCH
, 
	`RTL_R8
(PMCH) | 0xc0);

4873 
	`¹l_w0w1_”i
(

, 0x1a8, 
ERIAR_MASK_1111
, 0xfc000000,

4874 0x00000000, 
ERIAR_EXGMAC
);

4878 
	`r8168_phy_pow”_up
(

);

4879 
	}
}

4881 
	$¹l_g’”ic_İ
(
¹l8169_´iv©e
 *

,

4882 (*
İ
)(
¹l8169_´iv©e
 *))

4884 ià(
İ
)

4885 
	`İ
(

);

4886 
	}
}

4888 
	$¹l_¶l_pow”_down
(
¹l8169_´iv©e
 *

)

4890 
	`¹l_g’”ic_İ
(

,p->
¶l_pow”_İs
.
down
);

4891 
	}
}

4893 
	$¹l_¶l_pow”_up
(
¹l8169_´iv©e
 *

)

4895 
	`¹l_g’”ic_İ
(

,p->
¶l_pow”_İs
.
up
);

4896 
	}
}

4898 
	$¹l_š™_¶l_pow”_İs
(
¹l8169_´iv©e
 *

)

4900 
¶l_pow”_İs
 *
İs
 = &

->pll_power_ops;

4902 

->
mac_v”siÚ
) {

4903 
RTL_GIGA_MAC_VER_07
:

4904 
RTL_GIGA_MAC_VER_08
:

4905 
RTL_GIGA_MAC_VER_09
:

4906 
RTL_GIGA_MAC_VER_10
:

4907 
RTL_GIGA_MAC_VER_16
:

4908 
RTL_GIGA_MAC_VER_29
:

4909 
RTL_GIGA_MAC_VER_30
:

4910 
RTL_GIGA_MAC_VER_37
:

4911 
RTL_GIGA_MAC_VER_39
:

4912 
RTL_GIGA_MAC_VER_43
:

4913 
RTL_GIGA_MAC_VER_47
:

4914 
RTL_GIGA_MAC_VER_48
:

4915 
İs
->
down
 = 
r810x_¶l_pow”_down
;

4916 
İs
->
up
 = 
r810x_¶l_pow”_up
;

4919 
RTL_GIGA_MAC_VER_11
:

4920 
RTL_GIGA_MAC_VER_12
:

4921 
RTL_GIGA_MAC_VER_17
:

4922 
RTL_GIGA_MAC_VER_18
:

4923 
RTL_GIGA_MAC_VER_19
:

4924 
RTL_GIGA_MAC_VER_20
:

4925 
RTL_GIGA_MAC_VER_21
:

4926 
RTL_GIGA_MAC_VER_22
:

4927 
RTL_GIGA_MAC_VER_23
:

4928 
RTL_GIGA_MAC_VER_24
:

4929 
RTL_GIGA_MAC_VER_25
:

4930 
RTL_GIGA_MAC_VER_26
:

4931 
RTL_GIGA_MAC_VER_27
:

4932 
RTL_GIGA_MAC_VER_28
:

4933 
RTL_GIGA_MAC_VER_31
:

4934 
RTL_GIGA_MAC_VER_32
:

4935 
RTL_GIGA_MAC_VER_33
:

4936 
RTL_GIGA_MAC_VER_34
:

4937 
RTL_GIGA_MAC_VER_35
:

4938 
RTL_GIGA_MAC_VER_36
:

4939 
RTL_GIGA_MAC_VER_38
:

4940 
RTL_GIGA_MAC_VER_40
:

4941 
RTL_GIGA_MAC_VER_41
:

4942 
RTL_GIGA_MAC_VER_42
:

4943 
RTL_GIGA_MAC_VER_44
:

4944 
RTL_GIGA_MAC_VER_45
:

4945 
RTL_GIGA_MAC_VER_46
:

4946 
RTL_GIGA_MAC_VER_49
:

4947 
RTL_GIGA_MAC_VER_50
:

4948 
RTL_GIGA_MAC_VER_51
:

4949 
İs
->
down
 = 
r8168_¶l_pow”_down
;

4950 
İs
->
up
 = 
r8168_¶l_pow”_up
;

4954 
İs
->
down
 = 
NULL
;

4955 
İs
->
up
 = 
NULL
;

4958 
	}
}

4960 
	$¹l_š™_rxcfg
(
¹l8169_´iv©e
 *

)

4962 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

4964 

->
mac_v”siÚ
) {

4965 
RTL_GIGA_MAC_VER_01
:

4966 
RTL_GIGA_MAC_VER_02
:

4967 
RTL_GIGA_MAC_VER_03
:

4968 
RTL_GIGA_MAC_VER_04
:

4969 
RTL_GIGA_MAC_VER_05
:

4970 
RTL_GIGA_MAC_VER_06
:

4971 
RTL_GIGA_MAC_VER_10
:

4972 
RTL_GIGA_MAC_VER_11
:

4973 
RTL_GIGA_MAC_VER_12
:

4974 
RTL_GIGA_MAC_VER_13
:

4975 
RTL_GIGA_MAC_VER_14
:

4976 
RTL_GIGA_MAC_VER_15
:

4977 
RTL_GIGA_MAC_VER_16
:

4978 
RTL_GIGA_MAC_VER_17
:

4979 
	`RTL_W32
(
RxCÚfig
, 
RX_FIFO_THRESH
 | 
RX_DMA_BURST
);

4981 
RTL_GIGA_MAC_VER_18
:

4982 
RTL_GIGA_MAC_VER_19
:

4983 
RTL_GIGA_MAC_VER_20
:

4984 
RTL_GIGA_MAC_VER_21
:

4985 
RTL_GIGA_MAC_VER_22
:

4986 
RTL_GIGA_MAC_VER_23
:

4987 
RTL_GIGA_MAC_VER_24
:

4988 
RTL_GIGA_MAC_VER_34
:

4989 
RTL_GIGA_MAC_VER_35
:

4990 
	`RTL_W32
(
RxCÚfig
, 
RX128_INT_EN
 | 
RX_MULTI_EN
 | 
RX_DMA_BURST
);

4992 
RTL_GIGA_MAC_VER_40
:

4993 
RTL_GIGA_MAC_VER_41
:

4994 
RTL_GIGA_MAC_VER_42
:

4995 
RTL_GIGA_MAC_VER_43
:

4996 
RTL_GIGA_MAC_VER_44
:

4997 
RTL_GIGA_MAC_VER_45
:

4998 
RTL_GIGA_MAC_VER_46
:

4999 
RTL_GIGA_MAC_VER_47
:

5000 
RTL_GIGA_MAC_VER_48
:

5001 
RTL_GIGA_MAC_VER_49
:

5002 
RTL_GIGA_MAC_VER_50
:

5003 
RTL_GIGA_MAC_VER_51
:

5004 
	`RTL_W32
(
RxCÚfig
, 
RX128_INT_EN
 | 
RX_MULTI_EN
 | 
RX_DMA_BURST
 | 
RX_EARLY_OFF
);

5007 
	`RTL_W32
(
RxCÚfig
, 
RX128_INT_EN
 | 
RX_DMA_BURST
);

5010 
	}
}

5012 
	$¹l8169_š™_ršg_šdexes
(
¹l8169_´iv©e
 *

)

5014 

->
dœty_tx
 =p->
cur_tx
 =p->
cur_rx
 = 0;

5015 
	}
}

5017 
	$¹l_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5019 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5021 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

5022 
	`¹l_g’”ic_İ
(

,p->
jumbo_İs
.
’abË
);

5023 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

5024 
	}
}

5026 
	$¹l_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5028 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5030 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

5031 
	`¹l_g’”ic_İ
(

,p->
jumbo_İs
.
di§bË
);

5032 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

5033 
	}
}

5035 
	$r8168c_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5037 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5039 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è| 
Jumbo_En0
);

5040 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(CÚfig4è| 
Jumbo_En1
);

5041 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
, 
PCI_EXP_DEVCTL_READRQ_512B
);

5042 
	}
}

5044 
	$r8168c_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5046 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5048 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
Jumbo_En0
);

5049 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(CÚfig4è& ~
Jumbo_En1
);

5050 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5051 
	}
}

5053 
	$r8168dp_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5055 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5057 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è| 
Jumbo_En0
);

5058 
	}
}

5060 
	$r8168dp_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5062 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5064 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
Jumbo_En0
);

5065 
	}
}

5067 
	$r8168e_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5069 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5071 
	`RTL_W8
(
MaxTxPack‘Size
, 0x3f);

5072 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è| 
Jumbo_En0
);

5073 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(Config4) | 0x01);

5074 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
, 
PCI_EXP_DEVCTL_READRQ_512B
);

5075 
	}
}

5077 
	$r8168e_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5079 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5081 
	`RTL_W8
(
MaxTxPack‘Size
, 0x0c);

5082 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
Jumbo_En0
);

5083 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(Config4) & ~0x01);

5084 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5085 
	}
}

5087 
	$r8168b_0_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5089 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
,

5090 
PCI_EXP_DEVCTL_READRQ_512B
 | 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5091 
	}
}

5093 
	$r8168b_0_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5095 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
,

5096 (0x5 << 
MAX_READ_REQUEST_SHIFT
è| 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5097 
	}
}

5099 
	$r8168b_1_hw_jumbo_’abË
(
¹l8169_´iv©e
 *

)

5101 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5103 
	`r8168b_0_hw_jumbo_’abË
(

);

5105 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(Config4) | (1 << 0));

5106 
	}
}

5108 
	$r8168b_1_hw_jumbo_di§bË
(
¹l8169_´iv©e
 *

)

5110 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5112 
	`r8168b_0_hw_jumbo_di§bË
(

);

5114 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(Config4) & ~(1 << 0));

5115 
	}
}

5117 
	$¹l_š™_jumbo_İs
(
¹l8169_´iv©e
 *

)

5119 
jumbo_İs
 *
İs
 = &

->jumbo_ops;

5121 

->
mac_v”siÚ
) {

5122 
RTL_GIGA_MAC_VER_11
:

5123 
İs
->
di§bË
 = 
r8168b_0_hw_jumbo_di§bË
;

5124 
İs
->
’abË
 = 
r8168b_0_hw_jumbo_’abË
;

5126 
RTL_GIGA_MAC_VER_12
:

5127 
RTL_GIGA_MAC_VER_17
:

5128 
İs
->
di§bË
 = 
r8168b_1_hw_jumbo_di§bË
;

5129 
İs
->
’abË
 = 
r8168b_1_hw_jumbo_’abË
;

5131 
RTL_GIGA_MAC_VER_18
:

5132 
RTL_GIGA_MAC_VER_19
:

5133 
RTL_GIGA_MAC_VER_20
:

5134 
RTL_GIGA_MAC_VER_21
:

5135 
RTL_GIGA_MAC_VER_22
:

5136 
RTL_GIGA_MAC_VER_23
:

5137 
RTL_GIGA_MAC_VER_24
:

5138 
RTL_GIGA_MAC_VER_25
:

5139 
RTL_GIGA_MAC_VER_26
:

5140 
İs
->
di§bË
 = 
r8168c_hw_jumbo_di§bË
;

5141 
İs
->
’abË
 = 
r8168c_hw_jumbo_’abË
;

5143 
RTL_GIGA_MAC_VER_27
:

5144 
RTL_GIGA_MAC_VER_28
:

5145 
İs
->
di§bË
 = 
r8168dp_hw_jumbo_di§bË
;

5146 
İs
->
’abË
 = 
r8168dp_hw_jumbo_’abË
;

5148 
RTL_GIGA_MAC_VER_31
:

5149 
RTL_GIGA_MAC_VER_32
:

5150 
RTL_GIGA_MAC_VER_33
:

5151 
RTL_GIGA_MAC_VER_34
:

5152 
İs
->
di§bË
 = 
r8168e_hw_jumbo_di§bË
;

5153 
İs
->
’abË
 = 
r8168e_hw_jumbo_’abË
;

5160 
RTL_GIGA_MAC_VER_40
:

5161 
RTL_GIGA_MAC_VER_41
:

5162 
RTL_GIGA_MAC_VER_42
:

5163 
RTL_GIGA_MAC_VER_43
:

5164 
RTL_GIGA_MAC_VER_44
:

5165 
RTL_GIGA_MAC_VER_45
:

5166 
RTL_GIGA_MAC_VER_46
:

5167 
RTL_GIGA_MAC_VER_47
:

5168 
RTL_GIGA_MAC_VER_48
:

5169 
RTL_GIGA_MAC_VER_49
:

5170 
RTL_GIGA_MAC_VER_50
:

5171 
RTL_GIGA_MAC_VER_51
:

5173 
İs
->
di§bË
 = 
NULL
;

5174 
İs
->
’abË
 = 
NULL
;

5177 
	}
}

5179 
	$DECLARE_RTL_COND
(
¹l_chcmd_cÚd
)

5181 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5183  
	`RTL_R8
(
ChCmd
è& 
CmdRe£t
;

5184 
	}
}

5186 
	$¹l_hw_»£t
(
¹l8169_´iv©e
 *

)

5188 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5190 
	`RTL_W8
(
ChCmd
, 
CmdRe£t
);

5192 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_chcmd_cÚd
, 100, 100);

5193 
	}
}

5195 
	$¹l_»que¡_unÿched_fœmw¬e
(
¹l8169_´iv©e
 *

)

5197 
¹l_fw
 *rtl_fw;

5198 cÚ¡ *
Çme
;

5199 
rc
 = -
ENOMEM
;

5201 
Çme
 = 
	`¹l_lookup_fœmw¬e_Çme
(

);

5202 ià(!
Çme
)

5203 
out_no_fœmw¬e
;

5205 
¹l_fw
 = 
	`kz®loc
((*¹l_fw), 
GFP_KERNEL
);

5206 ià(!
¹l_fw
)

5207 
”r_w¬n
;

5209 
rc
 = 
	`»que¡_fœmw¬e
(&
¹l_fw
->
fw
, 
Çme
, &

->
pci_dev
->
dev
);

5210 ià(
rc
 < 0)

5211 
”r_ä“
;

5213 
rc
 = 
	`¹l_check_fœmw¬e
(

, 
¹l_fw
);

5214 ià(
rc
 < 0)

5215 
”r_»Ëa£_fœmw¬e
;

5217 

->
¹l_fw
 =„tl_fw;

5218 
out
:

5221 
”r_»Ëa£_fœmw¬e
:

5222 
	`»Ëa£_fœmw¬e
(
¹l_fw
->
fw
);

5223 
”r_ä“
:

5224 
	`kä“
(
¹l_fw
);

5225 
”r_w¬n
:

5226 
	`Ãtif_w¬n
(

, 
ifup
,p->
dev
, "unableo†oad firmware…atch %s (%d)\n",

5227 
Çme
, 
rc
);

5228 
out_no_fœmw¬e
:

5229 

->
¹l_fw
 = 
NULL
;

5230 
out
;

5231 
	}
}

5233 
	$¹l_»que¡_fœmw¬e
(
¹l8169_´iv©e
 *

)

5235 ià(
	`IS_ERR
(

->
¹l_fw
))

5236 
	`¹l_»que¡_unÿched_fœmw¬e
(

);

5237 
	}
}

5239 
	$¹l_rx_şo£
(
¹l8169_´iv©e
 *

)

5241 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5243 
	`RTL_W32
(
RxCÚfig
, 
	`RTL_R32
(RxCÚfigè& ~
RX_CONFIG_ACCEPT_MASK
);

5244 
	}
}

5246 
	$DECLARE_RTL_COND
(
¹l_Åq_cÚd
)

5248 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5250  
	`RTL_R8
(
TxPŞl
è& 
NPQ
;

5251 
	}
}

5253 
	$DECLARE_RTL_COND
(
¹l_txcfg_em±y_cÚd
)

5255 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5257  
	`RTL_R32
(
TxCÚfig
è& 
TXCFG_EMPTY
;

5258 
	}
}

5260 
	$¹l8169_hw_»£t
(
¹l8169_´iv©e
 *

)

5262 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5265 
	`¹l8169_œq_mask_ªd_ack
(

);

5267 
	`¹l_rx_şo£
(

);

5269 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_27
 ||

5270 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_28
 ||

5271 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
) {

5272 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_Åq_cÚd
, 20, 42*42);

5273 } ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
 ||

5274 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

5275 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
 ||

5276 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
 ||

5277 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
 ||

5278 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_40
 ||

5279 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_41
 ||

5280 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
 ||

5281 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_43
 ||

5282 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_44
 ||

5283 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
 ||

5284 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
 ||

5285 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_47
 ||

5286 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_48
 ||

5287 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

5288 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

5289 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) {

5290 
	`RTL_W8
(
ChCmd
, 
	`RTL_R8
(ChCmdè| 
StİReq
);

5291 
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_txcfg_em±y_cÚd
, 100, 666);

5293 
	`RTL_W8
(
ChCmd
, 
	`RTL_R8
(ChCmdè| 
StİReq
);

5294 
	`ud–ay
(100);

5297 
	`¹l_hw_»£t
(

);

5298 
	}
}

5300 
	$¹l_£t_rx_tx_cÚfig_»gi¡”s
(
¹l8169_´iv©e
 *

)

5302 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5305 
	`RTL_W32
(
TxCÚfig
, (
TX_DMA_BURST
 << 
TxDMAShiá
) |

5306 (
IÁ”F¿meG­
 << 
TxIÁ”F¿meG­Shiá
));

5307 
	}
}

5309 
	$¹l_hw_¡¬t
(
Ãt_deviû
 *
dev
)

5311 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5313 

->
	`hw_¡¬t
(
dev
);

5315 
	`¹l_œq_’abË_®l
(

);

5316 
	}
}

5318 
	$¹l_£t_rx_tx_desc_»gi¡”s
(
¹l8169_´iv©e
 *

,

5319 
__iomem
 *
ißddr
)

5326 
	`RTL_W32
(
TxDescS¹AddrHigh
, ((
u64
è

->
TxPhyAddr
) >> 32);

5327 
	`RTL_W32
(
TxDescS¹AddrLow
, ((
u64
è

->
TxPhyAddr
è& 
	`DMA_BIT_MASK
(32));

5328 
	`RTL_W32
(
RxDescAddrHigh
, ((
u64
è

->
RxPhyAddr
) >> 32);

5329 
	`RTL_W32
(
RxDescAddrLow
, ((
u64
è

->
RxPhyAddr
è& 
	`DMA_BIT_MASK
(32));

5330 
	}
}

5332 
u16
 
	$¹l_rw_ıluscmd
(
__iomem
 *
ißddr
)

5334 
u16
 
cmd
;

5336 
cmd
 = 
	`RTL_R16
(
CPlusCmd
);

5337 
	`RTL_W16
(
CPlusCmd
, 
cmd
);

5338  
cmd
;

5339 
	}
}

5341 
	$¹l_£t_rx_max_size
(
__iomem
 *
ißddr
, 
rx_buf_sz
)

5344 
	`RTL_W16
(
RxMaxSize
, 
rx_buf_sz
 + 1);

5345 
	}
}

5347 
	$¹l8169_£t_magic_»g
(
__iomem
 *
ißddr
, 
mac_v”siÚ
)

5349 cÚ¡ 
	s¹l_cfg2_šfo
 {

5350 
u32
 
mac_v”siÚ
;

5351 
u32
 
şk
;

5352 
u32
 
v®
;

5353 } 
cfg2_šfo
 [] = {

5354 { 
RTL_GIGA_MAC_VER_05
, 
PCI_Clock_33MHz
, 0x000fff00 },

5355 { 
RTL_GIGA_MAC_VER_05
, 
PCI_Clock_66MHz
, 0x000fffff },

5356 { 
RTL_GIGA_MAC_VER_06
, 
PCI_Clock_33MHz
, 0x00ffff00 },

5357 { 
RTL_GIGA_MAC_VER_06
, 
PCI_Clock_66MHz
, 0x00ffffff }

5359 cÚ¡ 
¹l_cfg2_šfo
 *
p
 = 
cfg2_šfo
;

5360 
i
;

5361 
u32
 
şk
;

5363 
şk
 = 
	`RTL_R8
(
CÚfig2
è& 
PCI_Clock_66MHz
;

5364 
i
 = 0; i < 
	`ARRAY_SIZE
(
cfg2_šfo
); i++, 
p
++) {

5365 ià((
p
->
mac_v”siÚ
 =ğmac_v”siÚè&& (p->
şk
 == clk)) {

5366 
	`RTL_W32
(0x7c, 
p
->
v®
);

5370 
	}
}

5372 
	$¹l_£t_rx_mode
(
Ãt_deviû
 *
dev
)

5374 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5375 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5376 
u32
 
mc_f‹r
[2];

5377 
rx_mode
;

5378 
u32
 
tmp
 = 0;

5380 ià(
dev
->
æags
 & 
IFF_PROMISC
) {

5382 
	`Ãtif_nÙiû
(

, 
lšk
, 
dev
, "Promiscuous modeƒnabled\n");

5383 
rx_mode
 =

5384 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
 |

5385 
Acû±AÎPhys
;

5386 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5387 } ià((
	`Ãtdev_mc_couÁ
(
dev
è> 
muÉiÿ¡_f‹r_lim™
) ||

5388 (
dev
->
æags
 & 
IFF_ALLMULTI
)) {

5390 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MuÉiÿ¡
 | 
Acû±MyPhys
;

5391 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5393 
Ãtdev_hw_addr
 *
ha
;

5395 
rx_mode
 = 
Acû±Brßdÿ¡
 | 
Acû±MyPhys
;

5396 
mc_f‹r
[1] = mc_filter[0] = 0;

5397 
	`Ãtdev_fÜ_—ch_mc_addr
(
ha
, 
dev
) {

5398 
b™_Ä
 = 
	`‘h”_üc
(
ETH_ALEN
, 
ha
->
addr
) >> 26;

5399 
mc_f‹r
[
b™_Ä
 >> 5] |= 1 << (bit_nr & 31);

5400 
rx_mode
 |ğ
Acû±MuÉiÿ¡
;

5404 ià(
dev
->
ã©u»s
 & 
NETIF_F_RXALL
)

5405 
rx_mode
 |ğ(
Acû±E¼
 | 
Acû±RuÁ
);

5407 
tmp
 = (
	`RTL_R32
(
RxCÚfig
è& ~
RX_CONFIG_ACCEPT_MASK
è| 
rx_mode
;

5409 ià(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_06
) {

5410 
u32
 
d©a
 = 
mc_f‹r
[0];

5412 
mc_f‹r
[0] = 
	`swab32
(mc_filter[1]);

5413 
mc_f‹r
[1] = 
	`swab32
(
d©a
);

5416 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
)

5417 
mc_f‹r
[1] = mc_filter[0] = 0xffffffff;

5419 
	`RTL_W32
(
MAR0
 + 4, 
mc_f‹r
[1]);

5420 
	`RTL_W32
(
MAR0
 + 0, 
mc_f‹r
[0]);

5422 
	`RTL_W32
(
RxCÚfig
, 
tmp
);

5423 
	}
}

5425 
	$¹l_hw_¡¬t_8169
(
Ãt_deviû
 *
dev
)

5427 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

5428 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5429 
pci_dev
 *
pdev
 = 

->pci_dev;

5431 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_05
) {

5432 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè| 
PCIMulRW
);

5433 
	`pci_wr™e_cÚfig_by‹
(
pdev
, 
PCI_CACHE_LINE_SIZE
, 0x08);

5436 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

5437 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
 ||

5438 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5439 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
 ||

5440 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_04
)

5441 
	`RTL_W8
(
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

5443 
	`¹l_š™_rxcfg
(

);

5445 
	`RTL_W8
(
E¬lyTxTh»s
, 
NoE¬lyTx
);

5447 
	`¹l_£t_rx_max_size
(
ißddr
, 
rx_buf_sz
);

5449 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_01
 ||

5450 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5451 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
 ||

5452 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_04
)

5453 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

5455 

->
ı_cmd
 |ğ
	`¹l_rw_ıluscmd
(
ißddr
è| 
PCIMulRW
;

5457 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_02
 ||

5458 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_03
) {

5459 
	`d´štk
("Set MAC Reg C+CR Offset 0xe0. "

5461 

->
ı_cmd
 |= (1 << 14);

5464 
	`RTL_W16
(
CPlusCmd
, 

->
ı_cmd
);

5466 
	`¹l8169_£t_magic_»g
(
ißddr
, 

->
mac_v”siÚ
);

5472 
	`RTL_W16
(
IÁrM™ig©e
, 0x0000);

5474 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

, 
ißddr
);

5476 ià(

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_01
 &&

5477 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_02
 &&

5478 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_03
 &&

5479 

->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_04
) {

5480 
	`RTL_W8
(
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

5481 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

5484 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

5487 
	`RTL_R8
(
IÁrMask
);

5489 
	`RTL_W32
(
RxMis£d
, 0);

5491 
	`¹l_£t_rx_mode
(
dev
);

5494 
	`RTL_W16
(
MuÉiIÁr
, 
	`RTL_R16
(MultiIntr) & 0xf000);

5495 
	}
}

5497 
	$¹l_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5499 ià(

->
csi_İs
.
wr™e
)

5500 

->
csi_İs
.
	`wr™e
Ñp, 
addr
, 
v®ue
);

5501 
	}
}

5503 
u32
 
	$¹l_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5505  

->
csi_İs
.
»ad
 ?p->csi_İs.
	`»ad
Ñp, 
addr
) : ~0;

5506 
	}
}

5508 
	$¹l_csi_acûss_’abË
(
¹l8169_´iv©e
 *

, 
u32
 
b™s
)

5510 
u32
 
csi
;

5512 
csi
 = 
	`¹l_csi_»ad
(

, 0x070c) & 0x00ffffff;

5513 
	`¹l_csi_wr™e
(

, 0x070c, 
csi
 | 
b™s
);

5514 
	}
}

5516 
	$¹l_csi_acûss_’abË_1
(
¹l8169_´iv©e
 *

)

5518 
	`¹l_csi_acûss_’abË
(

, 0x17000000);

5519 
	}
}

5521 
	$¹l_csi_acûss_’abË_2
(
¹l8169_´iv©e
 *

)

5523 
	`¹l_csi_acûss_’abË
(

, 0x27000000);

5524 
	}
}

5526 
	$DECLARE_RTL_COND
(
¹l_csŸr_cÚd
)

5528 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5530  
	`RTL_R32
(
CSIAR
è& 
CSIAR_FLAG
;

5531 
	}
}

5533 
	$r8169_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5535 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5537 
	`RTL_W32
(
CSIDR
, 
v®ue
);

5538 
	`RTL_W32
(
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5539 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5541 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5542 
	}
}

5544 
u32
 
	$r8169_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5546 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5548 
	`RTL_W32
(
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
) |

5549 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5551  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5552 
	`RTL_R32
(
CSIDR
) : ~0;

5553 
	}
}

5555 
	$r8402_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5557 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5559 
	`RTL_W32
(
CSIDR
, 
v®ue
);

5560 
	`RTL_W32
(
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5561 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
 |

5562 
CSIAR_FUNC_NIC
);

5564 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5565 
	}
}

5567 
u32
 
	$r8402_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5569 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5571 
	`RTL_W32
(
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
è| 
CSIAR_FUNC_NIC
 |

5572 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5574  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5575 
	`RTL_R32
(
CSIDR
) : ~0;

5576 
	}
}

5578 
	$r8411_csi_wr™e
(
¹l8169_´iv©e
 *

, 
addr
, 
v®ue
)

5580 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5582 
	`RTL_W32
(
CSIDR
, 
v®ue
);

5583 
	`RTL_W32
(
CSIAR
, 
CSIAR_WRITE_CMD
 | (
addr
 & 
CSIAR_ADDR_MASK
) |

5584 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
 |

5585 
CSIAR_FUNC_NIC2
);

5587 
	`¹l_ud–ay_loİ_wa™_low
(

, &
¹l_csŸr_cÚd
, 10, 100);

5588 
	}
}

5590 
u32
 
	$r8411_csi_»ad
(
¹l8169_´iv©e
 *

, 
addr
)

5592 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5594 
	`RTL_W32
(
CSIAR
, (
addr
 & 
CSIAR_ADDR_MASK
è| 
CSIAR_FUNC_NIC2
 |

5595 
CSIAR_BYTE_ENABLE
 << 
CSIAR_BYTE_ENABLE_SHIFT
);

5597  
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_csŸr_cÚd
, 10, 100) ?

5598 
	`RTL_R32
(
CSIDR
) : ~0;

5599 
	}
}

5601 
	$¹l_š™_csi_İs
(
¹l8169_´iv©e
 *

)

5603 
csi_İs
 *
İs
 = &

->csi_ops;

5605 

->
mac_v”siÚ
) {

5606 
RTL_GIGA_MAC_VER_01
:

5607 
RTL_GIGA_MAC_VER_02
:

5608 
RTL_GIGA_MAC_VER_03
:

5609 
RTL_GIGA_MAC_VER_04
:

5610 
RTL_GIGA_MAC_VER_05
:

5611 
RTL_GIGA_MAC_VER_06
:

5612 
RTL_GIGA_MAC_VER_10
:

5613 
RTL_GIGA_MAC_VER_11
:

5614 
RTL_GIGA_MAC_VER_12
:

5615 
RTL_GIGA_MAC_VER_13
:

5616 
RTL_GIGA_MAC_VER_14
:

5617 
RTL_GIGA_MAC_VER_15
:

5618 
RTL_GIGA_MAC_VER_16
:

5619 
RTL_GIGA_MAC_VER_17
:

5620 
İs
->
wr™e
 = 
NULL
;

5621 
İs
->
»ad
 = 
NULL
;

5624 
RTL_GIGA_MAC_VER_37
:

5625 
RTL_GIGA_MAC_VER_38
:

5626 
İs
->
wr™e
 = 
r8402_csi_wr™e
;

5627 
İs
->
»ad
 = 
r8402_csi_»ad
;

5630 
RTL_GIGA_MAC_VER_44
:

5631 
İs
->
wr™e
 = 
r8411_csi_wr™e
;

5632 
İs
->
»ad
 = 
r8411_csi_»ad
;

5636 
İs
->
wr™e
 = 
r8169_csi_wr™e
;

5637 
İs
->
»ad
 = 
r8169_csi_»ad
;

5640 
	}
}

5642 
	s•hy_šfo
 {

5643 
	moff£t
;

5644 
u16
 
	mmask
;

5645 
u16
 
	mb™s
;

5648 
	$¹l_•hy_š™
(
¹l8169_´iv©e
 *

, cÚ¡ 
•hy_šfo
 *
e
,

5649 
Ën
)

5651 
u16
 
w
;

5653 
Ën
-- > 0) {

5654 
w
 = (
	`¹l_•hy_»ad
(

, 
e
->
off£t
è& ~e->
mask
è|ƒ->
b™s
;

5655 
	`¹l_•hy_wr™e
(

, 
e
->
off£t
, 
w
);

5656 
e
++;

5658 
	}
}

5660 
	$¹l_di§bË_şock_»que¡
(
pci_dev
 *
pdev
)

5662 
	`pc›_ÿ·b™y_ş—r_wÜd
(
pdev
, 
PCI_EXP_LNKCTL
,

5663 
PCI_EXP_LNKCTL_CLKREQ_EN
);

5664 
	}
}

5666 
	$¹l_’abË_şock_»que¡
(
pci_dev
 *
pdev
)

5668 
	`pc›_ÿ·b™y_£t_wÜd
(
pdev
, 
PCI_EXP_LNKCTL
,

5669 
PCI_EXP_LNKCTL_CLKREQ_EN
);

5670 
	}
}

5672 
	$¹l_pc›_¡©e_l2l3_’abË
(
¹l8169_´iv©e
 *

, 
boŞ
 
’abË
)

5674 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5675 
u8
 
d©a
;

5677 
d©a
 = 
	`RTL_R8
(
CÚfig3
);

5679 ià(
’abË
)

5680 
d©a
 |ğ
Rdy_to_L23
;

5682 
d©a
 &ğ~
Rdy_to_L23
;

5684 
	`RTL_W8
(
CÚfig3
, 
d©a
);

5685 
	}
}

5687 
	#R8168_CPCMD_QUIRK_MASK
 (\

5688 
EÇbËBi¡
 | \

5689 
Mac_dbgo_Û
 | \

5690 
FÜû_h®f_dup
 | \

5691 
FÜû_rxæow_’
 | \

5692 
FÜû_txæow_’
 | \

5693 
Cx¶_dbg_£l
 | \

5694 
ASF
 | \

5695 
PktCÁrDi§bË
 | \

5696 
Mac_dbgo_£l
)

	)

5698 
	$¹l_hw_¡¬t_8168bb
(
¹l8169_´iv©e
 *

)

5700 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5701 
pci_dev
 *
pdev
 = 

->pci_dev;

5703 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

5705 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5707 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
) {

5708 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, (0x5 << 
MAX_READ_REQUEST_SHIFT
) |

5709 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

5711 
	}
}

5713 
	$¹l_hw_¡¬t_8168bef
(
¹l8169_´iv©e
 *

)

5715 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5717 
	`¹l_hw_¡¬t_8168bb
(

);

5719 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5721 
	`RTL_W8
(
CÚfig4
, 
	`RTL_R8
(Config4) & ~(1 << 0));

5722 
	}
}

5724 
	$__¹l_hw_¡¬t_8168ı
(
¹l8169_´iv©e
 *

)

5726 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5727 
pci_dev
 *
pdev
 = 

->pci_dev;

5729 
	`RTL_W8
(
CÚfig1
, 
	`RTL_R8
(CÚfig1è| 
S³ed_down
);

5731 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

5733 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5734 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5736 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5738 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5739 
	}
}

5741 
	$¹l_hw_¡¬t_8168ı_1
(
¹l8169_´iv©e
 *

)

5743 cÚ¡ 
•hy_šfo
 
e_šfo_8168ı
[] = {

5751 
	`¹l_csi_acûss_’abË_2
(

);

5753 
	`¹l_•hy_š™
(

, 
e_šfo_8168ı
, 
	`ARRAY_SIZE
(e_info_8168cp));

5755 
	`__¹l_hw_¡¬t_8168ı
(

);

5756 
	}
}

5758 
	$¹l_hw_¡¬t_8168ı_2
(
¹l8169_´iv©e
 *

)

5760 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5761 
pci_dev
 *
pdev
 = 

->pci_dev;

5763 
	`¹l_csi_acûss_’abË_2
(

);

5765 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

5767 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5768 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5770 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5771 
	}
}

5773 
	$¹l_hw_¡¬t_8168ı_3
(
¹l8169_´iv©e
 *

)

5775 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5776 
pci_dev
 *
pdev
 = 

->pci_dev;

5778 
	`¹l_csi_acûss_’abË_2
(

);

5780 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

5783 
	`RTL_W8
(
DBG_REG
, 0x20);

5785 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5787 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5788 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5790 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5791 
	}
}

5793 
	$¹l_hw_¡¬t_8168c_1
(
¹l8169_´iv©e
 *

)

5795 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5796 cÚ¡ 
•hy_šfo
 
e_šfo_8168c_1
[] = {

5802 
	`¹l_csi_acûss_’abË_2
(

);

5804 
	`RTL_W8
(
DBG_REG
, 0x06 | 
FIX_NAK_1
 | 
FIX_NAK_2
);

5806 
	`¹l_•hy_š™
(

, 
e_šfo_8168c_1
, 
	`ARRAY_SIZE
(e_info_8168c_1));

5808 
	`__¹l_hw_¡¬t_8168ı
(

);

5809 
	}
}

5811 
	$¹l_hw_¡¬t_8168c_2
(
¹l8169_´iv©e
 *

)

5813 cÚ¡ 
•hy_šfo
 
e_šfo_8168c_2
[] = {

5818 
	`¹l_csi_acûss_’abË_2
(

);

5820 
	`¹l_•hy_š™
(

, 
e_šfo_8168c_2
, 
	`ARRAY_SIZE
(e_info_8168c_2));

5822 
	`__¹l_hw_¡¬t_8168ı
(

);

5823 
	}
}

5825 
	$¹l_hw_¡¬t_8168c_3
(
¹l8169_´iv©e
 *

)

5827 
	`¹l_hw_¡¬t_8168c_2
(

);

5828 
	}
}

5830 
	$¹l_hw_¡¬t_8168c_4
(
¹l8169_´iv©e
 *

)

5832 
	`¹l_csi_acûss_’abË_2
(

);

5834 
	`__¹l_hw_¡¬t_8168ı
(

);

5835 
	}
}

5837 
	$¹l_hw_¡¬t_8168d
(
¹l8169_´iv©e
 *

)

5839 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5840 
pci_dev
 *
pdev
 = 

->pci_dev;

5842 
	`¹l_csi_acûss_’abË_2
(

);

5844 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5846 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5848 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5849 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5851 
	`RTL_W16
(
CPlusCmd
, 
	`RTL_R16
(CPlusCmdè& ~
R8168_CPCMD_QUIRK_MASK
);

5852 
	}
}

5854 
	$¹l_hw_¡¬t_8168dp
(
¹l8169_´iv©e
 *

)

5856 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5857 
pci_dev
 *
pdev
 = 

->pci_dev;

5859 
	`¹l_csi_acûss_’abË_1
(

);

5861 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5862 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5864 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5866 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5867 
	}
}

5869 
	$¹l_hw_¡¬t_8168d_4
(
¹l8169_´iv©e
 *

)

5871 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5872 
pci_dev
 *
pdev
 = 

->pci_dev;

5873 cÚ¡ 
•hy_šfo
 
e_šfo_8168d_4
[] = {

5879 
	`¹l_csi_acûss_’abË_1
(

);

5881 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5883 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5885 
	`¹l_•hy_š™
(

, 
e_šfo_8168d_4
, 
	`ARRAY_SIZE
(e_info_8168d_4));

5887 
	`¹l_’abË_şock_»que¡
(
pdev
);

5888 
	}
}

5890 
	$¹l_hw_¡¬t_8168e_1
(
¹l8169_´iv©e
 *

)

5892 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5893 
pci_dev
 *
pdev
 = 

->pci_dev;

5894 cÚ¡ 
•hy_šfo
 
e_šfo_8168e_1
[] = {

5910 
	`¹l_csi_acûss_’abË_2
(

);

5912 
	`¹l_•hy_š™
(

, 
e_šfo_8168e_1
, 
	`ARRAY_SIZE
(e_info_8168e_1));

5914 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5915 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5917 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

5919 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5922 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè| 
TXPLA_RST
);

5923 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè& ~
TXPLA_RST
);

5925 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
Spi_’
);

5926 
	}
}

5928 
	$¹l_hw_¡¬t_8168e_2
(
¹l8169_´iv©e
 *

)

5930 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5931 
pci_dev
 *
pdev
 = 

->pci_dev;

5932 cÚ¡ 
•hy_šfo
 
e_šfo_8168e_2
[] = {

5937 
	`¹l_csi_acûss_’abË_1
(

);

5939 
	`¹l_•hy_š™
(

, 
e_šfo_8168e_2
, 
	`ARRAY_SIZE
(e_info_8168e_2));

5941 ià(

->
dev
->
mtu
 <ğ
ETH_DATA_LEN
)

5942 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5944 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5945 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5946 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00100002, 
ERIAR_EXGMAC
);

5947 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

5948 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_1111
, 0x00000050, 
ERIAR_EXGMAC
);

5949 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_1111
, 0x07ff0060, 
ERIAR_EXGMAC
);

5950 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5951 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0xff00, 
ERIAR_EXGMAC
);

5953 
	`RTL_W8
(
MaxTxPack‘Size
, 
E¬lySize
);

5955 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5957 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

5958 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè& ~
NOW_IS_OOB
);

5961 
	`RTL_W8
(
EEE_LED
, 
	`RTL_R8
(EEE_LED) & ~0x07);

5963 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè| 
PFM_EN
);

5964 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè| 
PWM_EN
);

5965 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
Spi_’
);

5966 
	}
}

5968 
	$¹l_hw_¡¬t_8168f
(
¹l8169_´iv©e
 *

)

5970 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

5971 
pci_dev
 *
pdev
 = 

->pci_dev;

5973 
	`¹l_csi_acûss_’abË_2
(

);

5975 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

5977 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5978 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

5979 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00100002, 
ERIAR_EXGMAC
);

5980 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

5981 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

5982 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

5983 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5984 
	`¹l_w0w1_”i
(

, 0x1d0, 
ERIAR_MASK_0001
, 0x10, 0x00, 
ERIAR_EXGMAC
);

5985 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_1111
, 0x00000050, 
ERIAR_EXGMAC
);

5986 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_1111
, 0x00000060, 
ERIAR_EXGMAC
);

5988 
	`RTL_W8
(
MaxTxPack‘Size
, 
E¬lySize
);

5990 
	`¹l_di§bË_şock_»que¡
(
pdev
);

5992 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

5993 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè& ~
NOW_IS_OOB
);

5994 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè| 
PFM_EN
);

5995 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè| 
PWM_EN
);

5996 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
Spi_’
);

5997 
	}
}

5999 
	$¹l_hw_¡¬t_8168f_1
(
¹l8169_´iv©e
 *

)

6001 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6002 cÚ¡ 
•hy_šfo
 
e_šfo_8168f_1
[] = {

6009 
	`¹l_hw_¡¬t_8168f
(

);

6011 
	`¹l_•hy_š™
(

, 
e_šfo_8168f_1
, 
	`ARRAY_SIZE
(e_info_8168f_1));

6013 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0xff00, 
ERIAR_EXGMAC
);

6016 
	`RTL_W8
(
EEE_LED
, 
	`RTL_R8
(EEE_LED) & ~0x07);

6017 
	}
}

6019 
	$¹l_hw_¡¬t_8411
(
¹l8169_´iv©e
 *

)

6021 cÚ¡ 
•hy_šfo
 
e_šfo_8168f_1
[] = {

6028 
	`¹l_hw_¡¬t_8168f
(

);

6029 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6031 
	`¹l_•hy_š™
(

, 
e_šfo_8168f_1
, 
	`ARRAY_SIZE
(e_info_8168f_1));

6033 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0c00, 0x0000, 
ERIAR_EXGMAC
);

6034 
	}
}

6036 
	$¹l_hw_¡¬t_8168g
(
¹l8169_´iv©e
 *

)

6038 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6039 
pci_dev
 *
pdev
 = 

->pci_dev;

6041 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6043 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x080002, 
ERIAR_EXGMAC
);

6044 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x38, 
ERIAR_EXGMAC
);

6045 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x48, 
ERIAR_EXGMAC
);

6046 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6048 
	`¹l_csi_acûss_’abË_1
(

);

6050 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6052 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6053 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6054 
	`¹l_”i_wr™e
(

, 0x2f8, 
ERIAR_MASK_0011
, 0x1d8f, 
ERIAR_EXGMAC
);

6056 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè& ~
RXDV_GATED_EN
);

6057 
	`RTL_W8
(
MaxTxPack‘Size
, 
E¬lySize
);

6059 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6060 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6063 
	`RTL_W8
(
EEE_LED
, 
	`RTL_R8
(EEE_LED) & ~0x07);

6065 
	`¹l_w0w1_”i
(

, 0x2fc, 
ERIAR_MASK_0001
, 0x01, 0x06, 
ERIAR_EXGMAC
);

6066 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 0x1000, 
ERIAR_EXGMAC
);

6068 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6069 
	}
}

6071 
	$¹l_hw_¡¬t_8168g_1
(
¹l8169_´iv©e
 *

)

6073 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6074 cÚ¡ 
•hy_šfo
 
e_šfo_8168g_1
[] = {

6081 
	`¹l_hw_¡¬t_8168g
(

);

6084 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6085 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6086 
	`¹l_•hy_š™
(

, 
e_šfo_8168g_1
, 
	`ARRAY_SIZE
(e_info_8168g_1));

6087 
	}
}

6089 
	$¹l_hw_¡¬t_8168g_2
(
¹l8169_´iv©e
 *

)

6091 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6092 cÚ¡ 
•hy_šfo
 
e_šfo_8168g_2
[] = {

6099 
	`¹l_hw_¡¬t_8168g
(

);

6102 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6103 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6104 
	`¹l_•hy_š™
(

, 
e_šfo_8168g_2
, 
	`ARRAY_SIZE
(e_info_8168g_2));

6105 
	}
}

6107 
	$¹l_hw_¡¬t_8411_2
(
¹l8169_´iv©e
 *

)

6109 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6110 cÚ¡ 
•hy_šfo
 
e_šfo_8411_2
[] = {

6118 
	`¹l_hw_¡¬t_8168g
(

);

6121 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6122 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6123 
	`¹l_•hy_š™
(

, 
e_šfo_8411_2
, 
	`ARRAY_SIZE
(e_info_8411_2));

6124 
	}
}

6126 
	$¹l_hw_¡¬t_8168h_1
(
¹l8169_´iv©e
 *

)

6128 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6129 
pci_dev
 *
pdev
 = 

->pci_dev;

6130 
rg_§w_út
;

6131 
u32
 
d©a
;

6132 cÚ¡ 
•hy_šfo
 
e_šfo_8168h_1
[] = {

6142 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6143 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6144 
	`¹l_•hy_š™
(

, 
e_šfo_8168h_1
, 
	`ARRAY_SIZE
(e_info_8168h_1));

6146 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6148 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x00080002, 
ERIAR_EXGMAC
);

6149 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x38, 
ERIAR_EXGMAC
);

6150 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x48, 
ERIAR_EXGMAC
);

6151 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6153 
	`¹l_csi_acûss_’abË_1
(

);

6155 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6157 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6158 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6160 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_1111
, 0x0010, 0x00, 
ERIAR_EXGMAC
);

6162 
	`¹l_w0w1_”i
(

, 0xd4, 
ERIAR_MASK_1111
, 0x1f00, 0x00, 
ERIAR_EXGMAC
);

6164 
	`¹l_”i_wr™e
(

, 0x5f0, 
ERIAR_MASK_0011
, 0x4f87, 
ERIAR_EXGMAC
);

6166 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè& ~
RXDV_GATED_EN
);

6167 
	`RTL_W8
(
MaxTxPack‘Size
, 
E¬lySize
);

6169 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6170 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6173 
	`RTL_W8
(
EEE_LED
, 
	`RTL_R8
(EEE_LED) & ~0x07);

6175 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
PFM_EN
);

6176 
	`RTL_W8
(
MISC_1
, 
	`RTL_R8
(MISC_1è& ~
PFM_D3COLD_EN
);

6178 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
TX_10M_PS_EN
);

6180 
	`¹l_w0w1_”i
(

, 0x1b0, 
ERIAR_MASK_0011
, 0x0000, 0x1000, 
ERIAR_EXGMAC
);

6182 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6184 
	`¹l_wr™•hy
(

, 0x1f, 0x0c42);

6185 
rg_§w_út
 = (
	`¹l_»adphy
(

, 0x13) & 0x3fff);

6186 
	`¹l_wr™•hy
(

, 0x1f, 0x0000);

6187 ià(
rg_§w_út
 > 0) {

6188 
u16
 
sw_út_1ms_ši
;

6190 
sw_út_1ms_ši
 = 16000000/
rg_§w_út
;

6191 
sw_út_1ms_ši
 &= 0x0fff;

6192 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd412);

6193 
d©a
 &= ~0x0fff;

6194 
d©a
 |ğ
sw_út_1ms_ši
;

6195 
	`r8168_mac_oı_wr™e
(

, 0xd412, 
d©a
);

6198 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe056);

6199 
d©a
 &= ~0xf0;

6200 
d©a
 |= 0x70;

6201 
	`r8168_mac_oı_wr™e
(

, 0xe056, 
d©a
);

6203 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe052);

6204 
d©a
 &= ~0x6000;

6205 
d©a
 |= 0x8008;

6206 
	`r8168_mac_oı_wr™e
(

, 0xe052, 
d©a
);

6208 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe0d6);

6209 
d©a
 &= ~0x01ff;

6210 
d©a
 |= 0x017f;

6211 
	`r8168_mac_oı_wr™e
(

, 0xe0d6, 
d©a
);

6213 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd420);

6214 
d©a
 &= ~0x0fff;

6215 
d©a
 |= 0x047f;

6216 
	`r8168_mac_oı_wr™e
(

, 0xd420, 
d©a
);

6218 
	`r8168_mac_oı_wr™e
(

, 0xe63e, 0x0001);

6219 
	`r8168_mac_oı_wr™e
(

, 0xe63e, 0x0000);

6220 
	`r8168_mac_oı_wr™e
(

, 0xc094, 0x0000);

6221 
	`r8168_mac_oı_wr™e
(

, 0xc09e, 0x0000);

6222 
	}
}

6224 
	$¹l_hw_¡¬t_8168•
(
¹l8169_´iv©e
 *

)

6226 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6227 
pci_dev
 *
pdev
 = 

->pci_dev;

6229 
	`¹l8168•_¡İ_cmac
(

);

6231 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6233 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_0101
, 0x00080002, 
ERIAR_EXGMAC
);

6234 
	`¹l_”i_wr™e
(

, 0xcc, 
ERIAR_MASK_0001
, 0x2f, 
ERIAR_EXGMAC
);

6235 
	`¹l_”i_wr™e
(

, 0xd0, 
ERIAR_MASK_0001
, 0x5f, 
ERIAR_EXGMAC
);

6236 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00100006, 
ERIAR_EXGMAC
);

6238 
	`¹l_csi_acûss_’abË_1
(

);

6240 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6242 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6243 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6245 
	`¹l_w0w1_”i
(

, 0xd4, 
ERIAR_MASK_1111
, 0x1f80, 0x00, 
ERIAR_EXGMAC
);

6247 
	`¹l_”i_wr™e
(

, 0x5f0, 
ERIAR_MASK_0011
, 0x4f87, 
ERIAR_EXGMAC
);

6249 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè& ~
RXDV_GATED_EN
);

6250 
	`RTL_W8
(
MaxTxPack‘Size
, 
E¬lySize
);

6252 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6253 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6256 
	`RTL_W8
(
EEE_LED
, 
	`RTL_R8
(EEE_LED) & ~0x07);

6258 
	`¹l_w0w1_”i
(

, 0x2fc, 
ERIAR_MASK_0001
, 0x01, 0x06, 
ERIAR_EXGMAC
);

6260 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
TX_10M_PS_EN
);

6262 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6263 
	}
}

6265 
	$¹l_hw_¡¬t_8168•_1
(
¹l8169_´iv©e
 *

)

6267 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6268 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_1
[] = {

6277 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6278 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6279 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_1
, 
	`ARRAY_SIZE
(e_info_8168ep_1));

6281 
	`¹l_hw_¡¬t_8168•
(

);

6282 
	}
}

6284 
	$¹l_hw_¡¬t_8168•_2
(
¹l8169_´iv©e
 *

)

6286 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6287 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_2
[] = {

6294 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6295 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6296 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_2
, 
	`ARRAY_SIZE
(e_info_8168ep_2));

6298 
	`¹l_hw_¡¬t_8168•
(

);

6300 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
PFM_EN
);

6301 
	`RTL_W8
(
MISC_1
, 
	`RTL_R8
(MISC_1è& ~
PFM_D3COLD_EN
);

6302 
	}
}

6304 
	$¹l_hw_¡¬t_8168•_3
(
¹l8169_´iv©e
 *

)

6306 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6307 
u32
 
d©a
;

6308 cÚ¡ 
•hy_šfo
 
e_šfo_8168•_3
[] = {

6316 
	`RTL_W8
(
CÚfig2
, 
	`RTL_R8
(CÚfig2è& ~
ClkReqEn
);

6317 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& ~
ASPM_’
);

6318 
	`¹l_•hy_š™
(

, 
e_šfo_8168•_3
, 
	`ARRAY_SIZE
(e_info_8168ep_3));

6320 
	`¹l_hw_¡¬t_8168•
(

);

6322 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
PFM_EN
);

6323 
	`RTL_W8
(
MISC_1
, 
	`RTL_R8
(MISC_1è& ~
PFM_D3COLD_EN
);

6325 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd3e2);

6326 
d©a
 &= 0xf000;

6327 
d©a
 |= 0x0271;

6328 
	`r8168_mac_oı_wr™e
(

, 0xd3e2, 
d©a
);

6330 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xd3e4);

6331 
d©a
 &= 0xff00;

6332 
	`r8168_mac_oı_wr™e
(

, 0xd3e4, 
d©a
);

6334 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe860);

6335 
d©a
 |= 0x0080;

6336 
	`r8168_mac_oı_wr™e
(

, 0xe860, 
d©a
);

6337 
	}
}

6339 
	$¹l_hw_¡¬t_8168
(
Ãt_deviû
 *
dev
)

6341 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6342 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6344 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

6346 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

6348 
	`¹l_£t_rx_max_size
(
ißddr
, 
rx_buf_sz
);

6350 

->
ı_cmd
 |ğ
	`RTL_R16
(
CPlusCmd
è| 
PktCÁrDi§bË
 | 
INTT_1
;

6352 
	`RTL_W16
(
CPlusCmd
, 

->
ı_cmd
);

6354 
	`RTL_W16
(
IÁrM™ig©e
, 0x5151);

6357 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_11
) {

6358 

->
ev’t_¦ow
 |ğ
RxFIFOOv”
 | 
PCSTimeout
;

6359 

->
ev’t_¦ow
 &ğ~
RxOv”æow
;

6362 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

, 
ißddr
);

6364 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

6366 
	`RTL_R8
(
IÁrMask
);

6368 

->
mac_v”siÚ
) {

6369 
RTL_GIGA_MAC_VER_11
:

6370 
	`¹l_hw_¡¬t_8168bb
(

);

6373 
RTL_GIGA_MAC_VER_12
:

6374 
RTL_GIGA_MAC_VER_17
:

6375 
	`¹l_hw_¡¬t_8168bef
(

);

6378 
RTL_GIGA_MAC_VER_18
:

6379 
	`¹l_hw_¡¬t_8168ı_1
(

);

6382 
RTL_GIGA_MAC_VER_19
:

6383 
	`¹l_hw_¡¬t_8168c_1
(

);

6386 
RTL_GIGA_MAC_VER_20
:

6387 
	`¹l_hw_¡¬t_8168c_2
(

);

6390 
RTL_GIGA_MAC_VER_21
:

6391 
	`¹l_hw_¡¬t_8168c_3
(

);

6394 
RTL_GIGA_MAC_VER_22
:

6395 
	`¹l_hw_¡¬t_8168c_4
(

);

6398 
RTL_GIGA_MAC_VER_23
:

6399 
	`¹l_hw_¡¬t_8168ı_2
(

);

6402 
RTL_GIGA_MAC_VER_24
:

6403 
	`¹l_hw_¡¬t_8168ı_3
(

);

6406 
RTL_GIGA_MAC_VER_25
:

6407 
RTL_GIGA_MAC_VER_26
:

6408 
RTL_GIGA_MAC_VER_27
:

6409 
	`¹l_hw_¡¬t_8168d
(

);

6412 
RTL_GIGA_MAC_VER_28
:

6413 
	`¹l_hw_¡¬t_8168d_4
(

);

6416 
RTL_GIGA_MAC_VER_31
:

6417 
	`¹l_hw_¡¬t_8168dp
(

);

6420 
RTL_GIGA_MAC_VER_32
:

6421 
RTL_GIGA_MAC_VER_33
:

6422 
	`¹l_hw_¡¬t_8168e_1
(

);

6424 
RTL_GIGA_MAC_VER_34
:

6425 
	`¹l_hw_¡¬t_8168e_2
(

);

6428 
RTL_GIGA_MAC_VER_35
:

6429 
RTL_GIGA_MAC_VER_36
:

6430 
	`¹l_hw_¡¬t_8168f_1
(

);

6433 
RTL_GIGA_MAC_VER_38
:

6434 
	`¹l_hw_¡¬t_8411
(

);

6437 
RTL_GIGA_MAC_VER_40
:

6438 
RTL_GIGA_MAC_VER_41
:

6439 
	`¹l_hw_¡¬t_8168g_1
(

);

6441 
RTL_GIGA_MAC_VER_42
:

6442 
	`¹l_hw_¡¬t_8168g_2
(

);

6445 
RTL_GIGA_MAC_VER_44
:

6446 
	`¹l_hw_¡¬t_8411_2
(

);

6449 
RTL_GIGA_MAC_VER_45
:

6450 
RTL_GIGA_MAC_VER_46
:

6451 
	`¹l_hw_¡¬t_8168h_1
(

);

6454 
RTL_GIGA_MAC_VER_49
:

6455 
	`¹l_hw_¡¬t_8168•_1
(

);

6458 
RTL_GIGA_MAC_VER_50
:

6459 
	`¹l_hw_¡¬t_8168•_2
(

);

6462 
RTL_GIGA_MAC_VER_51
:

6463 
	`¹l_hw_¡¬t_8168•_3
(

);

6467 
	`´štk
(
KERN_ERR
 
PFX
 "%s: unknown chipset (mac_version = %d).\n",

6468 
dev
->
Çme
, 

->
mac_v”siÚ
);

6472 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

6474 
	`RTL_W8
(
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

6476 
	`¹l_£t_rx_mode
(
dev
);

6478 
	`RTL_W16
(
MuÉiIÁr
, 
	`RTL_R16
(MultiIntr) & 0xf000);

6479 
	}
}

6481 
	#R810X_CPCMD_QUIRK_MASK
 (\

6482 
EÇbËBi¡
 | \

6483 
Mac_dbgo_Û
 | \

6484 
FÜû_h®f_dup
 | \

6485 
FÜû_rxæow_’
 | \

6486 
FÜû_txæow_’
 | \

6487 
Cx¶_dbg_£l
 | \

6488 
ASF
 | \

6489 
PktCÁrDi§bË
 | \

6490 
Mac_dbgo_£l
)

	)

6492 
	$¹l_hw_¡¬t_8102e_1
(
¹l8169_´iv©e
 *

)

6494 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6495 
pci_dev
 *
pdev
 = 

->pci_dev;

6496 cÚ¡ 
•hy_šfo
 
e_šfo_8102e_1
[] = {

6506 
u8
 
cfg1
;

6508 
	`¹l_csi_acûss_’abË_2
(

);

6510 
	`RTL_W8
(
DBG_REG
, 
FIX_NAK_1
);

6512 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6514 
	`RTL_W8
(
CÚfig1
,

6515 
LEDS1
 | 
LEDS0
 | 
S³ed_down
 | 
MEMMAP
 | 
IOMAP
 | 
VPD
 | 
PMEÇbË
);

6516 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

6518 
cfg1
 = 
	`RTL_R8
(
CÚfig1
);

6519 ià((
cfg1
 & 
LEDS0
è&& (cfg1 & 
LEDS1
))

6520 
	`RTL_W8
(
CÚfig1
, 
cfg1
 & ~
LEDS0
);

6522 
	`¹l_•hy_š™
(

, 
e_šfo_8102e_1
, 
	`ARRAY_SIZE
(e_info_8102e_1));

6523 
	}
}

6525 
	$¹l_hw_¡¬t_8102e_2
(
¹l8169_´iv©e
 *

)

6527 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6528 
pci_dev
 *
pdev
 = 

->pci_dev;

6530 
	`¹l_csi_acûss_’abË_2
(

);

6532 
	`¹l_tx_³rfÜmªû_tw—k
(
pdev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6534 
	`RTL_W8
(
CÚfig1
, 
MEMMAP
 | 
IOMAP
 | 
VPD
 | 
PMEÇbË
);

6535 
	`RTL_W8
(
CÚfig3
, 
	`RTL_R8
(CÚfig3è& ~
B—cÚ_’
);

6536 
	}
}

6538 
	$¹l_hw_¡¬t_8102e_3
(
¹l8169_´iv©e
 *

)

6540 
	`¹l_hw_¡¬t_8102e_2
(

);

6542 
	`¹l_•hy_wr™e
(

, 0x03, 0xc2f9);

6543 
	}
}

6545 
	$¹l_hw_¡¬t_8105e_1
(
¹l8169_´iv©e
 *

)

6547 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6548 cÚ¡ 
•hy_šfo
 
e_šfo_8105e_1
[] = {

6560 
	`RTL_W32
(
FuncEv’t
, 
	`RTL_R32
(FuncEvent) | 0x002800);

6563 
	`RTL_W32
(
FuncEv’t
, 
	`RTL_R32
(FuncEvent) & ~0x010000);

6565 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè| 
EN_NDP
 | 
EN_OOB_RESET
);

6566 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè| 
PFM_EN
);

6568 
	`¹l_•hy_š™
(

, 
e_šfo_8105e_1
, 
	`ARRAY_SIZE
(e_info_8105e_1));

6570 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6571 
	}
}

6573 
	$¹l_hw_¡¬t_8105e_2
(
¹l8169_´iv©e
 *

)

6575 
	`¹l_hw_¡¬t_8105e_1
(

);

6576 
	`¹l_•hy_wr™e
(

, 0x1e, 
	`¹l_•hy_»ad
(tp, 0x1e) | 0x8000);

6577 
	}
}

6579 
	$¹l_hw_¡¬t_8402
(
¹l8169_´iv©e
 *

)

6581 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6582 cÚ¡ 
•hy_šfo
 
e_šfo_8402
[] = {

6587 
	`¹l_csi_acûss_’abË_2
(

);

6590 
	`RTL_W32
(
FuncEv’t
, 
	`RTL_R32
(FuncEvent) | 0x002800);

6592 
	`RTL_W32
(
TxCÚfig
, 
	`RTL_R32
(TxCÚfigè| 
TXCFG_AUTO_FIFO
);

6593 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè& ~
NOW_IS_OOB
);

6595 
	`¹l_•hy_š™
(

, 
e_šfo_8402
, 
	`ARRAY_SIZE
(e_info_8402));

6597 
	`¹l_tx_³rfÜmªû_tw—k
(

->
pci_dev
, 0x5 << 
MAX_READ_REQUEST_SHIFT
);

6599 
	`¹l_”i_wr™e
(

, 0xc8, 
ERIAR_MASK_1111
, 0x00000002, 
ERIAR_EXGMAC
);

6600 
	`¹l_”i_wr™e
(

, 0xe8, 
ERIAR_MASK_1111
, 0x00000006, 
ERIAR_EXGMAC
);

6601 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x00, 0x01, 
ERIAR_EXGMAC
);

6602 
	`¹l_w0w1_”i
(

, 0xdc, 
ERIAR_MASK_0001
, 0x01, 0x00, 
ERIAR_EXGMAC
);

6603 
	`¹l_”i_wr™e
(

, 0xc0, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6604 
	`¹l_”i_wr™e
(

, 0xb8, 
ERIAR_MASK_0011
, 0x0000, 
ERIAR_EXGMAC
);

6605 
	`¹l_w0w1_”i
(

, 0x0d4, 
ERIAR_MASK_0011
, 0x0e00, 0xff00, 
ERIAR_EXGMAC
);

6607 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6608 
	}
}

6610 
	$¹l_hw_¡¬t_8106
(
¹l8169_´iv©e
 *

)

6612 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6615 
	`RTL_W32
(
FuncEv’t
, 
	`RTL_R32
(FuncEvent) | 0x002800);

6617 
	`RTL_W32
(
MISC
, (
	`RTL_R32
(MISCè| 
DISABLE_LAN_EN
è& ~
EARLY_TALLY_EN
);

6618 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè| 
EN_NDP
 | 
EN_OOB_RESET
);

6619 
	`RTL_W8
(
DLLPR
, 
	`RTL_R8
(DLLPRè& ~
PFM_EN
);

6621 
	`¹l_pc›_¡©e_l2l3_’abË
(

, 
çl£
);

6622 
	}
}

6624 
	$¹l_hw_¡¬t_8101
(
Ãt_deviû
 *
dev
)

6626 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6627 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

6628 
pci_dev
 *
pdev
 = 

->pci_dev;

6630 ià(

->
mac_v”siÚ
 >ğ
RTL_GIGA_MAC_VER_30
)

6631 

->
ev’t_¦ow
 &ğ~
RxFIFOOv”
;

6633 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_13
 ||

6634 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_16
)

6635 
	`pc›_ÿ·b™y_£t_wÜd
(
pdev
, 
PCI_EXP_DEVCTL
,

6636 
PCI_EXP_DEVCTL_NOSNOOP_EN
);

6638 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

6640 
	`RTL_W8
(
MaxTxPack‘Size
, 
TxPack‘Max
);

6642 
	`¹l_£t_rx_max_size
(
ißddr
, 
rx_buf_sz
);

6644 

->
ı_cmd
 &ğ~
R810X_CPCMD_QUIRK_MASK
;

6645 
	`RTL_W16
(
CPlusCmd
, 

->
ı_cmd
);

6647 
	`¹l_£t_rx_tx_desc_»gi¡”s
(

, 
ißddr
);

6649 
	`¹l_£t_rx_tx_cÚfig_»gi¡”s
(

);

6651 

->
mac_v”siÚ
) {

6652 
RTL_GIGA_MAC_VER_07
:

6653 
	`¹l_hw_¡¬t_8102e_1
(

);

6656 
RTL_GIGA_MAC_VER_08
:

6657 
	`¹l_hw_¡¬t_8102e_3
(

);

6660 
RTL_GIGA_MAC_VER_09
:

6661 
	`¹l_hw_¡¬t_8102e_2
(

);

6664 
RTL_GIGA_MAC_VER_29
:

6665 
	`¹l_hw_¡¬t_8105e_1
(

);

6667 
RTL_GIGA_MAC_VER_30
:

6668 
	`¹l_hw_¡¬t_8105e_2
(

);

6671 
RTL_GIGA_MAC_VER_37
:

6672 
	`¹l_hw_¡¬t_8402
(

);

6675 
RTL_GIGA_MAC_VER_39
:

6676 
	`¹l_hw_¡¬t_8106
(

);

6678 
RTL_GIGA_MAC_VER_43
:

6679 
	`¹l_hw_¡¬t_8168g_2
(

);

6681 
RTL_GIGA_MAC_VER_47
:

6682 
RTL_GIGA_MAC_VER_48
:

6683 
	`¹l_hw_¡¬t_8168h_1
(

);

6687 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

6689 
	`RTL_W16
(
IÁrM™ig©e
, 0x0000);

6691 
	`RTL_W8
(
ChCmd
, 
CmdTxEnb
 | 
CmdRxEnb
);

6693 
	`¹l_£t_rx_mode
(
dev
);

6695 
	`RTL_R8
(
IÁrMask
);

6697 
	`RTL_W16
(
MuÉiIÁr
, 
	`RTL_R16
(MultiIntr) & 0xf000);

6698 
	}
}

6700 
	$¹l8169_chªge_mtu
(
Ãt_deviû
 *
dev
, 
Ãw_mtu
)

6702 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6704 ià(
Ãw_mtu
 < 
ETH_ZLEN
 ||

6705 
Ãw_mtu
 > 
¹l_ch_šfos
[

->
mac_v”siÚ
].
jumbo_max
)

6706  -
EINVAL
;

6708 ià(
Ãw_mtu
 > 
ETH_DATA_LEN
)

6709 
	`¹l_hw_jumbo_’abË
(

);

6711 
	`¹l_hw_jumbo_di§bË
(

);

6713 
dev
->
mtu
 = 
Ãw_mtu
;

6714 
	`Ãtdev_upd©e_ã©u»s
(
dev
);

6717 
	}
}

6719 
šlše
 
	$¹l8169_make_unu§bË_by_asic
(
RxDesc
 *
desc
)

6721 
desc
->
addr
 = 
	`ıu_to_Ë64
(0x0badbadbadbadbadull);

6722 
desc
->
İts1
 &ğ~
	`ıu_to_Ë32
(
DescOwn
 | 
RsvdMask
);

6723 
	}
}

6725 
	$¹l8169_ä“_rx_d©abuff
(
¹l8169_´iv©e
 *

,

6726 **
d©a_buff
, 
RxDesc
 *
desc
)

6728 
	`dma_unm­_sšgË
(&

->
pci_dev
->
dev
, 
	`Ë64_to_ıu
(
desc
->
addr
), 
rx_buf_sz
,

6729 
DMA_FROM_DEVICE
);

6731 
	`kä“
(*
d©a_buff
);

6732 *
d©a_buff
 = 
NULL
;

6733 
	`¹l8169_make_unu§bË_by_asic
(
desc
);

6734 
	}
}

6736 
šlše
 
	$¹l8169_m¬k_to_asic
(
RxDesc
 *
desc
, 
u32
 
rx_buf_sz
)

6738 
u32
 
eÜ
 = 
	`Ë32_to_ıu
(
desc
->
İts1
è& 
RšgEnd
;

6741 
	`dma_wmb
();

6743 
desc
->
İts1
 = 
	`ıu_to_Ë32
(
DescOwn
 | 
eÜ
 | 
rx_buf_sz
);

6744 
	}
}

6746 
šlše
 
	$¹l8169_m­_to_asic
(
RxDesc
 *
desc
, 
dma_addr_t
 
m­pšg
,

6747 
u32
 
rx_buf_sz
)

6749 
desc
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

6750 
	`¹l8169_m¬k_to_asic
(
desc
, 
rx_buf_sz
);

6751 
	}
}

6753 
šlše
 *
	$¹l8169_®ign
(*
d©a
)

6755  (*)
	`ALIGN
(()
d©a
, 16);

6756 
	}
}

6758 
sk_buff
 *
	$¹l8169_®loc_rx_d©a
(
¹l8169_´iv©e
 *

,

6759 
RxDesc
 *
desc
)

6761 *
d©a
;

6762 
dma_addr_t
 
m­pšg
;

6763 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

6764 
Ãt_deviû
 *
dev
 = 

->dev;

6765 
node
 = 
dev
->dev.
·»Á
 ? 
	`dev_to_node
(dev->dev.parent) : -1;

6767 
d©a
 = 
	`km®loc_node
(
rx_buf_sz
, 
GFP_KERNEL
, 
node
);

6768 ià(!
d©a
)

6769  
NULL
;

6771 ià(
	`¹l8169_®ign
(
d©a
) != data) {

6772 
	`kä“
(
d©a
);

6773 
d©a
 = 
	`km®loc_node
(
rx_buf_sz
 + 15, 
GFP_KERNEL
, 
node
);

6774 ià(!
d©a
)

6775  
NULL
;

6778 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
	`¹l8169_®ign
(
d©a
), 
rx_buf_sz
,

6779 
DMA_FROM_DEVICE
);

6780 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

6781 ià(
	`Ãt_¿‹lim™
())

6782 
	`Ãtif_”r
(

, 
drv
,p->
dev
, "Failedo map RX DMA!\n");

6783 
”r_out
;

6786 
	`¹l8169_m­_to_asic
(
desc
, 
m­pšg
, 
rx_buf_sz
);

6787  
d©a
;

6789 
”r_out
:

6790 
	`kä“
(
d©a
);

6791  
NULL
;

6792 
	}
}

6794 
	$¹l8169_rx_ş—r
(
¹l8169_´iv©e
 *

)

6796 
i
;

6798 
i
 = 0; i < 
NUM_RX_DESC
; i++) {

6799 ià(

->
Rx_d©abuff
[
i
]) {

6800 
	`¹l8169_ä“_rx_d©abuff
(

,p->
Rx_d©abuff
 + 
i
,

6801 

->
RxDescA¼ay
 + 
i
);

6804 
	}
}

6806 
šlše
 
	$¹l8169_m¬k_as_Ï¡_desütÜ
(
RxDesc
 *
desc
)

6808 
desc
->
İts1
 |ğ
	`ıu_to_Ë32
(
RšgEnd
);

6809 
	}
}

6811 
	$¹l8169_rx_fl
(
¹l8169_´iv©e
 *

)

6813 
i
;

6815 
i
 = 0; i < 
NUM_RX_DESC
; i++) {

6816 *
d©a
;

6818 ià(

->
Rx_d©abuff
[
i
])

6821 
d©a
 = 
	`¹l8169_®loc_rx_d©a
(

,p->
RxDescA¼ay
 + 
i
);

6822 ià(!
d©a
) {

6823 
	`¹l8169_make_unu§bË_by_asic
(

->
RxDescA¼ay
 + 
i
);

6824 
”r_out
;

6826 

->
Rx_d©abuff
[
i
] = 
d©a
;

6829 
	`¹l8169_m¬k_as_Ï¡_desütÜ
(

->
RxDescA¼ay
 + 
NUM_RX_DESC
 - 1);

6832 
”r_out
:

6833 
	`¹l8169_rx_ş—r
(

);

6834  -
ENOMEM
;

6835 
	}
}

6837 
	$¹l8169_š™_ršg
(
Ãt_deviû
 *
dev
)

6839 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6841 
	`¹l8169_š™_ršg_šdexes
(

);

6843 
	`mem£t
(

->
tx_skb
, 0x0, 
NUM_TX_DESC
 * (
ršg_šfo
));

6844 
	`mem£t
(

->
Rx_d©abuff
, 0x0, 
NUM_RX_DESC
 * (*));

6846  
	`¹l8169_rx_fl
(

);

6847 
	}
}

6849 
	$¹l8169_unm­_tx_skb
(
deviû
 *
d
, 
ršg_šfo
 *
tx_skb
,

6850 
TxDesc
 *
desc
)

6852 
Ën
 = 
tx_skb
->len;

6854 
	`dma_unm­_sšgË
(
d
, 
	`Ë64_to_ıu
(
desc
->
addr
), 
Ën
, 
DMA_TO_DEVICE
);

6856 
desc
->
İts1
 = 0x00;

6857 
desc
->
İts2
 = 0x00;

6858 
desc
->
addr
 = 0x00;

6859 
tx_skb
->
Ën
 = 0;

6860 
	}
}

6862 
	$¹l8169_tx_ş—r_¿nge
(
¹l8169_´iv©e
 *

, 
u32
 
¡¬t
,

6863 
n
)

6865 
i
;

6867 
i
 = 0; i < 
n
; i++) {

6868 
’Œy
 = (
¡¬t
 + 
i
è% 
NUM_TX_DESC
;

6869 
ršg_šfo
 *
tx_skb
 = 

->tx_skb + 
’Œy
;

6870 
Ën
 = 
tx_skb
->len;

6872 ià(
Ën
) {

6873 
sk_buff
 *
skb
 = 
tx_skb
->skb;

6875 
	`¹l8169_unm­_tx_skb
(&

->
pci_dev
->
dev
, 
tx_skb
,

6876 

->
TxDescA¼ay
 + 
’Œy
);

6877 ià(
skb
) {

6878 

->
dev
->
¡©s
.
tx_drİ³d
++;

6879 
	`dev_kä“_skb_ªy
(
skb
);

6880 
tx_skb
->
skb
 = 
NULL
;

6884 
	}
}

6886 
	$¹l8169_tx_ş—r
(
¹l8169_´iv©e
 *

)

6888 
	`¹l8169_tx_ş—r_¿nge
(

,p->
dœty_tx
, 
NUM_TX_DESC
);

6889 

->
cur_tx
 =p->
dœty_tx
 = 0;

6890 
	}
}

6892 
	$¹l_»£t_wÜk
(
¹l8169_´iv©e
 *

)

6894 
Ãt_deviû
 *
dev
 = 

->dev;

6895 
i
;

6897 
	`Çpi_di§bË
(&

->
Çpi
);

6898 
	`Ãtif_¡İ_queue
(
dev
);

6899 
	`synchrÚize_sched
();

6901 
	`¹l8169_hw_»£t
(

);

6903 
i
 = 0; i < 
NUM_RX_DESC
; i++)

6904 
	`¹l8169_m¬k_to_asic
(

->
RxDescA¼ay
 + 
i
, 
rx_buf_sz
);

6906 
	`¹l8169_tx_ş—r
(

);

6907 
	`¹l8169_š™_ršg_šdexes
(

);

6909 
	`Çpi_’abË
(&

->
Çpi
);

6910 
	`¹l_hw_¡¬t
(
dev
);

6911 
	`Ãtif_wake_queue
(
dev
);

6912 
	`¹l8169_check_lšk_¡©us
(
dev
, 

,p->
mmio_addr
);

6913 
	}
}

6915 
	$¹l8169_tx_timeout
(
Ãt_deviû
 *
dev
)

6917 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

6919 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

6920 
	}
}

6922 
	$¹l8169_xm™_äags
(
¹l8169_´iv©e
 *

, 
sk_buff
 *
skb
,

6923 
u32
 *
İts
)

6925 
skb_sh¬ed_šfo
 *
šfo
 = 
	`skb_shšfo
(
skb
);

6926 
cur_äag
, 
’Œy
;

6927 
TxDesc
 *
	`unš™Ÿlized_v¬
(
txd
);

6928 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

6930 
’Œy
 = 

->
cur_tx
;

6931 
cur_äag
 = 0; cur_äag < 
šfo
->
Ä_äags
; cur_frag++) {

6932 cÚ¡ 
skb_äag_t
 *
äag
 = 
šfo
->
äags
 + 
cur_äag
;

6933 
dma_addr_t
 
m­pšg
;

6934 
u32
 
¡©us
, 
Ën
;

6935 *
addr
;

6937 
’Œy
 = (’Œy + 1è% 
NUM_TX_DESC
;

6939 
txd
 = 

->
TxDescA¼ay
 + 
’Œy
;

6940 
Ën
 = 
	`skb_äag_size
(
äag
);

6941 
addr
 = 
	`skb_äag_add»ss
(
äag
);

6942 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
addr
, 
Ën
, 
DMA_TO_DEVICE
);

6943 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

6944 ià(
	`Ãt_¿‹lim™
())

6945 
	`Ãtif_”r
(

, 
drv
,p->
dev
,

6947 
”r_out
;

6951 
¡©us
 = 
İts
[0] | 
Ën
 |

6952 (
RšgEnd
 * !((
’Œy
 + 1è% 
NUM_TX_DESC
));

6954 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
¡©us
);

6955 
txd
->
İts2
 = 
	`ıu_to_Ë32
(
İts
[1]);

6956 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

6958 

->
tx_skb
[
’Œy
].
Ën
 =†en;

6961 ià(
cur_äag
) {

6962 

->
tx_skb
[
’Œy
].
skb
 = skb;

6963 
txd
->
İts1
 |ğ
	`ıu_to_Ë32
(
La¡F¿g
);

6966  
cur_äag
;

6968 
”r_out
:

6969 
	`¹l8169_tx_ş—r_¿nge
(

,p->
cur_tx
 + 1, 
cur_äag
);

6970  -
EIO
;

6971 
	}
}

6973 
boŞ
 
	$¹l_‹¡_hw_·d_bug
(
¹l8169_´iv©e
 *

, 
sk_buff
 *
skb
)

6975  
skb
->
Ën
 < 
ETH_ZLEN
 && 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_34
;

6976 
	}
}

6978 
Ãtdev_tx_t
 
¹l8169_¡¬t_xm™
(
sk_buff
 *
skb
,

6979 
Ãt_deviû
 *
dev
);

6984 
	$r8169_csum_wÜk¬ound
(
¹l8169_´iv©e
 *

,

6985 
sk_buff
 *
skb
)

6987 ià(
	`skb_shšfo
(
skb
)->
gso_size
) {

6988 
Ãtdev_ã©u»s_t
 
ã©u»s
 = 

->
dev
->features;

6989 
sk_buff
 *
£gs
, *
nskb
;

6991 
ã©u»s
 &ğ~(
NETIF_F_SG
 | 
NETIF_F_IPV6_CSUM
 | 
NETIF_F_TSO6
);

6992 
£gs
 = 
	`skb_gso_£gm’t
(
skb
, 
ã©u»s
);

6993 ià(
	`IS_ERR
(
£gs
) || !segs)

6994 
drİ
;

6997 
nskb
 = 
£gs
;

6998 
£gs
 = segs->
Ãxt
;

6999 
nskb
->
Ãxt
 = 
NULL
;

7000 
	`¹l8169_¡¬t_xm™
(
nskb
, 

->
dev
);

7001 } 
£gs
);

7003 
	`dev_cÚsume_skb_ªy
(
skb
);

7004 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

7005 ià(
	`skb_checksum_h–p
(
skb
) < 0)

7006 
drİ
;

7008 
	`¹l8169_¡¬t_xm™
(
skb
, 

->
dev
);

7010 
Ãt_deviû_¡©s
 *
¡©s
;

7012 
drİ
:

7013 
¡©s
 = &

->
dev
->stats;

7014 
¡©s
->
tx_drİ³d
++;

7015 
	`dev_kä“_skb_ªy
(
skb
);

7017 
	}
}

7023 
	$msdn_gŸÁ_£nd_check
(
sk_buff
 *
skb
)

7025 cÚ¡ 
v6hdr
 *
v6h
;

7026 
tıhdr
 *
th
;

7027 
»t
;

7029 
»t
 = 
	`skb_cow_h—d
(
skb
, 0);

7030 ià(
»t
)

7031  
»t
;

7033 
v6h
 = 
	`v6_hdr
(
skb
);

7034 
th
 = 
	`tı_hdr
(
skb
);

7036 
th
->
check
 = 0;

7037 
th
->
check
 = ~
	`tı_v6_check
(0, &
v6h
->
§ddr
, &v6h->
daddr
, 0);

7039  
»t
;

7040 
	}
}

7042 
šlše
 
__be16
 
	$g‘_´ÙocŞ
(
sk_buff
 *
skb
)

7044 
__be16
 
´ÙocŞ
;

7046 ià(
skb
->
´ÙocŞ
 =ğ
	`htÚs
(
ETH_P_8021Q
))

7047 
´ÙocŞ
 = 
	`vÏn_‘h_hdr
(
skb
)->
h_vÏn_’ÿpsuÏ‹d_´Ùo
;

7049 
´ÙocŞ
 = 
skb
->protocol;

7051  
´ÙocŞ
;

7052 
	}
}

7054 
boŞ
 
	$¹l8169_tso_csum_v1
(
¹l8169_´iv©e
 *

,

7055 
sk_buff
 *
skb
, 
u32
 *
İts
)

7057 
u32
 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
;

7059 ià(
mss
) {

7060 
İts
[0] |ğ
TD_LSO
;

7061 
İts
[0] |ğ
	`mš
(
mss
, 
TD_MSS_MAX
è<< 
TD0_MSS_SHIFT
;

7062 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

7063 cÚ¡ 
hdr
 *

 = 
	`_hdr
(
skb
);

7065 ià(

->
´ÙocŞ
 =ğ
IPPROTO_TCP
)

7066 
İts
[0] |ğ
TD0_IP_CS
 | 
TD0_TCP_CS
;

7067 ià(

->
´ÙocŞ
 =ğ
IPPROTO_UDP
)

7068 
İts
[0] |ğ
TD0_IP_CS
 | 
TD0_UDP_CS
;

7070 
	`WARN_ON_ONCE
(1);

7073  
Œue
;

7074 
	}
}

7076 
boŞ
 
	$¹l8169_tso_csum_v2
(
¹l8169_´iv©e
 *

,

7077 
sk_buff
 *
skb
, 
u32
 *
İts
)

7079 
u32
 
Œª¥Üt_off£t
 = (u32)
	`skb_Œª¥Üt_off£t
(
skb
);

7080 
u32
 
mss
 = 
	`skb_shšfo
(
skb
)->
gso_size
;

7082 ià(
mss
) {

7083 ià(
Œª¥Üt_off£t
 > 
GTTCPHO_MAX
) {

7084 
	`Ãtif_w¬n
(

, 
tx_”r
,p->
dev
,

7086 
Œª¥Üt_off£t
);

7087  
çl£
;

7090 
	`g‘_´ÙocŞ
(
skb
)) {

7091 
	`htÚs
(
ETH_P_IP
):

7092 
İts
[0] |ğ
TD1_GTSENV4
;

7095 
	`htÚs
(
ETH_P_IPV6
):

7096 ià(
	`msdn_gŸÁ_£nd_check
(
skb
))

7097  
çl£
;

7099 
İts
[0] |ğ
TD1_GTSENV6
;

7103 
	`WARN_ON_ONCE
(1);

7107 
İts
[0] |ğ
Œª¥Üt_off£t
 << 
GTTCPHO_SHIFT
;

7108 
İts
[1] |ğ
	`mš
(
mss
, 
TD_MSS_MAX
è<< 
TD1_MSS_SHIFT
;

7109 } ià(
skb
->
_summed
 =ğ
CHECKSUM_PARTIAL
) {

7110 
u8
 
_´ÙocŞ
;

7112 ià(
	`uÆik–y
(
	`¹l_‹¡_hw_·d_bug
(

, 
skb
)))

7113  !(
	`skb_checksum_h–p
(
skb
è|| 
	`‘h_skb_·d
(skb));

7115 ià(
Œª¥Üt_off£t
 > 
TCPHO_MAX
) {

7116 
	`Ãtif_w¬n
(

, 
tx_”r
,p->
dev
,

7118 
Œª¥Üt_off£t
);

7119  
çl£
;

7122 
	`g‘_´ÙocŞ
(
skb
)) {

7123 
	`htÚs
(
ETH_P_IP
):

7124 
İts
[1] |ğ
TD1_IPv4_CS
;

7125 
_´ÙocŞ
 = 
	`_hdr
(
skb
)->
´ÙocŞ
;

7128 
	`htÚs
(
ETH_P_IPV6
):

7129 
İts
[1] |ğ
TD1_IPv6_CS
;

7130 
_´ÙocŞ
 = 
	`v6_hdr
(
skb
)->
Ãxthdr
;

7134 
_´ÙocŞ
 = 
IPPROTO_RAW
;

7138 ià(
_´ÙocŞ
 =ğ
IPPROTO_TCP
)

7139 
İts
[1] |ğ
TD1_TCP_CS
;

7140 ià(
_´ÙocŞ
 =ğ
IPPROTO_UDP
)

7141 
İts
[1] |ğ
TD1_UDP_CS
;

7143 
	`WARN_ON_ONCE
(1);

7145 
İts
[1] |ğ
Œª¥Üt_off£t
 << 
TCPHO_SHIFT
;

7147 ià(
	`uÆik–y
(
	`¹l_‹¡_hw_·d_bug
(

, 
skb
)))

7148  !
	`‘h_skb_·d
(
skb
);

7151  
Œue
;

7152 
	}
}

7154 
Ãtdev_tx_t
 
	$¹l8169_¡¬t_xm™
(
sk_buff
 *
skb
,

7155 
Ãt_deviû
 *
dev
)

7157 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7158 
’Œy
 = 

->
cur_tx
 % 
NUM_TX_DESC
;

7159 
TxDesc
 *
txd
 = 

->
TxDescA¼ay
 + 
’Œy
;

7160 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7161 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

7162 
dma_addr_t
 
m­pšg
;

7163 
u32
 
¡©us
, 
Ën
;

7164 
u32
 
İts
[2];

7165 
äags
;

7167 ià(
	`uÆik–y
(!
	`TX_FRAGS_READY_FOR
(

, 
	`skb_shšfo
(
skb
)->
Ä_äags
))) {

7168 
	`Ãtif_”r
(

, 
drv
, 
dev
, "BUG! Tx Ring full when queue‡wake!\n");

7169 
”r_¡İ_0
;

7172 ià(
	`uÆik–y
(
	`Ë32_to_ıu
(
txd
->
İts1
è& 
DescOwn
))

7173 
”r_¡İ_0
;

7175 
İts
[1] = 
	`ıu_to_Ë32
(
	`¹l8169_tx_vÏn_g
(
skb
));

7176 
İts
[0] = 
DescOwn
;

7178 ià(!

->
	`tso_csum
Ñp, 
skb
, 
İts
)) {

7179 
	`r8169_csum_wÜk¬ound
(

, 
skb
);

7180  
NETDEV_TX_OK
;

7183 
Ën
 = 
	`skb_h—dËn
(
skb
);

7184 
m­pšg
 = 
	`dma_m­_sšgË
(
d
, 
skb
->
d©a
, 
Ën
, 
DMA_TO_DEVICE
);

7185 ià(
	`uÆik–y
(
	`dma_m­pšg_”rÜ
(
d
, 
m­pšg
))) {

7186 ià(
	`Ãt_¿‹lim™
())

7187 
	`Ãtif_”r
(

, 
drv
, 
dev
, "Failedo map TX DMA!\n");

7188 
”r_dma_0
;

7191 

->
tx_skb
[
’Œy
].
Ën
 =†en;

7192 
txd
->
addr
 = 
	`ıu_to_Ë64
(
m­pšg
);

7194 
äags
 = 
	`¹l8169_xm™_äags
(

, 
skb
, 
İts
);

7195 ià(
äags
 < 0)

7196 
”r_dma_1
;

7197 ià(
äags
)

7198 
İts
[0] |ğ
Fœ¡F¿g
;

7200 
İts
[0] |ğ
Fœ¡F¿g
 | 
La¡F¿g
;

7201 

->
tx_skb
[
’Œy
].
skb
 = skb;

7204 
txd
->
İts2
 = 
	`ıu_to_Ë32
(
İts
[1]);

7206 
	`skb_tx_time¡amp
(
skb
);

7209 
	`dma_wmb
();

7212 
¡©us
 = 
İts
[0] | 
Ën
 | (
RšgEnd
 * !((
’Œy
 + 1è% 
NUM_TX_DESC
));

7213 
txd
->
İts1
 = 
	`ıu_to_Ë32
(
¡©us
);

7216 
	`wmb
();

7218 

->
cur_tx
 +ğ
äags
 + 1;

7220 
	`RTL_W8
(
TxPŞl
, 
NPQ
);

7222 
	`mmiowb
();

7224 ià(!
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
)) {

7228 
	`smp_wmb
();

7229 
	`Ãtif_¡İ_queue
(
dev
);

7237 
	`smp_mb
();

7238 ià(
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
))

7239 
	`Ãtif_wake_queue
(
dev
);

7242  
NETDEV_TX_OK
;

7244 
”r_dma_1
:

7245 
	`¹l8169_unm­_tx_skb
(
d
, 

->
tx_skb
 + 
’Œy
, 
txd
);

7246 
”r_dma_0
:

7247 
	`dev_kä“_skb_ªy
(
skb
);

7248 
dev
->
¡©s
.
tx_drİ³d
++;

7249  
NETDEV_TX_OK
;

7251 
”r_¡İ_0
:

7252 
	`Ãtif_¡İ_queue
(
dev
);

7253 
dev
->
¡©s
.
tx_drİ³d
++;

7254  
NETDEV_TX_BUSY
;

7255 
	}
}

7257 
	$¹l8169_pc›¼_š‹¼u±
(
Ãt_deviû
 *
dev
)

7259 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7260 
pci_dev
 *
pdev
 = 

->pci_dev;

7261 
u16
 
pci_¡©us
, 
pci_cmd
;

7263 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
PCI_COMMAND
, &
pci_cmd
);

7264 
	`pci_»ad_cÚfig_wÜd
(
pdev
, 
PCI_STATUS
, &
pci_¡©us
);

7266 
	`Ãtif_”r
(

, 
šŒ
, 
dev
, "PCIƒrror (cmd = 0x%04x, status = 0x%04x)\n",

7267 
pci_cmd
, 
pci_¡©us
);

7277 ià(
pdev
->
brok’_·r™y_¡©us
)

7278 
pci_cmd
 &ğ~
PCI_COMMAND_PARITY
;

7280 
pci_cmd
 |ğ
PCI_COMMAND_SERR
 | 
PCI_COMMAND_PARITY
;

7282 
	`pci_wr™e_cÚfig_wÜd
(
pdev
, 
PCI_COMMAND
, 
pci_cmd
);

7284 
	`pci_wr™e_cÚfig_wÜd
(
pdev
, 
PCI_STATUS
,

7285 
pci_¡©us
 & (
PCI_STATUS_DETECTED_PARITY
 |

7286 
PCI_STATUS_SIG_SYSTEM_ERROR
 | 
PCI_STATUS_REC_MASTER_ABORT
 |

7287 
PCI_STATUS_REC_TARGET_ABORT
 | 
PCI_STATUS_SIG_TARGET_ABORT
));

7290 ià((

->
ı_cmd
 & 
PCIDAC
è&& !->
cur_rx
) {

7291 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7293 
	`Ãtif_šfo
(

, 
šŒ
, 
dev
, "disabling PCI DAC\n");

7294 

->
ı_cmd
 &ğ~
PCIDAC
;

7295 
	`RTL_W16
(
CPlusCmd
, 

->
ı_cmd
);

7296 
dev
->
ã©u»s
 &ğ~
NETIF_F_HIGHDMA
;

7299 
	`¹l8169_hw_»£t
(

);

7301 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7302 
	}
}

7304 
	$¹l_tx
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

)

7306 
dœty_tx
, 
tx_Ëá
;

7308 
dœty_tx
 = 

->dirty_tx;

7309 
	`smp_rmb
();

7310 
tx_Ëá
 = 

->
cur_tx
 - 
dœty_tx
;

7312 
tx_Ëá
 > 0) {

7313 
’Œy
 = 
dœty_tx
 % 
NUM_TX_DESC
;

7314 
ršg_šfo
 *
tx_skb
 = 

->tx_skb + 
’Œy
;

7315 
u32
 
¡©us
;

7317 
¡©us
 = 
	`Ë32_to_ıu
(

->
TxDescA¼ay
[
’Œy
].
İts1
);

7318 ià(
¡©us
 & 
DescOwn
)

7325 
	`dma_rmb
();

7327 
	`¹l8169_unm­_tx_skb
(&

->
pci_dev
->
dev
, 
tx_skb
,

7328 

->
TxDescA¼ay
 + 
’Œy
);

7329 ià(
¡©us
 & 
La¡F¿g
) {

7330 
	`u64_¡©s_upd©e_begš
(&

->
tx_¡©s
.
synı
);

7331 

->
tx_¡©s
.
·ck‘s
++;

7332 

->
tx_¡©s
.
by‹s
 +ğ
tx_skb
->
skb
->
Ën
;

7333 
	`u64_¡©s_upd©e_’d
(&

->
tx_¡©s
.
synı
);

7334 
	`dev_kä“_skb_ªy
(
tx_skb
->
skb
);

7335 
tx_skb
->
skb
 = 
NULL
;

7337 
dœty_tx
++;

7338 
tx_Ëá
--;

7341 ià(

->
dœty_tx
 != dirty_tx) {

7342 

->
dœty_tx
 = dirty_tx;

7350 
	`smp_mb
();

7351 ià(
	`Ãtif_queue_¡İ³d
(
dev
) &&

7352 
	`TX_FRAGS_READY_FOR
(

, 
MAX_SKB_FRAGS
)) {

7353 
	`Ãtif_wake_queue
(
dev
);

7361 ià(

->
cur_tx
 !ğ
dœty_tx
) {

7362 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7364 
	`RTL_W8
(
TxPŞl
, 
NPQ
);

7367 
	}
}

7369 
šlše
 
	$¹l8169_äagm’‹d_äame
(
u32
 
¡©us
)

7371  (
¡©us
 & (
Fœ¡F¿g
 | 
La¡F¿g
)) != (FirstFrag | LastFrag);

7372 
	}
}

7374 
šlše
 
	$¹l8169_rx_csum
(
sk_buff
 *
skb
, 
u32
 
İts1
)

7376 
u32
 
¡©us
 = 
İts1
 & 
RxPrÙoMask
;

7378 ià(((
¡©us
 =ğ
RxPrÙoTCP
è&& !(
İts1
 & 
TCPFa
)) ||

7379 ((
¡©us
 =ğ
RxPrÙoUDP
è&& !(
İts1
 & 
UDPFa
)))

7380 
skb
->
_summed
 = 
CHECKSUM_UNNECESSARY
;

7382 
	`skb_checksum_nÚe_as£¹
(
skb
);

7383 
	}
}

7385 
sk_buff
 *
	$¹l8169_Œy_rx_cİy
(*
d©a
,

7386 
¹l8169_´iv©e
 *

,

7387 
pkt_size
,

7388 
dma_addr_t
 
addr
)

7390 
sk_buff
 *
skb
 = 
NULL
;

7391 
deviû
 *
d
 = &

->
pci_dev
->
dev
;

7392 
bpf_´og
 *
xdp_´og
;

7394 
d©a
 = 
	`¹l8169_®ign
(data);

7395 
	`dma_sync_sšgË_fÜ_ıu
(
d
, 
addr
, 
pkt_size
, 
DMA_FROM_DEVICE
);

7396 
	`´eãtch
(
d©a
);

7397 
	`rcu_»ad_lock
();

7398 
xdp_´og
 = 
	`rcu_d”eã»nû
(

->xdp_prog);

7399 ià(
xdp_´og
) {

7400 
xdp_buff
 
xdp
;

7401 
u32
 
aùiÚ
;

7402 
xdp
.
d©a
 = data;

7403 
xdp
.
d©a_’d
 = 
d©a
 + 
pkt_size
;

7404 
aùiÚ
 = 
	`bpf_´og_run_xdp
(
xdp_´og
, &
xdp
);

7405 
aùiÚ
) {

7406 
XDP_PASS
:

7407 

->
xdp_couÁ”s
.
·ss
++;

7409 
XDP_DROP
:

7410 

->
xdp_couÁ”s
.
drİ
++;

7411 
xdp_drİ
;

7412 
XDP_TX
:

7415 

->
xdp_couÁ”s
.
tx
++;

7416 
xdp_drİ
;

7417 
XDP_ABORTED
:

7418 

->
xdp_couÁ”s
.
abÜ‹d
++;

7419 
xdp_drİ
;

7421 
	`bpf_w¬n_šv®id_xdp_aùiÚ
(
aùiÚ
);

7422 

->
xdp_couÁ”s
.
unknown
++;

7423 
xdp_drİ
;

7426 
	`rcu_»ad_uÆock
();

7427 
skb
 = 
	`Çpi_®loc_skb
(&

->
Çpi
, 
pkt_size
);

7428 ià(
skb
)

7429 
	`memıy
(
skb
->
d©a
, d©a, 
pkt_size
);

7430 
xdp_drİ
:

7431 
	`dma_sync_sšgË_fÜ_deviû
(
d
, 
addr
, 
pkt_size
, 
DMA_FROM_DEVICE
);

7433  
skb
;

7434 
	}
}

7436 
	$¹l_rx
(
Ãt_deviû
 *
dev
, 
¹l8169_´iv©e
 *

, 
u32
 
budg‘
)

7438 
cur_rx
, 
rx_Ëá
;

7439 
couÁ
;

7441 
cur_rx
 = 

->cur_rx;

7443 
rx_Ëá
 = 
	`mš
(
budg‘
, 
NUM_RX_DESC
);„x_Ëá > 0;„x_Ëá--, 
cur_rx
++) {

7444 
’Œy
 = 
cur_rx
 % 
NUM_RX_DESC
;

7445 
RxDesc
 *
desc
 = 

->
RxDescA¼ay
 + 
’Œy
;

7446 
u32
 
¡©us
;

7448 
¡©us
 = 
	`Ë32_to_ıu
(
desc
->
İts1
è& 

->
İts1_mask
;

7449 ià(
¡©us
 & 
DescOwn
)

7456 
	`dma_rmb
();

7458 ià(
	`uÆik–y
(
¡©us
 & 
RxRES
)) {

7459 
	`Ãtif_šfo
(

, 
rx_”r
, 
dev
, "Rx ERROR. status = %08x\n",

7460 
¡©us
);

7461 
dev
->
¡©s
.
rx_”rÜs
++;

7462 ià(
¡©us
 & (
RxRWT
 | 
RxRUNT
))

7463 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

7464 ià(
¡©us
 & 
RxCRC
)

7465 
dev
->
¡©s
.
rx_üc_”rÜs
++;

7466 ià(
¡©us
 & 
RxFOVF
) {

7467 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7468 
dev
->
¡©s
.
rx_fifo_”rÜs
++;

7470 ià((
¡©us
 & (
RxRUNT
 | 
RxCRC
)) &&

7471 !(
¡©us
 & (
RxRWT
 | 
RxFOVF
)) &&

7472 (
dev
->
ã©u»s
 & 
NETIF_F_RXALL
))

7473 
´oûss_pkt
;

7475 
sk_buff
 *
skb
;

7476 
dma_addr_t
 
addr
;

7477 
pkt_size
;

7479 
´oûss_pkt
:

7480 
addr
 = 
	`Ë64_to_ıu
(
desc
->addr);

7481 ià(
	`lik–y
(!(
dev
->
ã©u»s
 & 
NETIF_F_RXFCS
)))

7482 
pkt_size
 = (
¡©us
 & 0x00003fff) - 4;

7484 
pkt_size
 = 
¡©us
 & 0x00003fff;

7491 ià(
	`uÆik–y
(
	`¹l8169_äagm’‹d_äame
(
¡©us
))) {

7492 
dev
->
¡©s
.
rx_drİ³d
++;

7493 
dev
->
¡©s
.
rx_Ëngth_”rÜs
++;

7494 
»Ëa£_desütÜ
;

7497 
skb
 = 
	`¹l8169_Œy_rx_cİy
(

->
Rx_d©abuff
[
’Œy
],

7498 

, 
pkt_size
, 
addr
);

7499 ià(!
skb
) {

7500 
dev
->
¡©s
.
rx_drİ³d
++;

7501 
»Ëa£_desütÜ
;

7504 
	`¹l8169_rx_csum
(
skb
, 
¡©us
);

7505 
	`skb_put
(
skb
, 
pkt_size
);

7506 
skb
->
´ÙocŞ
 = 
	`‘h_ty³_Œªs
(skb, 
dev
);

7508 
	`¹l8169_rx_vÏn_g
(
desc
, 
skb
);

7510 ià(
skb
->
pkt_ty³
 =ğ
PACKET_MULTICAST
)

7511 
dev
->
¡©s
.
muÉiÿ¡
++;

7513 
	`Çpi_gro_»ûive
(&

->
Çpi
, 
skb
);

7515 
	`u64_¡©s_upd©e_begš
(&

->
rx_¡©s
.
synı
);

7516 

->
rx_¡©s
.
·ck‘s
++;

7517 

->
rx_¡©s
.
by‹s
 +ğ
pkt_size
;

7518 
	`u64_¡©s_upd©e_’d
(&

->
rx_¡©s
.
synı
);

7520 
»Ëa£_desütÜ
:

7521 
desc
->
İts2
 = 0;

7522 
	`¹l8169_m¬k_to_asic
(
desc
, 
rx_buf_sz
);

7525 
couÁ
 = 
cur_rx
 - 

->cur_rx;

7526 

->
cur_rx
 = cur_rx;

7528  
couÁ
;

7529 
	}
}

7531 
œq»tuº_t
 
	$¹l8169_š‹¼u±
(
œq
, *
dev_š¡ªû
)

7533 
Ãt_deviû
 *
dev
 = 
dev_š¡ªû
;

7534 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7535 
hªdËd
 = 0;

7536 
u16
 
¡©us
;

7538 
¡©us
 = 
	`¹l_g‘_ev’ts
(

);

7539 ià(
¡©us
 && status != 0xffff) {

7540 
¡©us
 &ğ
RTL_EVENT_NAPI
 | 

->
ev’t_¦ow
;

7541 ià(
¡©us
) {

7542 
hªdËd
 = 1;

7544 
	`¹l_œq_di§bË
(

);

7545 
	`Çpi_scheduË
(&

->
Çpi
);

7548  
	`IRQ_RETVAL
(
hªdËd
);

7549 
	}
}

7554 
	$¹l_¦ow_ev’t_wÜk
(
¹l8169_´iv©e
 *

)

7556 
Ãt_deviû
 *
dev
 = 

->dev;

7557 
u16
 
¡©us
;

7559 
¡©us
 = 
	`¹l_g‘_ev’ts
(

è&p->
ev’t_¦ow
;

7560 
	`¹l_ack_ev’ts
(

, 
¡©us
);

7562 ià(
	`uÆik–y
(
¡©us
 & 
RxFIFOOv”
)) {

7563 

->
mac_v”siÚ
) {

7565 
RTL_GIGA_MAC_VER_11
:

7566 
	`Ãtif_¡İ_queue
(
dev
);

7568 
	`£t_b™
(
RTL_FLAG_TASK_RESET_PENDING
, 

->
wk
.
æags
);

7574 ià(
	`uÆik–y
(
¡©us
 & 
SYSE¼
))

7575 
	`¹l8169_pc›¼_š‹¼u±
(
dev
);

7577 ià(
¡©us
 & 
LškChg
)

7578 
	`__¹l8169_check_lšk_¡©us
(
dev
, 

,p->
mmio_addr
, 
Œue
);

7580 
	`¹l_œq_’abË_®l
(

);

7581 
	}
}

7583 
	$¹l_sk
(
wÜk_¡ruù
 *
wÜk
)

7586 
b™Ä
;

7587 (*
aùiÚ
)(
¹l8169_´iv©e
 *);

7588 } 
¹l_wÜk
[] = {

7590 { 
RTL_FLAG_TASK_SLOW_PENDING
, 
¹l_¦ow_ev’t_wÜk
 },

7591 { 
RTL_FLAG_TASK_RESET_PENDING
, 
¹l_»£t_wÜk
 },

7592 { 
RTL_FLAG_TASK_PHY_PENDING
, 
¹l_phy_wÜk
 }

7594 
¹l8169_´iv©e
 *

 =

7595 
	`cÚš”_of
(
wÜk
, 
¹l8169_´iv©e
, 
wk
.work);

7596 
Ãt_deviû
 *
dev
 = 

->dev;

7597 
i
;

7599 
	`¹l_lock_wÜk
(

);

7601 ià(!
	`Ãtif_ruÂšg
(
dev
) ||

7602 !
	`‹¡_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
))

7603 
out_uÆock
;

7605 
i
 = 0; i < 
	`ARRAY_SIZE
(
¹l_wÜk
); i++) {

7606 
boŞ
 
³ndšg
;

7608 
³ndšg
 = 
	`‹¡_ªd_ş—r_b™
(
¹l_wÜk
[
i
].
b™Ä
, 

->
wk
.
æags
);

7609 ià(
³ndšg
)

7610 
¹l_wÜk
[
i
].
	`aùiÚ
(

);

7613 
out_uÆock
:

7614 
	`¹l_uÆock_wÜk
(

);

7615 
	}
}

7617 
	$¹l8169_pŞl
(
Çpi_¡ruù
 *
Çpi
, 
budg‘
)

7619 
¹l8169_´iv©e
 *

 = 
	`cÚš”_of
(
Çpi
, rtl8169_private,‚api);

7620 
Ãt_deviû
 *
dev
 = 

->dev;

7621 
u16
 
’abË_mask
 = 
RTL_EVENT_NAPI
 | 

->
ev’t_¦ow
;

7622 
wÜk_dÚe
= 0;

7623 
u16
 
¡©us
;

7625 
¡©us
 = 
	`¹l_g‘_ev’ts
(

);

7626 
	`¹l_ack_ev’ts
(

, 
¡©us
 & ~->
ev’t_¦ow
);

7628 ià(
¡©us
 & 
RTL_EVENT_NAPI_RX
)

7629 
wÜk_dÚe
 = 
	`¹l_rx
(
dev
, 

, (
u32
è
budg‘
);

7631 ià(
¡©us
 & 
RTL_EVENT_NAPI_TX
)

7632 
	`¹l_tx
(
dev
, 

);

7634 ià(
¡©us
 & 

->
ev’t_¦ow
) {

7635 
’abË_mask
 &ğ~

->
ev’t_¦ow
;

7637 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_SLOW_PENDING
);

7640 ià(
wÜk_dÚe
 < 
budg‘
) {

7641 
	`Çpi_com¶‘e
(
Çpi
);

7643 
	`¹l_œq_’abË
(

, 
’abË_mask
);

7644 
	`mmiowb
();

7647  
wÜk_dÚe
;

7648 
	}
}

7650 
	$¹l8169_rx_mis£d
(
Ãt_deviû
 *
dev
, 
__iomem
 *
ißddr
)

7652 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7654 ià(

->
mac_v”siÚ
 > 
RTL_GIGA_MAC_VER_06
)

7657 
dev
->
¡©s
.
rx_mis£d_”rÜs
 +ğ(
	`RTL_R32
(
RxMis£d
) & 0xffffff);

7658 
	`RTL_W32
(
RxMis£d
, 0);

7659 
	}
}

7661 
	$¹l8169_down
(
Ãt_deviû
 *
dev
)

7663 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7664 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7666 
	`d–_tim”_sync
(&

->
tim”
);

7668 
	`Çpi_di§bË
(&

->
Çpi
);

7669 
	`Ãtif_¡İ_queue
(
dev
);

7671 
	`¹l8169_hw_»£t
(

);

7677 
	`¹l8169_rx_mis£d
(
dev
, 
ißddr
);

7680 
	`synchrÚize_sched
();

7682 
	`¹l8169_tx_ş—r
(

);

7684 
	`¹l8169_rx_ş—r
(

);

7686 
	`¹l_¶l_pow”_down
(

);

7687 
	}
}

7689 
	$¹l8169_şo£
(
Ãt_deviû
 *
dev
)

7691 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7692 
pci_dev
 *
pdev
 = 

->pci_dev;

7694 
	`pm_ruÁime_g‘_sync
(&
pdev
->
dev
);

7697 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7699 
	`¹l_lock_wÜk
(

);

7700 
	`ş—r_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7702 
	`¹l8169_down
(
dev
);

7703 
	`¹l_uÆock_wÜk
(

);

7705 
	`ÿnûl_wÜk_sync
(&

->
wk
.
wÜk
);

7707 
	`ä“_œq
(
pdev
->
œq
, 
dev
);

7709 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
, 

->
RxDescA¼ay
,

7710 

->
RxPhyAddr
);

7711 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
, 

->
TxDescA¼ay
,

7712 

->
TxPhyAddr
);

7713 

->
TxDescA¼ay
 = 
NULL
;

7714 

->
RxDescA¼ay
 = 
NULL
;

7716 
	`pm_ruÁime_put_sync
(&
pdev
->
dev
);

7719 
	}
}

7721 #ifdeà
CONFIG_NET_POLL_CONTROLLER


7722 
	$¹l8169_ÃŞl
(
Ãt_deviû
 *
dev
)

7724 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7726 
	`¹l8169_š‹¼u±
(

->
pci_dev
->
œq
, 
dev
);

7727 
	}
}

7730 
	$¹l8169_xdp_£t
(
Ãt_deviû
 *
dev
, 
bpf_´og
 *
´og
)

7732 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7733 
bpf_´og
 *
Şd_´og
;

7735 
	`¹l_lock_wÜk
(

);

7738 
Şd_´og
 = 
	`rcu_d”eã»nû_´Ùeùed
(

->
xdp_´og
, 
	`¹l_wÜk_lock_h–d
(tp));

7739 
	`rcu_assign_poš‹r
(

->
xdp_´og
, 
´og
);

7740 ià(
´og
) {

7741 
	`bpf_´og_add
(
´og
, 1);

7743 
	`synchrÚize_rcu
();

7744 ià(
Şd_´og
) {

7745 
	`bpf_´og_put
(
Şd_´og
);

7747 

->
xdp_couÁ”s
.
£t
++;

7748 
	`¹l_uÆock_wÜk
(

);

7750 
	}
}

7752 
boŞ
 
	$¹l8169_xdp_©ched
(
Ãt_deviû
 *
dev
)

7754 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7755  !!

->
xdp_´og
;

7756 
	}
}

7758 
	$¹l8169_xdp
(
Ãt_deviû
 *
dev
, 
Ãtdev_bpf
 *
xdp
)

7760 
xdp
->
commªd
) {

7761 
XDP_SETUP_PROG
:

7762  
	`¹l8169_xdp_£t
(
dev
, 
xdp
->
´og
);

7763 
XDP_QUERY_PROG
:

7764 
xdp
->
´og_©ched
 = 
	`¹l8169_xdp_©ched
(
dev
);

7767  -
EINVAL
;

7769 
	}
}

7771 
	$¹l_İ’
(
Ãt_deviû
 *
dev
)

7773 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7774 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7775 
pci_dev
 *
pdev
 = 

->pci_dev;

7776 
»tv®
 = -
ENOMEM
;

7778 
	`pm_ruÁime_g‘_sync
(&
pdev
->
dev
);

7784 

->
TxDescA¼ay
 = 
	`dma_®loc_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
,

7785 &

->
TxPhyAddr
, 
GFP_KERNEL
);

7786 ià(!

->
TxDescA¼ay
)

7787 
”r_pm_ruÁime_put
;

7789 

->
RxDescA¼ay
 = 
	`dma_®loc_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
,

7790 &

->
RxPhyAddr
, 
GFP_KERNEL
);

7791 ià(!

->
RxDescA¼ay
)

7792 
”r_ä“_tx_0
;

7794 
»tv®
 = 
	`¹l8169_š™_ršg
(
dev
);

7795 ià(
»tv®
 < 0)

7796 
”r_ä“_rx_1
;

7798 
	`INIT_WORK
(&

->
wk
.
wÜk
, 
¹l_sk
);

7800 
	`smp_mb
();

7802 
	`¹l_»que¡_fœmw¬e
(

);

7804 
»tv®
 = 
	`»que¡_œq
(
pdev
->
œq
, 
¹l8169_š‹¼u±
,

7805 (

->
ã©u»s
 & 
RTL_FEATURE_MSI
è? 0 : 
IRQF_SHARED
,

7806 
dev
->
Çme
, dev);

7807 ià(
»tv®
 < 0)

7808 
”r_»Ëa£_fw_2
;

7810 
	`¹l_lock_wÜk
(

);

7812 
	`£t_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7814 
	`Çpi_’abË
(&

->
Çpi
);

7816 
	`¹l8169_š™_phy
(
dev
, 

);

7818 
	`__¹l8169_£t_ã©u»s
(
dev
, dev->
ã©u»s
);

7820 
	`¹l_¶l_pow”_up
(

);

7822 
	`¹l_hw_¡¬t
(
dev
);

7824 ià(!
	`¹l8169_š™_couÁ”_off£ts
(
dev
))

7825 
	`Ãtif_w¬n
(

, 
hw
, 
dev
, "counter„eset/update failed\n");

7827 
	`Ãtif_¡¬t_queue
(
dev
);

7829 
	`¹l_uÆock_wÜk
(

);

7831 

->
§ved_wŞİts
 = 0;

7832 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

7834 
	`¹l8169_check_lšk_¡©us
(
dev
, 

, 
ißddr
);

7835 
out
:

7836  
»tv®
;

7838 
”r_»Ëa£_fw_2
:

7839 
	`¹l_»Ëa£_fœmw¬e
(

);

7840 
	`¹l8169_rx_ş—r
(

);

7841 
”r_ä“_rx_1
:

7842 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_RX_RING_BYTES
, 

->
RxDescA¼ay
,

7843 

->
RxPhyAddr
);

7844 

->
RxDescA¼ay
 = 
NULL
;

7845 
”r_ä“_tx_0
:

7846 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, 
R8169_TX_RING_BYTES
, 

->
TxDescA¼ay
,

7847 

->
TxPhyAddr
);

7848 

->
TxDescA¼ay
 = 
NULL
;

7849 
”r_pm_ruÁime_put
:

7850 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

7851 
out
;

7852 
	}
}

7855 
	$¹l8169_g‘_¡©s64
(
Ãt_deviû
 *
dev
, 
¹Æ_lšk_¡©s64
 *
¡©s
)

7857 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7858 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

7859 
pci_dev
 *
pdev
 = 

->pci_dev;

7860 
¹l8169_couÁ”s
 *
couÁ”s
 = 

->counters;

7861 
¡¬t
;

7863 
	`pm_ruÁime_g‘_nÜesume
(&
pdev
->
dev
);

7865 ià(
	`Ãtif_ruÂšg
(
dev
è&& 
	`pm_ruÁime_aùive
(&
pdev
->dev))

7866 
	`¹l8169_rx_mis£d
(
dev
, 
ißddr
);

7869 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
rx_¡©s
.
synı
);

7870 
¡©s
->
rx_·ck‘s
 = 

->
rx_¡©s
.
·ck‘s
;

7871 
¡©s
->
rx_by‹s
 = 

->
rx_¡©s
.
by‹s
;

7872 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
rx_¡©s
.
synı
, 
¡¬t
));

7875 
¡¬t
 = 
	`u64_¡©s_ãtch_begš_œq
(&

->
tx_¡©s
.
synı
);

7876 
¡©s
->
tx_·ck‘s
 = 

->
tx_¡©s
.
·ck‘s
;

7877 
¡©s
->
tx_by‹s
 = 

->
tx_¡©s
.
by‹s
;

7878 } 
	`u64_¡©s_ãtch_»Œy_œq
(&

->
tx_¡©s
.
synı
, 
¡¬t
));

7880 
¡©s
->
rx_drİ³d
 = 
dev
->stats.rx_dropped;

7881 
¡©s
->
tx_drİ³d
 = 
dev
->stats.tx_dropped;

7882 
¡©s
->
rx_Ëngth_”rÜs
 = 
dev
->stats.rx_length_errors;

7883 
¡©s
->
rx_”rÜs
 = 
dev
->stats.rx_errors;

7884 
¡©s
->
rx_üc_”rÜs
 = 
dev
->stats.rx_crc_errors;

7885 
¡©s
->
rx_fifo_”rÜs
 = 
dev
->stats.rx_fifo_errors;

7886 
¡©s
->
rx_mis£d_”rÜs
 = 
dev
->stats.rx_missed_errors;

7887 
¡©s
->
muÉiÿ¡
 = 
dev
->stats.multicast;

7893 ià(
	`pm_ruÁime_aùive
(&
pdev
->
dev
))

7894 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7900 
¡©s
->
tx_”rÜs
 = 
	`Ë64_to_ıu
(
couÁ”s
->tx_errors) -

7901 
	`Ë64_to_ıu
(

->
tc_off£t
.
tx_”rÜs
);

7902 
¡©s
->
cŞlisiÚs
 = 
	`Ë32_to_ıu
(
couÁ”s
->
tx_muÉi_cŞlisiÚ
) -

7903 
	`Ë32_to_ıu
(

->
tc_off£t
.
tx_muÉi_cŞlisiÚ
);

7904 
¡©s
->
tx_abÜ‹d_”rÜs
 = 
	`Ë16_to_ıu
(
couÁ”s
->
tx_abÜ‹d
) -

7905 
	`Ë16_to_ıu
(

->
tc_off£t
.
tx_abÜ‹d
);

7907 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

7910 
	}
}

7912 
	$¹l8169_Ãt_su¥’d
(
Ãt_deviû
 *
dev
)

7914 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7916 ià(!
	`Ãtif_ruÂšg
(
dev
))

7919 
	`Ãtif_deviû_d‘ach
(
dev
);

7920 
	`Ãtif_¡İ_queue
(
dev
);

7922 
	`¹l_lock_wÜk
(

);

7923 
	`Çpi_di§bË
(&

->
Çpi
);

7924 
	`ş—r_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7925 
	`¹l_uÆock_wÜk
(

);

7927 
	`¹l_¶l_pow”_down
(

);

7928 
	}
}

7930 #ifdeà
CONFIG_PM


7932 
	$¹l8169_su¥’d
(
deviû
 *device)

7934 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7935 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7937 
	`¹l8169_Ãt_su¥’d
(
dev
);

7940 
	}
}

7942 
	$__¹l8169_»sume
(
Ãt_deviû
 *
dev
)

7944 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7946 
	`Ãtif_deviû_©ch
(
dev
);

7948 
	`¹l_¶l_pow”_up
(

);

7950 
	`¹l_lock_wÜk
(

);

7951 
	`Çpi_’abË
(&

->
Çpi
);

7952 
	`£t_b™
(
RTL_FLAG_TASK_ENABLED
, 

->
wk
.
æags
);

7953 
	`¹l_uÆock_wÜk
(

);

7955 
	`¹l_scheduË_sk
(

, 
RTL_FLAG_TASK_RESET_PENDING
);

7956 
	}
}

7958 
	$¹l8169_»sume
(
deviû
 *device)

7960 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7961 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7962 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7964 
	`¹l8169_š™_phy
(
dev
, 

);

7966 ià(
	`Ãtif_ruÂšg
(
dev
))

7967 
	`__¹l8169_»sume
(
dev
);

7970 
	}
}

7972 
	$¹l8169_ruÁime_su¥’d
(
deviû
 *device)

7974 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7975 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7976 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

7978 ià(!

->
TxDescA¼ay
)

7981 
	`¹l_lock_wÜk
(

);

7982 

->
§ved_wŞİts
 = 
	`__¹l8169_g‘_wŞ
(tp);

7983 
	`__¹l8169_£t_wŞ
(

, 
WAKE_ANY
);

7984 
	`¹l_uÆock_wÜk
(

);

7986 
	`¹l8169_Ãt_su¥’d
(
dev
);

7989 
	`¹l8169_rx_mis£d
(
dev
, 

->
mmio_addr
);

7990 
	`¹l8169_upd©e_couÁ”s
(
dev
);

7993 
	}
}

7995 
	$¹l8169_ruÁime_»sume
(
deviû
 *device)

7997 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

7998 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

7999 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

8000 
	`¹l_¿r_£t
(

, 
dev
->
dev_addr
);

8002 ià(!

->
TxDescA¼ay
)

8005 
	`¹l_lock_wÜk
(

);

8006 
	`__¹l8169_£t_wŞ
(

,p->
§ved_wŞİts
);

8007 

->
§ved_wŞİts
 = 0;

8008 
	`¹l_uÆock_wÜk
(

);

8010 
	`¹l8169_š™_phy
(
dev
, 

);

8012 
	`__¹l8169_»sume
(
dev
);

8015 
	}
}

8017 
	$¹l8169_ruÁime_idË
(
deviû
 *device)

8019 
pci_dev
 *
pdev
 = 
	`to_pci_dev
(
deviû
);

8020 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

8021 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

8023  

->
TxDescA¼ay
 ? -
EBUSY
 : 0;

8024 
	}
}

8026 cÚ¡ 
dev_pm_İs
 
	g¹l8169_pm_İs
 = {

8027 .
su¥’d
 = 
¹l8169_su¥’d
,

8028 .
	g»sume
 = 
¹l8169_»sume
,

8029 .
	gä“ze
 = 
¹l8169_su¥’d
,

8030 .
	gthaw
 = 
¹l8169_»sume
,

8031 .
	gpow”off
 = 
¹l8169_su¥’d
,

8032 .
	g»¡Üe
 = 
¹l8169_»sume
,

8033 .
	gruÁime_su¥’d
 = 
¹l8169_ruÁime_su¥’d
,

8034 .
	gruÁime_»sume
 = 
¹l8169_ruÁime_»sume
,

8035 .
	gruÁime_idË
 = 
¹l8169_ruÁime_idË
,

8038 
	#RTL8169_PM_OPS
 (&
¹l8169_pm_İs
)

	)

8042 
	#RTL8169_PM_OPS
 
NULL


	)

8046 
	$¹l_wŞ_shutdown_quœk
(
¹l8169_´iv©e
 *

)

8048 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

8051 

->
mac_v”siÚ
) {

8052 
RTL_GIGA_MAC_VER_11
:

8053 
RTL_GIGA_MAC_VER_12
:

8054 
RTL_GIGA_MAC_VER_17
:

8055 
	`pci_ş—r_ma¡”
(

->
pci_dev
);

8057 
	`RTL_W8
(
ChCmd
, 
CmdRxEnb
);

8059 
	`RTL_R8
(
ChCmd
);

8064 
	}
}

8066 
	$¹l_shutdown
(
pci_dev
 *
pdev
)

8068 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

8069 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

8070 
deviû
 *
d
 = &
pdev
->
dev
;

8072 
	`pm_ruÁime_g‘_sync
(
d
);

8074 
	`¹l8169_Ãt_su¥’d
(
dev
);

8077 
	`¹l_¿r_£t
(

, 
dev
->
³rm_addr
);

8079 
	`¹l8169_hw_»£t
(

);

8081 ià(
sy¡em_¡©e
 =ğ
SYSTEM_POWER_OFF
) {

8082 ià(
	`__¹l8169_g‘_wŞ
(

è& 
WAKE_ANY
) {

8083 
	`¹l_wŞ_su¥’d_quœk
(

);

8084 
	`¹l_wŞ_shutdown_quœk
(

);

8087 
	`pci_wake_äom_d3
(
pdev
, 
Œue
);

8088 
	`pci_£t_pow”_¡©e
(
pdev
, 
PCI_D3hÙ
);

8091 
	`pm_ruÁime_put_noidË
(
d
);

8092 
	}
}

8094 
	$¹l_»move_Úe
(
pci_dev
 *
pdev
)

8096 
Ãt_deviû
 *
dev
 = 
	`pci_g‘_drvd©a
(
pdev
);

8097 
¹l8169_´iv©e
 *

 = 
	`Ãtdev_´iv
(
dev
);

8099 ià((

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_27
 ||

8100 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_28
 ||

8101 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
 ||

8102 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

8103 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

8104 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) &&

8105 
	`r8168_check_dash
(

)) {

8106 
	`¹l8168_driv”_¡İ
(

);

8109 
	`Ãtif_Çpi_d–
(&

->
Çpi
);

8111 
	`uÄegi¡”_Ãtdev
(
dev
);

8113 
	`dma_ä“_coh”’t
(&

->
pci_dev
->
dev
, (*->
couÁ”s
),

8114 

->
couÁ”s
,p->
couÁ”s_phys_addr
);

8116 
	`¹l_»Ëa£_fœmw¬e
(

);

8118 ià(
	`pci_dev_run_wake
(
pdev
))

8119 
	`pm_ruÁime_g‘_nÜesume
(&
pdev
->
dev
);

8122 
	`¹l_¿r_£t
(

, 
dev
->
³rm_addr
);

8124 
	`¹l_di§bË_msi
(
pdev
, 

);

8125 
	`¹l8169_»Ëa£_bßrd
(
pdev
, 
dev
, 

->
mmio_addr
);

8126 
	}
}

8128 cÚ¡ 
Ãt_deviû_İs
 
	g¹l_Ãtdev_İs
 = {

8129 .
ndo_İ’
 = 
¹l_İ’
,

8130 .
	gndo_¡İ
 = 
¹l8169_şo£
,

8131 .
	gndo_g‘_¡©s64
 = 
¹l8169_g‘_¡©s64
,

8132 .
	gndo_¡¬t_xm™
 = 
¹l8169_¡¬t_xm™
,

8133 .
	gndo_tx_timeout
 = 
¹l8169_tx_timeout
,

8134 .
	gndo_v®id©e_addr
 = 
‘h_v®id©e_addr
,

8135 .
	gndo_chªge_mtu
 = 
¹l8169_chªge_mtu
,

8136 .
	gndo_fix_ã©u»s
 = 
¹l8169_fix_ã©u»s
,

8137 .
	gndo_£t_ã©u»s
 = 
¹l8169_£t_ã©u»s
,

8138 .
	gndo_£t_mac_add»ss
 = 
¹l_£t_mac_add»ss
,

8139 .
	gndo_do_ioùl
 = 
¹l8169_ioùl
,

8140 .
	gndo_£t_rx_mode
 = 
¹l_£t_rx_mode
,

8141 #ifdeà
CONFIG_NET_POLL_CONTROLLER


8142 .
	gndo_pŞl_cÚŒŞËr
 = 
¹l8169_ÃŞl
,

8144 .
	gndo_bpf
 = 
¹l8169_xdp
,

8148 cÚ¡ 
	s¹l_cfg_šfo
 {

8149 (*
	mhw_¡¬t
)(
	mÃt_deviû
 *);

8150 
	m»giÚ
;

8151 
	m®ign
;

8152 
u16
 
	mev’t_¦ow
;

8153 
	mã©u»s
;

8154 
u8
 
	mdeçuÉ_v”
;

8155 } 
	g¹l_cfg_šfos
 [] = {

8156 [
RTL_CFG_0
] = {

8157 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8169
,

8158 .
	g»giÚ
 = 1,

8159 .
	g®ign
 = 0,

8160 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
 | 
RxFIFOOv”
,

8161 .
	gã©u»s
 = 
RTL_FEATURE_GMII
,

8162 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_01
,

8164 [
RTL_CFG_1
] = {

8165 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8168
,

8166 .
	g»giÚ
 = 2,

8167 .
	g®ign
 = 8,

8168 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
,

8169 .
	gã©u»s
 = 
RTL_FEATURE_GMII
 | 
RTL_FEATURE_MSI
,

8170 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_11
,

8172 [
RTL_CFG_2
] = {

8173 .
hw_¡¬t
 = 
¹l_hw_¡¬t_8101
,

8174 .
	g»giÚ
 = 2,

8175 .
	g®ign
 = 8,

8176 .
	gev’t_¦ow
 = 
SYSE¼
 | 
LškChg
 | 
RxOv”æow
 | 
RxFIFOOv”
 |

8177 
PCSTimeout
,

8178 .
	gã©u»s
 = 
RTL_FEATURE_MSI
,

8179 .
	gdeçuÉ_v”
 = 
RTL_GIGA_MAC_VER_13
,

8184 
	$¹l_Œy_msi
(
¹l8169_´iv©e
 *

,

8185 cÚ¡ 
¹l_cfg_šfo
 *
cfg
)

8187 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

8188 
msi
 = 0;

8189 
u8
 
cfg2
;

8191 
cfg2
 = 
	`RTL_R8
(
CÚfig2
è& ~
MSIEÇbË
;

8192 ià(
cfg
->
ã©u»s
 & 
RTL_FEATURE_MSI
) {

8193 ià(
	`pci_’abË_msi
(

->
pci_dev
)) {

8194 
	`Ãtif_šfo
(

, 
hw
,p->
dev
, "no MSI. Backo INTx.\n");

8196 
cfg2
 |ğ
MSIEÇbË
;

8197 
msi
 = 
RTL_FEATURE_MSI
;

8200 ià(

->
mac_v”siÚ
 <ğ
RTL_GIGA_MAC_VER_06
)

8201 
	`RTL_W8
(
CÚfig2
, 
cfg2
);

8202  
msi
;

8203 
	}
}

8205 
	$DECLARE_RTL_COND
(
¹l_lšk_li¡_»ady_cÚd
)

8207 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

8209  
	`RTL_R8
(
MCU
è& 
LINK_LIST_RDY
;

8210 
	}
}

8212 
	$DECLARE_RTL_COND
(
¹l_rxtx_em±y_cÚd
)

8214 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

8216  (
	`RTL_R8
(
MCU
è& 
RXTX_EMPTY
) == RXTX_EMPTY;

8217 
	}
}

8219 
	$¹l_hw_š™_8168g
(
¹l8169_´iv©e
 *

)

8221 
__iomem
 *
ißddr
 = 

->
mmio_addr
;

8222 
u32
 
d©a
;

8224 

->
oı_ba£
 = 
OCP_STD_PHY_BASE
;

8226 
	`RTL_W32
(
MISC
, 
	`RTL_R32
(MISCè| 
RXDV_GATED_EN
);

8228 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_txcfg_em±y_cÚd
, 100, 42))

8231 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_rxtx_em±y_cÚd
, 100, 42))

8234 
	`RTL_W8
(
ChCmd
, 
	`RTL_R8
(ChCmdè& ~(
CmdTxEnb
 | 
CmdRxEnb
));

8235 
	`m¦“p
(1);

8236 
	`RTL_W8
(
MCU
, 
	`RTL_R8
(MCUè& ~
NOW_IS_OOB
);

8238 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe8de);

8239 
d©a
 &= ~(1 << 14);

8240 
	`r8168_mac_oı_wr™e
(

, 0xe8de, 
d©a
);

8242 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_lšk_li¡_»ady_cÚd
, 100, 42))

8245 
d©a
 = 
	`r8168_mac_oı_»ad
(

, 0xe8de);

8246 
d©a
 |= (1 << 15);

8247 
	`r8168_mac_oı_wr™e
(

, 0xe8de, 
d©a
);

8249 ià(!
	`¹l_ud–ay_loİ_wa™_high
(

, &
¹l_lšk_li¡_»ady_cÚd
, 100, 42))

8251 
	}
}

8253 
	$¹l_hw_š™_8168•
(
¹l8169_´iv©e
 *

)

8255 
	`¹l8168•_¡İ_cmac
(

);

8256 
	`¹l_hw_š™_8168g
(

);

8257 
	}
}

8259 
	$¹l_hw_š™Ÿlize
(
¹l8169_´iv©e
 *

)

8261 

->
mac_v”siÚ
) {

8262 
RTL_GIGA_MAC_VER_40
:

8263 
RTL_GIGA_MAC_VER_41
:

8264 
RTL_GIGA_MAC_VER_42
:

8265 
RTL_GIGA_MAC_VER_43
:

8266 
RTL_GIGA_MAC_VER_44
:

8267 
RTL_GIGA_MAC_VER_45
:

8268 
RTL_GIGA_MAC_VER_46
:

8269 
RTL_GIGA_MAC_VER_47
:

8270 
RTL_GIGA_MAC_VER_48
:

8271 
	`¹l_hw_š™_8168g
(

);

8273 
RTL_GIGA_MAC_VER_49
:

8274 
RTL_GIGA_MAC_VER_50
:

8275 
RTL_GIGA_MAC_VER_51
:

8276 
	`¹l_hw_š™_8168•
(

);

8281 
	}
}

8283 
	$¹l_š™_Úe
(
pci_dev
 *
pdev
, cÚ¡ 
pci_deviû_id
 *
’t
)

8285 cÚ¡ 
¹l_cfg_šfo
 *
cfg
 = 
¹l_cfg_šfos
 + 
’t
->
driv”_d©a
;

8286 cÚ¡ 
»giÚ
 = 
cfg
->region;

8287 
¹l8169_´iv©e
 *

;

8288 
mii_if_šfo
 *
mii
;

8289 
Ãt_deviû
 *
dev
;

8290 
__iomem
 *
ißddr
;

8291 
ch£t
, 
i
;

8292 
rc
;

8294 ià(
	`Ãtif_msg_drv
(&
debug
)) {

8295 
	`´štk
(
KERN_INFO
 "%s Gigabit Ethernet driver %s†oaded\n",

8296 
MODULENAME
, 
RTL8169_VERSION
);

8299 
dev
 = 
	`®loc_‘h”dev
( (*

));

8300 ià(!
dev
) {

8301 
rc
 = -
ENOMEM
;

8302 
out
;

8305 
	`SET_NETDEV_DEV
(
dev
, &
pdev
->dev);

8306 
dev
->
Ãtdev_İs
 = &
¹l_Ãtdev_İs
;

8307 

 = 
	`Ãtdev_´iv
(
dev
);

8308 

->
dev
 = dev;

8309 

->
pci_dev
 = 
pdev
;

8310 

->
msg_’abË
 = 
	`Ãtif_msg_š™
(
debug
.msg_’abË, 
R8169_MSG_DEFAULT
);

8312 
mii
 = &

->mii;

8313 
mii
->
dev
 = dev;

8314 
mii
->
mdio_»ad
 = 
¹l_mdio_»ad
;

8315 
mii
->
mdio_wr™e
 = 
¹l_mdio_wr™e
;

8316 
mii
->
phy_id_mask
 = 0x1f;

8317 
mii
->
»g_num_mask
 = 0x1f;

8318 
mii
->
suµÜts_gmii
 = !!(
cfg
->
ã©u»s
 & 
RTL_FEATURE_GMII
);

8322 
	`pci_di§bË_lšk_¡©e
(
pdev
, 
PCIE_LINK_STATE_L0S
 | 
PCIE_LINK_STATE_L1
 |

8323 
PCIE_LINK_STATE_CLKPM
);

8326 
rc
 = 
	`pci_’abË_deviû
(
pdev
);

8327 ià(
rc
 < 0) {

8328 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "enable failure\n");

8329 
”r_out_ä“_dev_1
;

8332 ià(
	`pci_£t_mwi
(
pdev
) < 0)

8333 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "Mem-Wr-Inval unavailable\n");

8336 ià(!(
	`pci_»sourû_æags
(
pdev
, 
»giÚ
è& 
IORESOURCE_MEM
)) {

8337 
	`Ãtif_”r
(

, 
´obe
, 
dev
,

8339 
»giÚ
);

8340 
rc
 = -
ENODEV
;

8341 
”r_out_mwi_2
;

8345 ià(
	`pci_»sourû_Ën
(
pdev
, 
»giÚ
è< 
R8169_REGS_SIZE
) {

8346 
	`Ãtif_”r
(

, 
´obe
, 
dev
,

8348 
rc
 = -
ENODEV
;

8349 
”r_out_mwi_2
;

8352 
rc
 = 
	`pci_»que¡_»giÚs
(
pdev
, 
MODULENAME
);

8353 ià(
rc
 < 0) {

8354 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "could‚ot„equest„egions\n");

8355 
”r_out_mwi_2
;

8359 
ißddr
 = 
	`iÜem­
(
	`pci_»sourû_¡¬t
(
pdev
, 
»giÚ
), 
R8169_REGS_SIZE
);

8360 ià(!
ißddr
) {

8361 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "cannot„emap MMIO,‡borting\n");

8362 
rc
 = -
EIO
;

8363 
”r_out_ä“_»s_3
;

8365 

->
mmio_addr
 = 
ißddr
;

8367 ià(!
	`pci_is_pc›
(
pdev
))

8368 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "not PCI Express\n");

8371 
	`¹l8169_g‘_mac_v”siÚ
(

, 
dev
, 
cfg
->
deçuÉ_v”
);

8373 

->
ı_cmd
 = 0;

8375 ià(((
dma_addr_t
) > 4) &&

8376 (
u£_dac
 =ğ1 || (u£_daø=ğ-1 && 
	`pci_is_pc›
(
pdev
) &&

8377 

->
mac_v”siÚ
 >ğ
RTL_GIGA_MAC_VER_18
)) &&

8378 !
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64)) &&

8379 !
	`pci_£t_cÚsi¡’t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(64))) {

8382 ià(!
	`pci_is_pc›
(
pdev
))

8383 

->
ı_cmd
 |ğ
PCIDAC
;

8384 
dev
->
ã©u»s
 |ğ
NETIF_F_HIGHDMA
;

8386 
rc
 = 
	`pci_£t_dma_mask
(
pdev
, 
	`DMA_BIT_MASK
(32));

8387 ià(
rc
 < 0) {

8388 
	`Ãtif_”r
(

, 
´obe
, 
dev
, "DMA configuration failed\n");

8389 
”r_out_unm­_4
;

8393 
	`¹l_š™_rxcfg
(

);

8395 
	`¹l_œq_di§bË
(

);

8397 
	`¹l_hw_š™Ÿlize
(

);

8399 
	`¹l_hw_»£t
(

);

8401 
	`¹l_ack_ev’ts
(

, 0xffff);

8403 
	`pci_£t_ma¡”
(
pdev
);

8405 
	`¹l_š™_mdio_İs
(

);

8406 
	`¹l_š™_¶l_pow”_İs
(

);

8407 
	`¹l_š™_jumbo_İs
(

);

8408 
	`¹l_š™_csi_İs
(

);

8410 
	`¹l8169_´št_mac_v”siÚ
(

);

8412 
ch£t
 = 

->
mac_v”siÚ
;

8413 

->
txd_v”siÚ
 = 
¹l_ch_šfos
[
ch£t
].txd_version;

8415 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_UÆock
);

8416 
	`RTL_W8
(
CÚfig1
, 
	`RTL_R8
(CÚfig1è| 
PMEÇbË
);

8417 
	`RTL_W8
(
CÚfig5
, 
	`RTL_R8
(CÚfig5è& (
BWF
 | 
MWF
 | 
UWF
 | 
LªWake
 | 
PMEStus
));

8418 

->
mac_v”siÚ
) {

8419 
RTL_GIGA_MAC_VER_34
:

8420 
RTL_GIGA_MAC_VER_35
:

8421 
RTL_GIGA_MAC_VER_36
:

8422 
RTL_GIGA_MAC_VER_37
:

8423 
RTL_GIGA_MAC_VER_38
:

8424 
RTL_GIGA_MAC_VER_40
:

8425 
RTL_GIGA_MAC_VER_41
:

8426 
RTL_GIGA_MAC_VER_42
:

8427 
RTL_GIGA_MAC_VER_43
:

8428 
RTL_GIGA_MAC_VER_44
:

8429 
RTL_GIGA_MAC_VER_45
:

8430 
RTL_GIGA_MAC_VER_46
:

8431 
RTL_GIGA_MAC_VER_47
:

8432 
RTL_GIGA_MAC_VER_48
:

8433 
RTL_GIGA_MAC_VER_49
:

8434 
RTL_GIGA_MAC_VER_50
:

8435 
RTL_GIGA_MAC_VER_51
:

8436 ià(
	`¹l_”i_»ad
(

, 0xdc, 
ERIAR_EXGMAC
è& 
MagicPack‘_v2
)

8437 

->
ã©u»s
 |ğ
RTL_FEATURE_WOL
;

8438 ià((
	`RTL_R8
(
CÚfig3
è& 
LškUp
) != 0)

8439 

->
ã©u»s
 |ğ
RTL_FEATURE_WOL
;

8442 ià((
	`RTL_R8
(
CÚfig3
è& (
LškUp
 | 
MagicPack‘
)) != 0)

8443 

->
ã©u»s
 |ğ
RTL_FEATURE_WOL
;

8446 ià((
	`RTL_R8
(
CÚfig5
è& (
UWF
 | 
BWF
 | 
MWF
)) != 0)

8447 

->
ã©u»s
 |ğ
RTL_FEATURE_WOL
;

8448 

->
ã©u»s
 |ğ
	`¹l_Œy_msi
Ñp, 
cfg
);

8449 
	`RTL_W8
(
Cfg9346
, 
Cfg9346_Lock
);

8451 ià(
	`¹l_tbi_’abËd
(

)) {

8452 

->
£t_¥“d
 = 
¹l8169_£t_¥“d_tbi
;

8453 

->
g‘_£‰šgs
 = 
¹l8169_g£t_tbi
;

8454 

->
phy_»£t_’abË
 = 
¹l8169_tbi_»£t_’abË
;

8455 

->
phy_»£t_³ndšg
 = 
¹l8169_tbi_»£t_³ndšg
;

8456 

->
lšk_ok
 = 
¹l8169_tbi_lšk_ok
;

8457 

->
do_ioùl
 = 
¹l_tbi_ioùl
;

8459 

->
£t_¥“d
 = 
¹l8169_£t_¥“d_xmii
;

8460 

->
g‘_£‰šgs
 = 
¹l8169_g£t_xmii
;

8461 

->
phy_»£t_’abË
 = 
¹l8169_xmii_»£t_’abË
;

8462 

->
phy_»£t_³ndšg
 = 
¹l8169_xmii_»£t_³ndšg
;

8463 

->
lšk_ok
 = 
¹l8169_xmii_lšk_ok
;

8464 

->
do_ioùl
 = 
¹l_xmii_ioùl
;

8467 
	`mu‹x_š™
(&

->
wk
.
mu‹x
);

8468 
	`u64_¡©s_š™
(&

->
rx_¡©s
.
synı
);

8469 
	`u64_¡©s_š™
(&

->
tx_¡©s
.
synı
);

8472 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_35
 ||

8473 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_36
 ||

8474 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_37
 ||

8475 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_38
 ||

8476 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_40
 ||

8477 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_41
 ||

8478 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_42
 ||

8479 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_43
 ||

8480 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_44
 ||

8481 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_45
 ||

8482 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_46
 ||

8483 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_47
 ||

8484 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_48
 ||

8485 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

8486 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

8487 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) {

8488 
u16
 
mac_addr
[3];

8490 *(
u32
 *)&
mac_addr
[0] = 
	`¹l_”i_»ad
(

, 0xe0, 
ERIAR_EXGMAC
);

8491 *(
u16
 *)&
mac_addr
[2] = 
	`¹l_”i_»ad
(

, 0xe4, 
ERIAR_EXGMAC
);

8493 ià(
	`is_v®id_‘h”_addr
((
u8
 *)
mac_addr
))

8494 
	`¹l_¿r_£t
(

, (
u8
 *)
mac_addr
);

8496 
i
 = 0; i < 
ETH_ALEN
; i++)

8497 
dev
->
dev_addr
[
i
] = 
	`RTL_R8
(
MAC0
 + i);

8499 
dev
->
‘htoŞ_İs
 = &
¹l8169_‘htoŞ_İs
;

8500 
dev
->
w©chdog_timeo
 = 
RTL8169_TX_TIMEOUT
;

8502 
	`Ãtif_Çpi_add
(
dev
, &

->
Çpi
, 
¹l8169_pŞl
, 
R8169_NAPI_WEIGHT
);

8506 
dev
->
ã©u»s
 |ğ
NETIF_F_RXCSUM
 |

8507 
NETIF_F_HW_VLAN_CTAG_TX
 | 
NETIF_F_HW_VLAN_CTAG_RX
;

8509 
dev
->
hw_ã©u»s
 = 
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

8510 
NETIF_F_RXCSUM
 | 
NETIF_F_HW_VLAN_CTAG_TX
 |

8511 
NETIF_F_HW_VLAN_CTAG_RX
;

8512 
dev
->
vÏn_ã©u»s
 = 
NETIF_F_SG
 | 
NETIF_F_IP_CSUM
 | 
NETIF_F_TSO
 |

8513 
NETIF_F_HIGHDMA
;

8515 

->
ı_cmd
 |ğ
RxChkSum
 | 
RxVÏn
;

8521 ià(

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_05
)

8523 
dev
->
hw_ã©u»s
 &ğ~
NETIF_F_HW_VLAN_CTAG_RX
;

8525 ià(

->
txd_v”siÚ
 =ğ
RTL_TD_0
)

8526 

->
tso_csum
 = 
¹l8169_tso_csum_v1
;

8527 ià(

->
txd_v”siÚ
 =ğ
RTL_TD_1
) {

8528 

->
tso_csum
 = 
¹l8169_tso_csum_v2
;

8529 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_IPV6_CSUM
 | 
NETIF_F_TSO6
;

8531 
	`WARN_ON_ONCE
(1);

8533 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXALL
;

8534 
dev
->
hw_ã©u»s
 |ğ
NETIF_F_RXFCS
;

8536 

->
hw_¡¬t
 = 
cfg
->hw_start;

8537 

->
ev’t_¦ow
 = 
cfg
->event_slow;

8539 

->
İts1_mask
 = (->
mac_v”siÚ
 !ğ
RTL_GIGA_MAC_VER_01
) ?

8540 ~(
RxBOVF
 | 
RxFOVF
) : ~0;

8542 
	`tim”_£tup
(&

->
tim”
, 
¹l8169_phy_tim”
, 0);

8544 

->
¹l_fw
 = 
RTL_FIRMWARE_UNKNOWN
;

8546 

->
couÁ”s
 = 
	`dma_®loc_coh”’t
 (&
pdev
->
dev
, (*tp->counters),

8547 &

->
couÁ”s_phys_addr
, 
GFP_KERNEL
);

8548 ià(!

->
couÁ”s
) {

8549 
rc
 = -
ENOMEM
;

8550 
”r_out_msi_5
;

8553 
rc
 = 
	`»gi¡”_Ãtdev
(
dev
);

8554 ià(
rc
 < 0)

8555 
”r_out_út_6
;

8557 
	`pci_£t_drvd©a
(
pdev
, 
dev
);

8559 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "%s‡t 0x%p, %pM, XID %08x IRQ %d\n",

8560 
¹l_ch_šfos
[
ch£t
].
Çme
, 
ißddr
, 
dev
->
dev_addr
,

8561 (
u32
)(
	`RTL_R32
(
TxCÚfig
è& 0x9cf0f8ff), 
pdev
->
œq
);

8562 ià(
¹l_ch_šfos
[
ch£t
].
jumbo_max
 !ğ
JUMBO_1K
) {

8563 
	`Ãtif_šfo
(

, 
´obe
, 
dev
, "jumbo features [frames: %d bytes, "

8565 
¹l_ch_šfos
[
ch£t
].
jumbo_max
,

8566 
¹l_ch_šfos
[
ch£t
].
jumbo_tx_csum
 ? "ok" : "ko");

8569 ià((

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_27
 ||

8570 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_28
 ||

8571 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_31
 ||

8572 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_49
 ||

8573 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_50
 ||

8574 

->
mac_v”siÚ
 =ğ
RTL_GIGA_MAC_VER_51
) &&

8575 
	`r8168_check_dash
(

)) {

8576 
	`¹l8168_driv”_¡¬t
(

);

8579 
	`deviû_£t_wakeup_’abË
(&
pdev
->
dev
, 

->
ã©u»s
 & 
RTL_FEATURE_WOL
);

8581 ià(
	`pci_dev_run_wake
(
pdev
))

8582 
	`pm_ruÁime_put_noidË
(&
pdev
->
dev
);

8584 
	`Ãtif_ÿ¼›r_off
(
dev
);

8586 
	`´štk
("Glenn\n");

8588 
out
:

8589  
rc
;

8591 
”r_out_út_6
:

8592 
	`dma_ä“_coh”’t
(&
pdev
->
dev
, (*

->
couÁ”s
),p->counters,

8593 

->
couÁ”s_phys_addr
);

8594 
”r_out_msi_5
:

8595 
	`Ãtif_Çpi_d–
(&

->
Çpi
);

8596 
	`¹l_di§bË_msi
(
pdev
, 

);

8597 
”r_out_unm­_4
:

8598 
	`iounm­
(
ißddr
);

8599 
”r_out_ä“_»s_3
:

8600 
	`pci_»Ëa£_»giÚs
(
pdev
);

8601 
”r_out_mwi_2
:

8602 
	`pci_ş—r_mwi
(
pdev
);

8603 
	`pci_di§bË_deviû
(
pdev
);

8604 
”r_out_ä“_dev_1
:

8605 
	`ä“_Ãtdev
(
dev
);

8606 
out
;

8607 
	}
}

8609 
pci_driv”
 
	g¹l8169_pci_driv”
 = {

8610 .
Çme
 = 
MODULENAME
,

8611 .
	gid_bË
 = 
¹l8169_pci_tbl
,

8612 .
	g´obe
 = 
¹l_š™_Úe
,

8613 .
	g»move
 = 
¹l_»move_Úe
,

8614 .
	gshutdown
 = 
¹l_shutdown
,

8615 .
	gdriv”
.
	gpm
 = 
RTL8169_PM_OPS
,

8618 
moduË_pci_driv”
(
¹l8169_pci_driv”
);

	@r8169.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/comp”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

6 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

8 
__visibË
 
moduË
 
__this_moduË


9 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

10 .
Çme
 = 
KBUILD_MODNAME
,

11 .
	gš™
 = 
š™_moduË
,

12 #ifdeà
CONFIG_MODULE_UNLOAD


13 .
	gex™
 = 
ş—nup_moduË
,

15 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

18 #ifdeà
RETPOLINE


19 
MODULE_INFO
(
»Şše
, "Y");

22 cÚ¡ 
	g__moduË_d•’ds
[]

23 
__u£d


24 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

27 
MODULE_ALIAS
("pci:v000010ECd00008129sv*sd*bc*sc*i*");

28 
MODULE_ALIAS
("pci:v000010ECd00008136sv*sd*bc*sc*i*");

29 
MODULE_ALIAS
("pci:v000010ECd00008161sv*sd*bc*sc*i*");

30 
MODULE_ALIAS
("pci:v000010ECd00008167sv*sd*bc*sc*i*");

31 
MODULE_ALIAS
("pci:v000010ECd00008168sv*sd*bc*sc*i*");

32 
MODULE_ALIAS
("pci:v000010ECd00008169sv*sd*bc*sc*i*");

33 
MODULE_ALIAS
("pci:v00001186d00004300sv00001186sd00004B10bc*sc*i*");

34 
MODULE_ALIAS
("pci:v00001186d00004300sv*sd*bc*sc*i*");

35 
MODULE_ALIAS
("pci:v00001186d00004302sv*sd*bc*sc*i*");

36 
MODULE_ALIAS
("pci:v00001259d0000C107sv*sd*bc*sc*i*");

37 
MODULE_ALIAS
("pci:v000016ECd00000116sv*sd*bc*sc*i*");

38 
MODULE_ALIAS
("pci:v00001737d00001032sv*sd00000024bc*sc*i*");

39 
MODULE_ALIAS
("pci:v00000001d00008168sv*sd00002410bc*sc*i*");

41 
MODULE_INFO
(
¤cv”siÚ
, "F05CE6F678A2E0DF4F18BD3");

	@
1
.
0
7
63
8139cp.c
8139too.c
atp.c
atp.h
r8169-old.c
r8169.c
r8169.mod.c
